<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<!-- autogenerated by 'erl2html2'. -->
<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8"/></meta>
<title>/buildroot/otp/lib/kernel/make_test_dir/kernel_test/socket_SUITE.erl</title>
</head>

<body bgcolor="white" text="black" link="blue" vlink="purple" alink="red">
<pre>
<a name="1"/>    1: <i>%%</i>
<a name="2"/>    2: <i>%% %CopyrightBegin%</i>
<a name="3"/>    3: <i>%% </i>
<a name="4"/>    4: <i>%% Copyright Ericsson AB 2018-2023. All Rights Reserved.</i>
<a name="5"/>    5: <i>%% </i>
<a name="6"/>    6: <i>%% Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</i>
<a name="7"/>    7: <i>%% you may not use this file except in compliance with the License.</i>
<a name="8"/>    8: <i>%% You may obtain a copy of the License at</i>
<a name="9"/>    9: <i>%%</i>
<a name="10"/>   10: <i>%%     http://www.apache.org/licenses/LICENSE-2.0</i>
<a name="11"/>   11: <i>%%</i>
<a name="12"/>   12: <i>%% Unless required by applicable law or agreed to in writing, software</i>
<a name="13"/>   13: <i>%% distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</i>
<a name="14"/>   14: <i>%% WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</i>
<a name="15"/>   15: <i>%% See the License for the specific language governing permissions and</i>
<a name="16"/>   16: <i>%% limitations under the License.</i>
<a name="17"/>   17: <i>%% </i>
<a name="18"/>   18: <i>%% %CopyrightEnd%</i>
<a name="19"/>   19: <i>%%</i>
<a name="20"/>   20: 
<a name="21"/>   21: <i>%% There are some environment variables that can be used to &quot;manipulate&quot;</i>
<a name="22"/>   22: <i>%% the test suite: </i>
<a name="23"/>   23: <i>%%</i>
<a name="24"/>   24: <i>%% Variable that controls which 'groups' are to run (with default values)</i>
<a name="25"/>   25: <i>%%</i>
<a name="26"/>   26: <i>%%         ESOCK_TEST_API:         include</i>
<a name="27"/>   27: <i>%%         ESOCK_TEST_REG:         include</i>
<a name="28"/>   28: <i>%%         ESOCK_TEST_MON:         include</i>
<a name="29"/>   29: <i>%%         ESOCK_TEST_IOCTL:       include</i>
<a name="30"/>   30: <i>%%         ESOCK_TEST_SOCK_CLOSE:  include</i>
<a name="31"/>   31: <i>%%         ESOCK_TEST_TRAFFIC:     include</i>
<a name="32"/>   32: <i>%%         ESOCK_TEST_TICKETS:     include</i>
<a name="33"/>   33: <i>%%         ESOCK_TEST_TTEST:       include</i>
<a name="34"/>   34: <i>%%</i>
<a name="35"/>   35: <i>%% Variable that controls &quot;verbosity&quot; of the test case(s):</i>
<a name="36"/>   36: <i>%%</i>
<a name="37"/>   37: <i>%%         ESOCK_TEST_QUIET: true (default) | false</i>
<a name="38"/>   38: <i>%%</i>
<a name="39"/>   39: <i>%% Defines the runtime of the ttest cases</i>
<a name="40"/>   40: <i>%% (This is the time during which &quot;measurement&quot; is performed. </i>
<a name="41"/>   41: <i>%%  the actual time it takes for the test case to complete</i>
<a name="42"/>   42: <i>%%  will be longer; setup, completion, ...)</i>
<a name="43"/>   43: <i>%%</i>
<a name="44"/>   44: <i>%%          ESOCK_TEST_TTEST_RUNTIME: 1 second</i>
<a name="45"/>   45: <i>%%              Format of values: &lt;integer&gt;[&lt;unit&gt;]</i>
<a name="46"/>   46: <i>%%              Where unit is: ms | s | m</i>
<a name="47"/>   47: <i>%%                 ms - milli seconds</i>
<a name="48"/>   48: <i>%%                 s  - seconds (default)</i>
<a name="49"/>   49: <i>%%                 m  - minutes</i>
<a name="50"/>   50: <i>%%</i>
<a name="51"/>   51: <i>%% The ttest takes a long time to run, even when the runtime is small,</i>
<a name="52"/>   52: <i>%% because there are such a large number of test cases.</i>
<a name="53"/>   53: <i>%% So, by default only the 'small' test cases are included in a test run.</i>
<a name="54"/>   54: <i>%% The following environment variables control which are included and </i>
<a name="55"/>   55: <i>%% excluded.</i>
<a name="56"/>   56: <i>%%</i>
<a name="57"/>   57: <i>%%          ESOCK_TEST_TTEST_SMALL:  included</i>
<a name="58"/>   58: <i>%%          ESOCK_TEST_TTEST_MEDIUM: excluded</i>
<a name="59"/>   59: <i>%%          ESOCK_TEST_TTEST_LARGE:  excluded</i>
<a name="60"/>   60: <i>%%</i>
<a name="61"/>   61: 
<a name="62"/>   62: <i>%% Run the entire test suite: </i>
<a name="63"/>   63: <i>%% ts:run(kernel, socket_SUITE, [batch]).</i>
<a name="64"/>   64: <i>%%</i>
<a name="65"/>   65: <i>%% Run a specific group:</i>
<a name="66"/>   66: <i>%% ts:run(kernel, socket_SUITE, {group, foo}, [batch]).</i>
<a name="67"/>   67: <i>%%</i>
<a name="68"/>   68: <i>%% Run a specific test case:</i>
<a name="69"/>   69: <i>%% ts:run(kernel, socket_SUITE, foo, [batch]).</i>
<a name="70"/>   70: <i>%%</i>
<a name="71"/>   71: <i>%% (cd /mnt/c/$LOCAL_TESTS/26/kernel_test/ &amp;&amp; $ERL_TOP/bin/win32/erl.exe -sname kernel-26-tester -pa c:$LOCAL_TESTS/26/test_server)</i>
<a name="72"/>   72: <i>%% application:set_env(kernel, test_inet_backends, true).</i>
<a name="73"/>   73: <i>%% S = fun() -&gt; ts:run(kernel, socket_SUITE, [batch]) end.</i>
<a name="74"/>   74: <i>%% S = fun(SUITE) -&gt; ts:run(kernel, SUITE, [batch]) end.</i>
<a name="75"/>   75: <i>%% S = fun() -&gt; ct:run_test([{suite, socket_SUITE}]) end.</i>
<a name="76"/>   76: <i>%% S = fun(SUITE) -&gt; ct:run_test([{suite, SUITE}]) end.</i>
<a name="77"/>   77: <i>%% G = fun(GROUP) -&gt; ts:run(kernel, socket_SUITE, {group, GROUP}, [batch]) end.</i>
<a name="78"/>   78: <i>%% G = fun(SUITE, GROUP) -&gt; ts:run(kernel, SUITE, {group, GROUP}, [batch]) end.</i>
<a name="79"/>   79: <i>%% G = fun(GROUP) -&gt; ct:run_test([{suite, socket_SUITE}, {group, GROUP}]) end.</i>
<a name="80"/>   80: <i>%% G = fun(SUITE, GROUP) -&gt; ct:run_test([{suite, SUITE}, {group, GROUP}]) end.</i>
<a name="81"/>   81: <i>%% T = fun(TC) -&gt; ts:run(kernel, socket_SUITE, TC, [batch]) end.</i>
<a name="82"/>   82: <i>%% T = fun(TC) -&gt; ct:run_test([{suite, socket_SUITE}, {testcase, TC}]) end.</i>
<a name="83"/>   83: <i>%% T = fun(S, TC) -&gt; ct:run_test([{suite, S}, {testcase, TC}]) end.</i>
<a name="84"/>   84: <i>%% T = fun(S, G, TC) -&gt; ct:run_test([{suite, S}, {group, G}, {testcase, TC}]) end.</i>
<a name="85"/>   85: <i>%%</i>
<a name="86"/>   86: <i>%% Some official info about AF_UNIX</i>
<a name="87"/>   87: <i>%% https://devblogs.microsoft.com/commandline/windowswsl-interop-with-af_unix/</i>
<a name="88"/>   88: 
<a name="89"/>   89: 
<a name="90"/>   90: 
<a name="91"/>   91: <b>-module</b>(socket_SUITE).
<a name="92"/>   92: 
<a name="93"/>   93: <b>-include_lib</b>(&quot;common_test/include/ct.hrl&quot;).
<a name="94"/>   94: <b>-include_lib</b>(&quot;common_test/include/ct_event.hrl&quot;).
<a name="95"/>   95: <b>-include</b>(&quot;socket_test_evaluator.hrl&quot;).
<a name="96"/>   96: 
<a name="97"/>   97: <i>%% Suite exports</i>
<a name="98"/>   98: <b>-export</b>([suite/0, all/0, groups/0]).
<a name="99"/>   99: <b>-export</b>([init_per_suite/1,    end_per_suite/1,
<a name="100"/>  100:          init_per_group/2,    end_per_group/2,
<a name="101"/>  101:          init_per_testcase/2, end_per_testcase/2]).
<a name="102"/>  102: 
<a name="103"/>  103: <i>%% Test cases</i>
<a name="104"/>  104: <b>-export</b>([
<a name="105"/>  105:          %% *** API Misc ***
<a name="106"/>  106:          api_m_info/1,
<a name="107"/>  107:          api_m_debug/1,
<a name="108"/>  108:          api_m_error_open/1,
<a name="109"/>  109:          api_m_error_bind/1,
<a name="110"/>  110: 
<a name="111"/>  111:          %% *** API Basic ***
<a name="112"/>  112:          api_b_simple_open_and_close_udp4/1,
<a name="113"/>  113:          api_b_simple_open_and_close_udp6/1,
<a name="114"/>  114:          api_b_simple_open_and_close_tcp4/1,
<a name="115"/>  115:          api_b_simple_open_and_close_tcp6/1,
<a name="116"/>  116:          api_b_open_and_info_udp4/1,
<a name="117"/>  117:          api_b_open_and_info_udp6/1,
<a name="118"/>  118:          api_b_open_and_info_tcp4/1,
<a name="119"/>  119:          api_b_open_and_info_tcp6/1,
<a name="120"/>  120:          api_b_open_and_close_udp4/1,
<a name="121"/>  121:          api_b_open_and_close_udp6/1,
<a name="122"/>  122:          api_b_open_and_close_tcp4/1,
<a name="123"/>  123:          api_b_open_and_close_tcp6/1,
<a name="124"/>  124:          api_b_open_and_close_udpL/1,
<a name="125"/>  125:          api_b_open_and_close_tcpL/1,
<a name="126"/>  126:          api_b_open_and_close_seqpL/1,
<a name="127"/>  127: 	 api_b_open_and_close_sctp4/1,
<a name="128"/>  128:          api_b_open_and_maybe_close_raw/1,
<a name="129"/>  129:          api_b_sendto_and_recvfrom_udp4/1,
<a name="130"/>  130:          api_b_sendto_and_recvfrom_udpL/1,
<a name="131"/>  131:          api_b_sendmsg_and_recvmsg_udp4/1,
<a name="132"/>  132:          api_b_sendmsg_and_recvmsg_udpL/1,
<a name="133"/>  133:          api_b_send_and_recv_tcp4/1,
<a name="134"/>  134:          api_b_send_and_recv_tcpL/1,
<a name="135"/>  135:          api_b_send_and_recv_seqpL/1,
<a name="136"/>  136:          api_b_sendmsg_and_recvmsg_tcp4/1,
<a name="137"/>  137:          api_b_sendmsg_and_recvmsg_tcpL/1,
<a name="138"/>  138:          api_b_sendmsg_and_recvmsg_seqpL/1,
<a name="139"/>  139:          api_b_sendmsg_and_recvmsg_sctp4/1,
<a name="140"/>  140:          api_b_sendmsg_iov_dgram_inet/1,
<a name="141"/>  141:          api_b_sendmsg_iov_dgram_inet6/1,
<a name="142"/>  142:          api_b_sendmsg_iov_dgram_local/1,
<a name="143"/>  143:          api_b_sendmsg_iov_stream_inet/1,
<a name="144"/>  144:          api_b_sendmsg_iov_stream_inet6/1,
<a name="145"/>  145:          api_b_sendmsg_iov_stream_local/1,
<a name="146"/>  146:          api_b_dgram_connect_udp4/1,
<a name="147"/>  147:          api_b_dgram_connect_udp6/1,
<a name="148"/>  148: 
<a name="149"/>  149:          %% *** API sendfile ***
<a name="150"/>  150:          api_sendfile_inet/1,
<a name="151"/>  151:          api_sendfile_inet6/1,
<a name="152"/>  152:          api_sendfile_local/1,
<a name="153"/>  153:          api_sendfile_loop_inet/1,
<a name="154"/>  154:          api_sendfile_loop_inet6/1,
<a name="155"/>  155:          api_sendfile_loop_local/1,
<a name="156"/>  156: 
<a name="157"/>  157:          %% *** API socket from FD ***
<a name="158"/>  158:          api_ffd_open_wod_and_info_udp4/1,
<a name="159"/>  159:          api_ffd_open_wod_and_info_udp6/1,
<a name="160"/>  160:          api_ffd_open_wod_and_info_tcp4/1,
<a name="161"/>  161:          api_ffd_open_wod_and_info_tcp6/1,
<a name="162"/>  162:          api_ffd_open_wd_and_info_udp4/1,
<a name="163"/>  163:          api_ffd_open_wd_and_info_udp6/1,
<a name="164"/>  164:          api_ffd_open_wd_and_info_tcp4/1,
<a name="165"/>  165:          api_ffd_open_wd_and_info_tcp6/1,
<a name="166"/>  166:          api_ffd_open_and_open_wod_and_send_udp4/1,
<a name="167"/>  167:          api_ffd_open_and_open_wod_and_send_udp6/1,
<a name="168"/>  168:          api_ffd_open_and_open_wd_and_send_udp4/1,
<a name="169"/>  169:          api_ffd_open_and_open_wd_and_send_udp6/1,
<a name="170"/>  170:          api_ffd_open_connect_and_open_wod_and_send_tcp4/1,
<a name="171"/>  171:          api_ffd_open_connect_and_open_wod_and_send_tcp6/1,
<a name="172"/>  172:          api_ffd_open_connect_and_open_wd_and_send_tcp4/1,
<a name="173"/>  173:          api_ffd_open_connect_and_open_wd_and_send_tcp6/1,
<a name="174"/>  174: 
<a name="175"/>  175: 
<a name="176"/>  176:          %% *** API async ***
<a name="177"/>  177:          api_a_connect_tcp4/1,
<a name="178"/>  178:          api_a_connect_tcp6/1,
<a name="179"/>  179:          api_a_sendto_and_recvfrom_udp4/1,
<a name="180"/>  180:          api_a_sendto_and_recvfrom_udp6/1,
<a name="181"/>  181:          api_a_sendmsg_and_recvmsg_udp4/1,
<a name="182"/>  182:          api_a_sendmsg_and_recvmsg_udp6/1,
<a name="183"/>  183:          api_a_send_and_recv_tcp4/1,
<a name="184"/>  184:          api_a_send_and_recv_tcp6/1,
<a name="185"/>  185:          api_a_sendmsg_and_recvmsg_tcp4/1,
<a name="186"/>  186:          api_a_sendmsg_and_recvmsg_tcp6/1,
<a name="187"/>  187:          api_a_recvfrom_cancel_udp4/1,
<a name="188"/>  188:          api_a_recvfrom_cancel_udp6/1,
<a name="189"/>  189:          api_a_recvmsg_cancel_udp4/1,
<a name="190"/>  190:          api_a_recvmsg_cancel_udp6/1,
<a name="191"/>  191:          api_a_accept_cancel_tcp4/1,
<a name="192"/>  192:          api_a_accept_cancel_tcp6/1,
<a name="193"/>  193:          api_a_recv_cancel_tcp4/1,
<a name="194"/>  194:          api_a_recv_cancel_tcp6/1,
<a name="195"/>  195:          api_a_recvmsg_cancel_tcp4/1,
<a name="196"/>  196:          api_a_recvmsg_cancel_tcp6/1,
<a name="197"/>  197:          api_a_mrecvfrom_cancel_udp4/1,
<a name="198"/>  198:          api_a_mrecvfrom_cancel_udp6/1,
<a name="199"/>  199:          api_a_mrecvmsg_cancel_udp4/1,
<a name="200"/>  200:          api_a_mrecvmsg_cancel_udp6/1,
<a name="201"/>  201:          api_a_maccept_cancel_tcp4/1,
<a name="202"/>  202:          api_a_maccept_cancel_tcp6/1,
<a name="203"/>  203:          api_a_mrecv_cancel_tcp4/1,
<a name="204"/>  204:          api_a_mrecv_cancel_tcp6/1,
<a name="205"/>  205:          api_a_mrecvmsg_cancel_tcp4/1,
<a name="206"/>  206:          api_a_mrecvmsg_cancel_tcp6/1,
<a name="207"/>  207: 
<a name="208"/>  208: 
<a name="209"/>  209:          %% *** API Options ***
<a name="210"/>  210:          api_opt_simple_otp_options/1,
<a name="211"/>  211:          api_opt_simple_otp_meta_option/1,
<a name="212"/>  212:          api_opt_simple_otp_rcvbuf_option/1,
<a name="213"/>  213:          api_opt_simple_otp_controlling_process/1,
<a name="214"/>  214:          api_opt_sock_acceptconn_udp/1,
<a name="215"/>  215:          api_opt_sock_acceptconn_tcp/1,
<a name="216"/>  216:          api_opt_sock_acceptfilter/1,
<a name="217"/>  217:          api_opt_sock_bindtodevice/1,
<a name="218"/>  218:          api_opt_sock_broadcast/1,
<a name="219"/>  219:          api_opt_sock_debug/1,
<a name="220"/>  220:          api_opt_sock_domain/1,
<a name="221"/>  221:          api_opt_sock_dontroute/1,
<a name="222"/>  222:          api_opt_sock_error/1,
<a name="223"/>  223:          api_opt_sock_keepalive/1,
<a name="224"/>  224:          api_opt_sock_linger/1,
<a name="225"/>  225:          api_opt_sock_mark/1,
<a name="226"/>  226:          api_opt_sock_maxdg/1,
<a name="227"/>  227:          api_opt_sock_max_msg_size/1,
<a name="228"/>  228:          api_opt_sock_oobinline/1,
<a name="229"/>  229:          api_opt_sock_passcred_tcp4/1,
<a name="230"/>  230:          api_opt_sock_peek_off_tcpL/1,
<a name="231"/>  231:          api_opt_sock_peercred_tcpL/1,
<a name="232"/>  232:          api_opt_sock_priority_udp4/1,
<a name="233"/>  233:          api_opt_sock_priority_tcp4/1,
<a name="234"/>  234:          api_opt_sock_rcvbuf_udp4/1,
<a name="235"/>  235:          api_opt_sock_rcvlowat_udp4/1,
<a name="236"/>  236:          api_opt_sock_rcvtimeo_udp4/1,
<a name="237"/>  237:          api_opt_sock_reuseaddr/1,
<a name="238"/>  238:          api_opt_sock_exclusiveaddruse/1,
<a name="239"/>  239:          api_opt_sock_bsp_state/1,
<a name="240"/>  240:          api_opt_sock_sndbuf_udp4/1,
<a name="241"/>  241:          api_opt_sock_sndlowat_udp4/1,
<a name="242"/>  242:          api_opt_sock_sndtimeo_udp4/1,
<a name="243"/>  243:          api_opt_sock_timestamp_udp4/1,
<a name="244"/>  244:          api_opt_sock_timestamp_tcp4/1,
<a name="245"/>  245:          api_opt_ip_add_drop_membership/0, api_opt_ip_add_drop_membership/1,
<a name="246"/>  246:          api_opt_ip_pktinfo_udp4/1,
<a name="247"/>  247:          api_opt_ip_recvopts_udp4/1,
<a name="248"/>  248:          api_opt_ip_recvorigdstaddr_udp4/1,
<a name="249"/>  249:          api_opt_ip_recvtos_udp4/1,
<a name="250"/>  250:          api_opt_ip_recvttl_udp4/1,
<a name="251"/>  251:          api_opt_ip_tos_udp4/1,
<a name="252"/>  252:          api_opt_ip_recverr_udp4/1,
<a name="253"/>  253:          api_opt_ip_mopts_udp4/1,
<a name="254"/>  254:          api_opt_ipv6_recvpktinfo_udp6/1,
<a name="255"/>  255: 	 api_opt_ipv6_flowinfo_udp6/1,
<a name="256"/>  256: 	 api_opt_ipv6_hoplimit_udp6/1,
<a name="257"/>  257: 	 api_opt_ipv6_tclass_udp6/1,
<a name="258"/>  258:          api_opt_ipv6_recverr_udp6/1,
<a name="259"/>  259: 	 api_opt_ipv6_mopts_udp6/1,
<a name="260"/>  260:          api_opt_tcp_congestion_tcp4/1,
<a name="261"/>  261:          api_opt_tcp_cork_tcp4/1,
<a name="262"/>  262:          api_opt_tcp_maxseg_tcp4/1,
<a name="263"/>  263:          api_opt_tcp_nodelay_tcp4/1,
<a name="264"/>  264:          api_opt_tcp_keepcnt_tcp4/1,
<a name="265"/>  265:          api_opt_tcp_keepidle_tcp4/1,
<a name="266"/>  266:          api_opt_tcp_keepintvl_tcp4/1,
<a name="267"/>  267:          api_opt_udp_cork_udp4/1,
<a name="268"/>  268: 
<a name="269"/>  269:          %% *** API Operation Timeout ***
<a name="270"/>  270:          api_to_connect_tcp4/1,
<a name="271"/>  271:          api_to_connect_tcp6/1,
<a name="272"/>  272:          api_to_accept_tcp4/1,
<a name="273"/>  273:          api_to_accept_tcp6/1,
<a name="274"/>  274:          api_to_maccept_tcp4/1,
<a name="275"/>  275:          api_to_maccept_tcp6/1,
<a name="276"/>  276:          api_to_send_tcp4/1,
<a name="277"/>  277:          api_to_send_tcp6/1,
<a name="278"/>  278:          api_to_sendto_udp4/1,
<a name="279"/>  279:          api_to_sendto_udp6/1,
<a name="280"/>  280:          api_to_sendmsg_tcp4/1,
<a name="281"/>  281:          api_to_sendmsg_tcp6/1,
<a name="282"/>  282:          api_to_recv_udp4/1,
<a name="283"/>  283:          api_to_recv_udp6/1,
<a name="284"/>  284:          api_to_recv_tcp4/1,
<a name="285"/>  285:          api_to_recv_tcp6/1,
<a name="286"/>  286:          api_to_recvfrom_udp4/1,
<a name="287"/>  287:          api_to_recvfrom_udp6/1,
<a name="288"/>  288:          api_to_recvmsg_udp4/1,
<a name="289"/>  289:          api_to_recvmsg_udp6/1,
<a name="290"/>  290:          api_to_recvmsg_tcp4/1,
<a name="291"/>  291:          api_to_recvmsg_tcp6/1,
<a name="292"/>  292: 
<a name="293"/>  293:          %% Socket Registry
<a name="294"/>  294:          reg_s_single_open_and_close_and_count/1,
<a name="295"/>  295:          reg_s_optional_open_and_close_and_count/1,
<a name="296"/>  296: 
<a name="297"/>  297: 
<a name="298"/>  298:          %% Socket Monitor
<a name="299"/>  299:          monitor_simple_open_and_close/1,
<a name="300"/>  300: 	 monitor_simple_open_and_exit/1,
<a name="301"/>  301: 	 monitor_simple_open_and_demon_and_close/1,
<a name="302"/>  302: 	 monitor_open_and_close_multi_socks/1,
<a name="303"/>  303: 	 monitor_open_and_exit_multi_socks/1,
<a name="304"/>  304: 	 monitor_open_and_demon_and_close_multi_socks/1,
<a name="305"/>  305: 	 monitor_open_and_close_multi_mon/1,
<a name="306"/>  306: 	 monitor_open_and_exit_multi_mon/1,
<a name="307"/>  307: 	 monitor_open_and_close_multi_socks_and_mon/1,
<a name="308"/>  308: 	 monitor_open_and_exit_multi_socks_and_mon/1,
<a name="309"/>  309: 	 monitor_closed_socket/1,
<a name="310"/>  310: 
<a name="311"/>  311:          %% *** Socket Closure ***
<a name="312"/>  312:          sc_cpe_socket_cleanup_tcp4/1,
<a name="313"/>  313:          sc_cpe_socket_cleanup_tcp6/1,
<a name="314"/>  314:          sc_cpe_socket_cleanup_tcpL/1,
<a name="315"/>  315:          sc_cpe_socket_cleanup_udp4/1,
<a name="316"/>  316:          sc_cpe_socket_cleanup_udp6/1,
<a name="317"/>  317:          sc_cpe_socket_cleanup_udpL/1,
<a name="318"/>  318: 
<a name="319"/>  319:          sc_lc_recv_response_tcp4/1,
<a name="320"/>  320:          sc_lc_recv_response_tcp6/1,
<a name="321"/>  321:          sc_lc_recv_response_tcpL/1,
<a name="322"/>  322:          sc_lc_recvfrom_response_udp4/1,
<a name="323"/>  323:          sc_lc_recvfrom_response_udp6/1,
<a name="324"/>  324:          sc_lc_recvfrom_response_udpL/1,
<a name="325"/>  325:          sc_lc_recvmsg_response_tcp4/1,
<a name="326"/>  326:          sc_lc_recvmsg_response_tcp6/1,
<a name="327"/>  327:          sc_lc_recvmsg_response_tcpL/1,
<a name="328"/>  328:          sc_lc_recvmsg_response_udp4/1,
<a name="329"/>  329:          sc_lc_recvmsg_response_udp6/1,
<a name="330"/>  330:          sc_lc_recvmsg_response_udpL/1,
<a name="331"/>  331:          sc_lc_acceptor_response_tcp4/1,
<a name="332"/>  332:          sc_lc_acceptor_response_tcp6/1,
<a name="333"/>  333:          sc_lc_acceptor_response_tcpL/1,
<a name="334"/>  334: 
<a name="335"/>  335:          sc_rc_recv_response_tcp4/1,
<a name="336"/>  336:          sc_rc_recv_response_tcp6/1,
<a name="337"/>  337:          sc_rc_recv_response_tcpL/1,
<a name="338"/>  338:          sc_rc_recvmsg_response_tcp4/1,
<a name="339"/>  339:          sc_rc_recvmsg_response_tcp6/1,
<a name="340"/>  340:          sc_rc_recvmsg_response_tcpL/1,
<a name="341"/>  341: 
<a name="342"/>  342:          sc_rs_recv_send_shutdown_receive_tcp4/1,
<a name="343"/>  343:          sc_rs_recv_send_shutdown_receive_tcp6/1,
<a name="344"/>  344:          sc_rs_recv_send_shutdown_receive_tcpL/1,
<a name="345"/>  345:          sc_rs_recvmsg_send_shutdown_receive_tcp4/1,
<a name="346"/>  346:          sc_rs_recvmsg_send_shutdown_receive_tcp6/1,
<a name="347"/>  347:          sc_rs_recvmsg_send_shutdown_receive_tcpL/1,
<a name="348"/>  348: 
<a name="349"/>  349:          %% Socket IOCTL simple
<a name="350"/>  350:          ioctl_simple1/1,
<a name="351"/>  351:          ioctl_simple2/1,
<a name="352"/>  352:          ioctl_nread/1,
<a name="353"/>  353:          %% Socket IOCTL get requests
<a name="354"/>  354:          ioctl_get_gifname/1,
<a name="355"/>  355:          ioctl_get_gifindex/1,
<a name="356"/>  356:          ioctl_get_gifaddr/1,
<a name="357"/>  357:          ioctl_get_gifdstaddr/1,
<a name="358"/>  358:          ioctl_get_gifbrdaddr/1,
<a name="359"/>  359:          ioctl_get_gifnetmask/1,
<a name="360"/>  360:          ioctl_get_gifmtu/1,
<a name="361"/>  361:          ioctl_get_gifhwaddr/1,
<a name="362"/>  362:          ioctl_get_giftxqlen/1,
<a name="363"/>  363:          ioctl_get_gifflags/1,
<a name="364"/>  364:          ioctl_get_gifmap/1,
<a name="365"/>  365:          ioctl_tcp_info/1,
<a name="366"/>  366:          %% ioctl_set_requests/1,
<a name="367"/>  367: 
<a name="368"/>  368:          %% *** Traffic ***
<a name="369"/>  369:          traffic_send_and_recv_counters_tcp4/1,
<a name="370"/>  370:          traffic_send_and_recv_counters_tcp6/1,
<a name="371"/>  371:          traffic_send_and_recv_counters_tcpL/1,
<a name="372"/>  372:          traffic_sendmsg_and_recvmsg_counters_tcp4/1,
<a name="373"/>  373:          traffic_sendmsg_and_recvmsg_counters_tcp6/1,
<a name="374"/>  374:          traffic_sendmsg_and_recvmsg_counters_tcpL/1,
<a name="375"/>  375:          traffic_sendto_and_recvfrom_counters_udp4/1,
<a name="376"/>  376:          traffic_sendto_and_recvfrom_counters_udp6/1,
<a name="377"/>  377:          traffic_sendto_and_recvfrom_counters_udpL/1,
<a name="378"/>  378:          traffic_sendmsg_and_recvmsg_counters_udp4/1,
<a name="379"/>  379:          traffic_sendmsg_and_recvmsg_counters_udp6/1,
<a name="380"/>  380:          traffic_sendmsg_and_recvmsg_counters_udpL/1,
<a name="381"/>  381: 
<a name="382"/>  382:          traffic_send_and_recv_chunks_tcp4/1,
<a name="383"/>  383:          traffic_send_and_recv_chunks_tcp6/1,
<a name="384"/>  384:          traffic_send_and_recv_chunks_tcpL/1,
<a name="385"/>  385: 
<a name="386"/>  386:          traffic_ping_pong_small_send_and_recv_tcp4/1,
<a name="387"/>  387:          traffic_ping_pong_small_send_and_recv_tcp6/1,
<a name="388"/>  388:          traffic_ping_pong_small_send_and_recv_tcpL/1,
<a name="389"/>  389:          traffic_ping_pong_medium_send_and_recv_tcp4/1,
<a name="390"/>  390:          traffic_ping_pong_medium_send_and_recv_tcp6/1,
<a name="391"/>  391:          traffic_ping_pong_medium_send_and_recv_tcpL/1,
<a name="392"/>  392:          traffic_ping_pong_large_send_and_recv_tcp4/1,
<a name="393"/>  393:          traffic_ping_pong_large_send_and_recv_tcp6/1,
<a name="394"/>  394:          traffic_ping_pong_large_send_and_recv_tcpL/1,
<a name="395"/>  395: 
<a name="396"/>  396:          traffic_ping_pong_small_sendto_and_recvfrom_udp4/1,
<a name="397"/>  397:          traffic_ping_pong_small_sendto_and_recvfrom_udp6/1,
<a name="398"/>  398:          traffic_ping_pong_small_sendto_and_recvfrom_udpL/1,
<a name="399"/>  399:          traffic_ping_pong_medium_sendto_and_recvfrom_udp4/1,
<a name="400"/>  400:          traffic_ping_pong_medium_sendto_and_recvfrom_udp6/1,
<a name="401"/>  401:          traffic_ping_pong_medium_sendto_and_recvfrom_udpL/1,
<a name="402"/>  402: 
<a name="403"/>  403:          traffic_ping_pong_small_sendmsg_and_recvmsg_tcp4/1,
<a name="404"/>  404:          traffic_ping_pong_small_sendmsg_and_recvmsg_tcp6/1,
<a name="405"/>  405:          traffic_ping_pong_small_sendmsg_and_recvmsg_tcpL/1,
<a name="406"/>  406:          traffic_ping_pong_medium_sendmsg_and_recvmsg_tcp4/1,
<a name="407"/>  407:          traffic_ping_pong_medium_sendmsg_and_recvmsg_tcp6/1,
<a name="408"/>  408:          traffic_ping_pong_medium_sendmsg_and_recvmsg_tcpL/1,
<a name="409"/>  409:          traffic_ping_pong_large_sendmsg_and_recvmsg_tcp4/1,
<a name="410"/>  410:          traffic_ping_pong_large_sendmsg_and_recvmsg_tcp6/1,
<a name="411"/>  411:          traffic_ping_pong_large_sendmsg_and_recvmsg_tcpL/1,
<a name="412"/>  412: 
<a name="413"/>  413:          traffic_ping_pong_small_sendmsg_and_recvmsg_udp4/1,
<a name="414"/>  414:          traffic_ping_pong_small_sendmsg_and_recvmsg_udp6/1,
<a name="415"/>  415:          traffic_ping_pong_small_sendmsg_and_recvmsg_udpL/1,
<a name="416"/>  416:          traffic_ping_pong_medium_sendmsg_and_recvmsg_udp4/1,
<a name="417"/>  417:          traffic_ping_pong_medium_sendmsg_and_recvmsg_udp6/1,
<a name="418"/>  418:          traffic_ping_pong_medium_sendmsg_and_recvmsg_udpL/1,
<a name="419"/>  419: 
<a name="420"/>  420:          %% *** Time Test ***
<a name="421"/>  421:          %% Server: transport = gen_tcp, active = false
<a name="422"/>  422:          %% Client: transport = gen_tcp
<a name="423"/>  423:          ttest_sgenf_cgenf_small_tcp4/1,
<a name="424"/>  424:          ttest_sgenf_cgenf_small_tcp6/1,
<a name="425"/>  425:          ttest_sgenf_cgenf_medium_tcp4/1,
<a name="426"/>  426:          ttest_sgenf_cgenf_medium_tcp6/1,
<a name="427"/>  427:          ttest_sgenf_cgenf_large_tcp4/1,
<a name="428"/>  428:          ttest_sgenf_cgenf_large_tcp6/1,
<a name="429"/>  429: 
<a name="430"/>  430:          ttest_sgenf_cgeno_small_tcp4/1,
<a name="431"/>  431:          ttest_sgenf_cgeno_small_tcp6/1,
<a name="432"/>  432:          ttest_sgenf_cgeno_medium_tcp4/1,
<a name="433"/>  433:          ttest_sgenf_cgeno_medium_tcp6/1,
<a name="434"/>  434:          ttest_sgenf_cgeno_large_tcp4/1,
<a name="435"/>  435:          ttest_sgenf_cgeno_large_tcp6/1,
<a name="436"/>  436: 
<a name="437"/>  437:          ttest_sgenf_cgent_small_tcp4/1,
<a name="438"/>  438:          ttest_sgenf_cgent_small_tcp6/1,
<a name="439"/>  439:          ttest_sgenf_cgent_medium_tcp4/1,
<a name="440"/>  440:          ttest_sgenf_cgent_medium_tcp6/1,
<a name="441"/>  441:          ttest_sgenf_cgent_large_tcp4/1,
<a name="442"/>  442:          ttest_sgenf_cgent_large_tcp6/1,
<a name="443"/>  443: 
<a name="444"/>  444:          %% Server: transport = gen_tcp, active = false
<a name="445"/>  445:          %% Client: transport = socket(tcp)
<a name="446"/>  446:          ttest_sgenf_csockf_small_tcp4/1,
<a name="447"/>  447:          ttest_sgenf_csockf_small_tcp6/1,
<a name="448"/>  448:          ttest_sgenf_csockf_medium_tcp4/1,
<a name="449"/>  449:          ttest_sgenf_csockf_medium_tcp6/1,
<a name="450"/>  450:          ttest_sgenf_csockf_large_tcp4/1,
<a name="451"/>  451:          ttest_sgenf_csockf_large_tcp6/1,
<a name="452"/>  452: 
<a name="453"/>  453:          ttest_sgenf_csocko_small_tcp4/1,
<a name="454"/>  454:          ttest_sgenf_csocko_small_tcp6/1,
<a name="455"/>  455:          ttest_sgenf_csocko_medium_tcp4/1,
<a name="456"/>  456:          ttest_sgenf_csocko_medium_tcp6/1,
<a name="457"/>  457:          ttest_sgenf_csocko_large_tcp4/1,
<a name="458"/>  458:          ttest_sgenf_csocko_large_tcp6/1,
<a name="459"/>  459: 
<a name="460"/>  460:          ttest_sgenf_csockt_small_tcp4/1,
<a name="461"/>  461:          ttest_sgenf_csockt_small_tcp6/1,
<a name="462"/>  462:          ttest_sgenf_csockt_medium_tcp4/1,
<a name="463"/>  463:          ttest_sgenf_csockt_medium_tcp6/1,
<a name="464"/>  464:          ttest_sgenf_csockt_large_tcp4/1,
<a name="465"/>  465:          ttest_sgenf_csockt_large_tcp6/1,
<a name="466"/>  466: 
<a name="467"/>  467:          %% Server: transport = gen_tcp(socket), active = false
<a name="468"/>  468:          %% Client: transport = socket(tcp)
<a name="469"/>  469:          ttest_sgsf_csockf_small_tcp4/1,
<a name="470"/>  470:          ttest_sgsf_csockf_small_tcp6/1,
<a name="471"/>  471:          ttest_sgsf_csockf_medium_tcp4/1,
<a name="472"/>  472:          ttest_sgsf_csockf_medium_tcp6/1,
<a name="473"/>  473:          ttest_sgsf_csockf_large_tcp4/1,
<a name="474"/>  474:          ttest_sgsf_csockf_large_tcp6/1,
<a name="475"/>  475: 
<a name="476"/>  476:          %% Server: transport = gen_tcp, active = once
<a name="477"/>  477:          %% Client: transport = gen_tcp
<a name="478"/>  478:          ttest_sgeno_cgenf_small_tcp4/1,
<a name="479"/>  479:          ttest_sgeno_cgenf_small_tcp6/1,
<a name="480"/>  480:          ttest_sgeno_cgenf_medium_tcp4/1,
<a name="481"/>  481:          ttest_sgeno_cgenf_medium_tcp6/1,
<a name="482"/>  482:          ttest_sgeno_cgenf_large_tcp4/1,
<a name="483"/>  483:          ttest_sgeno_cgenf_large_tcp6/1,
<a name="484"/>  484: 
<a name="485"/>  485:          ttest_sgeno_cgeno_small_tcp4/1,
<a name="486"/>  486:          ttest_sgeno_cgeno_small_tcp6/1,
<a name="487"/>  487:          ttest_sgeno_cgeno_medium_tcp4/1,
<a name="488"/>  488:          ttest_sgeno_cgeno_medium_tcp6/1,
<a name="489"/>  489:          ttest_sgeno_cgeno_large_tcp4/1,
<a name="490"/>  490:          ttest_sgeno_cgeno_large_tcp6/1,
<a name="491"/>  491: 
<a name="492"/>  492:          ttest_sgeno_cgent_small_tcp4/1,
<a name="493"/>  493:          ttest_sgeno_cgent_small_tcp6/1,
<a name="494"/>  494:          ttest_sgeno_cgent_medium_tcp4/1,
<a name="495"/>  495:          ttest_sgeno_cgent_medium_tcp6/1,
<a name="496"/>  496:          ttest_sgeno_cgent_large_tcp4/1,
<a name="497"/>  497:          ttest_sgeno_cgent_large_tcp6/1,
<a name="498"/>  498: 
<a name="499"/>  499:          %% Server: transport = gen_tcp, active = once
<a name="500"/>  500:          %% Client: transport = socket(tcp)
<a name="501"/>  501:          ttest_sgeno_csockf_small_tcp4/1,
<a name="502"/>  502:          ttest_sgeno_csockf_small_tcp6/1,
<a name="503"/>  503:          ttest_sgeno_csockf_medium_tcp4/1,
<a name="504"/>  504:          ttest_sgeno_csockf_medium_tcp6/1,
<a name="505"/>  505:          ttest_sgeno_csockf_large_tcp4/1,
<a name="506"/>  506:          ttest_sgeno_csockf_large_tcp6/1,
<a name="507"/>  507: 
<a name="508"/>  508:          ttest_sgeno_csocko_small_tcp4/1,
<a name="509"/>  509:          ttest_sgeno_csocko_small_tcp6/1,
<a name="510"/>  510:          ttest_sgeno_csocko_medium_tcp4/1,
<a name="511"/>  511:          ttest_sgeno_csocko_medium_tcp6/1,
<a name="512"/>  512:          ttest_sgeno_csocko_large_tcp4/1,
<a name="513"/>  513:          ttest_sgeno_csocko_large_tcp6/1,
<a name="514"/>  514: 
<a name="515"/>  515:          ttest_sgeno_csockt_small_tcp4/1,
<a name="516"/>  516:          ttest_sgeno_csockt_small_tcp6/1,
<a name="517"/>  517:          ttest_sgeno_csockt_medium_tcp4/1,
<a name="518"/>  518:          ttest_sgeno_csockt_medium_tcp6/1,
<a name="519"/>  519:          ttest_sgeno_csockt_large_tcp4/1,
<a name="520"/>  520:          ttest_sgeno_csockt_large_tcp6/1,
<a name="521"/>  521: 
<a name="522"/>  522:          %% Server: transport = gen_tcp, active = true
<a name="523"/>  523:          %% Client: transport = gen_tcp
<a name="524"/>  524:          ttest_sgent_cgenf_small_tcp4/1,
<a name="525"/>  525:          ttest_sgent_cgenf_small_tcp6/1,
<a name="526"/>  526:          ttest_sgent_cgenf_medium_tcp4/1,
<a name="527"/>  527:          ttest_sgent_cgenf_medium_tcp6/1,
<a name="528"/>  528:          ttest_sgent_cgenf_large_tcp4/1,
<a name="529"/>  529:          ttest_sgent_cgenf_large_tcp6/1,
<a name="530"/>  530: 
<a name="531"/>  531:          ttest_sgent_cgeno_small_tcp4/1,
<a name="532"/>  532:          ttest_sgent_cgeno_small_tcp6/1,
<a name="533"/>  533:          ttest_sgent_cgeno_medium_tcp4/1,
<a name="534"/>  534:          ttest_sgent_cgeno_medium_tcp6/1,
<a name="535"/>  535:          ttest_sgent_cgeno_large_tcp4/1,
<a name="536"/>  536:          ttest_sgent_cgeno_large_tcp6/1,
<a name="537"/>  537: 
<a name="538"/>  538:          ttest_sgent_cgent_small_tcp4/1,
<a name="539"/>  539:          ttest_sgent_cgent_small_tcp6/1,
<a name="540"/>  540:          ttest_sgent_cgent_medium_tcp4/0, ttest_sgent_cgent_medium_tcp4/1,
<a name="541"/>  541:          ttest_sgent_cgent_medium_tcp6/0, ttest_sgent_cgent_medium_tcp6/1,
<a name="542"/>  542:          ttest_sgent_cgent_large_tcp4/0, ttest_sgent_cgent_large_tcp4/1,
<a name="543"/>  543:          ttest_sgent_cgent_large_tcp6/0, ttest_sgent_cgent_large_tcp6/1,
<a name="544"/>  544: 
<a name="545"/>  545:          %% Server: transport = gen_tcp, active = true
<a name="546"/>  546:          %% Client: transport = socket(tcp)
<a name="547"/>  547:          ttest_sgent_csockf_small_tcp4/1,
<a name="548"/>  548:          ttest_sgent_csockf_small_tcp6/1,
<a name="549"/>  549:          ttest_sgent_csockf_medium_tcp4/1,
<a name="550"/>  550:          ttest_sgent_csockf_medium_tcp6/1,
<a name="551"/>  551:          ttest_sgent_csockf_large_tcp4/1,
<a name="552"/>  552:          ttest_sgent_csockf_large_tcp6/1,
<a name="553"/>  553: 
<a name="554"/>  554:          ttest_sgent_csocko_small_tcp4/1,
<a name="555"/>  555:          ttest_sgent_csocko_small_tcp6/1,
<a name="556"/>  556:          ttest_sgent_csocko_medium_tcp4/1,
<a name="557"/>  557:          ttest_sgent_csocko_medium_tcp6/1,
<a name="558"/>  558:          ttest_sgent_csocko_large_tcp4/1,
<a name="559"/>  559:          ttest_sgent_csocko_large_tcp6/1,
<a name="560"/>  560: 
<a name="561"/>  561:          ttest_sgent_csockt_small_tcp4/1,
<a name="562"/>  562:          ttest_sgent_csockt_small_tcp6/1,
<a name="563"/>  563:          ttest_sgent_csockt_medium_tcp4/1,
<a name="564"/>  564:          ttest_sgent_csockt_medium_tcp6/1,
<a name="565"/>  565:          ttest_sgent_csockt_large_tcp4/1,
<a name="566"/>  566:          ttest_sgent_csockt_large_tcp6/1,
<a name="567"/>  567: 
<a name="568"/>  568:          %% Server: transport = socket(tcp), active = false
<a name="569"/>  569:          %% Client: transport = gen_tcp
<a name="570"/>  570:          ttest_ssockf_cgenf_small_tcp4/1,
<a name="571"/>  571:          ttest_ssockf_cgenf_small_tcp6/1,
<a name="572"/>  572:          ttest_ssockf_cgenf_medium_tcp4/1,
<a name="573"/>  573:          ttest_ssockf_cgenf_medium_tcp6/1,
<a name="574"/>  574:          ttest_ssockf_cgenf_large_tcp4/1,
<a name="575"/>  575:          ttest_ssockf_cgenf_large_tcp6/1,
<a name="576"/>  576: 
<a name="577"/>  577:          ttest_ssockf_cgeno_small_tcp4/1,
<a name="578"/>  578:          ttest_ssockf_cgeno_small_tcp6/1,
<a name="579"/>  579:          ttest_ssockf_cgeno_medium_tcp4/1,
<a name="580"/>  580:          ttest_ssockf_cgeno_medium_tcp6/1,
<a name="581"/>  581:          ttest_ssockf_cgeno_large_tcp4/1,
<a name="582"/>  582:          ttest_ssockf_cgeno_large_tcp6/1,
<a name="583"/>  583: 
<a name="584"/>  584:          ttest_ssockf_cgent_small_tcp4/1,
<a name="585"/>  585:          ttest_ssockf_cgent_small_tcp6/1,
<a name="586"/>  586:          ttest_ssockf_cgent_medium_tcp4/1,
<a name="587"/>  587:          ttest_ssockf_cgent_medium_tcp6/1,
<a name="588"/>  588:          ttest_ssockf_cgent_large_tcp4/1,
<a name="589"/>  589:          ttest_ssockf_cgent_large_tcp6/1,
<a name="590"/>  590: 
<a name="591"/>  591:          %% Server: transport = socket(tcp), active = false
<a name="592"/>  592:          %% Client: transport = gen_tcp(socket)
<a name="593"/>  593:          ttest_ssockf_cgsf_small_tcp4/1,
<a name="594"/>  594:          ttest_ssockf_cgsf_small_tcp6/1,
<a name="595"/>  595:          ttest_ssockf_cgsf_medium_tcp4/1,
<a name="596"/>  596:          ttest_ssockf_cgsf_medium_tcp6/1,
<a name="597"/>  597:          ttest_ssockf_cgsf_large_tcp4/1,
<a name="598"/>  598:          ttest_ssockf_cgsf_large_tcp6/1,
<a name="599"/>  599: 
<a name="600"/>  600:          %% Server: transport = socket(tcp), active = false
<a name="601"/>  601:          %% Client: transport = socket(tcp)
<a name="602"/>  602:          ttest_ssockf_csockf_small_tcp4/1,
<a name="603"/>  603:          ttest_ssockf_csockf_small_tcp6/1,
<a name="604"/>  604:          ttest_ssockf_csockf_small_tcpL/1,
<a name="605"/>  605:          ttest_ssockf_csockf_medium_tcp4/1,
<a name="606"/>  606:          ttest_ssockf_csockf_medium_tcp6/1,
<a name="607"/>  607:          ttest_ssockf_csockf_medium_tcpL/1,
<a name="608"/>  608:          ttest_ssockf_csockf_large_tcp4/1,
<a name="609"/>  609:          ttest_ssockf_csockf_large_tcp6/1,
<a name="610"/>  610:          ttest_ssockf_csockf_large_tcpL/1,
<a name="611"/>  611: 
<a name="612"/>  612:          ttest_ssockf_csocko_small_tcp4/1,
<a name="613"/>  613:          ttest_ssockf_csocko_small_tcp6/1,
<a name="614"/>  614:          ttest_ssockf_csocko_small_tcpL/1,
<a name="615"/>  615:          ttest_ssockf_csocko_medium_tcp4/1,
<a name="616"/>  616:          ttest_ssockf_csocko_medium_tcp6/1,
<a name="617"/>  617:          ttest_ssockf_csocko_medium_tcpL/1,
<a name="618"/>  618:          ttest_ssockf_csocko_large_tcp4/1,
<a name="619"/>  619:          ttest_ssockf_csocko_large_tcp6/1,
<a name="620"/>  620:          ttest_ssockf_csocko_large_tcpL/1,
<a name="621"/>  621: 
<a name="622"/>  622:          ttest_ssockf_csockt_small_tcp4/1,
<a name="623"/>  623:          ttest_ssockf_csockt_small_tcp6/1,
<a name="624"/>  624:          ttest_ssockf_csockt_small_tcpL/1,
<a name="625"/>  625:          ttest_ssockf_csockt_medium_tcp4/1,
<a name="626"/>  626:          ttest_ssockf_csockt_medium_tcp6/1,
<a name="627"/>  627:          ttest_ssockf_csockt_medium_tcpL/1,
<a name="628"/>  628:          ttest_ssockf_csockt_large_tcp4/1,
<a name="629"/>  629:          ttest_ssockf_csockt_large_tcp6/1,
<a name="630"/>  630:          ttest_ssockf_csockt_large_tcpL/1,
<a name="631"/>  631: 
<a name="632"/>  632:          %% Server: transport = socket(tcp), active = once
<a name="633"/>  633:          %% Client: transport = gen_tcp
<a name="634"/>  634:          ttest_ssocko_cgenf_small_tcp4/1,
<a name="635"/>  635:          ttest_ssocko_cgenf_small_tcp6/1,
<a name="636"/>  636:          ttest_ssocko_cgenf_medium_tcp4/1,
<a name="637"/>  637:          ttest_ssocko_cgenf_medium_tcp6/1,
<a name="638"/>  638:          ttest_ssocko_cgenf_large_tcp4/1,
<a name="639"/>  639:          ttest_ssocko_cgenf_large_tcp6/1,
<a name="640"/>  640: 
<a name="641"/>  641:          ttest_ssocko_cgeno_small_tcp4/1,
<a name="642"/>  642:          ttest_ssocko_cgeno_small_tcp6/1,
<a name="643"/>  643:          ttest_ssocko_cgeno_medium_tcp4/1,
<a name="644"/>  644:          ttest_ssocko_cgeno_medium_tcp6/1,
<a name="645"/>  645:          ttest_ssocko_cgeno_large_tcp4/1,
<a name="646"/>  646:          ttest_ssocko_cgeno_large_tcp6/1,
<a name="647"/>  647: 
<a name="648"/>  648:          ttest_ssocko_cgent_small_tcp4/1,
<a name="649"/>  649:          ttest_ssocko_cgent_small_tcp6/1,
<a name="650"/>  650:          ttest_ssocko_cgent_medium_tcp4/1,
<a name="651"/>  651:          ttest_ssocko_cgent_medium_tcp6/1,
<a name="652"/>  652:          ttest_ssocko_cgent_large_tcp4/1,
<a name="653"/>  653:          ttest_ssocko_cgent_large_tcp6/1,
<a name="654"/>  654: 
<a name="655"/>  655:          %% Server: transport = socket(tcp), active = once
<a name="656"/>  656:          %% Client: transport = socket(tcp)
<a name="657"/>  657:          ttest_ssocko_csockf_small_tcp4/1,
<a name="658"/>  658:          ttest_ssocko_csockf_small_tcp6/1,
<a name="659"/>  659:          ttest_ssocko_csockf_small_tcpL/1,
<a name="660"/>  660:          ttest_ssocko_csockf_medium_tcp4/1,
<a name="661"/>  661:          ttest_ssocko_csockf_medium_tcpL/1,
<a name="662"/>  662:          ttest_ssocko_csockf_medium_tcp6/1,
<a name="663"/>  663:          ttest_ssocko_csockf_large_tcp4/1,
<a name="664"/>  664:          ttest_ssocko_csockf_large_tcp6/1,
<a name="665"/>  665:          ttest_ssocko_csockf_large_tcpL/1,
<a name="666"/>  666: 
<a name="667"/>  667:          ttest_ssocko_csocko_small_tcp4/1,
<a name="668"/>  668:          ttest_ssocko_csocko_small_tcp6/1,
<a name="669"/>  669:          ttest_ssocko_csocko_small_tcpL/1,
<a name="670"/>  670:          ttest_ssocko_csocko_medium_tcp4/1,
<a name="671"/>  671:          ttest_ssocko_csocko_medium_tcp6/1,
<a name="672"/>  672:          ttest_ssocko_csocko_medium_tcpL/1,
<a name="673"/>  673:          ttest_ssocko_csocko_large_tcp4/1,
<a name="674"/>  674:          ttest_ssocko_csocko_large_tcp6/1,
<a name="675"/>  675:          ttest_ssocko_csocko_large_tcpL/1,
<a name="676"/>  676: 
<a name="677"/>  677:          ttest_ssocko_csockt_small_tcp4/1,
<a name="678"/>  678:          ttest_ssocko_csockt_small_tcp6/1,
<a name="679"/>  679:          ttest_ssocko_csockt_small_tcpL/1,
<a name="680"/>  680:          ttest_ssocko_csockt_medium_tcp4/1,
<a name="681"/>  681:          ttest_ssocko_csockt_medium_tcp6/1,
<a name="682"/>  682:          ttest_ssocko_csockt_medium_tcpL/1,
<a name="683"/>  683:          ttest_ssocko_csockt_large_tcp4/1,
<a name="684"/>  684:          ttest_ssocko_csockt_large_tcp6/1,
<a name="685"/>  685:          ttest_ssocko_csockt_large_tcpL/1,
<a name="686"/>  686: 
<a name="687"/>  687:          %% Server: transport = socket(tcp), active = true
<a name="688"/>  688:          %% Client: transport = gen_tcp
<a name="689"/>  689:          ttest_ssockt_cgenf_small_tcp4/1,
<a name="690"/>  690:          ttest_ssockt_cgenf_small_tcp6/1,
<a name="691"/>  691:          ttest_ssockt_cgenf_medium_tcp4/1,
<a name="692"/>  692:          ttest_ssockt_cgenf_medium_tcp6/1,
<a name="693"/>  693:          ttest_ssockt_cgenf_large_tcp4/1,
<a name="694"/>  694:          ttest_ssockt_cgenf_large_tcp6/1,
<a name="695"/>  695: 
<a name="696"/>  696:          ttest_ssockt_cgeno_small_tcp4/1,
<a name="697"/>  697:          ttest_ssockt_cgeno_small_tcp6/1,
<a name="698"/>  698:          ttest_ssockt_cgeno_medium_tcp4/1,
<a name="699"/>  699:          ttest_ssockt_cgeno_medium_tcp6/1,
<a name="700"/>  700:          ttest_ssockt_cgeno_large_tcp4/1,
<a name="701"/>  701:          ttest_ssockt_cgeno_large_tcp6/1,
<a name="702"/>  702: 
<a name="703"/>  703:          ttest_ssockt_cgent_small_tcp4/1,
<a name="704"/>  704:          ttest_ssockt_cgent_small_tcp6/1,
<a name="705"/>  705:          ttest_ssockt_cgent_medium_tcp4/1,
<a name="706"/>  706:          ttest_ssockt_cgent_medium_tcp6/1,
<a name="707"/>  707:          ttest_ssockt_cgent_large_tcp4/1,
<a name="708"/>  708:          ttest_ssockt_cgent_large_tcp6/1,
<a name="709"/>  709: 
<a name="710"/>  710:          %% Server: transport = socket(tcp), active = true
<a name="711"/>  711:          %% Client: transport = socket(tcp)
<a name="712"/>  712:          ttest_ssockt_csockf_small_tcp4/1,
<a name="713"/>  713:          ttest_ssockt_csockf_small_tcp6/1,
<a name="714"/>  714:          ttest_ssockt_csockf_small_tcpL/1,
<a name="715"/>  715:          ttest_ssockt_csockf_medium_tcp4/1,
<a name="716"/>  716:          ttest_ssockt_csockf_medium_tcp6/1,
<a name="717"/>  717:          ttest_ssockt_csockf_medium_tcpL/1,
<a name="718"/>  718:          ttest_ssockt_csockf_large_tcp4/1,
<a name="719"/>  719:          ttest_ssockt_csockf_large_tcp6/1,
<a name="720"/>  720:          ttest_ssockt_csockf_large_tcpL/1,
<a name="721"/>  721: 
<a name="722"/>  722:          ttest_ssockt_csocko_small_tcp4/1,
<a name="723"/>  723:          ttest_ssockt_csocko_small_tcp6/1,
<a name="724"/>  724:          ttest_ssockt_csocko_small_tcpL/1,
<a name="725"/>  725:          ttest_ssockt_csocko_medium_tcp4/1,
<a name="726"/>  726:          ttest_ssockt_csocko_medium_tcp6/1,
<a name="727"/>  727:          ttest_ssockt_csocko_medium_tcpL/1,
<a name="728"/>  728:          ttest_ssockt_csocko_large_tcp4/1,
<a name="729"/>  729:          ttest_ssockt_csocko_large_tcp6/1,
<a name="730"/>  730:          ttest_ssockt_csocko_large_tcpL/1,
<a name="731"/>  731: 
<a name="732"/>  732:          ttest_ssockt_csockt_small_tcp4/1,
<a name="733"/>  733:          ttest_ssockt_csockt_small_tcp6/1,
<a name="734"/>  734:          ttest_ssockt_csockt_small_tcpL/1,
<a name="735"/>  735:          ttest_ssockt_csockt_medium_tcp4/1,
<a name="736"/>  736:          ttest_ssockt_csockt_medium_tcp6/1,
<a name="737"/>  737:          ttest_ssockt_csockt_medium_tcpL/1,
<a name="738"/>  738:          ttest_ssockt_csockt_large_tcp4/1,
<a name="739"/>  739:          ttest_ssockt_csockt_large_tcp6/1,
<a name="740"/>  740:          ttest_ssockt_csockt_large_tcpL/1,
<a name="741"/>  741: 
<a name="742"/>  742:          ttest_simple_ssockt_csocko_small_tcp4/1,
<a name="743"/>  743:          ttest_simple_ssockt_csocko_small_tcp6/1,
<a name="744"/>  744:          ttest_simple_ssockt_csocko_small_tcpL/1,
<a name="745"/>  745: 
<a name="746"/>  746:          %% Tickets
<a name="747"/>  747:          otp16359_maccept_tcp4/1,
<a name="748"/>  748:          otp16359_maccept_tcp6/1,
<a name="749"/>  749:          otp16359_maccept_tcpL/1,
<a name="750"/>  750:          otp18240_accept_mon_leak_tcp4/1,
<a name="751"/>  751:          otp18240_accept_mon_leak_tcp6/1,
<a name="752"/>  752:          otp18635/1
<a name="753"/>  753:         ]).
<a name="754"/>  754: 
<a name="755"/>  755: 
<a name="756"/>  756: <i>%% Internal exports</i>
<a name="757"/>  757: <i>%% -export([]).</i>
<a name="758"/>  758: 
<a name="759"/>  759: 
<a name="760"/>  760: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="761"/>  761: 
<a name="762"/>  762: <b>-define</b>(LIB,        socket_test_lib).
<a name="763"/>  763: <b>-define</b>(KLIB,       kernel_test_lib).
<a name="764"/>  764: <b>-define</b>(TTEST_LIB,  socket_test_ttest_lib).
<a name="765"/>  765: <b>-define</b>(LOGGER,     socket_test_logger).
<a name="766"/>  766: 
<a name="767"/>  767: <b>-define</b>(BASIC_REQ,  &lt;&lt;&quot;hejsan&quot;&gt;&gt;).
<a name="768"/>  768: <b>-define</b>(BASIC_REP,  &lt;&lt;&quot;hoppsan&quot;&gt;&gt;).
<a name="769"/>  769: 
<a name="770"/>  770: <b>-define</b>(DATA,       &lt;&lt;&quot;HOPPSAN&quot;&gt;&gt;). % Temporary
<a name="771"/>  771: <b>-define</b>(FAIL(R),    exit(R)).
<a name="772"/>  772: 
<a name="773"/>  773: <b>-define</b>(SLEEP(T),   receive after T -&gt; ok end).
<a name="774"/>  774: 
<a name="775"/>  775: <b>-define</b>(MINS(M),    timer:minutes(M)).
<a name="776"/>  776: <b>-define</b>(SECS(S),    timer:seconds(S)).
<a name="777"/>  777: 
<a name="778"/>  778: <b>-define</b>(TT(T),      ct:timetrap(T)).
<a name="779"/>  779: 
<a name="780"/>  780: <b>-define</b>(F(F, A),    ?LIB:f(F, A)).
<a name="781"/>  781: <b>-define</b>(P(F),       ?LIB:print(F)).
<a name="782"/>  782: <b>-define</b>(P(F, A),    ?LIB:print(F, A)).
<a name="783"/>  783: 
<a name="784"/>  784: 
<a name="785"/>  785: <b>-define</b>(TPP_SMALL,  lists:seq(1, 8)).
<a name="786"/>  786: <b>-define</b>(TPP_MEDIUM, lists:flatten(lists:duplicate(1024, ?TPP_SMALL))).
<a name="787"/>  787: <b>-define</b>(TPP_LARGE,  lists:flatten(lists:duplicate(1024, ?TPP_MEDIUM))).
<a name="788"/>  788: 
<a name="789"/>  789: <b>-define</b>(TPP_SMALL_NUM,  5000).
<a name="790"/>  790: <b>-define</b>(TPP_MEDIUM_NUM, 500).
<a name="791"/>  791: <b>-define</b>(TPP_LARGE_NUM,  50).
<a name="792"/>  792: <b>-define</b>(TPP_NUM(Config, Base), (Base) div lookup(kernel_factor, 1, Config)).
<a name="793"/>  793: 
<a name="794"/>  794: <b>-define</b>(WINDOWS, {win32,nt}).
<a name="795"/>  795: 
<a name="796"/>  796: <b>-define</b>(TTEST_RUNTIME,                       ?SECS(1)).
<a name="797"/>  797: <b>-define</b>(TTEST_MIN_FACTOR,                    3).
<a name="798"/>  798: <b>-define</b>(TTEST_MIN_FACTOR_WIN,                ?TTEST_MIN_FACTOR-1).
<a name="799"/>  799: <b>-define</b>(TTEST_DEFAULT_SMALL_MAX_OUTSTANDING, 50).
<a name="800"/>  800: <b>-define</b>(TTEST_DEFAULT_MEDIUM_MAX_OUTSTANDING,
<a name="801"/>  801:         ?TTEST_MK_DEFAULT_MAX_OUTSTANDING(
<a name="802"/>  802:            ?TTEST_DEFAULT_SMALL_MAX_OUTSTANDING)).
<a name="803"/>  803: <b>-define</b>(TTEST_DEFAULT_LARGE_MAX_OUTSTANDING,
<a name="804"/>  804:         ?TTEST_MK_DEFAULT_MAX_OUTSTANDING(
<a name="805"/>  805:            ?TTEST_DEFAULT_MEDIUM_MAX_OUTSTANDING)).
<a name="806"/>  806: 
<a name="807"/>  807: <b>-define</b>(TTEST_MK_DEFAULT_MAX_OUTSTANDING(__X__),
<a name="808"/>  808:         if ((__X__) &gt;= 5) -&gt;
<a name="809"/>  809:                 (__X__) div 5;
<a name="810"/>  810:            true -&gt;
<a name="811"/>  811:                 1
<a name="812"/>  812:         end).
<a name="813"/>  813: 
<a name="814"/>  814: <b>-define</b>(START_NODE(NamePre),
<a name="815"/>  815:         ?START_NODE(NamePre, 5000)).
<a name="816"/>  816: <b>-define</b>(START_NODE(NamePre, Timeout),
<a name="817"/>  817:         start_node(?CT_PEER_NAME(NamePre), Timeout)).
<a name="818"/>  818: 
<a name="819"/>  819: 
<a name="820"/>  820: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="821"/>  821: 
<a name="suite-0"/><a name="822"/>  822: <b>suite</b>() -&gt;
<a name="suite-last_expr"/><a name="823"/>  823:     [{ct_hooks, [ts_install_cth]},
<a name="824"/>  824:      {timetrap, {minutes,1}}].
<a name="825"/>  825: 
<a name="all-0"/><a name="826"/>  826: <b>all</b>() -&gt; 
<a name="827"/>  827:     Groups = [{api,          &quot;ESOCK_TEST_API&quot;,        include},
<a name="828"/>  828:               {reg,          &quot;ESOCK_TEST_REG&quot;,        include},
<a name="829"/>  829:               {monitor,      &quot;ESOCK_TEST_MON&quot;,        include},
<a name="830"/>  830:               {ioctl,        &quot;ESOCK_TEST_IOCTL&quot;,      include},
<a name="831"/>  831: 	      {socket_close, &quot;ESOCK_TEST_SOCK_CLOSE&quot;, include},
<a name="832"/>  832: 	      {traffic,      &quot;ESOCK_TEST_TRAFFIC&quot;,    include},
<a name="833"/>  833: 	      {ttest,        &quot;ESOCK_TEST_TTEST&quot;,      include},
<a name="834"/>  834: 	      {tickets,      &quot;ESOCK_TEST_TICKETS&quot;,    include}],
<a name="all-last_expr"/><a name="835"/>  835: <b>    [use_group</b>(Group, Env, Default) || {Group, Env, Default} &lt;- Groups].
<a name="836"/>  836: 
<a name="use_group-3"/><a name="837"/>  837: <b>use_group</b>(_Group, undefined, exclude) -&gt;
<a name="838"/>  838:     [];
<a name="839"/>  839: <b>use_group</b>(Group, undefined, _Default) -&gt;
<a name="840"/>  840:     [{group, Group}];
<a name="841"/>  841: <b>use_group</b>(Group, Env, Default) -&gt;
<a name="use_group-last_expr"/><a name="842"/>  842: <b>	case os:getenv</b>(Env) of
<a name="843"/>  843: 	    false when (Default =:= include) -&gt;
<a name="844"/>  844: 		[{group, Group}];
<a name="845"/>  845: 	    false -&gt;
<a name="846"/>  846: 		[];
<a name="847"/>  847: 	    Val -&gt;
<a name="848"/>  848: 		case list_to_atom(string:to_lower(Val)) of
<a name="849"/>  849: 		    Use when (Use =:= include) orelse 
<a name="850"/>  850: 			     (Use =:= enable) orelse 
<a name="851"/>  851: 			     (Use =:= true) -&gt;
<a name="852"/>  852: 			[{group, Group}];
<a name="853"/>  853: 		    _ -&gt;
<a name="854"/>  854: 			[]
<a name="855"/>  855: 		end
<a name="856"/>  856: 	end.
<a name="857"/>  857:     
<a name="858"/>  858: 
<a name="groups-0"/><a name="859"/>  859: <b>groups</b>() -&gt; 
<a name="groups-last_expr"/><a name="860"/>  860: <b>    [{api,                         [], api_cases</b>()},
<a name="861"/>  861:      {api_misc,                    [], api_misc_cases()},
<a name="862"/>  862:      {api_basic,                   [], api_basic_cases()},
<a name="863"/>  863:      {api_sendfile,                [], api_sendfile_cases()},
<a name="864"/>  864:      {api_from_fd,                 [], api_from_fd_cases()},
<a name="865"/>  865:      {api_async,                   [], api_async_cases()},
<a name="866"/>  866:      {api_async_ref,               [], api_async_cases()},
<a name="867"/>  867:      {api_options,                 [], api_options_cases()},
<a name="868"/>  868:      {api_options_otp,             [], api_options_otp_cases()},
<a name="869"/>  869:      {api_options_socket,          [], api_options_socket_cases()},
<a name="870"/>  870:      {api_option_sock_acceptconn,  [], api_option_sock_acceptconn_cases()},
<a name="871"/>  871:      {api_option_sock_passcred,    [], api_option_sock_passcred_cases()},
<a name="872"/>  872:      {api_option_sock_priority,    [], api_option_sock_priority_cases()},
<a name="873"/>  873:      {api_option_sock_buf,         [], api_option_sock_buf_cases()},
<a name="874"/>  874:      {api_option_sock_lowat,       [], api_option_sock_lowat_cases()},
<a name="875"/>  875:      {api_option_sock_timeo,       [], api_option_sock_timeo_cases()},
<a name="876"/>  876:      {api_option_sock_timestamp,   [], api_option_sock_timestamp_cases()},
<a name="877"/>  877:      {api_options_ip,              [], api_options_ip_cases()},
<a name="878"/>  878:      {api_options_ipv6,            [], api_options_ipv6_cases()},
<a name="879"/>  879:      {api_options_tcp,             [], api_options_tcp_cases()},
<a name="880"/>  880:      {api_options_udp,             [], api_options_udp_cases()},
<a name="881"/>  881:      %% {api_options_sctp,            [], api_options_sctp_cases()},
<a name="882"/>  882:      {api_op_with_timeout,         [], api_op_with_timeout_cases()},
<a name="883"/>  883:      {reg,                         [], reg_simple_cases()},
<a name="884"/>  884:      {monitor,                     [], monitor_cases()},
<a name="885"/>  885:      {socket_close,                [], socket_close_cases()},
<a name="886"/>  886:      {sc_ctrl_proc_exit,           [], sc_cp_exit_cases()},
<a name="887"/>  887:      {sc_local_close,              [], sc_lc_cases()},
<a name="888"/>  888:      {sc_remote_close,             [], sc_rc_cases()},
<a name="889"/>  889:      {sc_remote_shutdown,          [], sc_rs_cases()},
<a name="890"/>  890:      {ioctl,                       [], ioctl_cases()},
<a name="891"/>  891:      {ioctl_simple,                [], ioctl_simple_cases()},
<a name="892"/>  892:      {ioctl_get,                   [], ioctl_get_cases()},
<a name="893"/>  893:      {ioctl_set,                   [], ioctl_set_cases()},
<a name="894"/>  894:      {traffic,                     [], traffic_cases()},
<a name="895"/>  895:      {traffic_counters,            [], traffic_counters_cases()},
<a name="896"/>  896:      {traffic_chunks,              [], traffic_chunks_cases()},
<a name="897"/>  897:      {traffic_ping_pong,           [], traffic_ping_pong_cases()},
<a name="898"/>  898:      {traffic_pp_send_recv,        [], traffic_pp_send_recv_cases()},
<a name="899"/>  899:      {traffic_pp_sendto_recvfrom,  [], traffic_pp_sendto_recvfrom_cases()},
<a name="900"/>  900:      {traffic_pp_sendmsg_recvmsg,  [], traffic_pp_sendmsg_recvmsg_cases()},
<a name="901"/>  901:      {ttest,                       [], ttest_cases()},
<a name="902"/>  902:      {ttest_sgenf,                 [], ttest_sgenf_cases()},
<a name="903"/>  903:      {ttest_sgenf_cgen,            [], ttest_sgenf_cgen_cases()},
<a name="904"/>  904:      {ttest_sgenf_cgenf,           [], ttest_sgenf_cgenf_cases()},
<a name="905"/>  905:      {ttest_sgenf_cgeno,           [], ttest_sgenf_cgeno_cases()},
<a name="906"/>  906:      {ttest_sgenf_cgent,           [], ttest_sgenf_cgent_cases()},
<a name="907"/>  907:      {ttest_sgenf_csock,           [], ttest_sgenf_csock_cases()},
<a name="908"/>  908:      {ttest_sgenf_csockf,          [], ttest_sgenf_csockf_cases()},
<a name="909"/>  909:      {ttest_sgenf_csocko,          [], ttest_sgenf_csocko_cases()},
<a name="910"/>  910:      {ttest_sgenf_csockt,          [], ttest_sgenf_csockt_cases()},
<a name="911"/>  911:      {ttest_sgsf,                  [], ttest_sgsf_cases()},
<a name="912"/>  912:      {ttest_sgsf_csock,            [], ttest_sgsf_csock_cases()},
<a name="913"/>  913:      {ttest_sgsf_csockf,           [], ttest_sgsf_csockf_cases()},
<a name="914"/>  914:      {ttest_sgeno,                 [], ttest_sgeno_cases()},
<a name="915"/>  915:      {ttest_sgeno_cgen,            [], ttest_sgeno_cgen_cases()},
<a name="916"/>  916:      {ttest_sgeno_cgenf,           [], ttest_sgeno_cgenf_cases()},
<a name="917"/>  917:      {ttest_sgeno_cgeno,           [], ttest_sgeno_cgeno_cases()},
<a name="918"/>  918:      {ttest_sgeno_cgent,           [], ttest_sgeno_cgent_cases()},
<a name="919"/>  919:      {ttest_sgeno_csock,           [], ttest_sgeno_csock_cases()},
<a name="920"/>  920:      {ttest_sgeno_csockf,          [], ttest_sgeno_csockf_cases()},
<a name="921"/>  921:      {ttest_sgeno_csocko,          [], ttest_sgeno_csocko_cases()},
<a name="922"/>  922:      {ttest_sgeno_csockt,          [], ttest_sgeno_csockt_cases()},
<a name="923"/>  923:      {ttest_sgent,                 [], ttest_sgent_cases()},
<a name="924"/>  924:      {ttest_sgent_cgen,            [], ttest_sgent_cgen_cases()},
<a name="925"/>  925:      {ttest_sgent_cgenf,           [], ttest_sgent_cgenf_cases()},
<a name="926"/>  926:      {ttest_sgent_cgeno,           [], ttest_sgent_cgeno_cases()},
<a name="927"/>  927:      {ttest_sgent_cgent,           [], ttest_sgent_cgent_cases()},
<a name="928"/>  928:      {ttest_sgent_csock,           [], ttest_sgent_csock_cases()},
<a name="929"/>  929:      {ttest_sgent_csockf,          [], ttest_sgent_csockf_cases()},
<a name="930"/>  930:      {ttest_sgent_csocko,          [], ttest_sgent_csocko_cases()},
<a name="931"/>  931:      {ttest_sgent_csockt,          [], ttest_sgent_csockt_cases()},
<a name="932"/>  932:      {ttest_ssockf,                [], ttest_ssockf_cases()},
<a name="933"/>  933:      {ttest_ssockf_cgen,           [], ttest_ssockf_cgen_cases()},
<a name="934"/>  934:      {ttest_ssockf_cgenf,          [], ttest_ssockf_cgenf_cases()},
<a name="935"/>  935:      {ttest_ssockf_cgeno,          [], ttest_ssockf_cgeno_cases()},
<a name="936"/>  936:      {ttest_ssockf_cgent,          [], ttest_ssockf_cgent_cases()},
<a name="937"/>  937:      {ttest_ssockf_cgs,            [], ttest_ssockf_cgs_cases()},
<a name="938"/>  938:      {ttest_ssockf_cgsf,           [], ttest_ssockf_cgsf_cases()},
<a name="939"/>  939:      {ttest_ssockf_csock,          [], ttest_ssockf_csock_cases()},
<a name="940"/>  940:      {ttest_ssockf_csockf,         [], ttest_ssockf_csockf_cases()},
<a name="941"/>  941:      {ttest_ssockf_csocko,         [], ttest_ssockf_csocko_cases()},
<a name="942"/>  942:      {ttest_ssockf_csockt,         [], ttest_ssockf_csockt_cases()},
<a name="943"/>  943:      {ttest_ssocko,                [], ttest_ssocko_cases()},
<a name="944"/>  944:      {ttest_ssocko_cgen,           [], ttest_ssocko_cgen_cases()},
<a name="945"/>  945:      {ttest_ssocko_cgenf,          [], ttest_ssocko_cgenf_cases()},
<a name="946"/>  946:      {ttest_ssocko_cgeno,          [], ttest_ssocko_cgeno_cases()},
<a name="947"/>  947:      {ttest_ssocko_cgent,          [], ttest_ssocko_cgent_cases()},
<a name="948"/>  948:      {ttest_ssocko_csock,          [], ttest_ssocko_csock_cases()},
<a name="949"/>  949:      {ttest_ssocko_csockf,         [], ttest_ssocko_csockf_cases()},
<a name="950"/>  950:      {ttest_ssocko_csocko,         [], ttest_ssocko_csocko_cases()},
<a name="951"/>  951:      {ttest_ssocko_csockt,         [], ttest_ssocko_csockt_cases()},
<a name="952"/>  952:      {ttest_ssockt,                [], ttest_ssockt_cases()},
<a name="953"/>  953:      {ttest_ssockt_cgen,           [], ttest_ssockt_cgen_cases()},
<a name="954"/>  954:      {ttest_ssockt_cgenf,          [], ttest_ssockt_cgenf_cases()},
<a name="955"/>  955:      {ttest_ssockt_cgeno,          [], ttest_ssockt_cgeno_cases()},
<a name="956"/>  956:      {ttest_ssockt_cgent,          [], ttest_ssockt_cgent_cases()},
<a name="957"/>  957:      {ttest_ssockt_csock,          [], ttest_ssockt_csock_cases()},
<a name="958"/>  958:      {ttest_ssockt_csockf,         [], ttest_ssockt_csockf_cases()},
<a name="959"/>  959:      {ttest_ssockt_csocko,         [], ttest_ssockt_csocko_cases()},
<a name="960"/>  960:      {ttest_ssockt_csockt,         [], ttest_ssockt_csockt_cases()},
<a name="961"/>  961:      {ttest_simple_ssockt,         [], ttest_simple_ssockt_cases()},
<a name="962"/>  962:      {ttest_simple_ssockt_csock,   [], ttest_simple_ssockt_csock_cases()},
<a name="963"/>  963:      {ttest_simple_ssockt_csocko,  [], ttest_simple_ssockt_csocko_cases()},
<a name="964"/>  964: 
<a name="965"/>  965:      %% Ticket groups
<a name="966"/>  966:      {tickets,                     [], tickets_cases()},
<a name="967"/>  967:      {otp16359,                    [], otp16359_cases()},
<a name="968"/>  968:      {otp18240,                    [], otp18240_cases()}
<a name="969"/>  969:     ].
<a name="970"/>  970:      
<a name="api_cases-0"/><a name="971"/>  971: <b>api_cases</b>() -&gt;
<a name="api_cases-last_expr"/><a name="972"/>  972:     [
<a name="973"/>  973:      {group, api_misc},
<a name="974"/>  974:      {group, api_basic},
<a name="975"/>  975:      {group, api_sendfile},
<a name="976"/>  976:      {group, api_async},
<a name="977"/>  977:      {group, api_async_ref},
<a name="978"/>  978:      {group, api_options},
<a name="979"/>  979:      {group, api_op_with_timeout}
<a name="980"/>  980:     ].
<a name="981"/>  981: 
<a name="api_misc_cases-0"/><a name="982"/>  982: <b>api_misc_cases</b>() -&gt;
<a name="api_misc_cases-last_expr"/><a name="983"/>  983:     [
<a name="984"/>  984:      api_m_info,
<a name="985"/>  985:      api_m_debug,
<a name="986"/>  986:      api_m_error_open,
<a name="987"/>  987:      api_m_error_bind
<a name="988"/>  988:     ].
<a name="989"/>  989: 
<a name="api_basic_cases-0"/><a name="990"/>  990: <b>api_basic_cases</b>() -&gt;
<a name="api_basic_cases-last_expr"/><a name="991"/>  991:     [
<a name="992"/>  992:      api_b_simple_open_and_close_udp4,
<a name="993"/>  993:      api_b_simple_open_and_close_udp6,
<a name="994"/>  994:      api_b_simple_open_and_close_tcp4,
<a name="995"/>  995:      api_b_simple_open_and_close_tcp6,
<a name="996"/>  996:      api_b_open_and_info_udp4,
<a name="997"/>  997:      api_b_open_and_info_udp6,
<a name="998"/>  998:      api_b_open_and_info_tcp4,
<a name="999"/>  999:      api_b_open_and_info_tcp6,
<a name="1000"/> 1000:      api_b_open_and_close_udp4,
<a name="1001"/> 1001:      api_b_open_and_close_udp6,
<a name="1002"/> 1002:      api_b_open_and_close_tcp4,
<a name="1003"/> 1003:      api_b_open_and_close_tcp6,
<a name="1004"/> 1004:      api_b_open_and_close_udpL,
<a name="1005"/> 1005:      api_b_open_and_close_tcpL,
<a name="1006"/> 1006:      api_b_open_and_close_seqpL,
<a name="1007"/> 1007:      api_b_open_and_close_sctp4,
<a name="1008"/> 1008:      api_b_open_and_maybe_close_raw,
<a name="1009"/> 1009:      api_b_sendto_and_recvfrom_udp4,
<a name="1010"/> 1010:      api_b_sendto_and_recvfrom_udpL,
<a name="1011"/> 1011:      api_b_sendmsg_and_recvmsg_udp4,
<a name="1012"/> 1012:      api_b_sendmsg_and_recvmsg_udpL,
<a name="1013"/> 1013:      api_b_send_and_recv_tcp4,
<a name="1014"/> 1014:      api_b_send_and_recv_tcpL,
<a name="1015"/> 1015:      api_b_send_and_recv_seqpL,
<a name="1016"/> 1016:      api_b_sendmsg_and_recvmsg_tcp4,
<a name="1017"/> 1017:      api_b_sendmsg_and_recvmsg_tcpL,
<a name="1018"/> 1018:      api_b_sendmsg_and_recvmsg_seqpL,
<a name="1019"/> 1019:      api_b_sendmsg_and_recvmsg_sctp4,
<a name="1020"/> 1020:      api_b_sendmsg_iov_dgram_inet,
<a name="1021"/> 1021:      api_b_sendmsg_iov_dgram_inet6,
<a name="1022"/> 1022:      api_b_sendmsg_iov_dgram_local,
<a name="1023"/> 1023:      api_b_sendmsg_iov_stream_inet,
<a name="1024"/> 1024:      api_b_sendmsg_iov_stream_inet6,
<a name="1025"/> 1025:      api_b_sendmsg_iov_stream_local,
<a name="1026"/> 1026:      api_b_dgram_connect_udp4,
<a name="1027"/> 1027:      api_b_dgram_connect_udp6
<a name="1028"/> 1028:     ].
<a name="1029"/> 1029: 
<a name="api_sendfile_cases-0"/><a name="1030"/> 1030: <b>api_sendfile_cases</b>() -&gt;
<a name="api_sendfile_cases-last_expr"/><a name="1031"/> 1031:     [
<a name="1032"/> 1032:      api_sendfile_inet,
<a name="1033"/> 1033:      api_sendfile_inet6,
<a name="1034"/> 1034:      api_sendfile_local,
<a name="1035"/> 1035:      api_sendfile_loop_inet,
<a name="1036"/> 1036:      api_sendfile_loop_inet6,
<a name="1037"/> 1037:      api_sendfile_loop_local
<a name="1038"/> 1038:     ].
<a name="1039"/> 1039: 
<a name="api_from_fd_cases-0"/><a name="1040"/> 1040: <b>api_from_fd_cases</b>() -&gt;
<a name="api_from_fd_cases-last_expr"/><a name="1041"/> 1041:     [
<a name="1042"/> 1042:      api_ffd_open_wod_and_info_udp4,
<a name="1043"/> 1043:      api_ffd_open_wod_and_info_udp6,
<a name="1044"/> 1044:      api_ffd_open_wod_and_info_tcp4,
<a name="1045"/> 1045:      api_ffd_open_wod_and_info_tcp6,
<a name="1046"/> 1046:      api_ffd_open_wd_and_info_udp4,
<a name="1047"/> 1047:      api_ffd_open_wd_and_info_udp6,
<a name="1048"/> 1048:      api_ffd_open_wd_and_info_tcp4,
<a name="1049"/> 1049:      api_ffd_open_wd_and_info_tcp6,
<a name="1050"/> 1050:      api_ffd_open_and_open_wod_and_send_udp4,
<a name="1051"/> 1051:      api_ffd_open_and_open_wod_and_send_udp6,
<a name="1052"/> 1052:      api_ffd_open_and_open_wd_and_send_udp4,
<a name="1053"/> 1053:      api_ffd_open_and_open_wd_and_send_udp6,
<a name="1054"/> 1054:      api_ffd_open_connect_and_open_wod_and_send_tcp4,
<a name="1055"/> 1055:      api_ffd_open_connect_and_open_wod_and_send_tcp6,
<a name="1056"/> 1056:      api_ffd_open_connect_and_open_wd_and_send_tcp4,
<a name="1057"/> 1057:      api_ffd_open_connect_and_open_wd_and_send_tcp6
<a name="1058"/> 1058:     ].
<a name="1059"/> 1059: 
<a name="api_async_cases-0"/><a name="1060"/> 1060: <b>api_async_cases</b>() -&gt;
<a name="api_async_cases-last_expr"/><a name="1061"/> 1061:     [
<a name="1062"/> 1062:      api_a_connect_tcp4,
<a name="1063"/> 1063:      api_a_connect_tcp6,
<a name="1064"/> 1064:      api_a_sendto_and_recvfrom_udp4,
<a name="1065"/> 1065:      api_a_sendto_and_recvfrom_udp6,
<a name="1066"/> 1066:      api_a_sendmsg_and_recvmsg_udp4,
<a name="1067"/> 1067:      api_a_sendmsg_and_recvmsg_udp6,
<a name="1068"/> 1068:      api_a_send_and_recv_tcp4,
<a name="1069"/> 1069:      api_a_send_and_recv_tcp6,
<a name="1070"/> 1070:      api_a_sendmsg_and_recvmsg_tcp4,
<a name="1071"/> 1071:      api_a_sendmsg_and_recvmsg_tcp6,
<a name="1072"/> 1072:      api_a_recvfrom_cancel_udp4,
<a name="1073"/> 1073:      api_a_recvfrom_cancel_udp6,
<a name="1074"/> 1074:      api_a_recvmsg_cancel_udp4,
<a name="1075"/> 1075:      api_a_recvmsg_cancel_udp6,
<a name="1076"/> 1076:      api_a_accept_cancel_tcp4,
<a name="1077"/> 1077:      api_a_accept_cancel_tcp6,
<a name="1078"/> 1078:      api_a_recv_cancel_tcp4,
<a name="1079"/> 1079:      api_a_recv_cancel_tcp6,
<a name="1080"/> 1080:      api_a_recvmsg_cancel_tcp4,
<a name="1081"/> 1081:      api_a_recvmsg_cancel_tcp6,
<a name="1082"/> 1082:      api_a_mrecvfrom_cancel_udp4,
<a name="1083"/> 1083:      api_a_mrecvfrom_cancel_udp6,
<a name="1084"/> 1084:      api_a_mrecvmsg_cancel_udp4,
<a name="1085"/> 1085:      api_a_mrecvmsg_cancel_udp6,
<a name="1086"/> 1086:      api_a_maccept_cancel_tcp4,
<a name="1087"/> 1087:      api_a_maccept_cancel_tcp6,
<a name="1088"/> 1088:      api_a_mrecv_cancel_tcp4,
<a name="1089"/> 1089:      api_a_mrecv_cancel_tcp6,
<a name="1090"/> 1090:      api_a_mrecvmsg_cancel_tcp4,
<a name="1091"/> 1091:      api_a_mrecvmsg_cancel_tcp6
<a name="1092"/> 1092:     ].
<a name="1093"/> 1093: 
<a name="api_options_cases-0"/><a name="1094"/> 1094: <b>api_options_cases</b>() -&gt;
<a name="api_options_cases-last_expr"/><a name="1095"/> 1095:     [
<a name="1096"/> 1096:      {group, api_options_otp},
<a name="1097"/> 1097:      {group, api_options_socket},
<a name="1098"/> 1098:      {group, api_options_ip},
<a name="1099"/> 1099:      {group, api_options_ipv6},
<a name="1100"/> 1100:      {group, api_options_tcp},
<a name="1101"/> 1101:      {group, api_options_udp}
<a name="1102"/> 1102:      %% {group, api_options_sctp}
<a name="1103"/> 1103:     ].
<a name="1104"/> 1104: 
<a name="api_options_otp_cases-0"/><a name="1105"/> 1105: <b>api_options_otp_cases</b>() -&gt;
<a name="api_options_otp_cases-last_expr"/><a name="1106"/> 1106:     [
<a name="1107"/> 1107:      api_opt_simple_otp_options,
<a name="1108"/> 1108:      api_opt_simple_otp_meta_option,
<a name="1109"/> 1109:      api_opt_simple_otp_rcvbuf_option,
<a name="1110"/> 1110:      api_opt_simple_otp_controlling_process
<a name="1111"/> 1111:     ].
<a name="1112"/> 1112: 
<a name="api_options_socket_cases-0"/><a name="1113"/> 1113: <b>api_options_socket_cases</b>() -&gt;
<a name="api_options_socket_cases-last_expr"/><a name="1114"/> 1114:     [
<a name="1115"/> 1115:      {group, api_option_sock_acceptconn},
<a name="1116"/> 1116:      api_opt_sock_acceptfilter,
<a name="1117"/> 1117:      api_opt_sock_bindtodevice,
<a name="1118"/> 1118:      api_opt_sock_broadcast,
<a name="1119"/> 1119:      api_opt_sock_debug,
<a name="1120"/> 1120:      api_opt_sock_domain,
<a name="1121"/> 1121:      api_opt_sock_dontroute,
<a name="1122"/> 1122:      api_opt_sock_error,
<a name="1123"/> 1123:      api_opt_sock_keepalive,
<a name="1124"/> 1124:      api_opt_sock_linger,
<a name="1125"/> 1125:      api_opt_sock_mark,
<a name="1126"/> 1126:      api_opt_sock_maxdg,
<a name="1127"/> 1127:      api_opt_sock_max_msg_size,
<a name="1128"/> 1128:      api_opt_sock_oobinline,
<a name="1129"/> 1129:      {group, api_option_sock_passcred},
<a name="1130"/> 1130:      api_opt_sock_peek_off_tcpL,
<a name="1131"/> 1131:      api_opt_sock_peercred_tcpL,
<a name="1132"/> 1132:      {group, api_option_sock_priority},
<a name="1133"/> 1133:      {group, api_option_sock_buf},
<a name="1134"/> 1134:      {group, api_option_sock_lowat},
<a name="1135"/> 1135:      {group, api_option_sock_timeo},
<a name="1136"/> 1136:      {group, api_option_sock_timestamp},
<a name="1137"/> 1137:      api_opt_sock_reuseaddr,
<a name="1138"/> 1138:      api_opt_sock_exclusiveaddruse,
<a name="1139"/> 1139:      api_opt_sock_bsp_state
<a name="1140"/> 1140: 
<a name="1141"/> 1141:     ].
<a name="1142"/> 1142: 
<a name="api_option_sock_acceptconn_cases-0"/><a name="1143"/> 1143: <b>api_option_sock_acceptconn_cases</b>() -&gt;
<a name="api_option_sock_acceptconn_cases-last_expr"/><a name="1144"/> 1144:     [
<a name="1145"/> 1145:      api_opt_sock_acceptconn_udp,
<a name="1146"/> 1146:      api_opt_sock_acceptconn_tcp
<a name="1147"/> 1147:     ].
<a name="1148"/> 1148: 
<a name="api_option_sock_passcred_cases-0"/><a name="1149"/> 1149: <b>api_option_sock_passcred_cases</b>() -&gt;
<a name="api_option_sock_passcred_cases-last_expr"/><a name="1150"/> 1150:     [
<a name="1151"/> 1151:      %% api_opt_sock_passcred_udp4,
<a name="1152"/> 1152:      api_opt_sock_passcred_tcp4
<a name="1153"/> 1153:     ].
<a name="1154"/> 1154: 
<a name="api_option_sock_priority_cases-0"/><a name="1155"/> 1155: <b>api_option_sock_priority_cases</b>() -&gt;
<a name="api_option_sock_priority_cases-last_expr"/><a name="1156"/> 1156:     [
<a name="1157"/> 1157:      api_opt_sock_priority_udp4,
<a name="1158"/> 1158:      api_opt_sock_priority_tcp4%,
<a name="1159"/> 1159:      %% api_opt_sock_priority_udp6,
<a name="1160"/> 1160:      %% api_opt_sock_priority_tcp6
<a name="1161"/> 1161:     ].
<a name="1162"/> 1162: 
<a name="api_option_sock_buf_cases-0"/><a name="1163"/> 1163: <b>api_option_sock_buf_cases</b>() -&gt;
<a name="api_option_sock_buf_cases-last_expr"/><a name="1164"/> 1164:     [
<a name="1165"/> 1165:      api_opt_sock_rcvbuf_udp4,
<a name="1166"/> 1166:      api_opt_sock_sndbuf_udp4
<a name="1167"/> 1167:     ].
<a name="1168"/> 1168: 
<a name="api_option_sock_lowat_cases-0"/><a name="1169"/> 1169: <b>api_option_sock_lowat_cases</b>() -&gt;
<a name="api_option_sock_lowat_cases-last_expr"/><a name="1170"/> 1170:     [
<a name="1171"/> 1171:      api_opt_sock_rcvlowat_udp4,
<a name="1172"/> 1172:      api_opt_sock_sndlowat_udp4
<a name="1173"/> 1173:     ].
<a name="1174"/> 1174: 
<a name="api_option_sock_timeo_cases-0"/><a name="1175"/> 1175: <b>api_option_sock_timeo_cases</b>() -&gt;
<a name="api_option_sock_timeo_cases-last_expr"/><a name="1176"/> 1176:     [
<a name="1177"/> 1177:      api_opt_sock_rcvtimeo_udp4,
<a name="1178"/> 1178:      api_opt_sock_sndtimeo_udp4
<a name="1179"/> 1179:     ].
<a name="1180"/> 1180: 
<a name="api_option_sock_timestamp_cases-0"/><a name="1181"/> 1181: <b>api_option_sock_timestamp_cases</b>() -&gt;
<a name="api_option_sock_timestamp_cases-last_expr"/><a name="1182"/> 1182:     [
<a name="1183"/> 1183:      api_opt_sock_timestamp_udp4,
<a name="1184"/> 1184:      api_opt_sock_timestamp_tcp4
<a name="1185"/> 1185:     ].
<a name="1186"/> 1186: 
<a name="api_options_ip_cases-0"/><a name="1187"/> 1187: <b>api_options_ip_cases</b>() -&gt;
<a name="api_options_ip_cases-last_expr"/><a name="1188"/> 1188:     [
<a name="1189"/> 1189:      api_opt_ip_add_drop_membership,
<a name="1190"/> 1190:      api_opt_ip_pktinfo_udp4,
<a name="1191"/> 1191:      api_opt_ip_recvopts_udp4,
<a name="1192"/> 1192:      api_opt_ip_recvorigdstaddr_udp4,
<a name="1193"/> 1193:      api_opt_ip_recvtos_udp4,
<a name="1194"/> 1194:      api_opt_ip_recvttl_udp4,
<a name="1195"/> 1195:      api_opt_ip_tos_udp4,
<a name="1196"/> 1196:      api_opt_ip_recverr_udp4,
<a name="1197"/> 1197: 
<a name="1198"/> 1198:      %% Should be last!
<a name="1199"/> 1199:      api_opt_ip_mopts_udp4
<a name="1200"/> 1200:     ].
<a name="1201"/> 1201: 
<a name="api_options_ipv6_cases-0"/><a name="1202"/> 1202: <b>api_options_ipv6_cases</b>() -&gt;
<a name="api_options_ipv6_cases-last_expr"/><a name="1203"/> 1203:     [
<a name="1204"/> 1204:      api_opt_ipv6_recvpktinfo_udp6,
<a name="1205"/> 1205:      api_opt_ipv6_flowinfo_udp6,
<a name="1206"/> 1206:      api_opt_ipv6_hoplimit_udp6,
<a name="1207"/> 1207:      api_opt_ipv6_tclass_udp6,
<a name="1208"/> 1208:      api_opt_ipv6_recverr_udp6,
<a name="1209"/> 1209: 
<a name="1210"/> 1210:      %% Should be last!
<a name="1211"/> 1211:      api_opt_ipv6_mopts_udp6
<a name="1212"/> 1212:     ].
<a name="1213"/> 1213: 
<a name="api_options_tcp_cases-0"/><a name="1214"/> 1214: <b>api_options_tcp_cases</b>() -&gt;
<a name="api_options_tcp_cases-last_expr"/><a name="1215"/> 1215:     [
<a name="1216"/> 1216:      api_opt_tcp_congestion_tcp4,
<a name="1217"/> 1217:      %% api_opt_tcp_congestion_tcp6,
<a name="1218"/> 1218:      api_opt_tcp_cork_tcp4,
<a name="1219"/> 1219:      %% api_opt_tcp_cork_tcp6,
<a name="1220"/> 1220:      api_opt_tcp_maxseg_tcp4,
<a name="1221"/> 1221:      %% api_opt_tcp_maxseg_tcp6,
<a name="1222"/> 1222:      api_opt_tcp_nodelay_tcp4,
<a name="1223"/> 1223:      %% api_opt_tcp_nodelay_tcp6
<a name="1224"/> 1224:      api_opt_tcp_keepcnt_tcp4,
<a name="1225"/> 1225:      api_opt_tcp_keepidle_tcp4,
<a name="1226"/> 1226:      api_opt_tcp_keepintvl_tcp4
<a name="1227"/> 1227:     ].
<a name="1228"/> 1228: 
<a name="api_options_udp_cases-0"/><a name="1229"/> 1229: <b>api_options_udp_cases</b>() -&gt;
<a name="api_options_udp_cases-last_expr"/><a name="1230"/> 1230:     [
<a name="1231"/> 1231:      api_opt_udp_cork_udp4%,
<a name="1232"/> 1232:      %% api_opt_udp_cork_udp6
<a name="1233"/> 1233:     ].
<a name="1234"/> 1234: 
<a name="api_op_with_timeout_cases-0"/><a name="1235"/> 1235: <b>api_op_with_timeout_cases</b>() -&gt;
<a name="api_op_with_timeout_cases-last_expr"/><a name="1236"/> 1236:     [
<a name="1237"/> 1237:      api_to_connect_tcp4,
<a name="1238"/> 1238:      api_to_connect_tcp6,
<a name="1239"/> 1239:      api_to_accept_tcp4,
<a name="1240"/> 1240:      api_to_accept_tcp6,
<a name="1241"/> 1241:      api_to_maccept_tcp4,
<a name="1242"/> 1242:      api_to_maccept_tcp6,
<a name="1243"/> 1243:      api_to_send_tcp4,
<a name="1244"/> 1244:      api_to_send_tcp6,
<a name="1245"/> 1245:      api_to_sendto_udp4,
<a name="1246"/> 1246:      api_to_sendto_udp6,
<a name="1247"/> 1247:      api_to_sendmsg_tcp4,
<a name="1248"/> 1248:      api_to_sendmsg_tcp6,
<a name="1249"/> 1249:      api_to_recv_udp4,
<a name="1250"/> 1250:      api_to_recv_udp6,
<a name="1251"/> 1251:      api_to_recv_tcp4,
<a name="1252"/> 1252:      api_to_recv_tcp6,
<a name="1253"/> 1253:      api_to_recvfrom_udp4,
<a name="1254"/> 1254:      api_to_recvfrom_udp6,
<a name="1255"/> 1255:      api_to_recvmsg_udp4,
<a name="1256"/> 1256:      api_to_recvmsg_udp6,
<a name="1257"/> 1257:      api_to_recvmsg_tcp4,
<a name="1258"/> 1258:      api_to_recvmsg_tcp6
<a name="1259"/> 1259:     ].
<a name="1260"/> 1260: 
<a name="1261"/> 1261: <i>%% Socket Registry &quot;simple&quot; test cases</i>
<a name="reg_simple_cases-0"/><a name="1262"/> 1262: <b>reg_simple_cases</b>() -&gt;
<a name="reg_simple_cases-last_expr"/><a name="1263"/> 1263:     [
<a name="1264"/> 1264:      reg_s_single_open_and_close_and_count,
<a name="1265"/> 1265:      reg_s_optional_open_and_close_and_count
<a name="1266"/> 1266:     ].
<a name="1267"/> 1267: 
<a name="1268"/> 1268: 
<a name="1269"/> 1269: <i>%% Socket monitor test cases</i>
<a name="monitor_cases-0"/><a name="1270"/> 1270: <b>monitor_cases</b>() -&gt;
<a name="monitor_cases-last_expr"/><a name="1271"/> 1271:     [
<a name="1272"/> 1272:      monitor_simple_open_and_close,
<a name="1273"/> 1273:      monitor_simple_open_and_exit,
<a name="1274"/> 1274:      monitor_simple_open_and_demon_and_close,
<a name="1275"/> 1275:      monitor_open_and_close_multi_socks,
<a name="1276"/> 1276:      monitor_open_and_exit_multi_socks,
<a name="1277"/> 1277:      monitor_open_and_demon_and_close_multi_socks,
<a name="1278"/> 1278:      monitor_open_and_close_multi_mon,
<a name="1279"/> 1279:      monitor_open_and_exit_multi_mon,
<a name="1280"/> 1280:      monitor_open_and_close_multi_socks_and_mon,
<a name="1281"/> 1281:      monitor_open_and_exit_multi_socks_and_mon,
<a name="1282"/> 1282:      monitor_closed_socket
<a name="1283"/> 1283:     ].
<a name="1284"/> 1284: 
<a name="1285"/> 1285: 
<a name="1286"/> 1286: <i>%% These cases tests what happens when the socket is closed/shutdown,</i>
<a name="1287"/> 1287: <i>%% locally or remotely.</i>
<a name="socket_close_cases-0"/><a name="1288"/> 1288: <b>socket_close_cases</b>() -&gt;
<a name="socket_close_cases-last_expr"/><a name="1289"/> 1289:     [
<a name="1290"/> 1290:      {group, sc_ctrl_proc_exit},
<a name="1291"/> 1291:      {group, sc_local_close},
<a name="1292"/> 1292:      {group, sc_remote_close},
<a name="1293"/> 1293:      {group, sc_remote_shutdown}
<a name="1294"/> 1294:     ].
<a name="1295"/> 1295: 
<a name="1296"/> 1296: <i>%% These cases are all about socket cleanup after the controlling process</i>
<a name="1297"/> 1297: <i>%% exits *without* explicitly calling socket:close/1.</i>
<a name="sc_cp_exit_cases-0"/><a name="1298"/> 1298: <b>sc_cp_exit_cases</b>() -&gt;
<a name="sc_cp_exit_cases-last_expr"/><a name="1299"/> 1299:     [
<a name="1300"/> 1300:      sc_cpe_socket_cleanup_tcp4,
<a name="1301"/> 1301:      sc_cpe_socket_cleanup_tcp6,
<a name="1302"/> 1302:      sc_cpe_socket_cleanup_tcpL,
<a name="1303"/> 1303:      sc_cpe_socket_cleanup_udp4,
<a name="1304"/> 1304:      sc_cpe_socket_cleanup_udp6,
<a name="1305"/> 1305:      sc_cpe_socket_cleanup_udpL
<a name="1306"/> 1306:     ].
<a name="1307"/> 1307: 
<a name="1308"/> 1308: <i>%% These cases tests what happens when the socket is closed locally.</i>
<a name="sc_lc_cases-0"/><a name="1309"/> 1309: <b>sc_lc_cases</b>() -&gt;
<a name="sc_lc_cases-last_expr"/><a name="1310"/> 1310:     [
<a name="1311"/> 1311:      sc_lc_recv_response_tcp4,
<a name="1312"/> 1312:      sc_lc_recv_response_tcp6,
<a name="1313"/> 1313:      sc_lc_recv_response_tcpL,
<a name="1314"/> 1314: 
<a name="1315"/> 1315:      sc_lc_recvfrom_response_udp4,
<a name="1316"/> 1316:      sc_lc_recvfrom_response_udp6,
<a name="1317"/> 1317:      sc_lc_recvfrom_response_udpL,
<a name="1318"/> 1318: 
<a name="1319"/> 1319:      sc_lc_recvmsg_response_tcp4,
<a name="1320"/> 1320:      sc_lc_recvmsg_response_tcp6,
<a name="1321"/> 1321:      sc_lc_recvmsg_response_tcpL,
<a name="1322"/> 1322:      sc_lc_recvmsg_response_udp4,
<a name="1323"/> 1323:      sc_lc_recvmsg_response_udp6,
<a name="1324"/> 1324:      sc_lc_recvmsg_response_udpL,
<a name="1325"/> 1325: 
<a name="1326"/> 1326:      sc_lc_acceptor_response_tcp4,
<a name="1327"/> 1327:      sc_lc_acceptor_response_tcp6,
<a name="1328"/> 1328:      sc_lc_acceptor_response_tcpL
<a name="1329"/> 1329:     ].
<a name="1330"/> 1330: 
<a name="1331"/> 1331: <i>%% These cases tests what happens when the socket is closed remotely.</i>
<a name="sc_rc_cases-0"/><a name="1332"/> 1332: <b>sc_rc_cases</b>() -&gt;
<a name="sc_rc_cases-last_expr"/><a name="1333"/> 1333:     [
<a name="1334"/> 1334:      sc_rc_recv_response_tcp4,
<a name="1335"/> 1335:      sc_rc_recv_response_tcp6,
<a name="1336"/> 1336:      sc_rc_recv_response_tcpL,
<a name="1337"/> 1337: 
<a name="1338"/> 1338:      sc_rc_recvmsg_response_tcp4,
<a name="1339"/> 1339:      sc_rc_recvmsg_response_tcp6,
<a name="1340"/> 1340:      sc_rc_recvmsg_response_tcpL
<a name="1341"/> 1341:     ].
<a name="1342"/> 1342: 
<a name="1343"/> 1343: <i>%% These cases tests what happens when the socket is shutdown/closed remotely</i>
<a name="1344"/> 1344: <i>%% after writing and reading is ongoing.</i>
<a name="sc_rs_cases-0"/><a name="1345"/> 1345: <b>sc_rs_cases</b>() -&gt;
<a name="sc_rs_cases-last_expr"/><a name="1346"/> 1346:     [
<a name="1347"/> 1347:      sc_rs_recv_send_shutdown_receive_tcp4,
<a name="1348"/> 1348:      sc_rs_recv_send_shutdown_receive_tcp6,
<a name="1349"/> 1349:      sc_rs_recv_send_shutdown_receive_tcpL,
<a name="1350"/> 1350: 
<a name="1351"/> 1351:      sc_rs_recvmsg_send_shutdown_receive_tcp4,
<a name="1352"/> 1352:      sc_rs_recvmsg_send_shutdown_receive_tcp6,
<a name="1353"/> 1353:      sc_rs_recvmsg_send_shutdown_receive_tcpL
<a name="1354"/> 1354:     ].
<a name="1355"/> 1355: 
<a name="1356"/> 1356: 
<a name="ioctl_cases-0"/><a name="1357"/> 1357: <b>ioctl_cases</b>() -&gt;
<a name="ioctl_cases-last_expr"/><a name="1358"/> 1358:     [
<a name="1359"/> 1359:      {group, ioctl_simple},
<a name="1360"/> 1360:      {group, ioctl_get},
<a name="1361"/> 1361:      {group, ioctl_set}
<a name="1362"/> 1362:     ].
<a name="1363"/> 1363: 
<a name="1364"/> 1364: 
<a name="ioctl_simple_cases-0"/><a name="1365"/> 1365: <b>ioctl_simple_cases</b>() -&gt;
<a name="ioctl_simple_cases-last_expr"/><a name="1366"/> 1366:     [
<a name="1367"/> 1367:      ioctl_simple1,
<a name="1368"/> 1368:      ioctl_simple2,
<a name="1369"/> 1369:      ioctl_nread
<a name="1370"/> 1370:     ].
<a name="1371"/> 1371: 
<a name="1372"/> 1372: 
<a name="ioctl_get_cases-0"/><a name="1373"/> 1373: <b>ioctl_get_cases</b>() -&gt;
<a name="ioctl_get_cases-last_expr"/><a name="1374"/> 1374:     [
<a name="1375"/> 1375:      ioctl_get_gifname,
<a name="1376"/> 1376:      ioctl_get_gifindex,
<a name="1377"/> 1377:      ioctl_get_gifaddr,
<a name="1378"/> 1378:      ioctl_get_gifdstaddr,
<a name="1379"/> 1379:      ioctl_get_gifbrdaddr,
<a name="1380"/> 1380:      ioctl_get_gifnetmask,
<a name="1381"/> 1381:      ioctl_get_gifmtu,
<a name="1382"/> 1382:      ioctl_get_gifhwaddr,
<a name="1383"/> 1383:      ioctl_get_giftxqlen,
<a name="1384"/> 1384:      ioctl_get_gifflags,
<a name="1385"/> 1385:      ioctl_get_gifmap,
<a name="1386"/> 1386:      ioctl_tcp_info
<a name="1387"/> 1387:     ].
<a name="1388"/> 1388: 
<a name="1389"/> 1389: 
<a name="ioctl_set_cases-0"/><a name="1390"/> 1390: <b>ioctl_set_cases</b>() -&gt;
<a name="ioctl_set_cases-last_expr"/><a name="1391"/> 1391:     [
<a name="1392"/> 1392:     ].
<a name="1393"/> 1393: 
<a name="1394"/> 1394: 
<a name="traffic_cases-0"/><a name="1395"/> 1395: <b>traffic_cases</b>() -&gt;
<a name="traffic_cases-last_expr"/><a name="1396"/> 1396:     [
<a name="1397"/> 1397:      {group, traffic_counters},
<a name="1398"/> 1398:      {group, traffic_chunks},
<a name="1399"/> 1399:      {group, traffic_ping_pong}
<a name="1400"/> 1400:     ].
<a name="1401"/> 1401: 
<a name="traffic_counters_cases-0"/><a name="1402"/> 1402: <b>traffic_counters_cases</b>() -&gt;
<a name="traffic_counters_cases-last_expr"/><a name="1403"/> 1403:     [
<a name="1404"/> 1404:      traffic_send_and_recv_counters_tcp4,
<a name="1405"/> 1405:      traffic_send_and_recv_counters_tcp6,
<a name="1406"/> 1406:      traffic_send_and_recv_counters_tcpL,
<a name="1407"/> 1407:      traffic_sendmsg_and_recvmsg_counters_tcp4,
<a name="1408"/> 1408:      traffic_sendmsg_and_recvmsg_counters_tcp6,
<a name="1409"/> 1409:      traffic_sendmsg_and_recvmsg_counters_tcpL,
<a name="1410"/> 1410:      traffic_sendto_and_recvfrom_counters_udp4,
<a name="1411"/> 1411:      traffic_sendto_and_recvfrom_counters_udp6,
<a name="1412"/> 1412:      traffic_sendto_and_recvfrom_counters_udpL,
<a name="1413"/> 1413:      traffic_sendmsg_and_recvmsg_counters_udp4,
<a name="1414"/> 1414:      traffic_sendmsg_and_recvmsg_counters_udp6,
<a name="1415"/> 1415:      traffic_sendmsg_and_recvmsg_counters_udpL
<a name="1416"/> 1416:     ].
<a name="1417"/> 1417: 
<a name="traffic_chunks_cases-0"/><a name="1418"/> 1418: <b>traffic_chunks_cases</b>() -&gt;
<a name="traffic_chunks_cases-last_expr"/><a name="1419"/> 1419:     [
<a name="1420"/> 1420:      traffic_send_and_recv_chunks_tcp4,
<a name="1421"/> 1421:      traffic_send_and_recv_chunks_tcp6,
<a name="1422"/> 1422:      traffic_send_and_recv_chunks_tcpL
<a name="1423"/> 1423:     ].
<a name="1424"/> 1424: 
<a name="traffic_ping_pong_cases-0"/><a name="1425"/> 1425: <b>traffic_ping_pong_cases</b>() -&gt;
<a name="traffic_ping_pong_cases-last_expr"/><a name="1426"/> 1426:     [
<a name="1427"/> 1427:      {group, traffic_pp_send_recv},
<a name="1428"/> 1428:      {group, traffic_pp_sendto_recvfrom},
<a name="1429"/> 1429:      {group, traffic_pp_sendmsg_recvmsg}
<a name="1430"/> 1430:     ].
<a name="1431"/> 1431: 
<a name="traffic_pp_send_recv_cases-0"/><a name="1432"/> 1432: <b>traffic_pp_send_recv_cases</b>() -&gt;
<a name="traffic_pp_send_recv_cases-last_expr"/><a name="1433"/> 1433:     [
<a name="1434"/> 1434:      traffic_ping_pong_small_send_and_recv_tcp4,
<a name="1435"/> 1435:      traffic_ping_pong_small_send_and_recv_tcp6,
<a name="1436"/> 1436:      traffic_ping_pong_small_send_and_recv_tcpL,
<a name="1437"/> 1437:      traffic_ping_pong_medium_send_and_recv_tcp4,
<a name="1438"/> 1438:      traffic_ping_pong_medium_send_and_recv_tcp6,
<a name="1439"/> 1439:      traffic_ping_pong_medium_send_and_recv_tcpL,
<a name="1440"/> 1440:      traffic_ping_pong_large_send_and_recv_tcp4,
<a name="1441"/> 1441:      traffic_ping_pong_large_send_and_recv_tcp6,
<a name="1442"/> 1442:      traffic_ping_pong_large_send_and_recv_tcpL
<a name="1443"/> 1443:     ].    
<a name="1444"/> 1444: 
<a name="traffic_pp_sendto_recvfrom_cases-0"/><a name="1445"/> 1445: <b>traffic_pp_sendto_recvfrom_cases</b>() -&gt;
<a name="traffic_pp_sendto_recvfrom_cases-last_expr"/><a name="1446"/> 1446:     [
<a name="1447"/> 1447:      traffic_ping_pong_small_sendto_and_recvfrom_udp4,
<a name="1448"/> 1448:      traffic_ping_pong_small_sendto_and_recvfrom_udp6,
<a name="1449"/> 1449:      traffic_ping_pong_small_sendto_and_recvfrom_udpL,
<a name="1450"/> 1450:      traffic_ping_pong_medium_sendto_and_recvfrom_udp4,
<a name="1451"/> 1451:      traffic_ping_pong_medium_sendto_and_recvfrom_udp6,
<a name="1452"/> 1452:      traffic_ping_pong_medium_sendto_and_recvfrom_udpL
<a name="1453"/> 1453:     ].
<a name="1454"/> 1454: 
<a name="traffic_pp_sendmsg_recvmsg_cases-0"/><a name="1455"/> 1455: <b>traffic_pp_sendmsg_recvmsg_cases</b>() -&gt;
<a name="traffic_pp_sendmsg_recvmsg_cases-last_expr"/><a name="1456"/> 1456:     [    
<a name="1457"/> 1457:      traffic_ping_pong_small_sendmsg_and_recvmsg_tcp4,
<a name="1458"/> 1458:      traffic_ping_pong_small_sendmsg_and_recvmsg_tcp6,
<a name="1459"/> 1459:      traffic_ping_pong_small_sendmsg_and_recvmsg_tcpL,
<a name="1460"/> 1460:      traffic_ping_pong_medium_sendmsg_and_recvmsg_tcp4,
<a name="1461"/> 1461:      traffic_ping_pong_medium_sendmsg_and_recvmsg_tcp6,
<a name="1462"/> 1462:      traffic_ping_pong_medium_sendmsg_and_recvmsg_tcpL,
<a name="1463"/> 1463:      traffic_ping_pong_large_sendmsg_and_recvmsg_tcp4,
<a name="1464"/> 1464:      traffic_ping_pong_large_sendmsg_and_recvmsg_tcp6,
<a name="1465"/> 1465:      traffic_ping_pong_large_sendmsg_and_recvmsg_tcpL,
<a name="1466"/> 1466: 
<a name="1467"/> 1467:      traffic_ping_pong_small_sendmsg_and_recvmsg_udp4,
<a name="1468"/> 1468:      traffic_ping_pong_small_sendmsg_and_recvmsg_udp6,
<a name="1469"/> 1469:      traffic_ping_pong_small_sendmsg_and_recvmsg_udpL,
<a name="1470"/> 1470:      traffic_ping_pong_medium_sendmsg_and_recvmsg_udp4,
<a name="1471"/> 1471:      traffic_ping_pong_medium_sendmsg_and_recvmsg_udp6,
<a name="1472"/> 1472:      traffic_ping_pong_medium_sendmsg_and_recvmsg_udpL
<a name="1473"/> 1473:     ].
<a name="1474"/> 1474: 
<a name="1475"/> 1475: <i>%% Condition for running the ttest cases.</i>
<a name="1476"/> 1476: <i>%% No point in running these cases unless the machine is</i>
<a name="1477"/> 1477: <i>%% reasonably fast.</i>
<a name="ttest_condition-1"/><a name="1478"/> 1478: <b>ttest_condition</b>(Config) -&gt;
<a name="1479"/> 1479:     OsType = os:type(),
<a name="ttest_condition-last_expr"/><a name="1480"/> 1480: <b>    case ?config</b>(kernel_factor, Config) of
<a name="1481"/> 1481:         Factor when (OsType =:= ?WINDOWS) andalso
<a name="1482"/> 1482:                     is_integer(Factor) andalso
<a name="1483"/> 1483:                     (Factor =&lt; ?TTEST_MIN_FACTOR_WIN) -&gt;
<a name="1484"/> 1484:             ok;
<a name="1485"/> 1485:         Factor when is_integer(Factor) andalso (Factor =&lt; ?TTEST_MIN_FACTOR) -&gt;
<a name="1486"/> 1486:             ok;
<a name="1487"/> 1487:         Factor when is_integer(Factor) -&gt;
<a name="1488"/> 1488:             {skip, ?F(&quot;Too slow for TTest (~w)&quot;, [Factor])};
<a name="1489"/> 1489:         _ -&gt;
<a name="1490"/> 1490:             {skip, &quot;Too slow for TTest (undef)&quot;}
<a name="1491"/> 1491:     end.
<a name="1492"/> 1492: 
<a name="ttest_small_max_outstanding-1"/><a name="1493"/> 1493: <b>ttest_small_max_outstanding</b>(Config) -&gt;
<a name="1494"/> 1494:     EnvKey                = &quot;ESOCK_TEST_TTEST_SMALL_MAX_OUTSTANDING&quot;,
<a name="1495"/> 1495:     Default               = ?TTEST_DEFAULT_SMALL_MAX_OUTSTANDING,
<a name="1496"/> 1496:     DefaultMaxOutstanding = ttest_max_outstanding(Config, EnvKey, Default),
<a name="ttest_small_max_outstanding-last_expr"/><a name="1497"/> 1497: <b>    ttest_max_outstanding</b>(Config, DefaultMaxOutstanding).
<a name="1498"/> 1498: 
<a name="ttest_medium_max_outstanding-1"/><a name="1499"/> 1499: <b>ttest_medium_max_outstanding</b>(Config) -&gt;
<a name="1500"/> 1500:     SmallMaxOutstanding   = ttest_small_max_outstanding(Config),
<a name="1501"/> 1501:     EnvKey                = &quot;ESOCK_TEST_TTEST_MEDIUM_MAX_OUTSTANDING&quot;,
<a name="1502"/> 1502:     Default               = ?TTEST_MK_DEFAULT_MAX_OUTSTANDING(
<a name="1503"/> 1503:                                SmallMaxOutstanding),
<a name="1504"/> 1504:     DefaultMaxOutstanding = ttest_max_outstanding(Config, EnvKey, Default),
<a name="ttest_medium_max_outstanding-last_expr"/><a name="1505"/> 1505: <b>    ttest_max_outstanding</b>(Config, DefaultMaxOutstanding).
<a name="1506"/> 1506: 
<a name="ttest_large_max_outstanding-1"/><a name="1507"/> 1507: <b>ttest_large_max_outstanding</b>(Config) -&gt;
<a name="1508"/> 1508:     MediumMaxOutstanding  = ttest_medium_max_outstanding(Config),
<a name="1509"/> 1509:     EnvKey                = &quot;ESOCK_TEST_TTEST_LARGE_MAX_OUTSTANDING&quot;,
<a name="1510"/> 1510:     Default               = ?TTEST_MK_DEFAULT_MAX_OUTSTANDING(
<a name="1511"/> 1511:                                MediumMaxOutstanding),
<a name="1512"/> 1512:     DefaultMaxOutstanding = ttest_max_outstanding(Config, EnvKey, Default),
<a name="ttest_large_max_outstanding-last_expr"/><a name="1513"/> 1513: <b>    ttest_max_outstanding</b>(Config, DefaultMaxOutstanding).
<a name="1514"/> 1514: 
<a name="ttest_max_outstanding-2"/><a name="1515"/> 1515: <b>ttest_max_outstanding</b>(Config, Default)
<a name="1516"/> 1516:   when is_integer(Default) andalso (Default &gt; 1) -&gt;
<a name="1517"/> 1517:     %% Note that we should not even get here if factor &gt; 4
<a name="1518"/> 1518:     case ?config(kernel_factor, Config) of
<a name="1519"/> 1519:         1                     -&gt; Default;
<a name="1520"/> 1520:         2 when (Default &gt;= 2) -&gt; Default div 2;
<a name="1521"/> 1521:         3 when (Default &gt;= 4) -&gt; Default div 4;
<a name="1522"/> 1522:         _ when (Default &gt;= 8) -&gt; Default div 8;
<a name="1523"/> 1523:         _                     -&gt; 1
<a name="1524"/> 1524:     end;
<a name="1525"/> 1525: <b>ttest_max_outstanding</b>(_, _) -&gt;
<a name="ttest_max_outstanding-last_expr"/><a name="1526"/> 1526:     1.
<a name="1527"/> 1527: 
<a name="ttest_max_outstanding-3"/><a name="1528"/> 1528: <b>ttest_max_outstanding</b>(Config, EnvKey, Default) -&gt;
<a name="1529"/> 1529:     Key = list_to_atom(string:to_lower(EnvKey)),
<a name="ttest_max_outstanding-last_expr"/><a name="1530"/> 1530: <b>    case lists:keysearch</b>(Key, 1, Config) of
<a name="1531"/> 1531:         {value, {Key, MO}} when is_integer(MO) andalso (MO &gt; 0) -&gt;
<a name="1532"/> 1532:             MO;
<a name="1533"/> 1533:         _ -&gt;
<a name="1534"/> 1534:             case os:getenv(EnvKey) of
<a name="1535"/> 1535:                 false -&gt;
<a name="1536"/> 1536:                     Default;
<a name="1537"/> 1537:                 Val -&gt;
<a name="1538"/> 1538:                     try list_to_integer(Val) of
<a name="1539"/> 1539:                         MO when (MO &gt; 0) -&gt;
<a name="1540"/> 1540:                             MO;
<a name="1541"/> 1541:                         _ -&gt;
<a name="1542"/> 1542:                             1
<a name="1543"/> 1543:                     catch
<a name="1544"/> 1544:                         _:_:_ -&gt;
<a name="1545"/> 1545:                             Default
<a name="1546"/> 1546:                     end
<a name="1547"/> 1547:             end
<a name="1548"/> 1548:     end.
<a name="1549"/> 1549: 
<a name="ttest_cases-0"/><a name="1550"/> 1550: <b>ttest_cases</b>() -&gt;
<a name="ttest_cases-last_expr"/><a name="1551"/> 1551:     [
<a name="1552"/> 1552:      %% Server: transport = gen_tcp, active = false
<a name="1553"/> 1553:      {group, ttest_sgenf},
<a name="1554"/> 1554: 
<a name="1555"/> 1555:      %% Server: transport = gen_tcp, active = once
<a name="1556"/> 1556:      {group, ttest_sgeno},
<a name="1557"/> 1557: 
<a name="1558"/> 1558:      %% Server: transport = gen_tcp, active = true
<a name="1559"/> 1559:      {group, ttest_sgent},
<a name="1560"/> 1560: 
<a name="1561"/> 1561:      %% Server: transport = gen_tcp(socket), active = false
<a name="1562"/> 1562:      {group, ttest_sgsf},
<a name="1563"/> 1563: 
<a name="1564"/> 1564:      %% Server: transport = socket(tcp), active = false
<a name="1565"/> 1565:      {group, ttest_ssockf},
<a name="1566"/> 1566: 
<a name="1567"/> 1567:      %% Server: transport = socket(tcp), active = once
<a name="1568"/> 1568:      {group, ttest_ssocko},
<a name="1569"/> 1569: 
<a name="1570"/> 1570:      %% Server: transport = socket(tcp), active = true
<a name="1571"/> 1571:      {group, ttest_ssockt},
<a name="1572"/> 1572: 
<a name="1573"/> 1573:      %% simple: Server: transport = socket(tcp), active = true
<a name="1574"/> 1574:      {group, ttest_simple_ssockt}
<a name="1575"/> 1575: 
<a name="1576"/> 1576:     ].
<a name="1577"/> 1577: 
<a name="1578"/> 1578: 
<a name="1579"/> 1579: <i>%% Server: transport = gen_tcp, active = false</i>
<a name="ttest_sgenf_cases-0"/><a name="1580"/> 1580: <b>ttest_sgenf_cases</b>() -&gt;
<a name="ttest_sgenf_cases-last_expr"/><a name="1581"/> 1581:     [
<a name="1582"/> 1582:      {group, ttest_sgenf_cgen},
<a name="1583"/> 1583:      {group, ttest_sgenf_csock}
<a name="1584"/> 1584:     ].
<a name="1585"/> 1585: 
<a name="1586"/> 1586: <i>%% Server: transport = gen_tcp, active = false</i>
<a name="1587"/> 1587: <i>%% Client: transport = gen_tcp</i>
<a name="ttest_sgenf_cgen_cases-0"/><a name="1588"/> 1588: <b>ttest_sgenf_cgen_cases</b>() -&gt;
<a name="ttest_sgenf_cgen_cases-last_expr"/><a name="1589"/> 1589:     [
<a name="1590"/> 1590:      {group, ttest_sgenf_cgenf},
<a name="1591"/> 1591:      {group, ttest_sgenf_cgeno},
<a name="1592"/> 1592:      {group, ttest_sgenf_cgent}
<a name="1593"/> 1593:     ].
<a name="1594"/> 1594: 
<a name="1595"/> 1595: <i>%% Server: transport = gen_tcp(socket), active = false</i>
<a name="ttest_sgsf_cases-0"/><a name="1596"/> 1596: <b>ttest_sgsf_cases</b>() -&gt;
<a name="ttest_sgsf_cases-last_expr"/><a name="1597"/> 1597:     [
<a name="1598"/> 1598:      %% {group, ttest_sgenf_cgen},
<a name="1599"/> 1599:      {group, ttest_sgsf_csock}
<a name="1600"/> 1600:     ].
<a name="1601"/> 1601: 
<a name="1602"/> 1602: <i>%% Server: transport = gen_tcp, active = false</i>
<a name="1603"/> 1603: <i>%% Client: transport = gen_tcp, active = false</i>
<a name="1604"/> 1604: 
<a name="ttest_conditional_cases-3"/><a name="1605"/> 1605: <b>ttest_conditional_cases</b>(Env, Default, Cases) -&gt;
<a name="ttest_conditional_cases-last_expr"/><a name="1606"/> 1606: <b>    case os:getenv</b>(Env) of
<a name="1607"/> 1607:         false -&gt;
<a name="1608"/> 1608:             Default;
<a name="1609"/> 1609:         Val -&gt;
<a name="1610"/> 1610:             case list_to_atom(string:to_lower(Val)) of
<a name="1611"/> 1611:                 Use when (Use =:= include) orelse 
<a name="1612"/> 1612:                          (Use =:= enable) orelse 
<a name="1613"/> 1613:                          (Use =:= true) -&gt;
<a name="1614"/> 1614:                     Cases;
<a name="1615"/> 1615:                 _ -&gt; % Assumed to be explicitly *disabled*
<a name="1616"/> 1616:                     []
<a name="1617"/> 1617:             end
<a name="1618"/> 1618:     end.
<a name="1619"/> 1619: 
<a name="ttest_small_conditional_cases-1"/><a name="1620"/> 1620: <b>ttest_small_conditional_cases</b>(Cases) -&gt;
<a name="ttest_small_conditional_cases-last_expr"/><a name="1621"/> 1621: <b>    ttest_conditional_cases</b>(&quot;ESOCK_TEST_TTEST_SMALL&quot;, Cases, Cases).
<a name="1622"/> 1622: 
<a name="ttest_medium_conditional_cases-1"/><a name="1623"/> 1623: <b>ttest_medium_conditional_cases</b>(Cases) -&gt;
<a name="ttest_medium_conditional_cases-last_expr"/><a name="1624"/> 1624: <b>    ttest_conditional_cases</b>(&quot;ESOCK_TEST_TTEST_MEDIUM&quot;, [], Cases).
<a name="1625"/> 1625: 
<a name="ttest_large_conditional_cases-1"/><a name="1626"/> 1626: <b>ttest_large_conditional_cases</b>(Cases) -&gt;
<a name="ttest_large_conditional_cases-last_expr"/><a name="1627"/> 1627: <b>    ttest_conditional_cases</b>(&quot;ESOCK_TEST_TTEST_LARGE&quot;, [], Cases).
<a name="1628"/> 1628: 
<a name="ttest_select_conditional_cases-3"/><a name="1629"/> 1629: <b>ttest_select_conditional_cases</b>(Small, Medium, Large) -&gt;
<a name="ttest_select_conditional_cases-last_expr"/><a name="1630"/> 1630: <b>    ttest_small_conditional_cases</b>(Small) ++
<a name="1631"/> 1631:         ttest_medium_conditional_cases(Medium) ++
<a name="1632"/> 1632:         ttest_large_conditional_cases(Large).
<a name="1633"/> 1633: 
<a name="ttest_sgenf_cgenf_cases-0"/><a name="1634"/> 1634: <b>ttest_sgenf_cgenf_cases</b>() -&gt;
<a name="ttest_sgenf_cgenf_cases-last_expr"/><a name="1635"/> 1635: <b>    ttest_select_conditional_cases</b>(
<a name="1636"/> 1636:       %% Small
<a name="1637"/> 1637:       [ttest_sgenf_cgenf_small_tcp4,
<a name="1638"/> 1638:        ttest_sgenf_cgenf_small_tcp6],
<a name="1639"/> 1639:       %% Medium
<a name="1640"/> 1640:       [ttest_sgenf_cgenf_medium_tcp4,
<a name="1641"/> 1641:        ttest_sgenf_cgenf_medium_tcp6],
<a name="1642"/> 1642:       %% Large
<a name="1643"/> 1643:       [ttest_sgenf_cgenf_large_tcp4,
<a name="1644"/> 1644:        ttest_sgenf_cgenf_large_tcp6]).
<a name="1645"/> 1645: 
<a name="1646"/> 1646: <i>%% Server: transport = gen_tcp, active = false</i>
<a name="1647"/> 1647: <i>%% Client: transport = gen_tcp, active = once</i>
<a name="ttest_sgenf_cgeno_cases-0"/><a name="1648"/> 1648: <b>ttest_sgenf_cgeno_cases</b>() -&gt;
<a name="ttest_sgenf_cgeno_cases-last_expr"/><a name="1649"/> 1649: <b>    ttest_select_conditional_cases</b>(
<a name="1650"/> 1650:       %% Small
<a name="1651"/> 1651:       [ttest_sgenf_cgeno_small_tcp4,
<a name="1652"/> 1652:        ttest_sgenf_cgeno_small_tcp6],
<a name="1653"/> 1653:       %% Medium
<a name="1654"/> 1654:       [ttest_sgenf_cgeno_medium_tcp4,
<a name="1655"/> 1655:        ttest_sgenf_cgeno_medium_tcp6],
<a name="1656"/> 1656:       %% Large
<a name="1657"/> 1657:       [ttest_sgenf_cgeno_large_tcp4,
<a name="1658"/> 1658:        ttest_sgenf_cgeno_large_tcp6]).
<a name="1659"/> 1659: 
<a name="1660"/> 1660: <i>%% Server: transport = gen_tcp, active = false</i>
<a name="1661"/> 1661: <i>%% Client: transport = gen_tcp, active = true</i>
<a name="ttest_sgenf_cgent_cases-0"/><a name="1662"/> 1662: <b>ttest_sgenf_cgent_cases</b>() -&gt;
<a name="ttest_sgenf_cgent_cases-last_expr"/><a name="1663"/> 1663: <b>    ttest_select_conditional_cases</b>(
<a name="1664"/> 1664:       %% Small
<a name="1665"/> 1665:       [ttest_sgenf_cgent_small_tcp4,
<a name="1666"/> 1666:        ttest_sgenf_cgent_small_tcp6],
<a name="1667"/> 1667:       %% Medium
<a name="1668"/> 1668:       [ttest_sgenf_cgent_medium_tcp4,
<a name="1669"/> 1669:        ttest_sgenf_cgent_medium_tcp6],
<a name="1670"/> 1670:       %% Large
<a name="1671"/> 1671:       [ttest_sgenf_cgent_large_tcp4,
<a name="1672"/> 1672:        ttest_sgenf_cgent_large_tcp6]).
<a name="1673"/> 1673: 
<a name="1674"/> 1674: <i>%% Server: transport = gen_tcp, active = false</i>
<a name="1675"/> 1675: <i>%% Client: transport = socket(tcp)</i>
<a name="ttest_sgenf_csock_cases-0"/><a name="1676"/> 1676: <b>ttest_sgenf_csock_cases</b>() -&gt;
<a name="ttest_sgenf_csock_cases-last_expr"/><a name="1677"/> 1677:     [
<a name="1678"/> 1678:      {group, ttest_sgenf_csockf},
<a name="1679"/> 1679:      {group, ttest_sgenf_csocko},
<a name="1680"/> 1680:      {group, ttest_sgenf_csockt}
<a name="1681"/> 1681:     ].
<a name="1682"/> 1682: 
<a name="ttest_sgenf_csockf_cases-0"/><a name="1683"/> 1683: <b>ttest_sgenf_csockf_cases</b>() -&gt;
<a name="ttest_sgenf_csockf_cases-last_expr"/><a name="1684"/> 1684: <b>    ttest_select_conditional_cases</b>(
<a name="1685"/> 1685:       %% Small
<a name="1686"/> 1686:       [ttest_sgenf_csockf_small_tcp4,
<a name="1687"/> 1687:        ttest_sgenf_csockf_small_tcp6],
<a name="1688"/> 1688:       %% Medium
<a name="1689"/> 1689:       [ttest_sgenf_csockf_medium_tcp4,
<a name="1690"/> 1690:        ttest_sgenf_csockf_medium_tcp6],
<a name="1691"/> 1691:       %% Large
<a name="1692"/> 1692:       [ttest_sgenf_csockf_large_tcp4,
<a name="1693"/> 1693:        ttest_sgenf_csockf_large_tcp6]).
<a name="1694"/> 1694: 
<a name="ttest_sgenf_csocko_cases-0"/><a name="1695"/> 1695: <b>ttest_sgenf_csocko_cases</b>() -&gt;
<a name="ttest_sgenf_csocko_cases-last_expr"/><a name="1696"/> 1696: <b>    ttest_select_conditional_cases</b>(
<a name="1697"/> 1697:       %% Small
<a name="1698"/> 1698:       [ttest_sgenf_csocko_small_tcp4,
<a name="1699"/> 1699:        ttest_sgenf_csocko_small_tcp6],
<a name="1700"/> 1700:       %% Medium
<a name="1701"/> 1701:       [ttest_sgenf_csocko_medium_tcp4,
<a name="1702"/> 1702:        ttest_sgenf_csocko_medium_tcp6],
<a name="1703"/> 1703:       %% Large
<a name="1704"/> 1704:       [ttest_sgenf_csocko_large_tcp4,
<a name="1705"/> 1705:        ttest_sgenf_csocko_large_tcp6]).
<a name="1706"/> 1706: 
<a name="ttest_sgenf_csockt_cases-0"/><a name="1707"/> 1707: <b>ttest_sgenf_csockt_cases</b>() -&gt;
<a name="ttest_sgenf_csockt_cases-last_expr"/><a name="1708"/> 1708: <b>    ttest_select_conditional_cases</b>(
<a name="1709"/> 1709:       %% Small
<a name="1710"/> 1710:       [ttest_sgenf_csockt_small_tcp4,
<a name="1711"/> 1711:        ttest_sgenf_csockt_small_tcp6],
<a name="1712"/> 1712:       %% Medium
<a name="1713"/> 1713:       [ttest_sgenf_csockt_medium_tcp4,
<a name="1714"/> 1714:        ttest_sgenf_csockt_medium_tcp6],
<a name="1715"/> 1715:       %% Large
<a name="1716"/> 1716:      [ttest_sgenf_csockt_large_tcp4,
<a name="1717"/> 1717:       ttest_sgenf_csockt_large_tcp6]).
<a name="1718"/> 1718: 
<a name="1719"/> 1719: <i>%% Server: transport = gen_tcp(socket), active = false</i>
<a name="1720"/> 1720: <i>%% Client: transport = socket(tcp)</i>
<a name="ttest_sgsf_csock_cases-0"/><a name="1721"/> 1721: <b>ttest_sgsf_csock_cases</b>() -&gt;
<a name="ttest_sgsf_csock_cases-last_expr"/><a name="1722"/> 1722:     [
<a name="1723"/> 1723:      {group, ttest_sgsf_csockf}%% ,
<a name="1724"/> 1724:      %% {group, ttest_sgsf_csocko},
<a name="1725"/> 1725:      %% {group, ttest_sgsf_csockt}
<a name="1726"/> 1726:     ].
<a name="1727"/> 1727: 
<a name="ttest_sgsf_csockf_cases-0"/><a name="1728"/> 1728: <b>ttest_sgsf_csockf_cases</b>() -&gt;
<a name="ttest_sgsf_csockf_cases-last_expr"/><a name="1729"/> 1729: <b>    ttest_select_conditional_cases</b>(
<a name="1730"/> 1730:       %% Small
<a name="1731"/> 1731:       [ttest_sgsf_csockf_small_tcp4,
<a name="1732"/> 1732:        ttest_sgsf_csockf_small_tcp6],
<a name="1733"/> 1733:       %% Medium
<a name="1734"/> 1734:       [ttest_sgsf_csockf_medium_tcp4,
<a name="1735"/> 1735:        ttest_sgsf_csockf_medium_tcp6],
<a name="1736"/> 1736:       %% Large
<a name="1737"/> 1737:       [ttest_sgsf_csockf_large_tcp4,
<a name="1738"/> 1738:        ttest_sgsf_csockf_large_tcp6]).
<a name="1739"/> 1739: 
<a name="1740"/> 1740: <i>%% Server: transport = gen_tcp, active = once</i>
<a name="ttest_sgeno_cases-0"/><a name="1741"/> 1741: <b>ttest_sgeno_cases</b>() -&gt;
<a name="ttest_sgeno_cases-last_expr"/><a name="1742"/> 1742:     [
<a name="1743"/> 1743:      {group, ttest_sgeno_cgen},
<a name="1744"/> 1744:      {group, ttest_sgeno_csock}
<a name="1745"/> 1745:     ].
<a name="1746"/> 1746: 
<a name="1747"/> 1747: <i>%% Server: transport = gen_tcp, active = once</i>
<a name="1748"/> 1748: <i>%% Client: transport = gen_tcp</i>
<a name="ttest_sgeno_cgen_cases-0"/><a name="1749"/> 1749: <b>ttest_sgeno_cgen_cases</b>() -&gt;
<a name="ttest_sgeno_cgen_cases-last_expr"/><a name="1750"/> 1750:     [
<a name="1751"/> 1751:      {group, ttest_sgeno_cgenf},
<a name="1752"/> 1752:      {group, ttest_sgeno_cgeno},
<a name="1753"/> 1753:      {group, ttest_sgeno_cgent}
<a name="1754"/> 1754:     ].
<a name="1755"/> 1755: 
<a name="1756"/> 1756: <i>%% Server: transport = gen_tcp, active = once</i>
<a name="1757"/> 1757: <i>%% Client: transport = gen_tcp, active = false</i>
<a name="ttest_sgeno_cgenf_cases-0"/><a name="1758"/> 1758: <b>ttest_sgeno_cgenf_cases</b>() -&gt;
<a name="ttest_sgeno_cgenf_cases-last_expr"/><a name="1759"/> 1759: <b>    ttest_select_conditional_cases</b>(
<a name="1760"/> 1760:       %% Small
<a name="1761"/> 1761:       [ttest_sgeno_cgenf_small_tcp4,
<a name="1762"/> 1762:        ttest_sgeno_cgenf_small_tcp6],
<a name="1763"/> 1763:       %% Medium
<a name="1764"/> 1764:       [ttest_sgeno_cgenf_medium_tcp4,
<a name="1765"/> 1765:        ttest_sgeno_cgenf_medium_tcp6],
<a name="1766"/> 1766:       %% Large
<a name="1767"/> 1767:       [ttest_sgeno_cgenf_large_tcp4,
<a name="1768"/> 1768:        ttest_sgeno_cgenf_large_tcp6]).
<a name="1769"/> 1769: 
<a name="1770"/> 1770: <i>%% Server: transport = gen_tcp, active = once</i>
<a name="1771"/> 1771: <i>%% Client: transport = gen_tcp, active = once</i>
<a name="ttest_sgeno_cgeno_cases-0"/><a name="1772"/> 1772: <b>ttest_sgeno_cgeno_cases</b>() -&gt;
<a name="ttest_sgeno_cgeno_cases-last_expr"/><a name="1773"/> 1773: <b>    ttest_select_conditional_cases</b>(
<a name="1774"/> 1774:       %% Small
<a name="1775"/> 1775:       [ttest_sgeno_cgeno_small_tcp4,
<a name="1776"/> 1776:        ttest_sgeno_cgeno_small_tcp6],
<a name="1777"/> 1777:       %% Medium
<a name="1778"/> 1778:       [ttest_sgeno_cgeno_medium_tcp4,
<a name="1779"/> 1779:        ttest_sgeno_cgeno_medium_tcp6],
<a name="1780"/> 1780:       %% Large
<a name="1781"/> 1781:       [ttest_sgeno_cgeno_large_tcp4,
<a name="1782"/> 1782:        ttest_sgeno_cgeno_large_tcp6]).
<a name="1783"/> 1783: 
<a name="1784"/> 1784: <i>%% Server: transport = gen_tcp, active = once</i>
<a name="1785"/> 1785: <i>%% Client: transport = gen_tcp, active = true</i>
<a name="ttest_sgeno_cgent_cases-0"/><a name="1786"/> 1786: <b>ttest_sgeno_cgent_cases</b>() -&gt;
<a name="ttest_sgeno_cgent_cases-last_expr"/><a name="1787"/> 1787: <b>    ttest_select_conditional_cases</b>(
<a name="1788"/> 1788:       %% Small
<a name="1789"/> 1789:       [ttest_sgeno_cgent_small_tcp4,
<a name="1790"/> 1790:        ttest_sgeno_cgent_small_tcp6],
<a name="1791"/> 1791:       %% Medium
<a name="1792"/> 1792:       [ttest_sgeno_cgent_medium_tcp4,
<a name="1793"/> 1793:        ttest_sgeno_cgent_medium_tcp6],
<a name="1794"/> 1794:       %% Large
<a name="1795"/> 1795:       [ttest_sgeno_cgent_large_tcp4,
<a name="1796"/> 1796:        ttest_sgeno_cgent_large_tcp6]).
<a name="1797"/> 1797: 
<a name="1798"/> 1798: <i>%% Server: transport = gen_tcp, active = once</i>
<a name="1799"/> 1799: <i>%% Client: transport = socket(tcp)</i>
<a name="ttest_sgeno_csock_cases-0"/><a name="1800"/> 1800: <b>ttest_sgeno_csock_cases</b>() -&gt;
<a name="ttest_sgeno_csock_cases-last_expr"/><a name="1801"/> 1801:     [
<a name="1802"/> 1802:      {group, ttest_sgeno_csockf},
<a name="1803"/> 1803:      {group, ttest_sgeno_csocko},
<a name="1804"/> 1804:      {group, ttest_sgeno_csockt}
<a name="1805"/> 1805:     ].
<a name="1806"/> 1806: 
<a name="ttest_sgeno_csockf_cases-0"/><a name="1807"/> 1807: <b>ttest_sgeno_csockf_cases</b>() -&gt;
<a name="ttest_sgeno_csockf_cases-last_expr"/><a name="1808"/> 1808: <b>    ttest_select_conditional_cases</b>(
<a name="1809"/> 1809:       %% Small
<a name="1810"/> 1810:       [ttest_sgeno_csockf_small_tcp4,
<a name="1811"/> 1811:        ttest_sgeno_csockf_small_tcp6],
<a name="1812"/> 1812:       %% Medium
<a name="1813"/> 1813:       [ttest_sgeno_csockf_medium_tcp4,
<a name="1814"/> 1814:        ttest_sgeno_csockf_medium_tcp6],
<a name="1815"/> 1815:       %% Large
<a name="1816"/> 1816:       [ttest_sgeno_csockf_large_tcp4,
<a name="1817"/> 1817:        ttest_sgeno_csockf_large_tcp6]).
<a name="1818"/> 1818: 
<a name="ttest_sgeno_csocko_cases-0"/><a name="1819"/> 1819: <b>ttest_sgeno_csocko_cases</b>() -&gt;
<a name="ttest_sgeno_csocko_cases-last_expr"/><a name="1820"/> 1820: <b>    ttest_select_conditional_cases</b>(
<a name="1821"/> 1821:       %% Small
<a name="1822"/> 1822:       [ttest_sgeno_csocko_small_tcp4,
<a name="1823"/> 1823:        ttest_sgeno_csocko_small_tcp6],
<a name="1824"/> 1824:       %% Medium
<a name="1825"/> 1825:       [ttest_sgeno_csocko_medium_tcp4,
<a name="1826"/> 1826:        ttest_sgeno_csocko_medium_tcp6],
<a name="1827"/> 1827:       %% Large
<a name="1828"/> 1828:       [ttest_sgeno_csocko_large_tcp4,
<a name="1829"/> 1829:        ttest_sgeno_csocko_large_tcp6]).
<a name="1830"/> 1830: 
<a name="ttest_sgeno_csockt_cases-0"/><a name="1831"/> 1831: <b>ttest_sgeno_csockt_cases</b>() -&gt;
<a name="ttest_sgeno_csockt_cases-last_expr"/><a name="1832"/> 1832: <b>    ttest_select_conditional_cases</b>(
<a name="1833"/> 1833:       %% Small
<a name="1834"/> 1834:       [ttest_sgeno_csockt_small_tcp4,
<a name="1835"/> 1835:        ttest_sgeno_csockt_small_tcp6],
<a name="1836"/> 1836:       %% Medium
<a name="1837"/> 1837:       [ttest_sgeno_csockt_medium_tcp4,
<a name="1838"/> 1838:        ttest_sgeno_csockt_medium_tcp6],
<a name="1839"/> 1839:       %% Large
<a name="1840"/> 1840:       [ttest_sgeno_csockt_large_tcp4,
<a name="1841"/> 1841:        ttest_sgeno_csockt_large_tcp6]).
<a name="1842"/> 1842: 
<a name="1843"/> 1843: <i>%% Server: transport = gen_tcp, active = true</i>
<a name="ttest_sgent_cases-0"/><a name="1844"/> 1844: <b>ttest_sgent_cases</b>() -&gt;
<a name="ttest_sgent_cases-last_expr"/><a name="1845"/> 1845:     [
<a name="1846"/> 1846:      {group, ttest_sgent_cgen},
<a name="1847"/> 1847:      {group, ttest_sgent_csock}
<a name="1848"/> 1848:     ].
<a name="1849"/> 1849: 
<a name="1850"/> 1850: <i>%% Server: transport = gen_tcp, active = true</i>
<a name="1851"/> 1851: <i>%% Client: transport = gen_tcp</i>
<a name="ttest_sgent_cgen_cases-0"/><a name="1852"/> 1852: <b>ttest_sgent_cgen_cases</b>() -&gt;
<a name="ttest_sgent_cgen_cases-last_expr"/><a name="1853"/> 1853:     [
<a name="1854"/> 1854:      {group, ttest_sgent_cgenf},
<a name="1855"/> 1855:      {group, ttest_sgent_cgeno},
<a name="1856"/> 1856:      {group, ttest_sgent_cgent}
<a name="1857"/> 1857:     ].
<a name="1858"/> 1858: 
<a name="1859"/> 1859: <i>%% Server: transport = gen_tcp, active = true</i>
<a name="1860"/> 1860: <i>%% Client: transport = gen_tcp, active = false</i>
<a name="ttest_sgent_cgenf_cases-0"/><a name="1861"/> 1861: <b>ttest_sgent_cgenf_cases</b>() -&gt;
<a name="ttest_sgent_cgenf_cases-last_expr"/><a name="1862"/> 1862: <b>    ttest_select_conditional_cases</b>(
<a name="1863"/> 1863:       %% Small
<a name="1864"/> 1864:       [ttest_sgent_cgenf_small_tcp4,
<a name="1865"/> 1865:        ttest_sgent_cgenf_small_tcp6],
<a name="1866"/> 1866:       %% Medium
<a name="1867"/> 1867:       [ttest_sgent_cgenf_medium_tcp4,
<a name="1868"/> 1868:        ttest_sgent_cgenf_medium_tcp6],
<a name="1869"/> 1869:       %% Large
<a name="1870"/> 1870:       [ttest_sgent_cgenf_large_tcp4,
<a name="1871"/> 1871:        ttest_sgent_cgenf_large_tcp6]).
<a name="1872"/> 1872: 
<a name="1873"/> 1873: <i>%% Server: transport = gen_tcp, active = true</i>
<a name="1874"/> 1874: <i>%% Client: transport = gen_tcp, active = once</i>
<a name="ttest_sgent_cgeno_cases-0"/><a name="1875"/> 1875: <b>ttest_sgent_cgeno_cases</b>() -&gt;
<a name="ttest_sgent_cgeno_cases-last_expr"/><a name="1876"/> 1876: <b>    ttest_select_conditional_cases</b>(
<a name="1877"/> 1877:       %% Small
<a name="1878"/> 1878:       [ttest_sgent_cgeno_small_tcp4,
<a name="1879"/> 1879:        ttest_sgent_cgeno_small_tcp6],
<a name="1880"/> 1880:       %% Medium
<a name="1881"/> 1881:       [ttest_sgent_cgeno_medium_tcp4,
<a name="1882"/> 1882:        ttest_sgent_cgeno_medium_tcp6],
<a name="1883"/> 1883:       %% Large
<a name="1884"/> 1884:       [ttest_sgent_cgeno_large_tcp4,
<a name="1885"/> 1885:        ttest_sgent_cgeno_large_tcp6]).
<a name="1886"/> 1886: 
<a name="1887"/> 1887: <i>%% Server: transport = gen_tcp, active = true</i>
<a name="1888"/> 1888: <i>%% Client: transport = gen_tcp, active = true</i>
<a name="ttest_sgent_cgent_cases-0"/><a name="1889"/> 1889: <b>ttest_sgent_cgent_cases</b>() -&gt;
<a name="ttest_sgent_cgent_cases-last_expr"/><a name="1890"/> 1890: <b>    ttest_select_conditional_cases</b>(
<a name="1891"/> 1891:       %% Small
<a name="1892"/> 1892:       [ttest_sgent_cgent_small_tcp4,
<a name="1893"/> 1893:        ttest_sgent_cgent_small_tcp6],
<a name="1894"/> 1894:       %% Medium
<a name="1895"/> 1895:       [ttest_sgent_cgent_medium_tcp4,
<a name="1896"/> 1896:        ttest_sgent_cgent_medium_tcp6],
<a name="1897"/> 1897:       %% Large
<a name="1898"/> 1898:       [ttest_sgent_cgent_large_tcp4,
<a name="1899"/> 1899:        ttest_sgent_cgent_large_tcp6]).
<a name="1900"/> 1900: 
<a name="1901"/> 1901: <i>%% Server: transport = gen_tcp, active = true</i>
<a name="1902"/> 1902: <i>%% Client: transport = socket(tcp)</i>
<a name="ttest_sgent_csock_cases-0"/><a name="1903"/> 1903: <b>ttest_sgent_csock_cases</b>() -&gt;
<a name="ttest_sgent_csock_cases-last_expr"/><a name="1904"/> 1904:     [
<a name="1905"/> 1905:      {group, ttest_sgent_csockf},
<a name="1906"/> 1906:      {group, ttest_sgent_csocko},
<a name="1907"/> 1907:      {group, ttest_sgent_csockt}
<a name="1908"/> 1908:     ].
<a name="1909"/> 1909: 
<a name="ttest_sgent_csockf_cases-0"/><a name="1910"/> 1910: <b>ttest_sgent_csockf_cases</b>() -&gt;
<a name="ttest_sgent_csockf_cases-last_expr"/><a name="1911"/> 1911: <b>    ttest_select_conditional_cases</b>(
<a name="1912"/> 1912:       %% Small
<a name="1913"/> 1913:       [ttest_sgent_csockf_small_tcp4,
<a name="1914"/> 1914:        ttest_sgent_csockf_small_tcp6],
<a name="1915"/> 1915:       %% Medium
<a name="1916"/> 1916:       [ttest_sgent_csockf_medium_tcp4,
<a name="1917"/> 1917:        ttest_sgent_csockf_medium_tcp6],
<a name="1918"/> 1918:       %% Large
<a name="1919"/> 1919:       [ttest_sgent_csockf_large_tcp4,
<a name="1920"/> 1920:        ttest_sgent_csockf_large_tcp6]).
<a name="1921"/> 1921: 
<a name="ttest_sgent_csocko_cases-0"/><a name="1922"/> 1922: <b>ttest_sgent_csocko_cases</b>() -&gt;
<a name="ttest_sgent_csocko_cases-last_expr"/><a name="1923"/> 1923: <b>    ttest_select_conditional_cases</b>(
<a name="1924"/> 1924:       %% Small
<a name="1925"/> 1925:       [ttest_sgent_csocko_small_tcp4,
<a name="1926"/> 1926:        ttest_sgent_csocko_small_tcp6],
<a name="1927"/> 1927:       %% Medium
<a name="1928"/> 1928:       [ttest_sgent_csocko_medium_tcp4,
<a name="1929"/> 1929:        ttest_sgent_csocko_medium_tcp6],
<a name="1930"/> 1930:       %% Large
<a name="1931"/> 1931:       [ttest_sgent_csocko_large_tcp4,
<a name="1932"/> 1932:        ttest_sgent_csocko_large_tcp6]).
<a name="1933"/> 1933: 
<a name="ttest_sgent_csockt_cases-0"/><a name="1934"/> 1934: <b>ttest_sgent_csockt_cases</b>() -&gt;
<a name="ttest_sgent_csockt_cases-last_expr"/><a name="1935"/> 1935: <b>    ttest_select_conditional_cases</b>(
<a name="1936"/> 1936:       %% Small
<a name="1937"/> 1937:       [ttest_sgent_csockt_small_tcp4,
<a name="1938"/> 1938:        ttest_sgent_csockt_small_tcp6],
<a name="1939"/> 1939:       %% Medium
<a name="1940"/> 1940:       [ttest_sgent_csockt_medium_tcp4,
<a name="1941"/> 1941:        ttest_sgent_csockt_medium_tcp6],
<a name="1942"/> 1942:       %% Large
<a name="1943"/> 1943:       [ttest_sgent_csockt_large_tcp4,
<a name="1944"/> 1944:        ttest_sgent_csockt_large_tcp6]).
<a name="1945"/> 1945: 
<a name="1946"/> 1946: <i>%% Server: transport = socket(tcp), active = false</i>
<a name="ttest_ssockf_cases-0"/><a name="1947"/> 1947: <b>ttest_ssockf_cases</b>() -&gt;
<a name="ttest_ssockf_cases-last_expr"/><a name="1948"/> 1948:     [
<a name="1949"/> 1949:      {group, ttest_ssockf_cgen},
<a name="1950"/> 1950:      {group, ttest_ssockf_csock},
<a name="1951"/> 1951:      {group, ttest_ssockf_cgsf}
<a name="1952"/> 1952:     ].
<a name="1953"/> 1953: 
<a name="1954"/> 1954: <i>%% Server: transport = socket(tcp), active = false</i>
<a name="1955"/> 1955: <i>%% Client: transport = gen_tcp</i>
<a name="ttest_ssockf_cgen_cases-0"/><a name="1956"/> 1956: <b>ttest_ssockf_cgen_cases</b>() -&gt;
<a name="ttest_ssockf_cgen_cases-last_expr"/><a name="1957"/> 1957:     [
<a name="1958"/> 1958:      {group, ttest_ssockf_cgenf},
<a name="1959"/> 1959:      {group, ttest_ssockf_cgeno},
<a name="1960"/> 1960:      {group, ttest_ssockf_cgent}
<a name="1961"/> 1961:     ].
<a name="1962"/> 1962: 
<a name="1963"/> 1963: <i>%% Server: transport = socket(tcp), active = false</i>
<a name="1964"/> 1964: <i>%% Client: transport = gen_tcp, active = false</i>
<a name="ttest_ssockf_cgenf_cases-0"/><a name="1965"/> 1965: <b>ttest_ssockf_cgenf_cases</b>() -&gt;
<a name="ttest_ssockf_cgenf_cases-last_expr"/><a name="1966"/> 1966: <b>    ttest_select_conditional_cases</b>(
<a name="1967"/> 1967:       %% Small
<a name="1968"/> 1968:       [ttest_ssockf_cgenf_small_tcp4,
<a name="1969"/> 1969:        ttest_ssockf_cgenf_small_tcp6],
<a name="1970"/> 1970:       %% Medium
<a name="1971"/> 1971:       [ttest_ssockf_cgenf_medium_tcp4,
<a name="1972"/> 1972:        ttest_ssockf_cgenf_medium_tcp6],
<a name="1973"/> 1973:       %% Large
<a name="1974"/> 1974:       [ttest_ssockf_cgenf_large_tcp4,
<a name="1975"/> 1975:        ttest_ssockf_cgenf_large_tcp6]).
<a name="1976"/> 1976: 
<a name="1977"/> 1977: <i>%% Server: transport = socket(tcp), active = false</i>
<a name="1978"/> 1978: <i>%% Client: transport = gen_tcp, active = once</i>
<a name="ttest_ssockf_cgeno_cases-0"/><a name="1979"/> 1979: <b>ttest_ssockf_cgeno_cases</b>() -&gt;
<a name="ttest_ssockf_cgeno_cases-last_expr"/><a name="1980"/> 1980: <b>    ttest_select_conditional_cases</b>(
<a name="1981"/> 1981:       %% Small
<a name="1982"/> 1982:       [ttest_ssockf_cgeno_small_tcp4,
<a name="1983"/> 1983:        ttest_ssockf_cgeno_small_tcp6],
<a name="1984"/> 1984:       %% Medium
<a name="1985"/> 1985:       [ttest_ssockf_cgeno_medium_tcp4,
<a name="1986"/> 1986:        ttest_ssockf_cgeno_medium_tcp6],
<a name="1987"/> 1987:       %% Large
<a name="1988"/> 1988:       [ttest_ssockf_cgeno_large_tcp4,
<a name="1989"/> 1989:        ttest_ssockf_cgeno_large_tcp6]).
<a name="1990"/> 1990: 
<a name="1991"/> 1991: <i>%% Server: transport = socket(tcp), active = false</i>
<a name="1992"/> 1992: <i>%% Client: transport = gen_tcp, active = true</i>
<a name="ttest_ssockf_cgent_cases-0"/><a name="1993"/> 1993: <b>ttest_ssockf_cgent_cases</b>() -&gt;
<a name="ttest_ssockf_cgent_cases-last_expr"/><a name="1994"/> 1994: <b>    ttest_select_conditional_cases</b>(
<a name="1995"/> 1995:       %% Small
<a name="1996"/> 1996:       [ttest_ssockf_cgent_small_tcp4,
<a name="1997"/> 1997:        ttest_ssockf_cgent_small_tcp6],
<a name="1998"/> 1998:       %% Medium
<a name="1999"/> 1999:       [ttest_ssockf_cgent_medium_tcp4,
<a name="2000"/> 2000:        ttest_ssockf_cgent_medium_tcp6],
<a name="2001"/> 2001:       %% Large
<a name="2002"/> 2002:       [ttest_ssockf_cgent_large_tcp4,
<a name="2003"/> 2003:        ttest_ssockf_cgent_large_tcp6]).
<a name="2004"/> 2004: 
<a name="2005"/> 2005: <i>%% Server: transport = socket(tcp), active = false</i>
<a name="2006"/> 2006: <i>%% Client: transport = gen_tcp(socket)</i>
<a name="ttest_ssockf_cgs_cases-0"/><a name="2007"/> 2007: <b>ttest_ssockf_cgs_cases</b>() -&gt;
<a name="ttest_ssockf_cgs_cases-last_expr"/><a name="2008"/> 2008:     [
<a name="2009"/> 2009:      {group, ttest_ssockf_cgsf}%% ,
<a name="2010"/> 2010:      %% {group, ttest_ssockf_cgeno},
<a name="2011"/> 2011:      %% {group, ttest_ssockf_cgent}
<a name="2012"/> 2012:     ].
<a name="2013"/> 2013: 
<a name="2014"/> 2014: <i>%% Server: transport = socket(tcp), active = false</i>
<a name="2015"/> 2015: <i>%% Client: transport = gen_tcp(socket), active = false</i>
<a name="ttest_ssockf_cgsf_cases-0"/><a name="2016"/> 2016: <b>ttest_ssockf_cgsf_cases</b>() -&gt;
<a name="ttest_ssockf_cgsf_cases-last_expr"/><a name="2017"/> 2017: <b>    ttest_select_conditional_cases</b>(
<a name="2018"/> 2018:       %% Small
<a name="2019"/> 2019:       [ttest_ssockf_cgsf_small_tcp4,
<a name="2020"/> 2020:        ttest_ssockf_cgsf_small_tcp6],
<a name="2021"/> 2021:       %% Medium
<a name="2022"/> 2022:       [ttest_ssockf_cgsf_medium_tcp4,
<a name="2023"/> 2023:        ttest_ssockf_cgsf_medium_tcp6],
<a name="2024"/> 2024:       %% Large
<a name="2025"/> 2025:       [ttest_ssockf_cgsf_large_tcp4,
<a name="2026"/> 2026:        ttest_ssockf_cgsf_large_tcp6]).
<a name="2027"/> 2027: 
<a name="2028"/> 2028: <i>%% Server: transport = socket(tcp), active = false</i>
<a name="2029"/> 2029: <i>%% Client: transport = socket(tcp)</i>
<a name="ttest_ssockf_csock_cases-0"/><a name="2030"/> 2030: <b>ttest_ssockf_csock_cases</b>() -&gt;
<a name="ttest_ssockf_csock_cases-last_expr"/><a name="2031"/> 2031:     [
<a name="2032"/> 2032:      {group, ttest_ssockf_csockf},
<a name="2033"/> 2033:      {group, ttest_ssockf_csocko},
<a name="2034"/> 2034:      {group, ttest_ssockf_csockt}
<a name="2035"/> 2035:     ].
<a name="2036"/> 2036: 
<a name="2037"/> 2037: <i>%% Server: transport = socket(tcp), active = false</i>
<a name="2038"/> 2038: <i>%% Client: transport = socket(tcp), active = false</i>
<a name="ttest_ssockf_csockf_cases-0"/><a name="2039"/> 2039: <b>ttest_ssockf_csockf_cases</b>() -&gt;
<a name="ttest_ssockf_csockf_cases-last_expr"/><a name="2040"/> 2040: <b>    ttest_select_conditional_cases</b>(
<a name="2041"/> 2041:       %% Small
<a name="2042"/> 2042:       [ttest_ssockf_csockf_small_tcp4,
<a name="2043"/> 2043:        ttest_ssockf_csockf_small_tcp6,
<a name="2044"/> 2044:        ttest_ssockf_csockf_small_tcpL],
<a name="2045"/> 2045:       %% Medium
<a name="2046"/> 2046:       [ttest_ssockf_csockf_medium_tcp4,
<a name="2047"/> 2047:        ttest_ssockf_csockf_medium_tcp6,
<a name="2048"/> 2048:        ttest_ssockf_csockf_medium_tcpL],
<a name="2049"/> 2049:       %% Large
<a name="2050"/> 2050:       [ttest_ssockf_csockf_large_tcp4,
<a name="2051"/> 2051:        ttest_ssockf_csockf_large_tcp6,
<a name="2052"/> 2052:        ttest_ssockf_csockf_large_tcpL]).
<a name="2053"/> 2053: 
<a name="2054"/> 2054: <i>%% Server: transport = socket(tcp), active = false</i>
<a name="2055"/> 2055: <i>%% Client: transport = socket(tcp), active = once</i>
<a name="ttest_ssockf_csocko_cases-0"/><a name="2056"/> 2056: <b>ttest_ssockf_csocko_cases</b>() -&gt;
<a name="ttest_ssockf_csocko_cases-last_expr"/><a name="2057"/> 2057: <b>    ttest_select_conditional_cases</b>(
<a name="2058"/> 2058:       %% Small
<a name="2059"/> 2059:       [ttest_ssockf_csocko_small_tcp4,
<a name="2060"/> 2060:        ttest_ssockf_csocko_small_tcp6,
<a name="2061"/> 2061:        ttest_ssockf_csocko_small_tcpL],
<a name="2062"/> 2062:       %% Medium
<a name="2063"/> 2063:       [ttest_ssockf_csocko_medium_tcp4,
<a name="2064"/> 2064:        ttest_ssockf_csocko_medium_tcp6,
<a name="2065"/> 2065:        ttest_ssockf_csocko_medium_tcpL],
<a name="2066"/> 2066:       %% Large
<a name="2067"/> 2067:       [ttest_ssockf_csocko_large_tcp4,
<a name="2068"/> 2068:        ttest_ssockf_csocko_large_tcp6,
<a name="2069"/> 2069:        ttest_ssockf_csocko_large_tcpL]).
<a name="2070"/> 2070: 
<a name="2071"/> 2071: <i>%% Server: transport = socket(tcp), active = false</i>
<a name="2072"/> 2072: <i>%% Client: transport = socket(tcp), active = true</i>
<a name="ttest_ssockf_csockt_cases-0"/><a name="2073"/> 2073: <b>ttest_ssockf_csockt_cases</b>() -&gt;
<a name="ttest_ssockf_csockt_cases-last_expr"/><a name="2074"/> 2074: <b>    ttest_select_conditional_cases</b>(
<a name="2075"/> 2075:       %% Small
<a name="2076"/> 2076:       [ttest_ssockf_csockt_small_tcp4,
<a name="2077"/> 2077:        ttest_ssockf_csockt_small_tcp6,
<a name="2078"/> 2078:        ttest_ssockf_csockt_small_tcpL],
<a name="2079"/> 2079:       %% Medium
<a name="2080"/> 2080:       [ttest_ssockf_csockt_medium_tcp4,
<a name="2081"/> 2081:        ttest_ssockf_csockt_medium_tcp6,
<a name="2082"/> 2082:        ttest_ssockf_csockt_medium_tcpL],
<a name="2083"/> 2083:       %% Large
<a name="2084"/> 2084:       [ttest_ssockf_csockt_large_tcp4,
<a name="2085"/> 2085:        ttest_ssockf_csockt_large_tcp6,
<a name="2086"/> 2086:        ttest_ssockf_csockt_large_tcpL]).
<a name="2087"/> 2087: 
<a name="2088"/> 2088: <i>%% Server: transport = socket(tcp), active = once</i>
<a name="ttest_ssocko_cases-0"/><a name="2089"/> 2089: <b>ttest_ssocko_cases</b>() -&gt;
<a name="ttest_ssocko_cases-last_expr"/><a name="2090"/> 2090:     [
<a name="2091"/> 2091:      {group, ttest_ssocko_cgen},
<a name="2092"/> 2092:      {group, ttest_ssocko_csock}
<a name="2093"/> 2093:     ].
<a name="2094"/> 2094: 
<a name="2095"/> 2095: <i>%% Server: transport = socket(tcp), active = once</i>
<a name="2096"/> 2096: <i>%% Client: transport = gen_tcp</i>
<a name="ttest_ssocko_cgen_cases-0"/><a name="2097"/> 2097: <b>ttest_ssocko_cgen_cases</b>() -&gt;
<a name="ttest_ssocko_cgen_cases-last_expr"/><a name="2098"/> 2098:     [
<a name="2099"/> 2099:      {group, ttest_ssocko_cgenf},
<a name="2100"/> 2100:      {group, ttest_ssocko_cgeno},
<a name="2101"/> 2101:      {group, ttest_ssocko_cgent}
<a name="2102"/> 2102:     ].
<a name="2103"/> 2103: 
<a name="2104"/> 2104: <i>%% Server: transport = socket(tcp), active = once</i>
<a name="2105"/> 2105: <i>%% Client: transport = gen_tcp, active = false</i>
<a name="ttest_ssocko_cgenf_cases-0"/><a name="2106"/> 2106: <b>ttest_ssocko_cgenf_cases</b>() -&gt;
<a name="ttest_ssocko_cgenf_cases-last_expr"/><a name="2107"/> 2107: <b>    ttest_select_conditional_cases</b>(
<a name="2108"/> 2108:       %% Small
<a name="2109"/> 2109:       [ttest_ssocko_cgenf_small_tcp4,
<a name="2110"/> 2110:        ttest_ssocko_cgenf_small_tcp6],
<a name="2111"/> 2111:       %% Medium
<a name="2112"/> 2112:       [ttest_ssocko_cgenf_medium_tcp4,
<a name="2113"/> 2113:        ttest_ssocko_cgenf_medium_tcp6],
<a name="2114"/> 2114:       %% Large
<a name="2115"/> 2115:       [ttest_ssocko_cgenf_large_tcp4,
<a name="2116"/> 2116:        ttest_ssocko_cgenf_large_tcp6]).
<a name="2117"/> 2117: 
<a name="2118"/> 2118: <i>%% Server: transport = socket(tcp), active = once</i>
<a name="2119"/> 2119: <i>%% Client: transport = gen_tcp, active = once</i>
<a name="ttest_ssocko_cgeno_cases-0"/><a name="2120"/> 2120: <b>ttest_ssocko_cgeno_cases</b>() -&gt;
<a name="ttest_ssocko_cgeno_cases-last_expr"/><a name="2121"/> 2121: <b>    ttest_select_conditional_cases</b>(
<a name="2122"/> 2122:       %% Small
<a name="2123"/> 2123:       [ttest_ssocko_cgeno_small_tcp4,
<a name="2124"/> 2124:        ttest_ssocko_cgeno_small_tcp6],
<a name="2125"/> 2125:       %% Medium
<a name="2126"/> 2126:       [ttest_ssocko_cgeno_medium_tcp4,
<a name="2127"/> 2127:        ttest_ssocko_cgeno_medium_tcp6],
<a name="2128"/> 2128:       %% Large
<a name="2129"/> 2129:       [ttest_ssocko_cgeno_large_tcp4,
<a name="2130"/> 2130:        ttest_ssocko_cgeno_large_tcp6]).
<a name="2131"/> 2131: 
<a name="2132"/> 2132: <i>%% Server: transport = socket(tcp), active = once</i>
<a name="2133"/> 2133: <i>%% Client: transport = gen_tcp, active = true</i>
<a name="ttest_ssocko_cgent_cases-0"/><a name="2134"/> 2134: <b>ttest_ssocko_cgent_cases</b>() -&gt;
<a name="ttest_ssocko_cgent_cases-last_expr"/><a name="2135"/> 2135: <b>    ttest_select_conditional_cases</b>(
<a name="2136"/> 2136:       %% Small
<a name="2137"/> 2137:       [ttest_ssocko_cgent_small_tcp4,
<a name="2138"/> 2138:        ttest_ssocko_cgent_small_tcp6],
<a name="2139"/> 2139:       %% Medium
<a name="2140"/> 2140:       [ttest_ssocko_cgent_medium_tcp4,
<a name="2141"/> 2141:        ttest_ssocko_cgent_medium_tcp6],
<a name="2142"/> 2142:       %% Large
<a name="2143"/> 2143:       [ttest_ssocko_cgent_large_tcp4,
<a name="2144"/> 2144:        ttest_ssocko_cgent_large_tcp6]).
<a name="2145"/> 2145: 
<a name="2146"/> 2146: <i>%% Server: transport = socket(tcp), active = once</i>
<a name="2147"/> 2147: <i>%% Client: transport = socket(tcp)</i>
<a name="ttest_ssocko_csock_cases-0"/><a name="2148"/> 2148: <b>ttest_ssocko_csock_cases</b>() -&gt;
<a name="ttest_ssocko_csock_cases-last_expr"/><a name="2149"/> 2149:     [
<a name="2150"/> 2150:      {group, ttest_ssocko_csockf},
<a name="2151"/> 2151:      {group, ttest_ssocko_csocko},
<a name="2152"/> 2152:      {group, ttest_ssocko_csockt}
<a name="2153"/> 2153:     ].
<a name="2154"/> 2154: 
<a name="2155"/> 2155: <i>%% Server: transport = socket(tcp), active = once</i>
<a name="2156"/> 2156: <i>%% Client: transport = socket(tcp), active = false</i>
<a name="ttest_ssocko_csockf_cases-0"/><a name="2157"/> 2157: <b>ttest_ssocko_csockf_cases</b>() -&gt;
<a name="ttest_ssocko_csockf_cases-last_expr"/><a name="2158"/> 2158: <b>    ttest_select_conditional_cases</b>(
<a name="2159"/> 2159:       %% Small
<a name="2160"/> 2160:       [ttest_ssocko_csockf_small_tcp4,
<a name="2161"/> 2161:        ttest_ssocko_csockf_small_tcp6,
<a name="2162"/> 2162:        ttest_ssocko_csockf_small_tcpL],
<a name="2163"/> 2163:      %% Medium
<a name="2164"/> 2164:       [ttest_ssocko_csockf_medium_tcp4,
<a name="2165"/> 2165:        ttest_ssocko_csockf_medium_tcp6,
<a name="2166"/> 2166:        ttest_ssocko_csockf_medium_tcpL],
<a name="2167"/> 2167:       %% Large
<a name="2168"/> 2168:       [ttest_ssocko_csockf_large_tcp4,
<a name="2169"/> 2169:        ttest_ssocko_csockf_large_tcp6,
<a name="2170"/> 2170:        ttest_ssocko_csockf_large_tcpL]).
<a name="2171"/> 2171: 
<a name="2172"/> 2172: <i>%% Server: transport = socket(tcp), active = once</i>
<a name="2173"/> 2173: <i>%% Client: transport = socket(tcp), active = once</i>
<a name="ttest_ssocko_csocko_cases-0"/><a name="2174"/> 2174: <b>ttest_ssocko_csocko_cases</b>() -&gt;
<a name="ttest_ssocko_csocko_cases-last_expr"/><a name="2175"/> 2175: <b>    ttest_select_conditional_cases</b>(
<a name="2176"/> 2176:       %% Small
<a name="2177"/> 2177:       [ttest_ssocko_csocko_small_tcp4,
<a name="2178"/> 2178:        ttest_ssocko_csocko_small_tcp6,
<a name="2179"/> 2179:        ttest_ssocko_csocko_small_tcpL],
<a name="2180"/> 2180:       %% Medium
<a name="2181"/> 2181:       [ttest_ssocko_csocko_medium_tcp4,
<a name="2182"/> 2182:        ttest_ssocko_csocko_medium_tcp6,
<a name="2183"/> 2183:        ttest_ssocko_csocko_medium_tcpL],
<a name="2184"/> 2184:       %% Large
<a name="2185"/> 2185:       [ttest_ssocko_csocko_large_tcp4,
<a name="2186"/> 2186:        ttest_ssocko_csocko_large_tcp6,
<a name="2187"/> 2187:        ttest_ssocko_csocko_large_tcpL]).
<a name="2188"/> 2188: 
<a name="2189"/> 2189: <i>%% Server: transport = socket(tcp), active = once</i>
<a name="2190"/> 2190: <i>%% Client: transport = socket(tcp), active = true</i>
<a name="ttest_ssocko_csockt_cases-0"/><a name="2191"/> 2191: <b>ttest_ssocko_csockt_cases</b>() -&gt;
<a name="ttest_ssocko_csockt_cases-last_expr"/><a name="2192"/> 2192: <b>    ttest_select_conditional_cases</b>(
<a name="2193"/> 2193:       %% Small
<a name="2194"/> 2194:       [ttest_ssocko_csockt_small_tcp4,
<a name="2195"/> 2195:        ttest_ssocko_csockt_small_tcp6,
<a name="2196"/> 2196:        ttest_ssocko_csockt_small_tcpL],
<a name="2197"/> 2197:       %% Medium
<a name="2198"/> 2198:       [ttest_ssocko_csockt_medium_tcp4,
<a name="2199"/> 2199:        ttest_ssocko_csockt_medium_tcp6,
<a name="2200"/> 2200:        ttest_ssocko_csockt_medium_tcpL],
<a name="2201"/> 2201:       %% Large
<a name="2202"/> 2202:       [ttest_ssocko_csockt_large_tcp4,
<a name="2203"/> 2203:        ttest_ssocko_csockt_large_tcp6,
<a name="2204"/> 2204:        ttest_ssocko_csockt_large_tcpL]).
<a name="2205"/> 2205: 
<a name="2206"/> 2206: <i>%% Server: transport = socket(tcp), active = true</i>
<a name="ttest_ssockt_cases-0"/><a name="2207"/> 2207: <b>ttest_ssockt_cases</b>() -&gt;
<a name="ttest_ssockt_cases-last_expr"/><a name="2208"/> 2208:     [
<a name="2209"/> 2209:      {group, ttest_ssockt_cgen},
<a name="2210"/> 2210:      {group, ttest_ssockt_csock}
<a name="2211"/> 2211:     ].
<a name="2212"/> 2212: 
<a name="2213"/> 2213: <i>%% Server: transport = socket(tcp), active = true</i>
<a name="2214"/> 2214: <i>%% Client: transport = gen_tcp</i>
<a name="ttest_ssockt_cgen_cases-0"/><a name="2215"/> 2215: <b>ttest_ssockt_cgen_cases</b>() -&gt;
<a name="ttest_ssockt_cgen_cases-last_expr"/><a name="2216"/> 2216:     [
<a name="2217"/> 2217:      {group, ttest_ssockt_cgenf},
<a name="2218"/> 2218:      {group, ttest_ssockt_cgeno},
<a name="2219"/> 2219:      {group, ttest_ssockt_cgent}
<a name="2220"/> 2220:     ].
<a name="2221"/> 2221: 
<a name="2222"/> 2222: <i>%% Server: transport = socket(tcp), active = true</i>
<a name="2223"/> 2223: <i>%% Client: transport = gen_tcp, active = false</i>
<a name="ttest_ssockt_cgenf_cases-0"/><a name="2224"/> 2224: <b>ttest_ssockt_cgenf_cases</b>() -&gt;
<a name="ttest_ssockt_cgenf_cases-last_expr"/><a name="2225"/> 2225: <b>    ttest_select_conditional_cases</b>(
<a name="2226"/> 2226:       %% Small
<a name="2227"/> 2227:       [ttest_ssockt_cgenf_small_tcp4,
<a name="2228"/> 2228:        ttest_ssockt_cgenf_small_tcp6],
<a name="2229"/> 2229:       %% Medium
<a name="2230"/> 2230:       [ttest_ssockt_cgenf_medium_tcp4,
<a name="2231"/> 2231:        ttest_ssockt_cgenf_medium_tcp6],
<a name="2232"/> 2232:       %% Large
<a name="2233"/> 2233:       [ttest_ssockt_cgenf_large_tcp4,
<a name="2234"/> 2234:        ttest_ssockt_cgenf_large_tcp6]).
<a name="2235"/> 2235: 
<a name="2236"/> 2236: <i>%% Server: transport = socket(tcp), active = true</i>
<a name="2237"/> 2237: <i>%% Client: transport = gen_tcp, active = once</i>
<a name="ttest_ssockt_cgeno_cases-0"/><a name="2238"/> 2238: <b>ttest_ssockt_cgeno_cases</b>() -&gt;
<a name="ttest_ssockt_cgeno_cases-last_expr"/><a name="2239"/> 2239: <b>    ttest_select_conditional_cases</b>(
<a name="2240"/> 2240:       %% Small
<a name="2241"/> 2241:       [ttest_ssockt_cgeno_small_tcp4,
<a name="2242"/> 2242:        ttest_ssockt_cgeno_small_tcp6],
<a name="2243"/> 2243:       %% Medium
<a name="2244"/> 2244:       [ttest_ssockt_cgeno_medium_tcp4,
<a name="2245"/> 2245:        ttest_ssockt_cgeno_medium_tcp6],
<a name="2246"/> 2246:       %% Large
<a name="2247"/> 2247:       [ttest_ssockt_cgeno_large_tcp4,
<a name="2248"/> 2248:        ttest_ssockt_cgeno_large_tcp6]).
<a name="2249"/> 2249: 
<a name="2250"/> 2250: <i>%% Server: transport = socket(tcp), active = true</i>
<a name="2251"/> 2251: <i>%% Client: transport = gen_tcp, active = true</i>
<a name="ttest_ssockt_cgent_cases-0"/><a name="2252"/> 2252: <b>ttest_ssockt_cgent_cases</b>() -&gt;
<a name="ttest_ssockt_cgent_cases-last_expr"/><a name="2253"/> 2253: <b>    ttest_select_conditional_cases</b>(
<a name="2254"/> 2254:       %% Small
<a name="2255"/> 2255:       [ttest_ssockt_cgent_small_tcp4,
<a name="2256"/> 2256:        ttest_ssockt_cgent_small_tcp6],
<a name="2257"/> 2257:       %% Medium
<a name="2258"/> 2258:       [ttest_ssockt_cgent_medium_tcp4,
<a name="2259"/> 2259:        ttest_ssockt_cgent_medium_tcp6],
<a name="2260"/> 2260:       %% Large
<a name="2261"/> 2261:       [ttest_ssockt_cgent_large_tcp4,
<a name="2262"/> 2262:        ttest_ssockt_cgent_large_tcp6]).
<a name="2263"/> 2263: 
<a name="2264"/> 2264: <i>%% Server: transport = socket(tcp), active = true</i>
<a name="2265"/> 2265: <i>%% Client: transport = socket(tcp)</i>
<a name="ttest_ssockt_csock_cases-0"/><a name="2266"/> 2266: <b>ttest_ssockt_csock_cases</b>() -&gt;
<a name="ttest_ssockt_csock_cases-last_expr"/><a name="2267"/> 2267:     [
<a name="2268"/> 2268:      {group, ttest_ssockt_csockf},
<a name="2269"/> 2269:      {group, ttest_ssockt_csocko},
<a name="2270"/> 2270:      {group, ttest_ssockt_csockt}
<a name="2271"/> 2271:     ].
<a name="2272"/> 2272: 
<a name="2273"/> 2273: <i>%% Server: transport = socket(tcp), active = true</i>
<a name="2274"/> 2274: <i>%% Client: transport = socket(tcp), active = false</i>
<a name="ttest_ssockt_csockf_cases-0"/><a name="2275"/> 2275: <b>ttest_ssockt_csockf_cases</b>() -&gt;
<a name="ttest_ssockt_csockf_cases-last_expr"/><a name="2276"/> 2276: <b>    ttest_select_conditional_cases</b>(
<a name="2277"/> 2277:       %% Small
<a name="2278"/> 2278:       [ttest_ssockt_csockf_small_tcp4,
<a name="2279"/> 2279:        ttest_ssockt_csockf_small_tcp6,
<a name="2280"/> 2280:        ttest_ssockt_csockf_small_tcpL],
<a name="2281"/> 2281:       %% Medium
<a name="2282"/> 2282:       [ttest_ssockt_csockf_medium_tcp4,
<a name="2283"/> 2283:        ttest_ssockt_csockf_medium_tcp6,
<a name="2284"/> 2284:        ttest_ssockt_csockf_medium_tcpL],
<a name="2285"/> 2285:       %% Large
<a name="2286"/> 2286:       [ttest_ssockt_csockf_large_tcp4,
<a name="2287"/> 2287:        ttest_ssockt_csockf_large_tcp6,
<a name="2288"/> 2288:        ttest_ssockt_csockf_large_tcpL]).
<a name="2289"/> 2289: 
<a name="2290"/> 2290: <i>%% Server: transport = socket(tcp), active = true</i>
<a name="2291"/> 2291: <i>%% Client: transport = socket(tcp), active = once</i>
<a name="ttest_ssockt_csocko_cases-0"/><a name="2292"/> 2292: <b>ttest_ssockt_csocko_cases</b>() -&gt;
<a name="ttest_ssockt_csocko_cases-last_expr"/><a name="2293"/> 2293: <b>    ttest_select_conditional_cases</b>(
<a name="2294"/> 2294:       %% Small
<a name="2295"/> 2295:       [ttest_ssockt_csocko_small_tcp4,
<a name="2296"/> 2296:        ttest_ssockt_csocko_small_tcp6,
<a name="2297"/> 2297:        ttest_ssockt_csocko_small_tcpL],
<a name="2298"/> 2298:       %% Medium
<a name="2299"/> 2299:       [ttest_ssockt_csocko_medium_tcp4,
<a name="2300"/> 2300:        ttest_ssockt_csocko_medium_tcp6,
<a name="2301"/> 2301:        ttest_ssockt_csocko_medium_tcpL],
<a name="2302"/> 2302:       %% Large
<a name="2303"/> 2303:       [ttest_ssockt_csocko_large_tcp4,
<a name="2304"/> 2304:        ttest_ssockt_csocko_large_tcp6,
<a name="2305"/> 2305:        ttest_ssockt_csocko_large_tcpL]).
<a name="2306"/> 2306: 
<a name="2307"/> 2307: <i>%% Server: transport = socket(tcp), active = true</i>
<a name="2308"/> 2308: <i>%% Client: transport = socket(tcp), active = true</i>
<a name="ttest_ssockt_csockt_cases-0"/><a name="2309"/> 2309: <b>ttest_ssockt_csockt_cases</b>() -&gt;
<a name="ttest_ssockt_csockt_cases-last_expr"/><a name="2310"/> 2310: <b>    ttest_select_conditional_cases</b>(
<a name="2311"/> 2311:       %% Small
<a name="2312"/> 2312:       [ttest_ssockt_csockt_small_tcp4,
<a name="2313"/> 2313:        ttest_ssockt_csockt_small_tcp6,
<a name="2314"/> 2314:        ttest_ssockt_csockt_small_tcpL],
<a name="2315"/> 2315:       %% Medium
<a name="2316"/> 2316:       [ttest_ssockt_csockt_medium_tcp4,
<a name="2317"/> 2317:        ttest_ssockt_csockt_medium_tcp6,
<a name="2318"/> 2318:        ttest_ssockt_csockt_medium_tcpL],
<a name="2319"/> 2319:       %% Large
<a name="2320"/> 2320:       [ttest_ssockt_csockt_large_tcp4,
<a name="2321"/> 2321:        ttest_ssockt_csockt_large_tcp6,
<a name="2322"/> 2322:        ttest_ssockt_csockt_large_tcpL]).
<a name="2323"/> 2323: 
<a name="2324"/> 2324: <i>%% Server: transport = socket(tcp), active = true</i>
<a name="ttest_simple_ssockt_cases-0"/><a name="2325"/> 2325: <b>ttest_simple_ssockt_cases</b>() -&gt;
<a name="ttest_simple_ssockt_cases-last_expr"/><a name="2326"/> 2326:     [
<a name="2327"/> 2327:      {group, ttest_simple_ssockt_csock}
<a name="2328"/> 2328:     ].
<a name="2329"/> 2329: 
<a name="2330"/> 2330: <i>%% Server: transport = socket(tcp), active = true</i>
<a name="2331"/> 2331: <i>%% Client: transport = socket(tcp)</i>
<a name="ttest_simple_ssockt_csock_cases-0"/><a name="2332"/> 2332: <b>ttest_simple_ssockt_csock_cases</b>() -&gt;
<a name="ttest_simple_ssockt_csock_cases-last_expr"/><a name="2333"/> 2333:     [
<a name="2334"/> 2334:      %% {group, ttest_simple_ssockt_csockf},
<a name="2335"/> 2335:      {group, ttest_simple_ssockt_csocko}%% ,
<a name="2336"/> 2336:      %% {group, ttest_simple_ssockt_csockt}
<a name="2337"/> 2337:     ].
<a name="2338"/> 2338: 
<a name="2339"/> 2339: <i>%% Server: transport = socket(tcp), active = true</i>
<a name="2340"/> 2340: <i>%% Client: transport = socket(tcp), active = once</i>
<a name="ttest_simple_ssockt_csocko_cases-0"/><a name="2341"/> 2341: <b>ttest_simple_ssockt_csocko_cases</b>() -&gt;
<a name="ttest_simple_ssockt_csocko_cases-last_expr"/><a name="2342"/> 2342: <b>    ttest_select_conditional_cases</b>(
<a name="2343"/> 2343:       %% Small
<a name="2344"/> 2344:       [ttest_simple_ssockt_csocko_small_tcp4,
<a name="2345"/> 2345:        ttest_simple_ssockt_csocko_small_tcp6,
<a name="2346"/> 2346:        ttest_simple_ssockt_csocko_small_tcpL],
<a name="2347"/> 2347:       %% Medium
<a name="2348"/> 2348:       [],
<a name="2349"/> 2349:       %% Large
<a name="2350"/> 2350:       []).
<a name="2351"/> 2351: 
<a name="tickets_cases-0"/><a name="2352"/> 2352: <b>tickets_cases</b>() -&gt;
<a name="tickets_cases-last_expr"/><a name="2353"/> 2353:     [
<a name="2354"/> 2354:      {group, otp16359},
<a name="2355"/> 2355:      {group, otp18240},
<a name="2356"/> 2356:      otp18635
<a name="2357"/> 2357:     ].
<a name="2358"/> 2358: 
<a name="otp16359_cases-0"/><a name="2359"/> 2359: <b>otp16359_cases</b>() -&gt;
<a name="otp16359_cases-last_expr"/><a name="2360"/> 2360:     [
<a name="2361"/> 2361:      otp16359_maccept_tcp4,
<a name="2362"/> 2362:      otp16359_maccept_tcp6,
<a name="2363"/> 2363:      otp16359_maccept_tcpL
<a name="2364"/> 2364:     ].
<a name="2365"/> 2365: 
<a name="2366"/> 2366: 
<a name="otp18240_cases-0"/><a name="2367"/> 2367: <b>otp18240_cases</b>() -&gt;
<a name="otp18240_cases-last_expr"/><a name="2368"/> 2368:     [
<a name="2369"/> 2369:      otp18240_accept_mon_leak_tcp4,
<a name="2370"/> 2370:      otp18240_accept_mon_leak_tcp6
<a name="2371"/> 2371:     ].
<a name="2372"/> 2372: 
<a name="2373"/> 2373: 
<a name="2374"/> 2374: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="2375"/> 2375: 
<a name="init_per_suite-1"/><a name="2376"/> 2376: <b>init_per_suite</b>(Config0) -&gt;
<a name="2377"/> 2377:     ?P(&quot;init_per_suite -&gt; entry with&quot;
<a name="2378"/> 2378:        &quot;~n      Config: ~p&quot;
<a name="2379"/> 2379:        &quot;~n      Nodes:  ~p&quot;, [Config0, erlang:nodes()]),
<a name="2380"/> 2380:     
<a name="init_per_suite-last_expr"/><a name="2381"/> 2381: <b>    try socket:info</b>() of
<a name="2382"/> 2382:         #{} -&gt;
<a name="2383"/> 2383:             case ?KLIB:init_per_suite(Config0) of
<a name="2384"/> 2384:                 {skip, _} = SKIP -&gt;
<a name="2385"/> 2385:                     SKIP;
<a name="2386"/> 2386: 
<a name="2387"/> 2387:                 Config1 when is_list(Config1) -&gt;
<a name="2388"/> 2388: 
<a name="2389"/> 2389:                     ?P(&quot;init_per_suite -&gt; end when &quot;
<a name="2390"/> 2390:                        &quot;~n      Config: ~p&quot;, [Config1]),
<a name="2391"/> 2391: 
<a name="2392"/> 2392:                     %% We need a monitor on this node also
<a name="2393"/> 2393:                     kernel_test_sys_monitor:start(),
<a name="2394"/> 2394: 
<a name="2395"/> 2395:                     socket:use_registry(false),
<a name="2396"/> 2396:                     case quiet_mode(Config1) of
<a name="2397"/> 2397:                         default -&gt;
<a name="2398"/> 2398:                             case ?LOGGER:start() of
<a name="2399"/> 2399:                                 ok -&gt;
<a name="2400"/> 2400:                                     Config1;
<a name="2401"/> 2401:                                 {error, Reason} -&gt;
<a name="2402"/> 2402:                                     ?P(&quot;init_per_suite -&gt; &quot;
<a name="2403"/> 2403:                                        &quot;Failed starting logger&quot;
<a name="2404"/> 2404:                                        &quot;~n   Reason: ~p&quot;
<a name="2405"/> 2405:                                        &quot;~n&quot;, [Reason]),
<a name="2406"/> 2406:                                     {skip, &quot;Failed starting logger&quot;}
<a name="2407"/> 2407:                             end;
<a name="2408"/> 2408:                         Quiet -&gt;
<a name="2409"/> 2409:                             case ?LOGGER:start(Quiet) of
<a name="2410"/> 2410:                                 ok -&gt;
<a name="2411"/> 2411:                                     [{esock_test_quiet, Quiet} | Config1];
<a name="2412"/> 2412:                                 {error, Reason} -&gt;
<a name="2413"/> 2413:                                     ?P(&quot;init_per_suite -&gt; &quot;
<a name="2414"/> 2414:                                        &quot;Failed starting logger&quot;
<a name="2415"/> 2415:                                        &quot;~n   Reason: ~p&quot;
<a name="2416"/> 2416:                                        &quot;~n&quot;, [Reason]),
<a name="2417"/> 2417:                                     {skip, &quot;Failed starting logger&quot;}
<a name="2418"/> 2418:                             end
<a name="2419"/> 2419:                     end
<a name="2420"/> 2420:             end
<a name="2421"/> 2421:     catch
<a name="2422"/> 2422:         error : notsup -&gt;
<a name="2423"/> 2423:             {skip, &quot;esock not supported&quot;};
<a name="2424"/> 2424:         error : undef -&gt;
<a name="2425"/> 2425:             {skip, &quot;esock not configured&quot;}
<a name="2426"/> 2426:     end.
<a name="2427"/> 2427: 
<a name="end_per_suite-1"/><a name="2428"/> 2428: <b>end_per_suite</b>(Config0) -&gt;
<a name="2429"/> 2429: 
<a name="2430"/> 2430:     ?P(&quot;end_per_suite -&gt; entry with&quot;
<a name="2431"/> 2431:        &quot;~n      Config: ~p&quot;
<a name="2432"/> 2432:        &quot;~n      Nodes:  ~p&quot;, [Config0, erlang:nodes()]),
<a name="2433"/> 2433: 
<a name="2434"/> 2434:     %% Stop the local monitor
<a name="2435"/> 2435:     kernel_test_sys_monitor:stop(),
<a name="2436"/> 2436: 
<a name="2437"/> 2437:     (catch ?LOGGER:stop()),
<a name="2438"/> 2438: 
<a name="2439"/> 2439:     Config1 = ?KLIB:end_per_suite(Config0),
<a name="2440"/> 2440: 
<a name="2441"/> 2441:     ?P(&quot;end_per_suite -&gt; &quot;
<a name="2442"/> 2442:        &quot;~n      Nodes: ~p&quot;, [erlang:nodes()]),
<a name="2443"/> 2443: 
<a name="end_per_suite-last_expr"/><a name="2444"/> 2444:     Config1.
<a name="2445"/> 2445: 
<a name="2446"/> 2446: 
<a name="init_per_group-2"/><a name="2447"/> 2447: <b>init_per_group</b>(api_sendfile = GroupName, Config) -&gt;
<a name="2448"/> 2448:     io:format(&quot;init_per_group(~w) -&gt; entry with&quot;
<a name="2449"/> 2449:               &quot;~n   Config: ~p&quot;
<a name="2450"/> 2450:               &quot;~n&quot;, [GroupName, Config]),
<a name="2451"/> 2451:     case socket:is_supported(sendfile) of
<a name="2452"/> 2452:         true -&gt;
<a name="2453"/> 2453:             Dir = proplists:get_value(priv_dir, Config),
<a name="2454"/> 2454:             HeaderSize = 1021, % I like prime numbers
<a name="2455"/> 2455:             DataSize = 1031,  Pow2 = 16, % About 64 MB
<a name="2456"/> 2456:             Header = rand:bytes(HeaderSize),
<a name="2457"/> 2457:             Filler = rand:bytes(DataSize),
<a name="2458"/> 2458:             Trailer = rand:bytes(HeaderSize),
<a name="2459"/> 2459:             FileName = filename:join(Dir, &quot;sendfile.bin&quot;),
<a name="2460"/> 2460:             file:write_file(
<a name="2461"/> 2461:               FileName,
<a name="2462"/> 2462:               [Header, double_data(Pow2, Filler), Trailer]),
<a name="2463"/> 2463:             N = 1 bsl Pow2,
<a name="2464"/> 2464:             [{sendfile_file,
<a name="2465"/> 2465:               {FileName,
<a name="2466"/> 2466:                HeaderSize + (N * DataSize) + HeaderSize,
<a name="2467"/> 2467:                [Header, {N, Filler}, Trailer]}}
<a name="2468"/> 2468:              | Config];
<a name="2469"/> 2469:         false -&gt;
<a name="2470"/> 2470:             Config
<a name="2471"/> 2471:     end;
<a name="2472"/> 2472: <b>init_per_group</b>(GroupName, Config)
<a name="2473"/> 2473:   when (GroupName =:= sc_remote_close) orelse
<a name="2474"/> 2474:        (GroupName =:= sc_remote_shutdown) orelse
<a name="2475"/> 2475:        (GroupName =:= traffic) -&gt;
<a name="2476"/> 2476:     io:format(&quot;init_per_group(~w) -&gt; entry with&quot;
<a name="2477"/> 2477:               &quot;~n   Config: ~p&quot;
<a name="2478"/> 2478:               &quot;~n&quot;, [GroupName, Config]),
<a name="2479"/> 2479:     %% Maybe we should skip the entire suite for this platform,
<a name="2480"/> 2480:     %% but for now we just skip these groups, which seem to 
<a name="2481"/> 2481:     %% have problems (node start).
<a name="2482"/> 2482:     %% As stated elsewhere, its not really Fedora 16, but 
<a name="2483"/> 2483:     %% the *really* slow VM that is the issue.
<a name="2484"/> 2484:     try is_old_fedora16() of
<a name="2485"/> 2485:         ok -&gt;
<a name="2486"/> 2486:             Config
<a name="2487"/> 2487:     catch
<a name="2488"/> 2488:         throw:{skip, _} = SKIP -&gt;
<a name="2489"/> 2489:             SKIP
<a name="2490"/> 2490:     end;
<a name="2491"/> 2491: <b>init_per_group</b>(ttest = _GroupName, Config) -&gt;
<a name="2492"/> 2492:     io:format(&quot;init_per_group(~w) -&gt; entry with&quot;
<a name="2493"/> 2493:               &quot;~n   Config: ~p&quot;
<a name="2494"/> 2494:               &quot;~n&quot;, [_GroupName, Config]),
<a name="2495"/> 2495:     case ttest_condition(Config) of
<a name="2496"/> 2496:         ok -&gt;
<a name="2497"/> 2497:             ttest_manager_start(),
<a name="2498"/> 2498:             case lists:keysearch(esock_test_ttest_runtime, 1, Config) of
<a name="2499"/> 2499:                 {value, _} -&gt;
<a name="2500"/> 2500:                     Config;
<a name="2501"/> 2501:                 false -&gt;
<a name="2502"/> 2502:                     [{esock_test_ttest_runtime, which_ttest_runtime_env()} |
<a name="2503"/> 2503:                      Config]
<a name="2504"/> 2504:             end;
<a name="2505"/> 2505:         {skip, _} = SKIP -&gt;
<a name="2506"/> 2506:             SKIP
<a name="2507"/> 2507:     end;
<a name="2508"/> 2508: <b>init_per_group</b>(api_async_ref, Config) -&gt;
<a name="2509"/> 2509:     [{select_handle, true} | Config];
<a name="2510"/> 2510: <b>init_per_group</b>(_GroupName, Config) -&gt;
<a name="init_per_group-last_expr"/><a name="2511"/> 2511:     Config.
<a name="2512"/> 2512: 
<a name="end_per_group-2"/><a name="2513"/> 2513: <b>end_per_group</b>(ttest = _GroupName, Config) -&gt;
<a name="2514"/> 2514:     io:format(&quot;init_per_group(~w) -&gt; entry with&quot;
<a name="2515"/> 2515:               &quot;~n   Config: ~p&quot;
<a name="2516"/> 2516:               &quot;~n&quot;, [_GroupName, Config]),
<a name="2517"/> 2517:     ttest_manager_stop(),
<a name="2518"/> 2518:     lists:keydelete(esock_test_ttest_runtime, 1, Config);
<a name="2519"/> 2519: <b>end_per_group</b>(api_async_ref, Config) -&gt;
<a name="2520"/> 2520:     lists:keydelete(select_handle, 1, Config);
<a name="2521"/> 2521: <b>end_per_group</b>(_GroupName, Config) -&gt;
<a name="end_per_group-last_expr"/><a name="2522"/> 2522:     Config.
<a name="2523"/> 2523: 
<a name="2524"/> 2524: 
<a name="init_per_testcase-2"/><a name="2525"/> 2525: <b>init_per_testcase</b>(_TC, Config) -&gt;
<a name="2526"/> 2526:     io:format(&quot;init_per_testcase(~w) -&gt; entry with&quot;
<a name="2527"/> 2527:               &quot;~n   Config: ~p&quot;
<a name="2528"/> 2528:               &quot;~n&quot;, [_TC, Config]),
<a name="2529"/> 2529:     %% case quiet_mode(Config) of
<a name="2530"/> 2530:     %%     default -&gt;
<a name="2531"/> 2531:     %%         ?LOGGER:start();
<a name="2532"/> 2532:     %%     Quiet -&gt;
<a name="2533"/> 2533:     %%         ?LOGGER:start(Quiet)
<a name="2534"/> 2534:     %% end,
<a name="init_per_testcase-last_expr"/><a name="2535"/> 2535:     Config.
<a name="2536"/> 2536: 
<a name="end_per_testcase-2"/><a name="2537"/> 2537: <b>end_per_testcase</b>(_TC, Config) -&gt;
<a name="2538"/> 2538:     %% ?LOGGER:stop(),
<a name="end_per_testcase-last_expr"/><a name="2539"/> 2539:     Config.
<a name="2540"/> 2540: 
<a name="2541"/> 2541: 
<a name="quiet_mode-1"/><a name="2542"/> 2542: <b>quiet_mode</b>(Config) -&gt;
<a name="quiet_mode-last_expr"/><a name="2543"/> 2543: <b>    case lists:keysearch</b>(esock_test_quiet, 1, Config) of
<a name="2544"/> 2544:         {value, {esock_test_quiet, Quiet}} -&gt;
<a name="2545"/> 2545:             Quiet;
<a name="2546"/> 2546:         false -&gt;
<a name="2547"/> 2547:             case os:getenv(&quot;ESOCK_TEST_QUIET&quot;) of
<a name="2548"/> 2548:                 &quot;true&quot;  -&gt; true;
<a name="2549"/> 2549:                 &quot;false&quot; -&gt; false;
<a name="2550"/> 2550:                 _       -&gt; default
<a name="2551"/> 2551:             end
<a name="2552"/> 2552:     end.
<a name="2553"/> 2553: 
<a name="double_data-2"/><a name="2554"/> 2554: <b>double_data</b>(0, Data) -&gt;
<a name="2555"/> 2555:     Data;
<a name="2556"/> 2556: <b>double_data</b>(N, Data) -&gt;
<a name="double_data-last_expr"/><a name="2557"/> 2557: <b>    double_data</b>(N - 1, [Data, Data]).
<a name="2558"/> 2558: 
<a name="2559"/> 2559: 
<a name="2560"/> 2560: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="2561"/> 2561: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="2562"/> 2562: <i>%%                                                                     %%</i>
<a name="2563"/> 2563: <i>%%                           API MISC                                  %%</i>
<a name="2564"/> 2564: <i>%%                                                                     %%</i>
<a name="2565"/> 2565: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="2566"/> 2566: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="2567"/> 2567: 
<a name="2568"/> 2568: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="2569"/> 2569: 
<a name="2570"/> 2570: <i>%% This is an extremely rudimentary test case, that just tests</i>
<a name="2571"/> 2571: <i>%% that we can call the &quot;global&quot; info function and that it returns</i>
<a name="2572"/> 2572: <i>%% a non-empty map...</i>
<a name="2573"/> 2573: 
<a name="api_m_info-1"/><a name="2574"/> 2574: <b>api_m_info</b>(_Config) when is_list(_Config) -&gt;
<a name="2575"/> 2575:     ?TT(?SECS(5)),
<a name="api_m_info-last_expr"/><a name="2576"/> 2576: <b>    tc_try</b>(api_m_info,
<a name="2577"/> 2577:            fun() -&gt;
<a name="2578"/> 2578:                    ok = api_m_info()
<a name="2579"/> 2579:            end).
<a name="2580"/> 2580: 
<a name="api_m_info-0"/><a name="2581"/> 2581: <b>api_m_info</b>() -&gt;
<a name="api_m_info-last_expr"/><a name="2582"/> 2582: <b>    case socket:info</b>() of
<a name="2583"/> 2583:         Info when is_map(Info) -&gt;
<a name="2584"/> 2584:             Sz = maps:size(Info),
<a name="2585"/> 2585:             if
<a name="2586"/> 2586:                 (Sz &gt; 0) -&gt;
<a name="2587"/> 2587:                     ok;
<a name="2588"/> 2588:                 true -&gt;
<a name="2589"/> 2589:                     ?FAIL(no_info)
<a name="2590"/> 2590:             end;
<a name="2591"/> 2591:         Info -&gt;
<a name="2592"/> 2592:             ?FAIL({invalid_info, Info})
<a name="2593"/> 2593:     end.
<a name="2594"/> 2594: 
<a name="2595"/> 2595: 
<a name="2596"/> 2596: 
<a name="2597"/> 2597: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="2598"/> 2598: 
<a name="2599"/> 2599: <i>%% A simple test case that tests that the global debug can be changed.</i>
<a name="2600"/> 2600: <i>%% At the same time, it will test the info function (since it uses it</i>
<a name="2601"/> 2601: <i>%% for verification).</i>
<a name="2602"/> 2602: 
<a name="api_m_debug-1"/><a name="2603"/> 2603: <b>api_m_debug</b>(_Config) when is_list(_Config) -&gt;
<a name="2604"/> 2604:     ?TT(?SECS(5)),
<a name="api_m_debug-last_expr"/><a name="2605"/> 2605: <b>    tc_try</b>(api_m_debug,
<a name="2606"/> 2606:            fun() -&gt; has_bugfree_gcc() end,
<a name="2607"/> 2607:            fun() -&gt;
<a name="2608"/> 2608:                    ok = api_m_debug()
<a name="2609"/> 2609:            end).
<a name="2610"/> 2610: 
<a name="2611"/> 2611: <i>%% For some reason this test case triggers a gcc bug, which causes</i>
<a name="2612"/> 2612: <i>%% a segfault, on an ancient Fedora 16 VM. So, check the version of gcc...</i>
<a name="2613"/> 2613: <i>%% Not pretty, but the simplest way to skip (without actually testing</i>
<a name="2614"/> 2614: <i>%% for the host).</i>
<a name="has_bugfree_gcc-0"/><a name="2615"/> 2615: <b>has_bugfree_gcc</b>() -&gt;
<a name="has_bugfree_gcc-last_expr"/><a name="2616"/> 2616: <b>    has_bugfree_gcc</b>(os:type()).
<a name="2617"/> 2617: 
<a name="2618"/> 2618: <i>%% Make sure we are on linux</i>
<a name="has_bugfree_gcc-1"/><a name="2619"/> 2619: <b>has_bugfree_gcc</b>({unix, linux}) -&gt;
<a name="2620"/> 2620:     has_bugfree_gcc2(string:trim(os:cmd(&quot;cat /etc/issue&quot;)));
<a name="2621"/> 2621: <b>has_bugfree_gcc</b>(_) -&gt;
<a name="has_bugfree_gcc-last_expr"/><a name="2622"/> 2622:     ok.
<a name="2623"/> 2623: 
<a name="2624"/> 2624: <i>%% Make sure we are on Fedora 16</i>
<a name="has_bugfree_gcc2-1"/><a name="2625"/> 2625: <b>has_bugfree_gcc2</b>(&quot;Fedora release 16 &quot; ++ _) -&gt;
<a name="2626"/> 2626:     has_bugfree_gcc3(os:cmd(&quot;gcc --version&quot;));
<a name="2627"/> 2627: <b>has_bugfree_gcc2</b>(&quot;Welcome to SUSE Linux &quot; ++ _) -&gt;
<a name="2628"/> 2628:     has_bugfree_gcc4(os:cmd(&quot;gcc --version&quot;));
<a name="2629"/> 2629: <b>has_bugfree_gcc2</b>(_) -&gt;
<a name="has_bugfree_gcc2-last_expr"/><a name="2630"/> 2630:     ok.
<a name="2631"/> 2631: 
<a name="has_bugfree_gcc3-1"/><a name="2632"/> 2632: <b>has_bugfree_gcc3</b>(&quot;gcc (GCC) 4.6.3 20120306 (Red Hat 4.6.3-2&quot; ++ _) -&gt;
<a name="2633"/> 2633:     skip(&quot;Buggy GCC&quot;);
<a name="2634"/> 2634: <b>has_bugfree_gcc3</b>(_) -&gt;
<a name="has_bugfree_gcc3-last_expr"/><a name="2635"/> 2635:     ok.
<a name="2636"/> 2636: 
<a name="has_bugfree_gcc4-1"/><a name="2637"/> 2637: <b>has_bugfree_gcc4</b>(&quot;gcc (SUSE Linux) 4.3.2&quot; ++ _) -&gt;
<a name="2638"/> 2638:     skip(&quot;Buggy GCC&quot;);
<a name="2639"/> 2639: <b>has_bugfree_gcc4</b>(_) -&gt;
<a name="has_bugfree_gcc4-last_expr"/><a name="2640"/> 2640:     ok.
<a name="2641"/> 2641: 
<a name="api_m_debug-0"/><a name="2642"/> 2642: <b>api_m_debug</b>() -&gt;
<a name="2643"/> 2643:     i(&quot;get initial info&quot;),
<a name="2644"/> 2644:     #{debug := D0} = socket:info(),
<a name="2645"/> 2645:     D1 = not D0,
<a name="2646"/> 2646:     i(&quot;set new debug (~w =&gt; ~w)&quot;, [D0, D1]),
<a name="2647"/> 2647:     ok = socket:debug(D1),
<a name="2648"/> 2648:     i(&quot;get updated info (~w)&quot;, [D1]),
<a name="2649"/> 2649:     #{debug := D1} = socket:info(),
<a name="2650"/> 2650:     D2 = not D1,
<a name="2651"/> 2651:     i(&quot;set new debug (~w =&gt; ~w)&quot;, [D1, D2]),
<a name="2652"/> 2652:     ok = socket:debug(D2),
<a name="2653"/> 2653:     i(&quot;get updated info (~w)&quot;, [D2]),
<a name="2654"/> 2654:     #{debug := D2} = socket:info(),
<a name="2655"/> 2655:     i(&quot;ok&quot;),
<a name="api_m_debug-last_expr"/><a name="2656"/> 2656:     ok.
<a name="2657"/> 2657:     
<a name="2658"/> 2658: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="2659"/> 2659: 
<a name="2660"/> 2660: <i>%% Some tests for API misuses</i>
<a name="2661"/> 2661: 
<a name="2662"/> 2662: <b>-define</b>(
<a name="2663"/> 2663:    EXCEPTION(Code),
<a name="2664"/> 2664:    exception(fun () -&gt; begin Code end end)).
<a name="2665"/> 2665: 
<a name="exception-1"/><a name="2666"/> 2666: <b>exception</b>(Fun) -&gt;
<a name="exception-last_expr"/><a name="2667"/> 2667: <b>    try Fun</b>() of
<a name="2668"/> 2668:         Result -&gt;
<a name="2669"/> 2669:             error({unexpected_return, Result})
<a name="2670"/> 2670:     catch
<a name="2671"/> 2671:         Class : Reason -&gt;
<a name="2672"/> 2672:             {Class, Reason}
<a name="2673"/> 2673:     end.
<a name="2674"/> 2674: 
<a name="2675"/> 2675: 
<a name="api_m_error_open-1"/><a name="2676"/> 2676: <b>api_m_error_open</b>(Config) when is_list(Config) -&gt;
<a name="2677"/> 2677:     %%
<a name="2678"/> 2678:     %% open/1
<a name="2679"/> 2679:     {error, badarg} =
<a name="2680"/> 2680:         ?EXCEPTION(
<a name="2681"/> 2681:            socket:open(should_be_fd) ),
<a name="2682"/> 2682:     %%
<a name="2683"/> 2683:     %% open/2
<a name="2684"/> 2684:     {error, badarg} =
<a name="2685"/> 2685:         ?EXCEPTION(
<a name="2686"/> 2686:            socket:open(should_be_fd, #{}) ),
<a name="2687"/> 2687:     %%
<a name="2688"/> 2688:     %% A non-atom, non-integer protocol causes an exception
<a name="2689"/> 2689:     %% in prim_socket, whilst a non-atom, non-integer type
<a name="2690"/> 2690:     %% or domain causes an error return tuple from the NIF
<a name="2691"/> 2691:     %% code.  This is a bit inconsistent.  Should we change
<a name="2692"/> 2692:     %% that, if so - how, and consolidate in tests?
<a name="2693"/> 2693:     %%
<a name="2694"/> 2694:     {error,{invalid,{domain,should_be_domain}}} =
<a name="2695"/> 2695:         socket:open(should_be_domain, dgram),
<a name="2696"/> 2696:     {error,{invalid,{type,should_be_type}}} =
<a name="2697"/> 2697:         socket:open(inet, should_be_type),
<a name="2698"/> 2698:     %%
<a name="2699"/> 2699:     %% open/3
<a name="2700"/> 2700:     {error,{invalid,{domain,should_be_domain}}} =
<a name="2701"/> 2701:         socket:open(should_be_domain, dgram, #{}),
<a name="2702"/> 2702:     {error,{invalid,{type,should_be_type}}} =
<a name="2703"/> 2703:         socket:open(inet, should_be_type, #{}),
<a name="2704"/> 2704:     {error,{invalid,{protocol,should_be_protocol}}} =
<a name="2705"/> 2705:         socket:open(inet, dgram, should_be_protocol),
<a name="2706"/> 2706:     %%
<a name="2707"/> 2707:     %% open/4
<a name="2708"/> 2708:     {error,{invalid,{domain,should_be_domain}}} =
<a name="2709"/> 2709:         socket:open(should_be_domain, dgram, default, #{}),
<a name="2710"/> 2710:     {error,{invalid,{type,should_be_type}}} =
<a name="2711"/> 2711:         socket:open(inet, should_be_type, default, #{}),
<a name="2712"/> 2712:     {error,{invalid,{protocol,should_be_protocol}}} =
<a name="2713"/> 2713:         socket:open(inet, dgram, should_be_protocol, #{}),
<a name="api_m_error_open-last_expr"/><a name="2714"/> 2714:     {error, badarg} =
<a name="2715"/> 2715:         ?EXCEPTION(
<a name="2716"/> 2716:            socket:open(inet, dgram, default, should_be_options) ).
<a name="2717"/> 2717: 
<a name="2718"/> 2718: 
<a name="api_m_error_bind-1"/><a name="2719"/> 2719: <b>api_m_error_bind</b>(Config) when is_list(Config) -&gt;
<a name="2720"/> 2720:     {ok, S} = socket:open(inet, dgram),
<a name="2721"/> 2721:     try
<a name="2722"/> 2722:         %%
<a name="2723"/> 2723:         %% bind/2
<a name="2724"/> 2724:         {error, badarg} =
<a name="2725"/> 2725:             ?EXCEPTION(
<a name="2726"/> 2726:                socket:bind(should_be_socket, any) ),
<a name="2727"/> 2727:         {error, badarg} =
<a name="2728"/> 2728:             ?EXCEPTION(
<a name="2729"/> 2729:                socket:bind(make_ref(), any) ),
<a name="2730"/> 2730:         %%
<a name="2731"/> 2731:         %% A non-map, non-atom Addr causes an {invalid,_}
<a name="2732"/> 2732:         %% exception.  Should that instead be an error
<a name="2733"/> 2733:         %% return?
<a name="2734"/> 2734:         %%
<a name="2735"/> 2735:         {error,{invalid,{sockaddr,should_be_sockaddr}}} =
<a name="2736"/> 2736:             socket:bind(S, should_be_sockaddr),
<a name="2737"/> 2737:         EmptyMap = #{},
<a name="2738"/> 2738:         {error,{invalid,{sockaddr,family,EmptyMap}}} =
<a name="2739"/> 2739:             socket:bind(S, EmptyMap),
<a name="2740"/> 2740:         InvalidKey = #{family =&gt; inet, invalid_key =&gt; []},
<a name="2741"/> 2741:         {error,{invalid,{sockaddr,{keys,[invalid_key]},InvalidKey}}} =
<a name="2742"/> 2742:             socket:bind(S, InvalidKey),
<a name="2743"/> 2743:         InvalidFamily = #{family =&gt; invalid_family},
<a name="2744"/> 2744:         {error,{invalid,{sockaddr,InvalidFamily}}} =
<a name="2745"/> 2745:             socket:bind(S, InvalidFamily)
<a name="2746"/> 2746:     after
<a name="2747"/> 2747:         _ = socket:close(S)
<a name="2748"/> 2748:     end,
<a name="api_m_error_bind-last_expr"/><a name="2749"/> 2749:     ok.
<a name="2750"/> 2750: 
<a name="2751"/> 2751: 
<a name="2752"/> 2752: <i>%% XXX Lots of missing error tests here, for all other API functions...</i>
<a name="2753"/> 2753: 
<a name="2754"/> 2754: 
<a name="2755"/> 2755: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="2756"/> 2756: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="2757"/> 2757: <i>%%                                                                     %%</i>
<a name="2758"/> 2758: <i>%%                           API BASIC                                 %%</i>
<a name="2759"/> 2759: <i>%%                                                                     %%</i>
<a name="2760"/> 2760: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="2761"/> 2761: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="2762"/> 2762: 
<a name="2763"/> 2763: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="2764"/> 2764: 
<a name="2765"/> 2765: <i>%% Basically open (create) and then close.</i>
<a name="api_b_simple_open_and_close_udp4-1"/><a name="2766"/> 2766: <b>api_b_simple_open_and_close_udp4</b>(_Config) when is_list(_Config) -&gt;
<a name="2767"/> 2767:     ?TT(?SECS(5)),
<a name="api_b_simple_open_and_close_udp4-last_expr"/><a name="2768"/> 2768: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="2769"/> 2769:            fun() -&gt;
<a name="2770"/> 2770:                    InitState = #{domain   =&gt; inet,
<a name="2771"/> 2771:                                  type     =&gt; dgram,
<a name="2772"/> 2772:                                  protocol =&gt; udp},
<a name="2773"/> 2773:                    ok = api_b_simple_open_and_close(InitState)
<a name="2774"/> 2774:            end).
<a name="2775"/> 2775: 
<a name="2776"/> 2776: 
<a name="2777"/> 2777: 
<a name="2778"/> 2778: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="2779"/> 2779: 
<a name="2780"/> 2780: <i>%% Basically open (create) and then close.</i>
<a name="api_b_simple_open_and_close_udp6-1"/><a name="2781"/> 2781: <b>api_b_simple_open_and_close_udp6</b>(_Config) when is_list(_Config) -&gt;
<a name="2782"/> 2782:     ?TT(?SECS(5)),
<a name="api_b_simple_open_and_close_udp6-last_expr"/><a name="2783"/> 2783: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="2784"/> 2784:            fun() -&gt; has_support_ipv6() end,
<a name="2785"/> 2785:            fun() -&gt;
<a name="2786"/> 2786:                    InitState = #{domain   =&gt; inet6,
<a name="2787"/> 2787:                                  type     =&gt; dgram,
<a name="2788"/> 2788:                                  protocol =&gt; udp},
<a name="2789"/> 2789:                    ok = api_b_simple_open_and_close(InitState)
<a name="2790"/> 2790:            end).
<a name="2791"/> 2791: 
<a name="2792"/> 2792: 
<a name="2793"/> 2793: 
<a name="2794"/> 2794: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="2795"/> 2795: 
<a name="2796"/> 2796: <i>%% Basically open (create) and then close.</i>
<a name="api_b_simple_open_and_close_tcp4-1"/><a name="2797"/> 2797: <b>api_b_simple_open_and_close_tcp4</b>(_Config) when is_list(_Config) -&gt;
<a name="2798"/> 2798:     ?TT(?SECS(5)),
<a name="api_b_simple_open_and_close_tcp4-last_expr"/><a name="2799"/> 2799: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="2800"/> 2800:            fun() -&gt;
<a name="2801"/> 2801:                    InitState = #{domain   =&gt; inet,
<a name="2802"/> 2802:                                  type     =&gt; stream,
<a name="2803"/> 2803:                                  protocol =&gt; tcp},
<a name="2804"/> 2804:                    ok = api_b_simple_open_and_close(InitState)
<a name="2805"/> 2805:            end).
<a name="2806"/> 2806: 
<a name="2807"/> 2807: 
<a name="2808"/> 2808: 
<a name="2809"/> 2809: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="2810"/> 2810: 
<a name="2811"/> 2811: <i>%% Basically open (create) and then close.</i>
<a name="api_b_simple_open_and_close_tcp6-1"/><a name="2812"/> 2812: <b>api_b_simple_open_and_close_tcp6</b>(_Config) when is_list(_Config) -&gt;
<a name="2813"/> 2813:     ?TT(?SECS(5)),
<a name="api_b_simple_open_and_close_tcp6-last_expr"/><a name="2814"/> 2814: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="2815"/> 2815:            fun() -&gt; has_support_ipv6() end,
<a name="2816"/> 2816:            fun() -&gt;
<a name="2817"/> 2817:                    InitState = #{domain   =&gt; inet6,
<a name="2818"/> 2818:                                  type     =&gt; stream,
<a name="2819"/> 2819:                                  protocol =&gt; tcp},
<a name="2820"/> 2820:                    ok = api_b_simple_open_and_close(InitState)
<a name="2821"/> 2821:            end).
<a name="2822"/> 2822: 
<a name="2823"/> 2823: 
<a name="2824"/> 2824: 
<a name="2825"/> 2825: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="2826"/> 2826: 
<a name="api_b_simple_open_and_close-1"/><a name="2827"/> 2827: <b>api_b_simple_open_and_close</b>(InitState) -&gt;
<a name="2828"/> 2828:     Seq = 
<a name="2829"/> 2829:         [
<a name="2830"/> 2830:          #{desc =&gt; &quot;open&quot;,
<a name="2831"/> 2831:            cmd  =&gt; fun(#{domain   := Domain,
<a name="2832"/> 2832:                          type     := Type,
<a name="2833"/> 2833:                          protocol := Protocol} = State) -&gt; 
<a name="2834"/> 2834:                            case socket:open(Domain, Type, Protocol) of
<a name="2835"/> 2835:                                {ok, Sock} -&gt;
<a name="2836"/> 2836:                                    {ok, State#{sock =&gt; Sock}};
<a name="2837"/> 2837:                                {error, _} = ERROR -&gt;
<a name="2838"/> 2838:                                    ERROR
<a name="2839"/> 2839:                            end
<a name="2840"/> 2840:                    end},
<a name="2841"/> 2841: 
<a name="2842"/> 2842:          ?SEV_SLEEP(?SECS(1)),
<a name="2843"/> 2843: 
<a name="2844"/> 2844:          #{desc =&gt; &quot;close socket&quot;,
<a name="2845"/> 2845:            cmd  =&gt; fun(#{sock := Sock} = _State) -&gt;
<a name="2846"/> 2846:                            socket:close(Sock)
<a name="2847"/> 2847:                    end},
<a name="2848"/> 2848: 
<a name="2849"/> 2849:          %% *** We are done ***
<a name="2850"/> 2850:          ?SEV_FINISH_NORMAL
<a name="2851"/> 2851:         ],
<a name="2852"/> 2852:     Evaluator = ?SEV_START(&quot;tester&quot;, Seq, InitState),
<a name="api_b_simple_open_and_close-last_expr"/><a name="2853"/> 2853: <b>    ok = ?SEV_AWAIT_FINISH</b>([Evaluator]).
<a name="2854"/> 2854: 
<a name="2855"/> 2855: 
<a name="2856"/> 2856: 
<a name="2857"/> 2857: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="2858"/> 2858: 
<a name="2859"/> 2859: <i>%% Basically open (create) and info of an IPv4 UDP (dgram) socket.</i>
<a name="2860"/> 2860: <i>%% With some extra checks...</i>
<a name="api_b_open_and_info_udp4-1"/><a name="2861"/> 2861: <b>api_b_open_and_info_udp4</b>(_Config) when is_list(_Config) -&gt;
<a name="2862"/> 2862:     ?TT(?SECS(5)),
<a name="api_b_open_and_info_udp4-last_expr"/><a name="2863"/> 2863: <b>    tc_try</b>(api_b_open_and_info_udp4,
<a name="2864"/> 2864:            fun() -&gt;
<a name="2865"/> 2865:                    InitState = #{domain   =&gt; inet,
<a name="2866"/> 2866:                                  type     =&gt; dgram,
<a name="2867"/> 2867:                                  protocol =&gt; udp},
<a name="2868"/> 2868:                    ok = api_b_open_and_info(InitState)
<a name="2869"/> 2869:            end).
<a name="2870"/> 2870: 
<a name="2871"/> 2871: 
<a name="2872"/> 2872: 
<a name="2873"/> 2873: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="2874"/> 2874: 
<a name="2875"/> 2875: <i>%% Basically open (create) and info of an IPv6 UDP (dgram) socket.</i>
<a name="2876"/> 2876: <i>%% With some extra checks...</i>
<a name="api_b_open_and_info_udp6-1"/><a name="2877"/> 2877: <b>api_b_open_and_info_udp6</b>(_Config) when is_list(_Config) -&gt;
<a name="2878"/> 2878:     ?TT(?SECS(5)),
<a name="api_b_open_and_info_udp6-last_expr"/><a name="2879"/> 2879: <b>    tc_try</b>(api_b_open_and_info_udp6,
<a name="2880"/> 2880:            fun() -&gt; has_support_ipv6() end,
<a name="2881"/> 2881:            fun() -&gt;
<a name="2882"/> 2882:                    InitState = #{domain   =&gt; inet6,
<a name="2883"/> 2883:                                  type     =&gt; dgram,
<a name="2884"/> 2884:                                  protocol =&gt; udp},
<a name="2885"/> 2885:                    ok = api_b_open_and_info(InitState)
<a name="2886"/> 2886:            end).
<a name="2887"/> 2887: 
<a name="2888"/> 2888: 
<a name="2889"/> 2889: 
<a name="2890"/> 2890: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="2891"/> 2891: 
<a name="2892"/> 2892: <i>%% Basically open (create) and info of an IPv4 TCP (stream) socket.</i>
<a name="2893"/> 2893: <i>%% With some extra checks...</i>
<a name="api_b_open_and_info_tcp4-1"/><a name="2894"/> 2894: <b>api_b_open_and_info_tcp4</b>(_Config) when is_list(_Config) -&gt;
<a name="2895"/> 2895:     ?TT(?SECS(5)),
<a name="api_b_open_and_info_tcp4-last_expr"/><a name="2896"/> 2896: <b>    tc_try</b>(api_b_open_and_info_tcp4,
<a name="2897"/> 2897:            fun() -&gt;
<a name="2898"/> 2898:                    InitState = #{domain   =&gt; inet,
<a name="2899"/> 2899:                                  type     =&gt; stream,
<a name="2900"/> 2900:                                  protocol =&gt; tcp},
<a name="2901"/> 2901:                    ok = api_b_open_and_info(InitState)
<a name="2902"/> 2902:            end).
<a name="2903"/> 2903: 
<a name="2904"/> 2904: 
<a name="2905"/> 2905: 
<a name="2906"/> 2906: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="2907"/> 2907: 
<a name="2908"/> 2908: <i>%% Basically open (create) and info of an IPv6 TCP (stream) socket.</i>
<a name="2909"/> 2909: <i>%% With some extra checks...</i>
<a name="api_b_open_and_info_tcp6-1"/><a name="2910"/> 2910: <b>api_b_open_and_info_tcp6</b>(_Config) when is_list(_Config) -&gt;
<a name="2911"/> 2911:     ?TT(?SECS(5)),
<a name="api_b_open_and_info_tcp6-last_expr"/><a name="2912"/> 2912: <b>    tc_try</b>(api_b_open_and_info_tcp6,
<a name="2913"/> 2913:            fun() -&gt; has_support_ipv6() end,
<a name="2914"/> 2914:            fun() -&gt;
<a name="2915"/> 2915:                    InitState = #{domain   =&gt; inet6,
<a name="2916"/> 2916:                                  type     =&gt; stream,
<a name="2917"/> 2917:                                  protocol =&gt; tcp},
<a name="2918"/> 2918:                    ok = api_b_open_and_info(InitState)
<a name="2919"/> 2919:            end).
<a name="2920"/> 2920: 
<a name="2921"/> 2921: 
<a name="2922"/> 2922: 
<a name="2923"/> 2923: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="2924"/> 2924: 
<a name="api_b_open_and_info-1"/><a name="2925"/> 2925: <b>api_b_open_and_info</b>(InitState) -&gt;
<a name="2926"/> 2926:     Seq = 
<a name="2927"/> 2927:         [
<a name="2928"/> 2928:          #{desc =&gt; &quot;open&quot;,
<a name="2929"/> 2929:            cmd  =&gt; fun(#{domain   := Domain,
<a name="2930"/> 2930:                          type     := Type,
<a name="2931"/> 2931:                          protocol := Protocol} = State) -&gt; 
<a name="2932"/> 2932:                            case socket:open(Domain, Type, Protocol) of
<a name="2933"/> 2933:                                {ok, Sock} -&gt;
<a name="2934"/> 2934:                                    {ok, State#{sock =&gt; Sock}};
<a name="2935"/> 2935:                                {error, _} = ERROR -&gt;
<a name="2936"/> 2936:                                    ERROR
<a name="2937"/> 2937:                            end
<a name="2938"/> 2938:                    end},
<a name="2939"/> 2939:          #{desc =&gt; &quot;get socket info&quot;,
<a name="2940"/> 2940:            cmd  =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="2941"/> 2941:                            Info = socket:info(Sock),
<a name="2942"/> 2942:                            ?SEV_IPRINT(&quot;Got (some) Info: &quot;
<a name="2943"/> 2943:                                        &quot;~n   ~p&quot;, [Info]),
<a name="2944"/> 2944:                            {ok, State#{info =&gt; Info}}
<a name="2945"/> 2945:                    end},
<a name="2946"/> 2946:          #{desc =&gt; &quot;validate socket info&quot;,
<a name="2947"/> 2947:            cmd  =&gt; fun(#{domain   := Domain,
<a name="2948"/> 2948:                          type     := Type,
<a name="2949"/> 2949:                          protocol := Protocol,
<a name="2950"/> 2950:                          info     := #{domain        := Domain,
<a name="2951"/> 2951:                                        type          := Type,
<a name="2952"/> 2952:                                        protocol      := Protocol,
<a name="2953"/> 2953:                                        counters      := _,
<a name="2954"/> 2954:                                        num_readers   := 0,
<a name="2955"/> 2955:                                        num_writers   := 0,
<a name="2956"/> 2956:                                        num_acceptors := 0}}) -&gt;
<a name="2957"/> 2957:                            ok;
<a name="2958"/> 2958:                       (#{domain   := Domain,
<a name="2959"/> 2959:                          type     := Type,
<a name="2960"/> 2960:                          protocol := Protocol,
<a name="2961"/> 2961:                          info     := Info}) -&gt;
<a name="2962"/> 2962:                            ?SEV_EPRINT(&quot;Unexpected Info: &quot;
<a name="2963"/> 2963:                                        &quot;~n   (expected) Domain:   ~p&quot;
<a name="2964"/> 2964:                                        &quot;~n   (expected) Type:     ~p&quot;
<a name="2965"/> 2965:                                        &quot;~n   (expected) Protocol: ~p&quot;
<a name="2966"/> 2966:                                        &quot;~n   ~p&quot;,
<a name="2967"/> 2967:                                        [Domain, Type, Protocol, Info]),
<a name="2968"/> 2968:                            {error, unexpected_infio}
<a name="2969"/> 2969:                    end},
<a name="2970"/> 2970:          #{desc =&gt; &quot;close socket&quot;,
<a name="2971"/> 2971:            cmd  =&gt; fun(#{sock := Sock} = _State) -&gt;
<a name="2972"/> 2972:                            socket:close(Sock)
<a name="2973"/> 2973:                    end},
<a name="2974"/> 2974: 
<a name="2975"/> 2975:          %% *** We are done ***
<a name="2976"/> 2976:          ?SEV_FINISH_NORMAL
<a name="2977"/> 2977:         ],
<a name="2978"/> 2978:     Evaluator = ?SEV_START(&quot;tester&quot;, Seq, InitState),
<a name="api_b_open_and_info-last_expr"/><a name="2979"/> 2979: <b>    ok = ?SEV_AWAIT_FINISH</b>([Evaluator]).
<a name="2980"/> 2980: 
<a name="2981"/> 2981: 
<a name="2982"/> 2982: 
<a name="2983"/> 2983: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="2984"/> 2984: 
<a name="2985"/> 2985: <i>%% Basically open (create) and close an IPv4 UDP (dgram) socket.</i>
<a name="2986"/> 2986: <i>%% With some extra checks...</i>
<a name="api_b_open_and_close_udp4-1"/><a name="2987"/> 2987: <b>api_b_open_and_close_udp4</b>(_Config) when is_list(_Config) -&gt;
<a name="2988"/> 2988:     ?TT(?SECS(5)),
<a name="api_b_open_and_close_udp4-last_expr"/><a name="2989"/> 2989: <b>    tc_try</b>(api_b_open_and_close_udp4,
<a name="2990"/> 2990:            fun() -&gt;
<a name="2991"/> 2991:                    InitState = #{domain   =&gt; inet,
<a name="2992"/> 2992:                                  type     =&gt; dgram,
<a name="2993"/> 2993:                                  protocol =&gt; udp},
<a name="2994"/> 2994:                    ok = api_b_open_and_close(InitState)
<a name="2995"/> 2995:            end).
<a name="2996"/> 2996: 
<a name="2997"/> 2997: 
<a name="2998"/> 2998: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="2999"/> 2999: 
<a name="3000"/> 3000: <i>%% Basically open (create) and close an IPv6 UDP (dgram) socket.</i>
<a name="3001"/> 3001: <i>%% With some extra checks...</i>
<a name="api_b_open_and_close_udp6-1"/><a name="3002"/> 3002: <b>api_b_open_and_close_udp6</b>(_Config) when is_list(_Config) -&gt;
<a name="3003"/> 3003:     ?TT(?SECS(5)),
<a name="api_b_open_and_close_udp6-last_expr"/><a name="3004"/> 3004: <b>    tc_try</b>(api_b_open_and_close_udp6,
<a name="3005"/> 3005:            fun() -&gt; has_support_ipv6() end,
<a name="3006"/> 3006:            fun() -&gt;
<a name="3007"/> 3007:                    InitState = #{domain   =&gt; inet6,
<a name="3008"/> 3008:                                  type     =&gt; dgram,
<a name="3009"/> 3009:                                  protocol =&gt; udp},
<a name="3010"/> 3010:                    ok = api_b_open_and_close(InitState)
<a name="3011"/> 3011:            end).
<a name="3012"/> 3012: 
<a name="3013"/> 3013: 
<a name="3014"/> 3014: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="3015"/> 3015: 
<a name="3016"/> 3016: <i>%% Basically open (create) and close an IPv4 TCP (stream) socket.</i>
<a name="3017"/> 3017: <i>%% With some extra checks...</i>
<a name="api_b_open_and_close_tcp4-1"/><a name="3018"/> 3018: <b>api_b_open_and_close_tcp4</b>(_Config) when is_list(_Config) -&gt;
<a name="3019"/> 3019:     ?TT(?SECS(5)),
<a name="api_b_open_and_close_tcp4-last_expr"/><a name="3020"/> 3020: <b>    tc_try</b>(api_b_open_and_close_tcp4,
<a name="3021"/> 3021:            fun() -&gt;
<a name="3022"/> 3022:                    InitState = #{domain   =&gt; inet,
<a name="3023"/> 3023:                                  type     =&gt; stream,
<a name="3024"/> 3024:                                  protocol =&gt; tcp},
<a name="3025"/> 3025:                    ok = api_b_open_and_close(InitState)
<a name="3026"/> 3026:            end).
<a name="3027"/> 3027: 
<a name="3028"/> 3028: 
<a name="3029"/> 3029: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="3030"/> 3030: 
<a name="3031"/> 3031: <i>%% Basically open (create) and close an IPv6 TCP (stream) socket.</i>
<a name="3032"/> 3032: <i>%% With some extra checks...</i>
<a name="api_b_open_and_close_tcp6-1"/><a name="3033"/> 3033: <b>api_b_open_and_close_tcp6</b>(_Config) when is_list(_Config) -&gt;
<a name="3034"/> 3034:     ?TT(?SECS(5)),
<a name="api_b_open_and_close_tcp6-last_expr"/><a name="3035"/> 3035: <b>    tc_try</b>(api_b_open_and_close_tcp6,
<a name="3036"/> 3036:            fun() -&gt; has_support_ipv6() end,
<a name="3037"/> 3037:            fun() -&gt;
<a name="3038"/> 3038:                    InitState = #{domain   =&gt; inet,
<a name="3039"/> 3039:                                  type     =&gt; stream,
<a name="3040"/> 3040:                                  protocol =&gt; tcp},
<a name="3041"/> 3041:                    ok = api_b_open_and_close(InitState)
<a name="3042"/> 3042:            end).
<a name="3043"/> 3043: 
<a name="3044"/> 3044: 
<a name="3045"/> 3045: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="3046"/> 3046: 
<a name="3047"/> 3047: <i>%% Basically open (create) and close an Unix Domain dgram (UDP) socket.</i>
<a name="3048"/> 3048: <i>%% With some extra checks...</i>
<a name="api_b_open_and_close_udpL-1"/><a name="3049"/> 3049: <b>api_b_open_and_close_udpL</b>(_Config) when is_list(_Config) -&gt;
<a name="3050"/> 3050:     ?TT(?SECS(5)),
<a name="api_b_open_and_close_udpL-last_expr"/><a name="3051"/> 3051: <b>    tc_try</b>(api_b_open_and_close_udpL,
<a name="3052"/> 3052:            fun() -&gt;
<a name="3053"/> 3053: 		   has_support_unix_domain_socket(),
<a name="3054"/> 3054: 		   is_not_windows()
<a name="3055"/> 3055: 	   end,
<a name="3056"/> 3056:            fun() -&gt;
<a name="3057"/> 3057:                    InitState = #{domain   =&gt; local,
<a name="3058"/> 3058:                                  type     =&gt; dgram,
<a name="3059"/> 3059:                                  protocol =&gt; default},
<a name="3060"/> 3060:                    ok = api_b_open_and_close(InitState)
<a name="3061"/> 3061:            end).
<a name="3062"/> 3062: 
<a name="3063"/> 3063: 
<a name="3064"/> 3064: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="3065"/> 3065: 
<a name="3066"/> 3066: <i>%% Basically open (create) and close an Unix Domain stream (TCP) socket.</i>
<a name="3067"/> 3067: <i>%% With some extra checks...</i>
<a name="api_b_open_and_close_tcpL-1"/><a name="3068"/> 3068: <b>api_b_open_and_close_tcpL</b>(_Config) when is_list(_Config) -&gt;
<a name="3069"/> 3069:     ?TT(?SECS(5)),
<a name="api_b_open_and_close_tcpL-last_expr"/><a name="3070"/> 3070: <b>    tc_try</b>(api_b_open_and_close_tcpL,
<a name="3071"/> 3071:            fun() -&gt; has_support_unix_domain_socket() end,
<a name="3072"/> 3072:            fun() -&gt;
<a name="3073"/> 3073:                    InitState = #{domain   =&gt; local,
<a name="3074"/> 3074:                                  type     =&gt; stream,
<a name="3075"/> 3075:                                  protocol =&gt; default},
<a name="3076"/> 3076:                    ok = api_b_open_and_close(InitState)
<a name="3077"/> 3077:            end).
<a name="3078"/> 3078: 
<a name="3079"/> 3079: 
<a name="3080"/> 3080: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="3081"/> 3081: 
<a name="3082"/> 3082: <i>%% Basically open (create) and close an Unix Domain dgram (UDP) socket.</i>
<a name="3083"/> 3083: <i>%% With some extra checks...</i>
<a name="api_b_open_and_close_seqpL-1"/><a name="3084"/> 3084: <b>api_b_open_and_close_seqpL</b>(_Config) when is_list(_Config) -&gt;
<a name="3085"/> 3085:     ?TT(?SECS(5)),
<a name="api_b_open_and_close_seqpL-last_expr"/><a name="3086"/> 3086: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="3087"/> 3087:            fun() -&gt;
<a name="3088"/> 3088: 		   has_support_unix_domain_socket(),
<a name="3089"/> 3089:                    is_not_windows()
<a name="3090"/> 3090: 	   end,
<a name="3091"/> 3091:            fun() -&gt;
<a name="3092"/> 3092:                    InitState = #{domain   =&gt; local,
<a name="3093"/> 3093:                                  type     =&gt; seqpacket,
<a name="3094"/> 3094:                                  protocol =&gt; default},
<a name="3095"/> 3095:                    ok = api_b_open_and_close(InitState)
<a name="3096"/> 3096:            end).
<a name="3097"/> 3097: 
<a name="3098"/> 3098: 
<a name="3099"/> 3099: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="3100"/> 3100: 
<a name="3101"/> 3101: <i>%% Basically open (create) and close an IPv4 SCTP (seqpacket) socket.</i>
<a name="3102"/> 3102: <i>%% With some extra checks...</i>
<a name="api_b_open_and_close_sctp4-1"/><a name="3103"/> 3103: <b>api_b_open_and_close_sctp4</b>(_Config) when is_list(_Config) -&gt;
<a name="3104"/> 3104:     ?TT(?SECS(5)),
<a name="api_b_open_and_close_sctp4-last_expr"/><a name="3105"/> 3105: <b>    tc_try</b>(api_b_open_and_close_sctp4,
<a name="3106"/> 3106:            fun() -&gt; has_support_sctp() end,
<a name="3107"/> 3107:            fun() -&gt;
<a name="3108"/> 3108:                    InitState = #{domain   =&gt; inet,
<a name="3109"/> 3109:                                  type     =&gt; seqpacket,
<a name="3110"/> 3110:                                  protocol =&gt; sctp},
<a name="3111"/> 3111:                    ok = api_b_open_and_close(InitState)
<a name="3112"/> 3112:            end).
<a name="3113"/> 3113: 
<a name="3114"/> 3114: 
<a name="3115"/> 3115: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="3116"/> 3116: 
<a name="api_b_open_and_close-1"/><a name="3117"/> 3117: <b>api_b_open_and_close</b>(InitState) -&gt;
<a name="3118"/> 3118:     Seq = 
<a name="3119"/> 3119:         [
<a name="3120"/> 3120:          #{desc =&gt; &quot;open&quot;,
<a name="3121"/> 3121:            cmd  =&gt; fun(#{domain   := Domain,
<a name="3122"/> 3122:                          type     := Type,
<a name="3123"/> 3123:                          protocol := Protocol} = S) -&gt; 
<a name="3124"/> 3124:                            Res = socket:open(Domain, Type, Protocol), 
<a name="3125"/> 3125:                            {ok, {S, Res}} 
<a name="3126"/> 3126:                    end},
<a name="3127"/> 3127:          #{desc =&gt; &quot;validate open&quot;,
<a name="3128"/> 3128:            cmd  =&gt; fun({S, {ok, Sock}}) -&gt; 
<a name="3129"/> 3129:                            NewS = S#{socket =&gt; Sock},
<a name="3130"/> 3130:                            {ok, NewS};
<a name="3131"/> 3131:                       ({_, {error, epfnosupport = Reason}}) -&gt;
<a name="3132"/> 3132:                            {skip, Reason};
<a name="3133"/> 3133:                       ({_, {error, eprotonosupport = Reason}}) -&gt;
<a name="3134"/> 3134:                            {skip, Reason};
<a name="3135"/> 3135:                       ({_, {error, esocktnosupport = Reason}}) -&gt;
<a name="3136"/> 3136:                            {skip, Reason};
<a name="3137"/> 3137:                       ({_, {error, _} = ERROR}) -&gt;
<a name="3138"/> 3138:                            ERROR
<a name="3139"/> 3139:                    end},
<a name="3140"/> 3140:          #{desc =&gt; &quot;get domain (maybe)&quot;,
<a name="3141"/> 3141:            cmd  =&gt; fun(#{socket := Sock} = S) -&gt;
<a name="3142"/> 3142:                            Res = socket:getopt(Sock, socket, domain),
<a name="3143"/> 3143:                            {ok, {S, Res}}
<a name="3144"/> 3144:                    end},
<a name="3145"/> 3145:          #{desc =&gt; &quot;validate domain (maybe)&quot;,
<a name="3146"/> 3146:            cmd  =&gt; fun({#{domain := Domain} = S, {ok, Domain}}) -&gt; 
<a name="3147"/> 3147:                            {ok, S};
<a name="3148"/> 3148:                       ({#{domain := ExpDomain}, {ok, Domain}}) -&gt;
<a name="3149"/> 3149:                            {error, {unexpected_domain, ExpDomain, Domain}};
<a name="3150"/> 3150:                       %% Some platforms do not support this option
<a name="3151"/> 3151:                       ({S, {error, {invalid, _}} = ERROR}) -&gt;
<a name="3152"/> 3152:                            case
<a name="3153"/> 3153:                                socket:is_supported(options, socket, domain)
<a name="3154"/> 3154:                            of
<a name="3155"/> 3155:                                true -&gt;
<a name="3156"/> 3156:                                    ERROR;
<a name="3157"/> 3157:                                false -&gt;
<a name="3158"/> 3158:                                    ?SEV_IPRINT(&quot;socket option 'domain' &quot;
<a name="3159"/> 3159:                                                &quot;not supported&quot;),
<a name="3160"/> 3160:                                    {ok, S}
<a name="3161"/> 3161:                            end;
<a name="3162"/> 3162:                       ({_, {error, _} = ERROR}) -&gt;
<a name="3163"/> 3163:                            ERROR
<a name="3164"/> 3164:                    end},
<a name="3165"/> 3165:          #{desc =&gt; &quot;get type&quot;,
<a name="3166"/> 3166:            cmd  =&gt; fun(#{socket := Sock} = State) -&gt;
<a name="3167"/> 3167:                            Res = socket:getopt(Sock, socket, type), 
<a name="3168"/> 3168:                            {ok, {State, Res}}
<a name="3169"/> 3169:                    end},
<a name="3170"/> 3170:          #{desc =&gt; &quot;validate type&quot;,
<a name="3171"/> 3171:            cmd  =&gt; fun({#{type := Type} = State, {ok, Type}}) -&gt;
<a name="3172"/> 3172:                            {ok, State};
<a name="3173"/> 3173:                       ({#{type := ExpType}, {ok, Type}}) -&gt;
<a name="3174"/> 3174:                            {error, {unexpected_type, ExpType, Type}};
<a name="3175"/> 3175:                       ({_, {error, _} = ERROR}) -&gt;
<a name="3176"/> 3176:                            ERROR
<a name="3177"/> 3177:                    end},
<a name="3178"/> 3178:          #{desc =&gt; &quot;get protocol (maybe)&quot;,
<a name="3179"/> 3179:            cmd  =&gt; fun(#{socket := Sock} = State) -&gt;
<a name="3180"/> 3180:                            Res = socket:getopt(Sock, socket, protocol),
<a name="3181"/> 3181:                            {ok, {State, Res}}
<a name="3182"/> 3182:                    end},
<a name="3183"/> 3183:          #{desc =&gt; &quot;validate protocol&quot;,
<a name="3184"/> 3184:            cmd  =&gt; fun({#{protocol := Protocol} = State, {ok, Protocol}}) -&gt;
<a name="3185"/> 3185:                            {ok, State};
<a name="3186"/> 3186:                       ({#{domain   := Domain,
<a name="3187"/> 3187: 			  protocol := ExpProtocol}, {ok, Protocol}}) -&gt;
<a name="3188"/> 3188: 			   %% On OpenBSD (at least 6.6) something screwy happens
<a name="3189"/> 3189: 			   %% when domain = local.
<a name="3190"/> 3190: 			   %% It will report a completely different protocol (icmp)
<a name="3191"/> 3191: 			   %% but everything still works. So we skip if this happens
<a name="3192"/> 3192: 			   %% on OpenBSD...
<a name="3193"/> 3193: 			   case os:type() of
<a name="3194"/> 3194: 			       {unix, openbsd} when (Domain =:= local) -&gt;
<a name="3195"/> 3195: 				   {skip, ?F(&quot;Unexpected protocol: ~p instead of ~p&quot;,
<a name="3196"/> 3196: 					     [Protocol, ExpProtocol])};
<a name="3197"/> 3197: 			       _ -&gt;
<a name="3198"/> 3198: 				   {error, {unexpected_protocol,
<a name="3199"/> 3199: 					    ExpProtocol, Protocol}}
<a name="3200"/> 3200: 			   end;
<a name="3201"/> 3201:                       %% Some platforms do not support this option
<a name="3202"/> 3202:                       ({State, {error, {invalid, _}} = ERROR}) -&gt;
<a name="3203"/> 3203: 			   case socket:is_supported(options, socket, protocol) of
<a name="3204"/> 3204: 			       true -&gt;
<a name="3205"/> 3205:                                    ERROR;
<a name="3206"/> 3206: 			       false -&gt;
<a name="3207"/> 3207:                                    ?SEV_IPRINT(&quot;socket option 'protocol' &quot;
<a name="3208"/> 3208:                                                &quot;not supported&quot;),
<a name="3209"/> 3209:                                    {ok, State}
<a name="3210"/> 3210: 			   end;
<a name="3211"/> 3211:                       ({_, {error, _} = ERROR}) -&gt;
<a name="3212"/> 3212:                            ERROR
<a name="3213"/> 3213:                    end},
<a name="3214"/> 3214:          #{desc =&gt; &quot;get controlling-process&quot;,
<a name="3215"/> 3215:            cmd  =&gt; fun(#{socket := Sock} = State) -&gt;
<a name="3216"/> 3216:                            Res = socket:getopt(Sock, otp, controlling_process),
<a name="3217"/> 3217:                            {ok, {State, Res}}
<a name="3218"/> 3218:                    end},
<a name="3219"/> 3219:          #{desc =&gt; &quot;validate controlling-process&quot;,
<a name="3220"/> 3220:            cmd  =&gt; fun({State, {ok, Pid}}) -&gt;
<a name="3221"/> 3221:                            case self() of
<a name="3222"/> 3222:                                Pid -&gt;
<a name="3223"/> 3223:                                    {ok, State};
<a name="3224"/> 3224:                                _ -&gt;
<a name="3225"/> 3225:                                    {error, {unexpected_owner, Pid}}
<a name="3226"/> 3226:                            end;
<a name="3227"/> 3227:                       ({_, {error, _} = ERROR}) -&gt;
<a name="3228"/> 3228:                            ERROR
<a name="3229"/> 3229:                    end},
<a name="3230"/> 3230:          #{desc =&gt; &quot;close socket&quot;,
<a name="3231"/> 3231:            cmd  =&gt; fun(#{socket := Sock} = State) -&gt;
<a name="3232"/> 3232:                            Res = socket:close(Sock),
<a name="3233"/> 3233:                            {ok, {State, Res}}
<a name="3234"/> 3234:                    end},
<a name="3235"/> 3235:          #{desc =&gt; &quot;validate socket close&quot;,
<a name="3236"/> 3236:            cmd  =&gt; fun({_, ok}) -&gt;
<a name="3237"/> 3237:                            ok;
<a name="3238"/> 3238:                       ({_, {error, _} = ERROR}) -&gt;
<a name="3239"/> 3239:                            ERROR
<a name="3240"/> 3240:                    end},
<a name="3241"/> 3241: 
<a name="3242"/> 3242:          %% *** We are done ***
<a name="3243"/> 3243:          ?SEV_FINISH_NORMAL
<a name="3244"/> 3244:         ],
<a name="3245"/> 3245:     Evaluator = ?SEV_START(&quot;tester&quot;, Seq, InitState),
<a name="api_b_open_and_close-last_expr"/><a name="3246"/> 3246: <b>    ok = ?SEV_AWAIT_FINISH</b>([Evaluator]).
<a name="3247"/> 3247: 
<a name="3248"/> 3248: 
<a name="3249"/> 3249: 
<a name="3250"/> 3250: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="3251"/> 3251: 
<a name="3252"/> 3252: <i>%% Basically open (create) and (maybe) close an RAW socket.</i>
<a name="3253"/> 3253: 
<a name="api_b_open_and_maybe_close_raw-1"/><a name="3254"/> 3254: <b>api_b_open_and_maybe_close_raw</b>(_Config) when is_list(_Config) -&gt;
<a name="3255"/> 3255:     ?TT(?SECS(5)),
<a name="api_b_open_and_maybe_close_raw-last_expr"/><a name="3256"/> 3256: <b>    tc_try</b>(api_b_open_and_maybe_close_raw,
<a name="3257"/> 3257:            fun() -&gt;
<a name="3258"/> 3258:                    InitState = #{domain   =&gt; inet,
<a name="3259"/> 3259:                                  type     =&gt; raw,
<a name="3260"/> 3260:                                  protocol =&gt; {raw, 255}},
<a name="3261"/> 3261:                    ok = do_api_b_open_and_maybe_close_raw(InitState)
<a name="3262"/> 3262:            end).
<a name="3263"/> 3263: 
<a name="do_api_b_open_and_maybe_close_raw-1"/><a name="3264"/> 3264: <b>do_api_b_open_and_maybe_close_raw</b>(InitState) -&gt;
<a name="3265"/> 3265:     Tester = 
<a name="3266"/> 3266:         [
<a name="3267"/> 3267:          #{desc =&gt; &quot;open&quot;,
<a name="3268"/> 3268:            cmd  =&gt; fun(#{domain   := Domain,
<a name="3269"/> 3269:                          type     := Type,
<a name="3270"/> 3270:                          protocol := Protocol} = State) -&gt; 
<a name="3271"/> 3271:                            ?SEV_IPRINT(&quot;try open with:&quot;
<a name="3272"/> 3272:                                        &quot;~n   Domain:   ~p&quot;
<a name="3273"/> 3273:                                        &quot;~n   Type:     ~p&quot;
<a name="3274"/> 3274:                                        &quot;~n   Protocol: ~p&quot;,
<a name="3275"/> 3275:                                        [Domain, Type, Protocol]),
<a name="3276"/> 3276:                            case socket:open(Domain, Type, Protocol) of
<a name="3277"/> 3277:                                {ok, Sock} -&gt;
<a name="3278"/> 3278:                                    {ok, State#{sock =&gt; Sock}};
<a name="3279"/> 3279:                                {error, Reason} when (Reason =:= eperm) orelse
<a name="3280"/> 3280:                                                     (Reason =:= eacces) -&gt;
<a name="3281"/> 3281:                                    ?SEV_IPRINT(&quot;not allowed (~w) =&gt; SKIP&quot;,
<a name="3282"/> 3282:                                                [Reason]),
<a name="3283"/> 3283:                                    {skip, Reason};
<a name="3284"/> 3284:                                {error, Reason} = ERROR -&gt;
<a name="3285"/> 3285:                                    ?SEV_EPRINT(&quot;open failed:&quot;
<a name="3286"/> 3286:                                                &quot;~n   Reason: ~p&quot;, [Reason]),
<a name="3287"/> 3287:                                    ERROR
<a name="3288"/> 3288:                            end
<a name="3289"/> 3289:                    end},
<a name="3290"/> 3290:          #{desc =&gt; &quot;close socket&quot;,
<a name="3291"/> 3291:            cmd  =&gt; fun(#{socket := Sock} = State) -&gt;
<a name="3292"/> 3292:                            ?SEV_IPRINT(&quot;try socket close&quot;),
<a name="3293"/> 3293:                            case socket:close(Sock) of
<a name="3294"/> 3294:                                ok -&gt;
<a name="3295"/> 3295:                                    ?SEV_IPRINT(&quot;socket closed&quot;),
<a name="3296"/> 3296:                                    {ok, maps:remote(sock, State)};
<a name="3297"/> 3297:                                {error, Reason} = ERROR -&gt;
<a name="3298"/> 3298:                                    ?SEV_EPRINT(&quot;close failed:&quot;
<a name="3299"/> 3299:                                                &quot;~n   Reason: ~p&quot;, [Reason]),
<a name="3300"/> 3300:                                    ERROR
<a name="3301"/> 3301:                            end
<a name="3302"/> 3302:                    end},
<a name="3303"/> 3303: 
<a name="3304"/> 3304:          %% *** We are done ***
<a name="3305"/> 3305:          ?SEV_FINISH_NORMAL
<a name="3306"/> 3306:         ],
<a name="3307"/> 3307:     Evaluator = ?SEV_START(&quot;tester&quot;, Tester, InitState),
<a name="do_api_b_open_and_maybe_close_raw-last_expr"/><a name="3308"/> 3308: <b>    ok = ?SEV_AWAIT_FINISH</b>([Evaluator]).
<a name="3309"/> 3309: 
<a name="3310"/> 3310: 
<a name="3311"/> 3311: 
<a name="3312"/> 3312: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="3313"/> 3313: 
<a name="3314"/> 3314: <i>%% Basically send and receive on an IPv4 UDP (dgram) socket using</i>
<a name="3315"/> 3315: <i>%% sendto and recvfrom..</i>
<a name="api_b_sendto_and_recvfrom_udp4-1"/><a name="3316"/> 3316: <b>api_b_sendto_and_recvfrom_udp4</b>(_Config) when is_list(_Config) -&gt;
<a name="3317"/> 3317:     ?TT(?SECS(5)),
<a name="api_b_sendto_and_recvfrom_udp4-last_expr"/><a name="3318"/> 3318: <b>    tc_try</b>(api_b_sendto_and_recvfrom_udp4,
<a name="3319"/> 3319:            fun() -&gt; has_support_ipv4() end,
<a name="3320"/> 3320:            fun() -&gt;
<a name="3321"/> 3321:                    Send = fun(Sock, Data, Dest) -&gt;
<a name="3322"/> 3322:                                   socket:sendto(Sock, Data, Dest)
<a name="3323"/> 3323:                           end,
<a name="3324"/> 3324:                    Recv = fun(Sock) -&gt;
<a name="3325"/> 3325:                                   socket:recvfrom(Sock)
<a name="3326"/> 3326:                           end,
<a name="3327"/> 3327:                    InitState = #{domain =&gt; inet,
<a name="3328"/> 3328:                                  proto  =&gt; udp,
<a name="3329"/> 3329:                                  send   =&gt; Send,
<a name="3330"/> 3330:                                  recv   =&gt; Recv},
<a name="3331"/> 3331:                    ok = api_b_send_and_recv_udp(InitState)
<a name="3332"/> 3332:            end).
<a name="3333"/> 3333: 
<a name="3334"/> 3334: 
<a name="3335"/> 3335: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="3336"/> 3336: 
<a name="3337"/> 3337: <i>%% Basically send and receive on an IPv4 UDP (dgram) socket using</i>
<a name="3338"/> 3338: <i>%% sendto and recvfrom.</i>
<a name="api_b_sendto_and_recvfrom_udpL-1"/><a name="3339"/> 3339: <b>api_b_sendto_and_recvfrom_udpL</b>(_Config) when is_list(_Config) -&gt;
<a name="3340"/> 3340:     ?TT(?SECS(5)),
<a name="api_b_sendto_and_recvfrom_udpL-last_expr"/><a name="3341"/> 3341: <b>    tc_try</b>(api_b_sendto_and_recvfrom_udpL,
<a name="3342"/> 3342:            fun() -&gt;
<a name="3343"/> 3343:                    has_support_unix_domain_socket(),
<a name="3344"/> 3344: 		   is_not_windows(),
<a name="3345"/> 3345:                    unix_domain_socket_host_cond()
<a name="3346"/> 3346:            end,
<a name="3347"/> 3347:            fun() -&gt;
<a name="3348"/> 3348:                    Send = fun(Sock, Data, Dest) -&gt;
<a name="3349"/> 3349:                                   socket:sendto(Sock, Data, Dest)
<a name="3350"/> 3350:                           end,
<a name="3351"/> 3351:                    Recv = fun(Sock) -&gt;
<a name="3352"/> 3352:                                   socket:recvfrom(Sock)
<a name="3353"/> 3353:                           end,
<a name="3354"/> 3354:                    InitState = #{domain =&gt; local,
<a name="3355"/> 3355:                                  proto  =&gt; default,
<a name="3356"/> 3356:                                  send   =&gt; Send,
<a name="3357"/> 3357:                                  recv   =&gt; Recv},
<a name="3358"/> 3358:                    ok = api_b_send_and_recv_udp(InitState)
<a name="3359"/> 3359:            end).
<a name="3360"/> 3360: 
<a name="3361"/> 3361: 
<a name="3362"/> 3362: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="3363"/> 3363: 
<a name="3364"/> 3364: <i>%% Basically send and receive on an IPv4 UDP (dgram) socket</i>
<a name="3365"/> 3365: <i>%% using sendmsg and recvmsg.</i>
<a name="api_b_sendmsg_and_recvmsg_udp4-1"/><a name="3366"/> 3366: <b>api_b_sendmsg_and_recvmsg_udp4</b>(_Config) when is_list(_Config) -&gt;
<a name="3367"/> 3367:     ?TT(?SECS(5)),
<a name="api_b_sendmsg_and_recvmsg_udp4-last_expr"/><a name="3368"/> 3368: <b>    tc_try</b>(api_b_sendmsg_and_recvmsg_udp4,
<a name="3369"/> 3369:            fun() -&gt; has_support_ipv4() end,
<a name="3370"/> 3370:            fun() -&gt;
<a name="3371"/> 3371:                    Send = fun(Sock, Data, Dest) -&gt;
<a name="3372"/> 3372:                                   %% We need tests for this,
<a name="3373"/> 3373:                                   %% but this is not the place it.
<a name="3374"/> 3374:                                   %% CMsg  = #{level =&gt; ip,
<a name="3375"/> 3375:                                   %%              type  =&gt; tos,
<a name="3376"/> 3376:                                   %%              data  =&gt; reliability},
<a name="3377"/> 3377:                                   %% CMsgs = [CMsg],
<a name="3378"/> 3378:                                   Msg = #{addr =&gt; Dest,
<a name="3379"/> 3379:                                              %% ctrl =&gt; CMsgs,
<a name="3380"/> 3380:                                              iov  =&gt; [Data]},
<a name="3381"/> 3381:                                   socket:sendmsg(Sock, Msg)
<a name="3382"/> 3382:                           end,
<a name="3383"/> 3383:                    Recv = fun(Sock) -&gt;
<a name="3384"/> 3384:                                   %% We have some issues on old darwin...
<a name="3385"/> 3385:                                   %% ok = socket:setopt(Sock, {otp,debug}, true),
<a name="3386"/> 3386:                                   case socket:recvmsg(Sock) of
<a name="3387"/> 3387:                                       {ok, #{addr  := Source,
<a name="3388"/> 3388:                                              iov   := [Data]}} -&gt;
<a name="3389"/> 3389:                                           %% socket:setopt(Sock, otp, debug, false),
<a name="3390"/> 3390:                                           {ok, {Source, Data}};
<a name="3391"/> 3391:                                       {error, _} = ERROR -&gt;
<a name="3392"/> 3392:                                           ERROR
<a name="3393"/> 3393:                                   end
<a name="3394"/> 3394:                           end,
<a name="3395"/> 3395:                    InitState = #{domain =&gt; inet,
<a name="3396"/> 3396:                                  proto  =&gt; udp,
<a name="3397"/> 3397:                                  send   =&gt; Send,
<a name="3398"/> 3398:                                  recv   =&gt; Recv},
<a name="3399"/> 3399:                    ok = api_b_send_and_recv_udp(InitState)
<a name="3400"/> 3400:            end).
<a name="3401"/> 3401: 
<a name="3402"/> 3402: 
<a name="3403"/> 3403: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="3404"/> 3404: 
<a name="3405"/> 3405: <i>%% Basically send and receive on an IPv4 UDP (dgram) socket</i>
<a name="3406"/> 3406: <i>%% using sendmsg and recvmsg.</i>
<a name="api_b_sendmsg_and_recvmsg_udpL-1"/><a name="3407"/> 3407: <b>api_b_sendmsg_and_recvmsg_udpL</b>(_Config) when is_list(_Config) -&gt;
<a name="3408"/> 3408:     ?TT(?SECS(5)),
<a name="api_b_sendmsg_and_recvmsg_udpL-last_expr"/><a name="3409"/> 3409: <b>    tc_try</b>(api_b_sendmsg_and_recvmsg_udpL,
<a name="3410"/> 3410:            fun() -&gt;
<a name="3411"/> 3411:                    has_support_unix_domain_socket(),
<a name="3412"/> 3412: 		   is_not_windows(),
<a name="3413"/> 3413:                    unix_domain_socket_host_cond()
<a name="3414"/> 3414:            end,
<a name="3415"/> 3415:            fun() -&gt;
<a name="3416"/> 3416:                    Send = fun(Sock, Data, Dest) -&gt;
<a name="3417"/> 3417:                                   %% We need tests for this,
<a name="3418"/> 3418:                                   %% but this is not the place it.
<a name="3419"/> 3419:                                   %% CMsg  = #{level =&gt; ip,
<a name="3420"/> 3420:                                   %%              type  =&gt; tos,
<a name="3421"/> 3421:                                   %%              data  =&gt; reliability},
<a name="3422"/> 3422:                                   %% CMsgs = [CMsg],
<a name="3423"/> 3423:                                   Msg = #{addr =&gt; Dest,
<a name="3424"/> 3424:                                              %% ctrl =&gt; CMsgs,
<a name="3425"/> 3425:                                              iov  =&gt; [Data]},
<a name="3426"/> 3426:                                   socket:sendmsg(Sock, Msg)
<a name="3427"/> 3427:                           end,
<a name="3428"/> 3428:                    Recv = fun(Sock) -&gt;
<a name="3429"/> 3429:                                   %% We have some issues on old darwing...
<a name="3430"/> 3430:                                   %% socket:setopt(Sock, otp, debug, true),
<a name="3431"/> 3431:                                   case socket:recvmsg(Sock) of
<a name="3432"/> 3432:                                       {ok, #{addr  := Source,
<a name="3433"/> 3433:                                              iov   := [Data]}} -&gt;
<a name="3434"/> 3434:                                           %% socket:setopt(Sock, otp, debug, false),
<a name="3435"/> 3435:                                           {ok, {Source, Data}};
<a name="3436"/> 3436:                                       {error, _} = ERROR -&gt;
<a name="3437"/> 3437:                                           ERROR
<a name="3438"/> 3438:                                   end
<a name="3439"/> 3439:                           end,
<a name="3440"/> 3440:                    InitState = #{domain =&gt; local,
<a name="3441"/> 3441:                                  proto  =&gt; default,
<a name="3442"/> 3442:                                  send   =&gt; Send,
<a name="3443"/> 3443:                                  recv   =&gt; Recv},
<a name="3444"/> 3444:                    ok = api_b_send_and_recv_udp(InitState)
<a name="3445"/> 3445:            end).
<a name="3446"/> 3446: 
<a name="3447"/> 3447: 
<a name="3448"/> 3448: 
<a name="3449"/> 3449: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="3450"/> 3450: 
<a name="api_b_send_and_recv_udp-1"/><a name="3451"/> 3451: <b>api_b_send_and_recv_udp</b>(InitState) -&gt;
<a name="3452"/> 3452:     Seq = 
<a name="3453"/> 3453:         [
<a name="3454"/> 3454:          #{desc =&gt; &quot;local address&quot;,
<a name="3455"/> 3455:            cmd  =&gt; fun(#{domain := local = Domain} = State) -&gt;
<a name="3456"/> 3456:                            LSASrc = which_local_socket_addr(Domain),
<a name="3457"/> 3457:                            LSADst = which_local_socket_addr(Domain),
<a name="3458"/> 3458:                            {ok, State#{lsa_src =&gt; LSASrc,
<a name="3459"/> 3459:                                        lsa_dst =&gt; LSADst}};
<a name="3460"/> 3460:                       (#{domain := Domain} = State) -&gt;
<a name="3461"/> 3461:                            LSA = which_local_socket_addr(Domain),
<a name="3462"/> 3462:                            {ok, State#{lsa_src =&gt; LSA,
<a name="3463"/> 3463:                                        lsa_dst =&gt; LSA}}
<a name="3464"/> 3464:                    end},
<a name="3465"/> 3465: 
<a name="3466"/> 3466:          #{desc =&gt; &quot;open src socket&quot;,
<a name="3467"/> 3467:            cmd  =&gt; fun(#{domain := Domain,
<a name="3468"/> 3468:                          proto  := Proto} = State) -&gt;
<a name="3469"/> 3469:                            Sock = sock_open(Domain, dgram, Proto),
<a name="3470"/> 3470:                            {ok, State#{sock_src =&gt; Sock}}
<a name="3471"/> 3471:                    end},
<a name="3472"/> 3472:          #{desc =&gt; &quot;bind src socket&quot;,
<a name="3473"/> 3473:            cmd  =&gt; fun(#{sock_src := Sock, lsa_src := LSA}) -&gt;
<a name="3474"/> 3474:                            case sock_bind(Sock, LSA) of
<a name="3475"/> 3475:                                ok -&gt;
<a name="3476"/> 3476:                                    Port = sock_port(Sock),
<a name="3477"/> 3477:                                    ?SEV_IPRINT(&quot;src bound (to ~p)&quot;, [Port]),
<a name="3478"/> 3478:                                    ok;
<a name="3479"/> 3479:                                {error, Reason} = ERROR -&gt;
<a name="3480"/> 3480:                                    ?SEV_EPRINT(&quot;src bind failed: ~p&quot;, [Reason]),
<a name="3481"/> 3481:                                    ERROR
<a name="3482"/> 3482:                            end
<a name="3483"/> 3483:                    end},
<a name="3484"/> 3484:          #{desc =&gt; &quot;sockname src socket&quot;,
<a name="3485"/> 3485:            cmd  =&gt; fun(#{sock_src := Sock} = State) -&gt;
<a name="3486"/> 3486:                            SASrc = sock_sockname(Sock),
<a name="3487"/> 3487:                            ?SEV_IPRINT(&quot;src sockaddr: &quot;
<a name="3488"/> 3488:                                        &quot;~n   ~p&quot;, [SASrc]),
<a name="3489"/> 3489:                            {ok, State#{sa_src =&gt; SASrc}}
<a name="3490"/> 3490:                    end},
<a name="3491"/> 3491: 
<a name="3492"/> 3492:          #{desc =&gt; &quot;open dst socket&quot;,
<a name="3493"/> 3493:            cmd  =&gt; fun(#{domain := Domain,
<a name="3494"/> 3494:                          proto  := Proto} = State) -&gt;
<a name="3495"/> 3495:                            Sock = sock_open(Domain, dgram, Proto),
<a name="3496"/> 3496:                            {ok, State#{sock_dst =&gt; Sock}}
<a name="3497"/> 3497:                    end},
<a name="3498"/> 3498:          #{desc =&gt; &quot;bind dst socket&quot;,
<a name="3499"/> 3499:            cmd  =&gt; fun(#{sock_dst := Sock, lsa_dst := LSA}) -&gt;
<a name="3500"/> 3500:                            case sock_bind(Sock, LSA) of
<a name="3501"/> 3501:                                ok -&gt;
<a name="3502"/> 3502:                                    Port = sock_port(Sock),
<a name="3503"/> 3503:                                    ?SEV_IPRINT(&quot;src bound (to ~p)&quot;, [Port]),
<a name="3504"/> 3504:                                    ok;
<a name="3505"/> 3505:                                {error, Reason} = ERROR -&gt;
<a name="3506"/> 3506:                                    ?SEV_EPRINT(&quot;src bind failed: ~p&quot;, [Reason]),
<a name="3507"/> 3507:                                    ERROR
<a name="3508"/> 3508:                            end
<a name="3509"/> 3509:                    end},
<a name="3510"/> 3510:          #{desc =&gt; &quot;sockname dst socket&quot;,
<a name="3511"/> 3511:            cmd  =&gt; fun(#{sock_dst := Sock} = State) -&gt;
<a name="3512"/> 3512:                            SADst = sock_sockname(Sock),
<a name="3513"/> 3513:                            ?SEV_IPRINT(&quot;dst sockaddr: &quot;
<a name="3514"/> 3514:                                        &quot;~n   ~p&quot;, [SADst]),
<a name="3515"/> 3515:                            {ok, State#{sa_dst =&gt; SADst}}
<a name="3516"/> 3516:                    end},
<a name="3517"/> 3517:          #{desc =&gt; &quot;send req (to dst)&quot;,
<a name="3518"/> 3518:            cmd  =&gt; fun(#{sock_src := Sock, sa_dst := Dst, send := Send}) -&gt;
<a name="3519"/> 3519:                            Send(Sock, ?BASIC_REQ, Dst)
<a name="3520"/> 3520:                    end},
<a name="3521"/> 3521:          #{desc =&gt; &quot;recv req (from src)&quot;,
<a name="3522"/> 3522:            cmd  =&gt; fun(#{sock_dst := Sock, sa_src := Src, recv := Recv}) -&gt;
<a name="3523"/> 3523:                            case Recv(Sock) of
<a name="3524"/> 3524:                                {ok, {Src, ?BASIC_REQ}} -&gt;
<a name="3525"/> 3525:                                    ok;
<a name="3526"/> 3526:                                {ok, UnexpData} -&gt;
<a name="3527"/> 3527:                                    {error, {unexpected_data, UnexpData}};
<a name="3528"/> 3528:                                {error, _} = ERROR -&gt;
<a name="3529"/> 3529:                                    %% At the moment there is no way to get
<a name="3530"/> 3530:                                    %% status or state for the socket...
<a name="3531"/> 3531:                                    ERROR
<a name="3532"/> 3532:                            end
<a name="3533"/> 3533:                    end},
<a name="3534"/> 3534:          #{desc =&gt; &quot;send rep (to src)&quot;,
<a name="3535"/> 3535:            cmd  =&gt; fun(#{sock_dst := Sock, sa_src := Src, send := Send}) -&gt;
<a name="3536"/> 3536:                            Send(Sock, ?BASIC_REP, Src)
<a name="3537"/> 3537:                    end},
<a name="3538"/> 3538:          #{desc =&gt; &quot;recv rep (from dst)&quot;,
<a name="3539"/> 3539:            cmd  =&gt; fun(#{sock_src := Sock, sa_dst := Dst, recv := Recv}) -&gt;
<a name="3540"/> 3540:                            case Recv(Sock) of
<a name="3541"/> 3541:                                {ok, {Dst, ?BASIC_REP}} -&gt;
<a name="3542"/> 3542:                                    ok;
<a name="3543"/> 3543:                                {ok, UnexpData} -&gt;
<a name="3544"/> 3544:                                    {error, {unexpected_data, UnexpData}};
<a name="3545"/> 3545:                                {error, _} = ERROR -&gt;
<a name="3546"/> 3546:                                    %% At the moment there is no way to get
<a name="3547"/> 3547:                                    %% status or state for the socket...
<a name="3548"/> 3548:                                    ERROR
<a name="3549"/> 3549:                            end
<a name="3550"/> 3550:                    end},
<a name="3551"/> 3551:          #{desc =&gt; &quot;close src socket&quot;,
<a name="3552"/> 3552:            cmd  =&gt; fun(#{domain   := local,
<a name="3553"/> 3553:                          sock_src := Sock,
<a name="3554"/> 3554:                          lsa_src  := #{path := Path}} = State) -&gt;
<a name="3555"/> 3555:                            ok = socket:close(Sock),
<a name="3556"/> 3556:                            State1 =
<a name="3557"/> 3557:                                unlink_path(Path,
<a name="3558"/> 3558:                                            fun() -&gt; maps:remove(lsa_src, State) end,
<a name="3559"/> 3559:                                            fun() -&gt; State end),
<a name="3560"/> 3560:                            {ok, maps:remove(sock_src, State1)};
<a name="3561"/> 3561:                       (#{sock_src := Sock} = State) -&gt;
<a name="3562"/> 3562:                            ok = socket:close(Sock),
<a name="3563"/> 3563:                            {ok, maps:remove(sock_src, State)}
<a name="3564"/> 3564:                    end},
<a name="3565"/> 3565:          #{desc =&gt; &quot;close dst socket&quot;,
<a name="3566"/> 3566:            cmd  =&gt; fun(#{domain   := local,
<a name="3567"/> 3567:                          sock_dst := Sock,
<a name="3568"/> 3568:                          lsa_dst  := #{path := Path}} = State) -&gt;
<a name="3569"/> 3569:                            ok = socket:close(Sock),
<a name="3570"/> 3570:                            State1 =
<a name="3571"/> 3571:                                unlink_path(Path,
<a name="3572"/> 3572:                                            fun() -&gt; maps:remove(lsa_dst, State) end,
<a name="3573"/> 3573:                                            fun() -&gt; State end),
<a name="3574"/> 3574:                            {ok, maps:remove(sock_dst, State1)};
<a name="3575"/> 3575:                       (#{sock_dst := Sock} = State) -&gt;
<a name="3576"/> 3576:                            ok = socket:close(Sock),
<a name="3577"/> 3577:                            {ok, maps:remove(sock_dst, State)}
<a name="3578"/> 3578:                    end},
<a name="3579"/> 3579: 
<a name="3580"/> 3580:          %% *** We are done ***
<a name="3581"/> 3581:          ?SEV_FINISH_NORMAL
<a name="3582"/> 3582:         ],
<a name="3583"/> 3583:     Evaluator = ?SEV_START(&quot;tester&quot;, Seq, InitState),
<a name="api_b_send_and_recv_udp-last_expr"/><a name="3584"/> 3584: <b>    ok = ?SEV_AWAIT_FINISH</b>([Evaluator]).
<a name="3585"/> 3585: 
<a name="3586"/> 3586: 
<a name="3587"/> 3587: 
<a name="3588"/> 3588: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="3589"/> 3589: 
<a name="3590"/> 3590: <i>%% Basically send and receive using the &quot;common&quot; functions (send and recv)</i>
<a name="3591"/> 3591: <i>%% on an IPv4 TCP (stream) socket.</i>
<a name="api_b_send_and_recv_tcp4-1"/><a name="3592"/> 3592: <b>api_b_send_and_recv_tcp4</b>(_Config) when is_list(_Config) -&gt;
<a name="3593"/> 3593:     ?TT(?SECS(10)),
<a name="api_b_send_and_recv_tcp4-last_expr"/><a name="3594"/> 3594: <b>    tc_try</b>(api_b_send_and_recv_tcp4,
<a name="3595"/> 3595:            fun() -&gt; has_support_ipv4() end,
<a name="3596"/> 3596:            fun() -&gt;
<a name="3597"/> 3597:                    Send = fun(Sock, Data) -&gt;
<a name="3598"/> 3598:                                   socket:send(Sock, Data)
<a name="3599"/> 3599:                           end,
<a name="3600"/> 3600:                    Recv = fun(Sock) -&gt;
<a name="3601"/> 3601:                                   socket:recv(Sock)
<a name="3602"/> 3602:                           end,
<a name="3603"/> 3603:                    InitState = #{domain =&gt; inet,
<a name="3604"/> 3604:                                  type   =&gt; stream,
<a name="3605"/> 3605:                                  proto  =&gt; tcp,
<a name="3606"/> 3606:                                  send   =&gt; Send,
<a name="3607"/> 3607:                                  recv   =&gt; Recv},
<a name="3608"/> 3608:                    ok = api_b_send_and_recv_conn(InitState)
<a name="3609"/> 3609:            end).
<a name="3610"/> 3610: 
<a name="3611"/> 3611: 
<a name="3612"/> 3612: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="3613"/> 3613: 
<a name="3614"/> 3614: <i>%% Basically send and receive using the &quot;common&quot; functions (send and recv)</i>
<a name="3615"/> 3615: <i>%% on an Unix Domain (stream) socket (TCP).</i>
<a name="api_b_send_and_recv_tcpL-1"/><a name="3616"/> 3616: <b>api_b_send_and_recv_tcpL</b>(_Config) when is_list(_Config) -&gt;
<a name="3617"/> 3617:     ?TT(?SECS(10)),
<a name="api_b_send_and_recv_tcpL-last_expr"/><a name="3618"/> 3618: <b>    tc_try</b>(api_b_send_and_recv_tcpL,
<a name="3619"/> 3619:            fun() -&gt; has_support_unix_domain_socket() end,
<a name="3620"/> 3620:            fun() -&gt;
<a name="3621"/> 3621:                    Send = fun(Sock, Data) -&gt;
<a name="3622"/> 3622:                                   socket:send(Sock, Data)
<a name="3623"/> 3623:                           end,
<a name="3624"/> 3624:                    Recv = fun(Sock) -&gt;
<a name="3625"/> 3625:                                   socket:recv(Sock)
<a name="3626"/> 3626:                           end,
<a name="3627"/> 3627:                    InitState = #{domain =&gt; local,
<a name="3628"/> 3628:                                  type   =&gt; stream,
<a name="3629"/> 3629:                                  proto  =&gt; default,
<a name="3630"/> 3630:                                  send   =&gt; Send,
<a name="3631"/> 3631:                                  recv   =&gt; Recv},
<a name="3632"/> 3632:                    ok = api_b_send_and_recv_conn(InitState)
<a name="3633"/> 3633:            end).
<a name="3634"/> 3634: 
<a name="3635"/> 3635: 
<a name="3636"/> 3636: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="3637"/> 3637: 
<a name="3638"/> 3638: <i>%% Basically send and receive using the &quot;common&quot; functions (send and recv)</i>
<a name="3639"/> 3639: <i>%% on an Unix Domain seqpacket socket.</i>
<a name="api_b_send_and_recv_seqpL-1"/><a name="3640"/> 3640: <b>api_b_send_and_recv_seqpL</b>(_Config) when is_list(_Config) -&gt;
<a name="3641"/> 3641:     ?TT(?SECS(10)),
<a name="api_b_send_and_recv_seqpL-last_expr"/><a name="3642"/> 3642: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="3643"/> 3643:            fun() -&gt;
<a name="3644"/> 3644: 		   has_support_unix_domain_socket(),
<a name="3645"/> 3645:                    is_not_windows()
<a name="3646"/> 3646: 	   end,
<a name="3647"/> 3647:            fun() -&gt;
<a name="3648"/> 3648:                    Send = fun(Sock, Data) -&gt;
<a name="3649"/> 3649:                                   socket:send(Sock, Data)
<a name="3650"/> 3650:                           end,
<a name="3651"/> 3651:                    Recv = fun(Sock) -&gt;
<a name="3652"/> 3652:                                   socket:recv(Sock)
<a name="3653"/> 3653:                           end,
<a name="3654"/> 3654:                    InitState = #{domain =&gt; local,
<a name="3655"/> 3655:                                  type   =&gt; seqpacket,
<a name="3656"/> 3656:                                  proto  =&gt; default,
<a name="3657"/> 3657:                                  send   =&gt; Send,
<a name="3658"/> 3658:                                  recv   =&gt; Recv},
<a name="3659"/> 3659:                    ok = api_b_send_and_recv_conn(InitState)
<a name="3660"/> 3660:            end).
<a name="3661"/> 3661: 
<a name="3662"/> 3662: 
<a name="3663"/> 3663: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="3664"/> 3664: 
<a name="3665"/> 3665: <i>%% Basically send and receive using the msg functions (sendmsg and recvmsg)</i>
<a name="3666"/> 3666: <i>%% on an IPv4 TCP (stream) socket.</i>
<a name="api_b_sendmsg_and_recvmsg_tcp4-1"/><a name="3667"/> 3667: <b>api_b_sendmsg_and_recvmsg_tcp4</b>(_Config) when is_list(_Config) -&gt;
<a name="3668"/> 3668:     ?TT(?SECS(10)),
<a name="api_b_sendmsg_and_recvmsg_tcp4-last_expr"/><a name="3669"/> 3669: <b>    tc_try</b>(api_b_sendmsg_and_recvmsg_tcp4,
<a name="3670"/> 3670:            fun() -&gt;
<a name="3671"/> 3671:                    is_not_windows(),
<a name="3672"/> 3672:                    has_support_ipv4()
<a name="3673"/> 3673:            end,
<a name="3674"/> 3674:            fun() -&gt;
<a name="3675"/> 3675:                    Send = fun(Sock, Data) -&gt;
<a name="3676"/> 3676:                                   Msg = #{iov =&gt; [Data]},
<a name="3677"/> 3677:                                   socket:sendmsg(Sock, Msg)
<a name="3678"/> 3678:                           end,
<a name="3679"/> 3679:                    Recv = fun(Sock) -&gt;
<a name="3680"/> 3680:                                   case socket:recvmsg(Sock) of
<a name="3681"/> 3681:                                       {ok, #{addr  := _} = Addr} -&gt;
<a name="3682"/> 3682:                                           {error, {addr, Addr}};
<a name="3683"/> 3683:                                       {ok, #{iov   := [Data]}} -&gt;
<a name="3684"/> 3684:                                           {ok, Data};
<a name="3685"/> 3685:                                       {ok, Msg} -&gt;
<a name="3686"/> 3686:                                           {error, {msg, Msg}};
<a name="3687"/> 3687:                                       {error, _} = ERROR -&gt;
<a name="3688"/> 3688:                                           ERROR
<a name="3689"/> 3689:                                   end
<a name="3690"/> 3690:                           end,
<a name="3691"/> 3691:                    InitState = #{domain =&gt; inet,
<a name="3692"/> 3692:                                  type   =&gt; stream,
<a name="3693"/> 3693:                                  proto  =&gt; tcp,
<a name="3694"/> 3694:                                  send   =&gt; Send,
<a name="3695"/> 3695:                                  recv   =&gt; Recv},
<a name="3696"/> 3696:                    ok = api_b_send_and_recv_conn(InitState)
<a name="3697"/> 3697:            end).
<a name="3698"/> 3698: 
<a name="3699"/> 3699: 
<a name="3700"/> 3700: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="3701"/> 3701: 
<a name="3702"/> 3702: <i>%% Basically send and receive using the msg functions (sendmsg and recvmsg)</i>
<a name="3703"/> 3703: <i>%% on an Unix Domain (stream) socket (TCP).</i>
<a name="api_b_sendmsg_and_recvmsg_tcpL-1"/><a name="3704"/> 3704: <b>api_b_sendmsg_and_recvmsg_tcpL</b>(_Config) when is_list(_Config) -&gt;
<a name="3705"/> 3705:     ?TT(?SECS(10)),
<a name="api_b_sendmsg_and_recvmsg_tcpL-last_expr"/><a name="3706"/> 3706: <b>    tc_try</b>(api_b_sendmsg_and_recvmsg_tcpL,
<a name="3707"/> 3707:            fun() -&gt;
<a name="3708"/> 3708: 		   has_support_unix_domain_socket(),
<a name="3709"/> 3709: 		   is_not_windows()
<a name="3710"/> 3710: 	   end,
<a name="3711"/> 3711:            fun() -&gt;
<a name="3712"/> 3712:                    Send = fun(Sock, Data) -&gt;
<a name="3713"/> 3713:                                   Msg = #{iov =&gt; [Data]},
<a name="3714"/> 3714:                                   socket:sendmsg(Sock, Msg)
<a name="3715"/> 3715:                           end,
<a name="3716"/> 3716:                    Recv = fun(Sock) -&gt;
<a name="3717"/> 3717:                                   case socket:recvmsg(Sock) of
<a name="3718"/> 3718:                                       %% On some platforms, the address
<a name="3719"/> 3719:                                       %% *is* provided (e.g. linux)
<a name="3720"/> 3720:                                       {ok, #{addr  := #{family := local},
<a name="3721"/> 3721:                                              iov   := [Data]}} -&gt;
<a name="3722"/> 3722:                                           socket:setopt(Sock, 
<a name="3723"/> 3723:                                                         otp, 
<a name="3724"/> 3724:                                                         debug, 
<a name="3725"/> 3725:                                                         false),
<a name="3726"/> 3726:                                           {ok, Data};
<a name="3727"/> 3727:                                       {ok, #{addr := _} = Msg} -&gt;
<a name="3728"/> 3728:                                           {error, {msg, Msg}};
<a name="3729"/> 3729:                                       %% On some platforms, the address
<a name="3730"/> 3730:                                       %% is *not* provided (e.g. FreeBSD)
<a name="3731"/> 3731:                                       {ok, #{iov   := [Data]}} -&gt;
<a name="3732"/> 3732:                                           {ok, Data};
<a name="3733"/> 3733:                                       {ok, Msg} -&gt;
<a name="3734"/> 3734:                                           {error, {msg, Msg}};
<a name="3735"/> 3735:                                       {error, _} = ERROR -&gt;
<a name="3736"/> 3736:                                           socket:setopt(Sock, 
<a name="3737"/> 3737:                                                         otp, 
<a name="3738"/> 3738:                                                         debug, 
<a name="3739"/> 3739:                                                         false),
<a name="3740"/> 3740:                                           ERROR
<a name="3741"/> 3741:                                   end
<a name="3742"/> 3742:                           end,
<a name="3743"/> 3743:                    InitState = #{domain =&gt; local,
<a name="3744"/> 3744:                                  type   =&gt; stream,
<a name="3745"/> 3745:                                  proto  =&gt; default,
<a name="3746"/> 3746:                                  send   =&gt; Send,
<a name="3747"/> 3747:                                  recv   =&gt; Recv},
<a name="3748"/> 3748:                    ok = api_b_send_and_recv_conn(InitState)
<a name="3749"/> 3749:            end).
<a name="3750"/> 3750: 
<a name="3751"/> 3751: 
<a name="3752"/> 3752: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="3753"/> 3753: 
<a name="3754"/> 3754: <i>%% Basically send and receive using the msg functions (sendmsg and recvmsg)</i>
<a name="3755"/> 3755: <i>%% on an Unix Domain (stream) socket (TCP).</i>
<a name="api_b_sendmsg_and_recvmsg_seqpL-1"/><a name="3756"/> 3756: <b>api_b_sendmsg_and_recvmsg_seqpL</b>(_Config) when is_list(_Config) -&gt;
<a name="3757"/> 3757:     ?TT(?SECS(10)),
<a name="api_b_sendmsg_and_recvmsg_seqpL-last_expr"/><a name="3758"/> 3758: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="3759"/> 3759:            fun() -&gt;
<a name="3760"/> 3760: 		   has_support_unix_domain_socket(),
<a name="3761"/> 3761:                    is_not_windows()
<a name="3762"/> 3762: 	   end,
<a name="3763"/> 3763:            fun() -&gt;
<a name="3764"/> 3764:                    Send =
<a name="3765"/> 3765:                        fun(Sock, Data) -&gt;
<a name="3766"/> 3766:                                Msg =
<a name="3767"/> 3767:                                    #{iov =&gt; [Data]},
<a name="3768"/> 3768:                                socket:sendmsg(Sock, Msg)
<a name="3769"/> 3769:                        end,
<a name="3770"/> 3770:                    Recv = fun(Sock) -&gt;
<a name="3771"/> 3771:                                   case socket:recvmsg(Sock) of
<a name="3772"/> 3772:                                       %% On some platforms, the address
<a name="3773"/> 3773:                                       %% *is* provided (e.g. linux)
<a name="3774"/> 3774:                                       {ok,
<a name="3775"/> 3775:                                        #{addr  := #{family := local},
<a name="3776"/> 3776:                                          iov   := [Data]}} -&gt;
<a name="3777"/> 3777:                                           socket:setopt(
<a name="3778"/> 3778:                                             Sock, otp, debug, false),
<a name="3779"/> 3779:                                           {ok, Data};
<a name="3780"/> 3780:                                       {ok, #{addr := _} = Msg} -&gt;
<a name="3781"/> 3781:                                           {error, {msg, Msg}};
<a name="3782"/> 3782:                                       %% On some platforms, the address
<a name="3783"/> 3783:                                       %% is *not* provided (e.g. FreeBSD)
<a name="3784"/> 3784:                                       {ok,
<a name="3785"/> 3785:                                        #{iov   := [Data]}} -&gt;
<a name="3786"/> 3786:                                           {ok, Data};
<a name="3787"/> 3787:                                       {ok, Msg} -&gt;
<a name="3788"/> 3788:                                           {error, {msg, Msg}};
<a name="3789"/> 3789:                                       {error, _} = ERROR -&gt;
<a name="3790"/> 3790:                                           socket:setopt(
<a name="3791"/> 3791:                                             Sock, otp, debug, false),
<a name="3792"/> 3792:                                           ERROR
<a name="3793"/> 3793:                                   end
<a name="3794"/> 3794:                           end,
<a name="3795"/> 3795:                    InitState =
<a name="3796"/> 3796:                        #{domain =&gt; local,
<a name="3797"/> 3797:                          type   =&gt; seqpacket,
<a name="3798"/> 3798:                          proto  =&gt; default,
<a name="3799"/> 3799:                          send   =&gt; Send,
<a name="3800"/> 3800:                          recv   =&gt; Recv},
<a name="3801"/> 3801:                    ok = api_b_send_and_recv_conn(InitState)
<a name="3802"/> 3802:            end).
<a name="3803"/> 3803: 
<a name="3804"/> 3804: 
<a name="3805"/> 3805: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="3806"/> 3806: 
<a name="api_b_send_and_recv_conn-1"/><a name="3807"/> 3807: <b>api_b_send_and_recv_conn</b>(InitState) -&gt;
<a name="3808"/> 3808:     process_flag(trap_exit, true),
<a name="3809"/> 3809: 
<a name="3810"/> 3810:     ServerSeq = 
<a name="3811"/> 3811:         [
<a name="3812"/> 3812:          %% *** Wait for start order ***
<a name="3813"/> 3813:          #{desc =&gt; &quot;await start (from tester)&quot;,
<a name="3814"/> 3814:            cmd  =&gt; fun(State) -&gt;
<a name="3815"/> 3815:                            Tester = ?SEV_AWAIT_START(),
<a name="3816"/> 3816:                            {ok, State#{tester =&gt; Tester}}
<a name="3817"/> 3817:                    end},
<a name="3818"/> 3818:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="3819"/> 3819:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="3820"/> 3820:                            _MRef = erlang:monitor(process, Tester),
<a name="3821"/> 3821:                            ok
<a name="3822"/> 3822:                    end},
<a name="3823"/> 3823: 
<a name="3824"/> 3824:          %% *** Init part ***
<a name="3825"/> 3825:          #{desc =&gt; &quot;which local address&quot;,
<a name="3826"/> 3826:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="3827"/> 3827:                            LSA = which_local_socket_addr(Domain),
<a name="3828"/> 3828: 			   ?SEV_IPRINT(&quot;LSA: ~p&quot;, [LSA]),
<a name="3829"/> 3829:                            {ok, State#{lsa =&gt; LSA}}
<a name="3830"/> 3830:                    end},
<a name="3831"/> 3831:          #{desc =&gt; &quot;create listen socket&quot;,
<a name="3832"/> 3832:            cmd  =&gt; fun(#{domain := Domain,
<a name="3833"/> 3833:                          type := Type,
<a name="3834"/> 3834:                          proto  := Proto} = State) -&gt;
<a name="3835"/> 3835:                            case socket:open(Domain, Type, Proto) of
<a name="3836"/> 3836:                                {ok, Sock} -&gt;
<a name="3837"/> 3837:                                    {ok, State#{lsock =&gt; Sock}};
<a name="3838"/> 3838:                                {error, eprotonosupport = Reason} -&gt;
<a name="3839"/> 3839:                                    {skip, Reason};
<a name="3840"/> 3840:                                {error, _} = ERROR -&gt;
<a name="3841"/> 3841:                                    ERROR
<a name="3842"/> 3842:                            end
<a name="3843"/> 3843:                    end},
<a name="3844"/> 3844:          #{desc =&gt; &quot;bind to local address&quot;,
<a name="3845"/> 3845:            cmd  =&gt; fun(#{domain := local,
<a name="3846"/> 3846:                          lsock  := LSock,
<a name="3847"/> 3847:                          lsa    := LSA} = _State) -&gt;
<a name="3848"/> 3848: 			   ?SEV_IPRINT(&quot;try bind to: &quot;
<a name="3849"/> 3849: 				       &quot;~n   ~p&quot;, [LSA]),
<a name="3850"/> 3850: 			   %% _ = socket:setopt(LSock, otp, debug, true),
<a name="3851"/> 3851:                            case socket:bind(LSock, LSA) of
<a name="3852"/> 3852:                                ok -&gt;
<a name="3853"/> 3853:                                    %% We do not care about the port for local
<a name="3854"/> 3854: 				   %% _ = socket:setopt(LSock, otp, debug, false),
<a name="3855"/> 3855:                                    ok;
<a name="3856"/> 3856:                                {error, Reason} = ERROR -&gt;
<a name="3857"/> 3857: 				   %% _ = socket:setopt(LSock, otp, debug, false),
<a name="3858"/> 3858: 				   ?SEV_EPRINT(&quot;failed binding: &quot;
<a name="3859"/> 3859: 					       &quot;~n   ~p&quot;, [Reason]),
<a name="3860"/> 3860:                                    ERROR
<a name="3861"/> 3861:                            end;
<a name="3862"/> 3862:                       (#{lsock := LSock, lsa := LSA} = State) -&gt;
<a name="3863"/> 3863:                            case sock_bind(LSock, LSA) of
<a name="3864"/> 3864:                                ok -&gt;
<a name="3865"/> 3865:                                    Port = sock_port(LSock),
<a name="3866"/> 3866:                                    ?SEV_IPRINT(&quot;bound to port: ~w&quot;, [Port]),
<a name="3867"/> 3867:                                    {ok, State#{lport =&gt; Port}};
<a name="3868"/> 3868:                                {error, _} = ERROR -&gt;
<a name="3869"/> 3869:                                    ERROR
<a name="3870"/> 3870:                            end
<a name="3871"/> 3871:                    end},
<a name="3872"/> 3872:          #{desc =&gt; &quot;make listen socket&quot;,
<a name="3873"/> 3873:            cmd  =&gt; fun(#{lsock := LSock}) -&gt;
<a name="3874"/> 3874:                            socket:listen(LSock)
<a name="3875"/> 3875:                    end},
<a name="3876"/> 3876:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="3877"/> 3877:            cmd  =&gt; fun(#{domain := local,
<a name="3878"/> 3878:                          tester := Tester, lsa := #{path := Path}}) -&gt;
<a name="3879"/> 3879:                            ?SEV_ANNOUNCE_READY(Tester, init, Path),
<a name="3880"/> 3880:                            ok;
<a name="3881"/> 3881:                       (#{tester := Tester, lport := Port}) -&gt;
<a name="3882"/> 3882:                            %% This is actually not used for unix domain socket
<a name="3883"/> 3883:                            ?SEV_ANNOUNCE_READY(Tester, init, Port),
<a name="3884"/> 3884:                            ok
<a name="3885"/> 3885:                    end},
<a name="3886"/> 3886: 
<a name="3887"/> 3887:          %% The actual test
<a name="3888"/> 3888:          #{desc =&gt; &quot;await continue (accept)&quot;,
<a name="3889"/> 3889:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="3890"/> 3890:                            ?SEV_AWAIT_CONTINUE(Tester, tester, accept)
<a name="3891"/> 3891:                    end},
<a name="3892"/> 3892:          #{desc =&gt; &quot;await connection&quot;,
<a name="3893"/> 3893:            cmd  =&gt; fun(#{lsock := LSock} = State) -&gt;
<a name="3894"/> 3894: 			   %% _ = socket:setopt(LSock, otp, debug, true),
<a name="3895"/> 3895: 			   ?SEV_IPRINT(&quot;try accept&quot;),
<a name="3896"/> 3896:                            case socket:accept(LSock) of
<a name="3897"/> 3897:                                {ok, Sock} -&gt;
<a name="3898"/> 3898: 				   %% _ = socket:setopt(LSock, otp, debug, false),
<a name="3899"/> 3899:                                    ?SEV_IPRINT(&quot;accepted: ~n   ~p&quot;, [Sock]),
<a name="3900"/> 3900:                                    {ok, State#{csock =&gt; Sock}};
<a name="3901"/> 3901:                                {error, Reason} = ERROR -&gt;
<a name="3902"/> 3902: 				   %% _ = socket:setopt(LSock, otp, debug, false),
<a name="3903"/> 3903:                                    ?SEV_EPRINT(&quot;accept failed: &quot;
<a name="3904"/> 3904: 					       &quot;~n   ~p&quot;, [Reason]),
<a name="3905"/> 3905:                                    ERROR
<a name="3906"/> 3906:                            end
<a name="3907"/> 3907:                    end},
<a name="3908"/> 3908:          #{desc =&gt; &quot;announce ready (accept)&quot;,
<a name="3909"/> 3909:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="3910"/> 3910:                            ?SEV_ANNOUNCE_READY(Tester, accept),
<a name="3911"/> 3911:                            ok
<a name="3912"/> 3912:                    end},
<a name="3913"/> 3913:          #{desc =&gt; &quot;await (recv) request&quot;,
<a name="3914"/> 3914:            cmd  =&gt; fun(#{csock := Sock, recv := Recv}) -&gt;
<a name="3915"/> 3915:                            case Recv(Sock) of
<a name="3916"/> 3916:                                {ok, ?BASIC_REQ} -&gt;
<a name="3917"/> 3917:                                    ok;
<a name="3918"/> 3918:                                {error, _} = ERROR -&gt;
<a name="3919"/> 3919:                                    ERROR
<a name="3920"/> 3920:                            end
<a name="3921"/> 3921:                    end},
<a name="3922"/> 3922:          #{desc =&gt; &quot;announce ready (recv request)&quot;,
<a name="3923"/> 3923:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="3924"/> 3924:                            ?SEV_ANNOUNCE_READY(Tester, recv_req),
<a name="3925"/> 3925:                            ok
<a name="3926"/> 3926:                    end},
<a name="3927"/> 3927:          #{desc =&gt; &quot;await continue (with send reply)&quot;,
<a name="3928"/> 3928:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="3929"/> 3929:                            ?SEV_AWAIT_CONTINUE(Tester, tester, send_reply)
<a name="3930"/> 3930:                    end},
<a name="3931"/> 3931:          #{desc =&gt; &quot;send reply&quot;,
<a name="3932"/> 3932:            cmd  =&gt; fun(#{csock := Sock, send := Send}) -&gt;
<a name="3933"/> 3933:                            Send(Sock, ?BASIC_REP)
<a name="3934"/> 3934:                    end},
<a name="3935"/> 3935:          #{desc =&gt; &quot;announce ready (send reply)&quot;,
<a name="3936"/> 3936:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="3937"/> 3937:                            ?SEV_ANNOUNCE_READY(Tester, send_reply),
<a name="3938"/> 3938:                            ok
<a name="3939"/> 3939:                    end},
<a name="3940"/> 3940: 
<a name="3941"/> 3941:          %% *** Termination ***
<a name="3942"/> 3942:          #{desc =&gt; &quot;await terminate&quot;,
<a name="3943"/> 3943:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="3944"/> 3944:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="3945"/> 3945:                                ok -&gt;
<a name="3946"/> 3946:                                    {ok, maps:remove(tester, State)};
<a name="3947"/> 3947:                                {error, _} = ERROR -&gt;
<a name="3948"/> 3948:                                    ERROR
<a name="3949"/> 3949:                            end
<a name="3950"/> 3950:                    end},
<a name="3951"/> 3951:          #{desc =&gt; &quot;close connection socket&quot;,
<a name="3952"/> 3952:            cmd  =&gt; fun(#{csock := Sock} = State) -&gt;
<a name="3953"/> 3953:                            ok = socket:close(Sock),
<a name="3954"/> 3954:                            {ok, maps:remove(csock, State)}
<a name="3955"/> 3955:                    end},
<a name="3956"/> 3956:          #{desc =&gt; &quot;close listen socket&quot;,
<a name="3957"/> 3957:            cmd  =&gt; fun(#{domain   := local,
<a name="3958"/> 3958:                          lsock    := Sock,
<a name="3959"/> 3959:                          local_sa := #{path := Path}} = State) -&gt;
<a name="3960"/> 3960:                            ok = socket:close(Sock),
<a name="3961"/> 3961:                            State1 =
<a name="3962"/> 3962:                                unlink_path(Path,
<a name="3963"/> 3963:                                            fun() -&gt;
<a name="3964"/> 3964:                                                    maps:remove(local_sa, State)
<a name="3965"/> 3965:                                            end,
<a name="3966"/> 3966:                                            fun() -&gt; State end),
<a name="3967"/> 3967:                            {ok, maps:remove(lsock, State1)};
<a name="3968"/> 3968:                       (#{lsock := LSock} = State) -&gt;
<a name="3969"/> 3969:                            case socket:close(LSock) of
<a name="3970"/> 3970:                                ok -&gt;
<a name="3971"/> 3971:                                    {ok, maps:remove(lsock, State)};
<a name="3972"/> 3972:                                {error, _} = ERROR -&gt;
<a name="3973"/> 3973:                                    ERROR
<a name="3974"/> 3974:                            end
<a name="3975"/> 3975:                    end},
<a name="3976"/> 3976: 
<a name="3977"/> 3977:          %% *** We are done ***
<a name="3978"/> 3978:          ?SEV_FINISH_NORMAL
<a name="3979"/> 3979:         ],
<a name="3980"/> 3980: 
<a name="3981"/> 3981:     ClientSeq =
<a name="3982"/> 3982:         [
<a name="3983"/> 3983:          %% *** Wait for start order ***
<a name="3984"/> 3984:          #{desc =&gt; &quot;await start (from tester)&quot;,
<a name="3985"/> 3985:            cmd  =&gt; fun(#{domain := local} = State) -&gt;
<a name="3986"/> 3986:                            {Tester, Path} = ?SEV_AWAIT_START(),
<a name="3987"/> 3987:                            {ok, State#{tester =&gt; Tester, server_path =&gt; Path}};
<a name="3988"/> 3988:                       (State) -&gt;
<a name="3989"/> 3989:                            {Tester, Port} = ?SEV_AWAIT_START(),
<a name="3990"/> 3990:                            {ok, State#{tester =&gt; Tester, server_port =&gt; Port}}
<a name="3991"/> 3991:                    end},
<a name="3992"/> 3992:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="3993"/> 3993:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="3994"/> 3994:                            _MRef = erlang:monitor(process, Tester),
<a name="3995"/> 3995:                            ok
<a name="3996"/> 3996:                    end},
<a name="3997"/> 3997: 
<a name="3998"/> 3998:          %% *** The init part ***
<a name="3999"/> 3999:          #{desc =&gt; &quot;which server (local) address&quot;,
<a name="4000"/> 4000:            cmd  =&gt; fun(#{domain      := local = Domain,
<a name="4001"/> 4001:                          server_path := Path} = State) -&gt;
<a name="4002"/> 4002:                            LSA = which_local_socket_addr(Domain),
<a name="4003"/> 4003:                            SSA = #{family =&gt; Domain, path =&gt; Path},
<a name="4004"/> 4004:                            {ok, State#{local_sa =&gt; LSA, server_sa =&gt; SSA}};
<a name="4005"/> 4005:                       (#{domain := Domain, server_port := Port} = State) -&gt;
<a name="4006"/> 4006:                            LSA = which_local_socket_addr(Domain),
<a name="4007"/> 4007:                            SSA = LSA#{port =&gt; Port},
<a name="4008"/> 4008:                            {ok, State#{local_sa =&gt; LSA, server_sa =&gt; SSA}}
<a name="4009"/> 4009:                    end},
<a name="4010"/> 4010:          #{desc =&gt; &quot;create socket&quot;,
<a name="4011"/> 4011:            cmd  =&gt; fun(#{domain := Domain,
<a name="4012"/> 4012:                          type := Type,
<a name="4013"/> 4013:                          proto  := Proto} = State) -&gt;
<a name="4014"/> 4014:                            case socket:open(Domain, Type, Proto) of
<a name="4015"/> 4015:                                {ok, Sock} -&gt;
<a name="4016"/> 4016:                                    {ok, State#{sock =&gt; Sock}};
<a name="4017"/> 4017:                                {error, _} = ERROR -&gt;
<a name="4018"/> 4018:                                    ERROR
<a name="4019"/> 4019:                            end
<a name="4020"/> 4020:                    end},
<a name="4021"/> 4021:          #{desc =&gt; &quot;bind to local address&quot;,
<a name="4022"/> 4022:            cmd  =&gt; fun(#{sock := Sock, local_sa := LSA} = _State) -&gt;
<a name="4023"/> 4023:                            case sock_bind(Sock, LSA) of
<a name="4024"/> 4024:                                ok -&gt;
<a name="4025"/> 4025:                                    ok;
<a name="4026"/> 4026:                                {error, _} = ERROR -&gt;
<a name="4027"/> 4027:                                    ERROR
<a name="4028"/> 4028:                            end
<a name="4029"/> 4029:                    end},
<a name="4030"/> 4030:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="4031"/> 4031:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="4032"/> 4032:                            ?SEV_ANNOUNCE_READY(Tester, init),
<a name="4033"/> 4033:                            ok
<a name="4034"/> 4034:                    end},
<a name="4035"/> 4035: 
<a name="4036"/> 4036:          %% *** The actual test ***
<a name="4037"/> 4037:          #{desc =&gt; &quot;await continue (connect)&quot;,
<a name="4038"/> 4038:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="4039"/> 4039:                            ?SEV_AWAIT_CONTINUE(Tester, tester, connect)
<a name="4040"/> 4040:                    end},
<a name="4041"/> 4041:          #{desc =&gt; &quot;connect to server&quot;,
<a name="4042"/> 4042:            cmd  =&gt; fun(#{sock := Sock, server_sa := SSA}) -&gt;
<a name="4043"/> 4043:                            socket:connect(Sock, SSA)
<a name="4044"/> 4044:                    end},
<a name="4045"/> 4045:          #{desc =&gt; &quot;announce ready (connect)&quot;,
<a name="4046"/> 4046:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="4047"/> 4047:                            ?SEV_ANNOUNCE_READY(Tester, connect),
<a name="4048"/> 4048:                            ok
<a name="4049"/> 4049:                    end},
<a name="4050"/> 4050:          #{desc =&gt; &quot;await continue (send request)&quot;,
<a name="4051"/> 4051:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="4052"/> 4052:                            ?SEV_AWAIT_CONTINUE(Tester, tester, send_req)
<a name="4053"/> 4053:                    end},
<a name="4054"/> 4054:          #{desc =&gt; &quot;send request (to server)&quot;,
<a name="4055"/> 4055:            cmd  =&gt; fun(#{sock := Sock, send := Send}) -&gt;
<a name="4056"/> 4056:                            Send(Sock, ?BASIC_REQ)
<a name="4057"/> 4057:                    end},
<a name="4058"/> 4058:          #{desc =&gt; &quot;announce ready (send request)&quot;,
<a name="4059"/> 4059:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="4060"/> 4060:                            ?SEV_ANNOUNCE_READY(Tester, send_req),
<a name="4061"/> 4061:                            ok
<a name="4062"/> 4062:                    end},
<a name="4063"/> 4063:          #{desc =&gt; &quot;await recv reply (from server)&quot;,
<a name="4064"/> 4064:            cmd  =&gt; fun(#{sock := Sock, recv := Recv}) -&gt;
<a name="4065"/> 4065:                            {ok, ?BASIC_REP} = Recv(Sock),
<a name="4066"/> 4066:                            ok
<a name="4067"/> 4067:                    end},
<a name="4068"/> 4068:          #{desc =&gt; &quot;announce ready (recv reply)&quot;,
<a name="4069"/> 4069:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="4070"/> 4070:                            ?SEV_ANNOUNCE_READY(Tester, recv_reply),
<a name="4071"/> 4071:                            ok
<a name="4072"/> 4072:                    end},
<a name="4073"/> 4073: 
<a name="4074"/> 4074:          %% *** Termination ***
<a name="4075"/> 4075:          #{desc =&gt; &quot;await terminate&quot;,
<a name="4076"/> 4076:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="4077"/> 4077:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="4078"/> 4078:                                ok -&gt;
<a name="4079"/> 4079:                                    {ok, maps:remove(tester, State)};
<a name="4080"/> 4080:                                {error, _} = ERROR -&gt;
<a name="4081"/> 4081:                                    ERROR
<a name="4082"/> 4082:                            end
<a name="4083"/> 4083:                    end},
<a name="4084"/> 4084:          #{desc =&gt; &quot;close socket&quot;,
<a name="4085"/> 4085:            cmd  =&gt; fun(#{domain   := local,
<a name="4086"/> 4086:                          sock     := Sock,
<a name="4087"/> 4087:                          local_sa := #{path := Path}} = State) -&gt;
<a name="4088"/> 4088:                            ok = socket:close(Sock),
<a name="4089"/> 4089:                            State1 =
<a name="4090"/> 4090:                                unlink_path(Path,
<a name="4091"/> 4091:                                            fun() -&gt;
<a name="4092"/> 4092:                                                    maps:remove(local_sa, State)
<a name="4093"/> 4093:                                            end,
<a name="4094"/> 4094:                                            fun() -&gt; State end),
<a name="4095"/> 4095:                            {ok, maps:remove(sock, State1)};
<a name="4096"/> 4096:                       (#{sock := Sock} = State) -&gt;
<a name="4097"/> 4097:                            ok = socket:close(Sock),
<a name="4098"/> 4098:                            {ok, maps:remove(sock, State)}
<a name="4099"/> 4099:                    end},
<a name="4100"/> 4100: 
<a name="4101"/> 4101:          %% *** We are done ***
<a name="4102"/> 4102:          ?SEV_FINISH_NORMAL
<a name="4103"/> 4103:         ],
<a name="4104"/> 4104: 
<a name="4105"/> 4105:     TesterSeq =
<a name="4106"/> 4106:         [
<a name="4107"/> 4107:          %% *** Init part ***
<a name="4108"/> 4108:          #{desc =&gt; &quot;monitor server&quot;,
<a name="4109"/> 4109:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="4110"/> 4110:                            _MRef = erlang:monitor(process, Pid),
<a name="4111"/> 4111:                            ok
<a name="4112"/> 4112:                    end},
<a name="4113"/> 4113:          #{desc =&gt; &quot;monitor client&quot;,
<a name="4114"/> 4114:            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;
<a name="4115"/> 4115:                            _MRef = erlang:monitor(process, Pid),
<a name="4116"/> 4116:                            ok
<a name="4117"/> 4117:                    end},
<a name="4118"/> 4118: 
<a name="4119"/> 4119:          %% Start the server
<a name="4120"/> 4120:          #{desc =&gt; &quot;order server start&quot;,
<a name="4121"/> 4121:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="4122"/> 4122:                            ?SEV_ANNOUNCE_START(Pid),
<a name="4123"/> 4123:                            ok
<a name="4124"/> 4124:                    end},
<a name="4125"/> 4125:          #{desc =&gt; &quot;await server ready (init)&quot;,
<a name="4126"/> 4126:            cmd  =&gt; fun(#{server := Pid} = State) -&gt;
<a name="4127"/> 4127:                            {ok, Port} = ?SEV_AWAIT_READY(Pid, server, init),
<a name="4128"/> 4128:                            {ok, State#{server_port =&gt; Port}}
<a name="4129"/> 4129:                    end},
<a name="4130"/> 4130: 
<a name="4131"/> 4131:          %% Start the client
<a name="4132"/> 4132:          #{desc =&gt; &quot;order client start&quot;,
<a name="4133"/> 4133:            cmd  =&gt; fun(#{client := Pid, server_port := Port} = _State) -&gt;
<a name="4134"/> 4134:                            ?SEV_ANNOUNCE_START(Pid, Port),
<a name="4135"/> 4135:                            ok
<a name="4136"/> 4136:                    end},
<a name="4137"/> 4137:          #{desc =&gt; &quot;await client ready (init)&quot;,
<a name="4138"/> 4138:            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;
<a name="4139"/> 4139:                            ok = ?SEV_AWAIT_READY(Pid, client, init)
<a name="4140"/> 4140:                    end},
<a name="4141"/> 4141: 
<a name="4142"/> 4142:          %% *** The actual test ***
<a name="4143"/> 4143:          #{desc =&gt; &quot;order server to continue (with accept)&quot;,
<a name="4144"/> 4144:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="4145"/> 4145:                            ?SEV_ANNOUNCE_CONTINUE(Server, accept),
<a name="4146"/> 4146:                            ok
<a name="4147"/> 4147:                    end},
<a name="4148"/> 4148:          ?SEV_SLEEP(?SECS(1)),
<a name="4149"/> 4149:          #{desc =&gt; &quot;order client to continue (with connect)&quot;,
<a name="4150"/> 4150:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="4151"/> 4151:                            ?SEV_ANNOUNCE_CONTINUE(Client, connect),
<a name="4152"/> 4152:                            ok
<a name="4153"/> 4153:                    end},
<a name="4154"/> 4154:          #{desc =&gt; &quot;await client ready (connect)&quot;,
<a name="4155"/> 4155:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="4156"/> 4156:                            ?SEV_AWAIT_READY(Client, client, connect)
<a name="4157"/> 4157:                    end},
<a name="4158"/> 4158:          #{desc =&gt; &quot;await server ready (accept)&quot;,
<a name="4159"/> 4159:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="4160"/> 4160:                            ?SEV_AWAIT_READY(Server, server, accept)
<a name="4161"/> 4161:                    end},
<a name="4162"/> 4162:          #{desc =&gt; &quot;order client to continue (with send request)&quot;,
<a name="4163"/> 4163:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="4164"/> 4164:                            ?SEV_ANNOUNCE_CONTINUE(Client, send_req),
<a name="4165"/> 4165:                            ok
<a name="4166"/> 4166:                    end},
<a name="4167"/> 4167:          #{desc =&gt; &quot;await client ready (with send request)&quot;,
<a name="4168"/> 4168:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="4169"/> 4169:                            ?SEV_AWAIT_READY(Client, client, send_req)
<a name="4170"/> 4170:                    end},
<a name="4171"/> 4171:          #{desc =&gt; &quot;await server ready (request recv)&quot;,
<a name="4172"/> 4172:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="4173"/> 4173:                            ?SEV_AWAIT_READY(Server, server, recv_req)
<a name="4174"/> 4174:                    end},
<a name="4175"/> 4175:          #{desc =&gt; &quot;order server to continue (with send reply)&quot;,
<a name="4176"/> 4176:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="4177"/> 4177:                            ?SEV_ANNOUNCE_CONTINUE(Server, send_reply),
<a name="4178"/> 4178:                            ok
<a name="4179"/> 4179:                    end},
<a name="4180"/> 4180:          #{desc =&gt; &quot;await server ready (with reply sent)&quot;,
<a name="4181"/> 4181:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="4182"/> 4182:                            ?SEV_AWAIT_READY(Server, server, send_reply)
<a name="4183"/> 4183:                    end},
<a name="4184"/> 4184:          #{desc =&gt; &quot;await client ready (reply recv)&quot;,
<a name="4185"/> 4185:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="4186"/> 4186:                            ?SEV_AWAIT_READY(Client, client, recv_reply)
<a name="4187"/> 4187:                    end},
<a name="4188"/> 4188: 
<a name="4189"/> 4189: 
<a name="4190"/> 4190:          %% *** Termination ***
<a name="4191"/> 4191:          #{desc =&gt; &quot;order client to terminate&quot;,
<a name="4192"/> 4192:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="4193"/> 4193:                            ?SEV_ANNOUNCE_TERMINATE(Client),
<a name="4194"/> 4194:                            ok
<a name="4195"/> 4195:                    end},
<a name="4196"/> 4196:          #{desc =&gt; &quot;await client termination&quot;,
<a name="4197"/> 4197:            cmd  =&gt; fun(#{client := Client} = State) -&gt;
<a name="4198"/> 4198:                            ?SEV_AWAIT_TERMINATION(Client),
<a name="4199"/> 4199:                            State1 = maps:remove(client, State),
<a name="4200"/> 4200:                            {ok, State1}
<a name="4201"/> 4201:                    end},
<a name="4202"/> 4202:          #{desc =&gt; &quot;order server to terminate&quot;,
<a name="4203"/> 4203:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="4204"/> 4204:                            ?SEV_ANNOUNCE_TERMINATE(Server),
<a name="4205"/> 4205:                            ok
<a name="4206"/> 4206:                    end},
<a name="4207"/> 4207:          #{desc =&gt; &quot;await server termination&quot;,
<a name="4208"/> 4208:            cmd  =&gt; fun(#{server := Server} = State) -&gt;
<a name="4209"/> 4209:                            ?SEV_AWAIT_TERMINATION(Server),
<a name="4210"/> 4210:                            State1 = maps:remove(server, State),
<a name="4211"/> 4211:                            {ok, State1}
<a name="4212"/> 4212:                    end},
<a name="4213"/> 4213: 
<a name="4214"/> 4214:          %% *** We are done ***
<a name="4215"/> 4215:          ?SEV_FINISH_NORMAL
<a name="4216"/> 4216:         ],
<a name="4217"/> 4217: 
<a name="4218"/> 4218:     i(&quot;start server evaluator&quot;),
<a name="4219"/> 4219:     Server = ?SEV_START(&quot;server&quot;, ServerSeq, InitState),
<a name="4220"/> 4220: 
<a name="4221"/> 4221:     i(&quot;start client evaluator&quot;),
<a name="4222"/> 4222:     Client = ?SEV_START(&quot;client&quot;, ClientSeq, InitState),
<a name="4223"/> 4223:     i(&quot;await evaluator(s)&quot;),
<a name="4224"/> 4224: 
<a name="4225"/> 4225:     i(&quot;start tester evaluator&quot;),
<a name="4226"/> 4226:     TesterInitState = #{server =&gt; Server#ev.pid,
<a name="4227"/> 4227:                         client =&gt; Client#ev.pid},
<a name="4228"/> 4228:     Tester = ?SEV_START(&quot;tester&quot;, TesterSeq, TesterInitState),
<a name="4229"/> 4229: 
<a name="api_b_send_and_recv_conn-last_expr"/><a name="4230"/> 4230: <b>    ok = ?SEV_AWAIT_FINISH</b>([Server, Client, Tester]).
<a name="4231"/> 4231: 
<a name="4232"/> 4232: 
<a name="4233"/> 4233: 
<a name="4234"/> 4234: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="4235"/> 4235: 
<a name="4236"/> 4236: <i>%% Basically send and receive on an IPv4 SCTP (seqpacket) socket</i>
<a name="4237"/> 4237: <i>%% using sendmsg and recvmsg.</i>
<a name="api_b_sendmsg_and_recvmsg_sctp4-1"/><a name="4238"/> 4238: <b>api_b_sendmsg_and_recvmsg_sctp4</b>(_Config) when is_list(_Config) -&gt;
<a name="4239"/> 4239:     ?TT(?SECS(5)),
<a name="api_b_sendmsg_and_recvmsg_sctp4-last_expr"/><a name="4240"/> 4240: <b>    tc_try</b>(api_b_sendmsg_and_recvmsg_sctp4,
<a name="4241"/> 4241:            fun() -&gt;
<a name="4242"/> 4242: 		   has_support_sctp(),
<a name="4243"/> 4243: 		   not_yet_implemented()
<a name="4244"/> 4244: 	   end,
<a name="4245"/> 4245:            fun() -&gt;
<a name="4246"/> 4246:                    Send = fun(Sock, Data) -&gt;
<a name="4247"/> 4247:                                   %% CMsg  = #{level =&gt; sctp,
<a name="4248"/> 4248:                                   %%              type  =&gt; tos,
<a name="4249"/> 4249:                                   %%              data  =&gt; reliability},
<a name="4250"/> 4250:                                   %% CMsgs = [CMsg],
<a name="4251"/> 4251:                                   Msg = #{%% ctrl =&gt; CMsgs,
<a name="4252"/> 4252:                                              iov  =&gt; [Data]},
<a name="4253"/> 4253:                                   socket:sendmsg(Sock, Msg)
<a name="4254"/> 4254:                           end,
<a name="4255"/> 4255:                    Recv = fun(Sock) -&gt;
<a name="4256"/> 4256:                                   %% We have some issues on old darwing...
<a name="4257"/> 4257:                                   %% socket:setopt(Sock, otp, debug, true),
<a name="4258"/> 4258:                                   case socket:recvmsg(Sock) of
<a name="4259"/> 4259:                                       {ok, #{addr  := Source,
<a name="4260"/> 4260:                                              iov   := [Data]}} -&gt;
<a name="4261"/> 4261:                                           %% socket:setopt(Sock, otp, debug, false),
<a name="4262"/> 4262:                                           {ok, {Source, Data}};
<a name="4263"/> 4263:                                       {error, _} = ERROR -&gt;
<a name="4264"/> 4264:                                           ERROR
<a name="4265"/> 4265:                                   end
<a name="4266"/> 4266:                           end,
<a name="4267"/> 4267:                    InitState = #{domain =&gt; inet,
<a name="4268"/> 4268:                                  proto  =&gt; sctp,
<a name="4269"/> 4269:                                  send   =&gt; Send,
<a name="4270"/> 4270:                                  recv   =&gt; Recv},
<a name="4271"/> 4271:                    ok = api_b_send_and_recv_sctp(InitState)
<a name="4272"/> 4272:            end).
<a name="4273"/> 4273: 
<a name="4274"/> 4274: 
<a name="4275"/> 4275: 
<a name="4276"/> 4276: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="4277"/> 4277: 
<a name="api_b_send_and_recv_sctp-1"/><a name="4278"/> 4278: <b>api_b_send_and_recv_sctp</b>(_InitState) -&gt;
<a name="4279"/> 4279: <i>%%     Seq = </i>
<a name="4280"/> 4280: <i>%%         [</i>
<a name="4281"/> 4281: <i>%%          #{desc =&gt; &quot;local address&quot;,</i>
<a name="4282"/> 4282: <i>%%            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;</i>
<a name="4283"/> 4283: <i>%%                            LSA = which_local_socket_addr(Domain),</i>
<a name="4284"/> 4284: <i>%%                            {ok, State#{lsa_src =&gt; LSA,</i>
<a name="4285"/> 4285: <i>%%                                        lsa_dst =&gt; LSA}}</i>
<a name="4286"/> 4286: <i>%%                    end},</i>
<a name="4287"/> 4287: 
<a name="4288"/> 4288: <i>%%          #{desc =&gt; &quot;open src socket&quot;,</i>
<a name="4289"/> 4289: <i>%%            cmd  =&gt; fun(#{domain := Domain,</i>
<a name="4290"/> 4290: <i>%%                          proto  := Proto} = State) -&gt;</i>
<a name="4291"/> 4291: <i>%%                            Sock = sock_open(Domain, seqpacket, Proto),</i>
<a name="4292"/> 4292: <i>%%                            {ok, State#{sock_src =&gt; Sock}}</i>
<a name="4293"/> 4293: <i>%%                    end},</i>
<a name="4294"/> 4294: <i>%%          #{desc =&gt; &quot;bind src&quot;,</i>
<a name="4295"/> 4295: <i>%%            cmd  =&gt; fun(#{sock_src := Sock, lsa_src := LSA}) -&gt;</i>
<a name="4296"/> 4296: <i>%%                            case socket:bind(Sock, LSA) of</i>
<a name="4297"/> 4297: <i>%%                                ok -&gt;</i>
<a name="4298"/> 4298: <i>%%                                    ?SEV_IPRINT(&quot;src bound&quot;),</i>
<a name="4299"/> 4299: <i>%%                                    ok;</i>
<a name="4300"/> 4300: <i>%%                                {error, Reason} = ERROR -&gt;</i>
<a name="4301"/> 4301: <i>%%                                    ?SEV_EPRINT(&quot;src bind failed: ~p&quot;, [Reason]),</i>
<a name="4302"/> 4302: <i>%%                                    ERROR</i>
<a name="4303"/> 4303: <i>%%                            end</i>
<a name="4304"/> 4304: <i>%%                    end},</i>
<a name="4305"/> 4305: <i>%%          #{desc =&gt; &quot;sockname src socket&quot;,</i>
<a name="4306"/> 4306: <i>%%            cmd  =&gt; fun(#{sock_src := Sock} = State) -&gt;</i>
<a name="4307"/> 4307: <i>%%                            SASrc = sock_sockname(Sock),</i>
<a name="4308"/> 4308: <i>%%                            ?SEV_IPRINT(&quot;src sockaddr: &quot;</i>
<a name="4309"/> 4309: <i>%%                                        &quot;~n   ~p&quot;, [SASrc]),</i>
<a name="4310"/> 4310: <i>%%                            {ok, State#{sa_src =&gt; SASrc}}</i>
<a name="4311"/> 4311: <i>%%                    end},</i>
<a name="4312"/> 4312: 
<a name="4313"/> 4313: <i>%%          #{desc =&gt; &quot;open dst socket&quot;,</i>
<a name="4314"/> 4314: <i>%%            cmd  =&gt; fun(#{domain := Domain,</i>
<a name="4315"/> 4315: <i>%%                          proto  := Proto} = State) -&gt;</i>
<a name="4316"/> 4316: <i>%%                            Sock = sock_open(Domain, seqpacket, Proto),</i>
<a name="4317"/> 4317: <i>%%                            {ok, State#{sock_dst =&gt; Sock}}</i>
<a name="4318"/> 4318: <i>%%                    end},</i>
<a name="4319"/> 4319: <i>%%          #{desc =&gt; &quot;bind dst&quot;,</i>
<a name="4320"/> 4320: <i>%%            cmd  =&gt; fun(#{sock_dst := Sock, lsa_dst := LSA}) -&gt;</i>
<a name="4321"/> 4321: <i>%%                            case socket:bind(Sock, LSA) of</i>
<a name="4322"/> 4322: <i>%%                                ok -&gt;</i>
<a name="4323"/> 4323: <i>%%                                    ?SEV_IPRINT(&quot;src bound&quot;),</i>
<a name="4324"/> 4324: <i>%%                                    ok;</i>
<a name="4325"/> 4325: <i>%%                                {error, Reason} = ERROR -&gt;</i>
<a name="4326"/> 4326: <i>%%                                    ?SEV_EPRINT(&quot;src bind failed: ~p&quot;, [Reason]),</i>
<a name="4327"/> 4327: <i>%%                                    ERROR</i>
<a name="4328"/> 4328: <i>%%                            end</i>
<a name="4329"/> 4329: <i>%%                    end},</i>
<a name="4330"/> 4330: <i>%%          #{desc =&gt; &quot;sockname dst socket&quot;,</i>
<a name="4331"/> 4331: <i>%%            cmd  =&gt; fun(#{sock_dst := Sock} = State) -&gt;</i>
<a name="4332"/> 4332: <i>%%                            SADst = sock_sockname(Sock),</i>
<a name="4333"/> 4333: <i>%%                            ?SEV_IPRINT(&quot;dst sockaddr: &quot;</i>
<a name="4334"/> 4334: <i>%%                                        &quot;~n   ~p&quot;, [SADst]),</i>
<a name="4335"/> 4335: <i>%%                            {ok, State#{sa_dst =&gt; SADst}}</i>
<a name="4336"/> 4336: <i>%%                    end},</i>
<a name="4337"/> 4337: <i>%%          #{desc =&gt; &quot;send req (to dst)&quot;,</i>
<a name="4338"/> 4338: <i>%%            cmd  =&gt; fun(#{sock_src := Sock, sa_dst := Dst, send := Send}) -&gt;</i>
<a name="4339"/> 4339: <i>%%                            Send(Sock, ?BASIC_REQ, Dst)</i>
<a name="4340"/> 4340: <i>%%                    end},</i>
<a name="4341"/> 4341: <i>%%          #{desc =&gt; &quot;recv req (from src)&quot;,</i>
<a name="4342"/> 4342: <i>%%            cmd  =&gt; fun(#{sock_dst := Sock, sa_src := Src, recv := Recv}) -&gt;</i>
<a name="4343"/> 4343: <i>%%                            case Recv(Sock) of</i>
<a name="4344"/> 4344: <i>%%                                {ok, {Src, ?BASIC_REQ}} -&gt;</i>
<a name="4345"/> 4345: <i>%%                                    ok;</i>
<a name="4346"/> 4346: <i>%%                                {ok, UnexpData} -&gt;</i>
<a name="4347"/> 4347: <i>%%                                    {error, {unexpected_data, UnexpData}};</i>
<a name="4348"/> 4348: <i>%%                                {error, _} = ERROR -&gt;</i>
<a name="4349"/> 4349: <i>%%                                    %% At the moment there is no way to get</i>
<a name="4350"/> 4350: <i>%%                                    %% status or state for the socket...</i>
<a name="4351"/> 4351: <i>%%                                    ERROR</i>
<a name="4352"/> 4352: <i>%%                            end</i>
<a name="4353"/> 4353: <i>%%                    end},</i>
<a name="4354"/> 4354: <i>%%          #{desc =&gt; &quot;send rep (to src)&quot;,</i>
<a name="4355"/> 4355: <i>%%            cmd  =&gt; fun(#{sock_dst := Sock, sa_src := Src, send := Send}) -&gt;</i>
<a name="4356"/> 4356: <i>%%                            Send(Sock, ?BASIC_REP, Src)</i>
<a name="4357"/> 4357: <i>%%                    end},</i>
<a name="4358"/> 4358: <i>%%          #{desc =&gt; &quot;recv rep (from dst)&quot;,</i>
<a name="4359"/> 4359: <i>%%            cmd  =&gt; fun(#{sock_src := Sock, sa_dst := Dst, recv := Recv}) -&gt;</i>
<a name="4360"/> 4360: <i>%%                            case Recv(Sock) of</i>
<a name="4361"/> 4361: <i>%%                                {ok, {Dst, ?BASIC_REP}} -&gt;</i>
<a name="4362"/> 4362: <i>%%                                    ok;</i>
<a name="4363"/> 4363: <i>%%                                {ok, UnexpData} -&gt;</i>
<a name="4364"/> 4364: <i>%%                                    {error, {unexpected_data, UnexpData}};</i>
<a name="4365"/> 4365: <i>%%                                {error, _} = ERROR -&gt;</i>
<a name="4366"/> 4366: <i>%%                                    %% At the moment there is no way to get</i>
<a name="4367"/> 4367: <i>%%                                    %% status or state for the socket...</i>
<a name="4368"/> 4368: <i>%%                                    ERROR</i>
<a name="4369"/> 4369: <i>%%                            end</i>
<a name="4370"/> 4370: <i>%%                    end},</i>
<a name="4371"/> 4371: <i>%%          #{desc =&gt; &quot;close src socket&quot;,</i>
<a name="4372"/> 4372: <i>%%            cmd  =&gt; fun(#{sock_src := Sock} = State) -&gt;</i>
<a name="4373"/> 4373: <i>%%                            ok = socket:close(Sock),</i>
<a name="4374"/> 4374: <i>%%                            {ok, maps:remove(sock_src, State)}</i>
<a name="4375"/> 4375: <i>%%                    end},</i>
<a name="4376"/> 4376: <i>%%          #{desc =&gt; &quot;close dst socket&quot;,</i>
<a name="4377"/> 4377: <i>%%            cmd  =&gt; fun(#{sock_dst := Sock} = State) -&gt;</i>
<a name="4378"/> 4378: <i>%%                            ok = socket:close(Sock),</i>
<a name="4379"/> 4379: <i>%%                            {ok, maps:remove(sock_dst, State)}</i>
<a name="4380"/> 4380: <i>%%                    end},</i>
<a name="4381"/> 4381: 
<a name="4382"/> 4382: <i>%%          %% *** We are done ***</i>
<a name="4383"/> 4383: <i>%%          ?SEV_FINISH_NORMAL</i>
<a name="4384"/> 4384: <i>%%         ],</i>
<a name="4385"/> 4385: <i>%%     Evaluator = ?SEV_START(&quot;tester&quot;, Seq, InitState),</i>
<a name="4386"/> 4386: <i>%%     ok = ?SEV_AWAIT_FINISH([Evaluator]).</i>
<a name="4387"/> 4387: 
<a name="4388"/> 4388: <i>%%     process_flag(trap_exit, true),</i>
<a name="4389"/> 4389: <i>%%     ServerSeq = </i>
<a name="4390"/> 4390: <i>%%         [</i>
<a name="4391"/> 4391: <i>%%          %% *** Wait for start order ***</i>
<a name="4392"/> 4392: <i>%%          #{desc =&gt; &quot;await start (from tester)&quot;,</i>
<a name="4393"/> 4393: <i>%%            cmd  =&gt; fun(State) -&gt;</i>
<a name="4394"/> 4394: <i>%%                            Tester = ?SEV_AWAIT_START(),</i>
<a name="4395"/> 4395: <i>%%                            {ok, State#{tester =&gt; Tester}}</i>
<a name="4396"/> 4396: <i>%%                    end},</i>
<a name="4397"/> 4397: <i>%%          #{desc =&gt; &quot;monitor tester&quot;,</i>
<a name="4398"/> 4398: <i>%%            cmd  =&gt; fun(#{tester := Tester}) -&gt;</i>
<a name="4399"/> 4399: <i>%%                            _MRef = erlang:monitor(process, Tester),</i>
<a name="4400"/> 4400: <i>%%                            ok</i>
<a name="4401"/> 4401: <i>%%                    end},</i>
<a name="4402"/> 4402: 
<a name="4403"/> 4403: <i>%%          %% *** Init part ***</i>
<a name="4404"/> 4404: <i>%%          #{desc =&gt; &quot;which local address&quot;,</i>
<a name="4405"/> 4405: <i>%%            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;</i>
<a name="4406"/> 4406: <i>%%                            LSA = which_local_socket_addr(Domain),</i>
<a name="4407"/> 4407: <i>%%                            {ok, State#{lsa =&gt; LSA}}</i>
<a name="4408"/> 4408: <i>%%                    end},</i>
<a name="4409"/> 4409: <i>%%          #{desc =&gt; &quot;create (listen) socket&quot;,</i>
<a name="4410"/> 4410: <i>%%            cmd  =&gt; fun(#{domain := Domain,</i>
<a name="4411"/> 4411: <i>%%                          proto  := Proto} = State) -&gt;</i>
<a name="4412"/> 4412: <i>%%                            case socket:open(Domain, seqpacket, Proto) of</i>
<a name="4413"/> 4413: <i>%%                                {ok, Sock} -&gt;</i>
<a name="4414"/> 4414: <i>%%                                    {ok, State#{lsock =&gt; Sock}};</i>
<a name="4415"/> 4415: <i>%%                                {error, _} = ERROR -&gt;</i>
<a name="4416"/> 4416: <i>%%                                    ERROR</i>
<a name="4417"/> 4417: <i>%%                            end</i>
<a name="4418"/> 4418: <i>%%                    end},</i>
<a name="4419"/> 4419: <i>%%          #{desc =&gt; &quot;bind to local address&quot;,</i>
<a name="4420"/> 4420: <i>%%            cmd  =&gt; fun(#{lsock := LSock, lsa := LSA} = State) -&gt;</i>
<a name="4421"/> 4421: <i>%%                            case socket:bind(LSock, LSA) of</i>
<a name="4422"/> 4422: <i>%%                                ok -&gt;</i>
<a name="4423"/> 4423: <i>%%                                    Port = sock_port(LSock),</i>
<a name="4424"/> 4424: <i>%%                                    ?SEV_IPRINT(&quot;bound to port: ~w&quot;, [Port]),</i>
<a name="4425"/> 4425: <i>%%                                    {ok, State#{lport =&gt; Port}};</i>
<a name="4426"/> 4426: <i>%%                                {error, _} = ERROR -&gt;</i>
<a name="4427"/> 4427: <i>%%                                    ERROR</i>
<a name="4428"/> 4428: <i>%%                            end</i>
<a name="4429"/> 4429: <i>%%                    end},</i>
<a name="4430"/> 4430: <i>%%          #{desc =&gt; &quot;make listen socket&quot;,</i>
<a name="4431"/> 4431: <i>%%            cmd  =&gt; fun(#{lsock := LSock}) -&gt;</i>
<a name="4432"/> 4432: <i>%%                            socket:listen(LSock)</i>
<a name="4433"/> 4433: <i>%%                    end},</i>
<a name="4434"/> 4434: <i>%%          #{desc =&gt; &quot;announce ready (init)&quot;,</i>
<a name="4435"/> 4435: <i>%%            cmd  =&gt; fun(#{tester := Tester, lport := Port}) -&gt;</i>
<a name="4436"/> 4436: <i>%%                            ?SEV_ANNOUNCE_READY(Tester, init, Port),</i>
<a name="4437"/> 4437: <i>%%                            ok</i>
<a name="4438"/> 4438: <i>%%                    end},</i>
<a name="4439"/> 4439: 
<a name="4440"/> 4440: <i>%%          %% The actual test</i>
<a name="4441"/> 4441: <i>%%          #{desc =&gt; &quot;await continue (accept)&quot;,</i>
<a name="4442"/> 4442: <i>%%            cmd  =&gt; fun(#{tester := Tester}) -&gt;</i>
<a name="4443"/> 4443: <i>%%                            ?SEV_AWAIT_CONTINUE(Tester, tester, accept)</i>
<a name="4444"/> 4444: <i>%%                    end},</i>
<a name="4445"/> 4445: <i>%%          #{desc =&gt; &quot;accepting (await connection) FAKE&quot;,</i>
<a name="4446"/> 4446: <i>%%            cmd  =&gt; fun(#{lsock := LSock} = State) -&gt;</i>
<a name="4447"/> 4447: <i>%% 			   {ok, State#{csock =&gt; LSock}}</i>
<a name="4448"/> 4448: <i>%%                    end},</i>
<a name="4449"/> 4449: <i>%% %%          #{desc =&gt; &quot;accepting (await connection)&quot;,</i>
<a name="4450"/> 4450: <i>%% %%            cmd  =&gt; fun(#{lsock := LSock} = State) -&gt;</i>
<a name="4451"/> 4451: <i>%% %% 			   socket:setopt(LSock, otp, debug, true),</i>
<a name="4452"/> 4452: <i>%% %%                            case socket:accept(LSock) of</i>
<a name="4453"/> 4453: <i>%% %%                                {ok, Sock} -&gt;</i>
<a name="4454"/> 4454: <i>%% %% 				   socket:setopt(LSock, otp, debug, false),</i>
<a name="4455"/> 4455: <i>%% %%                                    ?SEV_IPRINT(&quot;accepted: ~n   ~p&quot;, [Sock]),</i>
<a name="4456"/> 4456: <i>%% %%                                    {ok, State#{csock =&gt; Sock}};</i>
<a name="4457"/> 4457: <i>%% %%                                {error, Reason} = ERROR -&gt;</i>
<a name="4458"/> 4458: <i>%% %% 				   socket:setopt(LSock, otp, debug, false),</i>
<a name="4459"/> 4459: <i>%% %% 				   ?SEV_EPRINT(&quot;Failed accepting: &quot;</i>
<a name="4460"/> 4460: <i>%% %% 					       &quot;~n   ~p&quot;, [Reason]),</i>
<a name="4461"/> 4461: <i>%% %%                                    ERROR</i>
<a name="4462"/> 4462: <i>%% %%                            end</i>
<a name="4463"/> 4463: <i>%% %%                    end},</i>
<a name="4464"/> 4464: <i>%%          #{desc =&gt; &quot;announce ready (accept)&quot;,</i>
<a name="4465"/> 4465: <i>%%            cmd  =&gt; fun(#{tester := Tester}) -&gt;</i>
<a name="4466"/> 4466: <i>%%                            ?SEV_ANNOUNCE_READY(Tester, accept),</i>
<a name="4467"/> 4467: <i>%%                            ok</i>
<a name="4468"/> 4468: <i>%%                    end},</i>
<a name="4469"/> 4469: <i>%%          #{desc =&gt; &quot;await (recv) request&quot;,</i>
<a name="4470"/> 4470: <i>%%            cmd  =&gt; fun(#{csock := Sock, recv := Recv}) -&gt;</i>
<a name="4471"/> 4471: <i>%%                            case Recv(Sock) of</i>
<a name="4472"/> 4472: <i>%%                                {ok, ?BASIC_REQ} -&gt;</i>
<a name="4473"/> 4473: <i>%%                                    ok;</i>
<a name="4474"/> 4474: <i>%%                                {error, _} = ERROR -&gt;</i>
<a name="4475"/> 4475: <i>%%                                    ERROR</i>
<a name="4476"/> 4476: <i>%%                            end</i>
<a name="4477"/> 4477: <i>%%                    end},</i>
<a name="4478"/> 4478: <i>%%          #{desc =&gt; &quot;announce ready (recv request)&quot;,</i>
<a name="4479"/> 4479: <i>%%            cmd  =&gt; fun(#{tester := Tester}) -&gt;</i>
<a name="4480"/> 4480: <i>%%                            ?SEV_ANNOUNCE_READY(Tester, recv_req),</i>
<a name="4481"/> 4481: <i>%%                            ok</i>
<a name="4482"/> 4482: <i>%%                    end},</i>
<a name="4483"/> 4483: <i>%%          #{desc =&gt; &quot;await continue (with send reply)&quot;,</i>
<a name="4484"/> 4484: <i>%%            cmd  =&gt; fun(#{tester := Tester}) -&gt;</i>
<a name="4485"/> 4485: <i>%%                            ?SEV_AWAIT_CONTINUE(Tester, tester, send_reply)</i>
<a name="4486"/> 4486: <i>%%                    end},</i>
<a name="4487"/> 4487: <i>%%          #{desc =&gt; &quot;send reply&quot;,</i>
<a name="4488"/> 4488: <i>%%            cmd  =&gt; fun(#{csock := Sock, send := Send}) -&gt;</i>
<a name="4489"/> 4489: <i>%%                            Send(Sock, ?BASIC_REP)</i>
<a name="4490"/> 4490: <i>%%                    end},</i>
<a name="4491"/> 4491: <i>%%          #{desc =&gt; &quot;announce ready (send reply)&quot;,</i>
<a name="4492"/> 4492: <i>%%            cmd  =&gt; fun(#{tester := Tester}) -&gt;</i>
<a name="4493"/> 4493: <i>%%                            ?SEV_ANNOUNCE_READY(Tester, send_reply),</i>
<a name="4494"/> 4494: <i>%%                            ok</i>
<a name="4495"/> 4495: <i>%%                    end},</i>
<a name="4496"/> 4496: 
<a name="4497"/> 4497: <i>%%          %% *** Termination ***</i>
<a name="4498"/> 4498: <i>%%          #{desc =&gt; &quot;await terminate&quot;,</i>
<a name="4499"/> 4499: <i>%%            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;</i>
<a name="4500"/> 4500: <i>%%                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of</i>
<a name="4501"/> 4501: <i>%%                                ok -&gt;</i>
<a name="4502"/> 4502: <i>%%                                    {ok, maps:remove(tester, State)};</i>
<a name="4503"/> 4503: <i>%%                                {error, _} = ERROR -&gt;</i>
<a name="4504"/> 4504: <i>%%                                    ERROR</i>
<a name="4505"/> 4505: <i>%%                            end</i>
<a name="4506"/> 4506: <i>%%                    end},</i>
<a name="4507"/> 4507: <i>%%          #{desc =&gt; &quot;close connection socket&quot;,</i>
<a name="4508"/> 4508: <i>%%            cmd  =&gt; fun(#{csock := Sock} = State) -&gt;</i>
<a name="4509"/> 4509: <i>%%                            ok = socket:close(Sock),</i>
<a name="4510"/> 4510: <i>%%                            {ok, maps:remove(csock, State)}</i>
<a name="4511"/> 4511: <i>%%                    end},</i>
<a name="4512"/> 4512: <i>%%          #{desc =&gt; &quot;close listen socket&quot;,</i>
<a name="4513"/> 4513: <i>%%            cmd  =&gt; fun(#{lsock := LSock} = State) -&gt;</i>
<a name="4514"/> 4514: <i>%%                            case socket:close(LSock) of</i>
<a name="4515"/> 4515: <i>%%                                ok -&gt;</i>
<a name="4516"/> 4516: <i>%%                                    {ok, maps:remove(lsock, State)};</i>
<a name="4517"/> 4517: <i>%%                                {error, _} = ERROR -&gt;</i>
<a name="4518"/> 4518: <i>%%                                    ERROR</i>
<a name="4519"/> 4519: <i>%%                            end</i>
<a name="4520"/> 4520: <i>%%                    end},</i>
<a name="4521"/> 4521: 
<a name="4522"/> 4522: <i>%%          %% *** We are done ***</i>
<a name="4523"/> 4523: <i>%%          ?SEV_FINISH_NORMAL</i>
<a name="4524"/> 4524: <i>%%         ],</i>
<a name="4525"/> 4525: 
<a name="4526"/> 4526: <i>%%     ClientSeq = </i>
<a name="4527"/> 4527: <i>%%         [</i>
<a name="4528"/> 4528: <i>%%          %% *** Wait for start order ***</i>
<a name="4529"/> 4529: <i>%%          #{desc =&gt; &quot;await start (from tester)&quot;,</i>
<a name="4530"/> 4530: <i>%%            cmd  =&gt; fun(State) -&gt;</i>
<a name="4531"/> 4531: <i>%%                            {Tester, Port} = ?SEV_AWAIT_START(),</i>
<a name="4532"/> 4532: <i>%%                            {ok, State#{tester =&gt; Tester, server_port =&gt; Port}}</i>
<a name="4533"/> 4533: <i>%%                    end},</i>
<a name="4534"/> 4534: <i>%%          #{desc =&gt; &quot;monitor tester&quot;,</i>
<a name="4535"/> 4535: <i>%%            cmd  =&gt; fun(#{tester := Tester}) -&gt;</i>
<a name="4536"/> 4536: <i>%%                            _MRef = erlang:monitor(process, Tester),</i>
<a name="4537"/> 4537: <i>%%                            ok</i>
<a name="4538"/> 4538: <i>%%                    end},</i>
<a name="4539"/> 4539: 
<a name="4540"/> 4540: <i>%%          %% *** The init part ***</i>
<a name="4541"/> 4541: <i>%%          #{desc =&gt; &quot;which server (local) address&quot;,</i>
<a name="4542"/> 4542: <i>%%            cmd  =&gt; fun(#{domain := Domain, server_port := Port} = State) -&gt;</i>
<a name="4543"/> 4543: <i>%%                            LSA = which_local_socket_addr(Domain),</i>
<a name="4544"/> 4544: <i>%%                            SSA = LSA#{port =&gt; Port},</i>
<a name="4545"/> 4545: <i>%%                            {ok, State#{local_sa =&gt; LSA, server_sa =&gt; SSA}}</i>
<a name="4546"/> 4546: <i>%%                    end},</i>
<a name="4547"/> 4547: <i>%%          #{desc =&gt; &quot;create socket&quot;,</i>
<a name="4548"/> 4548: <i>%%            cmd  =&gt; fun(#{domain := Domain,</i>
<a name="4549"/> 4549: <i>%%                          proto  := Proto} = State) -&gt;</i>
<a name="4550"/> 4550: <i>%%                            case socket:open(Domain, seqpacket, Proto) of</i>
<a name="4551"/> 4551: <i>%%                                {ok, Sock} -&gt;</i>
<a name="4552"/> 4552: <i>%%                                    {ok, State#{sock =&gt; Sock}};</i>
<a name="4553"/> 4553: <i>%%                                {error, _} = ERROR -&gt;</i>
<a name="4554"/> 4554: <i>%%                                    ERROR</i>
<a name="4555"/> 4555: <i>%%                            end</i>
<a name="4556"/> 4556: <i>%%                    end},</i>
<a name="4557"/> 4557: <i>%%          #{desc =&gt; &quot;bind to local address&quot;,</i>
<a name="4558"/> 4558: <i>%%            cmd  =&gt; fun(#{sock := Sock, local_sa := LSA} = _State) -&gt;</i>
<a name="4559"/> 4559: <i>%%                            case socket:bind(Sock, LSA) of</i>
<a name="4560"/> 4560: <i>%%                                ok -&gt;</i>
<a name="4561"/> 4561: <i>%%                                    ok;</i>
<a name="4562"/> 4562: <i>%%                                {error, _} = ERROR -&gt;</i>
<a name="4563"/> 4563: <i>%%                                    ERROR</i>
<a name="4564"/> 4564: <i>%%                            end</i>
<a name="4565"/> 4565: <i>%%                    end},</i>
<a name="4566"/> 4566: <i>%%          #{desc =&gt; &quot;announce ready (init)&quot;,</i>
<a name="4567"/> 4567: <i>%%            cmd  =&gt; fun(#{tester := Tester}) -&gt;</i>
<a name="4568"/> 4568: <i>%%                            ?SEV_ANNOUNCE_READY(Tester, init),</i>
<a name="4569"/> 4569: <i>%%                            ok</i>
<a name="4570"/> 4570: <i>%%                    end},</i>
<a name="4571"/> 4571: 
<a name="4572"/> 4572: <i>%%          %% *** The actual test ***</i>
<a name="4573"/> 4573: <i>%%          #{desc =&gt; &quot;await continue (connect)&quot;,</i>
<a name="4574"/> 4574: <i>%%            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;</i>
<a name="4575"/> 4575: <i>%%                            ?SEV_AWAIT_CONTINUE(Tester, tester, connect)</i>
<a name="4576"/> 4576: <i>%%                    end},</i>
<a name="4577"/> 4577: <i>%%          #{desc =&gt; &quot;connect to server&quot;,</i>
<a name="4578"/> 4578: <i>%%            cmd  =&gt; fun(#{sock := Sock, server_sa := SSA}) -&gt;</i>
<a name="4579"/> 4579: <i>%%                            case socket:connect(Sock, SSA) of</i>
<a name="4580"/> 4580: <i>%% 			       ok -&gt;</i>
<a name="4581"/> 4581: <i>%% 				   ?SEV_IPRINT(&quot;connected&quot;),</i>
<a name="4582"/> 4582: <i>%% 				   ok;</i>
<a name="4583"/> 4583: <i>%% 			       {error, Reason} = ERROR -&gt;</i>
<a name="4584"/> 4584: <i>%% 				   ?SEV_EPRINT(&quot;Failed connect: &quot;</i>
<a name="4585"/> 4585: <i>%% 					       &quot;~n   ~p&quot;, [Reason]),</i>
<a name="4586"/> 4586: <i>%% 				   ERROR</i>
<a name="4587"/> 4587: <i>%% 			   end</i>
<a name="4588"/> 4588: <i>%%                    end},</i>
<a name="4589"/> 4589: <i>%%          #{desc =&gt; &quot;announce ready (connect)&quot;,</i>
<a name="4590"/> 4590: <i>%%            cmd  =&gt; fun(#{tester := Tester}) -&gt;</i>
<a name="4591"/> 4591: <i>%%                            ?SEV_ANNOUNCE_READY(Tester, connect),</i>
<a name="4592"/> 4592: <i>%%                            ok</i>
<a name="4593"/> 4593: <i>%%                    end},</i>
<a name="4594"/> 4594: <i>%%          #{desc =&gt; &quot;await continue (send request)&quot;,</i>
<a name="4595"/> 4595: <i>%%            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;</i>
<a name="4596"/> 4596: <i>%%                            ?SEV_AWAIT_CONTINUE(Tester, tester, send_req)</i>
<a name="4597"/> 4597: <i>%%                    end},</i>
<a name="4598"/> 4598: <i>%%          #{desc =&gt; &quot;send request (to server)&quot;,</i>
<a name="4599"/> 4599: <i>%%            cmd  =&gt; fun(#{sock := Sock, send := Send}) -&gt;</i>
<a name="4600"/> 4600: <i>%%                            Send(Sock, ?BASIC_REQ)</i>
<a name="4601"/> 4601: <i>%%                    end},</i>
<a name="4602"/> 4602: <i>%%          #{desc =&gt; &quot;announce ready (send request)&quot;,</i>
<a name="4603"/> 4603: <i>%%            cmd  =&gt; fun(#{tester := Tester}) -&gt;</i>
<a name="4604"/> 4604: <i>%%                            ?SEV_ANNOUNCE_READY(Tester, send_req),</i>
<a name="4605"/> 4605: <i>%%                            ok</i>
<a name="4606"/> 4606: <i>%%                    end},</i>
<a name="4607"/> 4607: <i>%%          #{desc =&gt; &quot;await recv reply (from server)&quot;,</i>
<a name="4608"/> 4608: <i>%%            cmd  =&gt; fun(#{sock := Sock, recv := Recv}) -&gt;</i>
<a name="4609"/> 4609: <i>%%                            {ok, ?BASIC_REP} = Recv(Sock),</i>
<a name="4610"/> 4610: <i>%%                            ok</i>
<a name="4611"/> 4611: <i>%%                    end},</i>
<a name="4612"/> 4612: <i>%%          #{desc =&gt; &quot;announce ready (recv reply)&quot;,</i>
<a name="4613"/> 4613: <i>%%            cmd  =&gt; fun(#{tester := Tester}) -&gt;</i>
<a name="4614"/> 4614: <i>%%                            ?SEV_ANNOUNCE_READY(Tester, recv_reply),</i>
<a name="4615"/> 4615: <i>%%                            ok</i>
<a name="4616"/> 4616: <i>%%                    end},</i>
<a name="4617"/> 4617: 
<a name="4618"/> 4618: <i>%%          %% *** Termination ***</i>
<a name="4619"/> 4619: <i>%%          #{desc =&gt; &quot;await terminate&quot;,</i>
<a name="4620"/> 4620: <i>%%            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;</i>
<a name="4621"/> 4621: <i>%%                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of</i>
<a name="4622"/> 4622: <i>%%                                ok -&gt;</i>
<a name="4623"/> 4623: <i>%%                                    {ok, maps:remove(tester, State)};</i>
<a name="4624"/> 4624: <i>%%                                {error, _} = ERROR -&gt;</i>
<a name="4625"/> 4625: <i>%%                                    ERROR</i>
<a name="4626"/> 4626: <i>%%                            end</i>
<a name="4627"/> 4627: <i>%%                    end},</i>
<a name="4628"/> 4628: <i>%%          #{desc =&gt; &quot;close socket&quot;,</i>
<a name="4629"/> 4629: <i>%%            cmd  =&gt; fun(#{sock := Sock} = State) -&gt;</i>
<a name="4630"/> 4630: <i>%%                            ok = socket:close(Sock),</i>
<a name="4631"/> 4631: <i>%%                            {ok, maps:remove(sock, State)}</i>
<a name="4632"/> 4632: <i>%%                    end},</i>
<a name="4633"/> 4633: 
<a name="4634"/> 4634: <i>%%          %% *** We are done ***</i>
<a name="4635"/> 4635: <i>%%          ?SEV_FINISH_NORMAL</i>
<a name="4636"/> 4636: <i>%%         ],</i>
<a name="4637"/> 4637: 
<a name="4638"/> 4638: <i>%%     TesterSeq =</i>
<a name="4639"/> 4639: <i>%%         [</i>
<a name="4640"/> 4640: <i>%%          %% *** Init part ***</i>
<a name="4641"/> 4641: <i>%%          #{desc =&gt; &quot;monitor server&quot;,</i>
<a name="4642"/> 4642: <i>%%            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;</i>
<a name="4643"/> 4643: <i>%%                            _MRef = erlang:monitor(process, Pid),</i>
<a name="4644"/> 4644: <i>%%                            ok</i>
<a name="4645"/> 4645: <i>%%                    end},</i>
<a name="4646"/> 4646: <i>%%          #{desc =&gt; &quot;monitor client&quot;,</i>
<a name="4647"/> 4647: <i>%%            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;</i>
<a name="4648"/> 4648: <i>%%                            _MRef = erlang:monitor(process, Pid),</i>
<a name="4649"/> 4649: <i>%%                            ok</i>
<a name="4650"/> 4650: <i>%%                    end},</i>
<a name="4651"/> 4651: 
<a name="4652"/> 4652: <i>%%          %% Start the server</i>
<a name="4653"/> 4653: <i>%%          #{desc =&gt; &quot;order server start&quot;,</i>
<a name="4654"/> 4654: <i>%%            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;</i>
<a name="4655"/> 4655: <i>%%                            ?SEV_ANNOUNCE_START(Pid),</i>
<a name="4656"/> 4656: <i>%%                            ok</i>
<a name="4657"/> 4657: <i>%%                    end},</i>
<a name="4658"/> 4658: <i>%%          #{desc =&gt; &quot;await server ready (init)&quot;,</i>
<a name="4659"/> 4659: <i>%%            cmd  =&gt; fun(#{server := Pid} = State) -&gt;</i>
<a name="4660"/> 4660: <i>%%                            {ok, Port} = ?SEV_AWAIT_READY(Pid, server, init),</i>
<a name="4661"/> 4661: <i>%%                            {ok, State#{server_port =&gt; Port}}</i>
<a name="4662"/> 4662: <i>%%                    end},</i>
<a name="4663"/> 4663: 
<a name="4664"/> 4664: <i>%%          %% Start the client</i>
<a name="4665"/> 4665: <i>%%          #{desc =&gt; &quot;order client start&quot;,</i>
<a name="4666"/> 4666: <i>%%            cmd  =&gt; fun(#{client := Pid, server_port := Port} = _State) -&gt;</i>
<a name="4667"/> 4667: <i>%%                            ?SEV_ANNOUNCE_START(Pid, Port),</i>
<a name="4668"/> 4668: <i>%%                            ok</i>
<a name="4669"/> 4669: <i>%%                    end},</i>
<a name="4670"/> 4670: <i>%%          #{desc =&gt; &quot;await client ready (init)&quot;,</i>
<a name="4671"/> 4671: <i>%%            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;</i>
<a name="4672"/> 4672: <i>%%                            ok = ?SEV_AWAIT_READY(Pid, client, init)</i>
<a name="4673"/> 4673: <i>%%                    end},</i>
<a name="4674"/> 4674: 
<a name="4675"/> 4675: <i>%%          %% *** The actual test ***</i>
<a name="4676"/> 4676: <i>%%          #{desc =&gt; &quot;order server to continue (with accept)&quot;,</i>
<a name="4677"/> 4677: <i>%%            cmd  =&gt; fun(#{server := Server} = _State) -&gt;</i>
<a name="4678"/> 4678: <i>%%                            ?SEV_ANNOUNCE_CONTINUE(Server, accept),</i>
<a name="4679"/> 4679: <i>%%                            ok</i>
<a name="4680"/> 4680: <i>%%                    end},</i>
<a name="4681"/> 4681: <i>%%          ?SEV_SLEEP(?SECS(1)),</i>
<a name="4682"/> 4682: <i>%%          #{desc =&gt; &quot;order client to continue (with connect)&quot;,</i>
<a name="4683"/> 4683: <i>%%            cmd  =&gt; fun(#{client := Client} = _State) -&gt;</i>
<a name="4684"/> 4684: <i>%%                            ?SEV_ANNOUNCE_CONTINUE(Client, connect),</i>
<a name="4685"/> 4685: <i>%%                            ok</i>
<a name="4686"/> 4686: <i>%%                    end},</i>
<a name="4687"/> 4687: <i>%%          #{desc =&gt; &quot;await client ready (connect)&quot;,</i>
<a name="4688"/> 4688: <i>%%            cmd  =&gt; fun(#{client := Client} = _State) -&gt;</i>
<a name="4689"/> 4689: <i>%%                            ?SEV_AWAIT_READY(Client, client, connect)</i>
<a name="4690"/> 4690: <i>%%                    end},</i>
<a name="4691"/> 4691: <i>%%          #{desc =&gt; &quot;await server ready (accept)&quot;,</i>
<a name="4692"/> 4692: <i>%%            cmd  =&gt; fun(#{server := Server} = _State) -&gt;</i>
<a name="4693"/> 4693: <i>%%                            ?SEV_AWAIT_READY(Server, server, accept)</i>
<a name="4694"/> 4694: <i>%%                    end},</i>
<a name="4695"/> 4695: <i>%%          #{desc =&gt; &quot;order client to continue (with send request)&quot;,</i>
<a name="4696"/> 4696: <i>%%            cmd  =&gt; fun(#{client := Client} = _State) -&gt;</i>
<a name="4697"/> 4697: <i>%%                            ?SEV_ANNOUNCE_CONTINUE(Client, send_req),</i>
<a name="4698"/> 4698: <i>%%                            ok</i>
<a name="4699"/> 4699: <i>%%                    end},</i>
<a name="4700"/> 4700: <i>%%          #{desc =&gt; &quot;await client ready (with send request)&quot;,</i>
<a name="4701"/> 4701: <i>%%            cmd  =&gt; fun(#{client := Client} = _State) -&gt;</i>
<a name="4702"/> 4702: <i>%%                            ?SEV_AWAIT_READY(Client, client, send_req)</i>
<a name="4703"/> 4703: <i>%%                    end},</i>
<a name="4704"/> 4704: <i>%%          #{desc =&gt; &quot;await server ready (request recv)&quot;,</i>
<a name="4705"/> 4705: <i>%%            cmd  =&gt; fun(#{server := Server} = _State) -&gt;</i>
<a name="4706"/> 4706: <i>%%                            ?SEV_AWAIT_READY(Server, server, recv_req)</i>
<a name="4707"/> 4707: <i>%%                    end},</i>
<a name="4708"/> 4708: <i>%%          #{desc =&gt; &quot;order server to continue (with send reply)&quot;,</i>
<a name="4709"/> 4709: <i>%%            cmd  =&gt; fun(#{server := Server} = _State) -&gt;</i>
<a name="4710"/> 4710: <i>%%                            ?SEV_ANNOUNCE_CONTINUE(Server, send_reply),</i>
<a name="4711"/> 4711: <i>%%                            ok</i>
<a name="4712"/> 4712: <i>%%                    end},</i>
<a name="4713"/> 4713: <i>%%          #{desc =&gt; &quot;await server ready (with reply sent)&quot;,</i>
<a name="4714"/> 4714: <i>%%            cmd  =&gt; fun(#{server := Server} = _State) -&gt;</i>
<a name="4715"/> 4715: <i>%%                            ?SEV_AWAIT_READY(Server, server, send_reply)</i>
<a name="4716"/> 4716: <i>%%                    end},</i>
<a name="4717"/> 4717: <i>%%          #{desc =&gt; &quot;await client ready (reply recv)&quot;,</i>
<a name="4718"/> 4718: <i>%%            cmd  =&gt; fun(#{client := Client} = _State) -&gt;</i>
<a name="4719"/> 4719: <i>%%                            ?SEV_AWAIT_READY(Client, client, recv_reply)</i>
<a name="4720"/> 4720: <i>%%                    end},</i>
<a name="4721"/> 4721: 
<a name="4722"/> 4722: 
<a name="4723"/> 4723: <i>%%          %% *** Termination ***</i>
<a name="4724"/> 4724: <i>%%          #{desc =&gt; &quot;order client to terminate&quot;,</i>
<a name="4725"/> 4725: <i>%%            cmd  =&gt; fun(#{client := Client} = _State) -&gt;</i>
<a name="4726"/> 4726: <i>%%                            ?SEV_ANNOUNCE_TERMINATE(Client),</i>
<a name="4727"/> 4727: <i>%%                            ok</i>
<a name="4728"/> 4728: <i>%%                    end},</i>
<a name="4729"/> 4729: <i>%%          #{desc =&gt; &quot;await client termination&quot;,</i>
<a name="4730"/> 4730: <i>%%            cmd  =&gt; fun(#{client := Client} = State) -&gt;</i>
<a name="4731"/> 4731: <i>%%                            ?SEV_AWAIT_TERMINATION(Client),</i>
<a name="4732"/> 4732: <i>%%                            State1 = maps:remove(client, State),</i>
<a name="4733"/> 4733: <i>%%                            {ok, State1}</i>
<a name="4734"/> 4734: <i>%%                    end},</i>
<a name="4735"/> 4735: <i>%%          #{desc =&gt; &quot;order server to terminate&quot;,</i>
<a name="4736"/> 4736: <i>%%            cmd  =&gt; fun(#{server := Server} = _State) -&gt;</i>
<a name="4737"/> 4737: <i>%%                            ?SEV_ANNOUNCE_TERMINATE(Server),</i>
<a name="4738"/> 4738: <i>%%                            ok</i>
<a name="4739"/> 4739: <i>%%                    end},</i>
<a name="4740"/> 4740: <i>%%          #{desc =&gt; &quot;await server termination&quot;,</i>
<a name="4741"/> 4741: <i>%%            cmd  =&gt; fun(#{server := Server} = State) -&gt;</i>
<a name="4742"/> 4742: <i>%%                            ?SEV_AWAIT_TERMINATION(Server),</i>
<a name="4743"/> 4743: <i>%%                            State1 = maps:remove(server, State),</i>
<a name="4744"/> 4744: <i>%%                            {ok, State1}</i>
<a name="4745"/> 4745: <i>%%                    end},</i>
<a name="4746"/> 4746: 
<a name="4747"/> 4747: <i>%%          %% *** We are done ***</i>
<a name="4748"/> 4748: <i>%%          ?SEV_FINISH_NORMAL</i>
<a name="4749"/> 4749: <i>%%         ],</i>
<a name="4750"/> 4750: 
<a name="4751"/> 4751: <i>%%     i(&quot;start server evaluator&quot;),</i>
<a name="4752"/> 4752: <i>%%     Server = ?SEV_START(&quot;server&quot;, ServerSeq, InitState),</i>
<a name="4753"/> 4753: 
<a name="4754"/> 4754: <i>%%     i(&quot;start client evaluator&quot;),</i>
<a name="4755"/> 4755: <i>%%     Client = ?SEV_START(&quot;client&quot;, ClientSeq, InitState),</i>
<a name="4756"/> 4756: <i>%%     i(&quot;await evaluator(s)&quot;),</i>
<a name="4757"/> 4757: 
<a name="4758"/> 4758: <i>%%     i(&quot;start tester evaluator&quot;),</i>
<a name="4759"/> 4759: <i>%%     TesterInitState = #{server =&gt; Server#ev.pid,</i>
<a name="4760"/> 4760: <i>%%                         client =&gt; Client#ev.pid},</i>
<a name="4761"/> 4761: <i>%%     Tester = ?SEV_START(&quot;tester&quot;, TesterSeq, TesterInitState),</i>
<a name="4762"/> 4762: 
<a name="4763"/> 4763: <i>%%     ok = ?SEV_AWAIT_FINISH([Server, Client, Tester]).</i>
<a name="4764"/> 4764: 
<a name="api_b_send_and_recv_sctp-last_expr"/><a name="4765"/> 4765:     ok.
<a name="4766"/> 4766: 
<a name="4767"/> 4767: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="4768"/> 4768: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="4769"/> 4769: <i>%%                                                                     %%</i>
<a name="4770"/> 4770: <i>%%                           API IOV                                   %%</i>
<a name="4771"/> 4771: <i>%%                                                                     %%</i>
<a name="4772"/> 4772: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="4773"/> 4773: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="4774"/> 4774: 
<a name="api_b_sendmsg_iov_dgram_inet-1"/><a name="4775"/> 4775: <b>api_b_sendmsg_iov_dgram_inet</b>(Config) when is_list(Config) -&gt;
<a name="4776"/> 4776:     has_support_ipv4(),
<a name="api_b_sendmsg_iov_dgram_inet-last_expr"/><a name="4777"/> 4777: <b>    api_b_sendmsg_iov_dgram</b>(inet).
<a name="4778"/> 4778: <i>%%</i>
<a name="api_b_sendmsg_iov_dgram_inet6-1"/><a name="4779"/> 4779: <b>api_b_sendmsg_iov_dgram_inet6</b>(Config) when is_list(Config) -&gt;
<a name="4780"/> 4780:     has_support_ipv6(),
<a name="api_b_sendmsg_iov_dgram_inet6-last_expr"/><a name="4781"/> 4781: <b>    api_b_sendmsg_iov_dgram</b>(inet6).
<a name="4782"/> 4782: <i>%%</i>
<a name="api_b_sendmsg_iov_dgram_local-1"/><a name="4783"/> 4783: <b>api_b_sendmsg_iov_dgram_local</b>(Config) when is_list(Config) -&gt;
<a name="4784"/> 4784:     has_support_unix_domain_socket(),
<a name="4785"/> 4785:     is_not_windows(), % on Windows, local only works for stream sockets
<a name="api_b_sendmsg_iov_dgram_local-last_expr"/><a name="4786"/> 4786: <b>    api_b_sendmsg_iov_dgram</b>(local).
<a name="4787"/> 4787: 
<a name="api_b_sendmsg_iov_stream_inet-1"/><a name="4788"/> 4788: <b>api_b_sendmsg_iov_stream_inet</b>(Config) when is_list(Config) -&gt;
<a name="4789"/> 4789:     has_support_ipv4(),
<a name="4790"/> 4790:     is_not_windows(), % sendmsg does not work on Windows
<a name="api_b_sendmsg_iov_stream_inet-last_expr"/><a name="4791"/> 4791: <b>    api_b_sendmsg_iov_stream</b>(inet).
<a name="4792"/> 4792: <i>%%</i>
<a name="api_b_sendmsg_iov_stream_inet6-1"/><a name="4793"/> 4793: <b>api_b_sendmsg_iov_stream_inet6</b>(Config) when is_list(Config) -&gt;
<a name="4794"/> 4794:     has_support_ipv6(),
<a name="4795"/> 4795:     is_not_windows(), % sendmsg does not work on Windows
<a name="api_b_sendmsg_iov_stream_inet6-last_expr"/><a name="4796"/> 4796: <b>    api_b_sendmsg_iov_stream</b>(inet6).
<a name="4797"/> 4797: <i>%%</i>
<a name="api_b_sendmsg_iov_stream_local-1"/><a name="4798"/> 4798: <b>api_b_sendmsg_iov_stream_local</b>(Config) when is_list(Config) -&gt;
<a name="4799"/> 4799:     has_support_unix_domain_socket(),
<a name="4800"/> 4800:     is_not_windows(), % sendmsg does not work on Windows
<a name="api_b_sendmsg_iov_stream_local-last_expr"/><a name="4801"/> 4801: <b>    api_b_sendmsg_iov_stream</b>(local).
<a name="4802"/> 4802: 
<a name="4803"/> 4803: 
<a name="api_b_sendmsg_iov_dgram-1"/><a name="4804"/> 4804: <b>api_b_sendmsg_iov_dgram</b>(Domain) -&gt;
<a name="4805"/> 4805:     ?P(&quot;api_b_sendmsg_iov_dgram -&gt; entry with&quot;
<a name="4806"/> 4806:        &quot;~n   Domain: ~p&quot;, [Domain]),
<a name="4807"/> 4807:     ?TT(?SECS(5)),
<a name="4808"/> 4808:     #{iov_max := IOVMax} = socket:info(),
<a name="4809"/> 4809:     ?P(&quot;api_b_sendmsg_iov_dgram -&gt; IOVMax: ~p&quot;, [IOVMax]),
<a name="4810"/> 4810:     IOV =
<a name="4811"/> 4811:         lists:map(
<a name="4812"/> 4812:           fun (N) -&gt; &lt;&lt;(rand:uniform(N) - 1)&gt;&gt; end,
<a name="4813"/> 4813:           lists:duplicate(IOVMax, 256)),
<a name="4814"/> 4814:     IOVTooLarge = IOV ++ IOV,
<a name="4815"/> 4815:     Data = erlang:iolist_to_binary(IOV),
<a name="4816"/> 4816:     ?P(&quot;api_b_sendmsg_iov_dgram -&gt; a: create socket&quot;),
<a name="4817"/> 4817:     {ok, Sa} = socket:open(Domain, dgram, #{debug =&gt; true}),
<a name="api_b_sendmsg_iov_dgram-last_expr"/><a name="4818"/> 4818:     try
<a name="4819"/> 4819: 	?P(&quot;api_b_sendmsg_iov_dgram -&gt; b: create socket&quot;),
<a name="4820"/> 4820:         {ok, Sb} = socket:open(Domain, dgram),
<a name="4821"/> 4821:         try
<a name="4822"/> 4822: 	    ?P(&quot;api_b_sendmsg_iov_dgram -&gt; a: bind socket&quot;),
<a name="4823"/> 4823:             ok = socket:bind(Sa, which_local_socket_addr(Domain)),
<a name="4824"/> 4824: 	    ?P(&quot;api_b_sendmsg_iov_dgram -&gt; b: bind socket&quot;),
<a name="4825"/> 4825:             ok = socket:bind(Sb, which_local_socket_addr(Domain)),
<a name="4826"/> 4826: 	    ?P(&quot;api_b_sendmsg_iov_dgram -&gt; a: get sockname&quot;),
<a name="4827"/> 4827:             {ok, Aa} = socket:sockname(Sa),
<a name="4828"/> 4828: 	    ?P(&quot;api_b_sendmsg_iov_dgram -&gt; b: get sockname&quot;),
<a name="4829"/> 4829:             {ok, Ab} = socket:sockname(Sb),
<a name="4830"/> 4830:             %%
<a name="4831"/> 4831: 	    ?P(&quot;api_b_sendmsg_iov_dgram -&gt; a: sendmsg&quot;),
<a name="4832"/> 4832:             ok = socket:sendmsg(Sa, #{addr =&gt; Ab, iov =&gt; IOV}),
<a name="4833"/> 4833: 	    ?P(&quot;api_b_sendmsg_iov_dgram -&gt; b: recvfrom&quot;),
<a name="4834"/> 4834:             {ok, {Aa, Data}} = socket:recvfrom(Sb),
<a name="4835"/> 4835:             %%
<a name="4836"/> 4836: 	    ?P(&quot;api_b_sendmsg_iov_dgram -&gt; b: sendmsg (too large =&gt; fail)&quot;),
<a name="4837"/> 4837:             {error, {invalid, _}} =
<a name="4838"/> 4838:                 socket:sendmsg(Sb, #{addr =&gt; Aa, iov =&gt; IOVTooLarge}),
<a name="4839"/> 4839: 	    ?P(&quot;api_b_sendmsg_iov_dgram -&gt; done&quot;),
<a name="4840"/> 4840:             ok
<a name="4841"/> 4841:         after
<a name="4842"/> 4842: 	    ?P(&quot;api_b_sendmsg_iov_dgram -&gt; b: close socket&quot;),
<a name="4843"/> 4843:             socket:close(Sb)
<a name="4844"/> 4844:         end
<a name="4845"/> 4845:     after
<a name="4846"/> 4846: 	?P(&quot;api_b_sendmsg_iov_dgram -&gt; a: close socket&quot;),
<a name="4847"/> 4847:         socket:close(Sa)
<a name="4848"/> 4848:     end.
<a name="4849"/> 4849: 
<a name="api_b_sendmsg_iov_stream-1"/><a name="4850"/> 4850: <b>api_b_sendmsg_iov_stream</b>(Domain) -&gt;
<a name="4851"/> 4851:     ?P(&quot;api_b_sendmsg_iov_stream -&gt; entry with&quot;
<a name="4852"/> 4852:        &quot;~n   Domain: ~p&quot;, [Domain]),
<a name="4853"/> 4853:     ?TT(?SECS(5)),
<a name="4854"/> 4854:     #{iov_max := IOVMax} = socket:info(),
<a name="4855"/> 4855:     ?P(&quot;api_b_sendmsg_iov_stream -&gt; IOVMax: ~p&quot;, [IOVMax]),
<a name="4856"/> 4856:     IOV =
<a name="4857"/> 4857:         lists:map(
<a name="4858"/> 4858:           fun (N) -&gt; &lt;&lt;(rand:uniform(N) - 1)&gt;&gt; end,
<a name="4859"/> 4859:           lists:duplicate(IOVMax, 256)),
<a name="4860"/> 4860:     IOVTooLarge = IOV ++ IOV,
<a name="4861"/> 4861:     Data = erlang:iolist_to_binary(IOV),
<a name="4862"/> 4862:     DataTooLarge = erlang:iolist_to_binary(IOVTooLarge),
<a name="4863"/> 4863:     ?P(&quot;api_b_sendmsg_iov_stream -&gt; create stream socket a&quot;),
<a name="4864"/> 4864:     {ok, Sa} = socket:open(Domain, stream),
<a name="api_b_sendmsg_iov_stream-last_expr"/><a name="4865"/> 4865:     try
<a name="4866"/> 4866:         case os:type() of
<a name="4867"/> 4867:             {win32,nt} -&gt;
<a name="4868"/> 4868: 		?P(&quot;api_b_sendmsg_iov_stream-&gt; [win] a: bind socket&quot;),
<a name="4869"/> 4869:                 ok = socket:bind(Sa, which_local_socket_addr(Domain));
<a name="4870"/> 4870:             _ -&gt;
<a name="4871"/> 4871:                 ok
<a name="4872"/> 4872:         end,
<a name="4873"/> 4873: 	?P(&quot;api_b_sendmsg_iov_stream -&gt; create stream socket b&quot;),
<a name="4874"/> 4874:         {ok, Sb} = socket:open(Domain, stream),
<a name="4875"/> 4875:         try
<a name="4876"/> 4876: 	    ?P(&quot;api_b_sendmsg_iov_stream -&gt; b: bind socket&quot;),
<a name="4877"/> 4877:             ok = socket:bind(Sb, which_local_socket_addr(Domain)),
<a name="4878"/> 4878: 	    ?P(&quot;api_b_sendmsg_iov_stream -&gt; b: get sockname&quot;),
<a name="4879"/> 4879:             {ok, Ab} = socket:sockname(Sb),
<a name="4880"/> 4880: 	    ?P(&quot;api_b_sendmsg_iov_stream -&gt; b: make socket listen&quot;),
<a name="4881"/> 4881:             ok = socket:listen(Sb),
<a name="4882"/> 4882: 	    ?P(&quot;api_b_sendmsg_iov_stream -&gt; a: connect socket to b&quot;),
<a name="4883"/> 4883:             ok = socket:connect(Sa, Ab),
<a name="4884"/> 4884: 	    ?P(&quot;api_b_sendmsg_iov_stream -&gt; a: get sockname&quot;),
<a name="4885"/> 4885:             {ok, Aa} = socket:sockname(Sa),
<a name="4886"/> 4886: 	    ?P(&quot;api_b_sendmsg_iov_stream -&gt; a: get peername&quot;),
<a name="4887"/> 4887:             {ok, Ab} = socket:peername(Sa),
<a name="4888"/> 4888: 	    ?P(&quot;api_b_sendmsg_iov_stream -&gt; accept connection (=&gt; c)&quot;),
<a name="4889"/> 4889:             {ok, Sc} = socket:accept(Sb),
<a name="4890"/> 4890:             try
<a name="4891"/> 4891: 		?P(&quot;api_b_sendmsg_iov_stream -&gt; c: get sockname&quot;),
<a name="4892"/> 4892:                 {ok, Ab} = socket:sockname(Sc),
<a name="4893"/> 4893: 		?P(&quot;api_b_sendmsg_iov_stream -&gt; c: get peername&quot;),
<a name="4894"/> 4894:                 {ok, Aa} = socket:peername(Sc),
<a name="4895"/> 4895:                 %%
<a name="4896"/> 4896: 		?P(&quot;api_b_sendmsg_iov_stream -&gt; a: sendmsg&quot;),
<a name="4897"/> 4897:                 ok = socket:sendmsg(Sa, #{iov =&gt; IOV}),
<a name="4898"/> 4898: 		?P(&quot;api_b_sendmsg_iov_stream -&gt; c: recv&quot;),
<a name="4899"/> 4899:                 {ok, Data} =
<a name="4900"/> 4900:                     socket:recv(Sc, byte_size(Data)),
<a name="4901"/> 4901: 		?P(&quot;api_b_sendmsg_iov_stream -&gt; c: sendmsg (too large)&quot;),
<a name="4902"/> 4902:                 ok = socket:sendmsg(Sc, #{iov =&gt; IOVTooLarge}),
<a name="4903"/> 4903: 		?P(&quot;api_b_sendmsg_iov_stream -&gt; a: recv&quot;),
<a name="4904"/> 4904:                 {ok, DataTooLarge} =
<a name="4905"/> 4905:                     socket:recv(Sa, byte_size(DataTooLarge)),
<a name="4906"/> 4906: 		?P(&quot;api_b_sendmsg_iov_stream -&gt; done&quot;),
<a name="4907"/> 4907:                 ok
<a name="4908"/> 4908:             catch
<a name="4909"/> 4909:                 error:notsup = Reason:_ -&gt;
<a name="4910"/> 4910: 		    ?P(&quot;api_b_sendmsg_iov_stream -&gt; notsup&quot;),
<a name="4911"/> 4911:                     exit({skip, Reason})
<a name="4912"/> 4912:             after
<a name="4913"/> 4913:                 socket:close(Sc)
<a name="4914"/> 4914:             end
<a name="4915"/> 4915:         after
<a name="4916"/> 4916: 	    ?P(&quot;api_b_sendmsg_iov_stream -&gt; after - b: close socket&quot;),
<a name="4917"/> 4917:             socket:close(Sb)
<a name="4918"/> 4918:         end
<a name="4919"/> 4919:     after
<a name="4920"/> 4920: 	?P(&quot;api_b_sendmsg_iov_stream -&gt; after - a: close socket&quot;),
<a name="4921"/> 4921:         socket:close(Sa)
<a name="4922"/> 4922:     end.
<a name="4923"/> 4923: 
<a name="4924"/> 4924: 
<a name="4925"/> 4925: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="4926"/> 4926: 
<a name="4927"/> 4927: <i>%% Basically connect, send and receive using the &quot;common&quot; functions</i>
<a name="4928"/> 4928: <i>%% (send and recv) on an IPv4 UDP (dgram) socket.</i>
<a name="api_b_dgram_connect_udp4-1"/><a name="4929"/> 4929: <b>api_b_dgram_connect_udp4</b>(_Config) when is_list(_Config) -&gt;
<a name="4930"/> 4930:     ?TT(?SECS(10)),
<a name="api_b_dgram_connect_udp4-last_expr"/><a name="4931"/> 4931: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="4932"/> 4932:            fun() -&gt; has_support_ipv4() end,
<a name="4933"/> 4933:            fun() -&gt;
<a name="4934"/> 4934:                    InitState = #{domain =&gt; inet,
<a name="4935"/> 4935:                                  type   =&gt; dgram,
<a name="4936"/> 4936:                                  proto  =&gt; udp},
<a name="4937"/> 4937:                    ok = api_b_dgram_connect(InitState)
<a name="4938"/> 4938:            end).
<a name="4939"/> 4939: 
<a name="4940"/> 4940: 
<a name="4941"/> 4941: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="4942"/> 4942: 
<a name="4943"/> 4943: <i>%% Basically connect, send and receive using the &quot;common&quot; functions</i>
<a name="4944"/> 4944: <i>%% (send and recv) on an IPv6 UDP (dgram) socket.</i>
<a name="api_b_dgram_connect_udp6-1"/><a name="4945"/> 4945: <b>api_b_dgram_connect_udp6</b>(_Config) when is_list(_Config) -&gt;
<a name="4946"/> 4946:     ?TT(?SECS(10)),
<a name="api_b_dgram_connect_udp6-last_expr"/><a name="4947"/> 4947: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="4948"/> 4948:            fun() -&gt; has_support_ipv6() end,
<a name="4949"/> 4949:            fun() -&gt;
<a name="4950"/> 4950:                    InitState = #{domain =&gt; inet6,
<a name="4951"/> 4951:                                  type   =&gt; dgram,
<a name="4952"/> 4952:                                  proto  =&gt; udp},
<a name="4953"/> 4953:                    ok = api_b_dgram_connect(InitState)
<a name="4954"/> 4954:            end).
<a name="4955"/> 4955: 
<a name="4956"/> 4956: 
<a name="4957"/> 4957: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="4958"/> 4958: 
<a name="api_b_dgram_connect-1"/><a name="4959"/> 4959: <b>api_b_dgram_connect</b>(InitState) -&gt;
<a name="4960"/> 4960:     PeerSeq = 
<a name="4961"/> 4961:         [
<a name="4962"/> 4962:          %% *** Wait for start order part ***
<a name="4963"/> 4963:          #{desc =&gt; &quot;await start (from tester)&quot;,
<a name="4964"/> 4964:            cmd  =&gt; fun(State) -&gt;
<a name="4965"/> 4965:                            Tester = ?SEV_AWAIT_START(),
<a name="4966"/> 4966:                            {ok, State#{tester =&gt; Tester}}
<a name="4967"/> 4967:                    end},
<a name="4968"/> 4968:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="4969"/> 4969:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="4970"/> 4970:                            _MRef = erlang:monitor(process, Tester),
<a name="4971"/> 4971:                            ok
<a name="4972"/> 4972:                    end},
<a name="4973"/> 4973: 
<a name="4974"/> 4974:          %% *** Init part ***
<a name="4975"/> 4975:          #{desc =&gt; &quot;which local address&quot;,
<a name="4976"/> 4976:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="4977"/> 4977:                            LSA = which_local_socket_addr(Domain),
<a name="4978"/> 4978:                            {ok, State#{local_sa =&gt; LSA}}
<a name="4979"/> 4979:                    end},
<a name="4980"/> 4980: 
<a name="4981"/> 4981:          #{desc =&gt; &quot;open&quot;,
<a name="4982"/> 4982:            cmd  =&gt; fun(#{domain := Domain,
<a name="4983"/> 4983:                          type   := Type,
<a name="4984"/> 4984:                          proto  := Protocol} = State) -&gt;
<a name="4985"/> 4985:                            case socket:open(Domain, Type, Protocol) of
<a name="4986"/> 4986:                                {ok, Sock} -&gt;
<a name="4987"/> 4987:                                    {ok, State#{sock =&gt; Sock}};
<a name="4988"/> 4988:                                {error, eprotonosupport = Reason}
<a name="4989"/> 4989:                                  when (Reason =:= epfnosupport)    orelse
<a name="4990"/> 4990:                                       (Reason =:= eprotonosupport) orelse
<a name="4991"/> 4991:                                       (Reason =:= esocktnosupport) -&gt;
<a name="4992"/> 4992:                                    ?SEV_IPRINT(&quot;failed open: ~p =&gt; SKIP&quot;,
<a name="4993"/> 4993:                                                [Reason]),
<a name="4994"/> 4994:                                    {skip, Reason};
<a name="4995"/> 4995:                                {error, _} = ERROR -&gt;
<a name="4996"/> 4996:                                    ERROR
<a name="4997"/> 4997:                            end
<a name="4998"/> 4998:                    end},
<a name="4999"/> 4999: 
<a name="5000"/> 5000:          #{desc =&gt; &quot;bind to local address&quot;,
<a name="5001"/> 5001:            cmd  =&gt; fun(#{domain   := local,
<a name="5002"/> 5002:                          sock     := Sock,
<a name="5003"/> 5003:                          local_sa := LSA} = State) -&gt;
<a name="5004"/> 5004:                            case socket:bind(Sock, LSA) of
<a name="5005"/> 5005:                                ok -&gt;
<a name="5006"/> 5006:                                    {ok, State#{sock_sa =&gt; LSA}};
<a name="5007"/> 5007:                                {error, Reason} = ERROR -&gt;
<a name="5008"/> 5008: 				   ?SEV_EPRINT(&quot;failed binding: &quot;
<a name="5009"/> 5009: 					       &quot;~n   ~p&quot;, [Reason]),
<a name="5010"/> 5010:                                    ERROR
<a name="5011"/> 5011:                            end;
<a name="5012"/> 5012:                       (#{sock := Sock, local_sa := LSA} = State) -&gt;
<a name="5013"/> 5013:                            case sock_bind(Sock, LSA#{port =&gt; 0}) of
<a name="5014"/> 5014:                                ok -&gt;
<a name="5015"/> 5015:                                    Port = sock_port(Sock),
<a name="5016"/> 5016:                                    {ok, State#{sock_sa =&gt; LSA#{port =&gt; Port}}};
<a name="5017"/> 5017:                                {error, _} = ERROR -&gt;
<a name="5018"/> 5018:                                    ERROR
<a name="5019"/> 5019:                            end
<a name="5020"/> 5020:                    end},
<a name="5021"/> 5021: 
<a name="5022"/> 5022:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="5023"/> 5023:            cmd  =&gt; fun(#{tester := Tester, sock_sa := SSA}) -&gt;
<a name="5024"/> 5024:                            ?SEV_ANNOUNCE_READY(Tester, init, SSA),
<a name="5025"/> 5025:                            ok
<a name="5026"/> 5026:                    end},
<a name="5027"/> 5027: 
<a name="5028"/> 5028:          %% The actual test
<a name="5029"/> 5029:          #{desc =&gt; &quot;await continue (peer sa)&quot;,
<a name="5030"/> 5030:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="5031"/> 5031:                            case ?SEV_AWAIT_CONTINUE(Tester, tester, connect) of
<a name="5032"/> 5032:                                {ok, PeerSA} -&gt;
<a name="5033"/> 5033:                                    ?SEV_IPRINT(&quot;Peer SA:&quot;
<a name="5034"/> 5034:                                                &quot;~n   ~p&quot;, [PeerSA]),
<a name="5035"/> 5035:                                    {ok, State#{peer_sa =&gt; PeerSA}};
<a name="5036"/> 5036:                                {error, _} = ERROR -&gt;
<a name="5037"/> 5037:                                    ERROR
<a name="5038"/> 5038:                            end
<a name="5039"/> 5039:                    end},
<a name="5040"/> 5040: 
<a name="5041"/> 5041:          #{desc =&gt; &quot;connect&quot;,
<a name="5042"/> 5042:            cmd  =&gt; fun(#{sock := Sock, peer_sa := PSA}) -&gt;
<a name="5043"/> 5043:                            ?SEV_IPRINT(&quot;try connect&quot;),
<a name="5044"/> 5044:                            socket:connect(Sock, PSA)
<a name="5045"/> 5045:                    end},
<a name="5046"/> 5046: 
<a name="5047"/> 5047:          #{desc =&gt; &quot;announce ready (connected)&quot;,
<a name="5048"/> 5048:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="5049"/> 5049:                            ?SEV_ANNOUNCE_READY(Tester, connected),
<a name="5050"/> 5050:                            ok
<a name="5051"/> 5051:                    end},
<a name="5052"/> 5052: 
<a name="5053"/> 5053:          %% The actual test
<a name="5054"/> 5054:          #{desc =&gt; &quot;await continue (send and recv)&quot;,
<a name="5055"/> 5055:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="5056"/> 5056:                            case ?SEV_AWAIT_CONTINUE(Tester,
<a name="5057"/> 5057:                                                     tester, send_and_recv) of
<a name="5058"/> 5058:                                {ok, Role} -&gt;
<a name="5059"/> 5059:                                    ?SEV_IPRINT(&quot;role: ~p&quot;, [Role]),
<a name="5060"/> 5060:                                    {ok, State#{role =&gt; Role}};
<a name="5061"/> 5061:                                {error, _} = ERROR -&gt;
<a name="5062"/> 5062:                                    ERROR
<a name="5063"/> 5063:                            end
<a name="5064"/> 5064:                    end},
<a name="5065"/> 5065: 
<a name="5066"/> 5066:          #{desc =&gt; &quot;send (client) or recv (server) request&quot;,
<a name="5067"/> 5067:            cmd  =&gt; fun(#{sock := Sock, role := client}) -&gt;
<a name="5068"/> 5068:                            ?SEV_IPRINT(&quot;[client] try send request&quot;),
<a name="5069"/> 5069:                            socket:send(Sock, ?BASIC_REQ);
<a name="5070"/> 5070:                       (#{sock := Sock, role := server}) -&gt;
<a name="5071"/> 5071:                            ?SEV_IPRINT(&quot;[server] try recv request&quot;),
<a name="5072"/> 5072:                            case socket:recv(Sock) of
<a name="5073"/> 5073:                                {ok, ?BASIC_REQ} -&gt;
<a name="5074"/> 5074:                                    ok;
<a name="5075"/> 5075:                                {error, _} = ERROR -&gt;
<a name="5076"/> 5076:                                    ERROR
<a name="5077"/> 5077:                            end
<a name="5078"/> 5078:                    end},
<a name="5079"/> 5079: 
<a name="5080"/> 5080:          #{desc =&gt; &quot;recv (client) send (server) reply&quot;,
<a name="5081"/> 5081:            cmd  =&gt; fun(#{sock := Sock, role := client}) -&gt;
<a name="5082"/> 5082:                            ?SEV_IPRINT(&quot;[client] try recv reply&quot;),
<a name="5083"/> 5083:                            case socket:recv(Sock) of
<a name="5084"/> 5084:                                {ok, ?BASIC_REP} -&gt;
<a name="5085"/> 5085:                                    ok;
<a name="5086"/> 5086:                                {error, _} = ERROR -&gt;
<a name="5087"/> 5087:                                    ERROR
<a name="5088"/> 5088:                            end;
<a name="5089"/> 5089:                       (#{sock := Sock, role := server}) -&gt;
<a name="5090"/> 5090:                            ?SEV_IPRINT(&quot;[server] try send reply&quot;),
<a name="5091"/> 5091:                            socket:send(Sock, ?BASIC_REP)
<a name="5092"/> 5092:                    end},
<a name="5093"/> 5093: 
<a name="5094"/> 5094:          #{desc =&gt; &quot;announce ready (send_and_recv)&quot;,
<a name="5095"/> 5095:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="5096"/> 5096:                            ?SEV_ANNOUNCE_READY(Tester, send_and_recv),
<a name="5097"/> 5097:                            ok
<a name="5098"/> 5098:                    end},
<a name="5099"/> 5099: 
<a name="5100"/> 5100: 
<a name="5101"/> 5101:          %% *** Termination ***
<a name="5102"/> 5102:          #{desc =&gt; &quot;await terminate&quot;,
<a name="5103"/> 5103:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="5104"/> 5104:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="5105"/> 5105:                                ok -&gt;
<a name="5106"/> 5106:                                    {ok, maps:remove(tester, State)};
<a name="5107"/> 5107:                                {error, _} = ERROR -&gt;
<a name="5108"/> 5108:                                    ERROR
<a name="5109"/> 5109:                            end
<a name="5110"/> 5110:                    end},
<a name="5111"/> 5111:          #{desc =&gt; &quot;close socket&quot;,
<a name="5112"/> 5112:            cmd  =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="5113"/> 5113:                            socket:close(Sock),
<a name="5114"/> 5114:                            {ok, maps:remove(sock, State)}
<a name="5115"/> 5115:                    end},
<a name="5116"/> 5116: 
<a name="5117"/> 5117:          %% *** We are done ***
<a name="5118"/> 5118:          ?SEV_FINISH_NORMAL
<a name="5119"/> 5119:         ],
<a name="5120"/> 5120: 
<a name="5121"/> 5121: 
<a name="5122"/> 5122:     TesterSeq =
<a name="5123"/> 5123:         [
<a name="5124"/> 5124:          %% *** Init part ***
<a name="5125"/> 5125:          #{desc =&gt; &quot;monitor peer 1&quot;,
<a name="5126"/> 5126:            cmd  =&gt; fun(#{peer_1 := Pid} = _State) -&gt;
<a name="5127"/> 5127:                            _MRef = erlang:monitor(process, Pid),
<a name="5128"/> 5128:                            ok
<a name="5129"/> 5129:                    end},
<a name="5130"/> 5130:          #{desc =&gt; &quot;monitor peer 2&quot;,
<a name="5131"/> 5131:            cmd  =&gt; fun(#{peer_2 := Pid} = _State) -&gt;
<a name="5132"/> 5132:                            _MRef = erlang:monitor(process, Pid),
<a name="5133"/> 5133:                            ok
<a name="5134"/> 5134:                    end},
<a name="5135"/> 5135: 
<a name="5136"/> 5136:          #{desc =&gt; &quot;order peer 1 start&quot;,
<a name="5137"/> 5137:            cmd  =&gt; fun(#{peer_1 := Pid}) -&gt;
<a name="5138"/> 5138:                            ?SEV_ANNOUNCE_START(Pid)
<a name="5139"/> 5139:                    end},
<a name="5140"/> 5140:          #{desc =&gt; &quot;order peer 2 start&quot;,
<a name="5141"/> 5141:            cmd  =&gt; fun(#{peer_2 := Pid}) -&gt;
<a name="5142"/> 5142:                            ?SEV_ANNOUNCE_START(Pid)
<a name="5143"/> 5143:                    end},
<a name="5144"/> 5144: 
<a name="5145"/> 5145:          #{desc =&gt; &quot;await peer 1 ready (init)&quot;,
<a name="5146"/> 5146:            cmd  =&gt; fun(#{peer_1 := Pid} = State) -&gt;
<a name="5147"/> 5147:                            {ok, PeerSA} = ?SEV_AWAIT_READY(Pid, peer1, init),
<a name="5148"/> 5148:                            {ok, State#{peer_1_sa =&gt; PeerSA}}
<a name="5149"/> 5149:                    end},
<a name="5150"/> 5150:          #{desc =&gt; &quot;await peer 2 ready (init)&quot;,
<a name="5151"/> 5151:            cmd  =&gt; fun(#{peer_2 := Pid} = State) -&gt;
<a name="5152"/> 5152:                            {ok, PeerSA} = ?SEV_AWAIT_READY(Pid, peer2, init),
<a name="5153"/> 5153:                            {ok, State#{peer_2_sa =&gt; PeerSA}}
<a name="5154"/> 5154:                    end},
<a name="5155"/> 5155: 
<a name="5156"/> 5156: 
<a name="5157"/> 5157:          #{desc =&gt; &quot;order peer 1 to continue (with connect)&quot;,
<a name="5158"/> 5158:            cmd  =&gt; fun(#{peer_1 := Pid, peer_2_sa := PeerSA} = _State) -&gt;
<a name="5159"/> 5159:                            ?SEV_ANNOUNCE_CONTINUE(Pid, connect, PeerSA),
<a name="5160"/> 5160:                            ok
<a name="5161"/> 5161:                    end},
<a name="5162"/> 5162:          #{desc =&gt; &quot;order peer 2 to continue (with connect)&quot;,
<a name="5163"/> 5163:            cmd  =&gt; fun(#{peer_2 := Pid, peer_1_sa := PeerSA} = _State) -&gt;
<a name="5164"/> 5164:                            ?SEV_ANNOUNCE_CONTINUE(Pid, connect, PeerSA),
<a name="5165"/> 5165:                            ok
<a name="5166"/> 5166:                    end},
<a name="5167"/> 5167: 
<a name="5168"/> 5168: 
<a name="5169"/> 5169:          #{desc =&gt; &quot;await peer 1 ready (connected)&quot;,
<a name="5170"/> 5170:            cmd  =&gt; fun(#{peer_1 := Pid} = _State) -&gt;
<a name="5171"/> 5171:                            ?SEV_AWAIT_READY(Pid, peer1, connected)
<a name="5172"/> 5172:                    end},
<a name="5173"/> 5173:          #{desc =&gt; &quot;await peer 2 ready (connected)&quot;,
<a name="5174"/> 5174:            cmd  =&gt; fun(#{peer_2 := Pid} = _State) -&gt;
<a name="5175"/> 5175:                            ?SEV_AWAIT_READY(Pid, peer2, connected)
<a name="5176"/> 5176:                    end},
<a name="5177"/> 5177: 
<a name="5178"/> 5178: 
<a name="5179"/> 5179: 
<a name="5180"/> 5180:          %% We should pick one to issue the request
<a name="5181"/> 5181:          %% (and the other is then to *await* the request
<a name="5182"/> 5182:          %%  and respond).
<a name="5183"/> 5183: 
<a name="5184"/> 5184: 
<a name="5185"/> 5185: 
<a name="5186"/> 5186:          #{desc =&gt; &quot;order peer 1 to continue (with send_and_recv)&quot;,
<a name="5187"/> 5187:            cmd  =&gt; fun(#{peer_1 := Pid} = _State) -&gt;
<a name="5188"/> 5188:                            ?SEV_ANNOUNCE_CONTINUE(Pid, send_and_recv, client),
<a name="5189"/> 5189:                            ok
<a name="5190"/> 5190:                    end},
<a name="5191"/> 5191:          #{desc =&gt; &quot;order peer 2 to continue (with send_and_recv)&quot;,
<a name="5192"/> 5192:            cmd  =&gt; fun(#{peer_2 := Pid} = _State) -&gt;
<a name="5193"/> 5193:                            ?SEV_ANNOUNCE_CONTINUE(Pid, send_and_recv, server),
<a name="5194"/> 5194:                            ok
<a name="5195"/> 5195:                    end},
<a name="5196"/> 5196: 
<a name="5197"/> 5197: 
<a name="5198"/> 5198:          #{desc =&gt; &quot;await peer 1 ready (send_and_recv)&quot;,
<a name="5199"/> 5199:            cmd  =&gt; fun(#{peer_1 := Pid} = _State) -&gt;
<a name="5200"/> 5200:                            ?SEV_AWAIT_READY(Pid, peer1, send_and_recv)
<a name="5201"/> 5201:                    end},
<a name="5202"/> 5202:          #{desc =&gt; &quot;await peer 2 ready (send_and_recv)&quot;,
<a name="5203"/> 5203:            cmd  =&gt; fun(#{peer_2 := Pid} = _State) -&gt;
<a name="5204"/> 5204:                            ?SEV_AWAIT_READY(Pid, peer2, send_and_recv)
<a name="5205"/> 5205:                    end},
<a name="5206"/> 5206: 
<a name="5207"/> 5207: 
<a name="5208"/> 5208:          ?SEV_SLEEP(?SECS(1)),
<a name="5209"/> 5209: 
<a name="5210"/> 5210: 
<a name="5211"/> 5211:          %% *** Termination ***
<a name="5212"/> 5212:          #{desc =&gt; &quot;order peer 1 to terminate&quot;,
<a name="5213"/> 5213:            cmd  =&gt; fun(#{peer_1 := Pid} = _State) -&gt;
<a name="5214"/> 5214:                            ?SEV_ANNOUNCE_TERMINATE(Pid),
<a name="5215"/> 5215:                            ok
<a name="5216"/> 5216:                    end},
<a name="5217"/> 5217:          #{desc =&gt; &quot;await peer 1 termination&quot;,
<a name="5218"/> 5218:            cmd  =&gt; fun(#{peer_1 := Pid} = State) -&gt;
<a name="5219"/> 5219:                            ?SEV_AWAIT_TERMINATION(Pid),
<a name="5220"/> 5220:                            State1 = maps:remove(peer_1, State),
<a name="5221"/> 5221:                            {ok, State1}
<a name="5222"/> 5222:                    end},
<a name="5223"/> 5223:          #{desc =&gt; &quot;order peer 2 to terminate&quot;,
<a name="5224"/> 5224:            cmd  =&gt; fun(#{peer_2 := Pid} = _State) -&gt;
<a name="5225"/> 5225:                            ?SEV_ANNOUNCE_TERMINATE(Pid),
<a name="5226"/> 5226:                            ok
<a name="5227"/> 5227:                    end},
<a name="5228"/> 5228:          #{desc =&gt; &quot;await peer 2 termination&quot;,
<a name="5229"/> 5229:            cmd  =&gt; fun(#{peer_2 := Pid} = State) -&gt;
<a name="5230"/> 5230:                            ?SEV_AWAIT_TERMINATION(Pid),
<a name="5231"/> 5231:                            State1 = maps:remove(peer_2, State),
<a name="5232"/> 5232:                            {ok, State1}
<a name="5233"/> 5233:                    end},
<a name="5234"/> 5234: 
<a name="5235"/> 5235: 
<a name="5236"/> 5236:          %% *** We are done ***
<a name="5237"/> 5237:          ?SEV_FINISH_NORMAL
<a name="5238"/> 5238:         ],
<a name="5239"/> 5239: 
<a name="5240"/> 5240: 
<a name="5241"/> 5241:     Peer1  = ?SEV_START(&quot;peer 1&quot;, PeerSeq,   InitState),
<a name="5242"/> 5242:     Peer2  = ?SEV_START(&quot;peer 2&quot;, PeerSeq,   InitState),
<a name="5243"/> 5243:     Tester = ?SEV_START(&quot;tester&quot;, TesterSeq, #{peer_1 =&gt; Peer1#ev.pid,
<a name="5244"/> 5244:                                                peer_2 =&gt; Peer2#ev.pid}),
<a name="api_b_dgram_connect-last_expr"/><a name="5245"/> 5245: <b>    ok = ?SEV_AWAIT_FINISH</b>([Peer1, Peer2, Tester]).
<a name="5246"/> 5246: 
<a name="5247"/> 5247: 
<a name="5248"/> 5248: 
<a name="5249"/> 5249: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="5250"/> 5250: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="5251"/> 5251: <i>%%                                                                     %%</i>
<a name="5252"/> 5252: <i>%%                           API SENDFILE                              %%</i>
<a name="5253"/> 5253: <i>%%                                                                     %%</i>
<a name="5254"/> 5254: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="5255"/> 5255: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="5256"/> 5256: 
<a name="api_sendfile_inet-1"/><a name="5257"/> 5257: <b>api_sendfile_inet</b>(Config) when is_list(Config) -&gt;
<a name="5258"/> 5258:     has_support_sendfile(),
<a name="5259"/> 5259:     has_support_ipv4(),
<a name="api_sendfile_inet-last_expr"/><a name="5260"/> 5260: <b>    api_sendfile</b>(inet, Config, fun socket:sendfile/2).
<a name="5261"/> 5261: 
<a name="api_sendfile_inet6-1"/><a name="5262"/> 5262: <b>api_sendfile_inet6</b>(Config) when is_list(Config) -&gt;
<a name="5263"/> 5263:     has_support_sendfile(),
<a name="5264"/> 5264:     has_support_ipv6(),
<a name="api_sendfile_inet6-last_expr"/><a name="5265"/> 5265: <b>    api_sendfile</b>(inet6, Config, fun socket:sendfile/2).
<a name="5266"/> 5266: 
<a name="api_sendfile_local-1"/><a name="5267"/> 5267: <b>api_sendfile_local</b>(Config) when is_list(Config) -&gt;
<a name="5268"/> 5268:     has_support_sendfile(),
<a name="5269"/> 5269:     has_support_unix_domain_socket(),
<a name="api_sendfile_local-last_expr"/><a name="5270"/> 5270: <b>    api_sendfile</b>(local, Config, fun socket:sendfile/2).
<a name="5271"/> 5271: 
<a name="5272"/> 5272: 
<a name="5273"/> 5273: 
<a name="api_sendfile_loop_inet-1"/><a name="5274"/> 5274: <b>api_sendfile_loop_inet</b>(Config) when is_list(Config) -&gt;
<a name="5275"/> 5275:     has_support_sendfile(),
<a name="5276"/> 5276:     has_support_ipv4(),
<a name="api_sendfile_loop_inet-last_expr"/><a name="5277"/> 5277: <b>    api_sendfile</b>(inet, Config, fun sendfile_loop/2).
<a name="5278"/> 5278: 
<a name="api_sendfile_loop_inet6-1"/><a name="5279"/> 5279: <b>api_sendfile_loop_inet6</b>(Config) when is_list(Config) -&gt;
<a name="5280"/> 5280:     has_support_sendfile(),
<a name="5281"/> 5281:     has_support_ipv6(),
<a name="api_sendfile_loop_inet6-last_expr"/><a name="5282"/> 5282: <b>    api_sendfile</b>(inet6, Config, fun sendfile_loop/2).
<a name="5283"/> 5283: 
<a name="api_sendfile_loop_local-1"/><a name="5284"/> 5284: <b>api_sendfile_loop_local</b>(Config) when is_list(Config) -&gt;
<a name="5285"/> 5285:     has_support_sendfile(),
<a name="5286"/> 5286:     has_support_unix_domain_socket(),
<a name="api_sendfile_loop_local-last_expr"/><a name="5287"/> 5287: <b>    api_sendfile</b>(local, Config, fun sendfile_loop/2).
<a name="5288"/> 5288: 
<a name="5289"/> 5289: 
<a name="sendfile_loop-2"/><a name="5290"/> 5290: <b>sendfile_loop</b>(Sa, F) -&gt;
<a name="sendfile_loop-last_expr"/><a name="5291"/> 5291: <b>    sendfile_loop</b>(Sa, F, 0).
<a name="5292"/> 5292: 
<a name="sendfile_loop-3"/><a name="5293"/> 5293: <b>sendfile_loop</b>(Sa, Cont, Offset) -&gt;
<a name="5294"/> 5294:     SelectHandle = make_ref(),
<a name="sendfile_loop-last_expr"/><a name="5295"/> 5295: <b>    case socket:sendfile</b>(Sa, Cont, Offset, 0, SelectHandle) of
<a name="5296"/> 5296:         {select, Select} -&gt;
<a name="5297"/> 5297:             receive
<a name="5298"/> 5298:                 {'$socket', Sa, select, SelectHandle} -&gt;
<a name="5299"/> 5299:                     case Select of
<a name="5300"/> 5300:                         {{select_info, _, _} = Cont_1, BytesSent} -&gt;
<a name="5301"/> 5301:                             sendfile_loop(Sa, Cont_1, Offset + BytesSent);
<a name="5302"/> 5302:                         {select_info, _, _} = Cont_1 -&gt;
<a name="5303"/> 5303:                             sendfile_loop(Sa, Cont_1, Offset)
<a name="5304"/> 5304:                     end;
<a name="5305"/> 5305:                 {'$socket', Sa, abort, {SelectHandle, Reason}} -&gt;
<a name="5306"/> 5306:                     {error, {Reason, Offset}}
<a name="5307"/> 5307:             end;
<a name="5308"/> 5308:         {ok, BytesSent} -&gt;
<a name="5309"/> 5309:             {ok, Offset + BytesSent};
<a name="5310"/> 5310:         {error, Reason} = Error -&gt;
<a name="5311"/> 5311:             io:format(
<a name="5312"/> 5312:               &quot;sendfile_loop(~p, ~p, ~p) -&gt; ~p.~n&quot;,
<a name="5313"/> 5313:               [Sa, Cont, Offset, Error]),
<a name="5314"/> 5314:             {error, {Reason, Offset}}
<a name="5315"/> 5315:     end.
<a name="5316"/> 5316: 
<a name="5317"/> 5317: 
<a name="5318"/> 5318: 
<a name="api_sendfile-3"/><a name="5319"/> 5319: <b>api_sendfile</b>(Domain, Config, Sendfile) -&gt;
<a name="api_sendfile-last_expr"/><a name="5320"/> 5320: <b>    case proplists:get_value</b>(sendfile_file, Config) of
<a name="5321"/> 5321:         undefined -&gt;
<a name="5322"/> 5322:             {skip, sendfile_not_supported};
<a name="5323"/> 5323:         {File, Size, Data} -&gt;
<a name="5324"/> 5324:             api_sendfile(Domain, File, Size, Data, Sendfile)
<a name="5325"/> 5325:     end.
<a name="5326"/> 5326: 
<a name="api_sendfile-5"/><a name="5327"/> 5327: <b>api_sendfile</b>(Domain, File, Size, Data, Sendfile) -&gt;
<a name="5328"/> 5328:     ?TT(?SECS(10)),
<a name="5329"/> 5329:     TC = self(),
<a name="5330"/> 5330:     BufSize = Size bsr 10, % /1k
<a name="5331"/> 5331:     BindAddr = which_local_socket_addr(Domain),
<a name="5332"/> 5332:     case BindAddr of
<a name="5333"/> 5333:         #{family := local, path := Path} -&gt;
<a name="5334"/> 5334:             _ =
<a name="5335"/> 5335:                 spawn(
<a name="5336"/> 5336:                   fun () -&gt;
<a name="5337"/> 5337:                           Mref = monitor(process, TC),
<a name="5338"/> 5338:                           receive
<a name="5339"/> 5339:                               {'DOWN', Mref, _, _, _} -&gt;
<a name="5340"/> 5340:                                   unlink_path(Path)
<a name="5341"/> 5341:                           end
<a name="5342"/> 5342:                   end),
<a name="5343"/> 5343:             ok;
<a name="5344"/> 5344:         #{family := _} -&gt;
<a name="5345"/> 5345:             ok
<a name="5346"/> 5346:     end,
<a name="5347"/> 5347:     io:format(&quot;BindAddr = ~p~n&quot;, [BindAddr]),
<a name="5348"/> 5348:     {ok, F} = file:open(File, [raw, read, binary]),
<a name="5349"/> 5349:     io:format(&quot;F = ~p~n&quot;, [F]),
<a name="5350"/> 5350:     {ok, L} = socket:open(Domain, stream),
<a name="5351"/> 5351:     io:format(&quot;L = ~p~n&quot;, [L]),
<a name="5352"/> 5352:     ok = socket:bind(L, BindAddr),
<a name="5353"/> 5353:     ok = socket:listen(L),
<a name="5354"/> 5354:     {ok, Addr} = socket:sockname(L),
<a name="5355"/> 5355:     io:format(&quot;Addr = ~p~n&quot;, [Addr]),
<a name="5356"/> 5356:     {ok, Sa} = socket:open(Domain, stream),
<a name="5357"/> 5357:     io:format(&quot;Sa = ~p~n&quot;, [Sa]),
<a name="5358"/> 5358:     ok = socket:setopt(Sa, {socket,sndbuf}, BufSize),
<a name="5359"/> 5359:     ok = socket:connect(Sa, Addr),
<a name="5360"/> 5360:     {ok, Sb} = socket:accept(L),
<a name="5361"/> 5361:     io:format(&quot;Sb = ~p~n&quot;, [Sb]),
<a name="5362"/> 5362:     ok = socket:setopt(Sb, {socket,rcvbuf}, BufSize),
<a name="5363"/> 5363:     Verifyer =
<a name="5364"/> 5364:         spawn_link(
<a name="5365"/> 5365:           fun () -&gt;
<a name="5366"/> 5366:                   TC ! {self(), api_sendfile_verify(Sb, Data, 0)}
<a name="5367"/> 5367:           end),
<a name="5368"/> 5368:     io:format(&quot;Verifyer = ~p~n&quot;, [Verifyer]),
<a name="5369"/> 5369:     %%
<a name="5370"/> 5370:     SendfileResult = Sendfile(Sa, F),
<a name="5371"/> 5371:     io:format(&quot;SendfileResult = ~p~n&quot;, [SendfileResult]),
<a name="5372"/> 5372:     %%
<a name="api_sendfile-last_expr"/><a name="5373"/> 5373:     receive
<a name="5374"/> 5374:         {Verifyer, VerifyerResult} -&gt;
<a name="5375"/> 5375:             io:format(&quot;VerifyerResult = ~p~n&quot;, [VerifyerResult]),
<a name="5376"/> 5376:             case {SendfileResult, VerifyerResult} of
<a name="5377"/> 5377:                 {{ok, Size}, {ok, Size}} -&gt;
<a name="5378"/> 5378:                     ok;
<a name="5379"/> 5379:                 Other -&gt;
<a name="5380"/> 5380:                     ?FAIL({bad_result, Other})
<a name="5381"/> 5381:             end
<a name="5382"/> 5382:     end.
<a name="5383"/> 5383: 
<a name="api_sendfile_verify-3"/><a name="5384"/> 5384: <b>api_sendfile_verify</b>(_S, [], M) -&gt;
<a name="5385"/> 5385:     {ok, M};
<a name="5386"/> 5386: <b>api_sendfile_verify</b>(S, [Block | Data], M) when is_binary(Block) -&gt;
<a name="5387"/> 5387:     api_sendfile_verify_block(S, Data, M, Block, 1);
<a name="5388"/> 5388: <b>api_sendfile_verify</b>(S, [{N, Block} | Data], M) -&gt;
<a name="api_sendfile_verify-last_expr"/><a name="5389"/> 5389: <b>    api_sendfile_verify_block</b>(S, Data, M, Block, N).
<a name="5390"/> 5390: 
<a name="api_sendfile_verify_block-5"/><a name="5391"/> 5391: <b>api_sendfile_verify_block</b>(S, Data, M, Block, N) -&gt;
<a name="api_sendfile_verify_block-last_expr"/><a name="5392"/> 5392:     if
<a name="5393"/> 5393:         0 &lt; N -&gt;
<a name="5394"/> 5394:             ByteSize = byte_size(Block),
<a name="5395"/> 5395:             case socket:recv(S, ByteSize, 2000) of
<a name="5396"/> 5396:                 {ok, Block} -&gt;
<a name="5397"/> 5397:                     api_sendfile_verify_block(
<a name="5398"/> 5398:                       S, Data, M + ByteSize, Block, N - 1);
<a name="5399"/> 5399:                 Other -&gt;
<a name="5400"/> 5400:                     {error_at, M, Other}
<a name="5401"/> 5401:             end;
<a name="5402"/> 5402:         true -&gt;
<a name="5403"/> 5403:             api_sendfile_verify(S, Data, M)
<a name="5404"/> 5404:     end.
<a name="5405"/> 5405: 
<a name="5406"/> 5406: 
<a name="5407"/> 5407: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="5408"/> 5408: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="5409"/> 5409: <i>%%                                                                     %%</i>
<a name="5410"/> 5410: <i>%%                           API FROM FD                               %%</i>
<a name="5411"/> 5411: <i>%%                                                                     %%</i>
<a name="5412"/> 5412: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="5413"/> 5413: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="5414"/> 5414: 
<a name="5415"/> 5415: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="5416"/> 5416: 
<a name="5417"/> 5417: <i>%% Basically open (create) a socket from an already existing </i>
<a name="5418"/> 5418: <i>%% file descriptor (FD) and info of an IPv4 UDP (dgram) socket.</i>
<a name="5419"/> 5419: <i>%% With some extra checks...</i>
<a name="5420"/> 5420: <i>%% IPv4</i>
<a name="5421"/> 5421: <i>%% Without dup</i>
<a name="api_ffd_open_wod_and_info_udp4-1"/><a name="5422"/> 5422: <b>api_ffd_open_wod_and_info_udp4</b>(_Config) when is_list(_Config) -&gt;
<a name="5423"/> 5423:     ?TT(?SECS(5)),
<a name="api_ffd_open_wod_and_info_udp4-last_expr"/><a name="5424"/> 5424: <b>    tc_try</b>(api_ffd_open_wod_and_info_udp4,
<a name="5425"/> 5425:            fun() -&gt; has_support_ipv4() end,
<a name="5426"/> 5426:            fun() -&gt;
<a name="5427"/> 5427:                    InitState = #{domain   =&gt; inet,
<a name="5428"/> 5428:                                  type     =&gt; dgram,
<a name="5429"/> 5429:                                  protocol =&gt; udp,
<a name="5430"/> 5430:                                  dup      =&gt; false},
<a name="5431"/> 5431:                    ok = api_ffd_open_and_info(InitState)
<a name="5432"/> 5432:            end).
<a name="5433"/> 5433: 
<a name="5434"/> 5434: 
<a name="5435"/> 5435: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="5436"/> 5436: 
<a name="5437"/> 5437: <i>%% Basically open (create) a socket from an already existing </i>
<a name="5438"/> 5438: <i>%% file descriptor (FD) and info of an IPv6 UDP (dgram) socket.</i>
<a name="5439"/> 5439: <i>%% With some extra checks...</i>
<a name="5440"/> 5440: <i>%% IPv6</i>
<a name="5441"/> 5441: <i>%% Without dup</i>
<a name="api_ffd_open_wod_and_info_udp6-1"/><a name="5442"/> 5442: <b>api_ffd_open_wod_and_info_udp6</b>(_Config) when is_list(_Config) -&gt;
<a name="5443"/> 5443:     ?TT(?SECS(5)),
<a name="api_ffd_open_wod_and_info_udp6-last_expr"/><a name="5444"/> 5444: <b>    tc_try</b>(api_ffd_open_wod_and_info_udp6,
<a name="5445"/> 5445:            fun() -&gt; has_support_ipv6() end,
<a name="5446"/> 5446:            fun() -&gt;
<a name="5447"/> 5447:                    InitState = #{domain   =&gt; inet6,
<a name="5448"/> 5448:                                  type     =&gt; dgram,
<a name="5449"/> 5449:                                  protocol =&gt; udp,
<a name="5450"/> 5450:                                  dup      =&gt; false},
<a name="5451"/> 5451:                    ok = api_ffd_open_and_info(InitState)
<a name="5452"/> 5452:            end).
<a name="5453"/> 5453: 
<a name="5454"/> 5454: 
<a name="5455"/> 5455: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="5456"/> 5456: 
<a name="5457"/> 5457: <i>%% Basically open (create) a socket from an already existing </i>
<a name="5458"/> 5458: <i>%% file descriptor (FD) and info of an IPv4 UDP (dgram) socket.</i>
<a name="5459"/> 5459: <i>%% With some extra checks...</i>
<a name="5460"/> 5460: <i>%% IPv4</i>
<a name="5461"/> 5461: <i>%% With dup</i>
<a name="api_ffd_open_wd_and_info_udp4-1"/><a name="5462"/> 5462: <b>api_ffd_open_wd_and_info_udp4</b>(_Config) when is_list(_Config) -&gt;
<a name="5463"/> 5463:     ?TT(?SECS(5)),
<a name="api_ffd_open_wd_and_info_udp4-last_expr"/><a name="5464"/> 5464: <b>    tc_try</b>(api_ffd_wd_open_and_info_udp4,
<a name="5465"/> 5465:            fun() -&gt; has_support_ipv4() end,
<a name="5466"/> 5466:            fun() -&gt;
<a name="5467"/> 5467:                    InitState = #{domain   =&gt; inet,
<a name="5468"/> 5468:                                  type     =&gt; dgram,
<a name="5469"/> 5469:                                  protocol =&gt; udp,
<a name="5470"/> 5470:                                  dup      =&gt; true},
<a name="5471"/> 5471:                    ok = api_ffd_open_and_info(InitState)
<a name="5472"/> 5472:            end).
<a name="5473"/> 5473: 
<a name="5474"/> 5474: 
<a name="5475"/> 5475: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="5476"/> 5476: 
<a name="5477"/> 5477: <i>%% Basically open (create) a socket from an already existing </i>
<a name="5478"/> 5478: <i>%% file descriptor (FD) and info of an IPv4 UDP (dgram) socket.</i>
<a name="5479"/> 5479: <i>%% With some extra checks...</i>
<a name="5480"/> 5480: <i>%% IPv6</i>
<a name="5481"/> 5481: <i>%% With dup</i>
<a name="api_ffd_open_wd_and_info_udp6-1"/><a name="5482"/> 5482: <b>api_ffd_open_wd_and_info_udp6</b>(_Config) when is_list(_Config) -&gt;
<a name="5483"/> 5483:     ?TT(?SECS(5)),
<a name="api_ffd_open_wd_and_info_udp6-last_expr"/><a name="5484"/> 5484: <b>    tc_try</b>(api_ffd_wd_open_and_info_udp6,
<a name="5485"/> 5485:            fun() -&gt; has_support_ipv6() end,
<a name="5486"/> 5486:            fun() -&gt;
<a name="5487"/> 5487:                    InitState = #{domain   =&gt; inet,
<a name="5488"/> 5488:                                  type     =&gt; dgram,
<a name="5489"/> 5489:                                  protocol =&gt; udp,
<a name="5490"/> 5490:                                  dup      =&gt; true},
<a name="5491"/> 5491:                    ok = api_ffd_open_and_info(InitState)
<a name="5492"/> 5492:            end).
<a name="5493"/> 5493: 
<a name="5494"/> 5494: 
<a name="5495"/> 5495: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="5496"/> 5496: 
<a name="5497"/> 5497: <i>%% Basically open (create) a socket from an already existing </i>
<a name="5498"/> 5498: <i>%% file descriptor (FD) and info of an IPv4 TCP (stream) socket.</i>
<a name="5499"/> 5499: <i>%% With some extra checks...</i>
<a name="5500"/> 5500: <i>%% IPv6</i>
<a name="5501"/> 5501: <i>%% Without dup</i>
<a name="api_ffd_open_wod_and_info_tcp4-1"/><a name="5502"/> 5502: <b>api_ffd_open_wod_and_info_tcp4</b>(_Config) when is_list(_Config) -&gt;
<a name="5503"/> 5503:     ?TT(?SECS(5)),
<a name="api_ffd_open_wod_and_info_tcp4-last_expr"/><a name="5504"/> 5504: <b>    tc_try</b>(api_ffd_open_wod_and_info_tcp4,
<a name="5505"/> 5505:            fun() -&gt; has_support_ipv4() end,
<a name="5506"/> 5506:            fun() -&gt;
<a name="5507"/> 5507:                    InitState = #{domain   =&gt; inet,
<a name="5508"/> 5508:                                  type     =&gt; stream,
<a name="5509"/> 5509:                                  protocol =&gt; tcp,
<a name="5510"/> 5510:                                  dup      =&gt; false},
<a name="5511"/> 5511:                    ok = api_ffd_open_and_info(InitState)
<a name="5512"/> 5512:            end).
<a name="5513"/> 5513: 
<a name="5514"/> 5514: 
<a name="5515"/> 5515: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="5516"/> 5516: 
<a name="5517"/> 5517: <i>%% Basically open (create) a socket from an already existing </i>
<a name="5518"/> 5518: <i>%% file descriptor (FD) and info of an IPv6 TCP (stream) socket.</i>
<a name="5519"/> 5519: <i>%% With some extra checks...</i>
<a name="5520"/> 5520: <i>%% IPv6</i>
<a name="5521"/> 5521: <i>%% Without dup</i>
<a name="api_ffd_open_wod_and_info_tcp6-1"/><a name="5522"/> 5522: <b>api_ffd_open_wod_and_info_tcp6</b>(_Config) when is_list(_Config) -&gt;
<a name="5523"/> 5523:     ?TT(?SECS(5)),
<a name="api_ffd_open_wod_and_info_tcp6-last_expr"/><a name="5524"/> 5524: <b>    tc_try</b>(api_ffd_open_wod_and_info_tcp6,
<a name="5525"/> 5525:            fun() -&gt; has_support_ipv6() end,
<a name="5526"/> 5526:            fun() -&gt;
<a name="5527"/> 5527:                    InitState = #{domain   =&gt; inet6,
<a name="5528"/> 5528:                                  type     =&gt; stream,
<a name="5529"/> 5529:                                  protocol =&gt; tcp,
<a name="5530"/> 5530:                                  dup      =&gt; false},
<a name="5531"/> 5531:                    ok = api_ffd_open_and_info(InitState)
<a name="5532"/> 5532:            end).
<a name="5533"/> 5533: 
<a name="5534"/> 5534: 
<a name="5535"/> 5535: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="5536"/> 5536: 
<a name="5537"/> 5537: <i>%% Basically open (create) a socket from an already existing </i>
<a name="5538"/> 5538: <i>%% file descriptor (FD) and info of an IPv4 TCP (stream) socket.</i>
<a name="5539"/> 5539: <i>%% With some extra checks...</i>
<a name="5540"/> 5540: <i>%% IPv6</i>
<a name="5541"/> 5541: <i>%% With dup</i>
<a name="api_ffd_open_wd_and_info_tcp4-1"/><a name="5542"/> 5542: <b>api_ffd_open_wd_and_info_tcp4</b>(_Config) when is_list(_Config) -&gt;
<a name="5543"/> 5543:     ?TT(?SECS(5)),
<a name="api_ffd_open_wd_and_info_tcp4-last_expr"/><a name="5544"/> 5544: <b>    tc_try</b>(api_ffd_open_wd_and_info_tcp4,
<a name="5545"/> 5545:            fun() -&gt; has_support_ipv4() end,
<a name="5546"/> 5546:            fun() -&gt;
<a name="5547"/> 5547:                    InitState = #{domain   =&gt; inet,
<a name="5548"/> 5548:                                  type     =&gt; stream,
<a name="5549"/> 5549:                                  protocol =&gt; tcp,
<a name="5550"/> 5550:                                  dup      =&gt; true},
<a name="5551"/> 5551:                    ok = api_ffd_open_and_info(InitState)
<a name="5552"/> 5552:            end).
<a name="5553"/> 5553: 
<a name="5554"/> 5554: 
<a name="5555"/> 5555: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="5556"/> 5556: 
<a name="5557"/> 5557: <i>%% Basically open (create) a socket from an already existing </i>
<a name="5558"/> 5558: <i>%% file descriptor (FD) and info of an IPv6 TCP (stream) socket.</i>
<a name="5559"/> 5559: <i>%% With some extra checks...</i>
<a name="5560"/> 5560: <i>%% IPv6</i>
<a name="5561"/> 5561: <i>%% With dup</i>
<a name="api_ffd_open_wd_and_info_tcp6-1"/><a name="5562"/> 5562: <b>api_ffd_open_wd_and_info_tcp6</b>(_Config) when is_list(_Config) -&gt;
<a name="5563"/> 5563:     ?TT(?SECS(5)),
<a name="api_ffd_open_wd_and_info_tcp6-last_expr"/><a name="5564"/> 5564: <b>    tc_try</b>(api_ffd_open_wd_and_info_tcp6,
<a name="5565"/> 5565:            fun() -&gt; has_support_ipv6() end,
<a name="5566"/> 5566:            fun() -&gt;
<a name="5567"/> 5567:                    InitState = #{domain   =&gt; inet6,
<a name="5568"/> 5568:                                  type     =&gt; stream,
<a name="5569"/> 5569:                                  protocol =&gt; tcp,
<a name="5570"/> 5570:                                  dup      =&gt; true},
<a name="5571"/> 5571:                    ok = api_ffd_open_and_info(InitState)
<a name="5572"/> 5572:            end).
<a name="5573"/> 5573: 
<a name="5574"/> 5574: 
<a name="5575"/> 5575: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="5576"/> 5576: 
<a name="api_ffd_open_and_info-1"/><a name="5577"/> 5577: <b>api_ffd_open_and_info</b>(InitState) -&gt;
<a name="5578"/> 5578:     Seq = 
<a name="5579"/> 5579:         [
<a name="5580"/> 5580:          #{desc =&gt; &quot;open&quot;,
<a name="5581"/> 5581:            cmd  =&gt; fun(#{domain   := Domain,
<a name="5582"/> 5582:                          type     := Type,
<a name="5583"/> 5583:                          protocol := Protocol} = State) -&gt; 
<a name="5584"/> 5584:                            case socket:open(Domain, Type, Protocol) of
<a name="5585"/> 5585:                                {ok, Sock1} -&gt;
<a name="5586"/> 5586:                                    {ok, State#{sock1 =&gt; Sock1}};
<a name="5587"/> 5587:                                {error, _} = ERROR -&gt;
<a name="5588"/> 5588:                                    ERROR
<a name="5589"/> 5589:                            end
<a name="5590"/> 5590:                    end},
<a name="5591"/> 5591:          #{desc =&gt; &quot;get socket (1) FD&quot;,
<a name="5592"/> 5592:            cmd  =&gt; fun(#{sock1 := Sock1} = State) -&gt;
<a name="5593"/> 5593:                            case socket:getopt(Sock1, otp, fd) of
<a name="5594"/> 5594:                                {ok, FD} -&gt;
<a name="5595"/> 5595:                                    ?SEV_IPRINT(&quot;FD: ~w&quot;, [FD]),
<a name="5596"/> 5596:                                    {ok, State#{fd =&gt; FD}};
<a name="5597"/> 5597:                                {error, Reason} = ERROR -&gt;
<a name="5598"/> 5598:                                    ?SEV_EPRINT(&quot;failed get FD: &quot;
<a name="5599"/> 5599:                                                &quot;~n   ~p&quot;, [Reason]),
<a name="5600"/> 5600:                                    ERROR
<a name="5601"/> 5601:                            end
<a name="5602"/> 5602:                    end},
<a name="5603"/> 5603:          #{desc =&gt; &quot;check if we need to provide protocol or not&quot;,
<a name="5604"/> 5604:            cmd  =&gt; fun(#{sock1 := Sock1} = State) -&gt;
<a name="5605"/> 5605:                            case socket:getopt(Sock1, socket, protocol) of
<a name="5606"/> 5606:                                {ok, _} -&gt;
<a name="5607"/> 5607:                                    ?SEV_IPRINT(&quot;protocol accessible&quot;),
<a name="5608"/> 5608:                                    {ok, State#{provide_protocol =&gt; false}};
<a name="5609"/> 5609:                                {error, Reason} -&gt;
<a name="5610"/> 5610:                                    ?SEV_IPRINT(&quot;failed get protocol: &quot;
<a name="5611"/> 5611:                                                &quot;~n   ~p&quot;, [Reason]),
<a name="5612"/> 5612:                                    {ok, State#{provide_protocol =&gt; true}}
<a name="5613"/> 5613:                            end
<a name="5614"/> 5614:                    end},
<a name="5615"/> 5615:          #{desc =&gt; &quot;open with FD&quot;,
<a name="5616"/> 5616:            cmd  =&gt; fun(#{fd               := FD,
<a name="5617"/> 5617:                          dup              := DUP,
<a name="5618"/> 5618:                          provide_protocol := true,
<a name="5619"/> 5619:                          protocol         := Protocol} = State) -&gt; 
<a name="5620"/> 5620:                            case socket:open(FD, #{dup      =&gt; DUP,
<a name="5621"/> 5621:                                                   protocol =&gt; Protocol}) of
<a name="5622"/> 5622:                                {ok, Sock2} -&gt;
<a name="5623"/> 5623:                                    ?SEV_IPRINT(&quot;socket 2 open&quot;),
<a name="5624"/> 5624:                                    {ok, State#{sock2 =&gt; Sock2}};
<a name="5625"/> 5625:                                {error, Reason} = ERROR -&gt;
<a name="5626"/> 5626:                                    ?SEV_EPRINT(&quot;failed open socket with FD (~w): &quot;
<a name="5627"/> 5627:                                                &quot;~n   ~p&quot;, [FD, Reason]),
<a name="5628"/> 5628:                                    ERROR
<a name="5629"/> 5629:                            end;
<a name="5630"/> 5630:                       (#{fd               := FD,
<a name="5631"/> 5631:                          dup              := DUP,
<a name="5632"/> 5632:                          provide_protocol := false} = State) -&gt; 
<a name="5633"/> 5633:                            case socket:open(FD, #{dup =&gt; DUP}) of
<a name="5634"/> 5634:                                {ok, Sock2} -&gt;
<a name="5635"/> 5635:                                    ?SEV_IPRINT(&quot;socket 2 open&quot;),
<a name="5636"/> 5636:                                    {ok, State#{sock2 =&gt; Sock2}};
<a name="5637"/> 5637:                                {error, Reason} = ERROR -&gt;
<a name="5638"/> 5638:                                    ?SEV_EPRINT(&quot;failed open socket with FD (~w): &quot;
<a name="5639"/> 5639:                                                &quot;~n   ~p&quot;, [FD, Reason]),
<a name="5640"/> 5640:                                    ERROR
<a name="5641"/> 5641:                            end
<a name="5642"/> 5642:                    end},
<a name="5643"/> 5643:          #{desc =&gt; &quot;get socket (1) info&quot;,
<a name="5644"/> 5644:            cmd  =&gt; fun(#{sock1 := Sock} = State) -&gt;
<a name="5645"/> 5645:                            %% socket:setopt(Sock, otp, debug, true),
<a name="5646"/> 5646:                            Info = socket:info(Sock),
<a name="5647"/> 5647:                            %% socket:setopt(Sock, otp, debug, false),
<a name="5648"/> 5648:                            ?SEV_IPRINT(&quot;Got Info: &quot;
<a name="5649"/> 5649:                                        &quot;~n   ~p&quot;, [Info]),
<a name="5650"/> 5650:                            {ok, State#{info1 =&gt; Info}}
<a name="5651"/> 5651:                    end},
<a name="5652"/> 5652:          #{desc =&gt; &quot;get socket (2) info&quot;,
<a name="5653"/> 5653:            cmd  =&gt; fun(#{sock2 := Sock} = State) -&gt;
<a name="5654"/> 5654:                            %% socket:setopt(Sock, otp, debug, true),
<a name="5655"/> 5655:                            Info = socket:info(Sock),
<a name="5656"/> 5656:                            %% socket:setopt(Sock, otp, debug, false),
<a name="5657"/> 5657:                            ?SEV_IPRINT(&quot;Got Info: &quot;
<a name="5658"/> 5658:                                        &quot;~n   ~p&quot;, [Info]),
<a name="5659"/> 5659:                            {ok, State#{info2 =&gt; Info}}
<a name="5660"/> 5660:                    end},
<a name="5661"/> 5661:          #{desc =&gt; &quot;validate socket (1) info&quot;,
<a name="5662"/> 5662:            cmd  =&gt; fun(#{domain   := Domain,
<a name="5663"/> 5663:                          type     := Type,
<a name="5664"/> 5664:                          protocol := Protocol,
<a name="5665"/> 5665:                          info1    := #{domain        := Domain,
<a name="5666"/> 5666:                                        type          := Type,
<a name="5667"/> 5667:                                        protocol      := Protocol,
<a name="5668"/> 5668:                                        ctype         := normal,
<a name="5669"/> 5669:                                        counters      := _,
<a name="5670"/> 5670:                                        num_readers   := 0,
<a name="5671"/> 5671:                                        num_writers   := 0,
<a name="5672"/> 5672:                                        num_acceptors := 0}}) -&gt;
<a name="5673"/> 5673:                            ok;
<a name="5674"/> 5674:                       (#{domain   := Domain,
<a name="5675"/> 5675:                          type     := Type,
<a name="5676"/> 5676:                          protocol := Protocol,
<a name="5677"/> 5677:                          info     := Info}) -&gt;
<a name="5678"/> 5678:                            ?SEV_EPRINT(&quot;Unexpected Info for socket 1: &quot;
<a name="5679"/> 5679:                                        &quot;~n   (expected) Domain:      ~p&quot;
<a name="5680"/> 5680:                                        &quot;~n   (expected) Type:        ~p&quot;
<a name="5681"/> 5681:                                        &quot;~n   (expected) Protocol:    ~p&quot;
<a name="5682"/> 5682:                                        &quot;~n   (expected) Create Type: ~p&quot;
<a name="5683"/> 5683:                                        &quot;~n   ~p&quot;,
<a name="5684"/> 5684:                                        [Domain, Type, Protocol, normal, Info]),
<a name="5685"/> 5685:                            {error, unexpected_infio}
<a name="5686"/> 5686:                    end},
<a name="5687"/> 5687:          #{desc =&gt; &quot;validate socket (2) info&quot;,
<a name="5688"/> 5688:            cmd  =&gt; fun(#{domain   := Domain,
<a name="5689"/> 5689:                          type     := Type,
<a name="5690"/> 5690:                          protocol := Protocol,
<a name="5691"/> 5691:                          fd       := _FD,
<a name="5692"/> 5692:                          dup      := false,
<a name="5693"/> 5693:                          info2    := #{domain        := Domain,
<a name="5694"/> 5694:                                        type          := Type,
<a name="5695"/> 5695:                                        protocol      := Protocol,
<a name="5696"/> 5696:                                        ctype         := fromfd,
<a name="5697"/> 5697:                                        counters      := _,
<a name="5698"/> 5698:                                        num_readers   := 0,
<a name="5699"/> 5699:                                        num_writers   := 0,
<a name="5700"/> 5700:                                        num_acceptors := 0}}) -&gt;
<a name="5701"/> 5701:                            ok;
<a name="5702"/> 5702:                       (#{domain   := Domain,
<a name="5703"/> 5703:                          type     := Type,
<a name="5704"/> 5704:                          protocol := Protocol,
<a name="5705"/> 5705:                          fd       := _FD,
<a name="5706"/> 5706:                          dup      := false,
<a name="5707"/> 5707:                          info     := Info}) -&gt;
<a name="5708"/> 5708:                            ?SEV_EPRINT(&quot;Unexpected Info for socket 2: &quot;
<a name="5709"/> 5709:                                        &quot;~n   (expected) Domain:      ~p&quot;
<a name="5710"/> 5710:                                        &quot;~n   (expected) Type:        ~p&quot;
<a name="5711"/> 5711:                                        &quot;~n   (expected) Protocol:    ~p&quot;
<a name="5712"/> 5712:                                        &quot;~n   (expected) Create Type: ~p&quot;
<a name="5713"/> 5713:                                        &quot;~n   ~p&quot;,
<a name="5714"/> 5714:                                        [Domain, Type, Protocol,
<a name="5715"/> 5715:                                         fromfd, Info]),
<a name="5716"/> 5716:                            {error, unexpected_info};
<a name="5717"/> 5717:                       (#{domain   := Domain,
<a name="5718"/> 5718:                          type     := Type,
<a name="5719"/> 5719:                          protocol := Protocol,
<a name="5720"/> 5720:                          fd       := FD,
<a name="5721"/> 5721:                          dup      := true,
<a name="5722"/> 5722:                          info2    := #{domain        := Domain,
<a name="5723"/> 5723:                                        type          := Type,
<a name="5724"/> 5724:                                        protocol      := Protocol,
<a name="5725"/> 5725:                                        ctype         := {fromfd, FD},
<a name="5726"/> 5726:                                        counters      := _,
<a name="5727"/> 5727:                                        num_readers   := 0,
<a name="5728"/> 5728:                                        num_writers   := 0,
<a name="5729"/> 5729:                                        num_acceptors := 0}}) -&gt;
<a name="5730"/> 5730:                            ok;
<a name="5731"/> 5731:                       (#{domain   := Domain,
<a name="5732"/> 5732:                          type     := Type,
<a name="5733"/> 5733:                          protocol := Protocol,
<a name="5734"/> 5734:                          fd       := FD,
<a name="5735"/> 5735:                          dup      := true,
<a name="5736"/> 5736:                          info     := Info}) -&gt;
<a name="5737"/> 5737:                            ?SEV_EPRINT(&quot;Unexpected Info for socket 2: &quot;
<a name="5738"/> 5738:                                        &quot;~n   (expected) Domain:      ~p&quot;
<a name="5739"/> 5739:                                        &quot;~n   (expected) Type:        ~p&quot;
<a name="5740"/> 5740:                                        &quot;~n   (expected) Protocol:    ~p&quot;
<a name="5741"/> 5741:                                        &quot;~n   (expected) Create Type: ~p&quot;
<a name="5742"/> 5742:                                        &quot;~n   ~p&quot;,
<a name="5743"/> 5743:                                        [Domain, Type, Protocol,
<a name="5744"/> 5744:                                         {fromfd, FD}, Info]),
<a name="5745"/> 5745:                            {error, unexpected_info}
<a name="5746"/> 5746:                    end},
<a name="5747"/> 5747:          #{desc =&gt; &quot;close socket (1)&quot;,
<a name="5748"/> 5748:            cmd  =&gt; fun(#{sock1 := Sock} = _State) -&gt;
<a name="5749"/> 5749:                            socket:close(Sock)
<a name="5750"/> 5750:                    end},
<a name="5751"/> 5751:          #{desc =&gt; &quot;close socket (2)&quot;,
<a name="5752"/> 5752:            cmd  =&gt; fun(#{sock2 := Sock} = _State) -&gt;
<a name="5753"/> 5753:                            socket:close(Sock)
<a name="5754"/> 5754:                    end},
<a name="5755"/> 5755: 
<a name="5756"/> 5756:          %% *** We are done ***
<a name="5757"/> 5757:          ?SEV_FINISH_NORMAL
<a name="5758"/> 5758:         ],
<a name="5759"/> 5759:     Evaluator = ?SEV_START(&quot;tester&quot;, Seq, InitState),
<a name="api_ffd_open_and_info-last_expr"/><a name="5760"/> 5760: <b>    ok = ?SEV_AWAIT_FINISH</b>([Evaluator]).
<a name="5761"/> 5761: 
<a name="5762"/> 5762: 
<a name="5763"/> 5763: 
<a name="5764"/> 5764: 
<a name="5765"/> 5765: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="5766"/> 5766: 
<a name="5767"/> 5767: <i>%% Basically open a socket (1) and then create another socket (2) from</i>
<a name="5768"/> 5768: <i>%% its file descriptor *without* dup.</i>
<a name="5769"/> 5769: <i>%% Exchange some data from via both &quot;client&quot; sockets.</i>
<a name="5770"/> 5770: <i>%% Finally close the second socket. Ensure that the original socket</i>
<a name="5771"/> 5771: <i>%% has not been closed (test by sending some data).</i>
<a name="5772"/> 5772: <i>%% IPv4 UDP (dgram) socket.</i>
<a name="5773"/> 5773: <i>%%</i>
<a name="5774"/> 5774: <i>%% &lt;WARNING&gt;</i>
<a name="5775"/> 5775: <i>%%</i>
<a name="5776"/> 5776: <i>%% This is *not* how its intended to be used.</i>
<a name="5777"/> 5777: <i>%% That an erlang process creating a socket and then handing over the</i>
<a name="5778"/> 5778: <i>%% file descriptor to another erlang process. *But* its a convient way</i>
<a name="5779"/> 5779: <i>%% to test it!</i>
<a name="5780"/> 5780: <i>%%</i>
<a name="5781"/> 5781: <i>%% &lt;/WARNING&gt;</i>
<a name="5782"/> 5782: <i>%%</i>
<a name="api_ffd_open_and_open_wod_and_send_udp4-1"/><a name="5783"/> 5783: <b>api_ffd_open_and_open_wod_and_send_udp4</b>(_Config) when is_list(_Config) -&gt;
<a name="5784"/> 5784:     ?TT(?SECS(5)),
<a name="api_ffd_open_and_open_wod_and_send_udp4-last_expr"/><a name="5785"/> 5785: <b>    tc_try</b>(api_ffd_open_and_open_wod_and_send_udp4,
<a name="5786"/> 5786:            fun() -&gt; has_support_ipv4() end,
<a name="5787"/> 5787:            fun() -&gt;
<a name="5788"/> 5788:                    InitState = #{domain   =&gt; inet,
<a name="5789"/> 5789:                                  type     =&gt; dgram,
<a name="5790"/> 5790:                                  protocol =&gt; udp,
<a name="5791"/> 5791:                                  dup      =&gt; false},
<a name="5792"/> 5792:                    ok = api_ffd_open_and_open_and_send_udp(InitState)
<a name="5793"/> 5793:            end).
<a name="5794"/> 5794: 
<a name="5795"/> 5795: 
<a name="5796"/> 5796: 
<a name="5797"/> 5797: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="5798"/> 5798: 
<a name="5799"/> 5799: <i>%% Basically open a socket (1) and then create another socket (2) from</i>
<a name="5800"/> 5800: <i>%% its file descriptor *without* dup.</i>
<a name="5801"/> 5801: <i>%% Exchange some data from via both &quot;client&quot; sockets.</i>
<a name="5802"/> 5802: <i>%% Finally close the second socket. Ensure that the original socket</i>
<a name="5803"/> 5803: <i>%% has not been closed (test by sending some data).</i>
<a name="5804"/> 5804: <i>%% IPv6 UDP (dgram) socket.</i>
<a name="5805"/> 5805: <i>%%</i>
<a name="5806"/> 5806: <i>%% &lt;WARNING&gt;</i>
<a name="5807"/> 5807: <i>%%</i>
<a name="5808"/> 5808: <i>%% This is *not* how its intended to be used.</i>
<a name="5809"/> 5809: <i>%% That an erlang process creating a socket and then handing over the</i>
<a name="5810"/> 5810: <i>%% file descriptor to another erlang process. *But* its a convient way</i>
<a name="5811"/> 5811: <i>%% to test it!</i>
<a name="5812"/> 5812: <i>%%</i>
<a name="5813"/> 5813: <i>%% &lt;/WARNING&gt;</i>
<a name="5814"/> 5814: <i>%%</i>
<a name="api_ffd_open_and_open_wod_and_send_udp6-1"/><a name="5815"/> 5815: <b>api_ffd_open_and_open_wod_and_send_udp6</b>(_Config) when is_list(_Config) -&gt;
<a name="5816"/> 5816:     ?TT(?SECS(5)),
<a name="api_ffd_open_and_open_wod_and_send_udp6-last_expr"/><a name="5817"/> 5817: <b>    tc_try</b>(api_ffd_open_and_open_wod_and_send_udp6,
<a name="5818"/> 5818:            fun() -&gt; has_support_ipv6() end,
<a name="5819"/> 5819:            fun() -&gt;
<a name="5820"/> 5820:                    InitState = #{domain   =&gt; inet6,
<a name="5821"/> 5821:                                  type     =&gt; dgram,
<a name="5822"/> 5822:                                  protocol =&gt; udp,
<a name="5823"/> 5823:                                  dup      =&gt; false},
<a name="5824"/> 5824:                    ok = api_ffd_open_and_open_and_send_udp(InitState)
<a name="5825"/> 5825:            end).
<a name="5826"/> 5826: 
<a name="5827"/> 5827: 
<a name="5828"/> 5828: 
<a name="5829"/> 5829: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="5830"/> 5830: 
<a name="5831"/> 5831: <i>%% Basically open a socket (1) and then create another socket (2) from</i>
<a name="5832"/> 5832: <i>%% its file descriptor *with* dup.</i>
<a name="5833"/> 5833: <i>%% Exchange some data from via both &quot;client&quot; sockets.</i>
<a name="5834"/> 5834: <i>%% Finally close the second socket. Ensure that the original socket</i>
<a name="5835"/> 5835: <i>%% has not been closed (test by sending some data).</i>
<a name="5836"/> 5836: <i>%% IPv4 UDP (dgram) socket.</i>
<a name="5837"/> 5837: <i>%%</i>
<a name="api_ffd_open_and_open_wd_and_send_udp4-1"/><a name="5838"/> 5838: <b>api_ffd_open_and_open_wd_and_send_udp4</b>(_Config) when is_list(_Config) -&gt;
<a name="5839"/> 5839:     ?TT(?SECS(5)),
<a name="api_ffd_open_and_open_wd_and_send_udp4-last_expr"/><a name="5840"/> 5840: <b>    tc_try</b>(api_ffd_open_and_open_wd_and_send_udp4,
<a name="5841"/> 5841:            fun() -&gt; has_support_ipv4() end,
<a name="5842"/> 5842:            fun() -&gt;
<a name="5843"/> 5843:                    InitState = #{domain   =&gt; inet,
<a name="5844"/> 5844:                                  type     =&gt; dgram,
<a name="5845"/> 5845:                                  protocol =&gt; udp,
<a name="5846"/> 5846:                                  dup      =&gt; true},
<a name="5847"/> 5847:                    ok = api_ffd_open_and_open_and_send_udp(InitState)
<a name="5848"/> 5848:            end).
<a name="5849"/> 5849: 
<a name="5850"/> 5850: 
<a name="5851"/> 5851: 
<a name="5852"/> 5852: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="5853"/> 5853: 
<a name="5854"/> 5854: <i>%% Basically open a socket (1) and then create another socket (2) from</i>
<a name="5855"/> 5855: <i>%% its file descriptor *with* dup.</i>
<a name="5856"/> 5856: <i>%% Exchange some data from via both &quot;client&quot; sockets.</i>
<a name="5857"/> 5857: <i>%% Finally close the second socket. Ensure that the original socket</i>
<a name="5858"/> 5858: <i>%% has not been closed (test by sending some data).</i>
<a name="5859"/> 5859: <i>%% IPv6 UDP (dgram) socket.</i>
<a name="5860"/> 5860: <i>%%</i>
<a name="api_ffd_open_and_open_wd_and_send_udp6-1"/><a name="5861"/> 5861: <b>api_ffd_open_and_open_wd_and_send_udp6</b>(_Config) when is_list(_Config) -&gt;
<a name="5862"/> 5862:     ?TT(?SECS(5)),
<a name="api_ffd_open_and_open_wd_and_send_udp6-last_expr"/><a name="5863"/> 5863: <b>    tc_try</b>(api_ffd_open_and_open_wd_and_send_udp6,
<a name="5864"/> 5864:            fun() -&gt; has_support_ipv6() end,
<a name="5865"/> 5865:            fun() -&gt;
<a name="5866"/> 5866:                    InitState = #{domain   =&gt; inet6,
<a name="5867"/> 5867:                                  type     =&gt; dgram,
<a name="5868"/> 5868:                                  protocol =&gt; udp,
<a name="5869"/> 5869:                                  dup      =&gt; true},
<a name="5870"/> 5870:                    ok = api_ffd_open_and_open_and_send_udp(InitState)
<a name="5871"/> 5871:            end).
<a name="5872"/> 5872: 
<a name="5873"/> 5873: 
<a name="5874"/> 5874: 
<a name="5875"/> 5875: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="5876"/> 5876: 
<a name="api_ffd_open_and_open_and_send_udp-1"/><a name="5877"/> 5877: <b>api_ffd_open_and_open_and_send_udp</b>(InitState) -&gt;
<a name="5878"/> 5878:     Send = fun(Sock, Data, Dest) -&gt;
<a name="5879"/> 5879:                    socket:sendto(Sock, Data, Dest)
<a name="5880"/> 5880:            end,
<a name="5881"/> 5881:     Recv = fun(Sock) -&gt;
<a name="5882"/> 5882:                    socket:recvfrom(Sock)
<a name="5883"/> 5883:            end,
<a name="api_ffd_open_and_open_and_send_udp-last_expr"/><a name="5884"/> 5884: <b>    api_ffd_open_and_open_and_send_udp2</b>(InitState#{send   =&gt; Send,
<a name="5885"/> 5885:                                                            recv   =&gt; Recv}).
<a name="5886"/> 5886: 
<a name="api_ffd_open_and_open_and_send_udp2-1"/><a name="5887"/> 5887: <b>api_ffd_open_and_open_and_send_udp2</b>(InitState) -&gt;
<a name="5888"/> 5888:     process_flag(trap_exit, true),
<a name="5889"/> 5889:     ServerSeq = 
<a name="5890"/> 5890:         [
<a name="5891"/> 5891:          %% *** Wait for start order ***
<a name="5892"/> 5892:          #{desc =&gt; &quot;await start (from tester)&quot;,
<a name="5893"/> 5893:            cmd  =&gt; fun(State) -&gt;
<a name="5894"/> 5894:                            Tester = ?SEV_AWAIT_START(),
<a name="5895"/> 5895:                            {ok, State#{tester =&gt; Tester}}
<a name="5896"/> 5896:                    end},
<a name="5897"/> 5897:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="5898"/> 5898:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="5899"/> 5899:                            _MRef = erlang:monitor(process, Tester),
<a name="5900"/> 5900:                            ok
<a name="5901"/> 5901:                    end},
<a name="5902"/> 5902: 
<a name="5903"/> 5903:          %% *** Init part ***
<a name="5904"/> 5904:          #{desc =&gt; &quot;which local address&quot;,
<a name="5905"/> 5905:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="5906"/> 5906:                            LSA = which_local_socket_addr(Domain),
<a name="5907"/> 5907:                            {ok, State#{lsa =&gt; LSA}}
<a name="5908"/> 5908:                    end},
<a name="5909"/> 5909:          #{desc =&gt; &quot;create socket&quot;,
<a name="5910"/> 5910:            cmd  =&gt; fun(#{domain   := Domain,
<a name="5911"/> 5911:                          protocol := Proto} = State) -&gt;
<a name="5912"/> 5912:                            case socket:open(Domain, dgram, Proto) of
<a name="5913"/> 5913:                                {ok, Sock} -&gt;
<a name="5914"/> 5914:                                    {ok, State#{sock =&gt; Sock}};
<a name="5915"/> 5915:                                {error, _} = ERROR -&gt;
<a name="5916"/> 5916:                                    ERROR
<a name="5917"/> 5917:                            end
<a name="5918"/> 5918:                    end},
<a name="5919"/> 5919:          #{desc =&gt; &quot;bind to local address&quot;,
<a name="5920"/> 5920:            cmd  =&gt; fun(#{sock := Sock, lsa := LSA} = State) -&gt;
<a name="5921"/> 5921:                            case sock_bind(Sock, LSA) of
<a name="5922"/> 5922:                                ok -&gt;
<a name="5923"/> 5923:                                    Port = sock_port(Sock),
<a name="5924"/> 5924:                                    ?SEV_IPRINT(&quot;bound to port: ~w&quot;, [Port]),
<a name="5925"/> 5925:                                    {ok, State#{port =&gt; Port}};
<a name="5926"/> 5926:                                {error, _} = ERROR -&gt;
<a name="5927"/> 5927:                                    ERROR
<a name="5928"/> 5928:                            end
<a name="5929"/> 5929:                    end},
<a name="5930"/> 5930:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="5931"/> 5931:            cmd  =&gt; fun(#{tester := Tester, port := Port}) -&gt;
<a name="5932"/> 5932:                            ?SEV_ANNOUNCE_READY(Tester, init, Port),
<a name="5933"/> 5933:                            ok
<a name="5934"/> 5934:                    end},
<a name="5935"/> 5935: 
<a name="5936"/> 5936:          #{desc =&gt; &quot;await request 1 (recv)&quot;,
<a name="5937"/> 5937:            cmd  =&gt; fun(#{sock := Sock, recv := Recv} = State) -&gt;
<a name="5938"/> 5938:                            case Recv(Sock) of
<a name="5939"/> 5939:                                {ok, {Source, ?BASIC_REQ}} -&gt;
<a name="5940"/> 5940:                                    ?SEV_IPRINT(&quot;received request (1) from: &quot;
<a name="5941"/> 5941:                                                &quot;~n   ~p&quot;, [Source]),
<a name="5942"/> 5942:                                    {ok, State#{source =&gt; Source}};
<a name="5943"/> 5943:                                {error, _} = ERROR -&gt;
<a name="5944"/> 5944:                                    ERROR
<a name="5945"/> 5945:                            end
<a name="5946"/> 5946:                    end},
<a name="5947"/> 5947:          #{desc =&gt; &quot;announce ready 1 (recv request)&quot;,
<a name="5948"/> 5948:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="5949"/> 5949:                            ?SEV_ANNOUNCE_READY(Tester, recv_req),
<a name="5950"/> 5950:                            ok
<a name="5951"/> 5951:                    end},
<a name="5952"/> 5952:          #{desc =&gt; &quot;await continue 1 (with send reply)&quot;,
<a name="5953"/> 5953:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="5954"/> 5954:                            ?SEV_AWAIT_CONTINUE(Tester, tester, send_reply)
<a name="5955"/> 5955:                    end},
<a name="5956"/> 5956:          #{desc =&gt; &quot;send reply 1&quot;,
<a name="5957"/> 5957:            cmd  =&gt; fun(#{sock := Sock, send := Send, source := Source}) -&gt;
<a name="5958"/> 5958:                            Send(Sock, ?BASIC_REP, Source)
<a name="5959"/> 5959:                    end},
<a name="5960"/> 5960:          #{desc =&gt; &quot;announce ready 1 (send reply)&quot;,
<a name="5961"/> 5961:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="5962"/> 5962:                            ?SEV_ANNOUNCE_READY(Tester, send_reply),
<a name="5963"/> 5963:                            {ok, maps:remove(source, State)}
<a name="5964"/> 5964:                    end},
<a name="5965"/> 5965: 
<a name="5966"/> 5966:          #{desc =&gt; &quot;await request 2 (recv)&quot;,
<a name="5967"/> 5967:            cmd  =&gt; fun(#{sock := Sock, recv := Recv} = State) -&gt;
<a name="5968"/> 5968:                            case Recv(Sock) of
<a name="5969"/> 5969:                                {ok, {Source, ?BASIC_REQ}} -&gt; 
<a name="5970"/> 5970:                                    ?SEV_IPRINT(&quot;received request (2) from: &quot;
<a name="5971"/> 5971:                                                &quot;~n   ~p&quot;, [Source]),
<a name="5972"/> 5972:                                    {ok, State#{source =&gt; Source}};
<a name="5973"/> 5973:                                {error, _} = ERROR -&gt;
<a name="5974"/> 5974:                                    ERROR
<a name="5975"/> 5975:                            end
<a name="5976"/> 5976:                    end},
<a name="5977"/> 5977:          #{desc =&gt; &quot;announce ready 2 (recv request)&quot;,
<a name="5978"/> 5978:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="5979"/> 5979:                            ?SEV_ANNOUNCE_READY(Tester, recv_req),
<a name="5980"/> 5980:                            ok
<a name="5981"/> 5981:                    end},
<a name="5982"/> 5982:          #{desc =&gt; &quot;await continue 2 (with send reply)&quot;,
<a name="5983"/> 5983:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="5984"/> 5984:                            ?SEV_AWAIT_CONTINUE(Tester, tester, send_reply)
<a name="5985"/> 5985:                    end},
<a name="5986"/> 5986:          #{desc =&gt; &quot;send reply 2&quot;,
<a name="5987"/> 5987:            cmd  =&gt; fun(#{sock := Sock, send := Send, source := Source}) -&gt;
<a name="5988"/> 5988:                            Send(Sock, ?BASIC_REP, Source)
<a name="5989"/> 5989:                    end},
<a name="5990"/> 5990:          #{desc =&gt; &quot;announce ready 2 (send reply)&quot;,
<a name="5991"/> 5991:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="5992"/> 5992:                            ?SEV_ANNOUNCE_READY(Tester, send_reply),
<a name="5993"/> 5993:                            {ok, maps:remove(source, State)}
<a name="5994"/> 5994:                    end},
<a name="5995"/> 5995: 
<a name="5996"/> 5996:          #{desc =&gt; &quot;await request 3 (recv)&quot;,
<a name="5997"/> 5997:            cmd  =&gt; fun(#{sock := Sock, recv := Recv} = State) -&gt;
<a name="5998"/> 5998:                            case Recv(Sock) of
<a name="5999"/> 5999:                                {ok, {Source, ?BASIC_REQ}} -&gt;
<a name="6000"/> 6000:                                    ?SEV_IPRINT(&quot;received request (2) from: &quot;
<a name="6001"/> 6001:                                                &quot;~n   ~p&quot;, [Source]),
<a name="6002"/> 6002:                                    {ok, State#{source =&gt; Source}};
<a name="6003"/> 6003:                                {error, _} = ERROR -&gt;
<a name="6004"/> 6004:                                    ERROR
<a name="6005"/> 6005:                            end
<a name="6006"/> 6006:                    end},
<a name="6007"/> 6007:          #{desc =&gt; &quot;announce ready 3 (recv request)&quot;,
<a name="6008"/> 6008:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="6009"/> 6009:                            ?SEV_ANNOUNCE_READY(Tester, recv_req),
<a name="6010"/> 6010:                            ok
<a name="6011"/> 6011:                    end},
<a name="6012"/> 6012:          #{desc =&gt; &quot;await continue 3 (with send reply)&quot;,
<a name="6013"/> 6013:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="6014"/> 6014:                            ?SEV_AWAIT_CONTINUE(Tester, tester, send_reply)
<a name="6015"/> 6015:                    end},
<a name="6016"/> 6016:          #{desc =&gt; &quot;send reply 3&quot;,
<a name="6017"/> 6017:            cmd  =&gt; fun(#{sock := Sock, send := Send, source := Source}) -&gt;
<a name="6018"/> 6018:                            Send(Sock, ?BASIC_REP, Source)
<a name="6019"/> 6019:                    end},
<a name="6020"/> 6020:          #{desc =&gt; &quot;announce ready 3 (send reply)&quot;,
<a name="6021"/> 6021:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="6022"/> 6022:                            ?SEV_ANNOUNCE_READY(Tester, send_reply),
<a name="6023"/> 6023:                            {ok, maps:remove(source, State)}
<a name="6024"/> 6024:                    end},
<a name="6025"/> 6025: 
<a name="6026"/> 6026:          %% *** Termination ***
<a name="6027"/> 6027:          #{desc =&gt; &quot;await terminate&quot;,
<a name="6028"/> 6028:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="6029"/> 6029:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="6030"/> 6030:                                ok -&gt;
<a name="6031"/> 6031:                                    {ok, maps:remove(tester, State)};
<a name="6032"/> 6032:                                {error, _} = ERROR -&gt;
<a name="6033"/> 6033:                                    ERROR
<a name="6034"/> 6034:                            end
<a name="6035"/> 6035:                    end},
<a name="6036"/> 6036:          #{desc =&gt; &quot;close socket&quot;,
<a name="6037"/> 6037:            cmd  =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="6038"/> 6038:                            ok = socket:close(Sock),
<a name="6039"/> 6039:                            {ok, maps:remove(sock, State)}
<a name="6040"/> 6040:                    end},
<a name="6041"/> 6041: 
<a name="6042"/> 6042:          %% *** We are done ***
<a name="6043"/> 6043:          ?SEV_FINISH_NORMAL
<a name="6044"/> 6044:         ],
<a name="6045"/> 6045: 
<a name="6046"/> 6046: 
<a name="6047"/> 6047:     Client1Seq =
<a name="6048"/> 6048:         [
<a name="6049"/> 6049:          %% *** Wait for start order ***
<a name="6050"/> 6050:          #{desc =&gt; &quot;await start (from tester)&quot;,
<a name="6051"/> 6051:            cmd  =&gt; fun(State) -&gt;
<a name="6052"/> 6052:                            {Tester, Port} = ?SEV_AWAIT_START(),
<a name="6053"/> 6053:                            {ok, State#{tester =&gt; Tester, server_port =&gt; Port}}
<a name="6054"/> 6054:                    end},
<a name="6055"/> 6055:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="6056"/> 6056:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="6057"/> 6057:                            _MRef = erlang:monitor(process, Tester),
<a name="6058"/> 6058:                            ok
<a name="6059"/> 6059:                    end},
<a name="6060"/> 6060: 
<a name="6061"/> 6061:          %% *** The init part ***
<a name="6062"/> 6062:          #{desc =&gt; &quot;which server (local) address&quot;,
<a name="6063"/> 6063:            cmd  =&gt; fun(#{domain := Domain, server_port := Port} = State) -&gt;
<a name="6064"/> 6064:                            LSA = which_local_socket_addr(Domain),
<a name="6065"/> 6065:                            SSA = LSA#{port =&gt; Port},
<a name="6066"/> 6066:                            {ok, State#{local_sa =&gt; LSA, server_sa =&gt; SSA}}
<a name="6067"/> 6067:                    end},
<a name="6068"/> 6068:          #{desc =&gt; &quot;create socket&quot;,
<a name="6069"/> 6069:            cmd  =&gt; fun(#{domain   := Domain,
<a name="6070"/> 6070:                          protocol := Proto} = State) -&gt;
<a name="6071"/> 6071:                            case socket:open(Domain, dgram, Proto) of
<a name="6072"/> 6072:                                {ok, Sock} -&gt;
<a name="6073"/> 6073:                                    {ok, State#{sock =&gt; Sock}};
<a name="6074"/> 6074:                                {error, _} = ERROR -&gt;
<a name="6075"/> 6075:                                    ERROR
<a name="6076"/> 6076:                            end
<a name="6077"/> 6077:                    end},
<a name="6078"/> 6078:          #{desc =&gt; &quot;bind to local address&quot;,
<a name="6079"/> 6079:            cmd  =&gt; fun(#{sock := Sock, local_sa := LSA} = _State) -&gt;
<a name="6080"/> 6080:                            case sock_bind(Sock, LSA) of
<a name="6081"/> 6081:                                ok -&gt;
<a name="6082"/> 6082:                                    ok;
<a name="6083"/> 6083:                                {error, _} = ERROR -&gt;
<a name="6084"/> 6084:                                    ERROR
<a name="6085"/> 6085:                            end
<a name="6086"/> 6086:                    end},
<a name="6087"/> 6087:          #{desc =&gt; &quot;get socket FD&quot;,
<a name="6088"/> 6088:            cmd  =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="6089"/> 6089:                            case socket:getopt(Sock, otp, fd) of
<a name="6090"/> 6090:                                {ok, FD} -&gt;
<a name="6091"/> 6091:                                    ?SEV_IPRINT(&quot;FD: ~w&quot;, [FD]),
<a name="6092"/> 6092:                                    {ok, State#{fd =&gt; FD}};
<a name="6093"/> 6093:                                {error, Reason} = ERROR -&gt;
<a name="6094"/> 6094:                                    ?SEV_EPRINT(&quot;failed get FD: &quot;
<a name="6095"/> 6095:                                                &quot;~n   ~p&quot;, [Reason]),
<a name="6096"/> 6096:                                    ERROR
<a name="6097"/> 6097:                            end
<a name="6098"/> 6098:                    end},
<a name="6099"/> 6099:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="6100"/> 6100:            cmd  =&gt; fun(#{tester := Tester,
<a name="6101"/> 6101:                          fd     := FD}) -&gt;
<a name="6102"/> 6102:                            ?SEV_ANNOUNCE_READY(Tester, init, FD),
<a name="6103"/> 6103:                            ok
<a name="6104"/> 6104:                    end},
<a name="6105"/> 6105: 
<a name="6106"/> 6106:          %% *** The actual test ***
<a name="6107"/> 6107:          #{desc =&gt; &quot;await continue (send request 1)&quot;,
<a name="6108"/> 6108:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="6109"/> 6109:                            ?SEV_AWAIT_CONTINUE(Tester, tester, send_req)
<a name="6110"/> 6110:                    end},
<a name="6111"/> 6111:          #{desc =&gt; &quot;send request 1 (to server)&quot;,
<a name="6112"/> 6112:            cmd  =&gt; fun(#{sock := Sock, send := Send, server_sa := SSA}) -&gt;
<a name="6113"/> 6113:                            Send(Sock, ?BASIC_REQ, SSA)
<a name="6114"/> 6114:                    end},
<a name="6115"/> 6115:          #{desc =&gt; &quot;announce ready (send request 1)&quot;,
<a name="6116"/> 6116:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="6117"/> 6117:                            ?SEV_ANNOUNCE_READY(Tester, send_req),
<a name="6118"/> 6118:                            ok
<a name="6119"/> 6119:                    end},
<a name="6120"/> 6120:          #{desc =&gt; &quot;await recv reply 1 (from server)&quot;,
<a name="6121"/> 6121:            cmd  =&gt; fun(#{sock := Sock, recv := Recv}) -&gt;
<a name="6122"/> 6122:                            {ok, {_, ?BASIC_REP}} = Recv(Sock),
<a name="6123"/> 6123:                            ok
<a name="6124"/> 6124:                    end},
<a name="6125"/> 6125:          #{desc =&gt; &quot;announce ready (recv reply 1)&quot;,
<a name="6126"/> 6126:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="6127"/> 6127:                            ?SEV_ANNOUNCE_READY(Tester, recv_reply),
<a name="6128"/> 6128:                            ok
<a name="6129"/> 6129:                    end},
<a name="6130"/> 6130: 
<a name="6131"/> 6131:          #{desc =&gt; &quot;await continue (send request 3)&quot;,
<a name="6132"/> 6132:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="6133"/> 6133:                            ?SEV_AWAIT_CONTINUE(Tester, tester, send_req)
<a name="6134"/> 6134:                    end},
<a name="6135"/> 6135:          #{desc =&gt; &quot;send request 3 (to server)&quot;,
<a name="6136"/> 6136:            cmd  =&gt; fun(#{sock := Sock, send := Send, server_sa := SSA}) -&gt;
<a name="6137"/> 6137:                            Send(Sock, ?BASIC_REQ, SSA)
<a name="6138"/> 6138:                    end},
<a name="6139"/> 6139:          #{desc =&gt; &quot;announce ready (send request 3)&quot;,
<a name="6140"/> 6140:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="6141"/> 6141:                            ?SEV_ANNOUNCE_READY(Tester, send_req),
<a name="6142"/> 6142:                            ok
<a name="6143"/> 6143:                    end},
<a name="6144"/> 6144:          #{desc =&gt; &quot;await recv reply 3 (from server)&quot;,
<a name="6145"/> 6145:            cmd  =&gt; fun(#{sock := Sock, recv := Recv}) -&gt;
<a name="6146"/> 6146:                            {ok, {_, ?BASIC_REP}} = Recv(Sock),
<a name="6147"/> 6147:                            ok
<a name="6148"/> 6148:                    end},
<a name="6149"/> 6149:          #{desc =&gt; &quot;announce ready (recv reply 3)&quot;,
<a name="6150"/> 6150:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="6151"/> 6151:                            ?SEV_ANNOUNCE_READY(Tester, recv_reply),
<a name="6152"/> 6152:                            ok
<a name="6153"/> 6153:                    end},
<a name="6154"/> 6154: 
<a name="6155"/> 6155:          %% *** Termination ***
<a name="6156"/> 6156:          #{desc =&gt; &quot;await terminate&quot;,
<a name="6157"/> 6157:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="6158"/> 6158:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="6159"/> 6159:                                ok -&gt;
<a name="6160"/> 6160:                                    {ok, maps:remove(tester, State)};
<a name="6161"/> 6161:                                {error, _} = ERROR -&gt;
<a name="6162"/> 6162:                                    ERROR
<a name="6163"/> 6163:                            end
<a name="6164"/> 6164:                    end},
<a name="6165"/> 6165:          #{desc =&gt; &quot;close socket&quot;,
<a name="6166"/> 6166:            cmd  =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="6167"/> 6167:                            ok = socket:close(Sock),
<a name="6168"/> 6168:                            {ok, maps:remove(sock, State)}
<a name="6169"/> 6169:                    end},
<a name="6170"/> 6170: 
<a name="6171"/> 6171:          %% *** We are done ***
<a name="6172"/> 6172:          ?SEV_FINISH_NORMAL
<a name="6173"/> 6173:         ],
<a name="6174"/> 6174: 
<a name="6175"/> 6175: 
<a name="6176"/> 6176:     Client2Seq =
<a name="6177"/> 6177:         [
<a name="6178"/> 6178:          %% *** Wait for start order ***
<a name="6179"/> 6179:          #{desc =&gt; &quot;await start (from tester)&quot;,
<a name="6180"/> 6180:            cmd  =&gt; fun(State) -&gt;
<a name="6181"/> 6181:                            {Tester, {Port, FD}} = ?SEV_AWAIT_START(),
<a name="6182"/> 6182:                            {ok, State#{tester      =&gt; Tester,
<a name="6183"/> 6183:                                        server_port =&gt; Port,
<a name="6184"/> 6184:                                        fd          =&gt; FD}}
<a name="6185"/> 6185:                    end},
<a name="6186"/> 6186:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="6187"/> 6187:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="6188"/> 6188:                            _MRef = erlang:monitor(process, Tester),
<a name="6189"/> 6189:                            ok
<a name="6190"/> 6190:                    end},
<a name="6191"/> 6191: 
<a name="6192"/> 6192:          %% *** The init part ***
<a name="6193"/> 6193:          #{desc =&gt; &quot;which server (local) address&quot;,
<a name="6194"/> 6194:            cmd  =&gt; fun(#{domain := Domain, server_port := Port} = State) -&gt;
<a name="6195"/> 6195:                            LSA = which_local_socket_addr(Domain),
<a name="6196"/> 6196:                            SSA = LSA#{port =&gt; Port},
<a name="6197"/> 6197:                            {ok, State#{server_sa =&gt; SSA}}
<a name="6198"/> 6198:                    end},
<a name="6199"/> 6199:          #{desc =&gt; &quot;create socket&quot;,
<a name="6200"/> 6200:            cmd  =&gt; fun(#{fd  := FD,
<a name="6201"/> 6201:                          dup := DUP} = State) -&gt;
<a name="6202"/> 6202:                            case socket:open(FD, #{dup =&gt; DUP}) of
<a name="6203"/> 6203:                                {ok, Sock} -&gt;
<a name="6204"/> 6204:                                    {ok, State#{sock =&gt; Sock}};
<a name="6205"/> 6205:                                {error, _} = ERROR -&gt;
<a name="6206"/> 6206:                                    ERROR
<a name="6207"/> 6207:                            end
<a name="6208"/> 6208:                    end},
<a name="6209"/> 6209:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="6210"/> 6210:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="6211"/> 6211:                            ?SEV_ANNOUNCE_READY(Tester, init),
<a name="6212"/> 6212:                            ok
<a name="6213"/> 6213:                    end},
<a name="6214"/> 6214: 
<a name="6215"/> 6215:          %% *** The actual test ***
<a name="6216"/> 6216:          #{desc =&gt; &quot;await continue (send request 2)&quot;,
<a name="6217"/> 6217:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="6218"/> 6218:                            ?SEV_AWAIT_CONTINUE(Tester, tester, send_req)
<a name="6219"/> 6219:                    end},
<a name="6220"/> 6220:          #{desc =&gt; &quot;send request 2 (to server)&quot;,
<a name="6221"/> 6221:            cmd  =&gt; fun(#{sock := Sock, send := Send, server_sa := SSA}) -&gt;
<a name="6222"/> 6222:                            Send(Sock, ?BASIC_REQ, SSA)
<a name="6223"/> 6223:                    end},
<a name="6224"/> 6224:          #{desc =&gt; &quot;announce ready (send request 2)&quot;,
<a name="6225"/> 6225:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="6226"/> 6226:                            ?SEV_ANNOUNCE_READY(Tester, send_req),
<a name="6227"/> 6227:                            ok
<a name="6228"/> 6228:                    end},
<a name="6229"/> 6229:          #{desc =&gt; &quot;await recv reply 2 (from server)&quot;,
<a name="6230"/> 6230:            cmd  =&gt; fun(#{sock := Sock, recv := Recv}) -&gt;
<a name="6231"/> 6231:                            {ok, {_, ?BASIC_REP}} = Recv(Sock),
<a name="6232"/> 6232:                            ok
<a name="6233"/> 6233:                    end},
<a name="6234"/> 6234:          #{desc =&gt; &quot;announce ready (recv reply 2)&quot;,
<a name="6235"/> 6235:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="6236"/> 6236:                            ?SEV_ANNOUNCE_READY(Tester, recv_reply),
<a name="6237"/> 6237:                            ok
<a name="6238"/> 6238:                    end},
<a name="6239"/> 6239: 
<a name="6240"/> 6240:          %% *** Termination ***
<a name="6241"/> 6241:          #{desc =&gt; &quot;await terminate&quot;,
<a name="6242"/> 6242:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="6243"/> 6243:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="6244"/> 6244:                                ok -&gt;
<a name="6245"/> 6245:                                    {ok, maps:remove(tester, State)};
<a name="6246"/> 6246:                                {error, _} = ERROR -&gt;
<a name="6247"/> 6247:                                    ERROR
<a name="6248"/> 6248:                            end
<a name="6249"/> 6249:                    end},
<a name="6250"/> 6250:          #{desc =&gt; &quot;close socket&quot;,
<a name="6251"/> 6251:            cmd  =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="6252"/> 6252:                            ok = socket:close(Sock),
<a name="6253"/> 6253:                            {ok, maps:remove(sock, State)}
<a name="6254"/> 6254:                    end},
<a name="6255"/> 6255: 
<a name="6256"/> 6256:          %% *** We are done ***
<a name="6257"/> 6257:          ?SEV_FINISH_NORMAL
<a name="6258"/> 6258:         ],
<a name="6259"/> 6259: 
<a name="6260"/> 6260: 
<a name="6261"/> 6261:     TesterSeq =
<a name="6262"/> 6262:         [
<a name="6263"/> 6263:          %% *** Init part ***
<a name="6264"/> 6264:          #{desc =&gt; &quot;monitor server&quot;,
<a name="6265"/> 6265:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="6266"/> 6266:                            _MRef = erlang:monitor(process, Pid),
<a name="6267"/> 6267:                            ok
<a name="6268"/> 6268:                    end},
<a name="6269"/> 6269:          #{desc =&gt; &quot;monitor client 1&quot;,
<a name="6270"/> 6270:            cmd  =&gt; fun(#{client1 := Pid} = _State) -&gt;
<a name="6271"/> 6271:                            _MRef = erlang:monitor(process, Pid),
<a name="6272"/> 6272:                            ok
<a name="6273"/> 6273:                    end},
<a name="6274"/> 6274:          #{desc =&gt; &quot;monitor client 2&quot;,
<a name="6275"/> 6275:            cmd  =&gt; fun(#{client2 := Pid} = _State) -&gt;
<a name="6276"/> 6276:                            _MRef = erlang:monitor(process, Pid),
<a name="6277"/> 6277:                            ok
<a name="6278"/> 6278:                    end},
<a name="6279"/> 6279: 
<a name="6280"/> 6280:          %% Start the server
<a name="6281"/> 6281:          #{desc =&gt; &quot;order server start&quot;,
<a name="6282"/> 6282:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="6283"/> 6283:                            ?SEV_ANNOUNCE_START(Pid),
<a name="6284"/> 6284:                            ok
<a name="6285"/> 6285:                    end},
<a name="6286"/> 6286:          #{desc =&gt; &quot;await server ready (init)&quot;,
<a name="6287"/> 6287:            cmd  =&gt; fun(#{server := Pid} = State) -&gt;
<a name="6288"/> 6288:                            {ok, Port} = ?SEV_AWAIT_READY(Pid, server, init),
<a name="6289"/> 6289:                            {ok, State#{server_port =&gt; Port}}
<a name="6290"/> 6290:                    end},
<a name="6291"/> 6291: 
<a name="6292"/> 6292:          %% Start the client 1
<a name="6293"/> 6293:          #{desc =&gt; &quot;order client 1 start&quot;,
<a name="6294"/> 6294:            cmd  =&gt; fun(#{client1 := Pid, server_port := Port} = _State) -&gt;
<a name="6295"/> 6295:                            ?SEV_ANNOUNCE_START(Pid, Port),
<a name="6296"/> 6296:                            ok
<a name="6297"/> 6297:                    end},
<a name="6298"/> 6298:          #{desc =&gt; &quot;await client 1 ready (init)&quot;,
<a name="6299"/> 6299:            cmd  =&gt; fun(#{client1 := Pid} = State) -&gt;
<a name="6300"/> 6300:                            case ?SEV_AWAIT_READY(Pid, client1, init) of
<a name="6301"/> 6301:                                {ok, FD} -&gt;
<a name="6302"/> 6302:                                    {ok, State#{fd =&gt; FD}};
<a name="6303"/> 6303:                                {error, Reason} = ERROR -&gt;
<a name="6304"/> 6304:                                    ?SEV_EPRINT(&quot;Client 1 init error: &quot;
<a name="6305"/> 6305:                                                &quot;~n   ~p&quot;, [Reason]),
<a name="6306"/> 6306:                                    ERROR
<a name="6307"/> 6307:                            end
<a name="6308"/> 6308:                    end},
<a name="6309"/> 6309: 
<a name="6310"/> 6310:          ?SEV_SLEEP(?SECS(1)),
<a name="6311"/> 6311: 
<a name="6312"/> 6312:          %% Start the client 2
<a name="6313"/> 6313:          #{desc =&gt; &quot;order client 2 start&quot;,
<a name="6314"/> 6314:            cmd  =&gt; fun(#{client2     := Pid,
<a name="6315"/> 6315:                          server_port := Port,
<a name="6316"/> 6316:                          fd          := FD} = _State) -&gt;
<a name="6317"/> 6317:                            ?SEV_ANNOUNCE_START(Pid, {Port, FD}),
<a name="6318"/> 6318:                            ok
<a name="6319"/> 6319:                    end},
<a name="6320"/> 6320:          #{desc =&gt; &quot;await client 2 ready (init)&quot;,
<a name="6321"/> 6321:            cmd  =&gt; fun(#{client2 := Pid} = _State) -&gt;
<a name="6322"/> 6322:                            ok = ?SEV_AWAIT_READY(Pid, client2, init)
<a name="6323"/> 6323:                    end},
<a name="6324"/> 6324: 
<a name="6325"/> 6325:          %% *** The actual test ***
<a name="6326"/> 6326: 
<a name="6327"/> 6327:          #{desc =&gt; &quot;order client 1 to continue (with send request 1)&quot;,
<a name="6328"/> 6328:            cmd  =&gt; fun(#{client1 := Client} = _State) -&gt;
<a name="6329"/> 6329:                            ?SEV_ANNOUNCE_CONTINUE(Client, send_req),
<a name="6330"/> 6330:                            ok
<a name="6331"/> 6331:                    end},
<a name="6332"/> 6332:          #{desc =&gt; &quot;await client 1 ready (with send request 1)&quot;,
<a name="6333"/> 6333:            cmd  =&gt; fun(#{client1 := Client} = _State) -&gt;
<a name="6334"/> 6334:                            ?SEV_AWAIT_READY(Client, client1, send_req)
<a name="6335"/> 6335:                    end},
<a name="6336"/> 6336:          #{desc =&gt; &quot;await server ready (request recv 1)&quot;,
<a name="6337"/> 6337:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="6338"/> 6338:                            ?SEV_AWAIT_READY(Server, server, recv_req)
<a name="6339"/> 6339:                    end},
<a name="6340"/> 6340:          #{desc =&gt; &quot;order server to continue (with send reply 1)&quot;,
<a name="6341"/> 6341:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="6342"/> 6342:                            ?SEV_ANNOUNCE_CONTINUE(Server, send_reply),
<a name="6343"/> 6343:                            ok
<a name="6344"/> 6344:                    end},
<a name="6345"/> 6345:          #{desc =&gt; &quot;await server ready (with reply 1 sent)&quot;,
<a name="6346"/> 6346:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="6347"/> 6347:                            ?SEV_AWAIT_READY(Server, server, send_reply)
<a name="6348"/> 6348:                    end},
<a name="6349"/> 6349:          #{desc =&gt; &quot;await client 1 ready (reply recv 1)&quot;,
<a name="6350"/> 6350:            cmd  =&gt; fun(#{client1 := Client} = _State) -&gt;
<a name="6351"/> 6351:                            ?SEV_AWAIT_READY(Client, client1, recv_reply)
<a name="6352"/> 6352:                    end},
<a name="6353"/> 6353: 
<a name="6354"/> 6354: 
<a name="6355"/> 6355:          #{desc =&gt; &quot;order client 2 to continue (with send request 2)&quot;,
<a name="6356"/> 6356:            cmd  =&gt; fun(#{client2 := Client} = _State) -&gt;
<a name="6357"/> 6357:                            ?SEV_ANNOUNCE_CONTINUE(Client, send_req),
<a name="6358"/> 6358:                            ok
<a name="6359"/> 6359:                    end},
<a name="6360"/> 6360:          #{desc =&gt; &quot;await client 2 ready (with send request 2)&quot;,
<a name="6361"/> 6361:            cmd  =&gt; fun(#{client2 := Client} = _State) -&gt;
<a name="6362"/> 6362:                            ?SEV_AWAIT_READY(Client, client2, send_req)
<a name="6363"/> 6363:                    end},
<a name="6364"/> 6364:          #{desc =&gt; &quot;await server ready (request recv 2)&quot;,
<a name="6365"/> 6365:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="6366"/> 6366:                            ?SEV_AWAIT_READY(Server, server, recv_req)
<a name="6367"/> 6367:                    end},
<a name="6368"/> 6368:          #{desc =&gt; &quot;order server to continue (with send reply 2)&quot;,
<a name="6369"/> 6369:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="6370"/> 6370:                            ?SEV_ANNOUNCE_CONTINUE(Server, send_reply),
<a name="6371"/> 6371:                            ok
<a name="6372"/> 6372:                    end},
<a name="6373"/> 6373:          #{desc =&gt; &quot;await server ready (with reply 2 sent)&quot;,
<a name="6374"/> 6374:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="6375"/> 6375:                            ?SEV_AWAIT_READY(Server, server, send_reply)
<a name="6376"/> 6376:                    end},
<a name="6377"/> 6377:          #{desc =&gt; &quot;await client 2 ready (reply recv 2)&quot;,
<a name="6378"/> 6378:            cmd  =&gt; fun(#{client2 := Client} = _State) -&gt;
<a name="6379"/> 6379:                            ?SEV_AWAIT_READY(Client, client2, recv_reply)
<a name="6380"/> 6380:                    end},
<a name="6381"/> 6381: 
<a name="6382"/> 6382: 
<a name="6383"/> 6383:          #{desc =&gt; &quot;order client 2 to terminate&quot;,
<a name="6384"/> 6384:            cmd  =&gt; fun(#{client2 := Client} = _State) -&gt;
<a name="6385"/> 6385:                            ?SEV_ANNOUNCE_TERMINATE(Client),
<a name="6386"/> 6386:                            ok
<a name="6387"/> 6387:                    end},
<a name="6388"/> 6388:          #{desc =&gt; &quot;await client 2 termination&quot;,
<a name="6389"/> 6389:            cmd  =&gt; fun(#{client2 := Client} = State) -&gt;
<a name="6390"/> 6390:                            ?SEV_AWAIT_TERMINATION(Client),
<a name="6391"/> 6391:                            State1 = maps:remove(client2, State),
<a name="6392"/> 6392:                            {ok, State1}
<a name="6393"/> 6393:                    end},
<a name="6394"/> 6394: 
<a name="6395"/> 6395: 
<a name="6396"/> 6396:          #{desc =&gt; &quot;order client 1 to continue (with send request 3)&quot;,
<a name="6397"/> 6397:            cmd  =&gt; fun(#{client1 := Client} = _State) -&gt;
<a name="6398"/> 6398:                            ?SEV_ANNOUNCE_CONTINUE(Client, send_req),
<a name="6399"/> 6399:                            ok
<a name="6400"/> 6400:                    end},
<a name="6401"/> 6401:          #{desc =&gt; &quot;await client 1 ready (with send request 3)&quot;,
<a name="6402"/> 6402:            cmd  =&gt; fun(#{client1 := Client} = _State) -&gt;
<a name="6403"/> 6403:                            ?SEV_AWAIT_READY(Client, client1, send_req)
<a name="6404"/> 6404:                    end},
<a name="6405"/> 6405:          #{desc =&gt; &quot;await server ready (request recv 3)&quot;,
<a name="6406"/> 6406:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="6407"/> 6407:                            ?SEV_AWAIT_READY(Server, server, recv_req)
<a name="6408"/> 6408:                    end},
<a name="6409"/> 6409:          #{desc =&gt; &quot;order server to continue (with send reply 3)&quot;,
<a name="6410"/> 6410:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="6411"/> 6411:                            ?SEV_ANNOUNCE_CONTINUE(Server, send_reply),
<a name="6412"/> 6412:                            ok
<a name="6413"/> 6413:                    end},
<a name="6414"/> 6414:          #{desc =&gt; &quot;await server ready (with reply 3 sent)&quot;,
<a name="6415"/> 6415:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="6416"/> 6416:                            ?SEV_AWAIT_READY(Server, server, send_reply)
<a name="6417"/> 6417:                    end},
<a name="6418"/> 6418:          #{desc =&gt; &quot;await client 1 ready (reply recv 3)&quot;,
<a name="6419"/> 6419:            cmd  =&gt; fun(#{client1 := Client} = _State) -&gt;
<a name="6420"/> 6420:                            ?SEV_AWAIT_READY(Client, client1, recv_reply)
<a name="6421"/> 6421:                    end},
<a name="6422"/> 6422: 
<a name="6423"/> 6423: 
<a name="6424"/> 6424:          %% *** Termination ***
<a name="6425"/> 6425:          #{desc =&gt; &quot;order client 1 to terminate&quot;,
<a name="6426"/> 6426:            cmd  =&gt; fun(#{client1 := Client} = _State) -&gt;
<a name="6427"/> 6427:                            ?SEV_ANNOUNCE_TERMINATE(Client),
<a name="6428"/> 6428:                            ok
<a name="6429"/> 6429:                    end},
<a name="6430"/> 6430:          #{desc =&gt; &quot;await client 1 termination&quot;,
<a name="6431"/> 6431:            cmd  =&gt; fun(#{client1 := Client} = State) -&gt;
<a name="6432"/> 6432:                            ?SEV_AWAIT_TERMINATION(Client),
<a name="6433"/> 6433:                            State1 = maps:remove(client1, State),
<a name="6434"/> 6434:                            {ok, State1}
<a name="6435"/> 6435:                    end},
<a name="6436"/> 6436:          #{desc =&gt; &quot;order server to terminate&quot;,
<a name="6437"/> 6437:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="6438"/> 6438:                            ?SEV_ANNOUNCE_TERMINATE(Server),
<a name="6439"/> 6439:                            ok
<a name="6440"/> 6440:                    end},
<a name="6441"/> 6441:          #{desc =&gt; &quot;await server termination&quot;,
<a name="6442"/> 6442:            cmd  =&gt; fun(#{server := Server} = State) -&gt;
<a name="6443"/> 6443:                            ?SEV_AWAIT_TERMINATION(Server),
<a name="6444"/> 6444:                            State1 = maps:remove(server, State),
<a name="6445"/> 6445:                            {ok, State1}
<a name="6446"/> 6446:                    end},
<a name="6447"/> 6447: 
<a name="6448"/> 6448:          %% *** We are done ***
<a name="6449"/> 6449:          ?SEV_FINISH_NORMAL
<a name="6450"/> 6450:         ],
<a name="6451"/> 6451: 
<a name="6452"/> 6452:     i(&quot;start server evaluator&quot;),
<a name="6453"/> 6453:     Server = ?SEV_START(&quot;server&quot;, ServerSeq, maps:remove(dup, InitState)),
<a name="6454"/> 6454: 
<a name="6455"/> 6455:     i(&quot;start (socket origin) client 1 evaluator&quot;),
<a name="6456"/> 6456:     Client1 = ?SEV_START(&quot;client-1&quot;, Client1Seq, maps:remove(dup, InitState)),
<a name="6457"/> 6457:     i(&quot;await evaluator(s)&quot;),
<a name="6458"/> 6458: 
<a name="6459"/> 6459:     i(&quot;start client 2 evaluator&quot;),
<a name="6460"/> 6460:     Client2 = ?SEV_START(&quot;client-2&quot;, Client2Seq, InitState),
<a name="6461"/> 6461:     i(&quot;await evaluator(s)&quot;),
<a name="6462"/> 6462: 
<a name="6463"/> 6463:     i(&quot;start tester evaluator&quot;),
<a name="6464"/> 6464:     TesterInitState = #{server  =&gt; Server#ev.pid,
<a name="6465"/> 6465:                         client1 =&gt; Client1#ev.pid,
<a name="6466"/> 6466:                         client2 =&gt; Client2#ev.pid},
<a name="6467"/> 6467:     Tester = ?SEV_START(&quot;tester&quot;, TesterSeq, TesterInitState),
<a name="6468"/> 6468: 
<a name="api_ffd_open_and_open_and_send_udp2-last_expr"/><a name="6469"/> 6469: <b>    ok = ?SEV_AWAIT_FINISH</b>([Server, Client1, Client2, Tester]).
<a name="6470"/> 6470: 
<a name="6471"/> 6471: 
<a name="6472"/> 6472: 
<a name="6473"/> 6473: 
<a name="6474"/> 6474: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="6475"/> 6475: 
<a name="6476"/> 6476: <i>%% Basically open a socket (1), connect to a server and then create</i>
<a name="6477"/> 6477: <i>%% another socket (2) from its file descriptor *without* dup.</i>
<a name="6478"/> 6478: <i>%% Exchange some data from via both &quot;client&quot; sockets.</i>
<a name="6479"/> 6479: <i>%% Finally close the second socket. Ensure that the original socket</i>
<a name="6480"/> 6480: <i>%% has not been closed (test by sending some data).</i>
<a name="6481"/> 6481: <i>%% IPv4 TCP (stream) socket.</i>
<a name="6482"/> 6482: <i>%%</i>
<a name="6483"/> 6483: <i>%% &lt;WARNING&gt;</i>
<a name="6484"/> 6484: <i>%%</i>
<a name="6485"/> 6485: <i>%% This is *not* how its intended to be used.</i>
<a name="6486"/> 6486: <i>%% That an erlang process creating a socket and then handing over the</i>
<a name="6487"/> 6487: <i>%% file descriptor to another erlang process. *But* its a convient way</i>
<a name="6488"/> 6488: <i>%% to test it!</i>
<a name="6489"/> 6489: <i>%%</i>
<a name="6490"/> 6490: <i>%% &lt;/WARNING&gt;</i>
<a name="6491"/> 6491: <i>%%</i>
<a name="api_ffd_open_connect_and_open_wod_and_send_tcp4-1"/><a name="6492"/> 6492: <b>api_ffd_open_connect_and_open_wod_and_send_tcp4</b>(_Config) when is_list(_Config) -&gt;
<a name="6493"/> 6493:     ?TT(?SECS(5)),
<a name="api_ffd_open_connect_and_open_wod_and_send_tcp4-last_expr"/><a name="6494"/> 6494: <b>    tc_try</b>(api_ffd_open_connect_and_open_wod_and_send_tcp4,
<a name="6495"/> 6495:            fun() -&gt;
<a name="6496"/> 6496:                    InitState = #{domain   =&gt; inet,
<a name="6497"/> 6497:                                  type     =&gt; stream,
<a name="6498"/> 6498:                                  protocol =&gt; tcp,
<a name="6499"/> 6499:                                  dup      =&gt; false},
<a name="6500"/> 6500:                    ok = api_ffd_open_connect_and_open_and_send_tcp(InitState)
<a name="6501"/> 6501:            end).
<a name="6502"/> 6502: 
<a name="6503"/> 6503: 
<a name="6504"/> 6504: 
<a name="6505"/> 6505: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="6506"/> 6506: 
<a name="6507"/> 6507: <i>%% Basically open a socket (1), connect to a server and then create</i>
<a name="6508"/> 6508: <i>%% another socket (2) from its file descriptor *without* dup.</i>
<a name="6509"/> 6509: <i>%% Exchange some data from via both &quot;client&quot; sockets.</i>
<a name="6510"/> 6510: <i>%% Finally close the second socket. Ensure that the original socket</i>
<a name="6511"/> 6511: <i>%% has not been closed (test by sending some data).</i>
<a name="6512"/> 6512: <i>%% IPv6 TCP (stream) socket.</i>
<a name="6513"/> 6513: <i>%%</i>
<a name="6514"/> 6514: <i>%% &lt;WARNING&gt;</i>
<a name="6515"/> 6515: <i>%%</i>
<a name="6516"/> 6516: <i>%% This is *not* how its intended to be used.</i>
<a name="6517"/> 6517: <i>%% That an erlang process creating a socket and then handing over the</i>
<a name="6518"/> 6518: <i>%% file descriptor to another erlang process. *But* its a convient way</i>
<a name="6519"/> 6519: <i>%% to test it!</i>
<a name="6520"/> 6520: <i>%%</i>
<a name="6521"/> 6521: <i>%% &lt;/WARNING&gt;</i>
<a name="6522"/> 6522: <i>%%</i>
<a name="api_ffd_open_connect_and_open_wod_and_send_tcp6-1"/><a name="6523"/> 6523: <b>api_ffd_open_connect_and_open_wod_and_send_tcp6</b>(_Config) when is_list(_Config) -&gt;
<a name="6524"/> 6524:     ?TT(?SECS(5)),
<a name="api_ffd_open_connect_and_open_wod_and_send_tcp6-last_expr"/><a name="6525"/> 6525: <b>    tc_try</b>(api_ffd_open_connect_and_open_wod_and_send_tcp6,
<a name="6526"/> 6526:            fun() -&gt; has_support_ipv6() end,
<a name="6527"/> 6527:            fun() -&gt;
<a name="6528"/> 6528:                    InitState = #{domain   =&gt; inet6,
<a name="6529"/> 6529:                                  type     =&gt; stream,
<a name="6530"/> 6530:                                  protocol =&gt; tcp,
<a name="6531"/> 6531:                                  dup      =&gt; false},
<a name="6532"/> 6532:                    ok = api_ffd_open_connect_and_open_and_send_tcp(InitState)
<a name="6533"/> 6533:            end).
<a name="6534"/> 6534: 
<a name="6535"/> 6535: 
<a name="6536"/> 6536: 
<a name="6537"/> 6537: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="6538"/> 6538: 
<a name="6539"/> 6539: <i>%% Basically open a socket (1), connect to a server and then create</i>
<a name="6540"/> 6540: <i>%% another socket (2) from its file descriptor *with* dup.</i>
<a name="6541"/> 6541: <i>%% Exchange some data from via both &quot;client&quot; sockets.</i>
<a name="6542"/> 6542: <i>%% Finally close the second socket. Ensure that the original socket</i>
<a name="6543"/> 6543: <i>%% has not been closed (test by sending some data).</i>
<a name="6544"/> 6544: <i>%% IPv4 TCP (stream) socket.</i>
<a name="api_ffd_open_connect_and_open_wd_and_send_tcp4-1"/><a name="6545"/> 6545: <b>api_ffd_open_connect_and_open_wd_and_send_tcp4</b>(_Config) when is_list(_Config) -&gt;
<a name="6546"/> 6546:     ?TT(?SECS(5)),
<a name="api_ffd_open_connect_and_open_wd_and_send_tcp4-last_expr"/><a name="6547"/> 6547: <b>    tc_try</b>(api_ffd_open_connect_and_open_wd_and_send_tcp4,
<a name="6548"/> 6548:            fun() -&gt;
<a name="6549"/> 6549:                    InitState = #{domain   =&gt; inet,
<a name="6550"/> 6550:                                  type     =&gt; stream,
<a name="6551"/> 6551:                                  protocol =&gt; tcp,
<a name="6552"/> 6552:                                  dup      =&gt; true},
<a name="6553"/> 6553:                    ok = api_ffd_open_connect_and_open_and_send_tcp(InitState)
<a name="6554"/> 6554:            end).
<a name="6555"/> 6555: 
<a name="6556"/> 6556: 
<a name="6557"/> 6557: 
<a name="6558"/> 6558: 
<a name="6559"/> 6559: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="6560"/> 6560: 
<a name="6561"/> 6561: <i>%% Basically open a socket (1), connect to a server and then create</i>
<a name="6562"/> 6562: <i>%% another socket (2) from its file descriptor *with* dup.</i>
<a name="6563"/> 6563: <i>%% Exchange some data from via both &quot;client&quot; sockets.</i>
<a name="6564"/> 6564: <i>%% Finally close the second socket. Ensure that the original socket</i>
<a name="6565"/> 6565: <i>%% has not been closed (test by sending some data).</i>
<a name="6566"/> 6566: <i>%% IPv6 TCP (stream) socket.</i>
<a name="api_ffd_open_connect_and_open_wd_and_send_tcp6-1"/><a name="6567"/> 6567: <b>api_ffd_open_connect_and_open_wd_and_send_tcp6</b>(_Config) when is_list(_Config) -&gt;
<a name="6568"/> 6568:     ?TT(?SECS(5)),
<a name="api_ffd_open_connect_and_open_wd_and_send_tcp6-last_expr"/><a name="6569"/> 6569: <b>    tc_try</b>(api_ffd_open_connect_and_open_wd_and_send_tcp6,
<a name="6570"/> 6570:            fun() -&gt; has_support_ipv6() end,
<a name="6571"/> 6571:            fun() -&gt;
<a name="6572"/> 6572:                    InitState = #{domain   =&gt; inet6,
<a name="6573"/> 6573:                                  type     =&gt; stream,
<a name="6574"/> 6574:                                  protocol =&gt; tcp,
<a name="6575"/> 6575:                                  dup      =&gt; true},
<a name="6576"/> 6576:                    ok = api_ffd_open_connect_and_open_and_send_tcp(InitState)
<a name="6577"/> 6577:            end).
<a name="6578"/> 6578: 
<a name="6579"/> 6579: 
<a name="6580"/> 6580: 
<a name="6581"/> 6581: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="6582"/> 6582: 
<a name="api_ffd_open_connect_and_open_and_send_tcp-1"/><a name="6583"/> 6583: <b>api_ffd_open_connect_and_open_and_send_tcp</b>(InitState) -&gt;
<a name="6584"/> 6584:     Send = fun(Sock, Data) -&gt;
<a name="6585"/> 6585:                    socket:send(Sock, Data)
<a name="6586"/> 6586:            end,
<a name="6587"/> 6587:     Recv = fun(Sock) -&gt;
<a name="6588"/> 6588:                    socket:recv(Sock)
<a name="6589"/> 6589:            end,
<a name="api_ffd_open_connect_and_open_and_send_tcp-last_expr"/><a name="6590"/> 6590: <b>    api_ffd_open_connect_and_open_and_send_tcp2</b>(InitState#{send   =&gt; Send,
<a name="6591"/> 6591:                                                            recv   =&gt; Recv}).
<a name="6592"/> 6592: 
<a name="api_ffd_open_connect_and_open_and_send_tcp2-1"/><a name="6593"/> 6593: <b>api_ffd_open_connect_and_open_and_send_tcp2</b>(InitState) -&gt;
<a name="6594"/> 6594:     process_flag(trap_exit, true),
<a name="6595"/> 6595:     ServerSeq = 
<a name="6596"/> 6596:         [
<a name="6597"/> 6597:          %% *** Wait for start order ***
<a name="6598"/> 6598:          #{desc =&gt; &quot;await start (from tester)&quot;,
<a name="6599"/> 6599:            cmd  =&gt; fun(State) -&gt;
<a name="6600"/> 6600:                            Tester = ?SEV_AWAIT_START(),
<a name="6601"/> 6601:                            {ok, State#{tester =&gt; Tester}}
<a name="6602"/> 6602:                    end},
<a name="6603"/> 6603:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="6604"/> 6604:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="6605"/> 6605:                            _MRef = erlang:monitor(process, Tester),
<a name="6606"/> 6606:                            ok
<a name="6607"/> 6607:                    end},
<a name="6608"/> 6608: 
<a name="6609"/> 6609:          %% *** Init part ***
<a name="6610"/> 6610:          #{desc =&gt; &quot;which local address&quot;,
<a name="6611"/> 6611:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="6612"/> 6612:                            LSA = which_local_socket_addr(Domain),
<a name="6613"/> 6613:                            {ok, State#{lsa =&gt; LSA}}
<a name="6614"/> 6614:                    end},
<a name="6615"/> 6615:          #{desc =&gt; &quot;create listen socket&quot;,
<a name="6616"/> 6616:            cmd  =&gt; fun(#{domain   := Domain,
<a name="6617"/> 6617:                          protocol := Proto} = State) -&gt;
<a name="6618"/> 6618:                            case socket:open(Domain, stream, Proto) of
<a name="6619"/> 6619:                                {ok, Sock} -&gt;
<a name="6620"/> 6620:                                    {ok, State#{lsock =&gt; Sock}};
<a name="6621"/> 6621:                                {error, _} = ERROR -&gt;
<a name="6622"/> 6622:                                    ERROR
<a name="6623"/> 6623:                            end
<a name="6624"/> 6624:                    end},
<a name="6625"/> 6625:          #{desc =&gt; &quot;bind to local address&quot;,
<a name="6626"/> 6626:            cmd  =&gt; fun(#{lsock := LSock, lsa := LSA} = State) -&gt;
<a name="6627"/> 6627:                            case sock_bind(LSock, LSA) of
<a name="6628"/> 6628:                                ok -&gt;
<a name="6629"/> 6629:                                    Port = sock_port(LSock),
<a name="6630"/> 6630:                                    ?SEV_IPRINT(&quot;bound to port: ~w&quot;, [Port]),
<a name="6631"/> 6631:                                    {ok, State#{lport =&gt; Port}};
<a name="6632"/> 6632:                                {error, _} = ERROR -&gt;
<a name="6633"/> 6633:                                    ERROR
<a name="6634"/> 6634:                            end
<a name="6635"/> 6635:                    end},
<a name="6636"/> 6636:          #{desc =&gt; &quot;make listen socket&quot;,
<a name="6637"/> 6637:            cmd  =&gt; fun(#{lsock := LSock}) -&gt;
<a name="6638"/> 6638:                            socket:listen(LSock)
<a name="6639"/> 6639:                    end},
<a name="6640"/> 6640:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="6641"/> 6641:            cmd  =&gt; fun(#{tester := Tester, lport := Port}) -&gt;
<a name="6642"/> 6642:                            %% This is actually not used for unix domain socket
<a name="6643"/> 6643:                            ?SEV_ANNOUNCE_READY(Tester, init, Port),
<a name="6644"/> 6644:                            ok
<a name="6645"/> 6645:                    end},
<a name="6646"/> 6646: 
<a name="6647"/> 6647:          %% The actual test
<a name="6648"/> 6648:          #{desc =&gt; &quot;await continue (accept)&quot;,
<a name="6649"/> 6649:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="6650"/> 6650:                            ?SEV_AWAIT_CONTINUE(Tester, tester, accept)
<a name="6651"/> 6651:                    end},
<a name="6652"/> 6652:          #{desc =&gt; &quot;await connection&quot;,
<a name="6653"/> 6653:            cmd  =&gt; fun(#{lsock := LSock} = State) -&gt;
<a name="6654"/> 6654:                            case socket:accept(LSock) of
<a name="6655"/> 6655:                                {ok, Sock} -&gt;
<a name="6656"/> 6656:                                    ?SEV_IPRINT(&quot;accepted: ~n   ~p&quot;, [Sock]),
<a name="6657"/> 6657:                                    {ok, State#{csock =&gt; Sock}};
<a name="6658"/> 6658:                                {error, _} = ERROR -&gt;
<a name="6659"/> 6659:                                    ERROR
<a name="6660"/> 6660:                            end
<a name="6661"/> 6661:                    end},
<a name="6662"/> 6662:          #{desc =&gt; &quot;announce ready (accept)&quot;,
<a name="6663"/> 6663:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="6664"/> 6664:                            ?SEV_ANNOUNCE_READY(Tester, accept),
<a name="6665"/> 6665:                            ok
<a name="6666"/> 6666:                    end},
<a name="6667"/> 6667: 
<a name="6668"/> 6668:          #{desc =&gt; &quot;await request 1 (recv)&quot;,
<a name="6669"/> 6669:            cmd  =&gt; fun(#{csock := Sock, recv := Recv}) -&gt;
<a name="6670"/> 6670:                            case Recv(Sock) of
<a name="6671"/> 6671:                                {ok, ?BASIC_REQ} -&gt;
<a name="6672"/> 6672:                                    ok;
<a name="6673"/> 6673:                                {error, _} = ERROR -&gt;
<a name="6674"/> 6674:                                    ERROR
<a name="6675"/> 6675:                            end
<a name="6676"/> 6676:                    end},
<a name="6677"/> 6677:          #{desc =&gt; &quot;announce ready 1 (recv request)&quot;,
<a name="6678"/> 6678:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="6679"/> 6679:                            ?SEV_ANNOUNCE_READY(Tester, recv_req),
<a name="6680"/> 6680:                            ok
<a name="6681"/> 6681:                    end},
<a name="6682"/> 6682:          #{desc =&gt; &quot;await continue 1 (with send reply)&quot;,
<a name="6683"/> 6683:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="6684"/> 6684:                            ?SEV_AWAIT_CONTINUE(Tester, tester, send_reply)
<a name="6685"/> 6685:                    end},
<a name="6686"/> 6686:          #{desc =&gt; &quot;send reply 1&quot;,
<a name="6687"/> 6687:            cmd  =&gt; fun(#{csock := Sock, send := Send}) -&gt;
<a name="6688"/> 6688:                            Send(Sock, ?BASIC_REP)
<a name="6689"/> 6689:                    end},
<a name="6690"/> 6690:          #{desc =&gt; &quot;announce ready 1 (send reply)&quot;,
<a name="6691"/> 6691:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="6692"/> 6692:                            ?SEV_ANNOUNCE_READY(Tester, send_reply),
<a name="6693"/> 6693:                            ok
<a name="6694"/> 6694:                    end},
<a name="6695"/> 6695: 
<a name="6696"/> 6696:          #{desc =&gt; &quot;await request 2 (recv)&quot;,
<a name="6697"/> 6697:            cmd  =&gt; fun(#{csock := Sock, recv := Recv}) -&gt;
<a name="6698"/> 6698:                            case Recv(Sock) of
<a name="6699"/> 6699:                                {ok, ?BASIC_REQ} -&gt;
<a name="6700"/> 6700:                                    ok;
<a name="6701"/> 6701:                                {error, _} = ERROR -&gt;
<a name="6702"/> 6702:                                    ERROR
<a name="6703"/> 6703:                            end
<a name="6704"/> 6704:                    end},
<a name="6705"/> 6705:          #{desc =&gt; &quot;announce ready 2 (recv request)&quot;,
<a name="6706"/> 6706:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="6707"/> 6707:                            ?SEV_ANNOUNCE_READY(Tester, recv_req),
<a name="6708"/> 6708:                            ok
<a name="6709"/> 6709:                    end},
<a name="6710"/> 6710:          #{desc =&gt; &quot;await continue 2 (with send reply)&quot;,
<a name="6711"/> 6711:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="6712"/> 6712:                            ?SEV_AWAIT_CONTINUE(Tester, tester, send_reply)
<a name="6713"/> 6713:                    end},
<a name="6714"/> 6714:          #{desc =&gt; &quot;send reply 2&quot;,
<a name="6715"/> 6715:            cmd  =&gt; fun(#{csock := Sock, send := Send}) -&gt;
<a name="6716"/> 6716:                            Send(Sock, ?BASIC_REP)
<a name="6717"/> 6717:                    end},
<a name="6718"/> 6718:          #{desc =&gt; &quot;announce ready 2 (send reply)&quot;,
<a name="6719"/> 6719:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="6720"/> 6720:                            ?SEV_ANNOUNCE_READY(Tester, send_reply),
<a name="6721"/> 6721:                            ok
<a name="6722"/> 6722:                    end},
<a name="6723"/> 6723: 
<a name="6724"/> 6724:          #{desc =&gt; &quot;await request 3 (recv)&quot;,
<a name="6725"/> 6725:            cmd  =&gt; fun(#{csock := Sock, recv := Recv}) -&gt;
<a name="6726"/> 6726:                            case Recv(Sock) of
<a name="6727"/> 6727:                                {ok, ?BASIC_REQ} -&gt;
<a name="6728"/> 6728:                                    ok;
<a name="6729"/> 6729:                                {error, _} = ERROR -&gt;
<a name="6730"/> 6730:                                    ERROR
<a name="6731"/> 6731:                            end
<a name="6732"/> 6732:                    end},
<a name="6733"/> 6733:          #{desc =&gt; &quot;announce ready 3 (recv request)&quot;,
<a name="6734"/> 6734:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="6735"/> 6735:                            ?SEV_ANNOUNCE_READY(Tester, recv_req),
<a name="6736"/> 6736:                            ok
<a name="6737"/> 6737:                    end},
<a name="6738"/> 6738:          #{desc =&gt; &quot;await continue 3 (with send reply)&quot;,
<a name="6739"/> 6739:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="6740"/> 6740:                            ?SEV_AWAIT_CONTINUE(Tester, tester, send_reply)
<a name="6741"/> 6741:                    end},
<a name="6742"/> 6742:          #{desc =&gt; &quot;send reply 3&quot;,
<a name="6743"/> 6743:            cmd  =&gt; fun(#{csock := Sock, send := Send}) -&gt;
<a name="6744"/> 6744:                            Send(Sock, ?BASIC_REP)
<a name="6745"/> 6745:                    end},
<a name="6746"/> 6746:          #{desc =&gt; &quot;announce ready 3 (send reply)&quot;,
<a name="6747"/> 6747:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="6748"/> 6748:                            ?SEV_ANNOUNCE_READY(Tester, send_reply),
<a name="6749"/> 6749:                            ok
<a name="6750"/> 6750:                    end},
<a name="6751"/> 6751: 
<a name="6752"/> 6752:          %% *** Termination ***
<a name="6753"/> 6753:          #{desc =&gt; &quot;await terminate&quot;,
<a name="6754"/> 6754:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="6755"/> 6755:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="6756"/> 6756:                                ok -&gt;
<a name="6757"/> 6757:                                    {ok, maps:remove(tester, State)};
<a name="6758"/> 6758:                                {error, _} = ERROR -&gt;
<a name="6759"/> 6759:                                    ERROR
<a name="6760"/> 6760:                            end
<a name="6761"/> 6761:                    end},
<a name="6762"/> 6762:          #{desc =&gt; &quot;close connection socket&quot;,
<a name="6763"/> 6763:            cmd  =&gt; fun(#{csock := Sock} = State) -&gt;
<a name="6764"/> 6764:                            ok = socket:close(Sock),
<a name="6765"/> 6765:                            {ok, maps:remove(csock, State)}
<a name="6766"/> 6766:                    end},
<a name="6767"/> 6767:          #{desc =&gt; &quot;close listen socket&quot;,
<a name="6768"/> 6768:            cmd  =&gt; fun(#{lsock := LSock} = State) -&gt;
<a name="6769"/> 6769:                            case socket:close(LSock) of
<a name="6770"/> 6770:                                ok -&gt;
<a name="6771"/> 6771:                                    {ok, maps:remove(lsock, State)};
<a name="6772"/> 6772:                                {error, _} = ERROR -&gt;
<a name="6773"/> 6773:                                    ERROR
<a name="6774"/> 6774:                            end
<a name="6775"/> 6775:                    end},
<a name="6776"/> 6776: 
<a name="6777"/> 6777:          %% *** We are done ***
<a name="6778"/> 6778:          ?SEV_FINISH_NORMAL
<a name="6779"/> 6779:         ],
<a name="6780"/> 6780: 
<a name="6781"/> 6781: 
<a name="6782"/> 6782:     Client1Seq =
<a name="6783"/> 6783:         [
<a name="6784"/> 6784:          %% *** Wait for start order ***
<a name="6785"/> 6785:          #{desc =&gt; &quot;await start (from tester)&quot;,
<a name="6786"/> 6786:            cmd  =&gt; fun(State) -&gt;
<a name="6787"/> 6787:                            {Tester, Port} = ?SEV_AWAIT_START(),
<a name="6788"/> 6788:                            {ok, State#{tester =&gt; Tester, server_port =&gt; Port}}
<a name="6789"/> 6789:                    end},
<a name="6790"/> 6790:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="6791"/> 6791:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="6792"/> 6792:                            _MRef = erlang:monitor(process, Tester),
<a name="6793"/> 6793:                            ok
<a name="6794"/> 6794:                    end},
<a name="6795"/> 6795: 
<a name="6796"/> 6796:          %% *** The init part ***
<a name="6797"/> 6797:          #{desc =&gt; &quot;which server (local) address&quot;,
<a name="6798"/> 6798:            cmd  =&gt; fun(#{domain := Domain, server_port := Port} = State) -&gt;
<a name="6799"/> 6799:                            LSA = which_local_socket_addr(Domain),
<a name="6800"/> 6800:                            SSA = LSA#{port =&gt; Port},
<a name="6801"/> 6801:                            {ok, State#{local_sa =&gt; LSA, server_sa =&gt; SSA}}
<a name="6802"/> 6802:                    end},
<a name="6803"/> 6803:          #{desc =&gt; &quot;create socket&quot;,
<a name="6804"/> 6804:            cmd  =&gt; fun(#{domain   := Domain,
<a name="6805"/> 6805:                          protocol := Proto} = State) -&gt;
<a name="6806"/> 6806:                            case socket:open(Domain, stream, Proto) of
<a name="6807"/> 6807:                                {ok, Sock} -&gt;
<a name="6808"/> 6808:                                    {ok, State#{sock =&gt; Sock}};
<a name="6809"/> 6809:                                {error, _} = ERROR -&gt;
<a name="6810"/> 6810:                                    ERROR
<a name="6811"/> 6811:                            end
<a name="6812"/> 6812:                    end},
<a name="6813"/> 6813:          #{desc =&gt; &quot;bind to local address&quot;,
<a name="6814"/> 6814:            cmd  =&gt; fun(#{sock := Sock, local_sa := LSA} = _State) -&gt;
<a name="6815"/> 6815:                            case sock_bind(Sock, LSA) of
<a name="6816"/> 6816:                                ok -&gt;
<a name="6817"/> 6817:                                    ok;
<a name="6818"/> 6818:                                {error, _} = ERROR -&gt;
<a name="6819"/> 6819:                                    ERROR
<a name="6820"/> 6820:                            end
<a name="6821"/> 6821:                    end},
<a name="6822"/> 6822:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="6823"/> 6823:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="6824"/> 6824:                            ?SEV_ANNOUNCE_READY(Tester, init),
<a name="6825"/> 6825:                            ok
<a name="6826"/> 6826:                    end},
<a name="6827"/> 6827: 
<a name="6828"/> 6828: 
<a name="6829"/> 6829:          #{desc =&gt; &quot;await continue (connect)&quot;,
<a name="6830"/> 6830:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="6831"/> 6831:                            ?SEV_AWAIT_CONTINUE(Tester, tester, connect)
<a name="6832"/> 6832:                    end},
<a name="6833"/> 6833:          #{desc =&gt; &quot;connect to server&quot;,
<a name="6834"/> 6834:            cmd  =&gt; fun(#{sock := Sock, server_sa := SSA}) -&gt;
<a name="6835"/> 6835:                            socket:connect(Sock, SSA)
<a name="6836"/> 6836:                    end},
<a name="6837"/> 6837:          #{desc =&gt; &quot;get socket FD&quot;,
<a name="6838"/> 6838:            cmd  =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="6839"/> 6839:                            case socket:getopt(Sock, otp, fd) of
<a name="6840"/> 6840:                                {ok, FD} -&gt;
<a name="6841"/> 6841:                                    ?SEV_IPRINT(&quot;FD: ~w&quot;, [FD]),
<a name="6842"/> 6842:                                    {ok, State#{fd =&gt; FD}};
<a name="6843"/> 6843:                                {error, Reason} = ERROR -&gt;
<a name="6844"/> 6844:                                    ?SEV_EPRINT(&quot;failed get FD: &quot;
<a name="6845"/> 6845:                                                &quot;~n   ~p&quot;, [Reason]),
<a name="6846"/> 6846:                                    ERROR
<a name="6847"/> 6847:                            end
<a name="6848"/> 6848:                    end},
<a name="6849"/> 6849:          #{desc =&gt; &quot;announce ready (connect)&quot;,
<a name="6850"/> 6850:            cmd  =&gt; fun(#{tester := Tester,
<a name="6851"/> 6851:                          fd     := FD}) -&gt;
<a name="6852"/> 6852:                            ?SEV_ANNOUNCE_READY(Tester, connect, FD),
<a name="6853"/> 6853:                            ok
<a name="6854"/> 6854:                    end},
<a name="6855"/> 6855: 
<a name="6856"/> 6856: 
<a name="6857"/> 6857:          %% *** The actual test ***
<a name="6858"/> 6858:          #{desc =&gt; &quot;await continue (send request 1)&quot;,
<a name="6859"/> 6859:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="6860"/> 6860:                            ?SEV_AWAIT_CONTINUE(Tester, tester, send_req)
<a name="6861"/> 6861:                    end},
<a name="6862"/> 6862:          #{desc =&gt; &quot;send request 1 (to server)&quot;,
<a name="6863"/> 6863:            cmd  =&gt; fun(#{sock := Sock, send := Send}) -&gt;
<a name="6864"/> 6864:                            Send(Sock, ?BASIC_REQ)
<a name="6865"/> 6865:                    end},
<a name="6866"/> 6866:          #{desc =&gt; &quot;announce ready (send request 1)&quot;,
<a name="6867"/> 6867:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="6868"/> 6868:                            ?SEV_ANNOUNCE_READY(Tester, send_req),
<a name="6869"/> 6869:                            ok
<a name="6870"/> 6870:                    end},
<a name="6871"/> 6871:          #{desc =&gt; &quot;await recv reply 1 (from server)&quot;,
<a name="6872"/> 6872:            cmd  =&gt; fun(#{sock := Sock, recv := Recv}) -&gt;
<a name="6873"/> 6873:                            {ok, ?BASIC_REP} = Recv(Sock),
<a name="6874"/> 6874:                            ok
<a name="6875"/> 6875:                    end},
<a name="6876"/> 6876:          #{desc =&gt; &quot;announce ready (recv reply 1)&quot;,
<a name="6877"/> 6877:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="6878"/> 6878:                            ?SEV_ANNOUNCE_READY(Tester, recv_reply),
<a name="6879"/> 6879:                            ok
<a name="6880"/> 6880:                    end},
<a name="6881"/> 6881: 
<a name="6882"/> 6882:          #{desc =&gt; &quot;await continue (send request 3)&quot;,
<a name="6883"/> 6883:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="6884"/> 6884:                            ?SEV_AWAIT_CONTINUE(Tester, tester, send_req)
<a name="6885"/> 6885:                    end},
<a name="6886"/> 6886:          #{desc =&gt; &quot;send request 3 (to server)&quot;,
<a name="6887"/> 6887:            cmd  =&gt; fun(#{sock := Sock, send := Send}) -&gt;
<a name="6888"/> 6888:                            Send(Sock, ?BASIC_REQ)
<a name="6889"/> 6889:                    end},
<a name="6890"/> 6890:          #{desc =&gt; &quot;announce ready (send request 3)&quot;,
<a name="6891"/> 6891:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="6892"/> 6892:                            ?SEV_ANNOUNCE_READY(Tester, send_req),
<a name="6893"/> 6893:                            ok
<a name="6894"/> 6894:                    end},
<a name="6895"/> 6895:          #{desc =&gt; &quot;await recv reply 3 (from server)&quot;,
<a name="6896"/> 6896:            cmd  =&gt; fun(#{sock := Sock, recv := Recv}) -&gt;
<a name="6897"/> 6897:                            {ok, ?BASIC_REP} = Recv(Sock),
<a name="6898"/> 6898:                            ok
<a name="6899"/> 6899:                    end},
<a name="6900"/> 6900:          #{desc =&gt; &quot;announce ready (recv reply 3)&quot;,
<a name="6901"/> 6901:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="6902"/> 6902:                            ?SEV_ANNOUNCE_READY(Tester, recv_reply),
<a name="6903"/> 6903:                            ok
<a name="6904"/> 6904:                    end},
<a name="6905"/> 6905: 
<a name="6906"/> 6906:          %% *** Termination ***
<a name="6907"/> 6907:          #{desc =&gt; &quot;await terminate&quot;,
<a name="6908"/> 6908:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="6909"/> 6909:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="6910"/> 6910:                                ok -&gt;
<a name="6911"/> 6911:                                    {ok, maps:remove(tester, State)};
<a name="6912"/> 6912:                                {error, _} = ERROR -&gt;
<a name="6913"/> 6913:                                    ERROR
<a name="6914"/> 6914:                            end
<a name="6915"/> 6915:                    end},
<a name="6916"/> 6916:          #{desc =&gt; &quot;close socket&quot;,
<a name="6917"/> 6917:            cmd  =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="6918"/> 6918:                            ok = socket:close(Sock),
<a name="6919"/> 6919:                            {ok, maps:remove(sock, State)}
<a name="6920"/> 6920:                    end},
<a name="6921"/> 6921: 
<a name="6922"/> 6922:          %% *** We are done ***
<a name="6923"/> 6923:          ?SEV_FINISH_NORMAL
<a name="6924"/> 6924:         ],
<a name="6925"/> 6925: 
<a name="6926"/> 6926: 
<a name="6927"/> 6927:     Client2Seq =
<a name="6928"/> 6928:         [
<a name="6929"/> 6929:          %% *** Wait for start order ***
<a name="6930"/> 6930:          #{desc =&gt; &quot;await start (from tester)&quot;,
<a name="6931"/> 6931:            cmd  =&gt; fun(State) -&gt;
<a name="6932"/> 6932:                            {Tester, FD} = ?SEV_AWAIT_START(),
<a name="6933"/> 6933:                            {ok, State#{tester =&gt; Tester, fd =&gt; FD}}
<a name="6934"/> 6934:                    end},
<a name="6935"/> 6935:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="6936"/> 6936:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="6937"/> 6937:                            _MRef = erlang:monitor(process, Tester),
<a name="6938"/> 6938:                            ok
<a name="6939"/> 6939:                    end},
<a name="6940"/> 6940: 
<a name="6941"/> 6941:          %% *** The init part ***
<a name="6942"/> 6942:          #{desc =&gt; &quot;create socket&quot;,
<a name="6943"/> 6943:            cmd  =&gt; fun(#{fd  := FD,
<a name="6944"/> 6944:                          dup := DUP} = State) -&gt;
<a name="6945"/> 6945:                            case socket:open(FD, #{dup =&gt; DUP}) of
<a name="6946"/> 6946:                                {ok, Sock} -&gt;
<a name="6947"/> 6947:                                    {ok, State#{sock =&gt; Sock}};
<a name="6948"/> 6948:                                {error, _} = ERROR -&gt;
<a name="6949"/> 6949:                                    ERROR
<a name="6950"/> 6950:                            end
<a name="6951"/> 6951:                    end},
<a name="6952"/> 6952:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="6953"/> 6953:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="6954"/> 6954:                            ?SEV_ANNOUNCE_READY(Tester, init),
<a name="6955"/> 6955:                            ok
<a name="6956"/> 6956:                    end},
<a name="6957"/> 6957: 
<a name="6958"/> 6958:          %% *** The actual test ***
<a name="6959"/> 6959:          #{desc =&gt; &quot;await continue (send request 2)&quot;,
<a name="6960"/> 6960:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="6961"/> 6961:                            ?SEV_AWAIT_CONTINUE(Tester, tester, send_req)
<a name="6962"/> 6962:                    end},
<a name="6963"/> 6963:          #{desc =&gt; &quot;send request 2 (to server)&quot;,
<a name="6964"/> 6964:            cmd  =&gt; fun(#{sock := Sock, send := Send}) -&gt;
<a name="6965"/> 6965:                            Send(Sock, ?BASIC_REQ)
<a name="6966"/> 6966:                    end},
<a name="6967"/> 6967:          #{desc =&gt; &quot;announce ready (send request 2)&quot;,
<a name="6968"/> 6968:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="6969"/> 6969:                            ?SEV_ANNOUNCE_READY(Tester, send_req),
<a name="6970"/> 6970:                            ok
<a name="6971"/> 6971:                    end},
<a name="6972"/> 6972:          #{desc =&gt; &quot;await recv reply 2 (from server)&quot;,
<a name="6973"/> 6973:            cmd  =&gt; fun(#{sock := Sock, recv := Recv}) -&gt;
<a name="6974"/> 6974:                            {ok, ?BASIC_REP} = Recv(Sock),
<a name="6975"/> 6975:                            ok
<a name="6976"/> 6976:                    end},
<a name="6977"/> 6977:          #{desc =&gt; &quot;announce ready (recv reply 2)&quot;,
<a name="6978"/> 6978:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="6979"/> 6979:                            ?SEV_ANNOUNCE_READY(Tester, recv_reply),
<a name="6980"/> 6980:                            ok
<a name="6981"/> 6981:                    end},
<a name="6982"/> 6982: 
<a name="6983"/> 6983:          %% *** Termination ***
<a name="6984"/> 6984:          #{desc =&gt; &quot;await terminate&quot;,
<a name="6985"/> 6985:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="6986"/> 6986:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="6987"/> 6987:                                ok -&gt;
<a name="6988"/> 6988:                                    {ok, maps:remove(tester, State)};
<a name="6989"/> 6989:                                {error, _} = ERROR -&gt;
<a name="6990"/> 6990:                                    ERROR
<a name="6991"/> 6991:                            end
<a name="6992"/> 6992:                    end},
<a name="6993"/> 6993:          #{desc =&gt; &quot;close socket&quot;,
<a name="6994"/> 6994:            cmd  =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="6995"/> 6995:                            ok = socket:close(Sock),
<a name="6996"/> 6996:                            {ok, maps:remove(sock, State)}
<a name="6997"/> 6997:                    end},
<a name="6998"/> 6998: 
<a name="6999"/> 6999:          %% *** We are done ***
<a name="7000"/> 7000:          ?SEV_FINISH_NORMAL
<a name="7001"/> 7001:         ],
<a name="7002"/> 7002: 
<a name="7003"/> 7003: 
<a name="7004"/> 7004:     TesterSeq =
<a name="7005"/> 7005:         [
<a name="7006"/> 7006:          %% *** Init part ***
<a name="7007"/> 7007:          #{desc =&gt; &quot;monitor server&quot;,
<a name="7008"/> 7008:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="7009"/> 7009:                            _MRef = erlang:monitor(process, Pid),
<a name="7010"/> 7010:                            ok
<a name="7011"/> 7011:                    end},
<a name="7012"/> 7012:          #{desc =&gt; &quot;monitor client 1&quot;,
<a name="7013"/> 7013:            cmd  =&gt; fun(#{client1 := Pid} = _State) -&gt;
<a name="7014"/> 7014:                            _MRef = erlang:monitor(process, Pid),
<a name="7015"/> 7015:                            ok
<a name="7016"/> 7016:                    end},
<a name="7017"/> 7017:          #{desc =&gt; &quot;monitor client 2&quot;,
<a name="7018"/> 7018:            cmd  =&gt; fun(#{client2 := Pid} = _State) -&gt;
<a name="7019"/> 7019:                            _MRef = erlang:monitor(process, Pid),
<a name="7020"/> 7020:                            ok
<a name="7021"/> 7021:                    end},
<a name="7022"/> 7022: 
<a name="7023"/> 7023:          %% Start the server
<a name="7024"/> 7024:          #{desc =&gt; &quot;order server start&quot;,
<a name="7025"/> 7025:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="7026"/> 7026:                            ?SEV_ANNOUNCE_START(Pid),
<a name="7027"/> 7027:                            ok
<a name="7028"/> 7028:                    end},
<a name="7029"/> 7029:          #{desc =&gt; &quot;await server ready (init)&quot;,
<a name="7030"/> 7030:            cmd  =&gt; fun(#{server := Pid} = State) -&gt;
<a name="7031"/> 7031:                            {ok, Port} = ?SEV_AWAIT_READY(Pid, server, init),
<a name="7032"/> 7032:                            {ok, State#{server_port =&gt; Port}}
<a name="7033"/> 7033:                    end},
<a name="7034"/> 7034: 
<a name="7035"/> 7035:          %% Start the client 1
<a name="7036"/> 7036:          #{desc =&gt; &quot;order client 1 start&quot;,
<a name="7037"/> 7037:            cmd  =&gt; fun(#{client1 := Pid, server_port := Port} = _State) -&gt;
<a name="7038"/> 7038:                            ?SEV_ANNOUNCE_START(Pid, Port),
<a name="7039"/> 7039:                            ok
<a name="7040"/> 7040:                    end},
<a name="7041"/> 7041:          #{desc =&gt; &quot;await client 1 ready (init)&quot;,
<a name="7042"/> 7042:            cmd  =&gt; fun(#{client1 := Pid} = _State) -&gt;
<a name="7043"/> 7043:                            ok = ?SEV_AWAIT_READY(Pid, client1, init)
<a name="7044"/> 7044:                    end},
<a name="7045"/> 7045: 
<a name="7046"/> 7046:          #{desc =&gt; &quot;order server to continue (with accept)&quot;,
<a name="7047"/> 7047:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="7048"/> 7048:                            ?SEV_ANNOUNCE_CONTINUE(Server, accept),
<a name="7049"/> 7049:                            ok
<a name="7050"/> 7050:                    end},
<a name="7051"/> 7051:          ?SEV_SLEEP(?SECS(1)),
<a name="7052"/> 7052:          #{desc =&gt; &quot;order client 1 to continue (with connect)&quot;,
<a name="7053"/> 7053:            cmd  =&gt; fun(#{client1 := Client} = _State) -&gt;
<a name="7054"/> 7054:                            ?SEV_ANNOUNCE_CONTINUE(Client, connect),
<a name="7055"/> 7055:                            ok
<a name="7056"/> 7056:                    end},
<a name="7057"/> 7057:          #{desc =&gt; &quot;await client 1 ready (connect)&quot;,
<a name="7058"/> 7058:            cmd  =&gt; fun(#{client1 := Pid} = State) -&gt;
<a name="7059"/> 7059:                            {ok, FD} = ?SEV_AWAIT_READY(Pid, client1, connect),
<a name="7060"/> 7060:                            {ok, State#{fd =&gt; FD}}
<a name="7061"/> 7061:                    end},
<a name="7062"/> 7062:          #{desc =&gt; &quot;await server ready (accept)&quot;,
<a name="7063"/> 7063:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="7064"/> 7064:                            ?SEV_AWAIT_READY(Server, server, accept)
<a name="7065"/> 7065:                    end},         
<a name="7066"/> 7066: 
<a name="7067"/> 7067:          %% Start the client 2
<a name="7068"/> 7068:          #{desc =&gt; &quot;order client 2 start&quot;,
<a name="7069"/> 7069:            cmd  =&gt; fun(#{client2 := Pid, fd := FD} = _State) -&gt;
<a name="7070"/> 7070:                            ?SEV_ANNOUNCE_START(Pid, FD),
<a name="7071"/> 7071:                            ok
<a name="7072"/> 7072:                    end},
<a name="7073"/> 7073:          #{desc =&gt; &quot;await client 2 ready (init)&quot;,
<a name="7074"/> 7074:            cmd  =&gt; fun(#{client2 := Pid} = _State) -&gt;
<a name="7075"/> 7075:                            ok = ?SEV_AWAIT_READY(Pid, client2, init)
<a name="7076"/> 7076:                    end},
<a name="7077"/> 7077: 
<a name="7078"/> 7078:          %% *** The actual test ***
<a name="7079"/> 7079: 
<a name="7080"/> 7080:          #{desc =&gt; &quot;order client 1 to continue (with send request 1)&quot;,
<a name="7081"/> 7081:            cmd  =&gt; fun(#{client1 := Client} = _State) -&gt;
<a name="7082"/> 7082:                            ?SEV_ANNOUNCE_CONTINUE(Client, send_req),
<a name="7083"/> 7083:                            ok
<a name="7084"/> 7084:                    end},
<a name="7085"/> 7085:          #{desc =&gt; &quot;await client 1 ready (with send request 1)&quot;,
<a name="7086"/> 7086:            cmd  =&gt; fun(#{client1 := Client} = _State) -&gt;
<a name="7087"/> 7087:                            ?SEV_AWAIT_READY(Client, client1, send_req)
<a name="7088"/> 7088:                    end},
<a name="7089"/> 7089:          #{desc =&gt; &quot;await server ready (request recv 1)&quot;,
<a name="7090"/> 7090:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="7091"/> 7091:                            ?SEV_AWAIT_READY(Server, server, recv_req)
<a name="7092"/> 7092:                    end},
<a name="7093"/> 7093:          #{desc =&gt; &quot;order server to continue (with send reply 1)&quot;,
<a name="7094"/> 7094:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="7095"/> 7095:                            ?SEV_ANNOUNCE_CONTINUE(Server, send_reply),
<a name="7096"/> 7096:                            ok
<a name="7097"/> 7097:                    end},
<a name="7098"/> 7098:          #{desc =&gt; &quot;await server ready (with reply 1 sent)&quot;,
<a name="7099"/> 7099:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="7100"/> 7100:                            ?SEV_AWAIT_READY(Server, server, send_reply)
<a name="7101"/> 7101:                    end},
<a name="7102"/> 7102:          #{desc =&gt; &quot;await client 1 ready (reply recv 1)&quot;,
<a name="7103"/> 7103:            cmd  =&gt; fun(#{client1 := Client} = _State) -&gt;
<a name="7104"/> 7104:                            ?SEV_AWAIT_READY(Client, client1, recv_reply)
<a name="7105"/> 7105:                    end},
<a name="7106"/> 7106: 
<a name="7107"/> 7107: 
<a name="7108"/> 7108:          #{desc =&gt; &quot;order client 2 to continue (with send request 2)&quot;,
<a name="7109"/> 7109:            cmd  =&gt; fun(#{client2 := Client} = _State) -&gt;
<a name="7110"/> 7110:                            ?SEV_ANNOUNCE_CONTINUE(Client, send_req),
<a name="7111"/> 7111:                            ok
<a name="7112"/> 7112:                    end},
<a name="7113"/> 7113:          #{desc =&gt; &quot;await client 2 ready (with send request 2)&quot;,
<a name="7114"/> 7114:            cmd  =&gt; fun(#{client2 := Client} = _State) -&gt;
<a name="7115"/> 7115:                            ?SEV_AWAIT_READY(Client, client2, send_req)
<a name="7116"/> 7116:                    end},
<a name="7117"/> 7117:          #{desc =&gt; &quot;await server ready (request recv 2)&quot;,
<a name="7118"/> 7118:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="7119"/> 7119:                            ?SEV_AWAIT_READY(Server, server, recv_req)
<a name="7120"/> 7120:                    end},
<a name="7121"/> 7121:          #{desc =&gt; &quot;order server to continue (with send reply 2)&quot;,
<a name="7122"/> 7122:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="7123"/> 7123:                            ?SEV_ANNOUNCE_CONTINUE(Server, send_reply),
<a name="7124"/> 7124:                            ok
<a name="7125"/> 7125:                    end},
<a name="7126"/> 7126:          #{desc =&gt; &quot;await server ready (with reply 2 sent)&quot;,
<a name="7127"/> 7127:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="7128"/> 7128:                            ?SEV_AWAIT_READY(Server, server, send_reply)
<a name="7129"/> 7129:                    end},
<a name="7130"/> 7130:          #{desc =&gt; &quot;await client 2 ready (reply recv 2)&quot;,
<a name="7131"/> 7131:            cmd  =&gt; fun(#{client2 := Client} = _State) -&gt;
<a name="7132"/> 7132:                            ?SEV_AWAIT_READY(Client, client2, recv_reply)
<a name="7133"/> 7133:                    end},
<a name="7134"/> 7134: 
<a name="7135"/> 7135: 
<a name="7136"/> 7136:          #{desc =&gt; &quot;order client 2 to terminate&quot;,
<a name="7137"/> 7137:            cmd  =&gt; fun(#{client2 := Client} = _State) -&gt;
<a name="7138"/> 7138:                            ?SEV_ANNOUNCE_TERMINATE(Client),
<a name="7139"/> 7139:                            ok
<a name="7140"/> 7140:                    end},
<a name="7141"/> 7141:          #{desc =&gt; &quot;await client 2 termination&quot;,
<a name="7142"/> 7142:            cmd  =&gt; fun(#{client2 := Client} = State) -&gt;
<a name="7143"/> 7143:                            ?SEV_AWAIT_TERMINATION(Client),
<a name="7144"/> 7144:                            State1 = maps:remove(client2, State),
<a name="7145"/> 7145:                            {ok, State1}
<a name="7146"/> 7146:                    end},
<a name="7147"/> 7147: 
<a name="7148"/> 7148: 
<a name="7149"/> 7149:          #{desc =&gt; &quot;order client 1 to continue (with send request 3)&quot;,
<a name="7150"/> 7150:            cmd  =&gt; fun(#{client1 := Client} = _State) -&gt;
<a name="7151"/> 7151:                            ?SEV_ANNOUNCE_CONTINUE(Client, send_req),
<a name="7152"/> 7152:                            ok
<a name="7153"/> 7153:                    end},
<a name="7154"/> 7154:          #{desc =&gt; &quot;await client 1 ready (with send request 3)&quot;,
<a name="7155"/> 7155:            cmd  =&gt; fun(#{client1 := Client} = _State) -&gt;
<a name="7156"/> 7156:                            ?SEV_AWAIT_READY(Client, client1, send_req)
<a name="7157"/> 7157:                    end},
<a name="7158"/> 7158:          #{desc =&gt; &quot;await server ready (request recv 3)&quot;,
<a name="7159"/> 7159:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="7160"/> 7160:                            ?SEV_AWAIT_READY(Server, server, recv_req)
<a name="7161"/> 7161:                    end},
<a name="7162"/> 7162:          #{desc =&gt; &quot;order server to continue (with send reply 3)&quot;,
<a name="7163"/> 7163:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="7164"/> 7164:                            ?SEV_ANNOUNCE_CONTINUE(Server, send_reply),
<a name="7165"/> 7165:                            ok
<a name="7166"/> 7166:                    end},
<a name="7167"/> 7167:          #{desc =&gt; &quot;await server ready (with reply 3 sent)&quot;,
<a name="7168"/> 7168:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="7169"/> 7169:                            ?SEV_AWAIT_READY(Server, server, send_reply)
<a name="7170"/> 7170:                    end},
<a name="7171"/> 7171:          #{desc =&gt; &quot;await client 1 ready (reply recv 3)&quot;,
<a name="7172"/> 7172:            cmd  =&gt; fun(#{client1 := Client} = _State) -&gt;
<a name="7173"/> 7173:                            ?SEV_AWAIT_READY(Client, client1, recv_reply)
<a name="7174"/> 7174:                    end},
<a name="7175"/> 7175: 
<a name="7176"/> 7176: 
<a name="7177"/> 7177:          %% *** Termination ***
<a name="7178"/> 7178:          #{desc =&gt; &quot;order client 1 to terminate&quot;,
<a name="7179"/> 7179:            cmd  =&gt; fun(#{client1 := Client} = _State) -&gt;
<a name="7180"/> 7180:                            ?SEV_ANNOUNCE_TERMINATE(Client),
<a name="7181"/> 7181:                            ok
<a name="7182"/> 7182:                    end},
<a name="7183"/> 7183:          #{desc =&gt; &quot;await client 1 termination&quot;,
<a name="7184"/> 7184:            cmd  =&gt; fun(#{client1 := Client} = State) -&gt;
<a name="7185"/> 7185:                            ?SEV_AWAIT_TERMINATION(Client),
<a name="7186"/> 7186:                            State1 = maps:remove(client1, State),
<a name="7187"/> 7187:                            {ok, State1}
<a name="7188"/> 7188:                    end},
<a name="7189"/> 7189:          #{desc =&gt; &quot;order server to terminate&quot;,
<a name="7190"/> 7190:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="7191"/> 7191:                            ?SEV_ANNOUNCE_TERMINATE(Server),
<a name="7192"/> 7192:                            ok
<a name="7193"/> 7193:                    end},
<a name="7194"/> 7194:          #{desc =&gt; &quot;await server termination&quot;,
<a name="7195"/> 7195:            cmd  =&gt; fun(#{server := Server} = State) -&gt;
<a name="7196"/> 7196:                            ?SEV_AWAIT_TERMINATION(Server),
<a name="7197"/> 7197:                            State1 = maps:remove(server, State),
<a name="7198"/> 7198:                            {ok, State1}
<a name="7199"/> 7199:                    end},
<a name="7200"/> 7200: 
<a name="7201"/> 7201:          %% *** We are done ***
<a name="7202"/> 7202:          ?SEV_FINISH_NORMAL
<a name="7203"/> 7203:         ],
<a name="7204"/> 7204: 
<a name="7205"/> 7205:     i(&quot;start server evaluator&quot;),
<a name="7206"/> 7206:     Server = ?SEV_START(&quot;server&quot;, ServerSeq, maps:remove(dup, InitState)),
<a name="7207"/> 7207: 
<a name="7208"/> 7208:     i(&quot;start (socket origin) client 1 evaluator&quot;),
<a name="7209"/> 7209:     Client1 = ?SEV_START(&quot;client-1&quot;, Client1Seq, maps:remove(dup, InitState)),
<a name="7210"/> 7210:     i(&quot;await evaluator(s)&quot;),
<a name="7211"/> 7211: 
<a name="7212"/> 7212:     i(&quot;start client 2 evaluator&quot;),
<a name="7213"/> 7213:     Client2 = ?SEV_START(&quot;client-2&quot;, Client2Seq, InitState),
<a name="7214"/> 7214:     i(&quot;await evaluator(s)&quot;),
<a name="7215"/> 7215: 
<a name="7216"/> 7216:     i(&quot;start tester evaluator&quot;),
<a name="7217"/> 7217:     TesterInitState = #{server  =&gt; Server#ev.pid,
<a name="7218"/> 7218:                         client1 =&gt; Client1#ev.pid,
<a name="7219"/> 7219:                         client2 =&gt; Client2#ev.pid},
<a name="7220"/> 7220:     Tester = ?SEV_START(&quot;tester&quot;, TesterSeq, TesterInitState),
<a name="7221"/> 7221: 
<a name="api_ffd_open_connect_and_open_and_send_tcp2-last_expr"/><a name="7222"/> 7222: <b>    ok = ?SEV_AWAIT_FINISH</b>([Server, Client1, Client2, Tester]).
<a name="7223"/> 7223: 
<a name="7224"/> 7224: 
<a name="7225"/> 7225: 
<a name="7226"/> 7226: 
<a name="7227"/> 7227: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="7228"/> 7228: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="7229"/> 7229: <i>%%                                                                     %%</i>
<a name="7230"/> 7230: <i>%%                           API ASYNC                                 %%</i>
<a name="7231"/> 7231: <i>%%                                                                     %%</i>
<a name="7232"/> 7232: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="7233"/> 7233: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="7234"/> 7234: 
<a name="7235"/> 7235: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="7236"/> 7236: 
<a name="7237"/> 7237: <i>%% Basically establish a TCP connection via an async connect. IPv4.</i>
<a name="api_a_connect_tcp4-1"/><a name="7238"/> 7238: <b>api_a_connect_tcp4</b>(Config) when is_list(Config) -&gt;
<a name="7239"/> 7239:     ?TT(?SECS(10)),
<a name="api_a_connect_tcp4-last_expr"/><a name="7240"/> 7240: <b>    tc_try</b>(api_a_connect_tcp4,
<a name="7241"/> 7241:            fun() -&gt; has_support_ipv4() end,
<a name="7242"/> 7242:            fun() -&gt;
<a name="7243"/> 7243:                    ok = api_a_connect_tcpD(inet, nowait(Config))
<a name="7244"/> 7244:            end).
<a name="7245"/> 7245: 
<a name="7246"/> 7246: 
<a name="7247"/> 7247: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="7248"/> 7248: 
<a name="7249"/> 7249: <i>%% Basically establish a TCP connection via an async connect. IPv6.</i>
<a name="api_a_connect_tcp6-1"/><a name="7250"/> 7250: <b>api_a_connect_tcp6</b>(Config) when is_list(Config) -&gt;
<a name="7251"/> 7251:     ?TT(?SECS(10)),
<a name="api_a_connect_tcp6-last_expr"/><a name="7252"/> 7252: <b>    tc_try</b>(api_a_connect_tcp6,
<a name="7253"/> 7253:            fun() -&gt; has_support_ipv6() end,
<a name="7254"/> 7254:            fun() -&gt;
<a name="7255"/> 7255:                    ok = api_a_connect_tcpD(inet6, nowait(Config))
<a name="7256"/> 7256:            end).
<a name="7257"/> 7257: 
<a name="7258"/> 7258: 
<a name="7259"/> 7259: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="7260"/> 7260: 
<a name="api_a_connect_tcpD-2"/><a name="7261"/> 7261: <b>api_a_connect_tcpD</b>(Domain, Nowait) -&gt;
<a name="7262"/> 7262:     Connect = fun(Sock, SockAddr) -&gt;
<a name="7263"/> 7263:                       socket:connect(Sock, SockAddr, Nowait)
<a name="7264"/> 7264:               end,
<a name="7265"/> 7265:     Send = fun(Sock, Data) -&gt;
<a name="7266"/> 7266:                    socket:send(Sock, Data)
<a name="7267"/> 7267:            end,
<a name="7268"/> 7268:     Recv = fun(Sock) -&gt;
<a name="7269"/> 7269:                    socket:recv(Sock)
<a name="7270"/> 7270:            end,
<a name="7271"/> 7271:     InitState = #{domain =&gt; Domain,
<a name="7272"/> 7272:                   connect =&gt; Connect,
<a name="7273"/> 7273:                   send =&gt; Send,
<a name="7274"/> 7274:                   recv =&gt; Recv,
<a name="7275"/> 7275:                   connect_ref =&gt; Nowait},
<a name="api_a_connect_tcpD-last_expr"/><a name="7276"/> 7276: <b>    api_a_connect_tcp</b>(InitState).
<a name="7277"/> 7277: 
<a name="7278"/> 7278: 
<a name="7279"/> 7279: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="7280"/> 7280: 
<a name="api_a_connect_tcp-1"/><a name="7281"/> 7281: <b>api_a_connect_tcp</b>(InitState) -&gt;
<a name="7282"/> 7282:     process_flag(trap_exit, true),
<a name="7283"/> 7283:     ServerSeq = 
<a name="7284"/> 7284:         [
<a name="7285"/> 7285:          %% *** Wait for start order ***
<a name="7286"/> 7286:          #{desc =&gt; &quot;await start (from tester)&quot;,
<a name="7287"/> 7287:            cmd  =&gt; fun(State) -&gt;
<a name="7288"/> 7288:                            Tester = ?SEV_AWAIT_START(),
<a name="7289"/> 7289:                            {ok, State#{tester =&gt; Tester}}
<a name="7290"/> 7290:                    end},
<a name="7291"/> 7291:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="7292"/> 7292:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="7293"/> 7293:                            _MRef = erlang:monitor(process, Tester),
<a name="7294"/> 7294:                            ok
<a name="7295"/> 7295:                    end},
<a name="7296"/> 7296: 
<a name="7297"/> 7297:          %% *** Init part ***
<a name="7298"/> 7298:          #{desc =&gt; &quot;which local address&quot;,
<a name="7299"/> 7299:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="7300"/> 7300:                            LSA = which_local_socket_addr(Domain),
<a name="7301"/> 7301:                            {ok, State#{lsa =&gt; LSA}}
<a name="7302"/> 7302:                    end},
<a name="7303"/> 7303:          #{desc =&gt; &quot;create listen socket&quot;,
<a name="7304"/> 7304:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="7305"/> 7305:                            case socket:open(Domain, stream, tcp) of
<a name="7306"/> 7306:                                {ok, Sock} -&gt;
<a name="7307"/> 7307:                                    {ok, State#{lsock =&gt; Sock}};
<a name="7308"/> 7308:                                {error, _} = ERROR -&gt;
<a name="7309"/> 7309:                                    ERROR
<a name="7310"/> 7310:                            end
<a name="7311"/> 7311:                    end},
<a name="7312"/> 7312:          #{desc =&gt; &quot;bind to local address&quot;,
<a name="7313"/> 7313:            cmd  =&gt; fun(#{lsock := LSock, lsa := LSA} = State) -&gt;
<a name="7314"/> 7314:                            case sock_bind(LSock, LSA) of
<a name="7315"/> 7315:                                ok -&gt;
<a name="7316"/> 7316:                                    Port = sock_port(LSock),
<a name="7317"/> 7317:                                    {ok, State#{lport =&gt; Port}};
<a name="7318"/> 7318:                                {error, _} = ERROR -&gt;
<a name="7319"/> 7319:                                    ERROR
<a name="7320"/> 7320:                            end
<a name="7321"/> 7321:                    end},
<a name="7322"/> 7322:          #{desc =&gt; &quot;make listen socket&quot;,
<a name="7323"/> 7323:            cmd  =&gt; fun(#{lsock := LSock}) -&gt;
<a name="7324"/> 7324:                            socket:listen(LSock)
<a name="7325"/> 7325:                    end},
<a name="7326"/> 7326:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="7327"/> 7327:            cmd  =&gt; fun(#{tester := Tester, lport := Port}) -&gt;
<a name="7328"/> 7328:                            ?SEV_ANNOUNCE_READY(Tester, init, Port),
<a name="7329"/> 7329:                            ok
<a name="7330"/> 7330:                    end},
<a name="7331"/> 7331: 
<a name="7332"/> 7332:          %% The actual test
<a name="7333"/> 7333:          #{desc =&gt; &quot;await continue (accept)&quot;,
<a name="7334"/> 7334:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="7335"/> 7335:                            ?SEV_AWAIT_CONTINUE(Tester, tester, accept)
<a name="7336"/> 7336:                    end},
<a name="7337"/> 7337:          #{desc =&gt; &quot;await connection&quot;,
<a name="7338"/> 7338:            cmd  =&gt; fun(#{lsock := LSock} = State) -&gt;
<a name="7339"/> 7339:                            case socket:accept(LSock) of
<a name="7340"/> 7340:                                {ok, Sock} -&gt;
<a name="7341"/> 7341:                                    ?SEV_IPRINT(&quot;accepted: ~n   ~p&quot;, [Sock]),
<a name="7342"/> 7342:                                    {ok, State#{csock =&gt; Sock}};
<a name="7343"/> 7343:                                {error, _} = ERROR -&gt;
<a name="7344"/> 7344:                                    ERROR
<a name="7345"/> 7345:                            end
<a name="7346"/> 7346:                    end},
<a name="7347"/> 7347:          #{desc =&gt; &quot;announce ready (accept)&quot;,
<a name="7348"/> 7348:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="7349"/> 7349:                            ?SEV_ANNOUNCE_READY(Tester, accept),
<a name="7350"/> 7350:                            ok
<a name="7351"/> 7351:                    end},
<a name="7352"/> 7352: 
<a name="7353"/> 7353:          #{desc =&gt; &quot;await continue (recv_req)&quot;,
<a name="7354"/> 7354:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="7355"/> 7355:                            ?SEV_AWAIT_CONTINUE(Tester, tester, recv_req)
<a name="7356"/> 7356:                    end},
<a name="7357"/> 7357:          #{desc =&gt; &quot;recv req&quot;,
<a name="7358"/> 7358:            cmd  =&gt; fun(#{csock := Sock, recv := Recv}) -&gt;
<a name="7359"/> 7359:                            case Recv(Sock) of
<a name="7360"/> 7360:                                {ok, ?BASIC_REQ} -&gt;
<a name="7361"/> 7361:                                    ok;
<a name="7362"/> 7362:                                {ok, UnexpData} -&gt;
<a name="7363"/> 7363:                                    {error, {unexpected_data, UnexpData}};
<a name="7364"/> 7364:                                {error, _} = ERROR -&gt;
<a name="7365"/> 7365:                                    %% At the moment there is no way to get
<a name="7366"/> 7366:                                    %% status or state for the socket...
<a name="7367"/> 7367:                                    ERROR
<a name="7368"/> 7368:                            end
<a name="7369"/> 7369:                    end},
<a name="7370"/> 7370:          #{desc =&gt; &quot;announce ready (recv_req)&quot;,
<a name="7371"/> 7371:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="7372"/> 7372:                            ?SEV_ANNOUNCE_READY(Tester, recv_req),
<a name="7373"/> 7373:                            ok
<a name="7374"/> 7374:                    end},
<a name="7375"/> 7375:          #{desc =&gt; &quot;await continue (send_rep)&quot;,
<a name="7376"/> 7376:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="7377"/> 7377:                            ?SEV_AWAIT_CONTINUE(Tester, tester, send_rep)
<a name="7378"/> 7378:                    end},
<a name="7379"/> 7379:          #{desc =&gt; &quot;send rep&quot;,
<a name="7380"/> 7380:            cmd  =&gt; fun(#{csock := Sock, send := Send}) -&gt;
<a name="7381"/> 7381:                            Send(Sock, ?BASIC_REP)
<a name="7382"/> 7382:                    end},
<a name="7383"/> 7383:          #{desc =&gt; &quot;announce ready (send_rep)&quot;,
<a name="7384"/> 7384:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="7385"/> 7385:                            ?SEV_ANNOUNCE_READY(Tester, send_rep),
<a name="7386"/> 7386:                            ok
<a name="7387"/> 7387:                    end},
<a name="7388"/> 7388: 	 
<a name="7389"/> 7389: 
<a name="7390"/> 7390:          %% *** Termination ***
<a name="7391"/> 7391:          #{desc =&gt; &quot;await terminate&quot;,
<a name="7392"/> 7392:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="7393"/> 7393:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="7394"/> 7394:                                ok -&gt;
<a name="7395"/> 7395:                                    {ok, maps:remove(tester, State)};
<a name="7396"/> 7396:                                {error, _} = ERROR -&gt;
<a name="7397"/> 7397:                                    ERROR
<a name="7398"/> 7398:                            end
<a name="7399"/> 7399:                    end},
<a name="7400"/> 7400:          #{desc =&gt; &quot;close connection socket&quot;,
<a name="7401"/> 7401:            cmd  =&gt; fun(#{csock := Sock} = State) -&gt;
<a name="7402"/> 7402:                            ok = socket:close(Sock),
<a name="7403"/> 7403:                            {ok, maps:remove(csock, State)}
<a name="7404"/> 7404:                    end},
<a name="7405"/> 7405:          #{desc =&gt; &quot;close listen socket&quot;,
<a name="7406"/> 7406:            cmd  =&gt; fun(#{lsock := Sock} = State) -&gt;
<a name="7407"/> 7407:                            ok = socket:close(Sock),
<a name="7408"/> 7408:                            {ok, maps:remove(lsock, State)}
<a name="7409"/> 7409:                    end},
<a name="7410"/> 7410: 
<a name="7411"/> 7411:          %% *** We are done ***
<a name="7412"/> 7412:          ?SEV_FINISH_NORMAL
<a name="7413"/> 7413:         ],
<a name="7414"/> 7414: 
<a name="7415"/> 7415:     ClientSeq = 
<a name="7416"/> 7416:         [
<a name="7417"/> 7417:          %% *** Wait for start order ***
<a name="7418"/> 7418:          #{desc =&gt; &quot;await start (from tester)&quot;,
<a name="7419"/> 7419:            cmd  =&gt; fun(State) -&gt;
<a name="7420"/> 7420:                            {Tester, Port} = ?SEV_AWAIT_START(),
<a name="7421"/> 7421:                            {ok, State#{tester =&gt; Tester, server_port =&gt; Port}}
<a name="7422"/> 7422:                    end},
<a name="7423"/> 7423:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="7424"/> 7424:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="7425"/> 7425:                            _MRef = erlang:monitor(process, Tester),
<a name="7426"/> 7426:                            ok
<a name="7427"/> 7427:                    end},
<a name="7428"/> 7428: 
<a name="7429"/> 7429:          %% *** The init part ***
<a name="7430"/> 7430:          #{desc =&gt; &quot;which server (local) address&quot;,
<a name="7431"/> 7431:            cmd  =&gt; fun(#{domain := Domain, server_port := Port} = State) -&gt;
<a name="7432"/> 7432:                            LSA = which_local_socket_addr(Domain),
<a name="7433"/> 7433:                            SSA = LSA#{port =&gt; Port},
<a name="7434"/> 7434:                            {ok, State#{local_sa =&gt; LSA, server_sa =&gt; SSA}}
<a name="7435"/> 7435:                    end},
<a name="7436"/> 7436:          #{desc =&gt; &quot;create socket&quot;,
<a name="7437"/> 7437:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="7438"/> 7438:                            case socket:open(Domain, stream, tcp) of
<a name="7439"/> 7439:                                {ok, Sock} -&gt;
<a name="7440"/> 7440:                                    {ok, State#{sock =&gt; Sock}};
<a name="7441"/> 7441:                                {error, _} = ERROR -&gt;
<a name="7442"/> 7442:                                    ERROR
<a name="7443"/> 7443:                            end
<a name="7444"/> 7444:                    end},
<a name="7445"/> 7445:          #{desc =&gt; &quot;bind to local address&quot;,
<a name="7446"/> 7446:            cmd  =&gt; fun(#{sock := Sock, local_sa := LSA} = _State) -&gt;
<a name="7447"/> 7447:                            case sock_bind(Sock, LSA) of
<a name="7448"/> 7448:                                ok -&gt;
<a name="7449"/> 7449:                                    ok;
<a name="7450"/> 7450:                                {error, _} = ERROR -&gt;
<a name="7451"/> 7451:                                    ERROR
<a name="7452"/> 7452:                            end
<a name="7453"/> 7453:                    end},
<a name="7454"/> 7454:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="7455"/> 7455:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="7456"/> 7456:                            ?SEV_ANNOUNCE_READY(Tester, init),
<a name="7457"/> 7457:                            ok
<a name="7458"/> 7458:                    end},
<a name="7459"/> 7459: 
<a name="7460"/> 7460:          %% *** The actual test ***
<a name="7461"/> 7461:          #{desc =&gt; &quot;await continue (async connect)&quot;,
<a name="7462"/> 7462:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="7463"/> 7463:                            ?SEV_AWAIT_CONTINUE(Tester, tester, async_connect)
<a name="7464"/> 7464:                    end},
<a name="7465"/> 7465:          #{desc =&gt; &quot;connect (async) to server&quot;,
<a name="7466"/> 7466:            cmd  =&gt; fun(#{sock        := Sock,
<a name="7467"/> 7467:                          server_sa   := SSA,
<a name="7468"/> 7468:                          connect     := Connect,
<a name="7469"/> 7469:                          connect_ref := SR} = State) -&gt;
<a name="7470"/> 7470:                            case Connect(Sock, SSA) of
<a name="7471"/> 7471:                                ok -&gt;
<a name="7472"/> 7472:                                    ?SEV_IPRINT(&quot;ok -&gt; &quot;
<a name="7473"/> 7473: 					       &quot;unexpected success =&gt; SKIP&quot;, 
<a name="7474"/> 7474:                                                []),
<a name="7475"/> 7475:                                    {skip, unexpected_success};
<a name="7476"/> 7476: 
<a name="7477"/> 7477:                                {select, {select_info, ST, SelectRef}}
<a name="7478"/> 7478:                                  when SR =:= nowait -&gt;
<a name="7479"/> 7479:                                    ?SEV_IPRINT(&quot;select nowait -&gt;&quot;
<a name="7480"/> 7480:                                                &quot;~n   tag: ~p&quot;
<a name="7481"/> 7481:                                                &quot;~n   ref: ~p&quot;,
<a name="7482"/> 7482:                                                [ST, SelectRef]),
<a name="7483"/> 7483:                                    {ok, State#{asynch_tag  =&gt; select,
<a name="7484"/> 7484:                                                connect_tag =&gt; ST,
<a name="7485"/> 7485:                                                connect_ref =&gt; SelectRef}};
<a name="7486"/> 7486:                                {select, {select_info, ST, SR}}
<a name="7487"/> 7487:                                  when is_reference(SR) -&gt;
<a name="7488"/> 7488:                                    ?SEV_IPRINT(&quot;select ref -&gt;&quot;
<a name="7489"/> 7489:                                                &quot;~n   tag: ~p&quot;
<a name="7490"/> 7490:                                                &quot;~n   ref: ~p&quot;, [ST, SR]),
<a name="7491"/> 7491:                                    {ok, State#{asynch_tag  =&gt; select,
<a name="7492"/> 7492:                                                connect_tag =&gt; ST}};
<a name="7493"/> 7493: 
<a name="7494"/> 7494:                                {completion,
<a name="7495"/> 7495:                                 {completion_info, CT, CompletionRef}}
<a name="7496"/> 7496:                                  when SR =:= nowait -&gt;
<a name="7497"/> 7497:                                    ?SEV_IPRINT(&quot;completion nowait -&gt;&quot;
<a name="7498"/> 7498:                                                &quot;~n   tag: ~p&quot;
<a name="7499"/> 7499:                                                &quot;~n   ref: ~p&quot;,
<a name="7500"/> 7500:                                                [CT, CompletionRef]),
<a name="7501"/> 7501:                                    {ok, State#{asynch_tag  =&gt; completion,
<a name="7502"/> 7502:                                                connect_tag =&gt; CT,
<a name="7503"/> 7503:                                                connect_ref =&gt; CompletionRef}};
<a name="7504"/> 7504:                                {completion,
<a name="7505"/> 7505:                                 {completion_info, CT, CR}}
<a name="7506"/> 7506:                                  when is_reference(CR) -&gt;
<a name="7507"/> 7507:                                    ?SEV_IPRINT(&quot;completion ref -&gt;&quot;
<a name="7508"/> 7508:                                                &quot;~n   tag: ~p&quot;
<a name="7509"/> 7509:                                                &quot;~n   ref: ~p&quot;, [CT, CR]),
<a name="7510"/> 7510:                                    {ok, State#{asynch_tag  =&gt; completion,
<a name="7511"/> 7511:                                                connect_tag =&gt; CT}};
<a name="7512"/> 7512: 
<a name="7513"/> 7513:                                {error, _} = ERROR -&gt;
<a name="7514"/> 7514:                                    ERROR
<a name="7515"/> 7515:                            end
<a name="7516"/> 7516:                    end},
<a name="7517"/> 7517:          #{desc =&gt; &quot;announce ready (connect select|completion)&quot;,
<a name="7518"/> 7518:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="7519"/> 7519:                            ?SEV_ANNOUNCE_READY(Tester, connect_select),
<a name="7520"/> 7520:                            ok
<a name="7521"/> 7521:                    end},
<a name="7522"/> 7522:          #{desc =&gt; &quot;await select|completion message&quot;,
<a name="7523"/> 7523:            cmd  =&gt; fun(#{sock        := Sock,
<a name="7524"/> 7524:                          asynch_tag  := select,
<a name="7525"/> 7525:                          connect_tag := connect,
<a name="7526"/> 7526:                          connect_ref := Ref}) -&gt;
<a name="7527"/> 7527:                            receive
<a name="7528"/> 7528:                                {'$socket', Sock, select, Ref} -&gt;
<a name="7529"/> 7529:                                    ?SEV_IPRINT(&quot;select message -&gt;&quot;
<a name="7530"/> 7530:                                                &quot;~n   ref: ~p&quot;, [Ref]),
<a name="7531"/> 7531:                                    ok
<a name="7532"/> 7532:                            after 5000 -&gt;
<a name="7533"/> 7533:                                    ?SEV_EPRINT(&quot;timeout: &quot;
<a name="7534"/> 7534:                                                &quot;~n   message queue: ~p&quot;,
<a name="7535"/> 7535:                                                [mq()]),
<a name="7536"/> 7536:                                    {error, timeout}
<a name="7537"/> 7537:                            end;
<a name="7538"/> 7538:                       (#{sock        := Sock,
<a name="7539"/> 7539:                          asynch_tag  := completion,
<a name="7540"/> 7540:                          connect_tag := connect,
<a name="7541"/> 7541:                          connect_ref := Ref}) -&gt;
<a name="7542"/> 7542:                            receive
<a name="7543"/> 7543:                                {'$socket', Sock, completion, {Ref, ok = Res}} -&gt;
<a name="7544"/> 7544:                                    ?SEV_IPRINT(&quot;completion message -&gt;&quot;
<a name="7545"/> 7545:                                                &quot;~n   ref: ~p&quot;
<a name="7546"/> 7546:                                                &quot;~n   res: ~p&quot;, [Ref, Res]),
<a name="7547"/> 7547:                                    ok
<a name="7548"/> 7548:                            after 5000 -&gt;
<a name="7549"/> 7549:                                    ?SEV_EPRINT(&quot;timeout: &quot;
<a name="7550"/> 7550:                                                &quot;~n   message queue: ~p&quot;,
<a name="7551"/> 7551:                                                [mq()]),
<a name="7552"/> 7552:                                    {error, timeout}
<a name="7553"/> 7553:                            end
<a name="7554"/> 7554:                    end},
<a name="7555"/> 7555:          #{desc =&gt; &quot;announce ready (select|completion)&quot;,
<a name="7556"/> 7556:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="7557"/> 7557:                            ?SEV_ANNOUNCE_READY(Tester, select),
<a name="7558"/> 7558:                            ok
<a name="7559"/> 7559:                    end},
<a name="7560"/> 7560:          #{desc =&gt; &quot;(maybe) connect (async) to server&quot;,
<a name="7561"/> 7561:            cmd  =&gt; fun(#{sock        := Sock,
<a name="7562"/> 7562:                          server_sa   := SSA,
<a name="7563"/> 7563:                          asynch_tag  := select,
<a name="7564"/> 7564:                          connect_tag := connect,
<a name="7565"/> 7565:                          connect     := Connect}) -&gt;
<a name="7566"/> 7566:                            case Connect(Sock, SSA) of
<a name="7567"/> 7567:                                ok -&gt;
<a name="7568"/> 7568:                                    ok;
<a name="7569"/> 7569:                                {select, SelectInfo} -&gt;
<a name="7570"/> 7570:                                    {error, {unexpected_select, SelectInfo}};
<a name="7571"/> 7571:                                {error, _} = ERROR -&gt;
<a name="7572"/> 7572:                                    ERROR
<a name="7573"/> 7573:                            end;
<a name="7574"/> 7574:                       (#{sock        := _Sock,
<a name="7575"/> 7575:                          server_sa   := _SSA,
<a name="7576"/> 7576:                          asynch_tag  := completion,
<a name="7577"/> 7577:                          connect_tag := connect,
<a name="7578"/> 7578:                          connect     := _Connect}) -&gt;
<a name="7579"/> 7579:                            ok
<a name="7580"/> 7580:                    end},
<a name="7581"/> 7581:          #{desc =&gt; &quot;announce ready (connect)&quot;,
<a name="7582"/> 7582:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="7583"/> 7583:                            ?SEV_ANNOUNCE_READY(Tester, connect),
<a name="7584"/> 7584:                            ok
<a name="7585"/> 7585:                    end},
<a name="7586"/> 7586:          #{desc =&gt; &quot;get peername&quot;,
<a name="7587"/> 7587:            cmd  =&gt; fun(#{sock := Sock} = _State) -&gt;
<a name="7588"/> 7588:                            case socket:peername(Sock) of
<a name="7589"/> 7589:                                {ok, SockAddr} -&gt;
<a name="7590"/> 7590:                                    ?SEV_IPRINT(&quot;Peer Name: ~p&quot;, [SockAddr]),
<a name="7591"/> 7591:                                    ok;
<a name="7592"/> 7592:                                 {error, _} = ERROR -&gt;
<a name="7593"/> 7593:                                    ERROR
<a name="7594"/> 7594:                            end
<a name="7595"/> 7595:                    end},
<a name="7596"/> 7596: 
<a name="7597"/> 7597:          #{desc =&gt; &quot;await continue (send_req)&quot;,
<a name="7598"/> 7598:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="7599"/> 7599:                            ?SEV_AWAIT_CONTINUE(Tester, tester, send_req)
<a name="7600"/> 7600:                    end},
<a name="7601"/> 7601:          #{desc =&gt; &quot;send req&quot;,
<a name="7602"/> 7602:            cmd  =&gt; fun(#{sock := Sock, send := Send}) -&gt;
<a name="7603"/> 7603:                            Send(Sock, ?BASIC_REQ)
<a name="7604"/> 7604:                    end},
<a name="7605"/> 7605:          #{desc =&gt; &quot;announce ready (send_req)&quot;,
<a name="7606"/> 7606:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="7607"/> 7607:                            ?SEV_ANNOUNCE_READY(Tester, send_req),
<a name="7608"/> 7608:                            ok
<a name="7609"/> 7609:                    end},
<a name="7610"/> 7610:          #{desc =&gt; &quot;await continue (recv_rep)&quot;,
<a name="7611"/> 7611:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="7612"/> 7612:                            ?SEV_AWAIT_CONTINUE(Tester, tester, recv_rep)
<a name="7613"/> 7613:                    end},
<a name="7614"/> 7614:          #{desc =&gt; &quot;recv rep&quot;,
<a name="7615"/> 7615:            cmd  =&gt; fun(#{sock := Sock, recv := Recv}) -&gt;
<a name="7616"/> 7616:                            case Recv(Sock) of
<a name="7617"/> 7617:                                {ok, ?BASIC_REP} -&gt;
<a name="7618"/> 7618:                                    ok;
<a name="7619"/> 7619:                                {ok, UnexpData} -&gt;
<a name="7620"/> 7620:                                    {error, {unexpected_data, UnexpData}};
<a name="7621"/> 7621:                                {error, _} = ERROR -&gt;
<a name="7622"/> 7622:                                    %% At the moment there is no way to get
<a name="7623"/> 7623:                                    %% status or state for the socket...
<a name="7624"/> 7624:                                    ERROR
<a name="7625"/> 7625:                            end
<a name="7626"/> 7626:                    end},
<a name="7627"/> 7627:          #{desc =&gt; &quot;announce ready (recv_rep)&quot;,
<a name="7628"/> 7628:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="7629"/> 7629:                            ?SEV_ANNOUNCE_READY(Tester, recv_rep),
<a name="7630"/> 7630:                            ok
<a name="7631"/> 7631:                    end},
<a name="7632"/> 7632: 
<a name="7633"/> 7633:          %% *** Termination ***
<a name="7634"/> 7634:          #{desc =&gt; &quot;await terminate&quot;,
<a name="7635"/> 7635:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="7636"/> 7636:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="7637"/> 7637:                                ok -&gt;
<a name="7638"/> 7638:                                    {ok, maps:remove(tester, State)};
<a name="7639"/> 7639:                                {error, _} = ERROR -&gt;
<a name="7640"/> 7640:                                    ERROR
<a name="7641"/> 7641:                            end
<a name="7642"/> 7642:                    end},
<a name="7643"/> 7643:          #{desc =&gt; &quot;close socket&quot;,
<a name="7644"/> 7644:            cmd  =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="7645"/> 7645:                            ok = socket:close(Sock),
<a name="7646"/> 7646:                            State2 = maps:remove(sock,         State),
<a name="7647"/> 7647:                            State3 = maps:remove(connect_stag, State2),
<a name="7648"/> 7648:                            State4 = maps:remove(connect_sref, State3),
<a name="7649"/> 7649:                            {ok, State4}
<a name="7650"/> 7650:                    end},
<a name="7651"/> 7651: 
<a name="7652"/> 7652:          %% *** We are done ***
<a name="7653"/> 7653:          ?SEV_FINISH_NORMAL
<a name="7654"/> 7654:         ],
<a name="7655"/> 7655: 
<a name="7656"/> 7656:     TesterSeq =
<a name="7657"/> 7657:         [
<a name="7658"/> 7658:          %% *** Init part ***
<a name="7659"/> 7659:          #{desc =&gt; &quot;monitor server&quot;,
<a name="7660"/> 7660:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="7661"/> 7661:                            _MRef = erlang:monitor(process, Pid),
<a name="7662"/> 7662:                            ok
<a name="7663"/> 7663:                    end},
<a name="7664"/> 7664:          #{desc =&gt; &quot;monitor client&quot;,
<a name="7665"/> 7665:            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;
<a name="7666"/> 7666:                            _MRef = erlang:monitor(process, Pid),
<a name="7667"/> 7667:                            ok
<a name="7668"/> 7668:                    end},
<a name="7669"/> 7669: 
<a name="7670"/> 7670:          %% Start the server
<a name="7671"/> 7671:          #{desc =&gt; &quot;order server start&quot;,
<a name="7672"/> 7672:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="7673"/> 7673:                            ?SEV_ANNOUNCE_START(Pid),
<a name="7674"/> 7674:                            ok
<a name="7675"/> 7675:                    end},
<a name="7676"/> 7676:          #{desc =&gt; &quot;await server ready (init)&quot;,
<a name="7677"/> 7677:            cmd  =&gt; fun(#{server := Pid} = State) -&gt;
<a name="7678"/> 7678:                            {ok, Port} = ?SEV_AWAIT_READY(Pid, server, init),
<a name="7679"/> 7679:                            {ok, State#{server_port =&gt; Port}}
<a name="7680"/> 7680:                    end},
<a name="7681"/> 7681: 
<a name="7682"/> 7682:          %% Start the client
<a name="7683"/> 7683:          #{desc =&gt; &quot;order client start&quot;,
<a name="7684"/> 7684:            cmd  =&gt; fun(#{client := Pid, server_port := Port} = _State) -&gt;
<a name="7685"/> 7685:                            ?SEV_ANNOUNCE_START(Pid, Port),
<a name="7686"/> 7686:                            ok
<a name="7687"/> 7687:                    end},
<a name="7688"/> 7688:          #{desc =&gt; &quot;await client ready (init)&quot;,
<a name="7689"/> 7689:            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;
<a name="7690"/> 7690:                            ok = ?SEV_AWAIT_READY(Pid, client, init)
<a name="7691"/> 7691:                    end},
<a name="7692"/> 7692: 
<a name="7693"/> 7693: 
<a name="7694"/> 7694:          %% *** The actual test ***
<a name="7695"/> 7695:          #{desc =&gt; &quot;order client to continue (async connect)&quot;,
<a name="7696"/> 7696:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="7697"/> 7697:                            ?SEV_ANNOUNCE_CONTINUE(Client, async_connect),
<a name="7698"/> 7698:                            ok
<a name="7699"/> 7699:                    end},
<a name="7700"/> 7700:          #{desc =&gt; &quot;await client ready (connect select)&quot;,
<a name="7701"/> 7701:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="7702"/> 7702:                            ?SEV_AWAIT_READY(Client, client, connect_select)
<a name="7703"/> 7703:                    end},
<a name="7704"/> 7704: 
<a name="7705"/> 7705:          ?SEV_SLEEP(?SECS(1)),
<a name="7706"/> 7706: 
<a name="7707"/> 7707:          #{desc =&gt; &quot;order server to continue (with accept)&quot;,
<a name="7708"/> 7708:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="7709"/> 7709:                            ?SEV_ANNOUNCE_CONTINUE(Server, accept),
<a name="7710"/> 7710:                            ok
<a name="7711"/> 7711:                    end},
<a name="7712"/> 7712:          #{desc =&gt; &quot;await client ready (select)&quot;,
<a name="7713"/> 7713:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="7714"/> 7714:                            ?SEV_AWAIT_READY(Client, client, select)
<a name="7715"/> 7715:                    end},
<a name="7716"/> 7716:          #{desc =&gt; &quot;await client ready (connect)&quot;,
<a name="7717"/> 7717:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="7718"/> 7718:                            ?SEV_AWAIT_READY(Client, client, connect)
<a name="7719"/> 7719:                    end},
<a name="7720"/> 7720:          #{desc =&gt; &quot;await server ready (accept)&quot;,
<a name="7721"/> 7721:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="7722"/> 7722:                            ?SEV_AWAIT_READY(Server, server, accept)
<a name="7723"/> 7723:                    end},
<a name="7724"/> 7724: 
<a name="7725"/> 7725:          ?SEV_SLEEP(?SECS(1)),
<a name="7726"/> 7726: 
<a name="7727"/> 7727:          #{desc =&gt; &quot;order server to recv test req (recv req)&quot;,
<a name="7728"/> 7728:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="7729"/> 7729:                            ?SEV_ANNOUNCE_CONTINUE(Server, recv_req),
<a name="7730"/> 7730:                            ok
<a name="7731"/> 7731:                    end},
<a name="7732"/> 7732:          #{desc =&gt; &quot;order client to send test req (send req)&quot;,
<a name="7733"/> 7733:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="7734"/> 7734:                            ?SEV_ANNOUNCE_CONTINUE(Client, send_req),
<a name="7735"/> 7735:                            ok
<a name="7736"/> 7736:                    end},
<a name="7737"/> 7737:          #{desc =&gt; &quot;await client ready (send_req)&quot;,
<a name="7738"/> 7738:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="7739"/> 7739:                            ?SEV_AWAIT_READY(Client, client, send_req)
<a name="7740"/> 7740:                    end},
<a name="7741"/> 7741:          #{desc =&gt; &quot;await server ready (recv_req)&quot;,
<a name="7742"/> 7742:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="7743"/> 7743:                            ?SEV_AWAIT_READY(Server, server, recv_req)
<a name="7744"/> 7744:                    end},
<a name="7745"/> 7745:          #{desc =&gt; &quot;order client to recv test rep (send rep)&quot;,
<a name="7746"/> 7746:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="7747"/> 7747:                            ?SEV_ANNOUNCE_CONTINUE(Client, recv_rep),
<a name="7748"/> 7748:                            ok
<a name="7749"/> 7749:                    end},
<a name="7750"/> 7750:          #{desc =&gt; &quot;order server to send test rep (send rep)&quot;,
<a name="7751"/> 7751:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="7752"/> 7752:                            ?SEV_ANNOUNCE_CONTINUE(Server, send_rep),
<a name="7753"/> 7753:                            ok
<a name="7754"/> 7754:                    end},
<a name="7755"/> 7755:          #{desc =&gt; &quot;await server ready (send_rep)&quot;,
<a name="7756"/> 7756:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="7757"/> 7757:                            ?SEV_AWAIT_READY(Server, server, send_rep)
<a name="7758"/> 7758:                    end},
<a name="7759"/> 7759:          #{desc =&gt; &quot;await client ready (recv_rep)&quot;,
<a name="7760"/> 7760:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="7761"/> 7761:                            ?SEV_AWAIT_READY(Client, client, recv_rep)
<a name="7762"/> 7762:                    end},
<a name="7763"/> 7763: 
<a name="7764"/> 7764: 
<a name="7765"/> 7765:          %% *** Termination ***
<a name="7766"/> 7766:          #{desc =&gt; &quot;order client to terminate&quot;,
<a name="7767"/> 7767:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="7768"/> 7768:                            ?SEV_ANNOUNCE_TERMINATE(Client),
<a name="7769"/> 7769:                            ok
<a name="7770"/> 7770:                    end},
<a name="7771"/> 7771:          #{desc =&gt; &quot;await client termination&quot;,
<a name="7772"/> 7772:            cmd  =&gt; fun(#{client := Client} = State) -&gt;
<a name="7773"/> 7773:                            ?SEV_AWAIT_TERMINATION(Client),
<a name="7774"/> 7774:                            State1 = maps:remove(client, State),
<a name="7775"/> 7775:                            {ok, State1}
<a name="7776"/> 7776:                    end},
<a name="7777"/> 7777:          #{desc =&gt; &quot;order server to terminate&quot;,
<a name="7778"/> 7778:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="7779"/> 7779:                            ?SEV_ANNOUNCE_TERMINATE(Server),
<a name="7780"/> 7780:                            ok
<a name="7781"/> 7781:                    end},
<a name="7782"/> 7782:          #{desc =&gt; &quot;await server termination&quot;,
<a name="7783"/> 7783:            cmd  =&gt; fun(#{server := Server} = State) -&gt;
<a name="7784"/> 7784:                            ?SEV_AWAIT_TERMINATION(Server),
<a name="7785"/> 7785:                            State1 = maps:remove(server, State),
<a name="7786"/> 7786:                            {ok, State1}
<a name="7787"/> 7787:                    end},
<a name="7788"/> 7788: 
<a name="7789"/> 7789:          %% *** We are done ***
<a name="7790"/> 7790:          ?SEV_FINISH_NORMAL
<a name="7791"/> 7791:         ],
<a name="7792"/> 7792: 
<a name="7793"/> 7793:     i(&quot;start server evaluator&quot;),
<a name="7794"/> 7794:     Server = ?SEV_START(&quot;server&quot;, ServerSeq, InitState),
<a name="7795"/> 7795: 
<a name="7796"/> 7796:     i(&quot;start client evaluator&quot;),
<a name="7797"/> 7797:     Client = ?SEV_START(&quot;client&quot;, ClientSeq, InitState),
<a name="7798"/> 7798:     i(&quot;await evaluator(s)&quot;),
<a name="7799"/> 7799: 
<a name="7800"/> 7800:     i(&quot;start tester evaluator&quot;),
<a name="7801"/> 7801:     TesterInitState = #{server =&gt; Server#ev.pid,
<a name="7802"/> 7802:                         client =&gt; Client#ev.pid},
<a name="7803"/> 7803:     Tester = ?SEV_START(&quot;tester&quot;, TesterSeq, TesterInitState),
<a name="7804"/> 7804: 
<a name="api_a_connect_tcp-last_expr"/><a name="7805"/> 7805: <b>    ok = ?SEV_AWAIT_FINISH</b>([Server, Client, Tester]).
<a name="7806"/> 7806: 
<a name="7807"/> 7807: 
<a name="7808"/> 7808: 
<a name="7809"/> 7809: 
<a name="7810"/> 7810: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="7811"/> 7811: 
<a name="7812"/> 7812: <i>%% Basically send and receive on an IPv4 UDP (dgram) socket using</i>
<a name="7813"/> 7813: <i>%% sendto and recvfrom. But we try to be async. That is, we use</i>
<a name="7814"/> 7814: <i>%% the 'nowait' value for the Timeout argument (and await the eventual</i>
<a name="7815"/> 7815: <i>%% select message). Note that we only do this for the recvfrom,</i>
<a name="7816"/> 7816: <i>%% since its much more difficult to &quot;arrange&quot; for sendto.</i>
<a name="7817"/> 7817: <i>%%</i>
<a name="api_a_sendto_and_recvfrom_udp4-1"/><a name="7818"/> 7818: <b>api_a_sendto_and_recvfrom_udp4</b>(Config) when is_list(Config) -&gt;
<a name="7819"/> 7819:     ?TT(?SECS(5)),
<a name="7820"/> 7820:     Nowait = nowait(Config),
<a name="api_a_sendto_and_recvfrom_udp4-last_expr"/><a name="7821"/> 7821: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="7822"/> 7822:            fun() -&gt; has_support_ipv4() end,
<a name="7823"/> 7823:            fun() -&gt;
<a name="7824"/> 7824:                    Send = fun(Sock, Data, Dest) -&gt;
<a name="7825"/> 7825:                                   socket:sendto(Sock, Data, Dest)
<a name="7826"/> 7826:                           end,
<a name="7827"/> 7827:                    Recv = fun(Sock) -&gt;
<a name="7828"/> 7828:                                   socket:recvfrom(Sock, 0, Nowait)
<a name="7829"/> 7829:                           end,
<a name="7830"/> 7830:                    InitState = #{domain   =&gt; inet,
<a name="7831"/> 7831:                                  send     =&gt; Send,
<a name="7832"/> 7832:                                  recv     =&gt; Recv,
<a name="7833"/> 7833:                                  recv_ref =&gt; Nowait},
<a name="7834"/> 7834:                    ok = api_a_send_and_recv_udp(InitState)
<a name="7835"/> 7835:            end).
<a name="7836"/> 7836: 
<a name="7837"/> 7837: 
<a name="7838"/> 7838: 
<a name="7839"/> 7839: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="7840"/> 7840: 
<a name="7841"/> 7841: <i>%% Basically send and receive on an IPv6 UDP (dgram) socket using</i>
<a name="7842"/> 7842: <i>%% sendto and recvfrom. But we try to be async. That is, we use</i>
<a name="7843"/> 7843: <i>%% the 'nowait' value for the Timeout argument (and await the eventual</i>
<a name="7844"/> 7844: <i>%% select message). Note that we only do this for the recvfrom,</i>
<a name="7845"/> 7845: <i>%% since its much more difficult to &quot;arrange&quot; for sendto.</i>
<a name="7846"/> 7846: <i>%%</i>
<a name="api_a_sendto_and_recvfrom_udp6-1"/><a name="7847"/> 7847: <b>api_a_sendto_and_recvfrom_udp6</b>(Config) when is_list(Config) -&gt;
<a name="7848"/> 7848:     ?TT(?SECS(5)),
<a name="7849"/> 7849:     Nowait = nowait(Config),
<a name="api_a_sendto_and_recvfrom_udp6-last_expr"/><a name="7850"/> 7850: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="7851"/> 7851:            fun() -&gt; has_support_ipv6() end,
<a name="7852"/> 7852:            fun() -&gt;
<a name="7853"/> 7853:                    Send = fun(Sock, Data, Dest) -&gt;
<a name="7854"/> 7854:                                   socket:sendto(Sock, Data, Dest)
<a name="7855"/> 7855:                           end,
<a name="7856"/> 7856:                    Recv = fun(Sock) -&gt;
<a name="7857"/> 7857:                                   socket:recvfrom(Sock, 0, Nowait)
<a name="7858"/> 7858:                           end,
<a name="7859"/> 7859:                    InitState = #{domain   =&gt; inet6,
<a name="7860"/> 7860:                                  send     =&gt; Send,
<a name="7861"/> 7861:                                  recv     =&gt; Recv,
<a name="7862"/> 7862:                                  recv_ref =&gt; Nowait},
<a name="7863"/> 7863:                    ok = api_a_send_and_recv_udp(InitState)
<a name="7864"/> 7864:            end).
<a name="7865"/> 7865: 
<a name="7866"/> 7866: 
<a name="7867"/> 7867: 
<a name="7868"/> 7868: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="7869"/> 7869: 
<a name="7870"/> 7870: <i>%% Basically send and receive on an IPv4 UDP (dgram) socket using</i>
<a name="7871"/> 7871: <i>%% sendto and recvfrom. But we try to be async. That is, we use</i>
<a name="7872"/> 7872: <i>%% the 'nowait' value for the Timeout argument (and await the eventual</i>
<a name="7873"/> 7873: <i>%% select message). Note that we only do this for the recvmsg,</i>
<a name="7874"/> 7874: <i>%% since its much more difficult to &quot;arrange&quot; for sendmsg.</i>
<a name="7875"/> 7875: <i>%%</i>
<a name="api_a_sendmsg_and_recvmsg_udp4-1"/><a name="7876"/> 7876: <b>api_a_sendmsg_and_recvmsg_udp4</b>(Config) when is_list(Config) -&gt;
<a name="7877"/> 7877:     ?TT(?SECS(5)),
<a name="7878"/> 7878:     Nowait = nowait(Config),
<a name="api_a_sendmsg_and_recvmsg_udp4-last_expr"/><a name="7879"/> 7879: <b>    tc_try</b>(api_a_sendmsg_and_recvmsg_udp4,
<a name="7880"/> 7880:            fun() -&gt; has_support_ipv4() end,
<a name="7881"/> 7881:            fun() -&gt;
<a name="7882"/> 7882:                    Send = fun(Sock, Data, Dest) -&gt;
<a name="7883"/> 7883:                                   Msg = #{addr =&gt; Dest,
<a name="7884"/> 7884:                                              %% ctrl =&gt; CMsgs,
<a name="7885"/> 7885:                                              iov  =&gt; [Data]},
<a name="7886"/> 7886:                                   socket:sendmsg(Sock, Msg)
<a name="7887"/> 7887:                           end,
<a name="7888"/> 7888:                    Recv = fun(Sock) -&gt;
<a name="7889"/> 7889:                                   case socket:recvmsg(Sock, Nowait) of
<a name="7890"/> 7890:                                       {ok, #{addr  := Source,
<a name="7891"/> 7891:                                              iov   := [Data]}} -&gt;
<a name="7892"/> 7892:                                           {ok, {Source, Data}};
<a name="7893"/> 7893:                                       {ok, _} = OK -&gt;
<a name="7894"/> 7894:                                           OK;
<a name="7895"/> 7895:                                       {select, _} = SELECT -&gt;
<a name="7896"/> 7896:                                           SELECT;
<a name="7897"/> 7897:                                       {completion, _} = COMPLETION -&gt;
<a name="7898"/> 7898:                                           COMPLETION;
<a name="7899"/> 7899:                                       {error, _} = ERROR -&gt;
<a name="7900"/> 7900:                                           ERROR
<a name="7901"/> 7901:                                   end
<a name="7902"/> 7902:                           end,
<a name="7903"/> 7903:                    InitState = #{domain   =&gt; inet,
<a name="7904"/> 7904:                                  send     =&gt; Send,
<a name="7905"/> 7905:                                  recv     =&gt; Recv,
<a name="7906"/> 7906:                                  recv_ref =&gt; Nowait},
<a name="7907"/> 7907:                    ok = api_a_send_and_recv_udp(InitState)
<a name="7908"/> 7908:            end).
<a name="7909"/> 7909: 
<a name="7910"/> 7910: 
<a name="7911"/> 7911: 
<a name="7912"/> 7912: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="7913"/> 7913: 
<a name="7914"/> 7914: <i>%% Basically send and receive on an IPv6 UDP (dgram) socket using</i>
<a name="7915"/> 7915: <i>%% sendto and recvfrom. But we try to be async. That is, we use</i>
<a name="7916"/> 7916: <i>%% the 'nowait' value for the Timeout argument (and await the eventual</i>
<a name="7917"/> 7917: <i>%% select message). Note that we only do this for the recvmsg,</i>
<a name="7918"/> 7918: <i>%% since its much more difficult to &quot;arrange&quot; for sendmsg.</i>
<a name="7919"/> 7919: <i>%%</i>
<a name="api_a_sendmsg_and_recvmsg_udp6-1"/><a name="7920"/> 7920: <b>api_a_sendmsg_and_recvmsg_udp6</b>(Config) when is_list(Config) -&gt;
<a name="7921"/> 7921:     ?TT(?SECS(5)),
<a name="7922"/> 7922:     Nowait = nowait(Config),
<a name="api_a_sendmsg_and_recvmsg_udp6-last_expr"/><a name="7923"/> 7923: <b>    tc_try</b>(api_a_sendmsg_and_recvmsg_udp6,
<a name="7924"/> 7924:            fun() -&gt; has_support_ipv6() end,
<a name="7925"/> 7925:            fun() -&gt;
<a name="7926"/> 7926:                    Send = fun(Sock, Data, Dest) -&gt;
<a name="7927"/> 7927:                                   Msg = #{addr =&gt; Dest,
<a name="7928"/> 7928:                                              %% ctrl =&gt; CMsgs,
<a name="7929"/> 7929:                                              iov  =&gt; [Data]},
<a name="7930"/> 7930:                                   socket:sendmsg(Sock, Msg)
<a name="7931"/> 7931:                           end,
<a name="7932"/> 7932:                    Recv = fun(Sock) -&gt;
<a name="7933"/> 7933:                                   case socket:recvmsg(Sock, Nowait) of
<a name="7934"/> 7934:                                       {ok, #{addr  := Source,
<a name="7935"/> 7935:                                              iov   := [Data]}} -&gt;
<a name="7936"/> 7936:                                           {ok, {Source, Data}};
<a name="7937"/> 7937:                                       {ok, _} = OK -&gt;
<a name="7938"/> 7938:                                           OK;
<a name="7939"/> 7939:                                       {select, _} = SELECT -&gt;
<a name="7940"/> 7940:                                           SELECT;
<a name="7941"/> 7941:                                       {completion, _} = COMPLETION -&gt;
<a name="7942"/> 7942:                                           COMPLETION;
<a name="7943"/> 7943:                                       {error, _} = ERROR -&gt;
<a name="7944"/> 7944:                                           ERROR
<a name="7945"/> 7945:                                   end
<a name="7946"/> 7946:                           end,
<a name="7947"/> 7947:                    InitState = #{domain   =&gt; inet6,
<a name="7948"/> 7948:                                  send     =&gt; Send,
<a name="7949"/> 7949:                                  recv     =&gt; Recv,
<a name="7950"/> 7950:                                  recv_ref =&gt; Nowait},
<a name="7951"/> 7951:                    ok = api_a_send_and_recv_udp(InitState)
<a name="7952"/> 7952:            end).
<a name="7953"/> 7953: 
<a name="7954"/> 7954: 
<a name="7955"/> 7955: 
<a name="7956"/> 7956: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="7957"/> 7957: 
<a name="api_a_send_and_recv_udp-1"/><a name="7958"/> 7958: <b>api_a_send_and_recv_udp</b>(InitState) -&gt;
<a name="7959"/> 7959:     ServerSeq = 
<a name="7960"/> 7960:         [
<a name="7961"/> 7961:          %% *** Wait for start order part ***
<a name="7962"/> 7962:          #{desc =&gt; &quot;await start&quot;,
<a name="7963"/> 7963:            cmd  =&gt; fun(State) -&gt;
<a name="7964"/> 7964:                            Tester = ?SEV_AWAIT_START(),
<a name="7965"/> 7965:                            {ok, State#{tester =&gt; Tester}}
<a name="7966"/> 7966:                    end},
<a name="7967"/> 7967:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="7968"/> 7968:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="7969"/> 7969:                            _MRef = erlang:monitor(process, Tester),
<a name="7970"/> 7970:                            ok
<a name="7971"/> 7971:                    end},
<a name="7972"/> 7972: 
<a name="7973"/> 7973:          %% *** Init part ***
<a name="7974"/> 7974:          #{desc =&gt; &quot;which local address&quot;,
<a name="7975"/> 7975:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="7976"/> 7976:                            LSA = which_local_socket_addr(Domain),
<a name="7977"/> 7977:                            {ok, State#{local_sa =&gt; LSA}}
<a name="7978"/> 7978:                    end},
<a name="7979"/> 7979:          #{desc =&gt; &quot;create socket&quot;,
<a name="7980"/> 7980:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="7981"/> 7981:                            case socket:open(Domain, dgram, udp) of
<a name="7982"/> 7982:                                {ok, Sock} -&gt;
<a name="7983"/> 7983:                                    {ok, State#{sock =&gt; Sock}};
<a name="7984"/> 7984:                                {error, _} = ERROR -&gt;
<a name="7985"/> 7985:                                    ERROR
<a name="7986"/> 7986:                            end
<a name="7987"/> 7987:                    end},
<a name="7988"/> 7988:          #{desc =&gt; &quot;bind socket (to local address)&quot;,
<a name="7989"/> 7989:            cmd  =&gt; fun(#{sock := Sock, local_sa := LSA} = State) -&gt;
<a name="7990"/> 7990:                            case sock_bind(Sock, LSA) of
<a name="7991"/> 7991:                                ok -&gt;
<a name="7992"/> 7992:                                    Port = sock_port(Sock),
<a name="7993"/> 7993:                                    {ok, State#{port =&gt; Port}};
<a name="7994"/> 7994:                                {error, _} = ERROR -&gt;
<a name="7995"/> 7995:                                    ERROR
<a name="7996"/> 7996:                            end
<a name="7997"/> 7997:                    end},
<a name="7998"/> 7998:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="7999"/> 7999:            cmd  =&gt; fun(#{tester := Tester, local_sa := LSA, port := Port}) -&gt;
<a name="8000"/> 8000:                            ServerSA = LSA#{port =&gt; Port},
<a name="8001"/> 8001:                            ?SEV_ANNOUNCE_READY(Tester, init, ServerSA),
<a name="8002"/> 8002:                            ok
<a name="8003"/> 8003:                    end},
<a name="8004"/> 8004: 
<a name="8005"/> 8005:          %% The actual test
<a name="8006"/> 8006:          #{desc =&gt; &quot;await continue (recv)&quot;,
<a name="8007"/> 8007:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="8008"/> 8008:                            ?SEV_AWAIT_CONTINUE(Tester, tester, recv)
<a name="8009"/> 8009:                    end},
<a name="8010"/> 8010:          #{desc =&gt; &quot;try recv request (with nowait, expect select)&quot;,
<a name="8011"/> 8011:            cmd  =&gt; fun(#{sock     := Sock,
<a name="8012"/> 8012:                          recv     := Recv,
<a name="8013"/> 8013:                          recv_ref := Ref} = State) -&gt;
<a name="8014"/> 8014:                            case Recv(Sock) of
<a name="8015"/> 8015:                                {select, {select_info, Tag, RecvRef}}
<a name="8016"/> 8016:                                  when Ref =:= nowait -&gt;
<a name="8017"/> 8017:                                    ?SEV_IPRINT(&quot;expected select nowait: &quot;
<a name="8018"/> 8018:                                                &quot;~n   Tag: ~p&quot;
<a name="8019"/> 8019:                                                &quot;~n   Ref: ~p&quot;, [Tag, RecvRef]),
<a name="8020"/> 8020:                                    {ok, State#{async_tag =&gt; select,
<a name="8021"/> 8021:                                                recv_tag  =&gt; Tag,
<a name="8022"/> 8022:                                                recv_ref  =&gt; RecvRef}};
<a name="8023"/> 8023:                                {select, {select_info, Tag, Ref}}
<a name="8024"/> 8024:                                  when is_reference(Ref) -&gt;
<a name="8025"/> 8025:                                    ?SEV_IPRINT(&quot;expected select ref: &quot;
<a name="8026"/> 8026:                                                &quot;~n   Tag: ~p&quot;
<a name="8027"/> 8027:                                                &quot;~n   Ref: ~p&quot;, [Tag, Ref]),
<a name="8028"/> 8028:                                    {ok, State#{async_tag =&gt; select,
<a name="8029"/> 8029:                                                recv_tag  =&gt; Tag}};
<a name="8030"/> 8030: 
<a name="8031"/> 8031:                                {completion, {completion_info, Tag, RecvRef}}
<a name="8032"/> 8032:                                  when Ref =:= nowait -&gt;
<a name="8033"/> 8033:                                    ?SEV_IPRINT(&quot;expected select nowait: &quot;
<a name="8034"/> 8034:                                                &quot;~n   Tag: ~p&quot;
<a name="8035"/> 8035:                                                &quot;~n   Ref: ~p&quot;, [Tag, RecvRef]),
<a name="8036"/> 8036:                                    {ok, State#{async_tag =&gt; completion,
<a name="8037"/> 8037:                                                recv_tag  =&gt; Tag,
<a name="8038"/> 8038:                                                recv_ref  =&gt; RecvRef}};
<a name="8039"/> 8039:                                {completion, {completion_info, Tag, Ref}}
<a name="8040"/> 8040:                                  when is_reference(Ref) -&gt;
<a name="8041"/> 8041:                                    ?SEV_IPRINT(&quot;expected completion ref: &quot;
<a name="8042"/> 8042:                                                &quot;~n   Tag: ~p&quot;
<a name="8043"/> 8043:                                                &quot;~n   Ref: ~p&quot;, [Tag, Ref]),
<a name="8044"/> 8044:                                    {ok, State#{async_tag =&gt; completion,
<a name="8045"/> 8045:                                                recv_tag  =&gt; Tag}};
<a name="8046"/> 8046: 
<a name="8047"/> 8047:                                {ok, X} -&gt;
<a name="8048"/> 8048:                                    {error, {unexpected_success, X}};
<a name="8049"/> 8049: 
<a name="8050"/> 8050:                                {error, _} = ERROR -&gt;
<a name="8051"/> 8051:                                    ERROR
<a name="8052"/> 8052:                            end
<a name="8053"/> 8053:                    end},
<a name="8054"/> 8054:          #{desc =&gt; &quot;announce ready (recv_select)&quot;,
<a name="8055"/> 8055:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="8056"/> 8056:                            ?SEV_ANNOUNCE_READY(Tester, recv_select),
<a name="8057"/> 8057:                            ok
<a name="8058"/> 8058:                    end},
<a name="8059"/> 8059:          #{desc =&gt; &quot;await select|completion message&quot;,
<a name="8060"/> 8060:            cmd  =&gt; fun(#{async_tag := select,
<a name="8061"/> 8061:                          sock      := Sock,
<a name="8062"/> 8062:                          recv_ref  := RecvRef}) -&gt;
<a name="8063"/> 8063:                            receive
<a name="8064"/> 8064:                                {'$socket', Sock, select, RecvRef} -&gt;
<a name="8065"/> 8065:                                    ok
<a name="8066"/> 8066:                            after 5000 -&gt;
<a name="8067"/> 8067:                                    ?SEV_EPRINT(&quot;timeout when: &quot;
<a name="8068"/> 8068:                                                &quot;~n   Socket Info:   ~p&quot;
<a name="8069"/> 8069:                                                &quot;~n   Message Queue: ~p&quot;,
<a name="8070"/> 8070:                                                [socket:info(Sock), mq()]),
<a name="8071"/> 8071:                                    {error, timeout}
<a name="8072"/> 8072:                            end;
<a name="8073"/> 8073:                       (#{async_tag := completion,
<a name="8074"/> 8074:                          sock      := Sock,
<a name="8075"/> 8075:                          recv_ref  := RecvRef} = State) -&gt;
<a name="8076"/> 8076:                            receive
<a name="8077"/> 8077:                                %% Recvfrom
<a name="8078"/> 8078:                                {'$socket', Sock, completion,
<a name="8079"/> 8079:                                 {RecvRef, {ok, {Src, ?BASIC_REQ}}}} -&gt;
<a name="8080"/> 8080:                                    {ok, State#{req_src =&gt; Src}};
<a name="8081"/> 8081:                                %% Recvmsg
<a name="8082"/> 8082:                                {'$socket', Sock, completion,
<a name="8083"/> 8083:                                 {RecvRef, {ok, #{addr := Src,
<a name="8084"/> 8084:                                                  iov  := [?BASIC_REQ]}}}} -&gt;
<a name="8085"/> 8085:                                    {ok, State#{req_src =&gt; Src}};
<a name="8086"/> 8086:                                {'$socket', Sock, completion,
<a name="8087"/> 8087:                                 {RecvRef, {ok, Unexpected}}} -&gt;
<a name="8088"/> 8088:                                    ?SEV_EPRINT(&quot;Unexpected success result: &quot;
<a name="8089"/> 8089:                                                &quot;~n   ~p&quot;, [Unexpected]),
<a name="8090"/> 8090:                                    {error, {unexpected_success_result,
<a name="8091"/> 8091:                                             Unexpected}};
<a name="8092"/> 8092:                                {'$socket', Sock, completion,
<a name="8093"/> 8093:                                 {RecvRef, {error, Reason} = ERROR}} -&gt;
<a name="8094"/> 8094:                                    ?SEV_EPRINT(&quot;completion with error: &quot;
<a name="8095"/> 8095:                                                &quot;~n   ~p&quot;, [Reason]),
<a name="8096"/> 8096:                                    ERROR
<a name="8097"/> 8097:                            after 5000 -&gt;
<a name="8098"/> 8098:                                    ?SEV_EPRINT(&quot;timeout when: &quot;
<a name="8099"/> 8099:                                                &quot;~n   Socket Info:   ~p&quot;
<a name="8100"/> 8100:                                                &quot;~n   Message Queue: ~p&quot;,
<a name="8101"/> 8101:                                                [socket:info(Sock), mq()]),
<a name="8102"/> 8102:                                    {error, timeout}
<a name="8103"/> 8103:                            end
<a name="8104"/> 8104:                    end},
<a name="8105"/> 8105:          #{desc =&gt; &quot;announce ready (select)&quot;,
<a name="8106"/> 8106:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="8107"/> 8107:                            %% We are actually done *if* this was
<a name="8108"/> 8108:                            %% a completion event, but to make the
<a name="8109"/> 8109:                            %% test case simple...
<a name="8110"/> 8110:                            ?SEV_ANNOUNCE_READY(Tester, select),
<a name="8111"/> 8111:                            ok
<a name="8112"/> 8112:                    end},
<a name="8113"/> 8113:          #{desc =&gt; &quot;now read the data (request), for select&quot;,
<a name="8114"/> 8114:            cmd  =&gt; fun(#{async_tag := select,
<a name="8115"/> 8115:                          sock      := Sock,
<a name="8116"/> 8116:                          recv      := Recv} = State) -&gt;
<a name="8117"/> 8117:                            case Recv(Sock) of
<a name="8118"/> 8118:                                {ok, {Src, ?BASIC_REQ}} -&gt;
<a name="8119"/> 8119:                                    {ok, State#{req_src =&gt; Src}};
<a name="8120"/> 8120:                                {error, _} = ERROR -&gt;
<a name="8121"/> 8121:                                    ERROR
<a name="8122"/> 8122:                            end;
<a name="8123"/> 8123:                       (#{async_tag := completion} = _State) -&gt;
<a name="8124"/> 8124:                            %% We are already done!
<a name="8125"/> 8125:                            ?SEV_IPRINT(&quot;Already done!&quot;),
<a name="8126"/> 8126:                            ok
<a name="8127"/> 8127:                    end},
<a name="8128"/> 8128:          #{desc =&gt; &quot;announce ready (recv request)&quot;,
<a name="8129"/> 8129:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="8130"/> 8130:                            ?SEV_ANNOUNCE_READY(Tester, recv_req),
<a name="8131"/> 8131:                            ok
<a name="8132"/> 8132:                    end},
<a name="8133"/> 8133: 
<a name="8134"/> 8134:          #{desc =&gt; &quot;await continue (send reply)&quot;,
<a name="8135"/> 8135:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="8136"/> 8136:                            ?SEV_AWAIT_CONTINUE(Tester, tester, send_reply)
<a name="8137"/> 8137:                    end},
<a name="8138"/> 8138:          #{desc =&gt; &quot;send reply&quot;,
<a name="8139"/> 8139:            cmd  =&gt; fun(#{sock := Sock, req_src := Src, send := Send}) -&gt;
<a name="8140"/> 8140:                            Send(Sock, ?BASIC_REP, Src)
<a name="8141"/> 8141:                    end},
<a name="8142"/> 8142:          #{desc =&gt; &quot;announce ready (send)&quot;,
<a name="8143"/> 8143:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="8144"/> 8144:                            ?SEV_ANNOUNCE_READY(Tester, send),
<a name="8145"/> 8145:                            ok
<a name="8146"/> 8146:                    end},
<a name="8147"/> 8147: 
<a name="8148"/> 8148:          %% Termination
<a name="8149"/> 8149:          #{desc =&gt; &quot;await terminate (from tester)&quot;,
<a name="8150"/> 8150:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="8151"/> 8151:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="8152"/> 8152:                                ok -&gt;
<a name="8153"/> 8153:                                    State2 = maps:remove(tester,    State),
<a name="8154"/> 8154:                                    State3 = maps:remove(async_tag, State2),
<a name="8155"/> 8155:                                    State4 = maps:remove(recv_tag,  State3),
<a name="8156"/> 8156:                                    State5 = maps:remove(recv_ref,  State4),
<a name="8157"/> 8157:                                    State6 = maps:remove(req_src,   State5),
<a name="8158"/> 8158:                                    {ok, State6};
<a name="8159"/> 8159:                                {error, _} = ERROR -&gt;
<a name="8160"/> 8160:                                    ERROR
<a name="8161"/> 8161:                            end
<a name="8162"/> 8162:                    end},
<a name="8163"/> 8163:          #{desc =&gt; &quot;close socket&quot;,
<a name="8164"/> 8164:            cmd  =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="8165"/> 8165:                            ok = socket:close(Sock),
<a name="8166"/> 8166:                            {ok, maps:remove(sock, State)}
<a name="8167"/> 8167:                    end},
<a name="8168"/> 8168: 
<a name="8169"/> 8169:          %% *** We are done ***
<a name="8170"/> 8170:          ?SEV_FINISH_NORMAL
<a name="8171"/> 8171:         ],
<a name="8172"/> 8172: 
<a name="8173"/> 8173: 
<a name="8174"/> 8174:     ClientSeq = 
<a name="8175"/> 8175:         [
<a name="8176"/> 8176:          %% *** Wait for start order part ***
<a name="8177"/> 8177:          #{desc =&gt; &quot;await start&quot;,
<a name="8178"/> 8178:            cmd  =&gt; fun(State) -&gt;
<a name="8179"/> 8179:                            {Tester, ServerSA} = ?SEV_AWAIT_START(),
<a name="8180"/> 8180:                            {ok, State#{tester    =&gt; Tester, 
<a name="8181"/> 8181:                                        server_sa =&gt; ServerSA}}
<a name="8182"/> 8182:                    end},
<a name="8183"/> 8183:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="8184"/> 8184:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="8185"/> 8185:                            _MRef = erlang:monitor(process, Tester),
<a name="8186"/> 8186:                            ok
<a name="8187"/> 8187:                    end},
<a name="8188"/> 8188: 
<a name="8189"/> 8189:          %% *** Init part ***
<a name="8190"/> 8190:          #{desc =&gt; &quot;local address&quot;,
<a name="8191"/> 8191:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="8192"/> 8192:                            LSA = which_local_socket_addr(Domain),
<a name="8193"/> 8193:                            {ok, State#{lsa =&gt; LSA}}
<a name="8194"/> 8194:                    end},
<a name="8195"/> 8195:          #{desc =&gt; &quot;open socket&quot;,
<a name="8196"/> 8196:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="8197"/> 8197:                            Sock = sock_open(Domain, dgram, udp),
<a name="8198"/> 8198:                            {ok, State#{sock =&gt; Sock}}
<a name="8199"/> 8199:                    end},
<a name="8200"/> 8200:          #{desc =&gt; &quot;bind socket (to local address)&quot;,
<a name="8201"/> 8201:            cmd  =&gt; fun(#{sock := Sock, lsa := LSA}) -&gt;
<a name="8202"/> 8202:                           case sock_bind(Sock, LSA) of
<a name="8203"/> 8203:                                ok -&gt;
<a name="8204"/> 8204:                                    ok;
<a name="8205"/> 8205:                                {error, _} = ERROR -&gt;
<a name="8206"/> 8206:                                    ERROR
<a name="8207"/> 8207:                            end
<a name="8208"/> 8208:                    end},
<a name="8209"/> 8209:          #{desc =&gt; &quot;sockname&quot;,
<a name="8210"/> 8210:            cmd  =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="8211"/> 8211:                            SA = sock_sockname(Sock),
<a name="8212"/> 8212:                            {ok, State#{sa =&gt; SA}}
<a name="8213"/> 8213:                    end},
<a name="8214"/> 8214:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="8215"/> 8215:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="8216"/> 8216:                            ?SEV_ANNOUNCE_READY(Tester, init),
<a name="8217"/> 8217:                            ok
<a name="8218"/> 8218:                    end},
<a name="8219"/> 8219: 
<a name="8220"/> 8220:          %% The actual test
<a name="8221"/> 8221:          #{desc =&gt; &quot;await continue (send request)&quot;,
<a name="8222"/> 8222:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="8223"/> 8223:                            ?SEV_AWAIT_CONTINUE(Tester, tester, send_req)
<a name="8224"/> 8224:                    end},
<a name="8225"/> 8225:          #{desc =&gt; &quot;send request&quot;,
<a name="8226"/> 8226:            cmd  =&gt; fun(#{sock := Sock, server_sa := Server, send := Send}) -&gt;
<a name="8227"/> 8227:                            Send(Sock, ?BASIC_REQ, Server)
<a name="8228"/> 8228:                    end},
<a name="8229"/> 8229:          #{desc =&gt; &quot;announce ready (send request)&quot;,
<a name="8230"/> 8230:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="8231"/> 8231:                            ?SEV_ANNOUNCE_READY(Tester, send_req),
<a name="8232"/> 8232:                            ok
<a name="8233"/> 8233:                    end},
<a name="8234"/> 8234:          #{desc =&gt; &quot;await continue (recv)&quot;,
<a name="8235"/> 8235:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="8236"/> 8236:                            ?SEV_AWAIT_CONTINUE(Tester, tester, recv)
<a name="8237"/> 8237:                    end},
<a name="8238"/> 8238:          #{desc =&gt; &quot;try recv reply (with nowait)&quot;,
<a name="8239"/> 8239:            cmd  =&gt; fun(#{sock     := Sock,
<a name="8240"/> 8240:                          recv     := Recv,
<a name="8241"/> 8241:                          recv_ref := Ref} = State) -&gt;
<a name="8242"/> 8242:                            case Recv(Sock) of
<a name="8243"/> 8243:                                {select, {select_info, Tag, RecvRef}}
<a name="8244"/> 8244:                                  when Ref =:= nowait -&gt;
<a name="8245"/> 8245:                                    {ok, State#{async_tag =&gt; select,
<a name="8246"/> 8246:                                                recv_tag  =&gt; Tag,
<a name="8247"/> 8247:                                                recv_ref  =&gt; RecvRef}};
<a name="8248"/> 8248:                                {select, {select_info, Tag, Ref}}
<a name="8249"/> 8249:                                  when is_reference(Ref) -&gt;
<a name="8250"/> 8250:                                    {ok, State#{async_tag =&gt; select,
<a name="8251"/> 8251:                                                recv_tag  =&gt; Tag}};
<a name="8252"/> 8252:                                {completion, {completion_info, Tag, RecvRef}}
<a name="8253"/> 8253:                                  when Ref =:= nowait -&gt;
<a name="8254"/> 8254:                                    {ok, State#{async_tag =&gt; completion,
<a name="8255"/> 8255:                                                recv_tag  =&gt; Tag,
<a name="8256"/> 8256:                                                recv_ref  =&gt; RecvRef}};
<a name="8257"/> 8257:                                {completion, {completion_info, Tag, Ref}}
<a name="8258"/> 8258:                                  when is_reference(Ref) -&gt;
<a name="8259"/> 8259:                                    {ok, State#{async_tag =&gt; completion,
<a name="8260"/> 8260:                                                recv_tag  =&gt; Tag}};
<a name="8261"/> 8261:                                {ok, X} -&gt;
<a name="8262"/> 8262:                                    {error, {unexpected_select_info, X}};
<a name="8263"/> 8263:                                {error, _} = ERROR -&gt;
<a name="8264"/> 8264:                                    ERROR
<a name="8265"/> 8265:                            end
<a name="8266"/> 8266:                    end},
<a name="8267"/> 8267:          #{desc =&gt; &quot;announce ready (recv_select)&quot;,
<a name="8268"/> 8268:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="8269"/> 8269:                            ?SEV_ANNOUNCE_READY(Tester, recv_select),
<a name="8270"/> 8270:                            ok
<a name="8271"/> 8271:                    end},
<a name="8272"/> 8272:          #{desc =&gt; &quot;await select message&quot;,
<a name="8273"/> 8273:            cmd  =&gt; fun(#{async_tag := select,
<a name="8274"/> 8274:                          sock      := Sock,
<a name="8275"/> 8275:                          recv_ref  := RecvRef}) -&gt;
<a name="8276"/> 8276:                            receive
<a name="8277"/> 8277:                                {'$socket', Sock, select, RecvRef} -&gt;
<a name="8278"/> 8278:                                    ok
<a name="8279"/> 8279:                            end;
<a name="8280"/> 8280:                       (#{async_tag := completion,
<a name="8281"/> 8281:                          sock      := Sock,
<a name="8282"/> 8282:                          recv_ref  := RecvRef}) -&gt;
<a name="8283"/> 8283:                            receive
<a name="8284"/> 8284:                                {'$socket', Sock, completion,
<a name="8285"/> 8285:                                 {RecvRef, {ok, _}}} -&gt;
<a name="8286"/> 8286:                                    ok
<a name="8287"/> 8287:                            end
<a name="8288"/> 8288:                    end},
<a name="8289"/> 8289:          #{desc =&gt; &quot;announce ready (select)&quot;,
<a name="8290"/> 8290:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="8291"/> 8291:                            ?SEV_ANNOUNCE_READY(Tester, select),
<a name="8292"/> 8292:                            ok
<a name="8293"/> 8293:                    end},
<a name="8294"/> 8294:          #{desc =&gt; &quot;now read the data (reply)&quot;,
<a name="8295"/> 8295:            cmd  =&gt; fun(#{async_tag := select,
<a name="8296"/> 8296:                          sock      := Sock,
<a name="8297"/> 8297:                          recv      := Recv}) -&gt;
<a name="8298"/> 8298:                            case Recv(Sock) of
<a name="8299"/> 8299:                                {ok, {_Src, ?BASIC_REP}} -&gt;
<a name="8300"/> 8300:                                    ok;
<a name="8301"/> 8301:                                {error, _} = ERROR -&gt;
<a name="8302"/> 8302:                                    ERROR
<a name="8303"/> 8303:                            end;
<a name="8304"/> 8304:                       (#{async_tag := completion}) -&gt;
<a name="8305"/> 8305:                            ?SEV_IPRINT(&quot;Already read!&quot;),
<a name="8306"/> 8306:                            ok
<a name="8307"/> 8307:                    end},
<a name="8308"/> 8308:          #{desc =&gt; &quot;announce ready (recv reply)&quot;,
<a name="8309"/> 8309:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="8310"/> 8310:                            ?SEV_ANNOUNCE_READY(Tester, recv_rep),
<a name="8311"/> 8311:                            ok
<a name="8312"/> 8312:                    end},
<a name="8313"/> 8313: 
<a name="8314"/> 8314:          %% Termination
<a name="8315"/> 8315:          #{desc =&gt; &quot;await terminate (from tester)&quot;,
<a name="8316"/> 8316:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="8317"/> 8317:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="8318"/> 8318:                                ok -&gt;
<a name="8319"/> 8319:                                    State2 = maps:remove(tester,    State),
<a name="8320"/> 8320:                                    State3 = maps:remove(async_tag, State2),
<a name="8321"/> 8321:                                    State4 = maps:remove(recv_tag,  State3),
<a name="8322"/> 8322:                                    State5 = maps:remove(recv_ref,  State4),
<a name="8323"/> 8323:                                    {ok, State5};
<a name="8324"/> 8324:                                {error, _} = ERROR -&gt;
<a name="8325"/> 8325:                                    ERROR
<a name="8326"/> 8326:                            end
<a name="8327"/> 8327:                    end},
<a name="8328"/> 8328:          #{desc =&gt; &quot;close socket&quot;,
<a name="8329"/> 8329:            cmd  =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="8330"/> 8330:                            ok = socket:close(Sock),
<a name="8331"/> 8331:                            {ok, maps:remove(sock, State)}
<a name="8332"/> 8332:                    end},
<a name="8333"/> 8333: 
<a name="8334"/> 8334:          %% *** We are done ***
<a name="8335"/> 8335:          ?SEV_FINISH_NORMAL
<a name="8336"/> 8336:         ],
<a name="8337"/> 8337: 
<a name="8338"/> 8338: 
<a name="8339"/> 8339:     TesterSeq = 
<a name="8340"/> 8340:         [
<a name="8341"/> 8341:          %% *** Init part ***
<a name="8342"/> 8342:          #{desc =&gt; &quot;monitor server&quot;,
<a name="8343"/> 8343:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="8344"/> 8344:                            _MRef = erlang:monitor(process, Pid),
<a name="8345"/> 8345:                            ok
<a name="8346"/> 8346:                    end},
<a name="8347"/> 8347:          #{desc =&gt; &quot;monitor client&quot;,
<a name="8348"/> 8348:            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;
<a name="8349"/> 8349:                            _MRef = erlang:monitor(process, Pid),
<a name="8350"/> 8350:                            ok
<a name="8351"/> 8351:                    end},
<a name="8352"/> 8352: 
<a name="8353"/> 8353:          %% Start the server
<a name="8354"/> 8354:          #{desc =&gt; &quot;order server start&quot;,
<a name="8355"/> 8355:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="8356"/> 8356:                            ?SEV_ANNOUNCE_START(Pid),
<a name="8357"/> 8357:                            ok
<a name="8358"/> 8358:                    end},
<a name="8359"/> 8359:          #{desc =&gt; &quot;await server ready (init)&quot;,
<a name="8360"/> 8360:            cmd  =&gt; fun(#{server := Pid} = State) -&gt;
<a name="8361"/> 8361:                            {ok, ServerSA} = ?SEV_AWAIT_READY(Pid, server, init),
<a name="8362"/> 8362:                            {ok, State#{server_sa =&gt; ServerSA}}
<a name="8363"/> 8363:                    end},
<a name="8364"/> 8364: 
<a name="8365"/> 8365:          %% Start the client
<a name="8366"/> 8366:          #{desc =&gt; &quot;order client start&quot;,
<a name="8367"/> 8367:            cmd  =&gt; fun(#{client    := Pid, 
<a name="8368"/> 8368:                          server_sa := ServerSA} = _State) -&gt;
<a name="8369"/> 8369:                            ?SEV_ANNOUNCE_START(Pid, ServerSA),
<a name="8370"/> 8370:                            ok
<a name="8371"/> 8371:                    end},
<a name="8372"/> 8372:          #{desc =&gt; &quot;await client ready (init)&quot;,
<a name="8373"/> 8373:            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;
<a name="8374"/> 8374:                            ok = ?SEV_AWAIT_READY(Pid, client, init)
<a name="8375"/> 8375:                    end},
<a name="8376"/> 8376:  
<a name="8377"/> 8377:          %% The actual test
<a name="8378"/> 8378:          #{desc =&gt; &quot;order server continue (recv)&quot;,
<a name="8379"/> 8379:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="8380"/> 8380:                            ?SEV_ANNOUNCE_CONTINUE(Pid, recv),
<a name="8381"/> 8381:                            ok
<a name="8382"/> 8382:                    end},
<a name="8383"/> 8383:          #{desc =&gt; &quot;await server ready (recv_select)&quot;,
<a name="8384"/> 8384:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="8385"/> 8385:                            ok = ?SEV_AWAIT_READY(Pid, server, recv_select)
<a name="8386"/> 8386:                    end},
<a name="8387"/> 8387: 
<a name="8388"/> 8388:          #{desc =&gt; &quot;order client continue (send request)&quot;,
<a name="8389"/> 8389:            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;
<a name="8390"/> 8390:                            ?SEV_ANNOUNCE_CONTINUE(Pid, send_req),
<a name="8391"/> 8391:                            ok
<a name="8392"/> 8392:                    end},
<a name="8393"/> 8393:          #{desc =&gt; &quot;await client ready (send request)&quot;,
<a name="8394"/> 8394:            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;
<a name="8395"/> 8395:                            ok = ?SEV_AWAIT_READY(Pid, client, send_req)
<a name="8396"/> 8396:                    end},
<a name="8397"/> 8397:          #{desc =&gt; &quot;await server ready (select)&quot;,
<a name="8398"/> 8398:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="8399"/> 8399:                            ok = ?SEV_AWAIT_READY(Pid, server, select)
<a name="8400"/> 8400:                    end},
<a name="8401"/> 8401:          #{desc =&gt; &quot;await server ready (recv request)&quot;,
<a name="8402"/> 8402:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="8403"/> 8403:                            ok = ?SEV_AWAIT_READY(Pid, server, recv_req)
<a name="8404"/> 8404:                    end},
<a name="8405"/> 8405: 
<a name="8406"/> 8406:          #{desc =&gt; &quot;order client continue (recv)&quot;,
<a name="8407"/> 8407:            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;
<a name="8408"/> 8408:                            ?SEV_ANNOUNCE_CONTINUE(Pid, recv),
<a name="8409"/> 8409:                            ok
<a name="8410"/> 8410:                    end},
<a name="8411"/> 8411:          #{desc =&gt; &quot;await client ready (recv_select)&quot;,
<a name="8412"/> 8412:            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;
<a name="8413"/> 8413:                            ok = ?SEV_AWAIT_READY(Pid, client, recv_select)
<a name="8414"/> 8414:                    end},
<a name="8415"/> 8415:          #{desc =&gt; &quot;order server continue (send reply)&quot;,
<a name="8416"/> 8416:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="8417"/> 8417:                            ?SEV_ANNOUNCE_CONTINUE(Pid, send_reply),
<a name="8418"/> 8418:                            ok
<a name="8419"/> 8419:                    end},
<a name="8420"/> 8420:          #{desc =&gt; &quot;await server ready (send)&quot;,
<a name="8421"/> 8421:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="8422"/> 8422:                            ok = ?SEV_AWAIT_READY(Pid, server, send)
<a name="8423"/> 8423:                    end},
<a name="8424"/> 8424:          #{desc =&gt; &quot;await client ready (select)&quot;,
<a name="8425"/> 8425:            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;
<a name="8426"/> 8426:                            ok = ?SEV_AWAIT_READY(Pid, client, select)
<a name="8427"/> 8427:                    end},
<a name="8428"/> 8428:          #{desc =&gt; &quot;await client ready (recv reply)&quot;,
<a name="8429"/> 8429:            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;
<a name="8430"/> 8430:                            ok = ?SEV_AWAIT_READY(Pid, client, recv_rep)
<a name="8431"/> 8431:                    end},
<a name="8432"/> 8432: 
<a name="8433"/> 8433:          %% Terminations
<a name="8434"/> 8434:          #{desc =&gt; &quot;order client to terminate&quot;,
<a name="8435"/> 8435:            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;
<a name="8436"/> 8436:                            ?SEV_ANNOUNCE_TERMINATE(Pid),
<a name="8437"/> 8437:                            ok
<a name="8438"/> 8438:                    end},
<a name="8439"/> 8439:          #{desc =&gt; &quot;await client termination&quot;,
<a name="8440"/> 8440:            cmd  =&gt; fun(#{client := Pid} = State) -&gt;
<a name="8441"/> 8441:                            case ?SEV_AWAIT_TERMINATION(Pid) of
<a name="8442"/> 8442:                                ok -&gt;
<a name="8443"/> 8443:                                    State1 = maps:remove(client, State),
<a name="8444"/> 8444:                                    {ok, State1};
<a name="8445"/> 8445:                                {error, _} = ERROR -&gt;
<a name="8446"/> 8446:                                    ERROR
<a name="8447"/> 8447:                            end
<a name="8448"/> 8448:                    end},
<a name="8449"/> 8449:          #{desc =&gt; &quot;order server to terminate&quot;,
<a name="8450"/> 8450:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="8451"/> 8451:                            ?SEV_ANNOUNCE_TERMINATE(Pid),
<a name="8452"/> 8452:                            ok
<a name="8453"/> 8453:                    end},
<a name="8454"/> 8454:          #{desc =&gt; &quot;await server termination&quot;,
<a name="8455"/> 8455:            cmd  =&gt; fun(#{server := Pid} = State) -&gt;
<a name="8456"/> 8456:                            case ?SEV_AWAIT_TERMINATION(Pid) of
<a name="8457"/> 8457:                                ok -&gt;
<a name="8458"/> 8458:                                    State1 = maps:remove(server, State),
<a name="8459"/> 8459:                                    {ok, State1};
<a name="8460"/> 8460:                                {error, _} = ERROR -&gt;
<a name="8461"/> 8461:                                    ERROR
<a name="8462"/> 8462:                            end
<a name="8463"/> 8463:                    end},
<a name="8464"/> 8464: 
<a name="8465"/> 8465: 
<a name="8466"/> 8466:          %% *** We are done ***
<a name="8467"/> 8467:          ?SEV_FINISH_NORMAL
<a name="8468"/> 8468:         ],
<a name="8469"/> 8469: 
<a name="8470"/> 8470:     i(&quot;start server evaluator&quot;),
<a name="8471"/> 8471:     ServerInitState = InitState,
<a name="8472"/> 8472:     Server = ?SEV_START(&quot;server&quot;, ServerSeq, ServerInitState),
<a name="8473"/> 8473: 
<a name="8474"/> 8474:     i(&quot;start client evaluator(s)&quot;),
<a name="8475"/> 8475:     ClientInitState = InitState,
<a name="8476"/> 8476:     Client = ?SEV_START(&quot;client&quot;, ClientSeq, ClientInitState),
<a name="8477"/> 8477: 
<a name="8478"/> 8478:     i(&quot;start 'tester' evaluator&quot;),
<a name="8479"/> 8479:     TesterInitState = #{server =&gt; Server#ev.pid,
<a name="8480"/> 8480:                         client =&gt; Client#ev.pid},
<a name="8481"/> 8481:     Tester = ?SEV_START(&quot;tester&quot;, TesterSeq, TesterInitState),
<a name="8482"/> 8482: 
<a name="8483"/> 8483:     i(&quot;await evaluator&quot;),
<a name="api_a_send_and_recv_udp-last_expr"/><a name="8484"/> 8484: <b>    ok = ?SEV_AWAIT_FINISH</b>([Server, Client, Tester]).
<a name="8485"/> 8485: 
<a name="8486"/> 8486: 
<a name="8487"/> 8487: 
<a name="8488"/> 8488: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="8489"/> 8489: 
<a name="8490"/> 8490: <i>%% Basically send and receive using the &quot;common&quot; functions (send and recv)</i>
<a name="8491"/> 8491: <i>%% on an IPv4 TCP (stream) socket. But we try to be async. That is, we use</i>
<a name="8492"/> 8492: <i>%% the 'nowait' value for the Timeout argument (and await the eventual</i>
<a name="8493"/> 8493: <i>%% select message). Note that we only do this for the recv,</i>
<a name="8494"/> 8494: <i>%% since its much more difficult to &quot;arrange&quot; for send.</i>
<a name="8495"/> 8495: <i>%% We *also* test async for accept.</i>
<a name="api_a_send_and_recv_tcp4-1"/><a name="8496"/> 8496: <b>api_a_send_and_recv_tcp4</b>(Config) when is_list(Config) -&gt;
<a name="8497"/> 8497:     ?TT(?SECS(10)),
<a name="8498"/> 8498:     Nowait = nowait(Config),
<a name="api_a_send_and_recv_tcp4-last_expr"/><a name="8499"/> 8499: <b>    tc_try</b>(api_a_send_and_recv_tcp4,
<a name="8500"/> 8500:            fun() -&gt; has_support_ipv4() end,
<a name="8501"/> 8501:            fun() -&gt;
<a name="8502"/> 8502:                    Send = fun(Sock, Data) -&gt;
<a name="8503"/> 8503:                                   socket:send(Sock, Data)
<a name="8504"/> 8504:                           end,
<a name="8505"/> 8505:                    Recv = fun(Sock) -&gt;
<a name="8506"/> 8506:                                   socket:recv(Sock, 0, Nowait)
<a name="8507"/> 8507:                           end,
<a name="8508"/> 8508:                    InitState = #{domain =&gt; inet,
<a name="8509"/> 8509:                                  send =&gt; Send,
<a name="8510"/> 8510:                                  recv =&gt; Recv,
<a name="8511"/> 8511:                                  recv_sref =&gt; Nowait},
<a name="8512"/> 8512:                    ok = api_a_send_and_recv_tcp(Config, InitState)
<a name="8513"/> 8513:            end).
<a name="8514"/> 8514: 
<a name="8515"/> 8515: 
<a name="8516"/> 8516: 
<a name="8517"/> 8517: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="8518"/> 8518: 
<a name="8519"/> 8519: <i>%% Basically send and receive using the &quot;common&quot; functions (send and recv)</i>
<a name="8520"/> 8520: <i>%% on an IPv6 TCP (stream) socket. But we try to be async. That is, we use</i>
<a name="8521"/> 8521: <i>%% the 'nowait' value for the Timeout argument (and await the eventual</i>
<a name="8522"/> 8522: <i>%% select message). Note that we only do this for the recv,</i>
<a name="8523"/> 8523: <i>%% since its much more difficult to &quot;arrange&quot; for send.</i>
<a name="8524"/> 8524: <i>%% We *also* test async for accept.</i>
<a name="api_a_send_and_recv_tcp6-1"/><a name="8525"/> 8525: <b>api_a_send_and_recv_tcp6</b>(Config) when is_list(Config) -&gt;
<a name="8526"/> 8526:     ?TT(?SECS(10)),
<a name="8527"/> 8527:     Nowait = nowait(Config),
<a name="api_a_send_and_recv_tcp6-last_expr"/><a name="8528"/> 8528: <b>    tc_try</b>(api_a_send_and_recv_tcp6,
<a name="8529"/> 8529:            fun() -&gt; has_support_ipv6() end,
<a name="8530"/> 8530:            fun() -&gt;
<a name="8531"/> 8531:                    Send = fun(Sock, Data) -&gt;
<a name="8532"/> 8532:                                   socket:send(Sock, Data)
<a name="8533"/> 8533:                           end,
<a name="8534"/> 8534:                    Recv = fun(Sock) -&gt;
<a name="8535"/> 8535:                                   socket:recv(Sock, 0, Nowait)
<a name="8536"/> 8536:                           end,
<a name="8537"/> 8537:                    InitState = #{domain =&gt; inet6,
<a name="8538"/> 8538:                                  send =&gt; Send,
<a name="8539"/> 8539:                                  recv =&gt; Recv,
<a name="8540"/> 8540:                                  recv_sref =&gt; Nowait},
<a name="8541"/> 8541:                    ok = api_a_send_and_recv_tcp(Config, InitState)
<a name="8542"/> 8542:            end).
<a name="8543"/> 8543: 
<a name="8544"/> 8544: 
<a name="8545"/> 8545: 
<a name="8546"/> 8546: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="8547"/> 8547: 
<a name="8548"/> 8548: <i>%% Basically send and receive using the msg functions (sendmsg and recvmsg)</i>
<a name="8549"/> 8549: <i>%% on an IPv4 TCP (stream) socket. But we try to be async. That is, we use</i>
<a name="8550"/> 8550: <i>%% the 'nowait' value for the Timeout argument (and await the eventual</i>
<a name="8551"/> 8551: <i>%% select message). Note that we only do this for the recvmsg,</i>
<a name="8552"/> 8552: <i>%% since its much more difficult to &quot;arrange&quot; for sendmsg.</i>
<a name="8553"/> 8553: <i>%% We *also* test async for accept.</i>
<a name="api_a_sendmsg_and_recvmsg_tcp4-1"/><a name="8554"/> 8554: <b>api_a_sendmsg_and_recvmsg_tcp4</b>(Config) when is_list(Config) -&gt;
<a name="8555"/> 8555:     ?TT(?SECS(10)),
<a name="8556"/> 8556:     Nowait = nowait(Config),
<a name="api_a_sendmsg_and_recvmsg_tcp4-last_expr"/><a name="8557"/> 8557: <b>    tc_try</b>(api_a_sendmsg_and_recvmsg_tcp4,
<a name="8558"/> 8558:            fun() -&gt;
<a name="8559"/> 8559:                    is_not_windows(),
<a name="8560"/> 8560:                    has_support_ipv4()
<a name="8561"/> 8561:            end,
<a name="8562"/> 8562:            fun() -&gt;
<a name="8563"/> 8563:                    Send = fun(Sock, Data) -&gt;
<a name="8564"/> 8564:                                   Msg = #{iov =&gt; [Data]},
<a name="8565"/> 8565:                                   socket:sendmsg(Sock, Msg)
<a name="8566"/> 8566:                           end,
<a name="8567"/> 8567:                    Recv = fun(Sock) -&gt;
<a name="8568"/> 8568:                                   case socket:recvmsg(Sock, Nowait) of
<a name="8569"/> 8569:                                       {ok, #{iov   := [Data]}} -&gt;
<a name="8570"/> 8570:                                           {ok, Data};
<a name="8571"/> 8571:                                       {select, _} = SELECT -&gt;
<a name="8572"/> 8572:                                           SELECT;
<a name="8573"/> 8573: 				      {error, _} = ERROR -&gt;
<a name="8574"/> 8574:                                           ERROR
<a name="8575"/> 8575:                                   end
<a name="8576"/> 8576:                           end,
<a name="8577"/> 8577:                    InitState = #{domain =&gt; inet,
<a name="8578"/> 8578:                                  send =&gt; Send,
<a name="8579"/> 8579:                                  recv =&gt; Recv,
<a name="8580"/> 8580:                                  recv_sref =&gt; Nowait},
<a name="8581"/> 8581:                    ok = api_a_send_and_recv_tcp(Config, InitState)
<a name="8582"/> 8582:            end).
<a name="8583"/> 8583: 
<a name="8584"/> 8584: 
<a name="8585"/> 8585: 
<a name="8586"/> 8586: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="8587"/> 8587: 
<a name="8588"/> 8588: <i>%% Basically send and receive using the msg functions (sendmsg and recvmsg)</i>
<a name="8589"/> 8589: <i>%% on an IPv6 TCP (stream) socket. But we try to be async. That is, we use</i>
<a name="8590"/> 8590: <i>%% the 'nowait' value for the Timeout argument (and await the eventual</i>
<a name="8591"/> 8591: <i>%% select message). Note that we only do this for the recvmsg,</i>
<a name="8592"/> 8592: <i>%% since its much more difficult to &quot;arrange&quot; for sendmsg.</i>
<a name="8593"/> 8593: <i>%% We *also* test async for accept.</i>
<a name="api_a_sendmsg_and_recvmsg_tcp6-1"/><a name="8594"/> 8594: <b>api_a_sendmsg_and_recvmsg_tcp6</b>(Config) when is_list(Config) -&gt;
<a name="8595"/> 8595:     ?TT(?SECS(10)),
<a name="8596"/> 8596:     Nowait = nowait(Config),
<a name="api_a_sendmsg_and_recvmsg_tcp6-last_expr"/><a name="8597"/> 8597: <b>    tc_try</b>(api_a_sendmsg_and_recvmsg_tcp6,
<a name="8598"/> 8598:            fun() -&gt; has_support_ipv6() end,
<a name="8599"/> 8599:            fun() -&gt;
<a name="8600"/> 8600:                    Send = fun(Sock, Data) -&gt;
<a name="8601"/> 8601:                                   Msg = #{iov =&gt; [Data]},
<a name="8602"/> 8602:                                   socket:sendmsg(Sock, Msg)
<a name="8603"/> 8603:                           end,
<a name="8604"/> 8604:                    Recv = fun(Sock) -&gt;
<a name="8605"/> 8605:                                   case socket:recvmsg(Sock, Nowait) of
<a name="8606"/> 8606:                                       {ok, #{iov   := [Data]}} -&gt;
<a name="8607"/> 8607:                                           {ok, Data};
<a name="8608"/> 8608:                                       {select, _} = SELECT -&gt;
<a name="8609"/> 8609:                                           SELECT;
<a name="8610"/> 8610: 				      {error, _} = ERROR -&gt;
<a name="8611"/> 8611:                                           ERROR
<a name="8612"/> 8612:                                   end
<a name="8613"/> 8613:                           end,
<a name="8614"/> 8614:                    InitState = #{domain =&gt; inet6,
<a name="8615"/> 8615:                                  send =&gt; Send,
<a name="8616"/> 8616:                                  recv =&gt; Recv,
<a name="8617"/> 8617:                                  recv_sref =&gt; Nowait},
<a name="8618"/> 8618:                    ok = api_a_send_and_recv_tcp(Config, InitState)
<a name="8619"/> 8619:            end).
<a name="8620"/> 8620: 
<a name="8621"/> 8621: 
<a name="8622"/> 8622: 
<a name="8623"/> 8623: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="8624"/> 8624: 
<a name="api_a_send_and_recv_tcp-2"/><a name="8625"/> 8625: <b>api_a_send_and_recv_tcp</b>(Config, InitState) -&gt;
<a name="8626"/> 8626:     process_flag(trap_exit, true),
<a name="8627"/> 8627:     ServerSeq = 
<a name="8628"/> 8628:         [
<a name="8629"/> 8629:          %% *** Wait for start order ***
<a name="8630"/> 8630:          #{desc =&gt; &quot;await start (from tester)&quot;,
<a name="8631"/> 8631:            cmd  =&gt; fun(State) -&gt;
<a name="8632"/> 8632:                            Tester = ?SEV_AWAIT_START(),
<a name="8633"/> 8633:                            {ok, State#{tester =&gt; Tester}}
<a name="8634"/> 8634:                    end},
<a name="8635"/> 8635:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="8636"/> 8636:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="8637"/> 8637:                            _MRef = erlang:monitor(process, Tester),
<a name="8638"/> 8638:                            ok
<a name="8639"/> 8639:                    end},
<a name="8640"/> 8640: 
<a name="8641"/> 8641:          %% *** Init part ***
<a name="8642"/> 8642:          #{desc =&gt; &quot;which local address&quot;,
<a name="8643"/> 8643:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="8644"/> 8644:                            LSA = which_local_socket_addr(Domain),
<a name="8645"/> 8645:                            {ok, State#{lsa =&gt; LSA}}
<a name="8646"/> 8646:                    end},
<a name="8647"/> 8647:          #{desc =&gt; &quot;create listen socket&quot;,
<a name="8648"/> 8648:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="8649"/> 8649:                            case socket:open(Domain, stream, tcp) of
<a name="8650"/> 8650:                                {ok, Sock} -&gt;
<a name="8651"/> 8651:                                    {ok, State#{lsock =&gt; Sock}};
<a name="8652"/> 8652:                                {error, _} = ERROR -&gt;
<a name="8653"/> 8653:                                    ERROR
<a name="8654"/> 8654:                            end
<a name="8655"/> 8655:                    end},
<a name="8656"/> 8656:          #{desc =&gt; &quot;bind to local address&quot;,
<a name="8657"/> 8657:            cmd  =&gt; fun(#{lsock := LSock, lsa := LSA} = State) -&gt;
<a name="8658"/> 8658:                            case sock_bind(LSock, LSA) of
<a name="8659"/> 8659:                                ok -&gt;
<a name="8660"/> 8660:                                    Port = sock_port(LSock),
<a name="8661"/> 8661:                                    {ok, State#{lport =&gt; Port}};
<a name="8662"/> 8662:                                {error, _} = ERROR -&gt;
<a name="8663"/> 8663:                                    ERROR
<a name="8664"/> 8664:                            end
<a name="8665"/> 8665:                    end},
<a name="8666"/> 8666:          #{desc =&gt; &quot;make listen socket&quot;,
<a name="8667"/> 8667:            cmd  =&gt; fun(#{lsock := LSock}) -&gt;
<a name="8668"/> 8668:                            socket:listen(LSock)
<a name="8669"/> 8669:                    end},
<a name="8670"/> 8670:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="8671"/> 8671:            cmd  =&gt; fun(#{tester := Tester, lport := Port}) -&gt;
<a name="8672"/> 8672:                            ?SEV_ANNOUNCE_READY(Tester, init, Port),
<a name="8673"/> 8673:                            ok
<a name="8674"/> 8674:                    end},
<a name="8675"/> 8675: 
<a name="8676"/> 8676:          %% The actual test
<a name="8677"/> 8677:          #{desc =&gt; &quot;await continue (accept)&quot;,
<a name="8678"/> 8678:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="8679"/> 8679:                            ?SEV_AWAIT_CONTINUE(Tester, tester, accept)
<a name="8680"/> 8680:                    end},
<a name="8681"/> 8681:          #{desc =&gt; &quot;await connection (nowait)&quot;,
<a name="8682"/> 8682:            cmd  =&gt; fun(#{lsock := LSock} = State) -&gt;
<a name="8683"/> 8683:                            Nowait = nowait(Config),
<a name="8684"/> 8684:                            case socket:accept(LSock, Nowait) of
<a name="8685"/> 8685:                                {select, {select_info, Tag, Ref}}
<a name="8686"/> 8686:                                  when Nowait =:= nowait -&gt;
<a name="8687"/> 8687:                                    ?SEV_IPRINT(&quot;select accept message: &quot;
<a name="8688"/> 8688:                                                &quot;~n   Tag: ~p&quot;
<a name="8689"/> 8689:                                                &quot;~n   Ref: ~p&quot;, [Tag, Ref]),
<a name="8690"/> 8690:                                    {ok, State#{sorc        =&gt; select,
<a name="8691"/> 8691:                                                accept_stag =&gt; Tag,
<a name="8692"/> 8692:                                                accept_sref =&gt; Ref}};
<a name="8693"/> 8693:                                {select, {select_info, Tag, Nowait}}
<a name="8694"/> 8694:                                  when is_reference(Nowait) -&gt;
<a name="8695"/> 8695:                                    ?SEV_IPRINT(&quot;select accept result: &quot;
<a name="8696"/> 8696:                                                &quot;~n   Tag: ~p&quot;
<a name="8697"/> 8697:                                                &quot;~n   Ref: ~p&quot;, [Tag, Nowait]),
<a name="8698"/> 8698:                                    {ok, State#{sorc        =&gt; select,
<a name="8699"/> 8699:                                                accept_stag =&gt; Tag,
<a name="8700"/> 8700:                                                accept_sref =&gt; Nowait}};
<a name="8701"/> 8701: 
<a name="8702"/> 8702:                                {completion, {completion_info, Tag, Ref}}
<a name="8703"/> 8703:                                  when Nowait =:= nowait -&gt;
<a name="8704"/> 8704:                                    ?SEV_IPRINT(&quot;completion accept result: &quot;
<a name="8705"/> 8705:                                                &quot;~n   Tag: ~p&quot;
<a name="8706"/> 8706:                                                &quot;~n   Ref: ~p&quot;, [Tag, Ref]),
<a name="8707"/> 8707:                                    {ok, State#{sorc        =&gt; completion,
<a name="8708"/> 8708:                                                accept_stag =&gt; Tag,
<a name="8709"/> 8709:                                                accept_sref =&gt; Ref}};
<a name="8710"/> 8710:                                {completion, {completion_info, Tag, Nowait}}
<a name="8711"/> 8711:                                  when is_reference(Nowait) -&gt;
<a name="8712"/> 8712:                                    ?SEV_IPRINT(&quot;completion accept result: &quot;
<a name="8713"/> 8713:                                                &quot;~n   Tag: ~p&quot;
<a name="8714"/> 8714:                                                &quot;~n   Ref: ~p&quot;, [Tag, Nowait]),
<a name="8715"/> 8715:                                    {ok, State#{sorc        =&gt; completion,
<a name="8716"/> 8716:                                                accept_stag =&gt; Tag,
<a name="8717"/> 8717:                                                accept_sref =&gt; Nowait}};
<a name="8718"/> 8718: 
<a name="8719"/> 8719:                                {ok, X} -&gt;
<a name="8720"/> 8720:                                    {error, {unexpected_success, X}};
<a name="8721"/> 8721:                                {error, _} = ERROR -&gt;
<a name="8722"/> 8722:                                    ERROR
<a name="8723"/> 8723:                            end
<a name="8724"/> 8724:                    end},
<a name="8725"/> 8725:          #{desc =&gt; &quot;announce ready (accept_select)&quot;,
<a name="8726"/> 8726:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="8727"/> 8727:                            ?SEV_ANNOUNCE_READY(Tester, accept_select),
<a name="8728"/> 8728:                            ok
<a name="8729"/> 8729:                    end},
<a name="8730"/> 8730:          #{desc =&gt; &quot;await select|completion message&quot;,
<a name="8731"/> 8731:            cmd  =&gt; fun(#{lsock := Sock, accept_sref := Ref} = State) -&gt;
<a name="8732"/> 8732:                            receive
<a name="8733"/> 8733:                                {'$socket', Sock, select, Ref} -&gt;
<a name="8734"/> 8734:                                    ?SEV_IPRINT(&quot;select message: &quot;
<a name="8735"/> 8735:                                                &quot;ready for accept&quot;),
<a name="8736"/> 8736:                                    ok;
<a name="8737"/> 8737:                                {'$socket', Sock, completion,
<a name="8738"/> 8738:                                 {Ref, {ok, CSock}}} -&gt;
<a name="8739"/> 8739:                                    ?SEV_IPRINT(&quot;completion message: accepted: &quot;
<a name="8740"/> 8740:                                                &quot;~n   CSock: ~p&quot;, [Sock]),
<a name="8741"/> 8741:                                    {ok, State#{csock =&gt; CSock}}
<a name="8742"/> 8742:                            after 5000 -&gt;
<a name="8743"/> 8743:                                    ?SEV_EPRINT(&quot;select|completion message timeout:&quot;
<a name="8744"/> 8744:                                                &quot;~n   Sock:          ~p&quot;
<a name="8745"/> 8745:                                                &quot;~n   Ref:           ~p&quot;
<a name="8746"/> 8746:                                                &quot;~n   Message Queue: ~p&quot;,
<a name="8747"/> 8747:                                                [Sock, Ref, mq()]),
<a name="8748"/> 8748:                                    {error, timeout}
<a name="8749"/> 8749:                            end
<a name="8750"/> 8750:                    end},
<a name="8751"/> 8751:          #{desc =&gt; &quot;announce ready (select)&quot;,
<a name="8752"/> 8752:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="8753"/> 8753:                            ?SEV_ANNOUNCE_READY(Tester, select),
<a name="8754"/> 8754:                            ok
<a name="8755"/> 8755:                    end},
<a name="8756"/> 8756:          #{desc =&gt; &quot;try accept (again)&quot;,
<a name="8757"/> 8757:            cmd  =&gt; fun(#{lsock := LSock, sorc := select} = State) -&gt;
<a name="8758"/> 8758:                            ?SEV_IPRINT(&quot;try accept again&quot;),
<a name="8759"/> 8759:                            case socket:accept(LSock, nowait) of
<a name="8760"/> 8760:                                {ok, Sock} -&gt;
<a name="8761"/> 8761:                                    ?SEV_IPRINT(&quot;accepted: &quot;
<a name="8762"/> 8762:                                                &quot;~n   Sock: ~p&quot;, [Sock]),
<a name="8763"/> 8763:                                    {ok, State#{csock =&gt; Sock}};
<a name="8764"/> 8764:                                {error, _} = ERROR -&gt;
<a name="8765"/> 8765:                                    ERROR
<a name="8766"/> 8766:                            end;
<a name="8767"/> 8767:                        (#{sorc := completion})-&gt;
<a name="8768"/> 8768:                            ?SEV_IPRINT(&quot;already accepted&quot;),
<a name="8769"/> 8769:                            ok
<a name="8770"/> 8770:                    end},
<a name="8771"/> 8771:          #{desc =&gt; &quot;announce ready (accept)&quot;,
<a name="8772"/> 8772:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="8773"/> 8773:                            ?SEV_ANNOUNCE_READY(Tester, accept),
<a name="8774"/> 8774:                            ok
<a name="8775"/> 8775:                    end},
<a name="8776"/> 8776: 
<a name="8777"/> 8777:          #{desc =&gt; &quot;await continue (recv request)&quot;,
<a name="8778"/> 8778:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="8779"/> 8779:                            ?SEV_AWAIT_CONTINUE(Tester, tester, recv_req)
<a name="8780"/> 8780:                    end},
<a name="8781"/> 8781:          #{desc =&gt; &quot;try recv request (with nowait, expect select)&quot;,
<a name="8782"/> 8782:            cmd  =&gt; fun(#{csock     := Sock,
<a name="8783"/> 8783:                          recv      := Recv,
<a name="8784"/> 8784:                          recv_sref := SR} = State) -&gt;
<a name="8785"/> 8785:                            case Recv(Sock) of
<a name="8786"/> 8786:                                {select, {select_info, Tag, Ref}}
<a name="8787"/> 8787:                                  when SR =:= nowait -&gt;
<a name="8788"/> 8788:                                    ?SEV_IPRINT(&quot;recv select nowait: &quot;
<a name="8789"/> 8789:                                                &quot;~n   Tag: ~p&quot;
<a name="8790"/> 8790:                                                &quot;~n   Ref: ~p&quot;, [Tag, Ref]),
<a name="8791"/> 8791:                                    {ok, State#{recv_stag =&gt; Tag,
<a name="8792"/> 8792:                                                recv_sref =&gt; Ref}};
<a name="8793"/> 8793:                                {select, {select_info, Tag, SR}}
<a name="8794"/> 8794:                                  when is_reference(SR) -&gt;
<a name="8795"/> 8795:                                    ?SEV_IPRINT(&quot;recv select ref: &quot;
<a name="8796"/> 8796:                                                &quot;~n   Tag: ~p&quot;
<a name="8797"/> 8797:                                                &quot;~n   Ref: ~p&quot;, [Tag, SR]),
<a name="8798"/> 8798:                                    {ok, State#{recv_stag =&gt; Tag}};
<a name="8799"/> 8799: 
<a name="8800"/> 8800:                                {completion, {completion_info, Tag, Ref}}
<a name="8801"/> 8801:                                  when SR =:= nowait -&gt;
<a name="8802"/> 8802:                                    ?SEV_IPRINT(&quot;recv completion nowait: &quot;
<a name="8803"/> 8803:                                                &quot;~n   Tag: ~p&quot;
<a name="8804"/> 8804:                                                &quot;~n   Ref: ~p&quot;, [Tag, Ref]),
<a name="8805"/> 8805:                                    {ok, State#{recv_stag =&gt; Tag,
<a name="8806"/> 8806:                                                recv_sref =&gt; Ref}};
<a name="8807"/> 8807:                                {completion, {completion_info, Tag, SR}}
<a name="8808"/> 8808:                                  when is_reference(SR) -&gt;
<a name="8809"/> 8809:                                    ?SEV_IPRINT(&quot;recv completion ref: &quot;
<a name="8810"/> 8810:                                                &quot;~n   Tag: ~p&quot;
<a name="8811"/> 8811:                                                &quot;~n   Ref: ~p&quot;, [Tag, SR]),
<a name="8812"/> 8812:                                    {ok, State#{recv_stag =&gt; Tag}};
<a name="8813"/> 8813: 
<a name="8814"/> 8814:                                {ok, X} -&gt;
<a name="8815"/> 8815:                                    {error, {unexpected_success, X}};
<a name="8816"/> 8816:                                {error, _} = ERROR -&gt;
<a name="8817"/> 8817:                                    ERROR
<a name="8818"/> 8818:                            end
<a name="8819"/> 8819:                    end},
<a name="8820"/> 8820:          #{desc =&gt; &quot;announce ready (recv_select)&quot;,
<a name="8821"/> 8821:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="8822"/> 8822:                            ?SEV_ANNOUNCE_READY(Tester, recv_select),
<a name="8823"/> 8823:                            ok
<a name="8824"/> 8824:                    end},
<a name="8825"/> 8825:          #{desc =&gt; &quot;await select|completion message&quot;,
<a name="8826"/> 8826:            cmd  =&gt; fun(#{csock := Sock, recv_sref := RecvRef}) -&gt;
<a name="8827"/> 8827:                            receive
<a name="8828"/> 8828:                                {'$socket', Sock, select, RecvRef} -&gt;
<a name="8829"/> 8829:                                    ok;
<a name="8830"/> 8830:                                {'$socket', Sock, completion,
<a name="8831"/> 8831:                                 {RecvRef, {ok, ?BASIC_REQ}}} -&gt;
<a name="8832"/> 8832:                                    ?SEV_IPRINT(&quot;received expected data&quot;),
<a name="8833"/> 8833:                                    ok;
<a name="8834"/> 8834:                                {'$socket', Sock, completion,
<a name="8835"/> 8835:                                 {RecvRef, {error, Reason} = ERROR}} -&gt;
<a name="8836"/> 8836:                                    ?SEV_EPRINT(&quot;received unexpected error: &quot;
<a name="8837"/> 8837:                                                &quot;~n   ~p&quot;, [Reason]),
<a name="8838"/> 8838:                                    ERROR
<a name="8839"/> 8839:                            end
<a name="8840"/> 8840:                    end},
<a name="8841"/> 8841:          #{desc =&gt; &quot;announce ready (select)&quot;,
<a name="8842"/> 8842:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="8843"/> 8843:                            ?SEV_ANNOUNCE_READY(Tester, select),
<a name="8844"/> 8844:                            ok
<a name="8845"/> 8845:                    end},
<a name="8846"/> 8846:          #{desc =&gt; &quot;now read the data (request)&quot;,
<a name="8847"/> 8847:            cmd  =&gt; fun(#{sorc  := select,
<a name="8848"/> 8848:                          csock := Sock,
<a name="8849"/> 8849:                          recv  := Recv} = _State) -&gt;
<a name="8850"/> 8850:                            case Recv(Sock) of
<a name="8851"/> 8851:                                {ok, ?BASIC_REQ} -&gt;
<a name="8852"/> 8852:                                    ?SEV_IPRINT(&quot;read expected data&quot;),
<a name="8853"/> 8853:                                    ok;
<a name="8854"/> 8854:                                {error, _} = ERROR -&gt;
<a name="8855"/> 8855:                                    ERROR
<a name="8856"/> 8856:                            end;
<a name="8857"/> 8857:                       (#{sorc := completion}) -&gt;
<a name="8858"/> 8858:                            ?SEV_IPRINT(&quot;already received&quot;),
<a name="8859"/> 8859:                            ok
<a name="8860"/> 8860:                    end},
<a name="8861"/> 8861:          #{desc =&gt; &quot;announce ready (recv request)&quot;,
<a name="8862"/> 8862:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="8863"/> 8863:                            ?SEV_ANNOUNCE_READY(Tester, recv_req),
<a name="8864"/> 8864:                            ok
<a name="8865"/> 8865:                    end},
<a name="8866"/> 8866: 
<a name="8867"/> 8867:          #{desc =&gt; &quot;await continue (send reply)&quot;,
<a name="8868"/> 8868:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="8869"/> 8869:                            ?SEV_AWAIT_CONTINUE(Tester, tester, send_rep)
<a name="8870"/> 8870:                    end},
<a name="8871"/> 8871:          #{desc =&gt; &quot;send reply&quot;,
<a name="8872"/> 8872:            cmd  =&gt; fun(#{csock := Sock, send := Send}) -&gt;
<a name="8873"/> 8873:                            Send(Sock, ?BASIC_REP)
<a name="8874"/> 8874:                    end},
<a name="8875"/> 8875:          #{desc =&gt; &quot;announce ready (send reply)&quot;,
<a name="8876"/> 8876:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="8877"/> 8877:                            ?SEV_ANNOUNCE_READY(Tester, send_rep),
<a name="8878"/> 8878:                            ok
<a name="8879"/> 8879:                    end},
<a name="8880"/> 8880: 
<a name="8881"/> 8881:          %% *** Termination ***
<a name="8882"/> 8882:          #{desc =&gt; &quot;await terminate&quot;,
<a name="8883"/> 8883:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="8884"/> 8884:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="8885"/> 8885:                                ok -&gt;
<a name="8886"/> 8886:                                    {ok, maps:remove(tester, State)};
<a name="8887"/> 8887:                                {error, _} = ERROR -&gt;
<a name="8888"/> 8888:                                    ERROR
<a name="8889"/> 8889:                            end
<a name="8890"/> 8890:                    end},
<a name="8891"/> 8891:          #{desc =&gt; &quot;close connection socket&quot;,
<a name="8892"/> 8892:            cmd  =&gt; fun(#{csock := Sock}) -&gt;
<a name="8893"/> 8893:                            socket:close(Sock)
<a name="8894"/> 8894:                    end},
<a name="8895"/> 8895:          #{desc =&gt; &quot;close listen socket&quot;,
<a name="8896"/> 8896:            cmd  =&gt; fun(#{lsock := Sock}) -&gt;
<a name="8897"/> 8897:                            socket:close(Sock)
<a name="8898"/> 8898:                    end},
<a name="8899"/> 8899: 
<a name="8900"/> 8900:          %% *** We are done ***
<a name="8901"/> 8901:          ?SEV_FINISH_NORMAL
<a name="8902"/> 8902:         ],
<a name="8903"/> 8903: 
<a name="8904"/> 8904: 
<a name="8905"/> 8905:     ClientSeq = 
<a name="8906"/> 8906:         [
<a name="8907"/> 8907:          %% *** Wait for start order ***
<a name="8908"/> 8908:          #{desc =&gt; &quot;await start (from tester)&quot;,
<a name="8909"/> 8909:            cmd  =&gt; fun(State) -&gt;
<a name="8910"/> 8910:                            {Tester, Port} = ?SEV_AWAIT_START(),
<a name="8911"/> 8911:                            {ok, State#{tester =&gt; Tester, server_port =&gt; Port}}
<a name="8912"/> 8912:                    end},
<a name="8913"/> 8913:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="8914"/> 8914:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="8915"/> 8915:                            _MRef = erlang:monitor(process, Tester),
<a name="8916"/> 8916:                            ok
<a name="8917"/> 8917:                    end},
<a name="8918"/> 8918: 
<a name="8919"/> 8919:          %% *** The init part ***
<a name="8920"/> 8920:          #{desc =&gt; &quot;which server (local) address&quot;,
<a name="8921"/> 8921:            cmd  =&gt; fun(#{domain := Domain, server_port := Port} = State) -&gt;
<a name="8922"/> 8922:                            LSA = which_local_socket_addr(Domain),
<a name="8923"/> 8923:                            SSA = LSA#{port =&gt; Port},
<a name="8924"/> 8924:                            {ok, State#{local_sa =&gt; LSA, server_sa =&gt; SSA}}
<a name="8925"/> 8925:                    end},
<a name="8926"/> 8926:          #{desc =&gt; &quot;create socket&quot;,
<a name="8927"/> 8927:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="8928"/> 8928:                            case socket:open(Domain, stream, tcp) of
<a name="8929"/> 8929:                                {ok, Sock} -&gt;
<a name="8930"/> 8930:                                    {ok, State#{sock =&gt; Sock}};
<a name="8931"/> 8931:                                {error, _} = ERROR -&gt;
<a name="8932"/> 8932:                                    ERROR
<a name="8933"/> 8933:                            end
<a name="8934"/> 8934:                    end},
<a name="8935"/> 8935:          #{desc =&gt; &quot;bind to local address&quot;,
<a name="8936"/> 8936:            cmd  =&gt; fun(#{sock := Sock, local_sa := LSA} = _State) -&gt;
<a name="8937"/> 8937:                            case sock_bind(Sock, LSA) of
<a name="8938"/> 8938:                                ok -&gt;
<a name="8939"/> 8939:                                    ok;
<a name="8940"/> 8940:                                {error, _} = ERROR -&gt;
<a name="8941"/> 8941:                                    ERROR
<a name="8942"/> 8942:                            end
<a name="8943"/> 8943:                    end},
<a name="8944"/> 8944:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="8945"/> 8945:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="8946"/> 8946:                            ?SEV_ANNOUNCE_READY(Tester, init),
<a name="8947"/> 8947:                            ok
<a name="8948"/> 8948:                    end},
<a name="8949"/> 8949: 
<a name="8950"/> 8950:          %% *** The actual test ***
<a name="8951"/> 8951:          #{desc =&gt; &quot;await continue (connect)&quot;,
<a name="8952"/> 8952:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="8953"/> 8953:                            ?SEV_AWAIT_CONTINUE(Tester, tester, connect)
<a name="8954"/> 8954:                    end},
<a name="8955"/> 8955:          #{desc =&gt; &quot;connect to server&quot;,
<a name="8956"/> 8956:            cmd  =&gt; fun(#{sock := Sock, server_sa := SSA}) -&gt;
<a name="8957"/> 8957:                            socket:connect(Sock, SSA)
<a name="8958"/> 8958:                    end},
<a name="8959"/> 8959:          #{desc =&gt; &quot;announce ready (connect)&quot;,
<a name="8960"/> 8960:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="8961"/> 8961:                            ?SEV_ANNOUNCE_READY(Tester, connect),
<a name="8962"/> 8962:                            ok
<a name="8963"/> 8963:                    end},
<a name="8964"/> 8964: 
<a name="8965"/> 8965:          #{desc =&gt; &quot;await continue (send request)&quot;,
<a name="8966"/> 8966:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="8967"/> 8967:                            ?SEV_AWAIT_CONTINUE(Tester, tester, send_req)
<a name="8968"/> 8968:                    end},
<a name="8969"/> 8969:          #{desc =&gt; &quot;send request (to server)&quot;,
<a name="8970"/> 8970:            cmd  =&gt; fun(#{sock := Sock, send := Send}) -&gt;
<a name="8971"/> 8971:                            ok = Send(Sock, ?BASIC_REQ)
<a name="8972"/> 8972:                    end},
<a name="8973"/> 8973:          #{desc =&gt; &quot;announce ready (send request)&quot;,
<a name="8974"/> 8974:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="8975"/> 8975:                            ?SEV_ANNOUNCE_READY(Tester, send_req),
<a name="8976"/> 8976:                            ok
<a name="8977"/> 8977:                    end},
<a name="8978"/> 8978: 
<a name="8979"/> 8979:          #{desc =&gt; &quot;try recv reply (with nowait, expect select|completion)&quot;,
<a name="8980"/> 8980:            cmd  =&gt; fun(#{sock := Sock,
<a name="8981"/> 8981:                          recv := Recv,
<a name="8982"/> 8982:                          recv_sref := SR} = State) -&gt;
<a name="8983"/> 8983:                            case Recv(Sock) of
<a name="8984"/> 8984:                                {select, {select_info, Tag, Ref}}
<a name="8985"/> 8985:                                  when SR =:= nowait -&gt;
<a name="8986"/> 8986:                                    ?SEV_IPRINT(&quot;recv select nowait: &quot;
<a name="8987"/> 8987:                                                &quot;~n   Tag: ~p&quot;
<a name="8988"/> 8988:                                                &quot;~n   Ref: ~p&quot;, [Tag, Ref]),
<a name="8989"/> 8989:                                    {ok, State#{sorc      =&gt; select,
<a name="8990"/> 8990:                                                recv_stag =&gt; Tag,
<a name="8991"/> 8991:                                                recv_sref =&gt; Ref}};
<a name="8992"/> 8992:                                {select, {select_info, Tag, SR}}
<a name="8993"/> 8993:                                  when is_reference(SR) -&gt;
<a name="8994"/> 8994:                                    ?SEV_IPRINT(&quot;recv select ref: &quot;
<a name="8995"/> 8995:                                                &quot;~n   Tag: ~p&quot;
<a name="8996"/> 8996:                                                &quot;~n   Ref: ~p&quot;, [Tag, SR]),
<a name="8997"/> 8997:                                    {ok, State#{sorc      =&gt; select,
<a name="8998"/> 8998:                                                recv_stag =&gt; Tag}};
<a name="8999"/> 8999: 
<a name="9000"/> 9000:                                {completion, {completion_info, Tag, Ref}}
<a name="9001"/> 9001:                                  when SR =:= nowait -&gt;
<a name="9002"/> 9002:                                    ?SEV_IPRINT(&quot;recv completion nowait: &quot;
<a name="9003"/> 9003:                                                &quot;~n   Tag: ~p&quot;
<a name="9004"/> 9004:                                                &quot;~n   Ref: ~p&quot;, [Tag, Ref]),
<a name="9005"/> 9005:                                    {ok, State#{sorc      =&gt; completion,
<a name="9006"/> 9006:                                                recv_stag =&gt; Tag,
<a name="9007"/> 9007:                                                recv_sref =&gt; Ref}};
<a name="9008"/> 9008:                                {completion, {completion_info, Tag, SR}}
<a name="9009"/> 9009:                                  when is_reference(SR) -&gt;
<a name="9010"/> 9010:                                    ?SEV_IPRINT(&quot;recv completion ref: &quot;
<a name="9011"/> 9011:                                                &quot;~n   Tag: ~p&quot;
<a name="9012"/> 9012:                                                &quot;~n   Ref: ~p&quot;, [Tag, SR]),
<a name="9013"/> 9013:                                    {ok, State#{sorc      =&gt; completion,
<a name="9014"/> 9014:                                                recv_stag =&gt; Tag}};
<a name="9015"/> 9015: 
<a name="9016"/> 9016:                                {ok, X} -&gt;
<a name="9017"/> 9017:                                    {error, {unexpected_success, X}};
<a name="9018"/> 9018:                                {error, _} = ERROR -&gt;
<a name="9019"/> 9019:                                    ERROR
<a name="9020"/> 9020:                            end
<a name="9021"/> 9021:                    end},
<a name="9022"/> 9022:          #{desc =&gt; &quot;announce ready (recv_select)&quot;,
<a name="9023"/> 9023:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="9024"/> 9024:                            ?SEV_ANNOUNCE_READY(Tester, recv_select),
<a name="9025"/> 9025:                            ok
<a name="9026"/> 9026:                    end},
<a name="9027"/> 9027:          #{desc =&gt; &quot;await select message&quot;,
<a name="9028"/> 9028:            cmd  =&gt; fun(#{sock := Sock, recv_sref := RecvRef}) -&gt;
<a name="9029"/> 9029:                            receive
<a name="9030"/> 9030:                                {'$socket', Sock, select, RecvRef} -&gt;
<a name="9031"/> 9031:                                    ok;
<a name="9032"/> 9032:                                {'$socket', Sock, completion,
<a name="9033"/> 9033:                                 {RecvRef, {ok, ?BASIC_REP}}} -&gt;
<a name="9034"/> 9034:                                    ?SEV_IPRINT(&quot;received expected reply&quot;),
<a name="9035"/> 9035:                                    ok
<a name="9036"/> 9036:                            end
<a name="9037"/> 9037:                    end},
<a name="9038"/> 9038:          #{desc =&gt; &quot;announce ready (select)&quot;,
<a name="9039"/> 9039:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="9040"/> 9040:                            ?SEV_ANNOUNCE_READY(Tester, select),
<a name="9041"/> 9041:                            ok
<a name="9042"/> 9042:                    end},
<a name="9043"/> 9043:          #{desc =&gt; &quot;now read the data (reply)&quot;,
<a name="9044"/> 9044:            cmd  =&gt; fun(#{sorc := select, sock := Sock, recv := Recv}) -&gt;
<a name="9045"/> 9045:                            {ok, ?BASIC_REP} = Recv(Sock),
<a name="9046"/> 9046:                            ?SEV_IPRINT(&quot;[select] received expected reply&quot;),
<a name="9047"/> 9047:                            ok;
<a name="9048"/> 9048:                       (#{sorc := completion}) -&gt;
<a name="9049"/> 9049:                            ?SEV_IPRINT(&quot;[completion] &quot;
<a name="9050"/> 9050:                                        &quot;expected reply already received&quot;),
<a name="9051"/> 9051:                            ok
<a name="9052"/> 9052:                    end},
<a name="9053"/> 9053:          #{desc =&gt; &quot;announce ready (recv reply)&quot;,
<a name="9054"/> 9054:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="9055"/> 9055:                            ?SEV_ANNOUNCE_READY(Tester, recv_rep),
<a name="9056"/> 9056:                            ok
<a name="9057"/> 9057:                    end},
<a name="9058"/> 9058: 
<a name="9059"/> 9059:          %% *** Termination ***
<a name="9060"/> 9060:          #{desc =&gt; &quot;await terminate&quot;,
<a name="9061"/> 9061:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="9062"/> 9062:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="9063"/> 9063:                                ok -&gt;
<a name="9064"/> 9064:                                    {ok, maps:remove(tester, State)};
<a name="9065"/> 9065:                                {error, _} = ERROR -&gt;
<a name="9066"/> 9066:                                    ERROR
<a name="9067"/> 9067:                            end
<a name="9068"/> 9068:                    end},
<a name="9069"/> 9069:          #{desc =&gt; &quot;close socket&quot;,
<a name="9070"/> 9070:            cmd  =&gt; fun(#{sock := Sock}) -&gt;
<a name="9071"/> 9071:                            socket:close(Sock)
<a name="9072"/> 9072:                    end},
<a name="9073"/> 9073: 
<a name="9074"/> 9074:          %% *** We are done ***
<a name="9075"/> 9075:          ?SEV_FINISH_NORMAL
<a name="9076"/> 9076:         ],
<a name="9077"/> 9077: 
<a name="9078"/> 9078:     TesterSeq =
<a name="9079"/> 9079:         [
<a name="9080"/> 9080:          %% *** Init part ***
<a name="9081"/> 9081:          #{desc =&gt; &quot;monitor server&quot;,
<a name="9082"/> 9082:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="9083"/> 9083:                            _MRef = erlang:monitor(process, Pid),
<a name="9084"/> 9084:                            ok
<a name="9085"/> 9085:                    end},
<a name="9086"/> 9086:          #{desc =&gt; &quot;monitor client&quot;,
<a name="9087"/> 9087:            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;
<a name="9088"/> 9088:                            _MRef = erlang:monitor(process, Pid),
<a name="9089"/> 9089:                            ok
<a name="9090"/> 9090:                    end},
<a name="9091"/> 9091: 
<a name="9092"/> 9092:          %% Start the server
<a name="9093"/> 9093:          #{desc =&gt; &quot;order server start&quot;,
<a name="9094"/> 9094:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="9095"/> 9095:                            ?SEV_ANNOUNCE_START(Pid),
<a name="9096"/> 9096:                            ok
<a name="9097"/> 9097:                    end},
<a name="9098"/> 9098:          #{desc =&gt; &quot;await server ready (init)&quot;,
<a name="9099"/> 9099:            cmd  =&gt; fun(#{server := Pid} = State) -&gt;
<a name="9100"/> 9100:                            {ok, Port} = ?SEV_AWAIT_READY(Pid, server, init),
<a name="9101"/> 9101:                            {ok, State#{server_port =&gt; Port}}
<a name="9102"/> 9102:                    end},
<a name="9103"/> 9103: 
<a name="9104"/> 9104:          %% Start the client
<a name="9105"/> 9105:          #{desc =&gt; &quot;order client start&quot;,
<a name="9106"/> 9106:            cmd  =&gt; fun(#{client := Pid, server_port := Port} = _State) -&gt;
<a name="9107"/> 9107:                            ?SEV_ANNOUNCE_START(Pid, Port),
<a name="9108"/> 9108:                            ok
<a name="9109"/> 9109:                    end},
<a name="9110"/> 9110:          #{desc =&gt; &quot;await client ready (init)&quot;,
<a name="9111"/> 9111:            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;
<a name="9112"/> 9112:                            ok = ?SEV_AWAIT_READY(Pid, client, init)
<a name="9113"/> 9113:                    end},
<a name="9114"/> 9114: 
<a name="9115"/> 9115:          %% *** The actual test ***
<a name="9116"/> 9116:          #{desc =&gt; &quot;order server to continue (with accept)&quot;,
<a name="9117"/> 9117:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="9118"/> 9118:                            ?SEV_ANNOUNCE_CONTINUE(Server, accept),
<a name="9119"/> 9119:                            ok
<a name="9120"/> 9120:                    end},
<a name="9121"/> 9121:          #{desc =&gt; &quot;await server ready (accept select)&quot;,
<a name="9122"/> 9122:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="9123"/> 9123:                            ?SEV_AWAIT_READY(Pid, server, accept_select)
<a name="9124"/> 9124:                    end},
<a name="9125"/> 9125:          #{desc =&gt; &quot;order client to continue (with connect)&quot;,
<a name="9126"/> 9126:            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;
<a name="9127"/> 9127:                            ?SEV_ANNOUNCE_CONTINUE(Pid, connect),
<a name="9128"/> 9128:                            ok
<a name="9129"/> 9129:                    end},
<a name="9130"/> 9130:          #{desc =&gt; &quot;await server ready (select)&quot;,
<a name="9131"/> 9131:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="9132"/> 9132:                            ?SEV_AWAIT_READY(Pid, server, select)
<a name="9133"/> 9133:                    end},
<a name="9134"/> 9134:          #{desc =&gt; &quot;await server ready (accept)&quot;,
<a name="9135"/> 9135:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="9136"/> 9136:                            ?SEV_AWAIT_READY(Pid, server, accept)
<a name="9137"/> 9137:                    end},
<a name="9138"/> 9138:          #{desc =&gt; &quot;await client ready (connect)&quot;,
<a name="9139"/> 9139:            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;
<a name="9140"/> 9140:                            ?SEV_AWAIT_READY(Pid, client, connect)
<a name="9141"/> 9141:                    end},
<a name="9142"/> 9142: 
<a name="9143"/> 9143:          #{desc =&gt; &quot;order server to continue (recv request)&quot;,
<a name="9144"/> 9144:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="9145"/> 9145:                            ?SEV_ANNOUNCE_CONTINUE(Pid, recv_req),
<a name="9146"/> 9146:                            ok
<a name="9147"/> 9147:                    end},
<a name="9148"/> 9148:          #{desc =&gt; &quot;await server ready (recv select)&quot;,
<a name="9149"/> 9149:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="9150"/> 9150:                            ?SEV_AWAIT_READY(Pid, server, recv_select)
<a name="9151"/> 9151:                    end},
<a name="9152"/> 9152:          #{desc =&gt; &quot;order client to continue (send request)&quot;,
<a name="9153"/> 9153:            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;
<a name="9154"/> 9154:                            ?SEV_ANNOUNCE_CONTINUE(Pid, send_req),
<a name="9155"/> 9155:                            ok
<a name="9156"/> 9156:                    end},
<a name="9157"/> 9157:          #{desc =&gt; &quot;await client ready (send request)&quot;,
<a name="9158"/> 9158:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="9159"/> 9159:                            ?SEV_AWAIT_READY(Client, client, send_req)
<a name="9160"/> 9160:                    end},
<a name="9161"/> 9161:          #{desc =&gt; &quot;await server ready (select)&quot;,
<a name="9162"/> 9162:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="9163"/> 9163:                            ?SEV_AWAIT_READY(Pid, server, select)
<a name="9164"/> 9164:                    end},
<a name="9165"/> 9165:          #{desc =&gt; &quot;await server ready (recv request)&quot;,
<a name="9166"/> 9166:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="9167"/> 9167:                            ?SEV_AWAIT_READY(Pid, server, recv_req)
<a name="9168"/> 9168:                    end},
<a name="9169"/> 9169: 
<a name="9170"/> 9170:          #{desc =&gt; &quot;order client to continue (recv reply)&quot;,
<a name="9171"/> 9171:            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;
<a name="9172"/> 9172:                            ?SEV_ANNOUNCE_CONTINUE(Pid, recv_rep),
<a name="9173"/> 9173:                            ok
<a name="9174"/> 9174:                    end},
<a name="9175"/> 9175:          #{desc =&gt; &quot;await client ready (recv select)&quot;,
<a name="9176"/> 9176:            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;
<a name="9177"/> 9177:                            ?SEV_AWAIT_READY(Pid, client, recv_select)
<a name="9178"/> 9178:                    end},
<a name="9179"/> 9179:          #{desc =&gt; &quot;order server to continue (send reply)&quot;,
<a name="9180"/> 9180:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="9181"/> 9181:                            ?SEV_ANNOUNCE_CONTINUE(Pid, send_rep),
<a name="9182"/> 9182:                            ok
<a name="9183"/> 9183:                    end},
<a name="9184"/> 9184:          #{desc =&gt; &quot;await server ready (send reply)&quot;,
<a name="9185"/> 9185:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="9186"/> 9186:                            ?SEV_AWAIT_READY(Pid, server, send_rep)
<a name="9187"/> 9187:                    end},
<a name="9188"/> 9188:          #{desc =&gt; &quot;await client ready (select)&quot;,
<a name="9189"/> 9189:            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;
<a name="9190"/> 9190:                            ?SEV_AWAIT_READY(Pid, client, select)
<a name="9191"/> 9191:                    end},
<a name="9192"/> 9192:          #{desc =&gt; &quot;await client ready (reply recv)&quot;,
<a name="9193"/> 9193:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="9194"/> 9194:                            ?SEV_AWAIT_READY(Client, client, recv_rep)
<a name="9195"/> 9195:                    end},
<a name="9196"/> 9196: 
<a name="9197"/> 9197: 
<a name="9198"/> 9198:          %% *** Termination ***
<a name="9199"/> 9199:          #{desc =&gt; &quot;order client to terminate&quot;,
<a name="9200"/> 9200:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="9201"/> 9201:                            ?SEV_ANNOUNCE_TERMINATE(Client),
<a name="9202"/> 9202:                            ok
<a name="9203"/> 9203:                    end},
<a name="9204"/> 9204:          #{desc =&gt; &quot;await client termination&quot;,
<a name="9205"/> 9205:            cmd  =&gt; fun(#{client := Client} = State) -&gt;
<a name="9206"/> 9206:                            ?SEV_AWAIT_TERMINATION(Client),
<a name="9207"/> 9207:                            State1 = maps:remove(client, State),
<a name="9208"/> 9208:                            {ok, State1}
<a name="9209"/> 9209:                    end},
<a name="9210"/> 9210:          #{desc =&gt; &quot;order server to terminate&quot;,
<a name="9211"/> 9211:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="9212"/> 9212:                            ?SEV_ANNOUNCE_TERMINATE(Server),
<a name="9213"/> 9213:                            ok
<a name="9214"/> 9214:                    end},
<a name="9215"/> 9215:          #{desc =&gt; &quot;await server termination&quot;,
<a name="9216"/> 9216:            cmd  =&gt; fun(#{server := Server} = State) -&gt;
<a name="9217"/> 9217:                            ?SEV_AWAIT_TERMINATION(Server),
<a name="9218"/> 9218:                            State1 = maps:remove(server, State),
<a name="9219"/> 9219:                            {ok, State1}
<a name="9220"/> 9220:                    end},
<a name="9221"/> 9221: 
<a name="9222"/> 9222:          %% *** We are done ***
<a name="9223"/> 9223:          ?SEV_FINISH_NORMAL
<a name="9224"/> 9224:         ],
<a name="9225"/> 9225: 
<a name="9226"/> 9226:     i(&quot;start server evaluator&quot;),
<a name="9227"/> 9227:     Server = ?SEV_START(&quot;server&quot;, ServerSeq, InitState),
<a name="9228"/> 9228: 
<a name="9229"/> 9229:     i(&quot;start client evaluator&quot;),
<a name="9230"/> 9230:     Client = ?SEV_START(&quot;client&quot;, ClientSeq, InitState),
<a name="9231"/> 9231: 
<a name="9232"/> 9232:     i(&quot;start tester evaluator&quot;),
<a name="9233"/> 9233:     TesterInitState = #{server =&gt; Server#ev.pid,
<a name="9234"/> 9234:                         client =&gt; Client#ev.pid},
<a name="9235"/> 9235:     Tester = ?SEV_START(&quot;tester&quot;, TesterSeq, TesterInitState),
<a name="9236"/> 9236: 
<a name="9237"/> 9237:     i(&quot;await evaluator(s)&quot;),
<a name="api_a_send_and_recv_tcp-last_expr"/><a name="9238"/> 9238: <b>    ok = ?SEV_AWAIT_FINISH</b>([Server, Client, Tester]).
<a name="9239"/> 9239: 
<a name="9240"/> 9240: 
<a name="9241"/> 9241: 
<a name="9242"/> 9242: 
<a name="9243"/> 9243: 
<a name="9244"/> 9244: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="9245"/> 9245: 
<a name="9246"/> 9246: <i>%% Basically we make an async (Timeout = nowait) call to recvfrom,</i>
<a name="9247"/> 9247: <i>%% wait some time and then cancel. IPv4</i>
<a name="9248"/> 9248: <i>%%</i>
<a name="api_a_recvfrom_cancel_udp4-1"/><a name="9249"/> 9249: <b>api_a_recvfrom_cancel_udp4</b>(Config) when is_list(Config) -&gt;
<a name="9250"/> 9250:     ?TT(?SECS(10)),
<a name="9251"/> 9251:     Nowait = nowait(Config),
<a name="api_a_recvfrom_cancel_udp4-last_expr"/><a name="9252"/> 9252: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="9253"/> 9253:            fun() -&gt; has_support_ipv4() end,
<a name="9254"/> 9254:            fun() -&gt;
<a name="9255"/> 9255:                    Recv = fun(Sock) -&gt;
<a name="9256"/> 9256:                                   case socket:recvfrom(Sock, 0, Nowait) of
<a name="9257"/> 9257:                                       {ok, _} = OK -&gt;
<a name="9258"/> 9258:                                           OK;
<a name="9259"/> 9259:                                       {select, _} = SELECT -&gt;
<a name="9260"/> 9260:                                           SELECT;
<a name="9261"/> 9261:                                       {completion, _} = COMPLETION -&gt;
<a name="9262"/> 9262:                                           COMPLETION;
<a name="9263"/> 9263:                                       {error, _} = ERROR -&gt;
<a name="9264"/> 9264:                                           ERROR
<a name="9265"/> 9265:                                   end
<a name="9266"/> 9266:                           end,
<a name="9267"/> 9267:                    InitState = #{domain   =&gt; inet,
<a name="9268"/> 9268:                                  recv     =&gt; Recv,
<a name="9269"/> 9269:                                  recv_ref =&gt; Nowait},
<a name="9270"/> 9270:                    ok = api_a_recv_cancel_udp(InitState)
<a name="9271"/> 9271:            end).
<a name="9272"/> 9272: 
<a name="9273"/> 9273: 
<a name="9274"/> 9274: 
<a name="9275"/> 9275: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="9276"/> 9276: 
<a name="9277"/> 9277: <i>%% Basically we make an async (Timeout = nowait) call to recvfrom,</i>
<a name="9278"/> 9278: <i>%% wait some time and then cancel. IPv6</i>
<a name="9279"/> 9279: <i>%%</i>
<a name="api_a_recvfrom_cancel_udp6-1"/><a name="9280"/> 9280: <b>api_a_recvfrom_cancel_udp6</b>(Config) when is_list(Config) -&gt;
<a name="9281"/> 9281:     ?TT(?SECS(10)),
<a name="9282"/> 9282:     Nowait = nowait(Config),
<a name="api_a_recvfrom_cancel_udp6-last_expr"/><a name="9283"/> 9283: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="9284"/> 9284:            fun() -&gt; has_support_ipv6() end,
<a name="9285"/> 9285:            fun() -&gt;
<a name="9286"/> 9286:                    Recv = fun(Sock) -&gt;
<a name="9287"/> 9287:                                   case socket:recvfrom(Sock, 0, Nowait) of
<a name="9288"/> 9288:                                       {ok, _} = OK -&gt;
<a name="9289"/> 9289:                                           OK;
<a name="9290"/> 9290:                                       {select, _} = SELECT -&gt;
<a name="9291"/> 9291:                                           SELECT;
<a name="9292"/> 9292:                                       {completion, _} = COMPLETION -&gt;
<a name="9293"/> 9293:                                           COMPLETION;
<a name="9294"/> 9294:                                       {error, _} = ERROR -&gt;
<a name="9295"/> 9295:                                           ERROR
<a name="9296"/> 9296:                                   end
<a name="9297"/> 9297:                           end,
<a name="9298"/> 9298:                    InitState = #{domain   =&gt; inet6,
<a name="9299"/> 9299:                                  recv     =&gt; Recv,
<a name="9300"/> 9300:                                  recv_ref =&gt; Nowait},
<a name="9301"/> 9301:                    ok = api_a_recv_cancel_udp(InitState)
<a name="9302"/> 9302:            end).
<a name="9303"/> 9303: 
<a name="9304"/> 9304: 
<a name="9305"/> 9305: 
<a name="9306"/> 9306: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="9307"/> 9307: 
<a name="9308"/> 9308: <i>%% Basically we make an async (Timeout = nowait) call to recvmsg,</i>
<a name="9309"/> 9309: <i>%% wait some time and then cancel. IPv4</i>
<a name="9310"/> 9310: <i>%%</i>
<a name="api_a_recvmsg_cancel_udp4-1"/><a name="9311"/> 9311: <b>api_a_recvmsg_cancel_udp4</b>(Config) when is_list(Config) -&gt;
<a name="9312"/> 9312:     ?TT(?SECS(10)),
<a name="9313"/> 9313:     Nowait = nowait(Config),
<a name="api_a_recvmsg_cancel_udp4-last_expr"/><a name="9314"/> 9314: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="9315"/> 9315:            fun() -&gt; has_support_ipv4() end,
<a name="9316"/> 9316:            fun() -&gt;
<a name="9317"/> 9317:                    Recv = fun(Sock) -&gt;
<a name="9318"/> 9318:                                   case socket:recvmsg(Sock, Nowait) of
<a name="9319"/> 9319:                                       {ok, _} = OK -&gt;
<a name="9320"/> 9320:                                           OK;
<a name="9321"/> 9321:                                       {select, _} = SELECT -&gt;
<a name="9322"/> 9322:                                           SELECT;
<a name="9323"/> 9323:                                       {completion, _} = COMPLETION -&gt;
<a name="9324"/> 9324:                                           COMPLETION;
<a name="9325"/> 9325:                                       {error, _} = ERROR -&gt;
<a name="9326"/> 9326:                                           ERROR
<a name="9327"/> 9327:                                   end
<a name="9328"/> 9328:                           end,
<a name="9329"/> 9329:                    InitState = #{domain   =&gt; inet,
<a name="9330"/> 9330:                                  recv     =&gt; Recv,
<a name="9331"/> 9331:                                  recv_ref =&gt; Nowait},
<a name="9332"/> 9332:                    ok = api_a_recv_cancel_udp(InitState)
<a name="9333"/> 9333:            end).
<a name="9334"/> 9334: 
<a name="9335"/> 9335: 
<a name="9336"/> 9336: 
<a name="9337"/> 9337: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="9338"/> 9338: 
<a name="9339"/> 9339: <i>%% Basically we make an async (Timeout = nowait) call to recvmsg,</i>
<a name="9340"/> 9340: <i>%% wait some time and then cancel. IPv6</i>
<a name="9341"/> 9341: <i>%%</i>
<a name="api_a_recvmsg_cancel_udp6-1"/><a name="9342"/> 9342: <b>api_a_recvmsg_cancel_udp6</b>(Config) when is_list(Config) -&gt;
<a name="9343"/> 9343:     ?TT(?SECS(10)),
<a name="9344"/> 9344:     Nowait = nowait(Config),
<a name="api_a_recvmsg_cancel_udp6-last_expr"/><a name="9345"/> 9345: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="9346"/> 9346:            fun() -&gt; has_support_ipv6() end,
<a name="9347"/> 9347:            fun() -&gt;
<a name="9348"/> 9348:                    Recv = fun(Sock) -&gt;
<a name="9349"/> 9349:                                   case socket:recvmsg(Sock, Nowait) of
<a name="9350"/> 9350:                                       {ok, _} = OK -&gt;
<a name="9351"/> 9351:                                           OK;
<a name="9352"/> 9352:                                       {select, _} = SELECT -&gt;
<a name="9353"/> 9353:                                           SELECT;
<a name="9354"/> 9354:                                       {completion, _} = COMPLETION -&gt;
<a name="9355"/> 9355:                                           COMPLETION;
<a name="9356"/> 9356:                                       {error, _} = ERROR -&gt;
<a name="9357"/> 9357:                                           ERROR
<a name="9358"/> 9358:                                   end
<a name="9359"/> 9359:                           end,
<a name="9360"/> 9360:                    InitState = #{domain   =&gt; inet6,
<a name="9361"/> 9361:                                  recv     =&gt; Recv,
<a name="9362"/> 9362:                                  recv_ref =&gt; Nowait},
<a name="9363"/> 9363:                    ok = api_a_recv_cancel_udp(InitState)
<a name="9364"/> 9364:            end).
<a name="9365"/> 9365: 
<a name="9366"/> 9366: 
<a name="9367"/> 9367: 
<a name="9368"/> 9368: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="9369"/> 9369: 
<a name="api_a_recv_cancel_udp-1"/><a name="9370"/> 9370: <b>api_a_recv_cancel_udp</b>(InitState) -&gt;
<a name="9371"/> 9371:     ServerSeq = 
<a name="9372"/> 9372:         [
<a name="9373"/> 9373:          %% *** Wait for start order part ***
<a name="9374"/> 9374:          #{desc =&gt; &quot;await start&quot;,
<a name="9375"/> 9375:            cmd  =&gt; fun(State) -&gt;
<a name="9376"/> 9376:                            Tester = ?SEV_AWAIT_START(),
<a name="9377"/> 9377:                            {ok, State#{tester =&gt; Tester}}
<a name="9378"/> 9378:                    end},
<a name="9379"/> 9379:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="9380"/> 9380:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="9381"/> 9381:                            _MRef = erlang:monitor(process, Tester),
<a name="9382"/> 9382:                            ok
<a name="9383"/> 9383:                    end},
<a name="9384"/> 9384: 
<a name="9385"/> 9385:          %% *** Init part ***
<a name="9386"/> 9386:          #{desc =&gt; &quot;which local address&quot;,
<a name="9387"/> 9387:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="9388"/> 9388:                            LSA = which_local_socket_addr(Domain),
<a name="9389"/> 9389:                            {ok, State#{local_sa =&gt; LSA}}
<a name="9390"/> 9390:                    end},
<a name="9391"/> 9391:          #{desc =&gt; &quot;create socket&quot;,
<a name="9392"/> 9392:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="9393"/> 9393:                            case socket:open(Domain, dgram, udp) of
<a name="9394"/> 9394:                                {ok, Sock} -&gt;
<a name="9395"/> 9395:                                    {ok, State#{sock =&gt; Sock}};
<a name="9396"/> 9396:                                {error, _} = ERROR -&gt;
<a name="9397"/> 9397:                                    ERROR
<a name="9398"/> 9398:                            end
<a name="9399"/> 9399:                    end},
<a name="9400"/> 9400:          #{desc =&gt; &quot;bind socket (to local address)&quot;,
<a name="9401"/> 9401:            cmd  =&gt; fun(#{sock := Sock, local_sa := LSA} = State) -&gt;
<a name="9402"/> 9402:                            case sock_bind(Sock, LSA) of
<a name="9403"/> 9403:                                ok -&gt;
<a name="9404"/> 9404:                                    Port = sock_port(Sock),
<a name="9405"/> 9405:                                    {ok, State#{port =&gt; Port}};
<a name="9406"/> 9406:                                {error, _} = ERROR -&gt;
<a name="9407"/> 9407:                                    ERROR
<a name="9408"/> 9408:                            end
<a name="9409"/> 9409:                    end},
<a name="9410"/> 9410:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="9411"/> 9411:            cmd  =&gt; fun(#{tester := Tester, local_sa := LSA, port := Port}) -&gt;
<a name="9412"/> 9412:                            ServerSA = LSA#{port =&gt; Port},
<a name="9413"/> 9413:                            ?SEV_ANNOUNCE_READY(Tester, init, ServerSA),
<a name="9414"/> 9414:                            ok
<a name="9415"/> 9415:                    end},
<a name="9416"/> 9416: 
<a name="9417"/> 9417:          %% The actual test
<a name="9418"/> 9418:          #{desc =&gt; &quot;await continue (recv)&quot;,
<a name="9419"/> 9419:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="9420"/> 9420:                            ?SEV_AWAIT_CONTINUE(Tester, tester, recv)
<a name="9421"/> 9421:                    end},
<a name="9422"/> 9422:          #{desc =&gt; &quot;try recv request (with nowait, expect select|completion)&quot;,
<a name="9423"/> 9423:            cmd  =&gt; fun(#{sock     := Sock,
<a name="9424"/> 9424:                          recv     := Recv,
<a name="9425"/> 9425:                          recv_ref := Ref} = State) -&gt;
<a name="9426"/> 9426:                            case Recv(Sock) of
<a name="9427"/> 9427:                                {select, SI} when Ref =:= nowait -&gt;
<a name="9428"/> 9428:                                    {ok, State#{recv_select_info =&gt; SI}};
<a name="9429"/> 9429:                                {select,
<a name="9430"/> 9430:                                 {select_info, _Tag, Ref} = SI}
<a name="9431"/> 9431:                                  when is_reference(Ref) -&gt;
<a name="9432"/> 9432:                                    {ok, State#{recv_select_info =&gt; SI}};
<a name="9433"/> 9433: 
<a name="9434"/> 9434:                                {completion, CI} when Ref =:= nowait -&gt;
<a name="9435"/> 9435:                                    {ok, State#{recv_completion_info =&gt; CI}};
<a name="9436"/> 9436:                                {completion,
<a name="9437"/> 9437:                                 {completion_info, _Tag, Ref} = CI}
<a name="9438"/> 9438:                                  when is_reference(Ref) -&gt;
<a name="9439"/> 9439:                                    {ok, State#{recv_completion_info =&gt; CI}};
<a name="9440"/> 9440: 
<a name="9441"/> 9441:                                {ok, X} -&gt;
<a name="9442"/> 9442:                                    {error, {unexpected_success, X}};
<a name="9443"/> 9443: 
<a name="9444"/> 9444:                                {error, _} = ERROR -&gt;
<a name="9445"/> 9445:                                    ERROR
<a name="9446"/> 9446:                            end
<a name="9447"/> 9447:                    end},
<a name="9448"/> 9448:          #{desc =&gt; &quot;announce ready (recv_select)&quot;,
<a name="9449"/> 9449:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="9450"/> 9450:                            ?SEV_ANNOUNCE_READY(Tester, recv_select),
<a name="9451"/> 9451:                            ok
<a name="9452"/> 9452:                    end},
<a name="9453"/> 9453:          #{desc =&gt; &quot;wait for select message - without success&quot;,
<a name="9454"/> 9454:            cmd  =&gt; fun(#{sock := Sock}) -&gt;
<a name="9455"/> 9455:                            receive
<a name="9456"/> 9456:                                {'$socket', Sock, select, Ref} -&gt;
<a name="9457"/> 9457:                                    {error, {unexpected_select, Ref}};
<a name="9458"/> 9458: 
<a name="9459"/> 9459:                                {'$socket', Sock, completion, C} -&gt;
<a name="9460"/> 9460:                                    {error, {unexpected_completion, C}}
<a name="9461"/> 9461: 
<a name="9462"/> 9462:                            after 5000 -&gt;
<a name="9463"/> 9463:                                    ok
<a name="9464"/> 9464:                            end
<a name="9465"/> 9465:                    end},
<a name="9466"/> 9466:          #{desc =&gt; &quot;announce ready (no select)&quot;,
<a name="9467"/> 9467:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="9468"/> 9468:                            ?SEV_ANNOUNCE_READY(Tester, no_select),
<a name="9469"/> 9469:                            ok
<a name="9470"/> 9470:                    end},
<a name="9471"/> 9471:          #{desc =&gt; &quot;await continue (cancel)&quot;,
<a name="9472"/> 9472:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="9473"/> 9473:                            ?SEV_AWAIT_CONTINUE(Tester, tester, cancel)
<a name="9474"/> 9474:                    end},
<a name="9475"/> 9475:          #{desc =&gt; &quot;cancel&quot;,
<a name="9476"/> 9476:            cmd  =&gt; fun(#{sock := Sock, recv_select_info := SI}) -&gt;
<a name="9477"/> 9477:                            ok = socket:cancel(Sock, SI);
<a name="9478"/> 9478:                       (#{sock := Sock, recv_completion_info := CI}) -&gt;
<a name="9479"/> 9479:                            ok = socket:cancel(Sock, CI)
<a name="9480"/> 9480:                    end},
<a name="9481"/> 9481: 
<a name="9482"/> 9482:          #{desc =&gt; &quot;announce ready (cancel)&quot;,
<a name="9483"/> 9483:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="9484"/> 9484:                            ?SEV_ANNOUNCE_READY(Tester, cancel),
<a name="9485"/> 9485:                            ok
<a name="9486"/> 9486:                    end},
<a name="9487"/> 9487: 
<a name="9488"/> 9488:          %% Termination
<a name="9489"/> 9489:          #{desc =&gt; &quot;await terminate (from tester)&quot;,
<a name="9490"/> 9490:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="9491"/> 9491:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="9492"/> 9492:                                ok -&gt;
<a name="9493"/> 9493:                                    State2 = maps:remove(tester,   State),
<a name="9494"/> 9494:                                    State3 = maps:remove(recv_ref, State2),
<a name="9495"/> 9495:                                    State4 = maps:remove(req_src,  State3),
<a name="9496"/> 9496:                                    {ok, State4};
<a name="9497"/> 9497:                                {error, _} = ERROR -&gt;
<a name="9498"/> 9498:                                    ERROR
<a name="9499"/> 9499:                            end
<a name="9500"/> 9500:                    end},
<a name="9501"/> 9501:          #{desc =&gt; &quot;close socket&quot;,
<a name="9502"/> 9502:            cmd  =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="9503"/> 9503:                            ok = socket:close(Sock),
<a name="9504"/> 9504:                            {ok, maps:remove(sock, State)}
<a name="9505"/> 9505:                    end},
<a name="9506"/> 9506: 
<a name="9507"/> 9507:          %% *** We are done ***
<a name="9508"/> 9508:          ?SEV_FINISH_NORMAL
<a name="9509"/> 9509:         ],
<a name="9510"/> 9510: 
<a name="9511"/> 9511: 
<a name="9512"/> 9512:     TesterSeq = 
<a name="9513"/> 9513:         [
<a name="9514"/> 9514:          %% *** Init part ***
<a name="9515"/> 9515:          #{desc =&gt; &quot;monitor server&quot;,
<a name="9516"/> 9516:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="9517"/> 9517:                            _MRef = erlang:monitor(process, Pid),
<a name="9518"/> 9518:                            ok
<a name="9519"/> 9519:                    end},
<a name="9520"/> 9520: 
<a name="9521"/> 9521:          %% Start the server
<a name="9522"/> 9522:          #{desc =&gt; &quot;order server start&quot;,
<a name="9523"/> 9523:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="9524"/> 9524:                            ?SEV_ANNOUNCE_START(Pid),
<a name="9525"/> 9525:                            ok
<a name="9526"/> 9526:                    end},
<a name="9527"/> 9527:          #{desc =&gt; &quot;await server ready (init)&quot;,
<a name="9528"/> 9528:            cmd  =&gt; fun(#{server := Pid} = State) -&gt;
<a name="9529"/> 9529:                            {ok, ServerSA} = ?SEV_AWAIT_READY(Pid, server, init),
<a name="9530"/> 9530:                            {ok, State#{server_sa =&gt; ServerSA}}
<a name="9531"/> 9531:                    end},
<a name="9532"/> 9532: 
<a name="9533"/> 9533:          %% The actual test
<a name="9534"/> 9534:          #{desc =&gt; &quot;order server continue (recv)&quot;,
<a name="9535"/> 9535:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="9536"/> 9536:                            ?SEV_ANNOUNCE_CONTINUE(Pid, recv),
<a name="9537"/> 9537:                            ok
<a name="9538"/> 9538:                    end},
<a name="9539"/> 9539:          #{desc =&gt; &quot;await server ready (recv select)&quot;,
<a name="9540"/> 9540:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="9541"/> 9541:                            ok = ?SEV_AWAIT_READY(Pid, server, recv_select)
<a name="9542"/> 9542:                    end},
<a name="9543"/> 9543:          #{desc =&gt; &quot;await server ready (no select)&quot;,
<a name="9544"/> 9544:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="9545"/> 9545:                            ok = ?SEV_AWAIT_READY(Pid, server, no_select)
<a name="9546"/> 9546:                    end},
<a name="9547"/> 9547:          #{desc =&gt; &quot;order server continue (cancel)&quot;,
<a name="9548"/> 9548:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="9549"/> 9549:                            ?SEV_ANNOUNCE_CONTINUE(Pid, cancel),
<a name="9550"/> 9550:                            ok
<a name="9551"/> 9551:                    end},
<a name="9552"/> 9552:          #{desc =&gt; &quot;await server ready (cancel)&quot;,
<a name="9553"/> 9553:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="9554"/> 9554:                            ok = ?SEV_AWAIT_READY(Pid, server, cancel)
<a name="9555"/> 9555:                    end},
<a name="9556"/> 9556: 
<a name="9557"/> 9557:          %% Terminations
<a name="9558"/> 9558:          #{desc =&gt; &quot;order server to terminate&quot;,
<a name="9559"/> 9559:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="9560"/> 9560:                            ?SEV_ANNOUNCE_TERMINATE(Pid),
<a name="9561"/> 9561:                            ok
<a name="9562"/> 9562:                    end},
<a name="9563"/> 9563:          #{desc =&gt; &quot;await server termination&quot;,
<a name="9564"/> 9564:            cmd  =&gt; fun(#{server := Pid} = State) -&gt;
<a name="9565"/> 9565:                            case ?SEV_AWAIT_TERMINATION(Pid) of
<a name="9566"/> 9566:                                ok -&gt;
<a name="9567"/> 9567:                                    State1 = maps:remove(server, State),
<a name="9568"/> 9568:                                    {ok, State1};
<a name="9569"/> 9569:                                {error, _} = ERROR -&gt;
<a name="9570"/> 9570:                                    ERROR
<a name="9571"/> 9571:                            end
<a name="9572"/> 9572:                    end},
<a name="9573"/> 9573: 
<a name="9574"/> 9574: 
<a name="9575"/> 9575:          %% *** We are done ***
<a name="9576"/> 9576:          ?SEV_FINISH_NORMAL
<a name="9577"/> 9577:         ],
<a name="9578"/> 9578: 
<a name="9579"/> 9579:     i(&quot;start server evaluator&quot;),
<a name="9580"/> 9580:     ServerInitState = InitState,
<a name="9581"/> 9581:     Server = ?SEV_START(&quot;server&quot;, ServerSeq, ServerInitState),
<a name="9582"/> 9582: 
<a name="9583"/> 9583:     i(&quot;start 'tester' evaluator&quot;),
<a name="9584"/> 9584:     TesterInitState = #{server =&gt; Server#ev.pid},
<a name="9585"/> 9585:     Tester = ?SEV_START(&quot;tester&quot;, TesterSeq, TesterInitState),
<a name="9586"/> 9586: 
<a name="9587"/> 9587:     i(&quot;await evaluator&quot;),
<a name="api_a_recv_cancel_udp-last_expr"/><a name="9588"/> 9588: <b>    ok = ?SEV_AWAIT_FINISH</b>([Server, Tester]).
<a name="9589"/> 9589: 
<a name="9590"/> 9590: 
<a name="9591"/> 9591: 
<a name="9592"/> 9592: 
<a name="9593"/> 9593: 
<a name="9594"/> 9594: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="9595"/> 9595: 
<a name="9596"/> 9596: <i>%% Basically we make an async (Timeout = nowait) call to accept,</i>
<a name="9597"/> 9597: <i>%% wait some time and then cancel. IPv4</i>
<a name="9598"/> 9598: <i>%%</i>
<a name="api_a_accept_cancel_tcp4-1"/><a name="9599"/> 9599: <b>api_a_accept_cancel_tcp4</b>(Config) when is_list(Config) -&gt;
<a name="9600"/> 9600:     ?TT(?SECS(10)),
<a name="9601"/> 9601:     Nowait = nowait(Config),
<a name="api_a_accept_cancel_tcp4-last_expr"/><a name="9602"/> 9602: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="9603"/> 9603:            fun() -&gt; has_support_ipv4() end,
<a name="9604"/> 9604:            fun() -&gt;
<a name="9605"/> 9605:                    Accept = fun(Sock) -&gt;
<a name="9606"/> 9606:                                     case socket:accept(Sock, Nowait) of
<a name="9607"/> 9607:                                         {ok, _} = OK -&gt;
<a name="9608"/> 9608:                                             OK;
<a name="9609"/> 9609:                                         {select, _} = SELECT -&gt;
<a name="9610"/> 9610:                                             SELECT;
<a name="9611"/> 9611:                                         {completion, _} = COMPLETION -&gt;
<a name="9612"/> 9612:                                             COMPLETION;
<a name="9613"/> 9613:                                         {error, _} = ERROR -&gt;
<a name="9614"/> 9614:                                             ERROR
<a name="9615"/> 9615:                                     end
<a name="9616"/> 9616:                             end,
<a name="9617"/> 9617:                    InitState = #{domain     =&gt; inet,
<a name="9618"/> 9618:                                  accept     =&gt; Accept,
<a name="9619"/> 9619:                                  accept_ref =&gt; Nowait},
<a name="9620"/> 9620:                    ok = api_a_accept_cancel_tcp(InitState)
<a name="9621"/> 9621:            end).
<a name="9622"/> 9622: 
<a name="9623"/> 9623: 
<a name="9624"/> 9624: 
<a name="9625"/> 9625: 
<a name="9626"/> 9626: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="9627"/> 9627: 
<a name="9628"/> 9628: <i>%% Basically we make an async (Timeout = nowait) call to accept,</i>
<a name="9629"/> 9629: <i>%% wait some time and then cancel. IPv6</i>
<a name="9630"/> 9630: <i>%%</i>
<a name="api_a_accept_cancel_tcp6-1"/><a name="9631"/> 9631: <b>api_a_accept_cancel_tcp6</b>(Config) when is_list(Config) -&gt;
<a name="9632"/> 9632:     ?TT(?SECS(10)),
<a name="9633"/> 9633:     Nowait = nowait(Config),
<a name="api_a_accept_cancel_tcp6-last_expr"/><a name="9634"/> 9634: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="9635"/> 9635:            fun() -&gt; has_support_ipv6() end,
<a name="9636"/> 9636:            fun() -&gt;
<a name="9637"/> 9637:                    Accept = fun(Sock) -&gt;
<a name="9638"/> 9638:                                     case socket:accept(Sock, Nowait) of
<a name="9639"/> 9639:                                         {ok, _} = OK -&gt;
<a name="9640"/> 9640:                                             OK;
<a name="9641"/> 9641:                                         {select, _} = SELECT -&gt;
<a name="9642"/> 9642:                                             SELECT;
<a name="9643"/> 9643:                                         {completion, _} = COMPLETION -&gt;
<a name="9644"/> 9644:                                             COMPLETION;
<a name="9645"/> 9645:                                         {error, _} = ERROR -&gt;
<a name="9646"/> 9646:                                             ERROR
<a name="9647"/> 9647:                                     end
<a name="9648"/> 9648:                             end,
<a name="9649"/> 9649:                    InitState = #{domain     =&gt; inet6,
<a name="9650"/> 9650:                                  accept     =&gt; Accept,
<a name="9651"/> 9651:                                  accept_ref =&gt; Nowait},
<a name="9652"/> 9652:                    ok = api_a_accept_cancel_tcp(InitState)
<a name="9653"/> 9653:            end).
<a name="9654"/> 9654: 
<a name="9655"/> 9655: 
<a name="9656"/> 9656: 
<a name="9657"/> 9657: 
<a name="9658"/> 9658: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="9659"/> 9659: 
<a name="api_a_accept_cancel_tcp-1"/><a name="9660"/> 9660: <b>api_a_accept_cancel_tcp</b>(InitState) -&gt;
<a name="9661"/> 9661:     process_flag(trap_exit, true),
<a name="9662"/> 9662:     ServerSeq = 
<a name="9663"/> 9663:         [
<a name="9664"/> 9664:          %% *** Wait for start order ***
<a name="9665"/> 9665:          #{desc =&gt; &quot;await start (from tester)&quot;,
<a name="9666"/> 9666:            cmd  =&gt; fun(State) -&gt;
<a name="9667"/> 9667:                            Tester = ?SEV_AWAIT_START(),
<a name="9668"/> 9668:                            {ok, State#{tester =&gt; Tester}}
<a name="9669"/> 9669:                    end},
<a name="9670"/> 9670:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="9671"/> 9671:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="9672"/> 9672:                            _MRef = erlang:monitor(process, Tester),
<a name="9673"/> 9673:                            ok
<a name="9674"/> 9674:                    end},
<a name="9675"/> 9675: 
<a name="9676"/> 9676:          %% *** Init part ***
<a name="9677"/> 9677:          #{desc =&gt; &quot;which local address&quot;,
<a name="9678"/> 9678:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="9679"/> 9679:                            LSA = which_local_socket_addr(Domain),
<a name="9680"/> 9680:                            {ok, State#{lsa =&gt; LSA}}
<a name="9681"/> 9681:                    end},
<a name="9682"/> 9682:          #{desc =&gt; &quot;create listen socket&quot;,
<a name="9683"/> 9683:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="9684"/> 9684:                            case socket:open(Domain, stream, tcp) of
<a name="9685"/> 9685:                                {ok, Sock} -&gt;
<a name="9686"/> 9686:                                    {ok, State#{lsock =&gt; Sock}};
<a name="9687"/> 9687:                                {error, _} = ERROR -&gt;
<a name="9688"/> 9688:                                    ERROR
<a name="9689"/> 9689:                            end
<a name="9690"/> 9690:                    end},
<a name="9691"/> 9691:          #{desc =&gt; &quot;bind to local address&quot;,
<a name="9692"/> 9692:            cmd  =&gt; fun(#{lsock := LSock, lsa := LSA} = State) -&gt;
<a name="9693"/> 9693:                            case sock_bind(LSock, LSA) of
<a name="9694"/> 9694:                                ok -&gt;
<a name="9695"/> 9695:                                    Port = sock_port(LSock),
<a name="9696"/> 9696:                                    {ok, State#{lport =&gt; Port}};
<a name="9697"/> 9697:                                {error, _} = ERROR -&gt;
<a name="9698"/> 9698:                                    ERROR
<a name="9699"/> 9699:                            end
<a name="9700"/> 9700:                    end},
<a name="9701"/> 9701:          #{desc =&gt; &quot;make listen socket&quot;,
<a name="9702"/> 9702:            cmd  =&gt; fun(#{lsock := LSock}) -&gt;
<a name="9703"/> 9703:                            socket:listen(LSock)
<a name="9704"/> 9704:                    end},
<a name="9705"/> 9705:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="9706"/> 9706:            cmd  =&gt; fun(#{tester := Tester, lport := Port}) -&gt;
<a name="9707"/> 9707:                            ?SEV_ANNOUNCE_READY(Tester, init, Port),
<a name="9708"/> 9708:                            ok
<a name="9709"/> 9709:                    end},
<a name="9710"/> 9710: 
<a name="9711"/> 9711:          %% The actual test
<a name="9712"/> 9712:          #{desc =&gt; &quot;await continue (accept)&quot;,
<a name="9713"/> 9713:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="9714"/> 9714:                            ?SEV_AWAIT_CONTINUE(Tester, tester, accept)
<a name="9715"/> 9715:                    end},
<a name="9716"/> 9716:          #{desc =&gt; &quot;await connection (nowait)&quot;,
<a name="9717"/> 9717:            cmd  =&gt; fun(#{lsock      := LSock,
<a name="9718"/> 9718:                          accept     := Accept,
<a name="9719"/> 9719:                          accept_ref := Ref} = State) -&gt;
<a name="9720"/> 9720:                            case Accept(LSock) of
<a name="9721"/> 9721:                                {select, {select_info, T, R} = SI}
<a name="9722"/> 9722:                                  when Ref =:= nowait -&gt;
<a name="9723"/> 9723:                                    ?SEV_IPRINT(&quot;accept select nowait: &quot;
<a name="9724"/> 9724:                                                &quot;~n   T: ~p&quot;
<a name="9725"/> 9725:                                                &quot;~n   R: ~p&quot;, [T, R]),
<a name="9726"/> 9726:                                    {ok, State#{accept_select_info =&gt; SI}};
<a name="9727"/> 9727:                                {select, {select_info, T, Ref} = SI}
<a name="9728"/> 9728:                                  when is_reference(Ref) -&gt;
<a name="9729"/> 9729:                                    ?SEV_IPRINT(&quot;accept select ref: &quot;
<a name="9730"/> 9730:                                                &quot;~n   T: ~p&quot;
<a name="9731"/> 9731:                                                &quot;~n   R: ~p&quot;, [T, Ref]),
<a name="9732"/> 9732:                                    {ok, State#{accept_select_info =&gt; SI}};
<a name="9733"/> 9733: 
<a name="9734"/> 9734:                                {completion, {completion_info, T, R} = CI}
<a name="9735"/> 9735:                                  when Ref =:= nowait -&gt;
<a name="9736"/> 9736:                                    ?SEV_IPRINT(&quot;accept completion nowait: &quot;
<a name="9737"/> 9737:                                                &quot;~n   T: ~p&quot;
<a name="9738"/> 9738:                                                &quot;~n   R: ~p&quot;, [T, R]),
<a name="9739"/> 9739:                                    {ok, State#{accept_completion_info =&gt; CI}};
<a name="9740"/> 9740:                                {completion, {completion_info, T, Ref} = CI}
<a name="9741"/> 9741:                                  when is_reference(Ref) -&gt;
<a name="9742"/> 9742:                                    ?SEV_IPRINT(&quot;accept completion ref: &quot;
<a name="9743"/> 9743:                                                &quot;~n   T: ~p&quot;
<a name="9744"/> 9744:                                                &quot;~n   R: ~p&quot;, [T, Ref]),
<a name="9745"/> 9745:                                    {ok, State#{accept_completion_info =&gt; CI}};
<a name="9746"/> 9746: 
<a name="9747"/> 9747:                                {ok, X} -&gt;
<a name="9748"/> 9748:                                    {error, {unexpected_success, X}};
<a name="9749"/> 9749: 
<a name="9750"/> 9750:                                {error, _} = ERROR -&gt;
<a name="9751"/> 9751:                                    ERROR
<a name="9752"/> 9752:                            end
<a name="9753"/> 9753:                    end},
<a name="9754"/> 9754:          #{desc =&gt; &quot;announce ready (accept_select)&quot;,
<a name="9755"/> 9755:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="9756"/> 9756:                            ?SEV_ANNOUNCE_READY(Tester, accept_select),
<a name="9757"/> 9757:                            ok
<a name="9758"/> 9758:                    end},
<a name="9759"/> 9759:          #{desc =&gt; &quot;await select message (without success)&quot;,
<a name="9760"/> 9760:            cmd  =&gt; fun(#{lsock := Sock}) -&gt;
<a name="9761"/> 9761:                            receive
<a name="9762"/> 9762:                                {'$socket', Sock, select, Ref} -&gt;
<a name="9763"/> 9763:                                    {error, {unexpected_select, Ref}};
<a name="9764"/> 9764: 
<a name="9765"/> 9765:                                {'$socket', Sock, completion, C} -&gt;
<a name="9766"/> 9766:                                    {error, {unexpected_completion, C}}
<a name="9767"/> 9767: 
<a name="9768"/> 9768:                            after 5000 -&gt;
<a name="9769"/> 9769:                                    ok
<a name="9770"/> 9770:                            end
<a name="9771"/> 9771:                    end},
<a name="9772"/> 9772:          #{desc =&gt; &quot;announce ready (no select)&quot;,
<a name="9773"/> 9773:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="9774"/> 9774:                            ?SEV_ANNOUNCE_READY(Tester, no_select),
<a name="9775"/> 9775:                            ok
<a name="9776"/> 9776:                    end},
<a name="9777"/> 9777:          #{desc =&gt; &quot;await continue (cancel)&quot;,
<a name="9778"/> 9778:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="9779"/> 9779:                            ?SEV_AWAIT_CONTINUE(Tester, tester, cancel)
<a name="9780"/> 9780:                    end},
<a name="9781"/> 9781:          #{desc =&gt; &quot;cancel&quot;,
<a name="9782"/> 9782:            cmd  =&gt; fun(#{lsock              := Sock,
<a name="9783"/> 9783:                          accept_select_info := SelectInfo}) -&gt;
<a name="9784"/> 9784:                            ok = socket:cancel(Sock, SelectInfo);
<a name="9785"/> 9785:                       (#{lsock                  := Sock,
<a name="9786"/> 9786:                          accept_completion_info := CompletionInfo}) -&gt;
<a name="9787"/> 9787:                            ok = socket:cancel(Sock, CompletionInfo)
<a name="9788"/> 9788:                    end},
<a name="9789"/> 9789:          #{desc =&gt; &quot;announce ready (cancel)&quot;,
<a name="9790"/> 9790:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="9791"/> 9791:                            ?SEV_ANNOUNCE_READY(Tester, cancel),
<a name="9792"/> 9792:                            ok
<a name="9793"/> 9793:                    end},
<a name="9794"/> 9794: 
<a name="9795"/> 9795:          %% *** Termination ***
<a name="9796"/> 9796:          #{desc =&gt; &quot;await terminate&quot;,
<a name="9797"/> 9797:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="9798"/> 9798:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="9799"/> 9799:                                ok -&gt;
<a name="9800"/> 9800:                                    {ok, maps:remove(tester, State)};
<a name="9801"/> 9801:                                {error, _} = ERROR -&gt;
<a name="9802"/> 9802:                                    ERROR
<a name="9803"/> 9803:                            end
<a name="9804"/> 9804:                    end},
<a name="9805"/> 9805:          #{desc =&gt; &quot;close listen socket&quot;,
<a name="9806"/> 9806:            cmd  =&gt; fun(#{lsock := Sock}) -&gt;
<a name="9807"/> 9807:                            socket:close(Sock)
<a name="9808"/> 9808:                    end},
<a name="9809"/> 9809: 
<a name="9810"/> 9810:          %% *** We are done ***
<a name="9811"/> 9811:          ?SEV_FINISH_NORMAL
<a name="9812"/> 9812:         ],
<a name="9813"/> 9813: 
<a name="9814"/> 9814: 
<a name="9815"/> 9815:     TesterSeq =
<a name="9816"/> 9816:         [
<a name="9817"/> 9817:          %% *** Init part ***
<a name="9818"/> 9818:          #{desc =&gt; &quot;monitor server&quot;,
<a name="9819"/> 9819:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="9820"/> 9820:                            _MRef = erlang:monitor(process, Pid),
<a name="9821"/> 9821:                            ok
<a name="9822"/> 9822:                    end},
<a name="9823"/> 9823: 
<a name="9824"/> 9824:          %% Start the server
<a name="9825"/> 9825:          #{desc =&gt; &quot;order server start&quot;,
<a name="9826"/> 9826:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="9827"/> 9827:                            ?SEV_ANNOUNCE_START(Pid),
<a name="9828"/> 9828:                            ok
<a name="9829"/> 9829:                    end},
<a name="9830"/> 9830:          #{desc =&gt; &quot;await server ready (init)&quot;,
<a name="9831"/> 9831:            cmd  =&gt; fun(#{server := Pid} = State) -&gt;
<a name="9832"/> 9832:                            {ok, Port} = ?SEV_AWAIT_READY(Pid, server, init),
<a name="9833"/> 9833:                            {ok, State#{server_port =&gt; Port}}
<a name="9834"/> 9834:                    end},
<a name="9835"/> 9835: 
<a name="9836"/> 9836:          %% *** The actual test ***
<a name="9837"/> 9837:          #{desc =&gt; &quot;order server to continue (with accept)&quot;,
<a name="9838"/> 9838:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="9839"/> 9839:                            ?SEV_ANNOUNCE_CONTINUE(Server, accept),
<a name="9840"/> 9840:                            ok
<a name="9841"/> 9841:                    end},
<a name="9842"/> 9842:          #{desc =&gt; &quot;await server ready (accept select)&quot;,
<a name="9843"/> 9843:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="9844"/> 9844:                            ?SEV_AWAIT_READY(Pid, server, accept_select)
<a name="9845"/> 9845:                    end},
<a name="9846"/> 9846:          #{desc =&gt; &quot;await server ready (no select)&quot;,
<a name="9847"/> 9847:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="9848"/> 9848:                            ?SEV_AWAIT_READY(Pid, server, no_select)
<a name="9849"/> 9849:                    end},
<a name="9850"/> 9850:          #{desc =&gt; &quot;order server to continue (cancel)&quot;,
<a name="9851"/> 9851:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="9852"/> 9852:                            ?SEV_ANNOUNCE_CONTINUE(Pid, cancel),
<a name="9853"/> 9853:                            ok
<a name="9854"/> 9854:                    end},
<a name="9855"/> 9855:          #{desc =&gt; &quot;await server ready (cancel)&quot;,
<a name="9856"/> 9856:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="9857"/> 9857:                            ?SEV_AWAIT_READY(Pid, server, cancel)
<a name="9858"/> 9858:                    end},
<a name="9859"/> 9859: 
<a name="9860"/> 9860:          %% *** Termination ***
<a name="9861"/> 9861:          #{desc =&gt; &quot;order server to terminate&quot;,
<a name="9862"/> 9862:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="9863"/> 9863:                            ?SEV_ANNOUNCE_TERMINATE(Server),
<a name="9864"/> 9864:                            ok
<a name="9865"/> 9865:                    end},
<a name="9866"/> 9866:          #{desc =&gt; &quot;await server termination&quot;,
<a name="9867"/> 9867:            cmd  =&gt; fun(#{server := Server} = State) -&gt;
<a name="9868"/> 9868:                            ?SEV_AWAIT_TERMINATION(Server),
<a name="9869"/> 9869:                            State1 = maps:remove(server, State),
<a name="9870"/> 9870:                            {ok, State1}
<a name="9871"/> 9871:                    end},
<a name="9872"/> 9872: 
<a name="9873"/> 9873:          %% *** We are done ***
<a name="9874"/> 9874:          ?SEV_FINISH_NORMAL
<a name="9875"/> 9875:         ],
<a name="9876"/> 9876: 
<a name="9877"/> 9877:     i(&quot;start server evaluator&quot;),
<a name="9878"/> 9878:     Server = ?SEV_START(&quot;server&quot;, ServerSeq, InitState),
<a name="9879"/> 9879: 
<a name="9880"/> 9880:     i(&quot;start tester evaluator&quot;),
<a name="9881"/> 9881:     TesterInitState = #{server =&gt; Server#ev.pid},
<a name="9882"/> 9882:     Tester = ?SEV_START(&quot;tester&quot;, TesterSeq, TesterInitState),
<a name="9883"/> 9883: 
<a name="9884"/> 9884:     i(&quot;await evaluator(s)&quot;),
<a name="api_a_accept_cancel_tcp-last_expr"/><a name="9885"/> 9885: <b>    ok = ?SEV_AWAIT_FINISH</b>([Server, Tester]).
<a name="9886"/> 9886: 
<a name="9887"/> 9887: 
<a name="9888"/> 9888: 
<a name="9889"/> 9889: 
<a name="9890"/> 9890: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="9891"/> 9891: 
<a name="9892"/> 9892: <i>%% Basically we make an async (Timeout = nowait) call to recv,</i>
<a name="9893"/> 9893: <i>%% wait some time and then cancel. IPv4</i>
<a name="9894"/> 9894: <i>%%</i>
<a name="api_a_recv_cancel_tcp4-1"/><a name="9895"/> 9895: <b>api_a_recv_cancel_tcp4</b>(Config) when is_list(Config) -&gt;
<a name="9896"/> 9896:     ?TT(?SECS(10)),
<a name="9897"/> 9897:     Nowait = nowait(Config),
<a name="api_a_recv_cancel_tcp4-last_expr"/><a name="9898"/> 9898: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="9899"/> 9899:            fun() -&gt; has_support_ipv4() end,
<a name="9900"/> 9900:            fun() -&gt;
<a name="9901"/> 9901:                    Recv = fun(Sock) -&gt;
<a name="9902"/> 9902:                                   socket:recv(Sock, 0, Nowait)
<a name="9903"/> 9903:                           end,
<a name="9904"/> 9904:                    InitState = #{domain   =&gt; inet,
<a name="9905"/> 9905:                                  recv     =&gt; Recv,
<a name="9906"/> 9906:                                  recv_ref =&gt; Nowait},
<a name="9907"/> 9907:                    ok = api_a_recv_cancel_tcp(InitState)
<a name="9908"/> 9908:            end).
<a name="9909"/> 9909: 
<a name="9910"/> 9910: 
<a name="9911"/> 9911: 
<a name="9912"/> 9912: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="9913"/> 9913: 
<a name="9914"/> 9914: <i>%% Basically we make an async (Timeout = nowait) call to recv,</i>
<a name="9915"/> 9915: <i>%% wait some time and then cancel. IPv6</i>
<a name="9916"/> 9916: <i>%%</i>
<a name="api_a_recv_cancel_tcp6-1"/><a name="9917"/> 9917: <b>api_a_recv_cancel_tcp6</b>(Config) when is_list(Config) -&gt;
<a name="9918"/> 9918:     ?TT(?SECS(10)),
<a name="9919"/> 9919:     Nowait = nowait(Config),
<a name="api_a_recv_cancel_tcp6-last_expr"/><a name="9920"/> 9920: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="9921"/> 9921:            fun() -&gt; has_support_ipv6() end,
<a name="9922"/> 9922:            fun() -&gt;
<a name="9923"/> 9923:                    Recv = fun(Sock) -&gt;
<a name="9924"/> 9924:                                   socket:recv(Sock, 0, Nowait)
<a name="9925"/> 9925:                           end,
<a name="9926"/> 9926:                    InitState = #{domain   =&gt; inet6,
<a name="9927"/> 9927:                                  recv     =&gt; Recv,
<a name="9928"/> 9928:                                  recv_ref =&gt; Nowait},
<a name="9929"/> 9929:                    ok = api_a_recv_cancel_tcp(InitState)
<a name="9930"/> 9930:            end).
<a name="9931"/> 9931: 
<a name="9932"/> 9932: 
<a name="9933"/> 9933: 
<a name="9934"/> 9934: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="9935"/> 9935: 
<a name="9936"/> 9936: <i>%% Basically we make an async (Timeout = nowait) call to recvmsg,</i>
<a name="9937"/> 9937: <i>%% wait some time and then cancel. IPv4</i>
<a name="9938"/> 9938: <i>%%</i>
<a name="api_a_recvmsg_cancel_tcp4-1"/><a name="9939"/> 9939: <b>api_a_recvmsg_cancel_tcp4</b>(Config) when is_list(Config) -&gt;
<a name="9940"/> 9940:     ?TT(?SECS(10)),
<a name="9941"/> 9941:     Nowait = nowait(Config),
<a name="api_a_recvmsg_cancel_tcp4-last_expr"/><a name="9942"/> 9942: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="9943"/> 9943:            fun() -&gt;
<a name="9944"/> 9944:                    is_not_windows(),
<a name="9945"/> 9945:                    has_support_ipv4()
<a name="9946"/> 9946:            end,
<a name="9947"/> 9947:            fun() -&gt;
<a name="9948"/> 9948:                    Recv = fun(Sock) -&gt;
<a name="9949"/> 9949:                                   socket:recvmsg(Sock, Nowait)
<a name="9950"/> 9950:                           end,
<a name="9951"/> 9951:                    InitState = #{domain   =&gt; inet,
<a name="9952"/> 9952:                                  recv     =&gt; Recv,
<a name="9953"/> 9953:                                  recv_ref =&gt; Nowait},
<a name="9954"/> 9954:                    ok = api_a_recv_cancel_tcp(InitState)
<a name="9955"/> 9955:            end).
<a name="9956"/> 9956: 
<a name="9957"/> 9957: 
<a name="9958"/> 9958: 
<a name="9959"/> 9959: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="9960"/> 9960: 
<a name="9961"/> 9961: <i>%% Basically we make an async (Timeout = nowait) call to recvmsg,</i>
<a name="9962"/> 9962: <i>%% wait some time and then cancel. IPv6</i>
<a name="9963"/> 9963: <i>%%</i>
<a name="api_a_recvmsg_cancel_tcp6-1"/><a name="9964"/> 9964: <b>api_a_recvmsg_cancel_tcp6</b>(Config) when is_list(Config) -&gt;
<a name="9965"/> 9965:     ?TT(?SECS(10)),
<a name="9966"/> 9966:     Nowait = nowait(Config),
<a name="api_a_recvmsg_cancel_tcp6-last_expr"/><a name="9967"/> 9967: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="9968"/> 9968:            fun() -&gt;
<a name="9969"/> 9969:                    is_not_windows(),
<a name="9970"/> 9970:                    has_support_ipv6()
<a name="9971"/> 9971:            end,
<a name="9972"/> 9972:            fun() -&gt;
<a name="9973"/> 9973:                    Recv = fun(Sock) -&gt;
<a name="9974"/> 9974:                                   socket:recvmsg(Sock, Nowait)
<a name="9975"/> 9975:                           end,
<a name="9976"/> 9976:                    InitState = #{domain   =&gt; inet6,
<a name="9977"/> 9977:                                  recv     =&gt; Recv,
<a name="9978"/> 9978:                                  recv_ref =&gt; Nowait},
<a name="9979"/> 9979:                    ok = api_a_recv_cancel_tcp(InitState)
<a name="9980"/> 9980:            end).
<a name="9981"/> 9981: 
<a name="9982"/> 9982: 
<a name="9983"/> 9983: 
<a name="9984"/> 9984: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="9985"/> 9985: 
<a name="api_a_recv_cancel_tcp-1"/><a name="9986"/> 9986: <b>api_a_recv_cancel_tcp</b>(InitState) -&gt;
<a name="9987"/> 9987:     process_flag(trap_exit, true),
<a name="9988"/> 9988:     ServerSeq = 
<a name="9989"/> 9989:         [
<a name="9990"/> 9990:          %% *** Wait for start order ***
<a name="9991"/> 9991:          #{desc =&gt; &quot;await start (from tester)&quot;,
<a name="9992"/> 9992:            cmd  =&gt; fun(State) -&gt;
<a name="9993"/> 9993:                            Tester = ?SEV_AWAIT_START(),
<a name="9994"/> 9994:                            {ok, State#{tester =&gt; Tester}}
<a name="9995"/> 9995:                    end},
<a name="9996"/> 9996:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="9997"/> 9997:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="9998"/> 9998:                            _MRef = erlang:monitor(process, Tester),
<a name="9999"/> 9999:                            ok
<a name="10000"/>10000:                    end},
<a name="10001"/>10001: 
<a name="10002"/>10002:          %% *** Init part ***
<a name="10003"/>10003:          #{desc =&gt; &quot;which local address&quot;,
<a name="10004"/>10004:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="10005"/>10005:                            LSA = which_local_socket_addr(Domain),
<a name="10006"/>10006:                            {ok, State#{lsa =&gt; LSA}}
<a name="10007"/>10007:                    end},
<a name="10008"/>10008:          #{desc =&gt; &quot;create listen socket&quot;,
<a name="10009"/>10009:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="10010"/>10010:                            case socket:open(Domain, stream, tcp) of
<a name="10011"/>10011:                                {ok, Sock} -&gt;
<a name="10012"/>10012:                                    {ok, State#{lsock =&gt; Sock}};
<a name="10013"/>10013:                                {error, _} = ERROR -&gt;
<a name="10014"/>10014:                                    ERROR
<a name="10015"/>10015:                            end
<a name="10016"/>10016:                    end},
<a name="10017"/>10017:          #{desc =&gt; &quot;bind to local address&quot;,
<a name="10018"/>10018:            cmd  =&gt; fun(#{lsock := LSock, lsa := LSA} = State) -&gt;
<a name="10019"/>10019:                            case sock_bind(LSock, LSA) of
<a name="10020"/>10020:                                ok -&gt;
<a name="10021"/>10021:                                    Port = sock_port(LSock),
<a name="10022"/>10022:                                    {ok, State#{lport =&gt; Port}};
<a name="10023"/>10023:                                {error, _} = ERROR -&gt;
<a name="10024"/>10024:                                    ERROR
<a name="10025"/>10025:                            end
<a name="10026"/>10026:                    end},
<a name="10027"/>10027:          #{desc =&gt; &quot;make listen socket&quot;,
<a name="10028"/>10028:            cmd  =&gt; fun(#{lsock := LSock}) -&gt;
<a name="10029"/>10029:                            socket:listen(LSock)
<a name="10030"/>10030:                    end},
<a name="10031"/>10031:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="10032"/>10032:            cmd  =&gt; fun(#{tester := Tester, lport := Port}) -&gt;
<a name="10033"/>10033:                            ?SEV_ANNOUNCE_READY(Tester, init, Port),
<a name="10034"/>10034:                            ok
<a name="10035"/>10035:                    end},
<a name="10036"/>10036: 
<a name="10037"/>10037:          %% The actual test
<a name="10038"/>10038:          #{desc =&gt; &quot;await continue (accept)&quot;,
<a name="10039"/>10039:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="10040"/>10040:                            ?SEV_AWAIT_CONTINUE(Tester, tester, accept)
<a name="10041"/>10041:                    end},
<a name="10042"/>10042:          #{desc =&gt; &quot;await connection&quot;,
<a name="10043"/>10043:            cmd  =&gt; fun(#{lsock := LSock} = State) -&gt;
<a name="10044"/>10044:                            case socket:accept(LSock) of
<a name="10045"/>10045:                                {ok, CSock} -&gt;
<a name="10046"/>10046:                                    {ok, State#{csock =&gt; CSock}};
<a name="10047"/>10047:                                {error, _} = ERROR -&gt;
<a name="10048"/>10048:                                    ERROR
<a name="10049"/>10049:                            end
<a name="10050"/>10050:                    end},
<a name="10051"/>10051:          #{desc =&gt; &quot;announce ready (accept)&quot;,
<a name="10052"/>10052:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="10053"/>10053:                            ?SEV_ANNOUNCE_READY(Tester, accept),
<a name="10054"/>10054:                            ok
<a name="10055"/>10055:                    end},
<a name="10056"/>10056: 
<a name="10057"/>10057:          #{desc =&gt; &quot;await continue (nowait recv)&quot;,
<a name="10058"/>10058:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="10059"/>10059:                            ?SEV_AWAIT_CONTINUE(Tester, tester, recv)
<a name="10060"/>10060:                    end},
<a name="10061"/>10061: 
<a name="10062"/>10062:          #{desc =&gt; &quot;try recv request (with nowait, expect select|completion)&quot;,
<a name="10063"/>10063:            cmd  =&gt; fun(#{csock    := Sock,
<a name="10064"/>10064:                          recv     := Recv,
<a name="10065"/>10065:                          recv_ref := Ref} = State) -&gt;
<a name="10066"/>10066:                            case Recv(Sock) of
<a name="10067"/>10067:                                {select, {select_info, T, R} = SI}
<a name="10068"/>10068:                                  when Ref =:= nowait -&gt;
<a name="10069"/>10069:                                    ?SEV_IPRINT(&quot;recv select nowait: &quot;
<a name="10070"/>10070:                                                &quot;~n   Tag: ~p&quot;
<a name="10071"/>10071:                                                &quot;~n   Ref: ~p&quot;, [T, R]),
<a name="10072"/>10072:                                    {ok, State#{recv_select_info =&gt; SI}};
<a name="10073"/>10073:                                {select, {select_info, T, Ref} = SI}
<a name="10074"/>10074:                                  when is_reference(Ref) -&gt;
<a name="10075"/>10075:                                    ?SEV_IPRINT(&quot;recv select ref: &quot;
<a name="10076"/>10076:                                                &quot;~n   Tag: ~p&quot;
<a name="10077"/>10077:                                                &quot;~n   Ref: ~p&quot;, [T, Ref]),
<a name="10078"/>10078:                                    {ok, State#{recv_select_info =&gt; SI}};
<a name="10079"/>10079: 
<a name="10080"/>10080:                                {completion,
<a name="10081"/>10081:                                 {completion_info, T, R} = CI}
<a name="10082"/>10082:                                  when Ref =:= nowait -&gt;
<a name="10083"/>10083:                                    ?SEV_IPRINT(&quot;recv completion nowait: &quot;
<a name="10084"/>10084:                                                &quot;~n   Tag: ~p&quot;
<a name="10085"/>10085:                                                &quot;~n   Ref: ~p&quot;, [T, R]),
<a name="10086"/>10086:                                    {ok, State#{recv_completion_info =&gt; CI}};
<a name="10087"/>10087:                                {completion,
<a name="10088"/>10088:                                 {completion_info, T, Ref} = CI}
<a name="10089"/>10089:                                  when is_reference(Ref) -&gt;
<a name="10090"/>10090:                                    ?SEV_IPRINT(&quot;recv completion ref: &quot;
<a name="10091"/>10091:                                                &quot;~n   Tag: ~p&quot;
<a name="10092"/>10092:                                                &quot;~n   Ref: ~p&quot;, [T, Ref]),
<a name="10093"/>10093:                                    {ok, State#{recv_completion_info =&gt; CI}};
<a name="10094"/>10094: 
<a name="10095"/>10095:                                {ok, X} -&gt;
<a name="10096"/>10096:                                    {error, {unexpected_success, X}};
<a name="10097"/>10097: 
<a name="10098"/>10098:                                {error, _} = ERROR -&gt;
<a name="10099"/>10099:                                    ERROR
<a name="10100"/>10100:                            end
<a name="10101"/>10101:                    end},
<a name="10102"/>10102:          #{desc =&gt; &quot;announce ready (recv_select)&quot;,
<a name="10103"/>10103:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="10104"/>10104:                            ?SEV_ANNOUNCE_READY(Tester, recv_select),
<a name="10105"/>10105:                            ok
<a name="10106"/>10106:                    end},
<a name="10107"/>10107:          #{desc =&gt; &quot;await select message&quot;,
<a name="10108"/>10108:            cmd  =&gt; fun(#{csock := Sock}) -&gt;
<a name="10109"/>10109:                            receive
<a name="10110"/>10110:                                {'$socket', Sock, select, Ref} -&gt;
<a name="10111"/>10111:                                    {error, {unexpected_select, Ref}};
<a name="10112"/>10112: 
<a name="10113"/>10113:                                {'$socket', Sock, completion, C} -&gt;
<a name="10114"/>10114:                                    {error, {unexpected_completion, C}}
<a name="10115"/>10115: 
<a name="10116"/>10116:                            after 5000 -&gt;
<a name="10117"/>10117:                                    ok
<a name="10118"/>10118:                            end
<a name="10119"/>10119:                    end},
<a name="10120"/>10120:          #{desc =&gt; &quot;announce ready (no select)&quot;,
<a name="10121"/>10121:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="10122"/>10122:                            ?SEV_ANNOUNCE_READY(Tester, no_select),
<a name="10123"/>10123:                            ok
<a name="10124"/>10124:                    end},
<a name="10125"/>10125:          #{desc =&gt; &quot;await continue (cancel)&quot;,
<a name="10126"/>10126:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="10127"/>10127:                            ?SEV_AWAIT_CONTINUE(Tester, tester, cancel)
<a name="10128"/>10128:                    end},
<a name="10129"/>10129:          #{desc =&gt; &quot;cancel&quot;,
<a name="10130"/>10130:            cmd  =&gt; fun(#{csock := Sock, recv_select_info := SI}) -&gt;
<a name="10131"/>10131:                            ok = socket:cancel(Sock, SI);
<a name="10132"/>10132: 
<a name="10133"/>10133:                       (#{csock := Sock, recv_completion_info := CI}) -&gt;
<a name="10134"/>10134:                            ok = socket:cancel(Sock, CI)
<a name="10135"/>10135:                    end},
<a name="10136"/>10136:          #{desc =&gt; &quot;announce ready (cancel)&quot;,
<a name="10137"/>10137:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="10138"/>10138:                            ?SEV_ANNOUNCE_READY(Tester, cancel),
<a name="10139"/>10139:                            ok
<a name="10140"/>10140:                    end},
<a name="10141"/>10141: 
<a name="10142"/>10142:          %% *** Termination ***
<a name="10143"/>10143:          #{desc =&gt; &quot;await terminate&quot;,
<a name="10144"/>10144:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="10145"/>10145:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="10146"/>10146:                                ok -&gt;
<a name="10147"/>10147:                                    {ok, maps:remove(tester, State)};
<a name="10148"/>10148:                                {error, _} = ERROR -&gt;
<a name="10149"/>10149:                                    ERROR
<a name="10150"/>10150:                            end
<a name="10151"/>10151:                    end},
<a name="10152"/>10152:          #{desc =&gt; &quot;close connection socket&quot;,
<a name="10153"/>10153:            cmd  =&gt; fun(#{csock := Sock}) -&gt;
<a name="10154"/>10154:                            socket:close(Sock)
<a name="10155"/>10155:                    end},
<a name="10156"/>10156:          #{desc =&gt; &quot;close listen socket&quot;,
<a name="10157"/>10157:            cmd  =&gt; fun(#{lsock := Sock}) -&gt;
<a name="10158"/>10158:                            socket:close(Sock)
<a name="10159"/>10159:                    end},
<a name="10160"/>10160: 
<a name="10161"/>10161:          %% *** We are done ***
<a name="10162"/>10162:          ?SEV_FINISH_NORMAL
<a name="10163"/>10163:         ],
<a name="10164"/>10164: 
<a name="10165"/>10165: 
<a name="10166"/>10166:     ClientSeq = 
<a name="10167"/>10167:         [
<a name="10168"/>10168:          %% *** Wait for start order ***
<a name="10169"/>10169:          #{desc =&gt; &quot;await start (from tester)&quot;,
<a name="10170"/>10170:            cmd  =&gt; fun(State) -&gt;
<a name="10171"/>10171:                            {Tester, Port} = ?SEV_AWAIT_START(),
<a name="10172"/>10172:                            {ok, State#{tester =&gt; Tester, server_port =&gt; Port}}
<a name="10173"/>10173:                    end},
<a name="10174"/>10174:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="10175"/>10175:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="10176"/>10176:                            _MRef = erlang:monitor(process, Tester),
<a name="10177"/>10177:                            ok
<a name="10178"/>10178:                    end},
<a name="10179"/>10179: 
<a name="10180"/>10180:          %% *** The init part ***
<a name="10181"/>10181:          #{desc =&gt; &quot;which server (local) address&quot;,
<a name="10182"/>10182:            cmd  =&gt; fun(#{domain := Domain, server_port := Port} = State) -&gt;
<a name="10183"/>10183:                            LSA = which_local_socket_addr(Domain),
<a name="10184"/>10184:                            SSA = LSA#{port =&gt; Port},
<a name="10185"/>10185:                            {ok, State#{local_sa =&gt; LSA, server_sa =&gt; SSA}}
<a name="10186"/>10186:                    end},
<a name="10187"/>10187:          #{desc =&gt; &quot;create socket&quot;,
<a name="10188"/>10188:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="10189"/>10189:                            case socket:open(Domain, stream, tcp) of
<a name="10190"/>10190:                                {ok, Sock} -&gt;
<a name="10191"/>10191:                                    {ok, State#{sock =&gt; Sock}};
<a name="10192"/>10192:                                {error, _} = ERROR -&gt;
<a name="10193"/>10193:                                    ERROR
<a name="10194"/>10194:                            end
<a name="10195"/>10195:                    end},
<a name="10196"/>10196:          #{desc =&gt; &quot;bind to local address&quot;,
<a name="10197"/>10197:            cmd  =&gt; fun(#{sock := Sock, local_sa := LSA} = _State) -&gt;
<a name="10198"/>10198:                            case sock_bind(Sock, LSA) of
<a name="10199"/>10199:                                ok -&gt;
<a name="10200"/>10200:                                    ok;
<a name="10201"/>10201:                                {error, _} = ERROR -&gt;
<a name="10202"/>10202:                                    ERROR
<a name="10203"/>10203:                            end
<a name="10204"/>10204:                    end},
<a name="10205"/>10205:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="10206"/>10206:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="10207"/>10207:                            ?SEV_ANNOUNCE_READY(Tester, init),
<a name="10208"/>10208:                            ok
<a name="10209"/>10209:                    end},
<a name="10210"/>10210: 
<a name="10211"/>10211:          %% *** The actual test ***
<a name="10212"/>10212:          #{desc =&gt; &quot;await continue (connect)&quot;,
<a name="10213"/>10213:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="10214"/>10214:                            ?SEV_AWAIT_CONTINUE(Tester, tester, connect)
<a name="10215"/>10215:                    end},
<a name="10216"/>10216:          #{desc =&gt; &quot;connect to server&quot;,
<a name="10217"/>10217:            cmd  =&gt; fun(#{sock := Sock, server_sa := SSA}) -&gt;
<a name="10218"/>10218:                            socket:connect(Sock, SSA)
<a name="10219"/>10219:                    end},
<a name="10220"/>10220:          #{desc =&gt; &quot;announce ready (connect)&quot;,
<a name="10221"/>10221:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="10222"/>10222:                            ?SEV_ANNOUNCE_READY(Tester, connect),
<a name="10223"/>10223:                            ok
<a name="10224"/>10224:                    end},
<a name="10225"/>10225: 
<a name="10226"/>10226:          %% *** Termination ***
<a name="10227"/>10227:          #{desc =&gt; &quot;await terminate&quot;,
<a name="10228"/>10228:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="10229"/>10229:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="10230"/>10230:                                ok -&gt;
<a name="10231"/>10231:                                    {ok, maps:remove(tester, State)};
<a name="10232"/>10232:                                {error, _} = ERROR -&gt;
<a name="10233"/>10233:                                    ERROR
<a name="10234"/>10234:                            end
<a name="10235"/>10235:                    end},
<a name="10236"/>10236:          #{desc =&gt; &quot;close socket&quot;,
<a name="10237"/>10237:            cmd  =&gt; fun(#{sock := Sock}) -&gt;
<a name="10238"/>10238:                            socket:close(Sock)
<a name="10239"/>10239:                    end},
<a name="10240"/>10240: 
<a name="10241"/>10241:          %% *** We are done ***
<a name="10242"/>10242:          ?SEV_FINISH_NORMAL
<a name="10243"/>10243:         ],
<a name="10244"/>10244: 
<a name="10245"/>10245:     TesterSeq =
<a name="10246"/>10246:         [
<a name="10247"/>10247:          %% *** Init part ***
<a name="10248"/>10248:          #{desc =&gt; &quot;monitor server&quot;,
<a name="10249"/>10249:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="10250"/>10250:                            _MRef = erlang:monitor(process, Pid),
<a name="10251"/>10251:                            ok
<a name="10252"/>10252:                    end},
<a name="10253"/>10253:          #{desc =&gt; &quot;monitor client&quot;,
<a name="10254"/>10254:            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;
<a name="10255"/>10255:                            _MRef = erlang:monitor(process, Pid),
<a name="10256"/>10256:                            ok
<a name="10257"/>10257:                    end},
<a name="10258"/>10258: 
<a name="10259"/>10259:          %% Start the server
<a name="10260"/>10260:          #{desc =&gt; &quot;order server start&quot;,
<a name="10261"/>10261:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="10262"/>10262:                            ?SEV_ANNOUNCE_START(Pid),
<a name="10263"/>10263:                            ok
<a name="10264"/>10264:                    end},
<a name="10265"/>10265:          #{desc =&gt; &quot;await server ready (init)&quot;,
<a name="10266"/>10266:            cmd  =&gt; fun(#{server := Pid} = State) -&gt;
<a name="10267"/>10267:                            {ok, Port} = ?SEV_AWAIT_READY(Pid, server, init),
<a name="10268"/>10268:                            {ok, State#{server_port =&gt; Port}}
<a name="10269"/>10269:                    end},
<a name="10270"/>10270: 
<a name="10271"/>10271:          %% Start the client
<a name="10272"/>10272:          #{desc =&gt; &quot;order client start&quot;,
<a name="10273"/>10273:            cmd  =&gt; fun(#{client := Pid, server_port := Port} = _State) -&gt;
<a name="10274"/>10274:                            ?SEV_ANNOUNCE_START(Pid, Port),
<a name="10275"/>10275:                            ok
<a name="10276"/>10276:                    end},
<a name="10277"/>10277:          #{desc =&gt; &quot;await client ready (init)&quot;,
<a name="10278"/>10278:            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;
<a name="10279"/>10279:                            ok = ?SEV_AWAIT_READY(Pid, client, init)
<a name="10280"/>10280:                    end},
<a name="10281"/>10281: 
<a name="10282"/>10282:          %% *** The actual test ***
<a name="10283"/>10283:          #{desc =&gt; &quot;order server to continue (with accept)&quot;,
<a name="10284"/>10284:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="10285"/>10285:                            ?SEV_ANNOUNCE_CONTINUE(Server, accept),
<a name="10286"/>10286:                            ok
<a name="10287"/>10287:                    end},
<a name="10288"/>10288:          #{desc =&gt; &quot;order client to continue (connect)&quot;,
<a name="10289"/>10289:            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;
<a name="10290"/>10290:                            ?SEV_ANNOUNCE_CONTINUE(Pid, connect),
<a name="10291"/>10291:                            ok
<a name="10292"/>10292:                    end},
<a name="10293"/>10293:          #{desc =&gt; &quot;await client ready (connect)&quot;,
<a name="10294"/>10294:            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;
<a name="10295"/>10295:                            ?SEV_AWAIT_READY(Pid, client, connect)
<a name="10296"/>10296:                    end},
<a name="10297"/>10297:          #{desc =&gt; &quot;await server ready (accept)&quot;,
<a name="10298"/>10298:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="10299"/>10299:                            ?SEV_AWAIT_READY(Pid, server, accept)
<a name="10300"/>10300:                    end},
<a name="10301"/>10301: 
<a name="10302"/>10302:          #{desc =&gt; &quot;order server to continue (recv)&quot;,
<a name="10303"/>10303:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="10304"/>10304:                            ?SEV_ANNOUNCE_CONTINUE(Pid, recv),
<a name="10305"/>10305:                            ok
<a name="10306"/>10306:                    end},
<a name="10307"/>10307:          #{desc =&gt; &quot;await server ready (recv select)&quot;,
<a name="10308"/>10308:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="10309"/>10309:                            ?SEV_AWAIT_READY(Pid, server, recv_select)
<a name="10310"/>10310:                    end},
<a name="10311"/>10311:          #{desc =&gt; &quot;await server ready (no select)&quot;,
<a name="10312"/>10312:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="10313"/>10313:                            ?SEV_AWAIT_READY(Pid, server, no_select)
<a name="10314"/>10314:                    end},
<a name="10315"/>10315:          #{desc =&gt; &quot;order server to continue (send request)&quot;,
<a name="10316"/>10316:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="10317"/>10317:                            ?SEV_ANNOUNCE_CONTINUE(Pid, cancel),
<a name="10318"/>10318:                            ok
<a name="10319"/>10319:                    end},
<a name="10320"/>10320:          #{desc =&gt; &quot;await server ready (cancel)&quot;,
<a name="10321"/>10321:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="10322"/>10322:                            ?SEV_AWAIT_READY(Pid, server, cancel)
<a name="10323"/>10323:                    end},
<a name="10324"/>10324: 
<a name="10325"/>10325:          %% *** Termination ***
<a name="10326"/>10326:          #{desc =&gt; &quot;order client to terminate&quot;,
<a name="10327"/>10327:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="10328"/>10328:                            ?SEV_ANNOUNCE_TERMINATE(Client),
<a name="10329"/>10329:                            ok
<a name="10330"/>10330:                    end},
<a name="10331"/>10331:          #{desc =&gt; &quot;await client termination&quot;,
<a name="10332"/>10332:            cmd  =&gt; fun(#{client := Client} = State) -&gt;
<a name="10333"/>10333:                            ?SEV_AWAIT_TERMINATION(Client),
<a name="10334"/>10334:                            State1 = maps:remove(client, State),
<a name="10335"/>10335:                            {ok, State1}
<a name="10336"/>10336:                    end},
<a name="10337"/>10337:          #{desc =&gt; &quot;order server to terminate&quot;,
<a name="10338"/>10338:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="10339"/>10339:                            ?SEV_ANNOUNCE_TERMINATE(Server),
<a name="10340"/>10340:                            ok
<a name="10341"/>10341:                    end},
<a name="10342"/>10342:          #{desc =&gt; &quot;await server termination&quot;,
<a name="10343"/>10343:            cmd  =&gt; fun(#{server := Server} = State) -&gt;
<a name="10344"/>10344:                            ?SEV_AWAIT_TERMINATION(Server),
<a name="10345"/>10345:                            State1 = maps:remove(server, State),
<a name="10346"/>10346:                            {ok, State1}
<a name="10347"/>10347:                    end},
<a name="10348"/>10348: 
<a name="10349"/>10349:          %% *** We are done ***
<a name="10350"/>10350:          ?SEV_FINISH_NORMAL
<a name="10351"/>10351:         ],
<a name="10352"/>10352: 
<a name="10353"/>10353:     i(&quot;start server evaluator&quot;),
<a name="10354"/>10354:     Server = ?SEV_START(&quot;server&quot;, ServerSeq, InitState),
<a name="10355"/>10355: 
<a name="10356"/>10356:     i(&quot;start client evaluator&quot;),
<a name="10357"/>10357:     Client = ?SEV_START(&quot;client&quot;, ClientSeq, InitState),
<a name="10358"/>10358: 
<a name="10359"/>10359:     i(&quot;start tester evaluator&quot;),
<a name="10360"/>10360:     TesterInitState = #{server =&gt; Server#ev.pid,
<a name="10361"/>10361:                         client =&gt; Client#ev.pid},
<a name="10362"/>10362:     Tester = ?SEV_START(&quot;tester&quot;, TesterSeq, TesterInitState),
<a name="10363"/>10363: 
<a name="10364"/>10364:     i(&quot;await evaluator(s)&quot;),
<a name="api_a_recv_cancel_tcp-last_expr"/><a name="10365"/>10365: <b>    ok = ?SEV_AWAIT_FINISH</b>([Server, Client, Tester]).
<a name="10366"/>10366: 
<a name="10367"/>10367: 
<a name="10368"/>10368: 
<a name="10369"/>10369: 
<a name="10370"/>10370: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="10371"/>10371: 
<a name="10372"/>10372: <i>%% Basically we make multiple async (Timeout = nowait) call(s) to recvfrom</i>
<a name="10373"/>10373: <i>%% (from *several* processes), wait some time and then cancel.</i>
<a name="10374"/>10374: <i>%% This should result in abort messages to the 'other' processes. IPv4</i>
<a name="10375"/>10375: <i>%%</i>
<a name="api_a_mrecvfrom_cancel_udp4-1"/><a name="10376"/>10376: <b>api_a_mrecvfrom_cancel_udp4</b>(Config) when is_list(Config) -&gt;
<a name="10377"/>10377:     ?TT(?SECS(20)),
<a name="10378"/>10378:     Nowait = nowait(Config),
<a name="api_a_mrecvfrom_cancel_udp4-last_expr"/><a name="10379"/>10379: <b>    tc_try</b>(api_a_mrecvfrom_cancel_udp4,
<a name="10380"/>10380:            fun() -&gt; has_support_ipv4() end,
<a name="10381"/>10381:            fun() -&gt;
<a name="10382"/>10382:                    Recv = fun(Sock) -&gt;
<a name="10383"/>10383:                                   case socket:recvfrom(Sock, 0, Nowait) of
<a name="10384"/>10384:                                       {ok, _} = OK -&gt;
<a name="10385"/>10385:                                           OK;
<a name="10386"/>10386:                                       {select, _} = SELECT -&gt;
<a name="10387"/>10387:                                           SELECT;
<a name="10388"/>10388:                                       {completion, _} = COMPLETION -&gt;
<a name="10389"/>10389:                                           COMPLETION;
<a name="10390"/>10390:                                       {error, _} = ERROR -&gt;
<a name="10391"/>10391:                                           ERROR
<a name="10392"/>10392:                                   end
<a name="10393"/>10393:                           end,
<a name="10394"/>10394:                    InitState = #{domain   =&gt; inet,
<a name="10395"/>10395:                                  recv     =&gt; Recv,
<a name="10396"/>10396:                                  recv_ref =&gt; Nowait},
<a name="10397"/>10397:                    ok = api_a_mrecv_cancel_udp(InitState)
<a name="10398"/>10398:            end).
<a name="10399"/>10399: 
<a name="10400"/>10400: 
<a name="10401"/>10401: 
<a name="10402"/>10402: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="10403"/>10403: 
<a name="10404"/>10404: <i>%% Basically we make multiple async (Timeout = nowait) call(s) to recvfrom</i>
<a name="10405"/>10405: <i>%% (from *several* processes), wait some time and then cancel.</i>
<a name="10406"/>10406: <i>%% This should result in abort messages to the 'other' processes. IPv6</i>
<a name="10407"/>10407: <i>%%</i>
<a name="api_a_mrecvfrom_cancel_udp6-1"/><a name="10408"/>10408: <b>api_a_mrecvfrom_cancel_udp6</b>(Config) when is_list(Config) -&gt;
<a name="10409"/>10409:     ?TT(?SECS(20)),
<a name="10410"/>10410:     Nowait = nowait(Config),
<a name="api_a_mrecvfrom_cancel_udp6-last_expr"/><a name="10411"/>10411: <b>    tc_try</b>(api_a_mrecvfrom_cancel_udp6,
<a name="10412"/>10412:            fun() -&gt; has_support_ipv6() end,
<a name="10413"/>10413:            fun() -&gt;
<a name="10414"/>10414:                    Recv = fun(Sock) -&gt;
<a name="10415"/>10415:                                   case socket:recvfrom(Sock, 0, Nowait) of
<a name="10416"/>10416:                                       {ok, _} = OK -&gt;
<a name="10417"/>10417:                                           OK;
<a name="10418"/>10418:                                       {select, _} = SELECT -&gt;
<a name="10419"/>10419:                                           SELECT;
<a name="10420"/>10420:                                       {completion, _} = COMPLETION -&gt;
<a name="10421"/>10421:                                           COMPLETION;
<a name="10422"/>10422:                                       {error, _} = ERROR -&gt;
<a name="10423"/>10423:                                           ERROR
<a name="10424"/>10424:                                   end
<a name="10425"/>10425:                           end,
<a name="10426"/>10426:                    InitState = #{domain   =&gt; inet6,
<a name="10427"/>10427:                                  recv     =&gt; Recv,
<a name="10428"/>10428:                                  recv_ref =&gt; Nowait},
<a name="10429"/>10429:                    ok = api_a_mrecv_cancel_udp(InitState)
<a name="10430"/>10430:            end).
<a name="10431"/>10431: 
<a name="10432"/>10432: 
<a name="10433"/>10433: 
<a name="10434"/>10434: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="10435"/>10435: 
<a name="10436"/>10436: <i>%% Basically we make multiple async (Timeout = nowait) call(s) to recvmsg</i>
<a name="10437"/>10437: <i>%% (from *several* processes), wait some time and then cancel.</i>
<a name="10438"/>10438: <i>%% This should result in abort messages to the 'other' processes. IPv4</i>
<a name="10439"/>10439: <i>%%</i>
<a name="api_a_mrecvmsg_cancel_udp4-1"/><a name="10440"/>10440: <b>api_a_mrecvmsg_cancel_udp4</b>(Config) when is_list(Config) -&gt;
<a name="10441"/>10441:     ?TT(?SECS(20)),
<a name="10442"/>10442:     Nowait = nowait(Config),
<a name="api_a_mrecvmsg_cancel_udp4-last_expr"/><a name="10443"/>10443: <b>    tc_try</b>(api_a_mrecvmsg_cancel_udp4,
<a name="10444"/>10444:            fun() -&gt; has_support_ipv4() end,
<a name="10445"/>10445:            fun() -&gt;
<a name="10446"/>10446:                    Recv = fun(Sock) -&gt;
<a name="10447"/>10447:                                   case socket:recvmsg(Sock, Nowait) of
<a name="10448"/>10448:                                       {ok, _} = OK -&gt;
<a name="10449"/>10449:                                           OK;
<a name="10450"/>10450:                                       {select, _} = SELECT -&gt;
<a name="10451"/>10451:                                           SELECT;
<a name="10452"/>10452:                                       {completion, _} = COMPLETION -&gt;
<a name="10453"/>10453:                                           COMPLETION;
<a name="10454"/>10454:                                       {error, _} = ERROR -&gt;
<a name="10455"/>10455:                                           ERROR
<a name="10456"/>10456:                                   end
<a name="10457"/>10457:                           end,
<a name="10458"/>10458:                    InitState = #{domain   =&gt; inet,
<a name="10459"/>10459:                                  recv     =&gt; Recv,
<a name="10460"/>10460:                                  recv_ref =&gt; Nowait},
<a name="10461"/>10461:                    ok = api_a_mrecv_cancel_udp(InitState)
<a name="10462"/>10462:            end).
<a name="10463"/>10463: 
<a name="10464"/>10464: 
<a name="10465"/>10465: 
<a name="10466"/>10466: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="10467"/>10467: 
<a name="10468"/>10468: <i>%% Basically we make multiple async (Timeout = nowait) call(s) to recvmsg</i>
<a name="10469"/>10469: <i>%% (from *several* processes), wait some time and then cancel.</i>
<a name="10470"/>10470: <i>%% This should result in abort messages to the 'other' processes. IPv6</i>
<a name="10471"/>10471: <i>%%</i>
<a name="api_a_mrecvmsg_cancel_udp6-1"/><a name="10472"/>10472: <b>api_a_mrecvmsg_cancel_udp6</b>(Config) when is_list(Config) -&gt;
<a name="10473"/>10473:     ?TT(?SECS(20)),
<a name="10474"/>10474:     Nowait = nowait(Config),
<a name="api_a_mrecvmsg_cancel_udp6-last_expr"/><a name="10475"/>10475: <b>    tc_try</b>(api_a_mrecvmsg_cancel_udp6,
<a name="10476"/>10476:            fun() -&gt; has_support_ipv6() end,
<a name="10477"/>10477:            fun() -&gt;
<a name="10478"/>10478:                    Recv = fun(Sock) -&gt;
<a name="10479"/>10479:                                   case socket:recvmsg(Sock, Nowait) of
<a name="10480"/>10480:                                       {ok, _} = OK -&gt;
<a name="10481"/>10481:                                           OK;
<a name="10482"/>10482:                                       {select, _} = SELECT -&gt;
<a name="10483"/>10483:                                           SELECT;
<a name="10484"/>10484:                                       {completion, _} = COMPLETION -&gt;
<a name="10485"/>10485:                                           COMPLETION;
<a name="10486"/>10486:                                       {error, _} = ERROR -&gt;
<a name="10487"/>10487:                                           ERROR
<a name="10488"/>10488:                                   end
<a name="10489"/>10489:                           end,
<a name="10490"/>10490:                    InitState = #{domain   =&gt; inet6,
<a name="10491"/>10491:                                  recv     =&gt; Recv,
<a name="10492"/>10492:                                  recv_ref =&gt; Nowait},
<a name="10493"/>10493:                    ok = api_a_mrecv_cancel_udp(InitState)
<a name="10494"/>10494:            end).
<a name="10495"/>10495: 
<a name="10496"/>10496: 
<a name="10497"/>10497: 
<a name="10498"/>10498: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="10499"/>10499: 
<a name="api_a_mrecv_cancel_udp-1"/><a name="10500"/>10500: <b>api_a_mrecv_cancel_udp</b>(InitState) -&gt;
<a name="10501"/>10501:     ServerSeq = 
<a name="10502"/>10502:         [
<a name="10503"/>10503:          %% *** Wait for start order part ***
<a name="10504"/>10504:          #{desc =&gt; &quot;await start&quot;,
<a name="10505"/>10505:            cmd  =&gt; fun(State) -&gt;
<a name="10506"/>10506:                            Tester = ?SEV_AWAIT_START(),
<a name="10507"/>10507:                            {ok, State#{tester =&gt; Tester}}
<a name="10508"/>10508:                    end},
<a name="10509"/>10509:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="10510"/>10510:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="10511"/>10511:                            _MRef = erlang:monitor(process, Tester),
<a name="10512"/>10512:                            ok
<a name="10513"/>10513:                    end},
<a name="10514"/>10514: 
<a name="10515"/>10515:          %% *** Init part ***
<a name="10516"/>10516:          #{desc =&gt; &quot;which local address&quot;,
<a name="10517"/>10517:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="10518"/>10518:                            LSA = which_local_socket_addr(Domain),
<a name="10519"/>10519:                            {ok, State#{local_sa =&gt; LSA}}
<a name="10520"/>10520:                    end},
<a name="10521"/>10521:          #{desc =&gt; &quot;create socket&quot;,
<a name="10522"/>10522:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="10523"/>10523:                            case socket:open(Domain, dgram, udp) of
<a name="10524"/>10524:                                {ok, Sock} -&gt;
<a name="10525"/>10525:                                    {ok, State#{sock =&gt; Sock}};
<a name="10526"/>10526:                                {error, _} = ERROR -&gt;
<a name="10527"/>10527:                                    ERROR
<a name="10528"/>10528:                            end
<a name="10529"/>10529:                    end},
<a name="10530"/>10530:          #{desc =&gt; &quot;bind socket (to local address)&quot;,
<a name="10531"/>10531:            cmd  =&gt; fun(#{sock := Sock, local_sa := LSA} = State) -&gt;
<a name="10532"/>10532:                            case sock_bind(Sock, LSA) of
<a name="10533"/>10533:                                ok -&gt;
<a name="10534"/>10534:                                    Port = sock_port(Sock),
<a name="10535"/>10535:                                    {ok, State#{port =&gt; Port}};
<a name="10536"/>10536:                                {error, _} = ERROR -&gt;
<a name="10537"/>10537:                                    ERROR
<a name="10538"/>10538:                            end
<a name="10539"/>10539:                    end},
<a name="10540"/>10540:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="10541"/>10541:            cmd  =&gt; fun(#{tester := Tester, sock := Sock}) -&gt;
<a name="10542"/>10542:                            ?SEV_ANNOUNCE_READY(Tester, init, Sock),
<a name="10543"/>10543:                            ok
<a name="10544"/>10544:                    end},
<a name="10545"/>10545: 
<a name="10546"/>10546:          %% The actual test
<a name="10547"/>10547:          #{desc =&gt; &quot;await continue (recv)&quot;,
<a name="10548"/>10548:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="10549"/>10549:                            ?SEV_AWAIT_CONTINUE(Tester, tester, recv)
<a name="10550"/>10550:                    end},
<a name="10551"/>10551:          #{desc =&gt; &quot;try recv request (with nowait, expect select)&quot;,
<a name="10552"/>10552:            cmd  =&gt; fun(#{sock     := Sock,
<a name="10553"/>10553:                          recv     := Recv,
<a name="10554"/>10554:                          recv_ref := Ref} = State) -&gt;
<a name="10555"/>10555:                            case Recv(Sock) of
<a name="10556"/>10556:                                {select, SI}
<a name="10557"/>10557:                                  when Ref =:= nowait -&gt;
<a name="10558"/>10558:                                    {ok, State#{recv_select_info =&gt; SI}};
<a name="10559"/>10559:                                {select, {select_info, _Tag, Ref} = SI}
<a name="10560"/>10560:                                  when is_reference(Ref) -&gt;
<a name="10561"/>10561:                                    {ok, State#{recv_select_info =&gt; SI}};
<a name="10562"/>10562: 
<a name="10563"/>10563:                                {completion, CI}
<a name="10564"/>10564:                                  when Ref =:= nowait -&gt;
<a name="10565"/>10565:                                    {ok, State#{recv_completion_info =&gt; CI}};
<a name="10566"/>10566:                                {completion, {completion_info, _Tag, Ref} = CI}
<a name="10567"/>10567:                                  when is_reference(Ref) -&gt;
<a name="10568"/>10568:                                    {ok, State#{recv_completion_info =&gt; CI}};
<a name="10569"/>10569: 
<a name="10570"/>10570:                                {ok, X} -&gt;
<a name="10571"/>10571:                                    {error, {unexpected_success, X}};
<a name="10572"/>10572: 
<a name="10573"/>10573:                                {error, _} = ERROR -&gt;
<a name="10574"/>10574:                                    ERROR
<a name="10575"/>10575:                            end
<a name="10576"/>10576:                    end},
<a name="10577"/>10577:          #{desc =&gt; &quot;announce ready (recv_select)&quot;,
<a name="10578"/>10578:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="10579"/>10579:                            ?SEV_ANNOUNCE_READY(Tester, recv_select),
<a name="10580"/>10580:                            ok
<a name="10581"/>10581:                    end},
<a name="10582"/>10582:          #{desc =&gt; &quot;await abort message&quot;,
<a name="10583"/>10583:            cmd  =&gt; fun(#{sock             := Sock,
<a name="10584"/>10584:                          recv_select_info := {select_info, _, Ref}} =
<a name="10585"/>10585:                            State) -&gt;
<a name="10586"/>10586:                            receive
<a name="10587"/>10587:                                {'$socket', Sock, select, Ref} -&gt;
<a name="10588"/>10588:                                    {error, {unexpected_select, Ref}};
<a name="10589"/>10589:                                {'$socket', Sock, abort, {Ref, closed}} -&gt;
<a name="10590"/>10590:                                    {ok, maps:remove(sock, State)}
<a name="10591"/>10591:                            after 5000 -&gt;
<a name="10592"/>10592:                                    ?SEV_EPRINT(&quot;message queue: ~p&quot;, [mq()]),
<a name="10593"/>10593:                                    {error, timeout}
<a name="10594"/>10594:                            end;
<a name="10595"/>10595:                       (#{sock                 := Sock,
<a name="10596"/>10596:                          recv_completion_info := {completion_info, _, Ref}} = 
<a name="10597"/>10597:                            State) -&gt;
<a name="10598"/>10598:                            receive
<a name="10599"/>10599:                                {'$socket', Sock, completion, {Ref, CS}} -&gt;
<a name="10600"/>10600:                                    {error, {unexpected_completion, CS}};
<a name="10601"/>10601:                                {'$socket', Sock, abort, {Ref, closed}} -&gt;
<a name="10602"/>10602:                                    {ok, maps:remove(sock, State)}
<a name="10603"/>10603:                            after 5000 -&gt;
<a name="10604"/>10604:                                    ?SEV_EPRINT(&quot;message queue: ~p&quot;, [mq()]),
<a name="10605"/>10605:                                    {error, timeout}
<a name="10606"/>10606:                            end
<a name="10607"/>10607:                    end},
<a name="10608"/>10608:          #{desc =&gt; &quot;announce ready (abort)&quot;,
<a name="10609"/>10609:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="10610"/>10610:                            ?SEV_ANNOUNCE_READY(Tester, abort),
<a name="10611"/>10611:                            ok
<a name="10612"/>10612:                    end},
<a name="10613"/>10613: 
<a name="10614"/>10614:          %% Termination
<a name="10615"/>10615:          #{desc =&gt; &quot;await terminate (from tester)&quot;,
<a name="10616"/>10616:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="10617"/>10617:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="10618"/>10618:                                ok -&gt;
<a name="10619"/>10619:                                    State2 = maps:remove(tester,   State),
<a name="10620"/>10620:                                    State3 = maps:remove(recv_ref, State2),
<a name="10621"/>10621:                                    {ok, State3};
<a name="10622"/>10622:                                {error, _} = ERROR -&gt;
<a name="10623"/>10623:                                    ERROR
<a name="10624"/>10624:                            end
<a name="10625"/>10625:                    end},
<a name="10626"/>10626: 
<a name="10627"/>10627:          %% *** We are done ***
<a name="10628"/>10628:          ?SEV_FINISH_NORMAL
<a name="10629"/>10629:         ],
<a name="10630"/>10630: 
<a name="10631"/>10631: 
<a name="10632"/>10632:     AltServerSeq = 
<a name="10633"/>10633:         [
<a name="10634"/>10634:          %% *** Wait for start order part ***
<a name="10635"/>10635:          #{desc =&gt; &quot;await start&quot;,
<a name="10636"/>10636:            cmd  =&gt; fun(State) -&gt;
<a name="10637"/>10637:                            {Tester, Sock} = ?SEV_AWAIT_START(),
<a name="10638"/>10638:                            {ok, State#{tester =&gt; Tester, sock =&gt; Sock}}
<a name="10639"/>10639:                    end},
<a name="10640"/>10640:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="10641"/>10641:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="10642"/>10642:                            _MRef = erlang:monitor(process, Tester),
<a name="10643"/>10643:                            ok
<a name="10644"/>10644:                    end},
<a name="10645"/>10645:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="10646"/>10646:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="10647"/>10647:                            ?SEV_ANNOUNCE_READY(Tester, init),
<a name="10648"/>10648:                            ok
<a name="10649"/>10649:                    end},
<a name="10650"/>10650: 
<a name="10651"/>10651:          %% The actual test
<a name="10652"/>10652:          #{desc =&gt; &quot;await continue (recv)&quot;,
<a name="10653"/>10653:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="10654"/>10654:                            ?SEV_AWAIT_CONTINUE(Tester, tester, recv)
<a name="10655"/>10655:                    end},
<a name="10656"/>10656:          #{desc =&gt; &quot;try recv request (with nowait, expect select)&quot;,
<a name="10657"/>10657:            cmd  =&gt; fun(#{sock     := Sock,
<a name="10658"/>10658:                          recv     := Recv,
<a name="10659"/>10659:                          recv_ref := Ref} = State) -&gt;
<a name="10660"/>10660:                            case Recv(Sock) of
<a name="10661"/>10661:                                {select, SI} when Ref =:= nowait -&gt;
<a name="10662"/>10662:                                    {ok, State#{recv_select_info =&gt; SI}};
<a name="10663"/>10663:                                {select,
<a name="10664"/>10664:                                 {select_info, _Tag, Ref} = SI}
<a name="10665"/>10665:                                  when is_reference(Ref) -&gt;
<a name="10666"/>10666:                                    {ok, State#{recv_select_info =&gt; SI}};
<a name="10667"/>10667: 
<a name="10668"/>10668:                                {completion, CI} when Ref =:= nowait -&gt;
<a name="10669"/>10669:                                    {ok, State#{recv_completion_info =&gt; CI}};
<a name="10670"/>10670:                                {completion,
<a name="10671"/>10671:                                 {completion_info, _Tag, Ref} = CI}
<a name="10672"/>10672:                                  when is_reference(Ref) -&gt;
<a name="10673"/>10673:                                    {ok, State#{recv_completion_info =&gt; CI}};
<a name="10674"/>10674: 
<a name="10675"/>10675:                                {ok, X} -&gt;
<a name="10676"/>10676:                                    {error, {unexpected_success, X}};
<a name="10677"/>10677: 
<a name="10678"/>10678:                                {error, _} = ERROR -&gt;
<a name="10679"/>10679:                                    ERROR
<a name="10680"/>10680:                            end
<a name="10681"/>10681:                    end},
<a name="10682"/>10682:          #{desc =&gt; &quot;announce ready (recv_select)&quot;,
<a name="10683"/>10683:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="10684"/>10684:                            ?SEV_ANNOUNCE_READY(Tester, recv_select),
<a name="10685"/>10685:                            ok
<a name="10686"/>10686:                    end},
<a name="10687"/>10687:          #{desc =&gt; &quot;await abort message&quot;,
<a name="10688"/>10688:            cmd  =&gt; fun(#{sock             := Sock,
<a name="10689"/>10689:                          recv_select_info := {select_info, _, Ref}} = State) -&gt;
<a name="10690"/>10690:                            receive
<a name="10691"/>10691:                                {'$socket', Sock, select, Ref} -&gt;
<a name="10692"/>10692:                                    {error, {unexpected_select, Ref}};
<a name="10693"/>10693:                                {'$socket', Sock, abort, {Ref, closed}} -&gt;
<a name="10694"/>10694:                                    {ok, maps:remove(sock, State)}
<a name="10695"/>10695:                            after 5000 -&gt;
<a name="10696"/>10696:                                    ?SEV_EPRINT(&quot;message queue: ~p&quot;, [mq()]),
<a name="10697"/>10697:                                    {error, timeout}
<a name="10698"/>10698:                            end;
<a name="10699"/>10699: 
<a name="10700"/>10700:                       (#{sock                 := Sock,
<a name="10701"/>10701:                          recv_completion_info := {completion_info, _, Ref}} =
<a name="10702"/>10702:                            State) -&gt;
<a name="10703"/>10703:                            receive
<a name="10704"/>10704:                                {'$socket', Sock, completion, {Ref, CS}} -&gt;
<a name="10705"/>10705:                                    {error, {unexpected_completion, CS}};
<a name="10706"/>10706:                                {'$socket', Sock, abort, {Ref, closed}} -&gt;
<a name="10707"/>10707:                                    {ok, maps:remove(sock, State)}
<a name="10708"/>10708:                            after 5000 -&gt;
<a name="10709"/>10709:                                    ?SEV_EPRINT(&quot;message queue: ~p&quot;, [mq()]),
<a name="10710"/>10710:                                    {error, timeout}
<a name="10711"/>10711:                            end
<a name="10712"/>10712:                    end},
<a name="10713"/>10713:          #{desc =&gt; &quot;announce ready (abort)&quot;,
<a name="10714"/>10714:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="10715"/>10715:                            ?SEV_ANNOUNCE_READY(Tester, abort),
<a name="10716"/>10716:                            ok
<a name="10717"/>10717:                    end},
<a name="10718"/>10718: 
<a name="10719"/>10719:          %% Termination
<a name="10720"/>10720:          #{desc =&gt; &quot;await terminate (from tester)&quot;,
<a name="10721"/>10721:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="10722"/>10722:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="10723"/>10723:                                ok -&gt;
<a name="10724"/>10724:                                    ?SEV_IPRINT(&quot;terminating&quot;),
<a name="10725"/>10725:                                    State1 = maps:remove(recv_select_info, State),
<a name="10726"/>10726:                                    State2 = maps:remove(recv_completion_info, State1),
<a name="10727"/>10727:                                    State3 = maps:remove(tester,           State2),
<a name="10728"/>10728:                                    State4 = maps:remove(sock,             State3),
<a name="10729"/>10729:                                    {ok, State4};
<a name="10730"/>10730:                                {error, _} = ERROR -&gt;
<a name="10731"/>10731:                                    ERROR
<a name="10732"/>10732:                            end
<a name="10733"/>10733:                    end},
<a name="10734"/>10734: 
<a name="10735"/>10735:          %% *** We are done ***
<a name="10736"/>10736:          ?SEV_FINISH_NORMAL
<a name="10737"/>10737:         ],
<a name="10738"/>10738: 
<a name="10739"/>10739: 
<a name="10740"/>10740: 
<a name="10741"/>10741:     TesterSeq = 
<a name="10742"/>10742:         [
<a name="10743"/>10743:          %% *** Init part ***
<a name="10744"/>10744:          #{desc =&gt; &quot;monitor server&quot;,
<a name="10745"/>10745:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="10746"/>10746:                            _MRef = erlang:monitor(process, Pid),
<a name="10747"/>10747:                            ok
<a name="10748"/>10748:                    end},
<a name="10749"/>10749:          #{desc =&gt; &quot;monitor alt-server 1&quot;,
<a name="10750"/>10750:            cmd  =&gt; fun(#{alt_server1 := Pid} = _State) -&gt;
<a name="10751"/>10751:                            _MRef = erlang:monitor(process, Pid),
<a name="10752"/>10752:                            ok
<a name="10753"/>10753:                    end},
<a name="10754"/>10754:          #{desc =&gt; &quot;monitor alt-server 2&quot;,
<a name="10755"/>10755:            cmd  =&gt; fun(#{alt_server2 := Pid} = _State) -&gt;
<a name="10756"/>10756:                            _MRef = erlang:monitor(process, Pid),
<a name="10757"/>10757:                            ok
<a name="10758"/>10758:                    end},
<a name="10759"/>10759: 
<a name="10760"/>10760:          %% Start the server
<a name="10761"/>10761:          #{desc =&gt; &quot;order server start&quot;,
<a name="10762"/>10762:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="10763"/>10763:                            ?SEV_ANNOUNCE_START(Pid),
<a name="10764"/>10764:                            ok
<a name="10765"/>10765:                    end},
<a name="10766"/>10766:          #{desc =&gt; &quot;await server ready (init)&quot;,
<a name="10767"/>10767:            cmd  =&gt; fun(#{server := Pid} = State) -&gt;
<a name="10768"/>10768:                            {ok, Sock} = ?SEV_AWAIT_READY(Pid, server, init),
<a name="10769"/>10769:                            {ok, State#{sock =&gt; Sock}}
<a name="10770"/>10770:                    end},
<a name="10771"/>10771: 
<a name="10772"/>10772:          %% Start the alt-server 1
<a name="10773"/>10773:          #{desc =&gt; &quot;order alt-server 1 start&quot;,
<a name="10774"/>10774:            cmd  =&gt; fun(#{alt_server1 := Pid, sock := Sock} = _State) -&gt;
<a name="10775"/>10775:                            ?SEV_ANNOUNCE_START(Pid, Sock),
<a name="10776"/>10776:                            ok
<a name="10777"/>10777:                    end},
<a name="10778"/>10778:          #{desc =&gt; &quot;await alt-server 1 ready (init)&quot;,
<a name="10779"/>10779:            cmd  =&gt; fun(#{alt_server1 := Pid} = _State) -&gt;
<a name="10780"/>10780:                            ?SEV_AWAIT_READY(Pid, alt_server1, init)
<a name="10781"/>10781:                    end},
<a name="10782"/>10782: 
<a name="10783"/>10783:          %% Start the alt-server 2
<a name="10784"/>10784:          #{desc =&gt; &quot;order alt-server 2 start&quot;,
<a name="10785"/>10785:            cmd  =&gt; fun(#{alt_server2 := Pid, sock := Sock} = _State) -&gt;
<a name="10786"/>10786:                            ?SEV_ANNOUNCE_START(Pid, Sock),
<a name="10787"/>10787:                            ok
<a name="10788"/>10788:                    end},
<a name="10789"/>10789:          #{desc =&gt; &quot;await alt-server 2 ready (init)&quot;,
<a name="10790"/>10790:            cmd  =&gt; fun(#{alt_server2 := Pid} = _State) -&gt;
<a name="10791"/>10791:                            ?SEV_AWAIT_READY(Pid, alt_server2, init)
<a name="10792"/>10792:                    end},
<a name="10793"/>10793: 
<a name="10794"/>10794: 
<a name="10795"/>10795:          %% The actual test
<a name="10796"/>10796:          #{desc =&gt; &quot;order server continue (recv)&quot;,
<a name="10797"/>10797:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="10798"/>10798:                            ?SEV_ANNOUNCE_CONTINUE(Pid, recv),
<a name="10799"/>10799:                            ok
<a name="10800"/>10800:                    end},
<a name="10801"/>10801:          #{desc =&gt; &quot;await server ready (recv select)&quot;,
<a name="10802"/>10802:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="10803"/>10803:                            ok = ?SEV_AWAIT_READY(Pid, server, recv_select)
<a name="10804"/>10804:                    end},
<a name="10805"/>10805: 
<a name="10806"/>10806:          #{desc =&gt; &quot;order alt-server 1 continue (recv)&quot;,
<a name="10807"/>10807:            cmd  =&gt; fun(#{alt_server1 := Pid} = _State) -&gt;
<a name="10808"/>10808:                            ?SEV_ANNOUNCE_CONTINUE(Pid, recv),
<a name="10809"/>10809:                            ok
<a name="10810"/>10810:                    end},
<a name="10811"/>10811:          #{desc =&gt; &quot;await alt-server 1 ready (recv select)&quot;,
<a name="10812"/>10812:            cmd  =&gt; fun(#{alt_server1 := Pid} = _State) -&gt;
<a name="10813"/>10813:                            ok = ?SEV_AWAIT_READY(Pid, alt_server1, recv_select)
<a name="10814"/>10814:                    end},
<a name="10815"/>10815: 
<a name="10816"/>10816:          #{desc =&gt; &quot;order alt-server 2 continue (recv)&quot;,
<a name="10817"/>10817:            cmd  =&gt; fun(#{alt_server2 := Pid} = _State) -&gt;
<a name="10818"/>10818:                            ?SEV_ANNOUNCE_CONTINUE(Pid, recv),
<a name="10819"/>10819:                            ok
<a name="10820"/>10820:                    end},
<a name="10821"/>10821:          #{desc =&gt; &quot;await alt-server 2 ready (recv select)&quot;,
<a name="10822"/>10822:            cmd  =&gt; fun(#{alt_server2 := Pid} = _State) -&gt;
<a name="10823"/>10823:                            ok = ?SEV_AWAIT_READY(Pid, alt_server2, recv_select)
<a name="10824"/>10824:                    end},
<a name="10825"/>10825: 
<a name="10826"/>10826:          ?SEV_SLEEP(?SECS(1)),
<a name="10827"/>10827: 
<a name="10828"/>10828:          #{desc =&gt; &quot;close the socket&quot;,
<a name="10829"/>10829:            cmd  =&gt; fun(#{sock := Sock} = _State) -&gt;
<a name="10830"/>10830:                            socket:close(Sock)
<a name="10831"/>10831:                    end},
<a name="10832"/>10832: 
<a name="10833"/>10833:          #{desc =&gt; &quot;await server ready (abort)&quot;,
<a name="10834"/>10834:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="10835"/>10835:                            ok = ?SEV_AWAIT_READY(Pid, server, abort)
<a name="10836"/>10836:                    end},
<a name="10837"/>10837:          #{desc =&gt; &quot;await alt-server 1 ready (abort)&quot;,
<a name="10838"/>10838:            cmd  =&gt; fun(#{alt_server1 := Pid} = _State) -&gt;
<a name="10839"/>10839:                            ok = ?SEV_AWAIT_READY(Pid, alt_server1, abort)
<a name="10840"/>10840:                    end},
<a name="10841"/>10841:          #{desc =&gt; &quot;await alt-server 2 ready (abort)&quot;,
<a name="10842"/>10842:            cmd  =&gt; fun(#{alt_server2 := Pid} = _State) -&gt;
<a name="10843"/>10843:                            ok = ?SEV_AWAIT_READY(Pid, alt_server2, abort)
<a name="10844"/>10844:                    end},
<a name="10845"/>10845: 
<a name="10846"/>10846:          %% Terminations
<a name="10847"/>10847:          #{desc =&gt; &quot;order alt-server 2 to terminate&quot;,
<a name="10848"/>10848:            cmd  =&gt; fun(#{alt_server2 := Pid} = _State) -&gt;
<a name="10849"/>10849:                            ?SEV_ANNOUNCE_TERMINATE(Pid),
<a name="10850"/>10850:                            ok
<a name="10851"/>10851:                    end},
<a name="10852"/>10852:          #{desc =&gt; &quot;await alt-server 2 termination&quot;,
<a name="10853"/>10853:            cmd  =&gt; fun(#{alt_server2 := Pid} = State) -&gt;
<a name="10854"/>10854:                            case ?SEV_AWAIT_TERMINATION(Pid) of
<a name="10855"/>10855:                                ok -&gt;
<a name="10856"/>10856:                                    State1 = maps:remove(alt_server2, State),
<a name="10857"/>10857:                                    {ok, State1};
<a name="10858"/>10858:                                {error, _} = ERROR -&gt;
<a name="10859"/>10859:                                    ERROR
<a name="10860"/>10860:                            end
<a name="10861"/>10861:                    end},
<a name="10862"/>10862: 
<a name="10863"/>10863:          #{desc =&gt; &quot;order alt-server 1 to terminate&quot;,
<a name="10864"/>10864:            cmd  =&gt; fun(#{alt_server1 := Pid} = _State) -&gt;
<a name="10865"/>10865:                            ?SEV_ANNOUNCE_TERMINATE(Pid),
<a name="10866"/>10866:                            ok
<a name="10867"/>10867:                    end},
<a name="10868"/>10868:          #{desc =&gt; &quot;await alt-server 1 termination&quot;,
<a name="10869"/>10869:            cmd  =&gt; fun(#{alt_server1 := Pid} = State) -&gt;
<a name="10870"/>10870:                            case ?SEV_AWAIT_TERMINATION(Pid) of
<a name="10871"/>10871:                                ok -&gt;
<a name="10872"/>10872:                                    State1 = maps:remove(alt_server1, State),
<a name="10873"/>10873:                                    {ok, State1};
<a name="10874"/>10874:                                {error, _} = ERROR -&gt;
<a name="10875"/>10875:                                    ERROR
<a name="10876"/>10876:                            end
<a name="10877"/>10877:                    end},
<a name="10878"/>10878: 
<a name="10879"/>10879:          #{desc =&gt; &quot;order server to terminate&quot;,
<a name="10880"/>10880:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="10881"/>10881:                            ?SEV_ANNOUNCE_TERMINATE(Pid),
<a name="10882"/>10882:                            ok
<a name="10883"/>10883:                    end},
<a name="10884"/>10884:          #{desc =&gt; &quot;await server termination&quot;,
<a name="10885"/>10885:            cmd  =&gt; fun(#{server := Pid} = State) -&gt;
<a name="10886"/>10886:                            case ?SEV_AWAIT_TERMINATION(Pid) of
<a name="10887"/>10887:                                ok -&gt;
<a name="10888"/>10888:                                    State1 = maps:remove(server, State),
<a name="10889"/>10889:                                    {ok, State1};
<a name="10890"/>10890:                                {error, _} = ERROR -&gt;
<a name="10891"/>10891:                                    ERROR
<a name="10892"/>10892:                            end
<a name="10893"/>10893:                    end},
<a name="10894"/>10894: 
<a name="10895"/>10895: 
<a name="10896"/>10896:          %% *** We are done ***
<a name="10897"/>10897:          ?SEV_FINISH_NORMAL
<a name="10898"/>10898:         ],
<a name="10899"/>10899: 
<a name="10900"/>10900:     i(&quot;start server evaluator&quot;),
<a name="10901"/>10901:     Server = ?SEV_START(&quot;server&quot;, ServerSeq, InitState),
<a name="10902"/>10902: 
<a name="10903"/>10903:     i(&quot;start alt-server 1 evaluator&quot;),
<a name="10904"/>10904:     AltServer1 = ?SEV_START(&quot;alt_server1&quot;, AltServerSeq, InitState),
<a name="10905"/>10905: 
<a name="10906"/>10906:     i(&quot;start alt-server 2 evaluator&quot;),
<a name="10907"/>10907:     AltServer2 = ?SEV_START(&quot;alt_server2&quot;, AltServerSeq, InitState),
<a name="10908"/>10908: 
<a name="10909"/>10909:     i(&quot;start 'tester' evaluator&quot;),
<a name="10910"/>10910:     TesterInitState = #{server      =&gt; Server#ev.pid,
<a name="10911"/>10911:                         alt_server1 =&gt; AltServer1#ev.pid,
<a name="10912"/>10912:                         alt_server2 =&gt; AltServer2#ev.pid},
<a name="10913"/>10913:     Tester = ?SEV_START(&quot;tester&quot;, TesterSeq, TesterInitState),
<a name="10914"/>10914: 
<a name="10915"/>10915:     i(&quot;await evaluator(s)&quot;),
<a name="api_a_mrecv_cancel_udp-last_expr"/><a name="10916"/>10916: <b>    ok = ?SEV_AWAIT_FINISH</b>([Server, AltServer1, AltServer2, Tester]).
<a name="10917"/>10917: 
<a name="10918"/>10918: 
<a name="10919"/>10919: 
<a name="10920"/>10920: 
<a name="10921"/>10921: 
<a name="10922"/>10922: 
<a name="10923"/>10923: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="10924"/>10924: 
<a name="10925"/>10925: <i>%% Basically we make multiple async (Timeout = nowait) call(s) to accept</i>
<a name="10926"/>10926: <i>%% (from *several* processes), wait some time and then cancel,</i>
<a name="10927"/>10927: <i>%% This should result in abort messages to the 'other' processes. IPv4</i>
<a name="10928"/>10928: <i>%%</i>
<a name="api_a_maccept_cancel_tcp4-1"/><a name="10929"/>10929: <b>api_a_maccept_cancel_tcp4</b>(Config) when is_list(Config) -&gt;
<a name="10930"/>10930:     ?TT(?SECS(20)),
<a name="10931"/>10931:     Nowait = nowait(Config),
<a name="api_a_maccept_cancel_tcp4-last_expr"/><a name="10932"/>10932: <b>    tc_try</b>(api_a_maccept_cancel_tcp4,
<a name="10933"/>10933:            fun() -&gt; has_support_ipv4() end,
<a name="10934"/>10934:            fun() -&gt;
<a name="10935"/>10935:                    Accept = fun(Sock) -&gt;
<a name="10936"/>10936:                                     case socket:accept(Sock, Nowait) of
<a name="10937"/>10937:                                         {ok, _} = OK -&gt;
<a name="10938"/>10938:                                             OK;
<a name="10939"/>10939:                                         {select, _} = SELECT -&gt;
<a name="10940"/>10940:                                             SELECT;
<a name="10941"/>10941:                                         {completion, _} = COMPLETION -&gt;
<a name="10942"/>10942:                                             COMPLETION;
<a name="10943"/>10943:                                         {error, _} = ERROR -&gt;
<a name="10944"/>10944:                                             ERROR
<a name="10945"/>10945:                                     end
<a name="10946"/>10946:                             end,
<a name="10947"/>10947:                    InitState = #{domain     =&gt; inet,
<a name="10948"/>10948:                                  accept     =&gt; Accept,
<a name="10949"/>10949:                                  accept_ref =&gt; Nowait},
<a name="10950"/>10950:                    ok = api_a_maccept_cancel_tcp(InitState)
<a name="10951"/>10951:            end).
<a name="10952"/>10952: 
<a name="10953"/>10953: 
<a name="10954"/>10954: 
<a name="10955"/>10955: 
<a name="10956"/>10956: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="10957"/>10957: 
<a name="10958"/>10958: <i>%% Basically we make multiple async (Timeout = nowait) call(s) to accept</i>
<a name="10959"/>10959: <i>%% (from *several* processes), wait some time and then cancel,</i>
<a name="10960"/>10960: <i>%% This should result in abort messages to the 'other' processes. IPv6</i>
<a name="10961"/>10961: <i>%%</i>
<a name="api_a_maccept_cancel_tcp6-1"/><a name="10962"/>10962: <b>api_a_maccept_cancel_tcp6</b>(Config) when is_list(Config) -&gt;
<a name="10963"/>10963:     ?TT(?SECS(20)),
<a name="10964"/>10964:     Nowait = nowait(Config),
<a name="api_a_maccept_cancel_tcp6-last_expr"/><a name="10965"/>10965: <b>    tc_try</b>(api_a_maccept_cancel_tcp6,
<a name="10966"/>10966:            fun() -&gt; has_support_ipv6() end,
<a name="10967"/>10967:            fun() -&gt;
<a name="10968"/>10968:                    Accept = fun(Sock) -&gt;
<a name="10969"/>10969:                                     case socket:accept(Sock, Nowait) of
<a name="10970"/>10970:                                         {ok, _} = OK -&gt;
<a name="10971"/>10971:                                             OK;
<a name="10972"/>10972:                                         {select, _} = SELECT -&gt;
<a name="10973"/>10973:                                             SELECT;
<a name="10974"/>10974:                                         {completion, _} = COMPLETION -&gt;
<a name="10975"/>10975:                                             COMPLETION;
<a name="10976"/>10976:                                         {error, _} = ERROR -&gt;
<a name="10977"/>10977:                                             ERROR
<a name="10978"/>10978:                                     end
<a name="10979"/>10979:                             end,
<a name="10980"/>10980:                    InitState = #{domain     =&gt; inet6,
<a name="10981"/>10981:                                  accept     =&gt; Accept,
<a name="10982"/>10982:                                  accept_ref =&gt; Nowait},
<a name="10983"/>10983:                    ok = api_a_maccept_cancel_tcp(InitState)
<a name="10984"/>10984:            end).
<a name="10985"/>10985: 
<a name="10986"/>10986: 
<a name="10987"/>10987: 
<a name="10988"/>10988: 
<a name="10989"/>10989: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="10990"/>10990: 
<a name="api_a_maccept_cancel_tcp-1"/><a name="10991"/>10991: <b>api_a_maccept_cancel_tcp</b>(InitState) -&gt;
<a name="10992"/>10992:     process_flag(trap_exit, true),
<a name="10993"/>10993:     ServerSeq = 
<a name="10994"/>10994:         [
<a name="10995"/>10995:          %% *** Wait for start order ***
<a name="10996"/>10996:          #{desc =&gt; &quot;await start (from tester)&quot;,
<a name="10997"/>10997:            cmd  =&gt; fun(State) -&gt;
<a name="10998"/>10998:                            Tester = ?SEV_AWAIT_START(),
<a name="10999"/>10999:                            {ok, State#{tester =&gt; Tester}}
<a name="11000"/>11000:                    end},
<a name="11001"/>11001:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="11002"/>11002:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="11003"/>11003:                            _MRef = erlang:monitor(process, Tester),
<a name="11004"/>11004:                            ok
<a name="11005"/>11005:                    end},
<a name="11006"/>11006: 
<a name="11007"/>11007:          %% *** Init part ***
<a name="11008"/>11008:          #{desc =&gt; &quot;which local address&quot;,
<a name="11009"/>11009:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="11010"/>11010:                            LSA = which_local_socket_addr(Domain),
<a name="11011"/>11011:                            {ok, State#{lsa =&gt; LSA}}
<a name="11012"/>11012:                    end},
<a name="11013"/>11013:          #{desc =&gt; &quot;create listen socket&quot;,
<a name="11014"/>11014:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="11015"/>11015:                            case socket:open(Domain, stream, tcp) of
<a name="11016"/>11016:                                {ok, Sock} -&gt;
<a name="11017"/>11017:                                    {ok, State#{lsock =&gt; Sock}};
<a name="11018"/>11018:                                {error, _} = ERROR -&gt;
<a name="11019"/>11019:                                    ERROR
<a name="11020"/>11020:                            end
<a name="11021"/>11021:                    end},
<a name="11022"/>11022:          #{desc =&gt; &quot;bind to local address&quot;,
<a name="11023"/>11023:            cmd  =&gt; fun(#{lsock := LSock, lsa := LSA} = State) -&gt;
<a name="11024"/>11024:                            case sock_bind(LSock, LSA) of
<a name="11025"/>11025:                                ok -&gt;
<a name="11026"/>11026:                                    Port = sock_port(LSock),
<a name="11027"/>11027:                                    {ok, State#{lport =&gt; Port}};
<a name="11028"/>11028:                                {error, _} = ERROR -&gt;
<a name="11029"/>11029:                                    ERROR
<a name="11030"/>11030:                            end
<a name="11031"/>11031:                    end},
<a name="11032"/>11032:          #{desc =&gt; &quot;make listen socket&quot;,
<a name="11033"/>11033:            cmd  =&gt; fun(#{lsock := LSock}) -&gt;
<a name="11034"/>11034:                            socket:listen(LSock)
<a name="11035"/>11035:                    end},
<a name="11036"/>11036:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="11037"/>11037:            cmd  =&gt; fun(#{tester := Tester, lsock := Sock}) -&gt;
<a name="11038"/>11038:                            ?SEV_ANNOUNCE_READY(Tester, init, Sock),
<a name="11039"/>11039:                            ok
<a name="11040"/>11040:                    end},
<a name="11041"/>11041: 
<a name="11042"/>11042:          %% The actual test
<a name="11043"/>11043:          #{desc =&gt; &quot;await continue (accept)&quot;,
<a name="11044"/>11044:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="11045"/>11045:                            ?SEV_AWAIT_CONTINUE(Tester, tester, accept)
<a name="11046"/>11046:                    end},
<a name="11047"/>11047:          #{desc =&gt; &quot;await connection (nowait)&quot;,
<a name="11048"/>11048:            cmd  =&gt; fun(#{lsock      := LSock,
<a name="11049"/>11049:                          accept     := Accept,
<a name="11050"/>11050:                          accept_ref := Ref} = State) -&gt;
<a name="11051"/>11051:                            case Accept(LSock) of
<a name="11052"/>11052:                                {select, {select_info, T, R} = SI}
<a name="11053"/>11053:                                  when Ref =:= nowait -&gt;
<a name="11054"/>11054:                                    ?SEV_IPRINT(&quot;accept select nowait: &quot;
<a name="11055"/>11055:                                                &quot;~n   T: ~p&quot;
<a name="11056"/>11056:                                                &quot;~n   R: ~p&quot;, [T, R]),
<a name="11057"/>11057:                                    {ok, State#{accept_select_info =&gt; SI}};
<a name="11058"/>11058:                                {select, {select_info, T, Ref} = SI}
<a name="11059"/>11059:                                  when is_reference(Ref) -&gt;
<a name="11060"/>11060:                                    ?SEV_IPRINT(&quot;accept select ref: &quot;
<a name="11061"/>11061:                                                &quot;~n   T: ~p&quot;
<a name="11062"/>11062:                                                &quot;~n   R: ~p&quot;, [T, Ref]),
<a name="11063"/>11063:                                    {ok, State#{accept_select_info =&gt; SI}};
<a name="11064"/>11064: 
<a name="11065"/>11065:                                {completion, {completion_info, T, R} = CI}
<a name="11066"/>11066:                                  when Ref =:= nowait -&gt;
<a name="11067"/>11067:                                    ?SEV_IPRINT(&quot;accept completion nowait: &quot;
<a name="11068"/>11068:                                                &quot;~n   T: ~p&quot;
<a name="11069"/>11069:                                                &quot;~n   R: ~p&quot;, [T, R]),
<a name="11070"/>11070:                                    {ok, State#{accept_completion_info =&gt; CI}};
<a name="11071"/>11071:                                {completion, {completion_info, T, Ref} = CI}
<a name="11072"/>11072:                                  when is_reference(Ref) -&gt;
<a name="11073"/>11073:                                    ?SEV_IPRINT(&quot;accept completion ref: &quot;
<a name="11074"/>11074:                                                &quot;~n   T: ~p&quot;
<a name="11075"/>11075:                                                &quot;~n   R: ~p&quot;, [T, Ref]),
<a name="11076"/>11076:                                    {ok, State#{accept_completion_info =&gt; CI}};
<a name="11077"/>11077: 
<a name="11078"/>11078:                                {ok, X} -&gt;
<a name="11079"/>11079:                                    {error, {unexpected_success, X}};
<a name="11080"/>11080: 
<a name="11081"/>11081:                                {error, _} = ERROR -&gt;
<a name="11082"/>11082:                                    ERROR
<a name="11083"/>11083:                            end
<a name="11084"/>11084:                    end},
<a name="11085"/>11085:          #{desc =&gt; &quot;announce ready (accept_select)&quot;,
<a name="11086"/>11086:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="11087"/>11087:                            ?SEV_ANNOUNCE_READY(Tester, accept_select),
<a name="11088"/>11088:                            ok
<a name="11089"/>11089:                    end},
<a name="11090"/>11090:          #{desc =&gt; &quot;await select message (without success)&quot;,
<a name="11091"/>11091:            cmd  =&gt; fun(#{lsock              := Sock,
<a name="11092"/>11092:                          accept_select_info := {select_info, _, Ref}} = State) -&gt;
<a name="11093"/>11093:                            receive
<a name="11094"/>11094:                                {'$socket', Sock, select, Ref} -&gt;
<a name="11095"/>11095:                                    {error, {unexpected_select, Ref}};
<a name="11096"/>11096:                                {'$socket', Sock, abort, {Ref, closed}} -&gt;
<a name="11097"/>11097:                                    {ok, maps:remove(lsock, State)}
<a name="11098"/>11098:                            after 5000 -&gt;
<a name="11099"/>11099:                                    ?SEV_EPRINT(&quot;timeout when: &quot;
<a name="11100"/>11100:                                                &quot;~n   Sock:          ~p&quot;
<a name="11101"/>11101:                                                &quot;~n   Ref:           ~p&quot;
<a name="11102"/>11102:                                                &quot;~n   message queue: ~p&quot;,
<a name="11103"/>11103:                                                [Sock, Ref, mq()]),
<a name="11104"/>11104:                                    {error, timeout}
<a name="11105"/>11105:                            end;
<a name="11106"/>11106:                       (#{lsock                  := Sock,
<a name="11107"/>11107:                          accept_completion_info := {completion_info, _, Ref}} = State) -&gt;
<a name="11108"/>11108:                            receive
<a name="11109"/>11109:                                {'$socket', Sock, completion, {Ref, _} = C} -&gt;
<a name="11110"/>11110:                                    {error, {unexpected_completion, C}};
<a name="11111"/>11111:                                {'$socket', Sock, abort, {Ref, closed}} -&gt;
<a name="11112"/>11112:                                    {ok, maps:remove(lsock, State)}
<a name="11113"/>11113:                            after 5000 -&gt;
<a name="11114"/>11114:                                    ?SEV_EPRINT(&quot;timeout when: &quot;
<a name="11115"/>11115:                                                &quot;~n   Sock:          ~p&quot;
<a name="11116"/>11116:                                                &quot;~n   Ref:           ~p&quot;
<a name="11117"/>11117:                                                &quot;~n   message queue: ~p&quot;,
<a name="11118"/>11118:                                                [Sock, Ref, mq()]),
<a name="11119"/>11119:                                    {error, timeout}
<a name="11120"/>11120:                            end
<a name="11121"/>11121:                    end},
<a name="11122"/>11122:          #{desc =&gt; &quot;announce ready (abort)&quot;,
<a name="11123"/>11123:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="11124"/>11124:                            ?SEV_ANNOUNCE_READY(Tester, abort),
<a name="11125"/>11125:                            ok
<a name="11126"/>11126:                    end},
<a name="11127"/>11127: 
<a name="11128"/>11128:          %% *** Termination ***
<a name="11129"/>11129:          #{desc =&gt; &quot;await terminate&quot;,
<a name="11130"/>11130:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="11131"/>11131:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="11132"/>11132:                                ok -&gt;
<a name="11133"/>11133:                                    {ok, maps:remove(tester, State)};
<a name="11134"/>11134:                                {error, _} = ERROR -&gt;
<a name="11135"/>11135:                                    ERROR
<a name="11136"/>11136:                            end
<a name="11137"/>11137:                    end},
<a name="11138"/>11138: 
<a name="11139"/>11139:          %% *** We are done ***
<a name="11140"/>11140:          ?SEV_FINISH_NORMAL
<a name="11141"/>11141:         ],
<a name="11142"/>11142: 
<a name="11143"/>11143: 
<a name="11144"/>11144:     AltServerSeq =
<a name="11145"/>11145:         [
<a name="11146"/>11146:          %% *** Wait for start order part ***
<a name="11147"/>11147:          #{desc =&gt; &quot;await start&quot;,
<a name="11148"/>11148:            cmd  =&gt; fun(State) -&gt;
<a name="11149"/>11149:                            {Tester, Sock} = ?SEV_AWAIT_START(),
<a name="11150"/>11150:                            {ok, State#{tester =&gt; Tester, lsock =&gt; Sock}}
<a name="11151"/>11151:                    end},
<a name="11152"/>11152:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="11153"/>11153:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="11154"/>11154:                            _MRef = erlang:monitor(process, Tester),
<a name="11155"/>11155:                            ok
<a name="11156"/>11156:                    end},
<a name="11157"/>11157:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="11158"/>11158:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="11159"/>11159:                            ?SEV_ANNOUNCE_READY(Tester, init),
<a name="11160"/>11160:                            ok
<a name="11161"/>11161:                    end},
<a name="11162"/>11162: 
<a name="11163"/>11163:          %% The actual test
<a name="11164"/>11164:          #{desc =&gt; &quot;await continue (accept)&quot;,
<a name="11165"/>11165:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="11166"/>11166:                            ?SEV_AWAIT_CONTINUE(Tester, tester, accept)
<a name="11167"/>11167:                    end},
<a name="11168"/>11168:          #{desc =&gt; &quot;try accept request (with nowait, expect select)&quot;,
<a name="11169"/>11169:            cmd  =&gt; fun(#{lsock      := Sock,
<a name="11170"/>11170:                          accept     := Accept,
<a name="11171"/>11171:                          accept_ref := Ref} = State) -&gt;
<a name="11172"/>11172:                            case Accept(Sock) of
<a name="11173"/>11173:                                {select, SI} when Ref =:= nowait -&gt;
<a name="11174"/>11174:                                    {ok, State#{accept_select_info =&gt; SI}};
<a name="11175"/>11175:                                {select, {select_info, _Tag, Ref} = SI}
<a name="11176"/>11176:                                  when is_reference(Ref) -&gt;
<a name="11177"/>11177:                                    {ok, State#{accept_select_info =&gt; SI}};
<a name="11178"/>11178: 
<a name="11179"/>11179:                                {completion, CI} when Ref =:= nowait -&gt;
<a name="11180"/>11180:                                    {ok, State#{accept_completion_info =&gt; CI}};
<a name="11181"/>11181:                                {completion, {completion_info, _Tag, Ref} = CI}
<a name="11182"/>11182:                                  when is_reference(Ref) -&gt;
<a name="11183"/>11183:                                    {ok, State#{accept_completion_info =&gt; CI}};
<a name="11184"/>11184: 
<a name="11185"/>11185:                                {ok, X} -&gt;
<a name="11186"/>11186:                                    {error, {unexpected_success, X}};
<a name="11187"/>11187: 
<a name="11188"/>11188:                                {error, _} = ERROR -&gt;
<a name="11189"/>11189:                                    ERROR
<a name="11190"/>11190:                            end
<a name="11191"/>11191:                    end},
<a name="11192"/>11192:          #{desc =&gt; &quot;announce ready (accept_select)&quot;,
<a name="11193"/>11193:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="11194"/>11194:                            ?SEV_ANNOUNCE_READY(Tester, accept_select),
<a name="11195"/>11195:                            ok
<a name="11196"/>11196:                    end},
<a name="11197"/>11197:          #{desc =&gt; &quot;await abort message&quot;,
<a name="11198"/>11198:            cmd  =&gt; fun(#{lsock              := Sock,
<a name="11199"/>11199:                          accept_select_info := {select_info, _, Ref}} = State) -&gt;
<a name="11200"/>11200:                            receive
<a name="11201"/>11201:                                {'$socket', Sock, select, Ref} -&gt;
<a name="11202"/>11202:                                    {error, {unexpected_select, Ref}};
<a name="11203"/>11203:                                {'$socket', Sock, abort, {Ref, closed}} -&gt;
<a name="11204"/>11204:                                    {ok, maps:remove(sock, State)}
<a name="11205"/>11205:                            after 5000 -&gt;
<a name="11206"/>11206:                                    ?SEV_EPRINT(&quot;timeout when: &quot;
<a name="11207"/>11207:                                                &quot;~n   Sock:          ~p&quot;
<a name="11208"/>11208:                                                &quot;~n   Ref:           ~p&quot;
<a name="11209"/>11209:                                                &quot;~n   message queue: ~p&quot;,
<a name="11210"/>11210:                                                [Sock, Ref, mq()]),
<a name="11211"/>11211:                                    {error, timeout}
<a name="11212"/>11212:                            end;
<a name="11213"/>11213:                       (#{lsock              := Sock,
<a name="11214"/>11214:                          accept_completion_info := {completion_info, _, Ref}} = State) -&gt;
<a name="11215"/>11215:                            receive
<a name="11216"/>11216:                                {'$socket', Sock, completion, {Ref, _} = C} -&gt;
<a name="11217"/>11217:                                    {error, {unexpected_completion, C}};
<a name="11218"/>11218:                                {'$socket', Sock, abort, {Ref, closed}} -&gt;
<a name="11219"/>11219:                                    {ok, maps:remove(sock, State)}
<a name="11220"/>11220:                            after 5000 -&gt;
<a name="11221"/>11221:                                    ?SEV_EPRINT(&quot;timeout when: &quot;
<a name="11222"/>11222:                                                &quot;~n   Sock:          ~p&quot;
<a name="11223"/>11223:                                                &quot;~n   Ref:           ~p&quot;
<a name="11224"/>11224:                                                &quot;~n   message queue: ~p&quot;,
<a name="11225"/>11225:                                                [Sock, Ref, mq()]),
<a name="11226"/>11226:                                    {error, timeout}
<a name="11227"/>11227:                            end
<a name="11228"/>11228:                    end},
<a name="11229"/>11229:          #{desc =&gt; &quot;announce ready (abort)&quot;,
<a name="11230"/>11230:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="11231"/>11231:                            ?SEV_ANNOUNCE_READY(Tester, abort),
<a name="11232"/>11232:                            ok
<a name="11233"/>11233:                    end},
<a name="11234"/>11234: 
<a name="11235"/>11235:          %% Termination
<a name="11236"/>11236:          #{desc =&gt; &quot;await terminate (from tester)&quot;,
<a name="11237"/>11237:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="11238"/>11238:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="11239"/>11239:                                ok -&gt;
<a name="11240"/>11240:                                    ?SEV_IPRINT(&quot;terminating&quot;),
<a name="11241"/>11241:                                    State1 = maps:remove(tester,             State),
<a name="11242"/>11242:                                    State2 = maps:remove(accept_select_info, State1),
<a name="11243"/>11243:                                    State3 = maps:remove(accept_completion_info, State2),
<a name="11244"/>11244:                                    State4 = maps:remove(lsock,              State3),
<a name="11245"/>11245:                                    {ok, State4};
<a name="11246"/>11246:                                {error, _} = ERROR -&gt;
<a name="11247"/>11247:                                    ERROR
<a name="11248"/>11248:                            end
<a name="11249"/>11249:                    end},
<a name="11250"/>11250: 
<a name="11251"/>11251:          %% *** We are done ***
<a name="11252"/>11252:          ?SEV_FINISH_NORMAL
<a name="11253"/>11253:         ],
<a name="11254"/>11254: 
<a name="11255"/>11255: 
<a name="11256"/>11256:     TesterSeq =
<a name="11257"/>11257:         [
<a name="11258"/>11258:          %% *** Init part ***
<a name="11259"/>11259:          #{desc =&gt; &quot;monitor server&quot;,
<a name="11260"/>11260:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="11261"/>11261:                            _MRef = erlang:monitor(process, Pid),
<a name="11262"/>11262:                            ok
<a name="11263"/>11263:                    end},
<a name="11264"/>11264:          #{desc =&gt; &quot;monitor alt-server 1&quot;,
<a name="11265"/>11265:            cmd  =&gt; fun(#{alt_server1 := Pid} = _State) -&gt;
<a name="11266"/>11266:                            _MRef = erlang:monitor(process, Pid),
<a name="11267"/>11267:                            ok
<a name="11268"/>11268:                    end},
<a name="11269"/>11269:          #{desc =&gt; &quot;monitor alt-server 2&quot;,
<a name="11270"/>11270:            cmd  =&gt; fun(#{alt_server2 := Pid} = _State) -&gt;
<a name="11271"/>11271:                            _MRef = erlang:monitor(process, Pid),
<a name="11272"/>11272:                            ok
<a name="11273"/>11273:                    end},
<a name="11274"/>11274: 
<a name="11275"/>11275:          %% Start the server
<a name="11276"/>11276:          #{desc =&gt; &quot;order server start&quot;,
<a name="11277"/>11277:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="11278"/>11278:                            ?SEV_ANNOUNCE_START(Pid),
<a name="11279"/>11279:                            ok
<a name="11280"/>11280:                    end},
<a name="11281"/>11281:          #{desc =&gt; &quot;await server ready (init)&quot;,
<a name="11282"/>11282:            cmd  =&gt; fun(#{server := Pid} = State) -&gt;
<a name="11283"/>11283:                            {ok, Sock} = ?SEV_AWAIT_READY(Pid, server, init),
<a name="11284"/>11284:                            {ok, State#{sock =&gt; Sock}}
<a name="11285"/>11285:                    end},
<a name="11286"/>11286: 
<a name="11287"/>11287:          %% Start the alt-server 1
<a name="11288"/>11288:          #{desc =&gt; &quot;order alt-server 1 start&quot;,
<a name="11289"/>11289:            cmd  =&gt; fun(#{alt_server1 := Pid, sock := Sock} = _State) -&gt;
<a name="11290"/>11290:                            ?SEV_ANNOUNCE_START(Pid, Sock),
<a name="11291"/>11291:                            ok
<a name="11292"/>11292:                    end},
<a name="11293"/>11293:          #{desc =&gt; &quot;await alt-server 1 ready (init)&quot;,
<a name="11294"/>11294:            cmd  =&gt; fun(#{alt_server1 := Pid} = _State) -&gt;
<a name="11295"/>11295:                            ?SEV_AWAIT_READY(Pid, alt_server1, init)
<a name="11296"/>11296:                    end},
<a name="11297"/>11297: 
<a name="11298"/>11298:          %% Start the alt-server 2
<a name="11299"/>11299:          #{desc =&gt; &quot;order alt-server 2 start&quot;,
<a name="11300"/>11300:            cmd  =&gt; fun(#{alt_server2 := Pid, sock := Sock} = _State) -&gt;
<a name="11301"/>11301:                            ?SEV_ANNOUNCE_START(Pid, Sock),
<a name="11302"/>11302:                            ok
<a name="11303"/>11303:                    end},
<a name="11304"/>11304:          #{desc =&gt; &quot;await alt-server 2 ready (init)&quot;,
<a name="11305"/>11305:            cmd  =&gt; fun(#{alt_server2 := Pid} = _State) -&gt;
<a name="11306"/>11306:                            ?SEV_AWAIT_READY(Pid, alt_server2, init)
<a name="11307"/>11307:                    end},
<a name="11308"/>11308: 
<a name="11309"/>11309: 
<a name="11310"/>11310:          %% *** The actual test ***
<a name="11311"/>11311:          #{desc =&gt; &quot;order server continue (accept)&quot;,
<a name="11312"/>11312:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="11313"/>11313:                            ?SEV_ANNOUNCE_CONTINUE(Pid, accept),
<a name="11314"/>11314:                            ok
<a name="11315"/>11315:                    end},
<a name="11316"/>11316:          #{desc =&gt; &quot;await server ready (accept select)&quot;,
<a name="11317"/>11317:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="11318"/>11318:                            ok = ?SEV_AWAIT_READY(Pid, server, accept_select)
<a name="11319"/>11319:                    end},
<a name="11320"/>11320: 
<a name="11321"/>11321:          #{desc =&gt; &quot;order alt-server 1 continue (accept)&quot;,
<a name="11322"/>11322:            cmd  =&gt; fun(#{alt_server1 := Pid} = _State) -&gt;
<a name="11323"/>11323:                            ?SEV_ANNOUNCE_CONTINUE(Pid, accept),
<a name="11324"/>11324:                            ok
<a name="11325"/>11325:                    end},
<a name="11326"/>11326:          #{desc =&gt; &quot;await alt-server 1 ready (accept select)&quot;,
<a name="11327"/>11327:            cmd  =&gt; fun(#{alt_server1 := Pid} = _State) -&gt;
<a name="11328"/>11328:                            ok = ?SEV_AWAIT_READY(Pid, alt_server1, accept_select)
<a name="11329"/>11329:                    end},
<a name="11330"/>11330: 
<a name="11331"/>11331:          #{desc =&gt; &quot;order alt-server 2 continue (accept)&quot;,
<a name="11332"/>11332:            cmd  =&gt; fun(#{alt_server2 := Pid} = _State) -&gt;
<a name="11333"/>11333:                            ?SEV_ANNOUNCE_CONTINUE(Pid, accept),
<a name="11334"/>11334:                            ok
<a name="11335"/>11335:                    end},
<a name="11336"/>11336:          #{desc =&gt; &quot;await alt-server 2 ready (accept select)&quot;,
<a name="11337"/>11337:            cmd  =&gt; fun(#{alt_server2 := Pid} = _State) -&gt;
<a name="11338"/>11338:                            ok = ?SEV_AWAIT_READY(Pid, alt_server2, accept_select)
<a name="11339"/>11339:                    end},
<a name="11340"/>11340: 
<a name="11341"/>11341:          ?SEV_SLEEP(?SECS(1)),
<a name="11342"/>11342: 
<a name="11343"/>11343:          #{desc =&gt; &quot;close the socket&quot;,
<a name="11344"/>11344:            cmd  =&gt; fun(#{sock := Sock} = _State) -&gt;
<a name="11345"/>11345:                            socket:close(Sock)
<a name="11346"/>11346:                    end},
<a name="11347"/>11347: 
<a name="11348"/>11348:          #{desc =&gt; &quot;await server ready (abort)&quot;,
<a name="11349"/>11349:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="11350"/>11350:                            ok = ?SEV_AWAIT_READY(Pid, server, abort)
<a name="11351"/>11351:                    end},
<a name="11352"/>11352:          #{desc =&gt; &quot;await alt-server 1 ready (abort)&quot;,
<a name="11353"/>11353:            cmd  =&gt; fun(#{alt_server1 := Pid} = _State) -&gt;
<a name="11354"/>11354:                            ok = ?SEV_AWAIT_READY(Pid, alt_server1, abort)
<a name="11355"/>11355:                    end},
<a name="11356"/>11356:          #{desc =&gt; &quot;await alt-server 2 ready (abort)&quot;,
<a name="11357"/>11357:            cmd  =&gt; fun(#{alt_server2 := Pid} = _State) -&gt;
<a name="11358"/>11358:                            ok = ?SEV_AWAIT_READY(Pid, alt_server2, abort)
<a name="11359"/>11359:                    end},
<a name="11360"/>11360: 
<a name="11361"/>11361: 
<a name="11362"/>11362:          %% *** Termination ***
<a name="11363"/>11363:          #{desc =&gt; &quot;order alt-server 2 to terminate&quot;,
<a name="11364"/>11364:            cmd  =&gt; fun(#{alt_server2 := Pid} = _State) -&gt;
<a name="11365"/>11365:                            ?SEV_ANNOUNCE_TERMINATE(Pid),
<a name="11366"/>11366:                            ok
<a name="11367"/>11367:                    end},
<a name="11368"/>11368:          #{desc =&gt; &quot;await alt-server 2 termination&quot;,
<a name="11369"/>11369:            cmd  =&gt; fun(#{alt_server2 := Pid} = State) -&gt;
<a name="11370"/>11370:                            case ?SEV_AWAIT_TERMINATION(Pid) of
<a name="11371"/>11371:                                ok -&gt;
<a name="11372"/>11372:                                    State1 = maps:remove(alt_server2, State),
<a name="11373"/>11373:                                    {ok, State1};
<a name="11374"/>11374:                                {error, _} = ERROR -&gt;
<a name="11375"/>11375:                                    ERROR
<a name="11376"/>11376:                            end
<a name="11377"/>11377:                    end},
<a name="11378"/>11378: 
<a name="11379"/>11379:          #{desc =&gt; &quot;order alt-server 1 to terminate&quot;,
<a name="11380"/>11380:            cmd  =&gt; fun(#{alt_server1 := Pid} = _State) -&gt;
<a name="11381"/>11381:                            ?SEV_ANNOUNCE_TERMINATE(Pid),
<a name="11382"/>11382:                            ok
<a name="11383"/>11383:                    end},
<a name="11384"/>11384:          #{desc =&gt; &quot;await alt-server 1 termination&quot;,
<a name="11385"/>11385:            cmd  =&gt; fun(#{alt_server1 := Pid} = State) -&gt;
<a name="11386"/>11386:                            case ?SEV_AWAIT_TERMINATION(Pid) of
<a name="11387"/>11387:                                ok -&gt;
<a name="11388"/>11388:                                    State1 = maps:remove(alt_server1, State),
<a name="11389"/>11389:                                    {ok, State1};
<a name="11390"/>11390:                                {error, _} = ERROR -&gt;
<a name="11391"/>11391:                                    ERROR
<a name="11392"/>11392:                            end
<a name="11393"/>11393:                    end},
<a name="11394"/>11394: 
<a name="11395"/>11395:          #{desc =&gt; &quot;order server to terminate&quot;,
<a name="11396"/>11396:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="11397"/>11397:                            ?SEV_ANNOUNCE_TERMINATE(Server),
<a name="11398"/>11398:                            ok
<a name="11399"/>11399:                    end},
<a name="11400"/>11400:          #{desc =&gt; &quot;await server termination&quot;,
<a name="11401"/>11401:            cmd  =&gt; fun(#{server := Server} = State) -&gt;
<a name="11402"/>11402:                            ?SEV_AWAIT_TERMINATION(Server),
<a name="11403"/>11403:                            State1 = maps:remove(server, State),
<a name="11404"/>11404:                            {ok, State1}
<a name="11405"/>11405:                    end},
<a name="11406"/>11406: 
<a name="11407"/>11407:          %% *** We are done ***
<a name="11408"/>11408:          ?SEV_FINISH_NORMAL
<a name="11409"/>11409:         ],
<a name="11410"/>11410: 
<a name="11411"/>11411:     i(&quot;start server evaluator&quot;),
<a name="11412"/>11412:     Server = ?SEV_START(&quot;server&quot;, ServerSeq, InitState),
<a name="11413"/>11413: 
<a name="11414"/>11414:     i(&quot;start alt-server 1 evaluator&quot;),
<a name="11415"/>11415:     AltServer1 = ?SEV_START(&quot;alt_server1&quot;, AltServerSeq, InitState),
<a name="11416"/>11416: 
<a name="11417"/>11417:     i(&quot;start alt-server 2 evaluator&quot;),
<a name="11418"/>11418:     AltServer2 = ?SEV_START(&quot;alt_server2&quot;, AltServerSeq, InitState),
<a name="11419"/>11419: 
<a name="11420"/>11420:     i(&quot;start tester evaluator&quot;),
<a name="11421"/>11421:     TesterInitState = #{server      =&gt; Server#ev.pid,
<a name="11422"/>11422:                         alt_server1 =&gt; AltServer1#ev.pid,
<a name="11423"/>11423:                         alt_server2 =&gt; AltServer2#ev.pid},
<a name="11424"/>11424:     Tester = ?SEV_START(&quot;tester&quot;, TesterSeq, TesterInitState),
<a name="11425"/>11425: 
<a name="11426"/>11426:     i(&quot;await evaluator(s)&quot;),
<a name="api_a_maccept_cancel_tcp-last_expr"/><a name="11427"/>11427: <b>    ok = ?SEV_AWAIT_FINISH</b>([Server, AltServer1, AltServer2, Tester]).
<a name="11428"/>11428: 
<a name="11429"/>11429: 
<a name="11430"/>11430: 
<a name="11431"/>11431: 
<a name="11432"/>11432: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="11433"/>11433: 
<a name="11434"/>11434: <i>%% Basically we make multiple async (Timeout = nowait) call(s) to recv</i>
<a name="11435"/>11435: <i>%% (from *several* processes), wait some time and then cancel,</i>
<a name="11436"/>11436: <i>%% This should result in abort messages to the 'other' processes. IPv4</i>
<a name="11437"/>11437: <i>%%</i>
<a name="api_a_mrecv_cancel_tcp4-1"/><a name="11438"/>11438: <b>api_a_mrecv_cancel_tcp4</b>(Config) when is_list(Config) -&gt;
<a name="11439"/>11439:     ?TT(?SECS(20)),
<a name="11440"/>11440:     Nowait = nowait(Config),
<a name="api_a_mrecv_cancel_tcp4-last_expr"/><a name="11441"/>11441: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="11442"/>11442:            fun() -&gt; has_support_ipv4() end,
<a name="11443"/>11443:            fun() -&gt;
<a name="11444"/>11444:                    Recv = fun(Sock) -&gt;
<a name="11445"/>11445:                                   socket:recv(Sock, 0, Nowait)
<a name="11446"/>11446:                           end,
<a name="11447"/>11447:                    InitState = #{domain   =&gt; inet,
<a name="11448"/>11448:                                  recv     =&gt; Recv,
<a name="11449"/>11449:                                  recv_ref =&gt; Nowait},
<a name="11450"/>11450:                    ok = api_a_mrecv_cancel_tcp(InitState)
<a name="11451"/>11451:            end).
<a name="11452"/>11452: 
<a name="11453"/>11453: 
<a name="11454"/>11454: 
<a name="11455"/>11455: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="11456"/>11456: 
<a name="11457"/>11457: <i>%% Basically we make multiple async (Timeout = nowait) call(s) to recv</i>
<a name="11458"/>11458: <i>%% (from *several* processes), wait some time and then cancel,</i>
<a name="11459"/>11459: <i>%% This should result in abort messages to the 'other' processes. IPv6</i>
<a name="11460"/>11460: <i>%%</i>
<a name="api_a_mrecv_cancel_tcp6-1"/><a name="11461"/>11461: <b>api_a_mrecv_cancel_tcp6</b>(Config) when is_list(Config) -&gt;
<a name="11462"/>11462:     ?TT(?SECS(20)),
<a name="11463"/>11463:     Nowait = nowait(Config),
<a name="api_a_mrecv_cancel_tcp6-last_expr"/><a name="11464"/>11464: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="11465"/>11465:            fun() -&gt; has_support_ipv6() end,
<a name="11466"/>11466:            fun() -&gt;
<a name="11467"/>11467:                    Recv = fun(Sock) -&gt;
<a name="11468"/>11468:                                   socket:recv(Sock, 0, Nowait)
<a name="11469"/>11469:                           end,
<a name="11470"/>11470:                    InitState = #{domain   =&gt; inet6,
<a name="11471"/>11471:                                  recv     =&gt; Recv,
<a name="11472"/>11472:                                  recv_ref =&gt; Nowait},
<a name="11473"/>11473:                    ok = api_a_mrecv_cancel_tcp(InitState)
<a name="11474"/>11474:            end).
<a name="11475"/>11475: 
<a name="11476"/>11476: 
<a name="11477"/>11477: 
<a name="11478"/>11478: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="11479"/>11479: 
<a name="11480"/>11480: <i>%% Basically we make multiple async (Timeout = nowait) call(s) to recvmsg</i>
<a name="11481"/>11481: <i>%% (from *several* processes), wait some time and then cancel,</i>
<a name="11482"/>11482: <i>%% This should result in abort messages to the 'other' processes. IPv4</i>
<a name="11483"/>11483: <i>%%</i>
<a name="api_a_mrecvmsg_cancel_tcp4-1"/><a name="11484"/>11484: <b>api_a_mrecvmsg_cancel_tcp4</b>(Config) when is_list(Config) -&gt;
<a name="11485"/>11485:     ?TT(?SECS(20)),
<a name="11486"/>11486:     Nowait = nowait(Config),
<a name="api_a_mrecvmsg_cancel_tcp4-last_expr"/><a name="11487"/>11487: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="11488"/>11488:            fun() -&gt;
<a name="11489"/>11489:                    is_not_windows(),
<a name="11490"/>11490:                    has_support_ipv4()
<a name="11491"/>11491:            end,
<a name="11492"/>11492:            fun() -&gt;
<a name="11493"/>11493:                    Recv = fun(Sock) -&gt;
<a name="11494"/>11494:                                   socket:recvmsg(Sock, Nowait)
<a name="11495"/>11495:                           end,
<a name="11496"/>11496:                    InitState = #{domain   =&gt; inet,
<a name="11497"/>11497:                                  recv     =&gt; Recv,
<a name="11498"/>11498:                                  recv_ref =&gt; Nowait},
<a name="11499"/>11499:                    ok = api_a_mrecv_cancel_tcp(InitState)
<a name="11500"/>11500:            end).
<a name="11501"/>11501: 
<a name="11502"/>11502: 
<a name="11503"/>11503: 
<a name="11504"/>11504: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="11505"/>11505: 
<a name="11506"/>11506: <i>%% Basically we make multiple async (Timeout = nowait) call(s) to recvmsg</i>
<a name="11507"/>11507: <i>%% (from *several* processes), wait some time and then cancel,</i>
<a name="11508"/>11508: <i>%% This should result in abort messages to the 'other' processes. IPv6</i>
<a name="11509"/>11509: <i>%%</i>
<a name="api_a_mrecvmsg_cancel_tcp6-1"/><a name="11510"/>11510: <b>api_a_mrecvmsg_cancel_tcp6</b>(Config) when is_list(Config) -&gt;
<a name="11511"/>11511:     ?TT(?SECS(20)),
<a name="11512"/>11512:     Nowait = nowait(Config),
<a name="api_a_mrecvmsg_cancel_tcp6-last_expr"/><a name="11513"/>11513: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="11514"/>11514:            fun() -&gt;
<a name="11515"/>11515:                    is_not_windows(),
<a name="11516"/>11516:                    has_support_ipv6()
<a name="11517"/>11517:            end,
<a name="11518"/>11518:            fun() -&gt;
<a name="11519"/>11519:                    Recv = fun(Sock) -&gt;
<a name="11520"/>11520:                                   socket:recvmsg(Sock, Nowait)
<a name="11521"/>11521:                           end,
<a name="11522"/>11522:                    InitState = #{domain   =&gt; inet6,
<a name="11523"/>11523:                                  recv     =&gt; Recv,
<a name="11524"/>11524:                                  recv_ref =&gt; Nowait},
<a name="11525"/>11525:                    ok = api_a_mrecv_cancel_tcp(InitState)
<a name="11526"/>11526:            end).
<a name="11527"/>11527: 
<a name="11528"/>11528: 
<a name="11529"/>11529: 
<a name="11530"/>11530: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="11531"/>11531: 
<a name="api_a_mrecv_cancel_tcp-1"/><a name="11532"/>11532: <b>api_a_mrecv_cancel_tcp</b>(InitState) -&gt;
<a name="11533"/>11533:     process_flag(trap_exit, true),
<a name="11534"/>11534:     ServerSeq = 
<a name="11535"/>11535:         [
<a name="11536"/>11536:          %% *** Wait for start order ***
<a name="11537"/>11537:          #{desc =&gt; &quot;await start (from tester)&quot;,
<a name="11538"/>11538:            cmd  =&gt; fun(State) -&gt;
<a name="11539"/>11539:                            Tester = ?SEV_AWAIT_START(),
<a name="11540"/>11540:                            {ok, State#{tester =&gt; Tester}}
<a name="11541"/>11541:                    end},
<a name="11542"/>11542:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="11543"/>11543:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="11544"/>11544:                            _MRef = erlang:monitor(process, Tester),
<a name="11545"/>11545:                            ok
<a name="11546"/>11546:                    end},
<a name="11547"/>11547: 
<a name="11548"/>11548:          %% *** Init part ***
<a name="11549"/>11549:          #{desc =&gt; &quot;which local address&quot;,
<a name="11550"/>11550:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="11551"/>11551:                            LSA = which_local_socket_addr(Domain),
<a name="11552"/>11552:                            {ok, State#{lsa =&gt; LSA}}
<a name="11553"/>11553:                    end},
<a name="11554"/>11554:          #{desc =&gt; &quot;create listen socket&quot;,
<a name="11555"/>11555:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="11556"/>11556:                            case socket:open(Domain, stream, tcp) of
<a name="11557"/>11557:                                {ok, Sock} -&gt;
<a name="11558"/>11558:                                    {ok, State#{lsock =&gt; Sock}};
<a name="11559"/>11559:                                {error, _} = ERROR -&gt;
<a name="11560"/>11560:                                    ERROR
<a name="11561"/>11561:                            end
<a name="11562"/>11562:                    end},
<a name="11563"/>11563:          #{desc =&gt; &quot;bind to local address&quot;,
<a name="11564"/>11564:            cmd  =&gt; fun(#{lsock := LSock, lsa := LSA} = State) -&gt;
<a name="11565"/>11565:                            case sock_bind(LSock, LSA) of
<a name="11566"/>11566:                                ok -&gt;
<a name="11567"/>11567:                                    Port = sock_port(LSock),
<a name="11568"/>11568:                                    {ok, State#{lport =&gt; Port}};
<a name="11569"/>11569:                                {error, _} = ERROR -&gt;
<a name="11570"/>11570:                                    ERROR
<a name="11571"/>11571:                            end
<a name="11572"/>11572:                    end},
<a name="11573"/>11573:          #{desc =&gt; &quot;make listen socket&quot;,
<a name="11574"/>11574:            cmd  =&gt; fun(#{lsock := LSock}) -&gt;
<a name="11575"/>11575:                            socket:listen(LSock)
<a name="11576"/>11576:                    end},
<a name="11577"/>11577:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="11578"/>11578:            cmd  =&gt; fun(#{tester := Tester, lport := Port}) -&gt;
<a name="11579"/>11579:                            ?SEV_ANNOUNCE_READY(Tester, init, Port),
<a name="11580"/>11580:                            ok
<a name="11581"/>11581:                    end},
<a name="11582"/>11582: 
<a name="11583"/>11583:          %% The actual test
<a name="11584"/>11584:          #{desc =&gt; &quot;await continue (accept)&quot;,
<a name="11585"/>11585:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="11586"/>11586:                            ?SEV_AWAIT_CONTINUE(Tester, tester, accept)
<a name="11587"/>11587:                    end},
<a name="11588"/>11588:          #{desc =&gt; &quot;await connection&quot;,
<a name="11589"/>11589:            cmd  =&gt; fun(#{lsock := LSock} = State) -&gt;
<a name="11590"/>11590:                            case socket:accept(LSock) of
<a name="11591"/>11591:                                {ok, CSock} -&gt;
<a name="11592"/>11592:                                    {ok, State#{csock =&gt; CSock}};
<a name="11593"/>11593:                                {error, _} = ERROR -&gt;
<a name="11594"/>11594:                                    ERROR
<a name="11595"/>11595:                            end
<a name="11596"/>11596:                    end},
<a name="11597"/>11597:          #{desc =&gt; &quot;announce ready (accept)&quot;,
<a name="11598"/>11598:            cmd  =&gt; fun(#{tester := Tester, csock := Sock}) -&gt;
<a name="11599"/>11599:                            ?SEV_ANNOUNCE_READY(Tester, accept, Sock),
<a name="11600"/>11600:                            ok
<a name="11601"/>11601:                    end},
<a name="11602"/>11602: 
<a name="11603"/>11603:          #{desc =&gt; &quot;await continue (nowait recv)&quot;,
<a name="11604"/>11604:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="11605"/>11605:                            ?SEV_AWAIT_CONTINUE(Tester, tester, recv)
<a name="11606"/>11606:                    end},
<a name="11607"/>11607:          #{desc =&gt; &quot;try recv request (with nowait, expect select|completion)&quot;,
<a name="11608"/>11608:            cmd  =&gt; fun(#{csock    := Sock,
<a name="11609"/>11609:                          recv     := Recv,
<a name="11610"/>11610:                          recv_ref := Ref} = State) -&gt;
<a name="11611"/>11611:                            case Recv(Sock) of
<a name="11612"/>11612:                                {select, {select_info, T, R} = SI}
<a name="11613"/>11613:                                  when Ref =:= nowait -&gt;
<a name="11614"/>11614:                                    ?SEV_IPRINT(&quot;recv select nowait: &quot;
<a name="11615"/>11615:                                                &quot;~n   Tag: ~p&quot;
<a name="11616"/>11616:                                                &quot;~n   Ref: ~p&quot;, [T, R]),
<a name="11617"/>11617:                                    {ok, State#{recv_select_info =&gt; SI}};
<a name="11618"/>11618:                                {select, {select_info, T, Ref} = SI}
<a name="11619"/>11619:                                  when is_reference(Ref) -&gt;
<a name="11620"/>11620:                                    ?SEV_IPRINT(&quot;recv select nowait: &quot;
<a name="11621"/>11621:                                                &quot;~n   Tag: ~p&quot;
<a name="11622"/>11622:                                                &quot;~n   Ref: ~p&quot;, [T, Ref]),
<a name="11623"/>11623:                                    {ok, State#{recv_select_info =&gt; SI}};
<a name="11624"/>11624: 
<a name="11625"/>11625:                                {completion, {completion_info, T, R} = CI}
<a name="11626"/>11626:                                  when Ref =:= nowait -&gt;
<a name="11627"/>11627:                                    ?SEV_IPRINT(&quot;recv completion nowait: &quot;
<a name="11628"/>11628:                                                &quot;~n   Tag: ~p&quot;
<a name="11629"/>11629:                                                &quot;~n   Ref: ~p&quot;, [T, R]),
<a name="11630"/>11630:                                    {ok, State#{recv_completion_info =&gt; CI}};
<a name="11631"/>11631:                                {completion, {completion_info, T, Ref} = CI}
<a name="11632"/>11632:                                  when is_reference(Ref) -&gt;
<a name="11633"/>11633:                                    ?SEV_IPRINT(&quot;recv completion nowait: &quot;
<a name="11634"/>11634:                                                &quot;~n   Tag: ~p&quot;
<a name="11635"/>11635:                                                &quot;~n   Ref: ~p&quot;, [T, Ref]),
<a name="11636"/>11636:                                    {ok, State#{recv_completion_info =&gt; CI}};
<a name="11637"/>11637: 
<a name="11638"/>11638:                                {ok, X} -&gt;
<a name="11639"/>11639:                                    {error, {unexpected_success, X}};
<a name="11640"/>11640: 
<a name="11641"/>11641:                                {error, _} = ERROR -&gt;
<a name="11642"/>11642:                                    ERROR
<a name="11643"/>11643:                            end
<a name="11644"/>11644:                    end},
<a name="11645"/>11645:          #{desc =&gt; &quot;announce ready (recv_select)&quot;,
<a name="11646"/>11646:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="11647"/>11647:                            ?SEV_ANNOUNCE_READY(Tester, recv_select),
<a name="11648"/>11648:                            ok
<a name="11649"/>11649:                    end},
<a name="11650"/>11650:          #{desc =&gt; &quot;await select|completion message&quot;,
<a name="11651"/>11651:            cmd  =&gt; fun(#{csock            := Sock,
<a name="11652"/>11652:                          recv_select_info := {select_info, _, Ref}} = State) -&gt;
<a name="11653"/>11653:                            receive
<a name="11654"/>11654:                                {'$socket', Sock, select, Ref} -&gt;
<a name="11655"/>11655:                                    {error, {unexpected_select, Ref}};
<a name="11656"/>11656:                                {'$socket', Sock, abort, {Ref, closed}} -&gt;
<a name="11657"/>11657:                                    {ok, maps:remove(sock, State)}
<a name="11658"/>11658:                            after 5000 -&gt;
<a name="11659"/>11659:                                    ok
<a name="11660"/>11660:                            end;
<a name="11661"/>11661:                       (#{csock                := Sock,
<a name="11662"/>11662:                          recv_completion_info := {completion_info, _, Ref}} = State) -&gt;
<a name="11663"/>11663:                            receive
<a name="11664"/>11664:                                {'$socket', Sock, completion, {Ref, _} = C} -&gt;
<a name="11665"/>11665:                                    {error, {unexpected_completion, C}};
<a name="11666"/>11666:                                {'$socket', Sock, abort, {Ref, closed}} -&gt;
<a name="11667"/>11667:                                    {ok, maps:remove(sock, State)}
<a name="11668"/>11668:                            after 5000 -&gt;
<a name="11669"/>11669:                                    ok
<a name="11670"/>11670:                            end
<a name="11671"/>11671:                    end},
<a name="11672"/>11672:          #{desc =&gt; &quot;announce ready (abort)&quot;,
<a name="11673"/>11673:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="11674"/>11674:                            ?SEV_ANNOUNCE_READY(Tester, abort),
<a name="11675"/>11675:                            ok
<a name="11676"/>11676:                    end},
<a name="11677"/>11677: 
<a name="11678"/>11678:          %% *** Termination ***
<a name="11679"/>11679:          #{desc =&gt; &quot;await terminate&quot;,
<a name="11680"/>11680:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="11681"/>11681:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="11682"/>11682:                                ok -&gt;
<a name="11683"/>11683:                                    {ok, maps:remove(tester, State)};
<a name="11684"/>11684:                                {error, _} = ERROR -&gt;
<a name="11685"/>11685:                                    ERROR
<a name="11686"/>11686:                            end
<a name="11687"/>11687:                    end},
<a name="11688"/>11688:          #{desc =&gt; &quot;close listen socket&quot;,
<a name="11689"/>11689:            cmd  =&gt; fun(#{lsock := Sock}) -&gt;
<a name="11690"/>11690:                            socket:close(Sock)
<a name="11691"/>11691:                    end},
<a name="11692"/>11692: 
<a name="11693"/>11693:          %% *** We are done ***
<a name="11694"/>11694:          ?SEV_FINISH_NORMAL
<a name="11695"/>11695:         ],
<a name="11696"/>11696: 
<a name="11697"/>11697:     AltServerSeq =
<a name="11698"/>11698:         [
<a name="11699"/>11699:          %% *** Wait for start order part ***
<a name="11700"/>11700:          #{desc =&gt; &quot;await start&quot;,
<a name="11701"/>11701:            cmd  =&gt; fun(State) -&gt;
<a name="11702"/>11702:                            {Tester, Sock} = ?SEV_AWAIT_START(),
<a name="11703"/>11703:                            {ok, State#{tester =&gt; Tester, sock =&gt; Sock}}
<a name="11704"/>11704:                    end},
<a name="11705"/>11705:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="11706"/>11706:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="11707"/>11707:                            _MRef = erlang:monitor(process, Tester),
<a name="11708"/>11708:                            ok
<a name="11709"/>11709:                    end},
<a name="11710"/>11710:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="11711"/>11711:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="11712"/>11712:                            ?SEV_ANNOUNCE_READY(Tester, init),
<a name="11713"/>11713:                            ok
<a name="11714"/>11714:                    end},
<a name="11715"/>11715: 
<a name="11716"/>11716:          %% The actual test
<a name="11717"/>11717:          #{desc =&gt; &quot;await continue (recv)&quot;,
<a name="11718"/>11718:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="11719"/>11719:                            ?SEV_AWAIT_CONTINUE(Tester, tester, recv)
<a name="11720"/>11720:                    end},
<a name="11721"/>11721:          #{desc =&gt; &quot;try recv request (with nowait, expect select)&quot;,
<a name="11722"/>11722:            cmd  =&gt; fun(#{sock     := Sock,
<a name="11723"/>11723:                          recv     := Recv,
<a name="11724"/>11724:                          recv_ref := Ref} = State) -&gt;
<a name="11725"/>11725:                            case Recv(Sock) of
<a name="11726"/>11726:                                {select, SI} when Ref =:= nowait -&gt;
<a name="11727"/>11727:                                    {ok, State#{recv_select_info =&gt; SI}};
<a name="11728"/>11728:                                {select, {select_info, _Tag, Ref} = SI}
<a name="11729"/>11729:                                  when is_reference(Ref) -&gt;
<a name="11730"/>11730:                                    {ok, State#{recv_select_info =&gt; SI}};
<a name="11731"/>11731: 
<a name="11732"/>11732:                                {completion, CI} when Ref =:= nowait -&gt;
<a name="11733"/>11733:                                    {ok, State#{recv_completion_info =&gt; CI}};
<a name="11734"/>11734:                                {completion, {completion_info, _Tag, Ref} = CI}
<a name="11735"/>11735:                                  when is_reference(Ref) -&gt;
<a name="11736"/>11736:                                    {ok, State#{recv_completion_info =&gt; CI}};
<a name="11737"/>11737: 
<a name="11738"/>11738:                                {ok, X} -&gt;
<a name="11739"/>11739:                                    {error, {unexpected_success, X}};
<a name="11740"/>11740: 
<a name="11741"/>11741:                                {error, _} = ERROR -&gt;
<a name="11742"/>11742:                                    ERROR
<a name="11743"/>11743:                            end
<a name="11744"/>11744:                    end},
<a name="11745"/>11745:          #{desc =&gt; &quot;announce ready (recv_select)&quot;,
<a name="11746"/>11746:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="11747"/>11747:                            ?SEV_ANNOUNCE_READY(Tester, recv_select),
<a name="11748"/>11748:                            ok
<a name="11749"/>11749:                    end},
<a name="11750"/>11750:          #{desc =&gt; &quot;await abort message&quot;,
<a name="11751"/>11751:            cmd  =&gt; fun(#{sock             := Sock,
<a name="11752"/>11752:                          recv_select_info := {select_info, _, Ref}} = State) -&gt;
<a name="11753"/>11753:                            receive
<a name="11754"/>11754:                                {'$socket', Sock, select, Ref} -&gt;
<a name="11755"/>11755:                                    {error, {unexpected_select, Ref}};
<a name="11756"/>11756:                                {'$socket', Sock, abort, {Ref, closed}} -&gt;
<a name="11757"/>11757:                                    {ok, maps:remove(sock, State)}
<a name="11758"/>11758:                            after 5000 -&gt;
<a name="11759"/>11759:                                    ?SEV_EPRINT(&quot;message queue: ~p&quot;, [mq()]),
<a name="11760"/>11760:                                    {error, timeout}
<a name="11761"/>11761:                            end;
<a name="11762"/>11762:                       (#{sock             := Sock,
<a name="11763"/>11763:                          recv_completion_info := {completion_info, _, Ref}} = State) -&gt;
<a name="11764"/>11764:                            receive
<a name="11765"/>11765:                                {'$socket', Sock, completion, {Ref, _} = C} -&gt;
<a name="11766"/>11766:                                    {error, {unexpected_completion, C}};
<a name="11767"/>11767:                                {'$socket', Sock, abort, {Ref, closed}} -&gt;
<a name="11768"/>11768:                                    {ok, maps:remove(sock, State)}
<a name="11769"/>11769:                            after 5000 -&gt;
<a name="11770"/>11770:                                    ?SEV_EPRINT(&quot;message queue: ~p&quot;, [mq()]),
<a name="11771"/>11771:                                    {error, timeout}
<a name="11772"/>11772:                            end
<a name="11773"/>11773:                    end},
<a name="11774"/>11774:          #{desc =&gt; &quot;announce ready (abort)&quot;,
<a name="11775"/>11775:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="11776"/>11776:                            ?SEV_ANNOUNCE_READY(Tester, abort),
<a name="11777"/>11777:                            ok
<a name="11778"/>11778:                    end},
<a name="11779"/>11779: 
<a name="11780"/>11780:          %% Termination
<a name="11781"/>11781:          #{desc =&gt; &quot;await terminate (from tester)&quot;,
<a name="11782"/>11782:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="11783"/>11783:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="11784"/>11784:                                ok -&gt;
<a name="11785"/>11785:                                    ?SEV_IPRINT(&quot;terminating&quot;),
<a name="11786"/>11786:                                    State1 = maps:remove(recv_select_info, State),
<a name="11787"/>11787:                                    State2 = maps:remove(recv_completion_info, State1),
<a name="11788"/>11788:                                    State3 = maps:remove(tester,           State2),
<a name="11789"/>11789:                                    State4 = maps:remove(sock,             State3),
<a name="11790"/>11790:                                    {ok, State4};
<a name="11791"/>11791:                                {error, _} = ERROR -&gt;
<a name="11792"/>11792:                                    ERROR
<a name="11793"/>11793:                            end
<a name="11794"/>11794:                    end},
<a name="11795"/>11795: 
<a name="11796"/>11796:          %% *** We are done ***
<a name="11797"/>11797:          ?SEV_FINISH_NORMAL
<a name="11798"/>11798:         ],
<a name="11799"/>11799: 
<a name="11800"/>11800:     ClientSeq = 
<a name="11801"/>11801:         [
<a name="11802"/>11802:          %% *** Wait for start order ***
<a name="11803"/>11803:          #{desc =&gt; &quot;await start (from tester)&quot;,
<a name="11804"/>11804:            cmd  =&gt; fun(State) -&gt;
<a name="11805"/>11805:                            {Tester, Port} = ?SEV_AWAIT_START(),
<a name="11806"/>11806:                            {ok, State#{tester =&gt; Tester, server_port =&gt; Port}}
<a name="11807"/>11807:                    end},
<a name="11808"/>11808:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="11809"/>11809:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="11810"/>11810:                            _MRef = erlang:monitor(process, Tester),
<a name="11811"/>11811:                            ok
<a name="11812"/>11812:                    end},
<a name="11813"/>11813: 
<a name="11814"/>11814:          %% *** The init part ***
<a name="11815"/>11815:          #{desc =&gt; &quot;which server (local) address&quot;,
<a name="11816"/>11816:            cmd  =&gt; fun(#{domain := Domain, server_port := Port} = State) -&gt;
<a name="11817"/>11817:                            LSA = which_local_socket_addr(Domain),
<a name="11818"/>11818:                            SSA = LSA#{port =&gt; Port},
<a name="11819"/>11819:                            {ok, State#{local_sa =&gt; LSA, server_sa =&gt; SSA}}
<a name="11820"/>11820:                    end},
<a name="11821"/>11821:          #{desc =&gt; &quot;create socket&quot;,
<a name="11822"/>11822:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="11823"/>11823:                            case socket:open(Domain, stream, tcp) of
<a name="11824"/>11824:                                {ok, Sock} -&gt;
<a name="11825"/>11825:                                    {ok, State#{sock =&gt; Sock}};
<a name="11826"/>11826:                                {error, _} = ERROR -&gt;
<a name="11827"/>11827:                                    ERROR
<a name="11828"/>11828:                            end
<a name="11829"/>11829:                    end},
<a name="11830"/>11830:          #{desc =&gt; &quot;bind to local address&quot;,
<a name="11831"/>11831:            cmd  =&gt; fun(#{sock := Sock, local_sa := LSA} = _State) -&gt;
<a name="11832"/>11832:                            case sock_bind(Sock, LSA) of
<a name="11833"/>11833:                                ok -&gt;
<a name="11834"/>11834:                                    ok;
<a name="11835"/>11835:                                {error, _} = ERROR -&gt;
<a name="11836"/>11836:                                    ERROR
<a name="11837"/>11837:                            end
<a name="11838"/>11838:                    end},
<a name="11839"/>11839:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="11840"/>11840:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="11841"/>11841:                            ?SEV_ANNOUNCE_READY(Tester, init),
<a name="11842"/>11842:                            ok
<a name="11843"/>11843:                    end},
<a name="11844"/>11844: 
<a name="11845"/>11845:          %% *** The actual test ***
<a name="11846"/>11846:          #{desc =&gt; &quot;await continue (connect)&quot;,
<a name="11847"/>11847:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="11848"/>11848:                            ?SEV_AWAIT_CONTINUE(Tester, tester, connect)
<a name="11849"/>11849:                    end},
<a name="11850"/>11850:          #{desc =&gt; &quot;connect to server&quot;,
<a name="11851"/>11851:            cmd  =&gt; fun(#{sock := Sock, server_sa := SSA}) -&gt;
<a name="11852"/>11852:                            socket:connect(Sock, SSA)
<a name="11853"/>11853:                    end},
<a name="11854"/>11854:          #{desc =&gt; &quot;announce ready (connect)&quot;,
<a name="11855"/>11855:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="11856"/>11856:                            ?SEV_ANNOUNCE_READY(Tester, connect),
<a name="11857"/>11857:                            ok
<a name="11858"/>11858:                    end},
<a name="11859"/>11859: 
<a name="11860"/>11860:          %% *** Termination ***
<a name="11861"/>11861:          #{desc =&gt; &quot;await terminate&quot;,
<a name="11862"/>11862:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="11863"/>11863:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="11864"/>11864:                                ok -&gt;
<a name="11865"/>11865:                                    {ok, maps:remove(tester, State)};
<a name="11866"/>11866:                                {error, _} = ERROR -&gt;
<a name="11867"/>11867:                                    ERROR
<a name="11868"/>11868:                            end
<a name="11869"/>11869:                    end},
<a name="11870"/>11870:          #{desc =&gt; &quot;close socket&quot;,
<a name="11871"/>11871:            cmd  =&gt; fun(#{sock := Sock}) -&gt;
<a name="11872"/>11872:                            socket:close(Sock)
<a name="11873"/>11873:                    end},
<a name="11874"/>11874: 
<a name="11875"/>11875:          %% *** We are done ***
<a name="11876"/>11876:          ?SEV_FINISH_NORMAL
<a name="11877"/>11877:         ],
<a name="11878"/>11878: 
<a name="11879"/>11879:     TesterSeq =
<a name="11880"/>11880:         [
<a name="11881"/>11881:          %% *** Init part ***
<a name="11882"/>11882:          #{desc =&gt; &quot;monitor server&quot;,
<a name="11883"/>11883:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="11884"/>11884:                            _MRef = erlang:monitor(process, Pid),
<a name="11885"/>11885:                            ok
<a name="11886"/>11886:                    end},
<a name="11887"/>11887:          #{desc =&gt; &quot;monitor alt-server 1&quot;,
<a name="11888"/>11888:            cmd  =&gt; fun(#{alt_server1 := Pid} = _State) -&gt;
<a name="11889"/>11889:                            _MRef = erlang:monitor(process, Pid),
<a name="11890"/>11890:                            ok
<a name="11891"/>11891:                    end},
<a name="11892"/>11892:          #{desc =&gt; &quot;monitor alt-server 2&quot;,
<a name="11893"/>11893:            cmd  =&gt; fun(#{alt_server2 := Pid} = _State) -&gt;
<a name="11894"/>11894:                            _MRef = erlang:monitor(process, Pid),
<a name="11895"/>11895:                            ok
<a name="11896"/>11896:                    end},
<a name="11897"/>11897:          #{desc =&gt; &quot;monitor client&quot;,
<a name="11898"/>11898:            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;
<a name="11899"/>11899:                            _MRef = erlang:monitor(process, Pid),
<a name="11900"/>11900:                            ok
<a name="11901"/>11901:                    end},
<a name="11902"/>11902: 
<a name="11903"/>11903:          %% Start the server
<a name="11904"/>11904:          #{desc =&gt; &quot;order server start&quot;,
<a name="11905"/>11905:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="11906"/>11906:                            ?SEV_ANNOUNCE_START(Pid),
<a name="11907"/>11907:                            ok
<a name="11908"/>11908:                    end},
<a name="11909"/>11909:          #{desc =&gt; &quot;await server ready (init)&quot;,
<a name="11910"/>11910:            cmd  =&gt; fun(#{server := Pid} = State) -&gt;
<a name="11911"/>11911:                            {ok, Port} = ?SEV_AWAIT_READY(Pid, server, init),
<a name="11912"/>11912:                            {ok, State#{server_port =&gt; Port}}
<a name="11913"/>11913:                    end},
<a name="11914"/>11914: 
<a name="11915"/>11915:          %% Start the client
<a name="11916"/>11916:          #{desc =&gt; &quot;order client start&quot;,
<a name="11917"/>11917:            cmd  =&gt; fun(#{client := Pid, server_port := Port} = _State) -&gt;
<a name="11918"/>11918:                            ?SEV_ANNOUNCE_START(Pid, Port),
<a name="11919"/>11919:                            ok
<a name="11920"/>11920:                    end},
<a name="11921"/>11921:          #{desc =&gt; &quot;await client ready (init)&quot;,
<a name="11922"/>11922:            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;
<a name="11923"/>11923:                            ok = ?SEV_AWAIT_READY(Pid, client, init)
<a name="11924"/>11924:                    end},
<a name="11925"/>11925: 
<a name="11926"/>11926:          #{desc =&gt; &quot;order server to continue (with accept)&quot;,
<a name="11927"/>11927:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="11928"/>11928:                            ?SEV_ANNOUNCE_CONTINUE(Server, accept),
<a name="11929"/>11929:                            ok
<a name="11930"/>11930:                    end},
<a name="11931"/>11931:          #{desc =&gt; &quot;order client to continue (connect)&quot;,
<a name="11932"/>11932:            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;
<a name="11933"/>11933:                            ?SEV_ANNOUNCE_CONTINUE(Pid, connect),
<a name="11934"/>11934:                            ok
<a name="11935"/>11935:                    end},
<a name="11936"/>11936:          #{desc =&gt; &quot;await client ready (connect)&quot;,
<a name="11937"/>11937:            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;
<a name="11938"/>11938:                            ?SEV_AWAIT_READY(Pid, client, connect)
<a name="11939"/>11939:                    end},
<a name="11940"/>11940:          #{desc =&gt; &quot;await server ready (accept)&quot;,
<a name="11941"/>11941:            cmd  =&gt; fun(#{server := Pid} = State) -&gt;
<a name="11942"/>11942:                            {ok, Sock} = ?SEV_AWAIT_READY(Pid, server, accept),
<a name="11943"/>11943:                            {ok, State#{sock =&gt; Sock}}
<a name="11944"/>11944:                    end},
<a name="11945"/>11945: 
<a name="11946"/>11946:          %% Start the alt server 1
<a name="11947"/>11947:          #{desc =&gt; &quot;order alt-server 1 start&quot;,
<a name="11948"/>11948:            cmd  =&gt; fun(#{alt_server1 := Pid, sock := Sock} = _State) -&gt;
<a name="11949"/>11949:                            ?SEV_ANNOUNCE_START(Pid, Sock),
<a name="11950"/>11950:                            ok
<a name="11951"/>11951:                    end},
<a name="11952"/>11952:          #{desc =&gt; &quot;await alt-server 1 ready (init)&quot;,
<a name="11953"/>11953:            cmd  =&gt; fun(#{alt_server1 := Pid} = _State) -&gt;
<a name="11954"/>11954:                            ok = ?SEV_AWAIT_READY(Pid, alt_server1, init)
<a name="11955"/>11955:                    end},
<a name="11956"/>11956: 
<a name="11957"/>11957:          %% Start the alt server 2
<a name="11958"/>11958:          #{desc =&gt; &quot;order alt-server 2 start&quot;,
<a name="11959"/>11959:            cmd  =&gt; fun(#{alt_server2 := Pid, sock := Sock} = _State) -&gt;
<a name="11960"/>11960:                            ?SEV_ANNOUNCE_START(Pid, Sock),
<a name="11961"/>11961:                            ok
<a name="11962"/>11962:                    end},
<a name="11963"/>11963:          #{desc =&gt; &quot;await alt-server 2 ready (init)&quot;,
<a name="11964"/>11964:            cmd  =&gt; fun(#{alt_server2 := Pid} = _State) -&gt;
<a name="11965"/>11965:                            ok = ?SEV_AWAIT_READY(Pid, alt_server2, init)
<a name="11966"/>11966:                    end},
<a name="11967"/>11967: 
<a name="11968"/>11968: 
<a name="11969"/>11969:          %% *** The actual test ***
<a name="11970"/>11970:          #{desc =&gt; &quot;order server continue (recv)&quot;,
<a name="11971"/>11971:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="11972"/>11972:                            ?SEV_ANNOUNCE_CONTINUE(Pid, recv),
<a name="11973"/>11973:                            ok
<a name="11974"/>11974:                    end},
<a name="11975"/>11975:          #{desc =&gt; &quot;await server ready (recv select)&quot;,
<a name="11976"/>11976:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="11977"/>11977:                            ok = ?SEV_AWAIT_READY(Pid, server, recv_select)
<a name="11978"/>11978:                    end},
<a name="11979"/>11979: 
<a name="11980"/>11980:          #{desc =&gt; &quot;order alt-server 1 continue (recv)&quot;,
<a name="11981"/>11981:            cmd  =&gt; fun(#{alt_server1 := Pid} = _State) -&gt;
<a name="11982"/>11982:                            ?SEV_ANNOUNCE_CONTINUE(Pid, recv),
<a name="11983"/>11983:                            ok
<a name="11984"/>11984:                    end},
<a name="11985"/>11985:          #{desc =&gt; &quot;await alt-server 1 ready (recv select)&quot;,
<a name="11986"/>11986:            cmd  =&gt; fun(#{alt_server1 := Pid} = _State) -&gt;
<a name="11987"/>11987:                            ok = ?SEV_AWAIT_READY(Pid, alt_server1, recv_select)
<a name="11988"/>11988:                    end},
<a name="11989"/>11989: 
<a name="11990"/>11990:          #{desc =&gt; &quot;order alt-server 2 continue (recv)&quot;,
<a name="11991"/>11991:            cmd  =&gt; fun(#{alt_server2 := Pid} = _State) -&gt;
<a name="11992"/>11992:                            ?SEV_ANNOUNCE_CONTINUE(Pid, recv),
<a name="11993"/>11993:                            ok
<a name="11994"/>11994:                    end},
<a name="11995"/>11995:          #{desc =&gt; &quot;await alt-server 2 ready (recv select)&quot;,
<a name="11996"/>11996:            cmd  =&gt; fun(#{alt_server2 := Pid} = _State) -&gt;
<a name="11997"/>11997:                            ok = ?SEV_AWAIT_READY(Pid, alt_server2, recv_select)
<a name="11998"/>11998:                    end},
<a name="11999"/>11999: 
<a name="12000"/>12000:          ?SEV_SLEEP(?SECS(1)),
<a name="12001"/>12001: 
<a name="12002"/>12002:          #{desc =&gt; &quot;close the socket&quot;,
<a name="12003"/>12003:            cmd  =&gt; fun(#{sock := Sock} = _State) -&gt;
<a name="12004"/>12004:                            socket:close(Sock)
<a name="12005"/>12005:                    end},
<a name="12006"/>12006: 
<a name="12007"/>12007:          #{desc =&gt; &quot;await server ready (abort)&quot;,
<a name="12008"/>12008:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="12009"/>12009:                            ok = ?SEV_AWAIT_READY(Pid, server, abort)
<a name="12010"/>12010:                    end},
<a name="12011"/>12011:          #{desc =&gt; &quot;await alt-server 1 ready (abort)&quot;,
<a name="12012"/>12012:            cmd  =&gt; fun(#{alt_server1 := Pid} = _State) -&gt;
<a name="12013"/>12013:                            ok = ?SEV_AWAIT_READY(Pid, alt_server1, abort)
<a name="12014"/>12014:                    end},
<a name="12015"/>12015:          #{desc =&gt; &quot;await alt-server 2 ready (abort)&quot;,
<a name="12016"/>12016:            cmd  =&gt; fun(#{alt_server2 := Pid} = _State) -&gt;
<a name="12017"/>12017:                            ok = ?SEV_AWAIT_READY(Pid, alt_server2, abort)
<a name="12018"/>12018:                    end},
<a name="12019"/>12019: 
<a name="12020"/>12020:          %% Terminations
<a name="12021"/>12021:          #{desc =&gt; &quot;order client to terminate&quot;,
<a name="12022"/>12022:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="12023"/>12023:                            ?SEV_ANNOUNCE_TERMINATE(Client),
<a name="12024"/>12024:                            ok
<a name="12025"/>12025:                    end},
<a name="12026"/>12026:          #{desc =&gt; &quot;await client termination&quot;,
<a name="12027"/>12027:            cmd  =&gt; fun(#{client := Client} = State) -&gt;
<a name="12028"/>12028:                            ?SEV_AWAIT_TERMINATION(Client),
<a name="12029"/>12029:                            State1 = maps:remove(client, State),
<a name="12030"/>12030:                            {ok, State1}
<a name="12031"/>12031:                    end},
<a name="12032"/>12032: 
<a name="12033"/>12033:          #{desc =&gt; &quot;order alt-server 2 to terminate&quot;,
<a name="12034"/>12034:            cmd  =&gt; fun(#{alt_server2 := Pid} = _State) -&gt;
<a name="12035"/>12035:                            ?SEV_ANNOUNCE_TERMINATE(Pid),
<a name="12036"/>12036:                            ok
<a name="12037"/>12037:                    end},
<a name="12038"/>12038:          #{desc =&gt; &quot;await alt-server 2 termination&quot;,
<a name="12039"/>12039:            cmd  =&gt; fun(#{alt_server2 := Pid} = State) -&gt;
<a name="12040"/>12040:                            case ?SEV_AWAIT_TERMINATION(Pid) of
<a name="12041"/>12041:                                ok -&gt;
<a name="12042"/>12042:                                    State1 = maps:remove(alt_server2, State),
<a name="12043"/>12043:                                    {ok, State1};
<a name="12044"/>12044:                                {error, _} = ERROR -&gt;
<a name="12045"/>12045:                                    ERROR
<a name="12046"/>12046:                            end
<a name="12047"/>12047:                    end},
<a name="12048"/>12048: 
<a name="12049"/>12049:          #{desc =&gt; &quot;order alt-server 1 to terminate&quot;,
<a name="12050"/>12050:            cmd  =&gt; fun(#{alt_server1 := Pid} = _State) -&gt;
<a name="12051"/>12051:                            ?SEV_ANNOUNCE_TERMINATE(Pid),
<a name="12052"/>12052:                            ok
<a name="12053"/>12053:                    end},
<a name="12054"/>12054:          #{desc =&gt; &quot;await alt-server 1 termination&quot;,
<a name="12055"/>12055:            cmd  =&gt; fun(#{alt_server1 := Pid} = State) -&gt;
<a name="12056"/>12056:                            case ?SEV_AWAIT_TERMINATION(Pid) of
<a name="12057"/>12057:                                ok -&gt;
<a name="12058"/>12058:                                    State1 = maps:remove(alt_server1, State),
<a name="12059"/>12059:                                    {ok, State1};
<a name="12060"/>12060:                                {error, _} = ERROR -&gt;
<a name="12061"/>12061:                                    ERROR
<a name="12062"/>12062:                            end
<a name="12063"/>12063:                    end},
<a name="12064"/>12064: 
<a name="12065"/>12065:          #{desc =&gt; &quot;order server to terminate&quot;,
<a name="12066"/>12066:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="12067"/>12067:                            ?SEV_ANNOUNCE_TERMINATE(Pid),
<a name="12068"/>12068:                            ok
<a name="12069"/>12069:                    end},
<a name="12070"/>12070:          #{desc =&gt; &quot;await server termination&quot;,
<a name="12071"/>12071:            cmd  =&gt; fun(#{server := Pid} = State) -&gt;
<a name="12072"/>12072:                            case ?SEV_AWAIT_TERMINATION(Pid) of
<a name="12073"/>12073:                                ok -&gt;
<a name="12074"/>12074:                                    State1 = maps:remove(server, State),
<a name="12075"/>12075:                                    {ok, State1};
<a name="12076"/>12076:                                {error, _} = ERROR -&gt;
<a name="12077"/>12077:                                    ERROR
<a name="12078"/>12078:                            end
<a name="12079"/>12079:                    end},
<a name="12080"/>12080: 
<a name="12081"/>12081: 
<a name="12082"/>12082:          %% *** We are done ***
<a name="12083"/>12083:          ?SEV_FINISH_NORMAL
<a name="12084"/>12084:         ],
<a name="12085"/>12085: 
<a name="12086"/>12086:     i(&quot;start server evaluator&quot;),
<a name="12087"/>12087:     Server = ?SEV_START(&quot;server&quot;, ServerSeq, InitState),
<a name="12088"/>12088: 
<a name="12089"/>12089:     i(&quot;start alt-server 1 evaluator&quot;),
<a name="12090"/>12090:     AltServer1 = ?SEV_START(&quot;alt_server1&quot;, AltServerSeq, InitState),
<a name="12091"/>12091: 
<a name="12092"/>12092:     i(&quot;start alt-server 2 evaluator&quot;),
<a name="12093"/>12093:     AltServer2 = ?SEV_START(&quot;alt_server2&quot;, AltServerSeq, InitState),
<a name="12094"/>12094: 
<a name="12095"/>12095:     i(&quot;start client evaluator&quot;),
<a name="12096"/>12096:     Client = ?SEV_START(&quot;client&quot;, ClientSeq, InitState),
<a name="12097"/>12097: 
<a name="12098"/>12098:     i(&quot;start tester evaluator&quot;),
<a name="12099"/>12099:     TesterInitState = #{server      =&gt; Server#ev.pid,
<a name="12100"/>12100:                         alt_server1 =&gt; AltServer1#ev.pid,
<a name="12101"/>12101:                         alt_server2 =&gt; AltServer2#ev.pid,
<a name="12102"/>12102:                         client      =&gt; Client#ev.pid},
<a name="12103"/>12103:     Tester = ?SEV_START(&quot;tester&quot;, TesterSeq, TesterInitState),
<a name="12104"/>12104: 
<a name="12105"/>12105:     i(&quot;await evaluator(s)&quot;),
<a name="api_a_mrecv_cancel_tcp-last_expr"/><a name="12106"/>12106: <b>    ok = ?SEV_AWAIT_FINISH</b>([Server, AltServer1, AltServer2, Client, Tester]).
<a name="12107"/>12107: 
<a name="12108"/>12108: 
<a name="12109"/>12109: 
<a name="12110"/>12110: 
<a name="12111"/>12111: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="12112"/>12112: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="12113"/>12113: <i>%%                                                                     %%</i>
<a name="12114"/>12114: <i>%%                           API OPTIONS                               %%</i>
<a name="12115"/>12115: <i>%%                                                                     %%</i>
<a name="12116"/>12116: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="12117"/>12117: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="12118"/>12118: 
<a name="12119"/>12119: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="12120"/>12120: 
<a name="12121"/>12121: <i>%% Perform some simple getopt and setopt with the level = otp options</i>
<a name="api_opt_simple_otp_options-1"/><a name="12122"/>12122: <b>api_opt_simple_otp_options</b>(_Config) when is_list(_Config) -&gt;
<a name="12123"/>12123:     ?TT(?SECS(5)),
<a name="api_opt_simple_otp_options-last_expr"/><a name="12124"/>12124: <b>    tc_try</b>(api_opt_simple_otp_options,
<a name="12125"/>12125:            fun() -&gt; api_opt_simple_otp_options() end).
<a name="12126"/>12126: 
<a name="api_opt_simple_otp_options-0"/><a name="12127"/>12127: <b>api_opt_simple_otp_options</b>() -&gt;
<a name="12128"/>12128:     Get = fun(S, Key) -&gt;
<a name="12129"/>12129:                   socket:getopt(S, otp, Key)
<a name="12130"/>12130:           end,
<a name="12131"/>12131:     Set = fun(S, Key, Val) -&gt;
<a name="12132"/>12132:                   socket:setopt(S, otp, Key, Val)
<a name="12133"/>12133:           end,
<a name="12134"/>12134: 
<a name="12135"/>12135:     Seq = 
<a name="12136"/>12136:         [
<a name="12137"/>12137:          %% *** Init part ***
<a name="12138"/>12138:          #{desc =&gt; &quot;create socket&quot;,
<a name="12139"/>12139:            cmd  =&gt; fun(#{domain   := Domain, 
<a name="12140"/>12140:                          type     := Type,
<a name="12141"/>12141:                          protocol := Protocol} = State) -&gt;
<a name="12142"/>12142:                            Sock = sock_open(Domain, Type, Protocol),
<a name="12143"/>12143:                            {ok, State#{sock =&gt; Sock}}
<a name="12144"/>12144:                    end},
<a name="12145"/>12145:          #{desc =&gt; &quot;create dummy process&quot;,
<a name="12146"/>12146:            cmd  =&gt; fun(State) -&gt;
<a name="12147"/>12147:                            Pid =  spawn_link(fun() -&gt; 
<a name="12148"/>12148:                                                      put(sname, &quot;dummy&quot;),
<a name="12149"/>12149:                                                      receive
<a name="12150"/>12150:                                                          die -&gt; 
<a name="12151"/>12151:                                                              exit(normal) 
<a name="12152"/>12152:                                                      end 
<a name="12153"/>12153:                                              end),
<a name="12154"/>12154:                            {ok, State#{dummy =&gt; Pid}}
<a name="12155"/>12155:                    end},
<a name="12156"/>12156: 
<a name="12157"/>12157:          %% *** Check iow part ***
<a name="12158"/>12158:          #{desc =&gt; &quot;get iow&quot;,
<a name="12159"/>12159:            cmd  =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="12160"/>12160:                            case Get(Sock, iow) of
<a name="12161"/>12161:                                {ok, IOW} when is_boolean(IOW) -&gt;
<a name="12162"/>12162:                                    {ok, State#{iow =&gt; IOW}};
<a name="12163"/>12163:                                {ok, _} = OK -&gt;
<a name="12164"/>12164:                                    {error, OK};
<a name="12165"/>12165:                                {error, _} = ERROR -&gt;
<a name="12166"/>12166:                                    ERROR
<a name="12167"/>12167:                            end
<a name="12168"/>12168:                    end},
<a name="12169"/>12169: 
<a name="12170"/>12170:          %% #{desc =&gt; &quot;enable debug&quot;,
<a name="12171"/>12171:          %%   cmd  =&gt; fun(#{sock := Sock}) -&gt;
<a name="12172"/>12172:          %%                   ok = socket:setopt(Sock, otp, debug, true)
<a name="12173"/>12173:          %%           end},
<a name="12174"/>12174: 
<a name="12175"/>12175:          #{desc =&gt; &quot;set (new) iow&quot;,
<a name="12176"/>12176:            cmd  =&gt; fun(#{sock := Sock, iow := OldIOW} = State) -&gt;
<a name="12177"/>12177:                            NewIOW = not OldIOW,
<a name="12178"/>12178:                            case Set(Sock, iow, NewIOW) of
<a name="12179"/>12179:                                ok -&gt;
<a name="12180"/>12180:                                    {ok, State#{iow =&gt; NewIOW}};
<a name="12181"/>12181:                                {error, _} = ERROR -&gt;
<a name="12182"/>12182:                                    ERROR
<a name="12183"/>12183:                            end
<a name="12184"/>12184:                    end},
<a name="12185"/>12185:          #{desc =&gt; &quot;get (new) iow&quot;,
<a name="12186"/>12186:            cmd  =&gt; fun(#{sock := Sock, iow := IOW}) -&gt;
<a name="12187"/>12187:                            case Get(Sock, iow) of
<a name="12188"/>12188:                                {ok, IOW} -&gt;
<a name="12189"/>12189:                                    ok;
<a name="12190"/>12190:                                {ok, _} = OK-&gt;
<a name="12191"/>12191:                                    {error, OK};
<a name="12192"/>12192:                                {error, _} = ERROR -&gt;
<a name="12193"/>12193:                                    ERROR
<a name="12194"/>12194:                            end
<a name="12195"/>12195:                    end},
<a name="12196"/>12196: 
<a name="12197"/>12197:          %% *** Check rcvbuf part ***
<a name="12198"/>12198:          #{desc =&gt; &quot;get rcvbuf&quot;,
<a name="12199"/>12199:            cmd  =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="12200"/>12200:                            case Get(Sock, rcvbuf) of
<a name="12201"/>12201:                                {ok, RcvBuf} when is_integer(RcvBuf) -&gt;
<a name="12202"/>12202:                                    {ok, State#{rcvbuf =&gt; RcvBuf}};
<a name="12203"/>12203:                                {ok, {N, RcvBuf} = V} when is_integer(N) andalso 
<a name="12204"/>12204:                                                           is_integer(RcvBuf) -&gt;
<a name="12205"/>12205:                                    {ok, State#{rcvbuf =&gt; V}};
<a name="12206"/>12206:                                {ok, _} = OK -&gt;
<a name="12207"/>12207:                                    {error, OK};
<a name="12208"/>12208:                                {error, _} = ERROR -&gt;
<a name="12209"/>12209:                                    ERROR
<a name="12210"/>12210:                            end
<a name="12211"/>12211:                    end},
<a name="12212"/>12212:          #{desc =&gt; &quot;set (new) rcvbuf&quot;,
<a name="12213"/>12213:            cmd  =&gt; fun(#{sock := Sock, rcvbuf := {OldN, OldRcvBuf}} = State) -&gt;
<a name="12214"/>12214:                            NewRcvBuf = {OldN+2, OldRcvBuf + 1024},
<a name="12215"/>12215:                            case Set(Sock, rcvbuf, NewRcvBuf) of
<a name="12216"/>12216:                                ok -&gt;
<a name="12217"/>12217:                                    {ok, State#{rcvbuf =&gt; NewRcvBuf}};
<a name="12218"/>12218:                                {error, _} = ERROR -&gt;
<a name="12219"/>12219:                                    ERROR
<a name="12220"/>12220:                            end;
<a name="12221"/>12221:                       (#{sock := Sock, rcvbuf := OldRcvBuf} = State) when is_integer(OldRcvBuf) -&gt;
<a name="12222"/>12222:                            NewRcvBuf = 2 * OldRcvBuf,
<a name="12223"/>12223:                            case Set(Sock, rcvbuf, NewRcvBuf) of
<a name="12224"/>12224:                                ok -&gt;
<a name="12225"/>12225:                                    {ok, State#{rcvbuf =&gt; NewRcvBuf}};
<a name="12226"/>12226:                                {error, _} = ERROR -&gt;
<a name="12227"/>12227:                                    ERROR
<a name="12228"/>12228:                            end;
<a name="12229"/>12229:                       (#{sock := Sock, rcvbuf := OldRcvBuf,
<a name="12230"/>12230:                          type := stream,
<a name="12231"/>12231:                          protocol := tcp} = State) when is_integer(OldRcvBuf) -&gt;
<a name="12232"/>12232:                            NewRcvBuf = {2, OldRcvBuf},
<a name="12233"/>12233:                            case Set(Sock, rcvbuf, NewRcvBuf) of
<a name="12234"/>12234:                                ok -&gt;
<a name="12235"/>12235:                                    {ok, State#{rcvbuf =&gt; NewRcvBuf}};
<a name="12236"/>12236:                                {error, _} = ERROR -&gt;
<a name="12237"/>12237:                                    ERROR
<a name="12238"/>12238:                            end
<a name="12239"/>12239:                    end},
<a name="12240"/>12240:          #{desc =&gt; &quot;get (new) rcvbuf&quot;,
<a name="12241"/>12241:            cmd  =&gt; fun(#{sock := Sock, rcvbuf := RcvBuf}) -&gt;
<a name="12242"/>12242:                            case Get(Sock, rcvbuf) of
<a name="12243"/>12243:                                {ok, RcvBuf} -&gt;
<a name="12244"/>12244:                                    ok;
<a name="12245"/>12245:                                {ok, _} = OK -&gt;
<a name="12246"/>12246:                                    {error, OK};
<a name="12247"/>12247:                                {error, _} = ERROR -&gt;
<a name="12248"/>12248:                                    ERROR
<a name="12249"/>12249:                            end
<a name="12250"/>12250:                    end},
<a name="12251"/>12251: 
<a name="12252"/>12252:          %% *** Check rcvctrlbuf part ***
<a name="12253"/>12253:          #{desc =&gt; &quot;get rcvctrlbuf&quot;,
<a name="12254"/>12254:            cmd  =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="12255"/>12255:                            case Get(Sock, rcvctrlbuf) of
<a name="12256"/>12256:                                {ok, RcvCtrlBuf} when is_integer(RcvCtrlBuf) -&gt;
<a name="12257"/>12257:                                    {ok, State#{rcvctrlbuf =&gt; RcvCtrlBuf}};
<a name="12258"/>12258:                                {ok, _} = OK -&gt;
<a name="12259"/>12259:                                    {error, OK};
<a name="12260"/>12260:                                {error, _} = ERROR -&gt;
<a name="12261"/>12261:                                    ERROR
<a name="12262"/>12262:                            end
<a name="12263"/>12263:                    end},
<a name="12264"/>12264:          #{desc =&gt; &quot;set (new) rcvctrlbuf&quot;,
<a name="12265"/>12265:            cmd  =&gt; fun(#{sock := Sock, rcvctrlbuf := OldRcvCtrlBuf} = State) -&gt;
<a name="12266"/>12266:                            NewRcvCtrlBuf = 2 * OldRcvCtrlBuf,
<a name="12267"/>12267:                            case Set(Sock, rcvctrlbuf, NewRcvCtrlBuf) of
<a name="12268"/>12268:                                ok -&gt;
<a name="12269"/>12269:                                    {ok, State#{rcvctrlbuf =&gt; NewRcvCtrlBuf}};
<a name="12270"/>12270:                                {error, _} = ERROR -&gt;
<a name="12271"/>12271:                                    ERROR
<a name="12272"/>12272:                            end
<a name="12273"/>12273:                    end},
<a name="12274"/>12274:          #{desc =&gt; &quot;get (new) rcvctrlbuf&quot;,
<a name="12275"/>12275:            cmd  =&gt; fun(#{sock := Sock, rcvctrlbuf := RcvCtrlBuf}) -&gt;
<a name="12276"/>12276:                            case Get(Sock, rcvctrlbuf) of
<a name="12277"/>12277:                                {ok, RcvCtrlBuf} -&gt;
<a name="12278"/>12278:                                    ok;
<a name="12279"/>12279:                                {ok, _} = OK -&gt;
<a name="12280"/>12280:                                    {error, OK};
<a name="12281"/>12281:                                {error, _} = ERROR -&gt;
<a name="12282"/>12282:                                    ERROR
<a name="12283"/>12283:                            end
<a name="12284"/>12284:                    end},
<a name="12285"/>12285:          %% *** Check rcvctrlbuf part ***
<a name="12286"/>12286:          #{desc =&gt; &quot;get rcvctrlbuf&quot;,
<a name="12287"/>12287:            cmd  =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="12288"/>12288:                            case Get(Sock, rcvctrlbuf) of
<a name="12289"/>12289:                                {ok, RcvCtrlBuf} when is_integer(RcvCtrlBuf) -&gt;
<a name="12290"/>12290:                                    {ok, State#{rcvctrlbuf =&gt; RcvCtrlBuf}};
<a name="12291"/>12291:                                {ok, _} = OK -&gt;
<a name="12292"/>12292:                                    {error, OK};
<a name="12293"/>12293:                                {error, _} = ERROR -&gt;
<a name="12294"/>12294:                                    ERROR
<a name="12295"/>12295:                            end
<a name="12296"/>12296:                    end},
<a name="12297"/>12297:          #{desc =&gt; &quot;set (new) rcvctrlbuf&quot;,
<a name="12298"/>12298:            cmd  =&gt; fun(#{sock := Sock, rcvctrlbuf := OldRcvCtrlBuf} = State) -&gt;
<a name="12299"/>12299:                            NewRcvCtrlBuf = 2 * OldRcvCtrlBuf,
<a name="12300"/>12300:                            case Set(Sock, rcvctrlbuf, NewRcvCtrlBuf) of
<a name="12301"/>12301:                                ok -&gt;
<a name="12302"/>12302:                                    {ok, State#{rcvctrlbuf =&gt; NewRcvCtrlBuf}};
<a name="12303"/>12303:                                {error, _} = ERROR -&gt;
<a name="12304"/>12304:                                    ERROR
<a name="12305"/>12305:                            end
<a name="12306"/>12306:                    end},
<a name="12307"/>12307:          #{desc =&gt; &quot;get (new) rcvctrlbuf&quot;,
<a name="12308"/>12308:            cmd  =&gt; fun(#{sock := Sock, rcvctrlbuf := RcvCtrlBuf}) -&gt;
<a name="12309"/>12309:                            case Get(Sock, rcvctrlbuf) of
<a name="12310"/>12310:                                {ok, RcvCtrlBuf} -&gt;
<a name="12311"/>12311:                                    ok;
<a name="12312"/>12312:                                {ok, _} = OK -&gt;
<a name="12313"/>12313:                                    {error, OK};
<a name="12314"/>12314:                                {error, _} = ERROR -&gt;
<a name="12315"/>12315:                                    ERROR
<a name="12316"/>12316:                            end
<a name="12317"/>12317:                    end},
<a name="12318"/>12318: 
<a name="12319"/>12319: 
<a name="12320"/>12320:          %% *** Check sndctrlbuf part ***
<a name="12321"/>12321:          #{desc =&gt; &quot;get sndctrlbuf&quot;,
<a name="12322"/>12322:            cmd  =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="12323"/>12323:                            case Get(Sock, sndctrlbuf) of
<a name="12324"/>12324:                                {ok, SndCtrlBuf} when is_integer(SndCtrlBuf) -&gt;
<a name="12325"/>12325:                                    {ok, State#{sndctrlbuf =&gt; SndCtrlBuf}};
<a name="12326"/>12326:                                {ok, _} = OK -&gt;
<a name="12327"/>12327:                                    {error, OK};
<a name="12328"/>12328:                                {error, _} = ERROR -&gt;
<a name="12329"/>12329:                                    ERROR
<a name="12330"/>12330:                            end
<a name="12331"/>12331:                    end},
<a name="12332"/>12332:          #{desc =&gt; &quot;set (new) sndctrlbuf&quot;,
<a name="12333"/>12333:            cmd  =&gt; fun(#{sock := Sock, sndctrlbuf := OldSndCtrlBuf} = State) -&gt;
<a name="12334"/>12334:                            NewSndCtrlBuf = 2 * OldSndCtrlBuf,
<a name="12335"/>12335:                            case Set(Sock, sndctrlbuf, NewSndCtrlBuf) of
<a name="12336"/>12336:                                ok -&gt;
<a name="12337"/>12337:                                    {ok, State#{sndctrlbuf =&gt; NewSndCtrlBuf}};
<a name="12338"/>12338:                                {error, _} = ERROR -&gt;
<a name="12339"/>12339:                                    ERROR
<a name="12340"/>12340:                            end
<a name="12341"/>12341:                    end},
<a name="12342"/>12342:          #{desc =&gt; &quot;get (new) sndctrlbuf&quot;,
<a name="12343"/>12343:            cmd  =&gt; fun(#{sock := Sock, sndctrlbuf := SndCtrlBuf}) -&gt;
<a name="12344"/>12344:                            case Get(Sock, sndctrlbuf) of
<a name="12345"/>12345:                                {ok, SndCtrlBuf} -&gt;
<a name="12346"/>12346:                                    ok;
<a name="12347"/>12347:                                {ok, _} = OK-&gt;
<a name="12348"/>12348:                                    {error, OK};
<a name="12349"/>12349:                                {error, _} = ERROR -&gt;
<a name="12350"/>12350:                                    ERROR
<a name="12351"/>12351:                            end
<a name="12352"/>12352:                    end},
<a name="12353"/>12353: 
<a name="12354"/>12354:          %% *** Check controlling-process part ***
<a name="12355"/>12355:          #{desc =&gt; &quot;verify self as controlling-process&quot;,
<a name="12356"/>12356:            cmd  =&gt; fun(#{sock := Sock}) -&gt;
<a name="12357"/>12357:                            Self = self(),
<a name="12358"/>12358:                            case Get(Sock, controlling_process) of
<a name="12359"/>12359:                                {ok, Self} -&gt;
<a name="12360"/>12360:                                    ok;
<a name="12361"/>12361:                                {ok, _} = OK -&gt;
<a name="12362"/>12362:                                    {error, OK};
<a name="12363"/>12363:                                {error, _} = ERROR -&gt;
<a name="12364"/>12364:                                    ERROR
<a name="12365"/>12365:                            end
<a name="12366"/>12366:                    end},
<a name="12367"/>12367:          #{desc =&gt; &quot;set dummy as controlling-process&quot;,
<a name="12368"/>12368:            cmd  =&gt; fun(#{sock := Sock, dummy := Dummy}) -&gt;
<a name="12369"/>12369:                            Set(Sock, controlling_process, Dummy)
<a name="12370"/>12370:                    end},
<a name="12371"/>12371:          #{desc =&gt; &quot;verify dummy as controlling-process&quot;,
<a name="12372"/>12372:            cmd  =&gt; fun(#{sock := Sock, dummy := Dummy}) -&gt;
<a name="12373"/>12373:                            case Get(Sock, controlling_process) of
<a name="12374"/>12374:                                {ok, Dummy} -&gt;
<a name="12375"/>12375:                                    ok;
<a name="12376"/>12376:                                {ok, _} = OK -&gt;
<a name="12377"/>12377:                                    {error, OK};
<a name="12378"/>12378:                                {error, _} = ERROR -&gt;
<a name="12379"/>12379:                                    ERROR
<a name="12380"/>12380:                            end
<a name="12381"/>12381:                    end},
<a name="12382"/>12382: 
<a name="12383"/>12383:          %% *** We are done ***
<a name="12384"/>12384:          #{desc =&gt; &quot;finish&quot;,
<a name="12385"/>12385:            cmd  =&gt; fun(#{ dummy := Dummy }) -&gt;
<a name="12386"/>12386:                            Dummy ! die,
<a name="12387"/>12387:                            {ok, normal}
<a name="12388"/>12388:                    end}
<a name="12389"/>12389:         ],
<a name="12390"/>12390: 
<a name="12391"/>12391:     i(&quot;start tcp (stream) evaluator&quot;),
<a name="12392"/>12392:     InitState1 = #{domain =&gt; inet, type =&gt; stream, protocol =&gt; tcp},
<a name="12393"/>12393:     Tester1 = ?SEV_START(&quot;tcp-tester&quot;, Seq, InitState1),
<a name="12394"/>12394:     i(&quot;await tcp evaluator&quot;),
<a name="12395"/>12395:     ok = ?SEV_AWAIT_FINISH([Tester1]),
<a name="12396"/>12396: 
<a name="12397"/>12397:     i(&quot;start udp (dgram) socket&quot;),
<a name="12398"/>12398:     InitState2 = #{domain =&gt; inet, type =&gt; dgram, protocol =&gt; udp},
<a name="12399"/>12399:     Tester2 = ?SEV_START(&quot;udp-tester&quot;, Seq, InitState2),
<a name="12400"/>12400:     i(&quot;await udp evaluator&quot;),
<a name="api_opt_simple_otp_options-last_expr"/><a name="12401"/>12401: <b>    ok = ?SEV_AWAIT_FINISH</b>([Tester2]).
<a name="12402"/>12402: 
<a name="12403"/>12403: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="12404"/>12404: 
<a name="12405"/>12405: <i>%% Perform some simple getopt and setopt otp meta option</i>
<a name="api_opt_simple_otp_meta_option-1"/><a name="12406"/>12406: <b>api_opt_simple_otp_meta_option</b>(_Config) when is_list(_Config) -&gt;
<a name="12407"/>12407:     ?TT(?SECS(5)),
<a name="api_opt_simple_otp_meta_option-last_expr"/><a name="12408"/>12408: <b>    tc_try</b>(api_opt_simple_otp_meta_option,
<a name="12409"/>12409:            fun() -&gt; api_opt_simple_otp_meta_option() end).
<a name="12410"/>12410: 
<a name="api_opt_simple_otp_meta_option-0"/><a name="12411"/>12411: <b>api_opt_simple_otp_meta_option</b>() -&gt;
<a name="12412"/>12412:     Get = fun(S) -&gt;
<a name="12413"/>12413:                   socket:getopt(S, otp, meta)
<a name="12414"/>12414:           end,
<a name="12415"/>12415:     Set = fun(S, Val) -&gt;
<a name="12416"/>12416:                   socket:setopt(S, otp, meta, Val)
<a name="12417"/>12417:           end,
<a name="12418"/>12418: 
<a name="12419"/>12419:     MainSeq =
<a name="12420"/>12420:         [
<a name="12421"/>12421:          #{desc =&gt; &quot;monitor helper&quot;,
<a name="12422"/>12422:            cmd =&gt; fun(#{helper := Pid}) -&gt;
<a name="12423"/>12423:                           _ = erlang:monitor(process, Pid),
<a name="12424"/>12424:                           ok
<a name="12425"/>12425:                   end},
<a name="12426"/>12426: 
<a name="12427"/>12427:          #{desc =&gt; &quot;create socket&quot;,
<a name="12428"/>12428:            cmd  =&gt; fun(#{domain   := Domain,
<a name="12429"/>12429:                          type     := Type,
<a name="12430"/>12430:                          protocol := Protocol} = State) -&gt;
<a name="12431"/>12431:                            Sock = sock_open(Domain, Type, Protocol),
<a name="12432"/>12432:                            {ok, State#{sock =&gt; Sock}}
<a name="12433"/>12433:                    end},
<a name="12434"/>12434: 
<a name="12435"/>12435:          #{desc =&gt; &quot;get default&quot;,
<a name="12436"/>12436:            cmd =&gt; fun(#{sock := Sock}) -&gt;
<a name="12437"/>12437:                           case Get(Sock) of
<a name="12438"/>12438:                               {ok, undefined} -&gt;
<a name="12439"/>12439:                                   ok;
<a name="12440"/>12440:                               {ok, _} = OK -&gt;
<a name="12441"/>12441:                                   {error, OK};
<a name="12442"/>12442:                               {error, _} = ERROR -&gt;
<a name="12443"/>12443:                                   ERROR
<a name="12444"/>12444:                           end
<a name="12445"/>12445:                   end},
<a name="12446"/>12446: 
<a name="12447"/>12447:          #{desc =&gt; &quot;set value&quot;,
<a name="12448"/>12448:            cmd =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="12449"/>12449:                           Value = make_ref(),
<a name="12450"/>12450:                           case Set(Sock, Value) of
<a name="12451"/>12451:                               ok -&gt;
<a name="12452"/>12452:                                   {ok, State#{value =&gt; Value}};
<a name="12453"/>12453:                               {error, _} = ERROR -&gt;
<a name="12454"/>12454:                                   ERROR
<a name="12455"/>12455:                           end
<a name="12456"/>12456:                   end},
<a name="12457"/>12457: 
<a name="12458"/>12458:          #{desc =&gt; &quot;get value&quot;,
<a name="12459"/>12459:            cmd =&gt; fun(#{sock := Sock, value := Value}) -&gt;
<a name="12460"/>12460:                           case Get(Sock) of
<a name="12461"/>12461:                               {ok, Value} -&gt;
<a name="12462"/>12462:                                   ok;
<a name="12463"/>12463:                               {ok, _} = OK -&gt;
<a name="12464"/>12464:                                   {error, OK};
<a name="12465"/>12465:                               {error, _} = ERROR -&gt;
<a name="12466"/>12466:                                   ERROR
<a name="12467"/>12467:                           end
<a name="12468"/>12468:                   end},
<a name="12469"/>12469: 
<a name="12470"/>12470:          #{desc =&gt; &quot;set complex value&quot;,
<a name="12471"/>12471:            cmd =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="12472"/>12472:                           Value =
<a name="12473"/>12473:                               #{a =&gt; 1,
<a name="12474"/>12474:                                 b =&gt; {2, 3},
<a name="12475"/>12475:                                 c =&gt; make_ref(),
<a name="12476"/>12476:                                 d =&gt; self(),
<a name="12477"/>12477:                                 e =&gt; State},
<a name="12478"/>12478:                           case Set(Sock, Value) of
<a name="12479"/>12479:                               ok -&gt;
<a name="12480"/>12480:                                   {ok, State#{value := Value}};
<a name="12481"/>12481:                               {error, _} = ERROR -&gt;
<a name="12482"/>12482:                                   ERROR
<a name="12483"/>12483:                           end
<a name="12484"/>12484:                   end},
<a name="12485"/>12485: 
<a name="12486"/>12486:          #{desc =&gt; &quot;get complex value&quot;,
<a name="12487"/>12487:            cmd =&gt; fun(#{sock := Sock, value := Value}) -&gt;
<a name="12488"/>12488:                           case Get(Sock) of
<a name="12489"/>12489:                               {ok, Value} -&gt;
<a name="12490"/>12490:                                   ok;
<a name="12491"/>12491:                               {ok, _} = OK-&gt;
<a name="12492"/>12492:                                   {error, OK};
<a name="12493"/>12493:                               {error, _} = ERROR -&gt;
<a name="12494"/>12494:                                   ERROR
<a name="12495"/>12495:                           end
<a name="12496"/>12496:                   end},
<a name="12497"/>12497: 
<a name="12498"/>12498:          #{desc =&gt; &quot;start helper&quot;,
<a name="12499"/>12499:            cmd =&gt; fun(#{helper := Pid,  sock := Sock, value := Value}) -&gt;
<a name="12500"/>12500:                           ?SEV_ANNOUNCE_START(Pid, {Sock, Value}),
<a name="12501"/>12501:                           ok
<a name="12502"/>12502:                   end},
<a name="12503"/>12503: 
<a name="12504"/>12504:          #{desc =&gt; &quot;wait for helper ready&quot;,
<a name="12505"/>12505:            cmd =&gt; fun(#{helper := Pid}) -&gt;
<a name="12506"/>12506:                           ?SEV_AWAIT_READY(Pid, helper, test)
<a name="12507"/>12507:                   end},
<a name="12508"/>12508: 
<a name="12509"/>12509:          #{desc =&gt; &quot;socket close&quot;,
<a name="12510"/>12510:            cmd =&gt; fun(#{sock := Sock}) -&gt;
<a name="12511"/>12511:                           socket:close(Sock)
<a name="12512"/>12512:                   end},
<a name="12513"/>12513: 
<a name="12514"/>12514:         ?SEV_FINISH_NORMAL],
<a name="12515"/>12515: 
<a name="12516"/>12516:     HelperSeq =
<a name="12517"/>12517:         [#{desc =&gt; &quot;await start&quot;,
<a name="12518"/>12518:            cmd =&gt; fun (State) -&gt;
<a name="12519"/>12519:                           {Main, {Sock, Value}} = ?SEV_AWAIT_START(),
<a name="12520"/>12520:                           {ok, State#{main =&gt; Main,
<a name="12521"/>12521:                                       sock =&gt; Sock,
<a name="12522"/>12522:                                       value =&gt; Value}}
<a name="12523"/>12523:                   end},
<a name="12524"/>12524:          #{desc =&gt; &quot;monitor main&quot;,
<a name="12525"/>12525:            cmd =&gt; fun(#{main := Main}) -&gt;
<a name="12526"/>12526:                           _ = erlang:monitor(process, Main),
<a name="12527"/>12527:                           ok
<a name="12528"/>12528:                   end}
<a name="12529"/>12529: 
<a name="12530"/>12530:          #{desc =&gt; &quot;get value&quot;,
<a name="12531"/>12531:            cmd =&gt; fun(#{sock := Sock, value := Value}) -&gt;
<a name="12532"/>12532:                           case Get(Sock) of
<a name="12533"/>12533:                               {ok, Value} -&gt;
<a name="12534"/>12534:                                   ok;
<a name="12535"/>12535:                               {ok, _} = OK-&gt;
<a name="12536"/>12536:                                   {error, OK};
<a name="12537"/>12537:                               {error, _} = ERROR -&gt;
<a name="12538"/>12538:                                   ERROR
<a name="12539"/>12539:                           end
<a name="12540"/>12540:                   end},
<a name="12541"/>12541: 
<a name="12542"/>12542:          #{desc =&gt; &quot;set and fail&quot;,
<a name="12543"/>12543:            cmd =&gt; fun(#{sock := Sock}) -&gt;
<a name="12544"/>12544:                           Value = self(),
<a name="12545"/>12545:                           case Set(Sock, Value) of
<a name="12546"/>12546:                               ok -&gt;
<a name="12547"/>12547:                                   {error, only_owner_may_set};
<a name="12548"/>12548:                               {error, {invalid, not_owner}} -&gt;
<a name="12549"/>12549:                                   ok;
<a name="12550"/>12550:                               {error, _} = ERROR -&gt;
<a name="12551"/>12551:                                   ERROR
<a name="12552"/>12552:                           end
<a name="12553"/>12553:                   end},
<a name="12554"/>12554: 
<a name="12555"/>12555:          #{desc =&gt; &quot;announce ready (test)&quot;,
<a name="12556"/>12556:            cmd  =&gt; fun(#{main := Main}) -&gt;
<a name="12557"/>12557:                            ?SEV_ANNOUNCE_READY(Main, test),
<a name="12558"/>12558:                            ok
<a name="12559"/>12559:                    end},
<a name="12560"/>12560: 
<a name="12561"/>12561:          ?SEV_FINISH_NORMAL],
<a name="12562"/>12562: 
<a name="12563"/>12563: 
<a name="12564"/>12564:     i(&quot;start tcp helper evaluator&quot;),
<a name="12565"/>12565:     Helper = ?SEV_START(&quot;tcp-helper&quot;, HelperSeq, #{}),
<a name="12566"/>12566: 
<a name="12567"/>12567:     i(&quot;start tcp main evaluator&quot;),
<a name="12568"/>12568:     MainState = #{domain =&gt; inet, type =&gt; stream, protocol =&gt; tcp,
<a name="12569"/>12569:                   helper =&gt; Helper#ev.pid},
<a name="12570"/>12570:     Main = ?SEV_START(&quot;tcp-main&quot;, MainSeq, MainState),
<a name="12571"/>12571: 
<a name="12572"/>12572:     i(&quot;await tcp evaluators&quot;),
<a name="api_opt_simple_otp_meta_option-last_expr"/><a name="12573"/>12573: <b>    ok = ?SEV_AWAIT_FINISH</b>([Helper, Main]).
<a name="12574"/>12574: 
<a name="12575"/>12575: 
<a name="12576"/>12576: 
<a name="12577"/>12577: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="12578"/>12578: 
<a name="12579"/>12579: <i>%% Perform some simple operations with the rcvbuf otp option</i>
<a name="12580"/>12580: <i>%% The operations we test here are only for type = stream and</i>
<a name="12581"/>12581: <i>%% protocol = tcp.</i>
<a name="api_opt_simple_otp_rcvbuf_option-1"/><a name="12582"/>12582: <b>api_opt_simple_otp_rcvbuf_option</b>(_Config) when is_list(_Config) -&gt;
<a name="12583"/>12583:     ?TT(?SECS(15)),
<a name="api_opt_simple_otp_rcvbuf_option-last_expr"/><a name="12584"/>12584: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="12585"/>12585:            fun() -&gt;
<a name="12586"/>12586:                    api_opt_simple_otp_rcvbuf_option()
<a name="12587"/>12587:            end).
<a name="12588"/>12588: 
<a name="api_opt_simple_otp_rcvbuf_option-0"/><a name="12589"/>12589: <b>api_opt_simple_otp_rcvbuf_option</b>() -&gt;
<a name="12590"/>12590:     Get = fun(S) -&gt;
<a name="12591"/>12591:                   socket:getopt(S, otp, rcvbuf)
<a name="12592"/>12592:           end,
<a name="12593"/>12593:     Set = fun(S, Val) -&gt;
<a name="12594"/>12594:                   socket:setopt(S, otp, rcvbuf, Val)
<a name="12595"/>12595:           end,
<a name="12596"/>12596: 
<a name="12597"/>12597:     ServerSeq = 
<a name="12598"/>12598:         [
<a name="12599"/>12599:          %% *** Wait for start order part ***
<a name="12600"/>12600:          #{desc =&gt; &quot;await start (from tester)&quot;,
<a name="12601"/>12601:            cmd  =&gt; fun(State) -&gt;
<a name="12602"/>12602:                            Tester = ?SEV_AWAIT_START(),
<a name="12603"/>12603:                            {ok, State#{tester =&gt; Tester}}
<a name="12604"/>12604:                    end},
<a name="12605"/>12605:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="12606"/>12606:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="12607"/>12607:                            _MRef = erlang:monitor(process, Tester),
<a name="12608"/>12608:                            ok
<a name="12609"/>12609:                    end},
<a name="12610"/>12610: 
<a name="12611"/>12611:          %% *** Init part ***
<a name="12612"/>12612:          #{desc =&gt; &quot;which local address&quot;,
<a name="12613"/>12613:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="12614"/>12614:                            LSA = which_local_socket_addr(Domain),
<a name="12615"/>12615:                            {ok, State#{local_sa =&gt; LSA}}
<a name="12616"/>12616:                    end},
<a name="12617"/>12617:          #{desc =&gt; &quot;create listen socket&quot;,
<a name="12618"/>12618:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="12619"/>12619:                            case socket:open(Domain, stream, tcp) of
<a name="12620"/>12620:                                {ok, Sock} -&gt;
<a name="12621"/>12621:                                    {ok, State#{lsock =&gt; Sock}};
<a name="12622"/>12622:                                {error, _} = ERROR -&gt;
<a name="12623"/>12623:                                    ERROR
<a name="12624"/>12624:                            end
<a name="12625"/>12625:                    end},
<a name="12626"/>12626:          #{desc =&gt; &quot;bind to local address&quot;,
<a name="12627"/>12627:            cmd  =&gt; fun(#{lsock := LSock, local_sa := LSA} = State) -&gt;
<a name="12628"/>12628:                            case sock_bind(LSock, LSA) of
<a name="12629"/>12629:                                ok -&gt;
<a name="12630"/>12630:                                    Port = sock_port(LSock),
<a name="12631"/>12631:                                    {ok, State#{lport =&gt; Port}};
<a name="12632"/>12632:                                {error, _} = ERROR -&gt;
<a name="12633"/>12633:                                    ERROR
<a name="12634"/>12634:                            end
<a name="12635"/>12635:                    end},
<a name="12636"/>12636:          #{desc =&gt; &quot;make listen socket&quot;,
<a name="12637"/>12637:            cmd  =&gt; fun(#{lsock := LSock}) -&gt;
<a name="12638"/>12638:                            socket:listen(LSock)
<a name="12639"/>12639:                    end},
<a name="12640"/>12640:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="12641"/>12641:            cmd  =&gt; fun(#{tester   := Tester,
<a name="12642"/>12642:                          local_sa := LocalSA,
<a name="12643"/>12643:                          lport    := Port}) -&gt;
<a name="12644"/>12644:                            ServerSA = LocalSA#{port =&gt; Port},
<a name="12645"/>12645:                            ?SEV_ANNOUNCE_READY(Tester, init, ServerSA),
<a name="12646"/>12646:                            ok
<a name="12647"/>12647:                    end},
<a name="12648"/>12648: 
<a name="12649"/>12649: 
<a name="12650"/>12650:          %% *** The actual test part ***
<a name="12651"/>12651:          #{desc =&gt; &quot;await continue (accept)&quot;,
<a name="12652"/>12652:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="12653"/>12653:                            ?SEV_AWAIT_CONTINUE(Tester, tester, accept)
<a name="12654"/>12654:                    end},
<a name="12655"/>12655:          #{desc =&gt; &quot;attempt to accept&quot;,
<a name="12656"/>12656:            cmd  =&gt; fun(#{lsock := LSock} = State) -&gt;
<a name="12657"/>12657:                            case socket:accept(LSock) of
<a name="12658"/>12658:                                {ok, Sock} -&gt;
<a name="12659"/>12659:                                    {ok, State#{sock =&gt; Sock}};
<a name="12660"/>12660:                                {error, _} = ERROR -&gt;
<a name="12661"/>12661:                                    ERROR
<a name="12662"/>12662:                            end
<a name="12663"/>12663:                    end},
<a name="12664"/>12664:          #{desc =&gt; &quot;announce ready (accept)&quot;,
<a name="12665"/>12665:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="12666"/>12666:                            ?SEV_ANNOUNCE_READY(Tester, accept),
<a name="12667"/>12667:                            ok
<a name="12668"/>12668:                    end},
<a name="12669"/>12669: 
<a name="12670"/>12670:          %% Recv with default size for (otp) rcvbuf
<a name="12671"/>12671:          #{desc =&gt; &quot;await continue (recv initial)&quot;,
<a name="12672"/>12672:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="12673"/>12673:                            case ?SEV_AWAIT_CONTINUE(Tester, tester, recv) of
<a name="12674"/>12674:                                {ok, MsgSz} -&gt;
<a name="12675"/>12675:                                    ?SEV_IPRINT(&quot;MsgSz: ~p&quot;, [MsgSz]),
<a name="12676"/>12676:                                    {ok, State#{msg_sz =&gt; MsgSz}};
<a name="12677"/>12677:                                {error, _} = ERROR -&gt;
<a name="12678"/>12678:                                    ERROR
<a name="12679"/>12679:                            end
<a name="12680"/>12680:                    end},
<a name="12681"/>12681:          #{desc =&gt; &quot;attempt to recv&quot;,
<a name="12682"/>12682:            cmd  =&gt; fun(#{sock := Sock, msg_sz := MsgSz} = _State) -&gt;
<a name="12683"/>12683:                            ?SEV_IPRINT(&quot;try recv ~w bytes when rcvbuf is ~s&quot;, 
<a name="12684"/>12684:                                        [MsgSz,
<a name="12685"/>12685:                                         case Get(Sock) of
<a name="12686"/>12686:                                             {ok, RcvBuf} -&gt; f(&quot;~w&quot;, [RcvBuf]);
<a name="12687"/>12687:                                             {error, _}   -&gt; &quot;-&quot;
<a name="12688"/>12688:                                         end]),
<a name="12689"/>12689:                            case socket:recv(Sock) of
<a name="12690"/>12690:                                {ok, Data} when (size(Data) =:= MsgSz) -&gt;
<a name="12691"/>12691:                                    ok;
<a name="12692"/>12692:                                {ok, Data} -&gt;
<a name="12693"/>12693:                                    {error, {invalid_msg_sz, MsgSz, size(Data)}};
<a name="12694"/>12694:                                {error, _} = ERROR -&gt;
<a name="12695"/>12695:                                    ERROR
<a name="12696"/>12696:                            end
<a name="12697"/>12697:                    end},
<a name="12698"/>12698:          #{desc =&gt; &quot;announce ready (recv initial)&quot;,
<a name="12699"/>12699:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="12700"/>12700:                            ?SEV_ANNOUNCE_READY(Tester, recv),
<a name="12701"/>12701:                            ok
<a name="12702"/>12702:                    end},
<a name="12703"/>12703: 
<a name="12704"/>12704:          %% Recv with new size (1) for (otp) rcvbuf
<a name="12705"/>12705:          #{desc =&gt; &quot;await continue (recv 1)&quot;,
<a name="12706"/>12706:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="12707"/>12707:                            case ?SEV_AWAIT_CONTINUE(Tester, tester, recv) of
<a name="12708"/>12708:                                {ok, NewRcvBuf} -&gt;
<a name="12709"/>12709:                                    ?SEV_IPRINT(&quot;set new rcvbuf: ~p&quot;, [NewRcvBuf]),
<a name="12710"/>12710:                                    {ok, State#{rcvbuf =&gt; NewRcvBuf}};
<a name="12711"/>12711:                                {error, _} = ERROR -&gt;
<a name="12712"/>12712:                                    ERROR
<a name="12713"/>12713:                            end
<a name="12714"/>12714:                    end},
<a name="12715"/>12715:          #{desc =&gt; &quot;attempt to setopt rcvbuf&quot;,
<a name="12716"/>12716:            cmd  =&gt; fun(#{sock := Sock, rcvbuf := NewRcvBuf} = _State) -&gt;
<a name="12717"/>12717:                            case Set(Sock, NewRcvBuf) of
<a name="12718"/>12718:                                ok -&gt;
<a name="12719"/>12719:                                    ok;
<a name="12720"/>12720:                                {error, _} = ERROR -&gt;
<a name="12721"/>12721:                                    ERROR
<a name="12722"/>12722:                            end
<a name="12723"/>12723:                    end},
<a name="12724"/>12724:          #{desc =&gt; &quot;attempt to recv&quot;,
<a name="12725"/>12725:            cmd  =&gt; fun(#{sock := Sock, msg_sz := MsgSz} = _State) -&gt;
<a name="12726"/>12726:                            ?SEV_IPRINT(&quot;try recv ~w bytes when rcvbuf is ~s&quot;, 
<a name="12727"/>12727:                                        [MsgSz,
<a name="12728"/>12728:                                         case Get(Sock) of
<a name="12729"/>12729:                                             {ok, RcvBuf} -&gt; f(&quot;~w&quot;, [RcvBuf]);
<a name="12730"/>12730:                                             {error, _}   -&gt; &quot;-&quot;
<a name="12731"/>12731:                                         end]),
<a name="12732"/>12732:                            case socket:recv(Sock) of
<a name="12733"/>12733:                                {ok, Data} when (size(Data) =:= MsgSz) -&gt;
<a name="12734"/>12734:                                    ok;
<a name="12735"/>12735:                                {ok, Data} -&gt;
<a name="12736"/>12736:                                    {error, {invalid_msg_sz, MsgSz, size(Data)}};
<a name="12737"/>12737:                                {error, _} = ERROR -&gt;
<a name="12738"/>12738:                                    ERROR
<a name="12739"/>12739:                            end
<a name="12740"/>12740:                    end},
<a name="12741"/>12741:          #{desc =&gt; &quot;announce ready (recv 1)&quot;,
<a name="12742"/>12742:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="12743"/>12743:                            ?SEV_ANNOUNCE_READY(Tester, recv),
<a name="12744"/>12744:                            ok
<a name="12745"/>12745:                    end},
<a name="12746"/>12746: 
<a name="12747"/>12747:          %% Recv with new size (2) for (otp) rcvbuf
<a name="12748"/>12748:          #{desc =&gt; &quot;await continue (recv 2)&quot;,
<a name="12749"/>12749:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="12750"/>12750:                            case ?SEV_AWAIT_CONTINUE(Tester, tester, recv) of
<a name="12751"/>12751:                                {ok, NewRcvBuf} -&gt;
<a name="12752"/>12752:                                    ?SEV_IPRINT(&quot;set new rcvbuf: ~p&quot;, [NewRcvBuf]),
<a name="12753"/>12753:                                    {ok, State#{rcvbuf =&gt; NewRcvBuf}};
<a name="12754"/>12754:                                {error, _} = ERROR -&gt;
<a name="12755"/>12755:                                    ERROR
<a name="12756"/>12756:                            end
<a name="12757"/>12757:                    end},
<a name="12758"/>12758:          #{desc =&gt; &quot;attempt to setopt rcvbuf&quot;,
<a name="12759"/>12759:            cmd  =&gt; fun(#{sock := Sock, rcvbuf := NewRcvBuf} = _State) -&gt;
<a name="12760"/>12760:                            case Set(Sock, NewRcvBuf) of
<a name="12761"/>12761:                                ok -&gt;
<a name="12762"/>12762:                                    ok;
<a name="12763"/>12763:                                {error, _} = ERROR -&gt;
<a name="12764"/>12764:                                    ERROR
<a name="12765"/>12765:                            end
<a name="12766"/>12766:                    end},
<a name="12767"/>12767:          #{desc =&gt; &quot;attempt to recv&quot;,
<a name="12768"/>12768:            cmd  =&gt; fun(#{sock := Sock, msg_sz := MsgSz} = _State) -&gt;
<a name="12769"/>12769:                            case socket:recv(Sock) of
<a name="12770"/>12770:                                {ok, Data} when (size(Data) =:= MsgSz) -&gt;
<a name="12771"/>12771:                                    ok;
<a name="12772"/>12772:                                {ok, Data} -&gt;
<a name="12773"/>12773:                                    {error, {invalid_msg_sz, MsgSz, size(Data)}};
<a name="12774"/>12774:                                {error, _} = ERROR -&gt;
<a name="12775"/>12775:                                    ERROR
<a name="12776"/>12776:                            end
<a name="12777"/>12777:                    end},
<a name="12778"/>12778:          #{desc =&gt; &quot;announce ready (recv 2)&quot;,
<a name="12779"/>12779:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="12780"/>12780:                            ?SEV_ANNOUNCE_READY(Tester, recv),
<a name="12781"/>12781:                            ok
<a name="12782"/>12782:                    end},
<a name="12783"/>12783: 
<a name="12784"/>12784:          %% Recv with new size (3) for (otp) rcvbuf
<a name="12785"/>12785:          #{desc =&gt; &quot;await continue (recv 3, truncated)&quot;,
<a name="12786"/>12786:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="12787"/>12787:                            case ?SEV_AWAIT_CONTINUE(Tester, tester, recv) of
<a name="12788"/>12788:                                {ok, {ExpSz, NewRcvBuf}} -&gt;
<a name="12789"/>12789:                                    ?SEV_IPRINT(&quot;set new rcvbuf:&quot;
<a name="12790"/>12790:                                                &quot;~n   New RcvBuf:  ~p&quot;
<a name="12791"/>12791:                                                &quot;~n   Expect Size: ~p&quot;,
<a name="12792"/>12792:                                                [ExpSz, NewRcvBuf]),
<a name="12793"/>12793:                                    {ok, State#{msg_sz =&gt; ExpSz,
<a name="12794"/>12794:                                                rcvbuf =&gt; NewRcvBuf}};
<a name="12795"/>12795:                                {error, _} = ERROR -&gt;
<a name="12796"/>12796:                                    ERROR
<a name="12797"/>12797:                            end
<a name="12798"/>12798:                    end},
<a name="12799"/>12799:          #{desc =&gt; &quot;attempt to setopt rcvbuf&quot;,
<a name="12800"/>12800:            cmd  =&gt; fun(#{sock := Sock, rcvbuf := NewRcvBuf} = _State) -&gt;
<a name="12801"/>12801:                            case Set(Sock, NewRcvBuf) of
<a name="12802"/>12802:                                ok -&gt;
<a name="12803"/>12803:                                    ?SEV_IPRINT(&quot;set new rcvbuf: ~p&quot;,
<a name="12804"/>12804:                                                [NewRcvBuf]),
<a name="12805"/>12805:                                    ok;
<a name="12806"/>12806:                                {error, _} = ERROR -&gt;
<a name="12807"/>12807:                                    ERROR
<a name="12808"/>12808:                            end
<a name="12809"/>12809:                    end},
<a name="12810"/>12810:          #{desc =&gt; &quot;attempt to recv&quot;,
<a name="12811"/>12811:            cmd  =&gt; fun(#{sock := Sock, msg_sz := MsgSz} = _State) -&gt;
<a name="12812"/>12812:                            ?SEV_IPRINT(&quot;try recv ~w bytes of data&quot;, [MsgSz]),
<a name="12813"/>12813:                            case socket:recv(Sock) of
<a name="12814"/>12814:                                {ok, Data} when (size(Data) =:= MsgSz) -&gt;
<a name="12815"/>12815:                                    ok;
<a name="12816"/>12816:                                {ok, Data} -&gt;
<a name="12817"/>12817:                                    {error, {invalid_msg_sz, MsgSz, size(Data)}};
<a name="12818"/>12818:                                {error, _} = ERROR -&gt;
<a name="12819"/>12819:                                    ERROR
<a name="12820"/>12820:                            end
<a name="12821"/>12821:                    end},
<a name="12822"/>12822:          #{desc =&gt; &quot;announce ready (recv)&quot;,
<a name="12823"/>12823:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="12824"/>12824:                            ?SEV_ANNOUNCE_READY(Tester, recv),
<a name="12825"/>12825:                            ok
<a name="12826"/>12826:                    end},
<a name="12827"/>12827: 
<a name="12828"/>12828: 
<a name="12829"/>12829:          %% Termination
<a name="12830"/>12830:          #{desc =&gt; &quot;await terminate&quot;,
<a name="12831"/>12831:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="12832"/>12832:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="12833"/>12833:                                ok -&gt;
<a name="12834"/>12834:                                    {ok, maps:remove(tester, State)};
<a name="12835"/>12835:                                {error, _} = ERROR -&gt;
<a name="12836"/>12836:                                    ERROR
<a name="12837"/>12837:                            end
<a name="12838"/>12838:                    end},
<a name="12839"/>12839:          #{desc =&gt; &quot;close socket(s)&quot;,
<a name="12840"/>12840:            cmd  =&gt; fun(#{lsock := LSock, sock := Sock} = State) -&gt;
<a name="12841"/>12841:                            sock_close(Sock),
<a name="12842"/>12842:                            sock_close(LSock),
<a name="12843"/>12843:                            State1 = maps:remove(sock,  State),
<a name="12844"/>12844:                            State2 = maps:remove(lport, State1),
<a name="12845"/>12845:                            State3 = maps:remove(lsock, State2),
<a name="12846"/>12846:                            {ok, State3}
<a name="12847"/>12847:                    end},
<a name="12848"/>12848: 
<a name="12849"/>12849:          %% *** We are done ***
<a name="12850"/>12850:          ?SEV_FINISH_NORMAL
<a name="12851"/>12851:         ],
<a name="12852"/>12852: 
<a name="12853"/>12853:     ClientSeq =
<a name="12854"/>12854:         [
<a name="12855"/>12855:          %% *** Wait for start order part ***
<a name="12856"/>12856:          #{desc =&gt; &quot;await start&quot;,
<a name="12857"/>12857:            cmd  =&gt; fun(State) -&gt;
<a name="12858"/>12858:                            {Tester, ServerSA} = ?SEV_AWAIT_START(),
<a name="12859"/>12859:                            {ok, State#{tester    =&gt; Tester,
<a name="12860"/>12860:                                        server_sa =&gt; ServerSA}}
<a name="12861"/>12861:                    end},
<a name="12862"/>12862:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="12863"/>12863:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="12864"/>12864:                            _MRef = erlang:monitor(process, Tester),
<a name="12865"/>12865:                            ok
<a name="12866"/>12866:                    end},
<a name="12867"/>12867: 
<a name="12868"/>12868:          %% *** Init part ***
<a name="12869"/>12869:          #{desc =&gt; &quot;which local address&quot;,
<a name="12870"/>12870:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="12871"/>12871:                            LSA = which_local_socket_addr(Domain),
<a name="12872"/>12872:                            {ok, State#{local_sa =&gt; LSA}}
<a name="12873"/>12873:                    end},
<a name="12874"/>12874:          #{desc =&gt; &quot;create socket&quot;,
<a name="12875"/>12875:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="12876"/>12876:                            case socket:open(Domain, stream, tcp) of
<a name="12877"/>12877:                                {ok, Sock} -&gt;
<a name="12878"/>12878:                                    {ok, State#{sock =&gt; Sock}};
<a name="12879"/>12879:                                {error, _} = ERROR -&gt;
<a name="12880"/>12880:                                    ERROR
<a name="12881"/>12881:                            end
<a name="12882"/>12882:                    end},
<a name="12883"/>12883:          #{desc =&gt; &quot;bind to local address&quot;,
<a name="12884"/>12884:            cmd  =&gt; fun(#{sock := Sock, local_sa := LSA} = _State) -&gt;
<a name="12885"/>12885:                            case sock_bind(Sock, LSA) of
<a name="12886"/>12886:                                ok -&gt;
<a name="12887"/>12887:                                    ok;
<a name="12888"/>12888:                                {error, _} = ERROR -&gt;
<a name="12889"/>12889:                                    ERROR
<a name="12890"/>12890:                            end
<a name="12891"/>12891:                    end},
<a name="12892"/>12892:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="12893"/>12893:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="12894"/>12894:                            ?SEV_ANNOUNCE_READY(Tester, init),
<a name="12895"/>12895:                            ok
<a name="12896"/>12896:                    end},
<a name="12897"/>12897: 
<a name="12898"/>12898:          %% The actual test
<a name="12899"/>12899:          #{desc =&gt; &quot;await continue (connect)&quot;,
<a name="12900"/>12900:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="12901"/>12901:                            ?SEV_AWAIT_CONTINUE(Tester, tester, connect)
<a name="12902"/>12902:                    end},
<a name="12903"/>12903:          #{desc =&gt; &quot;connect to server&quot;,
<a name="12904"/>12904:            cmd  =&gt; fun(#{sock := Sock, server_sa := SSA}) -&gt;
<a name="12905"/>12905:                            socket:connect(Sock, SSA)
<a name="12906"/>12906:                    end},
<a name="12907"/>12907:          #{desc =&gt; &quot;announce ready (connect)&quot;,
<a name="12908"/>12908:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="12909"/>12909:                            ?SEV_ANNOUNCE_READY(Tester, connect),
<a name="12910"/>12910:                            ok
<a name="12911"/>12911:                    end},
<a name="12912"/>12912: 
<a name="12913"/>12913:          #{desc =&gt; &quot;await continue (send initial)&quot;,
<a name="12914"/>12914:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="12915"/>12915:                            case ?SEV_AWAIT_CONTINUE(Tester, tester, send) of
<a name="12916"/>12916:                                {ok, Data} -&gt;
<a name="12917"/>12917:                                    {ok, State#{data =&gt; Data}};
<a name="12918"/>12918:                                {error, _} = ERROR -&gt;
<a name="12919"/>12919:                                    ERROR
<a name="12920"/>12920:                            end
<a name="12921"/>12921:                    end},
<a name="12922"/>12922:          #{desc =&gt; &quot;send (initial) data to server&quot;,
<a name="12923"/>12923:            cmd  =&gt; fun(#{sock := Sock, data := Data} = _State) -&gt;
<a name="12924"/>12924:                            ?SEV_IPRINT(&quot;try send ~w bytes&quot;, [size(Data)]),
<a name="12925"/>12925:                            socket:send(Sock, Data)
<a name="12926"/>12926:                    end},
<a name="12927"/>12927:          #{desc =&gt; &quot;announce ready (send initial)&quot;,
<a name="12928"/>12928:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="12929"/>12929:                            ?SEV_ANNOUNCE_READY(Tester, send),
<a name="12930"/>12930:                            ok
<a name="12931"/>12931:                    end},
<a name="12932"/>12932: 
<a name="12933"/>12933:          #{desc =&gt; &quot;await continue (send 1)&quot;,
<a name="12934"/>12934:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="12935"/>12935:                            ?SEV_AWAIT_CONTINUE(Tester, tester, send)
<a name="12936"/>12936:                    end},
<a name="12937"/>12937:          #{desc =&gt; &quot;send (1) data to server&quot;,
<a name="12938"/>12938:            cmd  =&gt; fun(#{sock := Sock, data := Data}) -&gt;
<a name="12939"/>12939:                            ?SEV_IPRINT(&quot;try send ~w bytes&quot;, [size(Data)]),
<a name="12940"/>12940:                            socket:send(Sock, Data)
<a name="12941"/>12941:                    end},
<a name="12942"/>12942:          #{desc =&gt; &quot;announce ready (send 1)&quot;,
<a name="12943"/>12943:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="12944"/>12944:                            ?SEV_ANNOUNCE_READY(Tester, send),
<a name="12945"/>12945:                            ok
<a name="12946"/>12946:                    end},
<a name="12947"/>12947: 
<a name="12948"/>12948:          #{desc =&gt; &quot;await continue (send 2)&quot;,
<a name="12949"/>12949:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="12950"/>12950:                            ?SEV_AWAIT_CONTINUE(Tester, tester, send)
<a name="12951"/>12951:                    end},
<a name="12952"/>12952:          #{desc =&gt; &quot;send (2) data to server&quot;,
<a name="12953"/>12953:            cmd  =&gt; fun(#{sock := Sock, data := Data}) -&gt;
<a name="12954"/>12954:                            ?SEV_IPRINT(&quot;try send ~w bytes&quot;, [size(Data)]),
<a name="12955"/>12955:                            socket:send(Sock, Data)
<a name="12956"/>12956:                    end},
<a name="12957"/>12957:          #{desc =&gt; &quot;announce ready (send 2)&quot;,
<a name="12958"/>12958:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="12959"/>12959:                            ?SEV_ANNOUNCE_READY(Tester, send),
<a name="12960"/>12960:                            ok
<a name="12961"/>12961:                    end},
<a name="12962"/>12962: 
<a name="12963"/>12963:          #{desc =&gt; &quot;await continue (send 3)&quot;,
<a name="12964"/>12964:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="12965"/>12965:                            ?SEV_AWAIT_CONTINUE(Tester, tester, send)
<a name="12966"/>12966:                    end},
<a name="12967"/>12967:          #{desc =&gt; &quot;send (3) data to server&quot;,
<a name="12968"/>12968:            cmd  =&gt; fun(#{sock := Sock, data := Data}) -&gt;
<a name="12969"/>12969:                            ?SEV_IPRINT(&quot;try send ~w bytes&quot;, [size(Data)]),
<a name="12970"/>12970:                            socket:send(Sock, Data)
<a name="12971"/>12971:                    end},
<a name="12972"/>12972:          #{desc =&gt; &quot;announce ready (send 3)&quot;,
<a name="12973"/>12973:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="12974"/>12974:                            ?SEV_ANNOUNCE_READY(Tester, send),
<a name="12975"/>12975:                            ok
<a name="12976"/>12976:                    end},
<a name="12977"/>12977: 
<a name="12978"/>12978: 
<a name="12979"/>12979:          %% Termination
<a name="12980"/>12980:          #{desc =&gt; &quot;await terminate&quot;,
<a name="12981"/>12981:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="12982"/>12982:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="12983"/>12983:                                ok -&gt;
<a name="12984"/>12984:                                    {ok, maps:remove(tester, State)};
<a name="12985"/>12985:                                {error, _} = ERROR -&gt;
<a name="12986"/>12986:                                    ERROR
<a name="12987"/>12987:                            end
<a name="12988"/>12988:                    end},
<a name="12989"/>12989:          #{desc =&gt; &quot;close socket&quot;,
<a name="12990"/>12990:            cmd  =&gt; fun(#{sock := Sock}) -&gt;
<a name="12991"/>12991:                            socket:close(Sock)
<a name="12992"/>12992:                    end},
<a name="12993"/>12993: 
<a name="12994"/>12994:          %% *** We are done ***
<a name="12995"/>12995:          ?SEV_FINISH_NORMAL
<a name="12996"/>12996:         ],
<a name="12997"/>12997: 
<a name="12998"/>12998:     TesterSeq =
<a name="12999"/>12999:         [
<a name="13000"/>13000:          %% *** Init part ***
<a name="13001"/>13001:          #{desc =&gt; &quot;monitor server&quot;,
<a name="13002"/>13002:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="13003"/>13003:                            _MRef = erlang:monitor(process, Server),
<a name="13004"/>13004:                            ok
<a name="13005"/>13005:                    end},
<a name="13006"/>13006:          #{desc =&gt; &quot;monitor client&quot;,
<a name="13007"/>13007:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="13008"/>13008:                            _MRef = erlang:monitor(process, Client),
<a name="13009"/>13009:                            ok
<a name="13010"/>13010:                    end},
<a name="13011"/>13011:          #{desc =&gt; &quot;order server start&quot;,
<a name="13012"/>13012:            cmd  =&gt; fun(#{server := Server}) -&gt;
<a name="13013"/>13013:                            ?SEV_ANNOUNCE_START(Server)
<a name="13014"/>13014:                    end},
<a name="13015"/>13015:          #{desc =&gt; &quot;await server ready (init)&quot;,
<a name="13016"/>13016:            cmd  =&gt; fun(#{server := Server} = State) -&gt;
<a name="13017"/>13017:                            {ok, ServerSA} = ?SEV_AWAIT_READY(Server, server, init),
<a name="13018"/>13018:                            {ok, State#{server_sa =&gt; ServerSA}}
<a name="13019"/>13019:                    end},
<a name="13020"/>13020:          #{desc =&gt; &quot;order client start&quot;,
<a name="13021"/>13021:            cmd  =&gt; fun(#{client    := Client,
<a name="13022"/>13022:                          server_sa := ServerSA}) -&gt;
<a name="13023"/>13023:                            ?SEV_ANNOUNCE_START(Client, ServerSA),
<a name="13024"/>13024:                            ok
<a name="13025"/>13025:                    end},
<a name="13026"/>13026:          #{desc =&gt; &quot;await client ready (init)&quot;,
<a name="13027"/>13027:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="13028"/>13028:                            ?SEV_AWAIT_READY(Client, client, init)
<a name="13029"/>13029:                    end},
<a name="13030"/>13030: 
<a name="13031"/>13031: 
<a name="13032"/>13032:          %% The actual test (connecting)
<a name="13033"/>13033:          #{desc =&gt; &quot;order server accept (accept)&quot;,
<a name="13034"/>13034:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="13035"/>13035:                            ?SEV_ANNOUNCE_CONTINUE(Server, accept),
<a name="13036"/>13036:                            ok
<a name="13037"/>13037:                    end},
<a name="13038"/>13038:          ?SEV_SLEEP(?SECS(1)),
<a name="13039"/>13039:          #{desc =&gt; &quot;order client continue (connect)&quot;,
<a name="13040"/>13040:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="13041"/>13041:                            ?SEV_ANNOUNCE_CONTINUE(Client, connect),
<a name="13042"/>13042:                            ok
<a name="13043"/>13043:                    end},
<a name="13044"/>13044:          #{desc =&gt; &quot;await client ready (connect)&quot;,
<a name="13045"/>13045:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="13046"/>13046:                            ?SEV_AWAIT_READY(Client, client, connect)
<a name="13047"/>13047:                    end},
<a name="13048"/>13048:          #{desc =&gt; &quot;await server ready (accept)&quot;,
<a name="13049"/>13049:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="13050"/>13050:                            ?SEV_AWAIT_READY(Server, server, accept)
<a name="13051"/>13051:                    end},
<a name="13052"/>13052: 
<a name="13053"/>13053:          %% The actual test (initial part)
<a name="13054"/>13054:          #{desc =&gt; &quot;order client continue (send initial)&quot;,
<a name="13055"/>13055:            cmd  =&gt; fun(#{client := Client, data := Data} = _State) -&gt;
<a name="13056"/>13056:                            ?SEV_ANNOUNCE_CONTINUE(Client, send, Data),
<a name="13057"/>13057:                            ok
<a name="13058"/>13058:                    end},
<a name="13059"/>13059:          ?SEV_SLEEP(?SECS(1)),
<a name="13060"/>13060:          #{desc =&gt; &quot;order server continue (recv initial)&quot;,
<a name="13061"/>13061:            cmd  =&gt; fun(#{server := Server, data := Data} = _State) -&gt;
<a name="13062"/>13062:                            ExpMsgSz = size(Data),
<a name="13063"/>13063:                            ?SEV_ANNOUNCE_CONTINUE(Server, recv, ExpMsgSz),
<a name="13064"/>13064:                            ok
<a name="13065"/>13065:                    end},
<a name="13066"/>13066:          #{desc =&gt; &quot;await client ready (send initial)&quot;,
<a name="13067"/>13067:            cmd  =&gt; fun(#{server := Server,
<a name="13068"/>13068:                          client := Client} = _State) -&gt;
<a name="13069"/>13069:                            case ?SEV_AWAIT_READY(Client, client, send,
<a name="13070"/>13070:                                                  [{server, Server}]) of
<a name="13071"/>13071:                                ok -&gt;
<a name="13072"/>13072:                                    ok;
<a name="13073"/>13073:                                {error, _} = ERROR -&gt;
<a name="13074"/>13074:                                    ERROR
<a name="13075"/>13075:                            end
<a name="13076"/>13076:                    end},
<a name="13077"/>13077:          #{desc =&gt; &quot;await server ready (recv initial)&quot;,
<a name="13078"/>13078:            cmd  =&gt; fun(#{server := Server,
<a name="13079"/>13079:                          client := Client} = _State) -&gt;
<a name="13080"/>13080:                            case ?SEV_AWAIT_READY(Server, client, recv,
<a name="13081"/>13081:                                                  [{client, Client}]) of
<a name="13082"/>13082:                                ok -&gt;
<a name="13083"/>13083:                                    ok;
<a name="13084"/>13084:                                {error, _} = ERROR -&gt;
<a name="13085"/>13085:                                    ERROR
<a name="13086"/>13086:                            end
<a name="13087"/>13087:                    end},
<a name="13088"/>13088: 
<a name="13089"/>13089:          %% The actual test (part 1)
<a name="13090"/>13090:          #{desc =&gt; &quot;order client continue (send 1)&quot;,
<a name="13091"/>13091:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="13092"/>13092:                            ?SEV_ANNOUNCE_CONTINUE(Client, send),
<a name="13093"/>13093:                            ok
<a name="13094"/>13094:                    end},
<a name="13095"/>13095:          ?SEV_SLEEP(?SECS(1)),
<a name="13096"/>13096:          #{desc =&gt; &quot;order server continue (recv 1)&quot;,
<a name="13097"/>13097:            cmd  =&gt; fun(#{server := Server, data := Data} = _State) -&gt;
<a name="13098"/>13098:                            MsgSz     = size(Data),
<a name="13099"/>13099:                            NewRcvBuf =
<a name="13100"/>13100:                                case os:type() of
<a name="13101"/>13101:                                    {win32, nt} -&gt;
<a name="13102"/>13102:                                        (((2 * MsgSz) div 1024) + 1) * 1024;
<a name="13103"/>13103:                                    _ -&gt;
<a name="13104"/>13104:                                        {2 + (MsgSz div 1024), 1024}
<a name="13105"/>13105:                                end,
<a name="13106"/>13106:                            ?SEV_ANNOUNCE_CONTINUE(Server, recv, NewRcvBuf),
<a name="13107"/>13107:                            ok
<a name="13108"/>13108:                    end},
<a name="13109"/>13109:          #{desc =&gt; &quot;await client ready (send 1)&quot;,
<a name="13110"/>13110:            cmd  =&gt; fun(#{server := Server,
<a name="13111"/>13111:                          client := Client} = _State) -&gt;
<a name="13112"/>13112:                            case ?SEV_AWAIT_READY(Client, client, send,
<a name="13113"/>13113:                                                  [{server, Server}]) of
<a name="13114"/>13114:                                ok -&gt;
<a name="13115"/>13115:                                    ok;
<a name="13116"/>13116:                                {error, _} = ERROR -&gt;
<a name="13117"/>13117:                                    ERROR
<a name="13118"/>13118:                            end
<a name="13119"/>13119:                    end},
<a name="13120"/>13120:          #{desc =&gt; &quot;await server ready (recv 1)&quot;,
<a name="13121"/>13121:            cmd  =&gt; fun(#{server := Server,
<a name="13122"/>13122:                          client := Client} = _State) -&gt;
<a name="13123"/>13123:                            case ?SEV_AWAIT_READY(Server, client, recv,
<a name="13124"/>13124:                                                  [{client, Client}]) of
<a name="13125"/>13125:                                ok -&gt;
<a name="13126"/>13126:                                    ok;
<a name="13127"/>13127:                                {error, _} = ERROR -&gt;
<a name="13128"/>13128:                                    ERROR
<a name="13129"/>13129:                            end
<a name="13130"/>13130:                    end},
<a name="13131"/>13131: 
<a name="13132"/>13132:          %% The actual test (part 2)
<a name="13133"/>13133:          #{desc =&gt; &quot;order client continue (send 2)&quot;,
<a name="13134"/>13134:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="13135"/>13135:                            ?SEV_ANNOUNCE_CONTINUE(Client, send),
<a name="13136"/>13136:                            ok
<a name="13137"/>13137:                    end},
<a name="13138"/>13138:          ?SEV_SLEEP(?SECS(1)),
<a name="13139"/>13139:          #{desc =&gt; &quot;order server continue (recv 2)&quot;,
<a name="13140"/>13140:            cmd  =&gt; fun(#{server := Server, data := Data} = _State) -&gt;
<a name="13141"/>13141:                            MsgSz     = size(Data),
<a name="13142"/>13142:                            NewRcvBuf = 
<a name="13143"/>13143:                                case os:type() of
<a name="13144"/>13144:                                    {win32, nt} -&gt;
<a name="13145"/>13145:                                        (((3 * MsgSz) div 1024) + 1) * 1024;
<a name="13146"/>13146:                                    _ -&gt;
<a name="13147"/>13147:                                        {2 + (MsgSz div 2048), 2048}
<a name="13148"/>13148:                                end,
<a name="13149"/>13149:                            ?SEV_ANNOUNCE_CONTINUE(Server, recv, NewRcvBuf),
<a name="13150"/>13150:                            ok
<a name="13151"/>13151:                    end},
<a name="13152"/>13152:          #{desc =&gt; &quot;await client ready (send 2)&quot;,
<a name="13153"/>13153:            cmd  =&gt; fun(#{server := Server,
<a name="13154"/>13154:                          client := Client} = _State) -&gt;
<a name="13155"/>13155:                            case ?SEV_AWAIT_READY(Client, client, send,
<a name="13156"/>13156:                                                  [{server, Server}]) of
<a name="13157"/>13157:                                ok -&gt;
<a name="13158"/>13158:                                    ok;
<a name="13159"/>13159:                                {error, _} = ERROR -&gt;
<a name="13160"/>13160:                                    ERROR
<a name="13161"/>13161:                            end
<a name="13162"/>13162:                    end},
<a name="13163"/>13163:          #{desc =&gt; &quot;await server ready (recv 2)&quot;,
<a name="13164"/>13164:            cmd  =&gt; fun(#{server := Server,
<a name="13165"/>13165:                          client := Client} = _State) -&gt;
<a name="13166"/>13166:                            case ?SEV_AWAIT_READY(Server, client, recv,
<a name="13167"/>13167:                                                  [{client, Client}]) of
<a name="13168"/>13168:                                ok -&gt;
<a name="13169"/>13169:                                    ok;
<a name="13170"/>13170:                                {error, _} = ERROR -&gt;
<a name="13171"/>13171:                                    ERROR
<a name="13172"/>13172:                            end
<a name="13173"/>13173:                    end},
<a name="13174"/>13174: 
<a name="13175"/>13175: 
<a name="13176"/>13176:          %% The actual test (part 3)
<a name="13177"/>13177:          #{desc =&gt; &quot;order client continue (send 3)&quot;,
<a name="13178"/>13178:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="13179"/>13179:                            ?SEV_ANNOUNCE_CONTINUE(Client, send),
<a name="13180"/>13180:                            ok
<a name="13181"/>13181:                    end},
<a name="13182"/>13182:          ?SEV_SLEEP(?SECS(1)),
<a name="13183"/>13183:          #{desc =&gt; &quot;order server continue (recv 3)&quot;,
<a name="13184"/>13184:            cmd  =&gt; fun(#{server := Server, data := Data} = _State) -&gt;
<a name="13185"/>13185:                            MsgSz = size(Data),
<a name="13186"/>13186:                            BufSz = 2048,
<a name="13187"/>13187:                            N     = MsgSz div BufSz - 1,
<a name="13188"/>13188:                            {ExpSz, NewRcvBuf} =
<a name="13189"/>13189:                                case os:type() of
<a name="13190"/>13190:                                    {win32, nt} -&gt;
<a name="13191"/>13191:                                        {N*BufSz, N*BufSz};
<a name="13192"/>13192:                                    _ -&gt;
<a name="13193"/>13193:                                        {N*BufSz, {N, BufSz}}
<a name="13194"/>13194:                                end,
<a name="13195"/>13195:                            ?SEV_ANNOUNCE_CONTINUE(Server, recv,
<a name="13196"/>13196:                                                   {ExpSz, NewRcvBuf})
<a name="13197"/>13197:                    end},
<a name="13198"/>13198:          #{desc =&gt; &quot;await client ready (send 3)&quot;,
<a name="13199"/>13199:            cmd  =&gt; fun(#{server := Server,
<a name="13200"/>13200:                          client := Client} = _State) -&gt;
<a name="13201"/>13201:                            case ?SEV_AWAIT_READY(Client, client, send,
<a name="13202"/>13202:                                                  [{server, Server}]) of
<a name="13203"/>13203:                                ok -&gt;
<a name="13204"/>13204:                                    ok;
<a name="13205"/>13205:                                {error, _} = ERROR -&gt;
<a name="13206"/>13206:                                    ERROR
<a name="13207"/>13207:                            end
<a name="13208"/>13208:                    end},
<a name="13209"/>13209:          #{desc =&gt; &quot;await server ready (recv 3)&quot;,
<a name="13210"/>13210:            cmd  =&gt; fun(#{server := Server,
<a name="13211"/>13211:                          client := Client} = _State) -&gt;
<a name="13212"/>13212:                            case ?SEV_AWAIT_READY(Server, client, recv,
<a name="13213"/>13213:                                                  [{client, Client}]) of
<a name="13214"/>13214:                                ok -&gt;
<a name="13215"/>13215:                                    ok;
<a name="13216"/>13216:                                {error, _} = ERROR -&gt;
<a name="13217"/>13217:                                    ERROR
<a name="13218"/>13218:                            end
<a name="13219"/>13219:                    end},
<a name="13220"/>13220: 
<a name="13221"/>13221: 
<a name="13222"/>13222:          ?SEV_SLEEP(?SECS(1)),
<a name="13223"/>13223: 
<a name="13224"/>13224:          %% *** Terminate server ***
<a name="13225"/>13225:          #{desc =&gt; &quot;order client terminate&quot;,
<a name="13226"/>13226:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="13227"/>13227:                            ?SEV_ANNOUNCE_TERMINATE(Client),
<a name="13228"/>13228:                            ok
<a name="13229"/>13229:                    end},
<a name="13230"/>13230:          #{desc =&gt; &quot;await client down&quot;,
<a name="13231"/>13231:            cmd  =&gt; fun(#{client := Client} = State) -&gt;
<a name="13232"/>13232:                            ?SEV_AWAIT_TERMINATION(Client),
<a name="13233"/>13233:                            State1 = maps:remove(client,    State),
<a name="13234"/>13234:                            {ok, State1}
<a name="13235"/>13235:                    end},
<a name="13236"/>13236:          #{desc =&gt; &quot;order server terminate&quot;,
<a name="13237"/>13237:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="13238"/>13238:                            ?SEV_ANNOUNCE_TERMINATE(Server),
<a name="13239"/>13239:                            ok
<a name="13240"/>13240:                    end},
<a name="13241"/>13241:          #{desc =&gt; &quot;await server down&quot;,
<a name="13242"/>13242:            cmd  =&gt; fun(#{server := Server} = State) -&gt;
<a name="13243"/>13243:                            ?SEV_AWAIT_TERMINATION(Server),
<a name="13244"/>13244:                            State1 = maps:remove(server,    State),
<a name="13245"/>13245:                            State2 = maps:remove(server_sa, State1),
<a name="13246"/>13246:                            {ok, State2}
<a name="13247"/>13247:                    end},
<a name="13248"/>13248: 
<a name="13249"/>13249:          %% *** We are done ***
<a name="13250"/>13250:          ?SEV_FINISH_NORMAL
<a name="13251"/>13251:         ],
<a name="13252"/>13252: 
<a name="13253"/>13253:     %% Create a data binary of 6*1024 bytes
<a name="13254"/>13254:     Data      = list_to_binary(lists:duplicate(6*4, lists:seq(0, 255))),
<a name="13255"/>13255:     InitState = #{domain =&gt; inet_or_inet6(),
<a name="13256"/>13256:                   data   =&gt; Data},
<a name="13257"/>13257: 
<a name="13258"/>13258:     i(&quot;create server evaluator&quot;),
<a name="13259"/>13259:     ServerInitState = #{domain =&gt; maps:get(domain, InitState)},
<a name="13260"/>13260:     Server          = ?SEV_START(&quot;server&quot;, ServerSeq, ServerInitState),
<a name="13261"/>13261: 
<a name="13262"/>13262:     i(&quot;create client evaluator&quot;),
<a name="13263"/>13263:     ClientInitState = #{host   =&gt; local_host(),
<a name="13264"/>13264:                         domain =&gt; maps:get(domain, InitState)},
<a name="13265"/>13265:     Client          = ?SEV_START(&quot;client&quot;, ClientSeq, ClientInitState),
<a name="13266"/>13266: 
<a name="13267"/>13267:     i(&quot;create tester evaluator&quot;),
<a name="13268"/>13268:     TesterInitState = InitState#{server =&gt; Server#ev.pid,
<a name="13269"/>13269:                                  client =&gt; Client#ev.pid},
<a name="13270"/>13270:     Tester          = ?SEV_START(&quot;tester&quot;, TesterSeq, TesterInitState),
<a name="13271"/>13271: 
<a name="13272"/>13272:     i(&quot;await evaluator(s)&quot;),
<a name="api_opt_simple_otp_rcvbuf_option-last_expr"/><a name="13273"/>13273: <b>    ok = ?SEV_AWAIT_FINISH</b>([Server, Client, Tester]).
<a name="13274"/>13274: 
<a name="13275"/>13275: 
<a name="13276"/>13276: 
<a name="13277"/>13277: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="13278"/>13278: 
<a name="13279"/>13279: <i>%% Perform some simple getopt and setopt with the level = otp options</i>
<a name="api_opt_simple_otp_controlling_process-1"/><a name="13280"/>13280: <b>api_opt_simple_otp_controlling_process</b>(_Config) when is_list(_Config) -&gt;
<a name="13281"/>13281:     ?TT(?SECS(30)),
<a name="api_opt_simple_otp_controlling_process-last_expr"/><a name="13282"/>13282: <b>    tc_try</b>(api_opt_simple_otp_controlling_process,
<a name="13283"/>13283:            fun() -&gt; api_opt_simple_otp_controlling_process() end).
<a name="13284"/>13284: 
<a name="api_opt_simple_otp_controlling_process-0"/><a name="13285"/>13285: <b>api_opt_simple_otp_controlling_process</b>() -&gt;
<a name="13286"/>13286:     Get = fun(S, Key) -&gt;
<a name="13287"/>13287:                   socket:getopt(S, otp, Key)
<a name="13288"/>13288:           end,
<a name="13289"/>13289:     Set = fun(S, Key, Val) -&gt;
<a name="13290"/>13290:                   socket:setopt(S, otp, Key, Val)
<a name="13291"/>13291:           end,
<a name="13292"/>13292: 
<a name="13293"/>13293:     ClientSeq =
<a name="13294"/>13294:         [
<a name="13295"/>13295:          %% *** Init part ***
<a name="13296"/>13296:          #{desc =&gt; &quot;await start&quot;,
<a name="13297"/>13297:            cmd  =&gt; fun(State) -&gt;
<a name="13298"/>13298:                            {Tester, Sock} = ?SEV_AWAIT_START(),
<a name="13299"/>13299:                            {ok, State#{tester =&gt; Tester,
<a name="13300"/>13300:                                        sock   =&gt; Sock}}
<a name="13301"/>13301:                    end},
<a name="13302"/>13302:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="13303"/>13303:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="13304"/>13304:                            _MRef = erlang:monitor(process, Tester),
<a name="13305"/>13305:                            ok
<a name="13306"/>13306:                    end},
<a name="13307"/>13307: 
<a name="13308"/>13308:          %% *** The actual test ***
<a name="13309"/>13309:          #{desc =&gt; &quot;verify tester as controlling-process&quot;,
<a name="13310"/>13310:            cmd  =&gt; fun(#{tester := Tester, sock := Sock} = _State) -&gt;
<a name="13311"/>13311:                            case Get(Sock, controlling_process) of
<a name="13312"/>13312:                                {ok, Tester} -&gt;
<a name="13313"/>13313:                                    ok;
<a name="13314"/>13314:                                {ok, _} = OK -&gt;
<a name="13315"/>13315:                                    {error, OK};
<a name="13316"/>13316:                                {error, _} = ERROR -&gt;
<a name="13317"/>13317:                                    ERROR
<a name="13318"/>13318:                            end
<a name="13319"/>13319:                    end},
<a name="13320"/>13320:          #{desc =&gt; &quot;attempt invalid controlling-process transfer (to self)&quot;,
<a name="13321"/>13321:            cmd  =&gt; fun(#{sock := Sock} = _State) -&gt;
<a name="13322"/>13322:                            case Set(Sock, controlling_process, self()) of
<a name="13323"/>13323:                                {error, {invalid, not_owner}} -&gt;
<a name="13324"/>13324:                                    ok;
<a name="13325"/>13325:                                ok -&gt;
<a name="13326"/>13326:                                    {error, unexpected_success};
<a name="13327"/>13327:                                {error, _} = ERROR -&gt;
<a name="13328"/>13328:                                    ERROR
<a name="13329"/>13329:                            end
<a name="13330"/>13330:                    end},
<a name="13331"/>13331:          #{desc =&gt; &quot;announce ready (not owner)&quot;,
<a name="13332"/>13332:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="13333"/>13333:                            ?SEV_ANNOUNCE_READY(Tester, not_owner),
<a name="13334"/>13334:                            ok
<a name="13335"/>13335:                    end},
<a name="13336"/>13336:          #{desc =&gt; &quot;await continue (owner)&quot;,
<a name="13337"/>13337:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="13338"/>13338:                            ?SEV_AWAIT_CONTINUE(Tester, tester, owner)
<a name="13339"/>13339:                    end},
<a name="13340"/>13340:          #{desc =&gt; &quot;verify self as controlling-process&quot;,
<a name="13341"/>13341:            cmd  =&gt; fun(#{sock := Sock} = _State) -&gt;
<a name="13342"/>13342:                            Self = self(),
<a name="13343"/>13343:                            case Get(Sock, controlling_process) of
<a name="13344"/>13344:                                {ok, Self} -&gt;
<a name="13345"/>13345:                                    ok;
<a name="13346"/>13346:                                {ok, _} = OK -&gt;
<a name="13347"/>13347:                                    {error, OK};
<a name="13348"/>13348:                                {error, _} = ERROR -&gt;
<a name="13349"/>13349:                                    ERROR
<a name="13350"/>13350:                            end
<a name="13351"/>13351:                    end},
<a name="13352"/>13352:          #{desc =&gt; &quot;attempt controlling-process transfer to tester&quot;,
<a name="13353"/>13353:            cmd  =&gt; fun(#{tester := Tester, sock := Sock} = _State) -&gt;
<a name="13354"/>13354:                            Set(Sock, controlling_process, Tester)
<a name="13355"/>13355:                    end},
<a name="13356"/>13356:          #{desc =&gt; &quot;attempt invalid controlling-process transfer (to self)&quot;,
<a name="13357"/>13357:            cmd  =&gt; fun(#{sock := Sock} = _State) -&gt;
<a name="13358"/>13358:                            case Set(Sock, controlling_process, self()) of
<a name="13359"/>13359:                                {error, {invalid, not_owner}} -&gt;
<a name="13360"/>13360:                                    ok;
<a name="13361"/>13361:                                ok -&gt;
<a name="13362"/>13362:                                    {error, unexpected_success};
<a name="13363"/>13363:                                {error, _} = ERROR -&gt;
<a name="13364"/>13364:                                    ERROR
<a name="13365"/>13365:                            end
<a name="13366"/>13366:                    end},
<a name="13367"/>13367:          #{desc =&gt; &quot;announce ready (owner)&quot;,
<a name="13368"/>13368:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="13369"/>13369:                            ?SEV_ANNOUNCE_READY(Tester, owner),
<a name="13370"/>13370:                            ok
<a name="13371"/>13371: 
<a name="13372"/>13372:                    end},
<a name="13373"/>13373:          
<a name="13374"/>13374:          %% *** Termination ***
<a name="13375"/>13375:          #{desc =&gt; &quot;await termination&quot;,
<a name="13376"/>13376:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="13377"/>13377:                            ?SEV_AWAIT_TERMINATE(Tester, tester),
<a name="13378"/>13378:                            State1 = maps:remove(tester, State),
<a name="13379"/>13379:                            State2 = maps:remove(sock, State1),
<a name="13380"/>13380:                            {ok, State2}
<a name="13381"/>13381:                    end},
<a name="13382"/>13382: 
<a name="13383"/>13383:          %% *** We are done ***
<a name="13384"/>13384:          ?SEV_FINISH_NORMAL
<a name="13385"/>13385:         ],
<a name="13386"/>13386: 
<a name="13387"/>13387:     TesterSeq =
<a name="13388"/>13388:         [
<a name="13389"/>13389:          %% *** Init part ***
<a name="13390"/>13390:          #{desc =&gt; &quot;create socket&quot;,
<a name="13391"/>13391:            cmd  =&gt; fun(#{domain   := Domain, 
<a name="13392"/>13392:                          type     := Type,
<a name="13393"/>13393:                          protocol := Protocol} = State) -&gt;
<a name="13394"/>13394:                            Sock = sock_open(Domain, Type, Protocol),
<a name="13395"/>13395:                            {ok, State#{sock =&gt; Sock}}
<a name="13396"/>13396:                    end},
<a name="13397"/>13397:          #{desc =&gt; &quot;monitor client&quot;,
<a name="13398"/>13398:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="13399"/>13399:                            _MRef = erlang:monitor(process, Client),
<a name="13400"/>13400:                            ok
<a name="13401"/>13401:                    end},
<a name="13402"/>13402: 
<a name="13403"/>13403:          %% *** The actual test ***
<a name="13404"/>13404:          #{desc =&gt; &quot;verify self as controlling-process&quot;,
<a name="13405"/>13405:            cmd  =&gt; fun(#{sock := Sock} = _State) -&gt;
<a name="13406"/>13406:                            Self = self(),
<a name="13407"/>13407:                            case Get(Sock, controlling_process) of
<a name="13408"/>13408:                                {ok, Self} -&gt;
<a name="13409"/>13409:                                    ok;
<a name="13410"/>13410:                                {ok, _} = OK -&gt;
<a name="13411"/>13411:                                    {error, OK};
<a name="13412"/>13412:                                {error, _} = ERROR -&gt;
<a name="13413"/>13413:                                    ERROR
<a name="13414"/>13414:                            end
<a name="13415"/>13415:                    end},
<a name="13416"/>13416:          #{desc =&gt; &quot;order (client) start&quot;,
<a name="13417"/>13417:            cmd  =&gt; fun(#{client := Client, sock := Sock} = _State) -&gt;
<a name="13418"/>13418:                            ?SEV_ANNOUNCE_START(Client, Sock),
<a name="13419"/>13419:                            ok
<a name="13420"/>13420:                    end},
<a name="13421"/>13421:          #{desc =&gt; &quot;await (client) ready (not owner)&quot;,
<a name="13422"/>13422:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="13423"/>13423:                            ?SEV_AWAIT_READY(Client, client, not_owner)
<a name="13424"/>13424:                    end},
<a name="13425"/>13425:          #{desc =&gt; &quot;attempt controlling-process transfer to client&quot;,
<a name="13426"/>13426:            cmd  =&gt; fun(#{client := Client, sock := Sock} = _State) -&gt;
<a name="13427"/>13427:                            Set(Sock, controlling_process, Client)
<a name="13428"/>13428:                    end},
<a name="13429"/>13429:          #{desc =&gt; &quot;verify client as controlling-process&quot;,
<a name="13430"/>13430:            cmd  =&gt; fun(#{client := Client, sock := Sock} = _State) -&gt;
<a name="13431"/>13431:                            case Get(Sock, controlling_process) of
<a name="13432"/>13432:                                {ok, Client} -&gt;
<a name="13433"/>13433:                                    ok;
<a name="13434"/>13434:                                {ok, _} = OK -&gt;
<a name="13435"/>13435:                                    {error, OK};
<a name="13436"/>13436:                                {error, _} = ERROR -&gt;
<a name="13437"/>13437:                                    ERROR
<a name="13438"/>13438:                            end
<a name="13439"/>13439:                    end},
<a name="13440"/>13440:          #{desc =&gt; &quot;attempt invalid controlling-process transfer (to self)&quot;,
<a name="13441"/>13441:            cmd  =&gt; fun(#{sock := Sock} = _State) -&gt;
<a name="13442"/>13442:                            case Set(Sock, controlling_process, self()) of
<a name="13443"/>13443:                                {error, {invalid, not_owner}} -&gt;
<a name="13444"/>13444:                                    ok;
<a name="13445"/>13445:                                ok -&gt;
<a name="13446"/>13446:                                    {error, unexpected_success};
<a name="13447"/>13447:                                {error, _} = ERROR -&gt;
<a name="13448"/>13448:                                    ERROR
<a name="13449"/>13449:                            end
<a name="13450"/>13450:                    end},
<a name="13451"/>13451:          #{desc =&gt; &quot;order (client) continue (owner)&quot;,
<a name="13452"/>13452:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="13453"/>13453:                            ?SEV_ANNOUNCE_CONTINUE(Client, owner),
<a name="13454"/>13454:                            ok
<a name="13455"/>13455:                    end},
<a name="13456"/>13456:          #{desc =&gt; &quot;await (client) ready (2)&quot;,
<a name="13457"/>13457:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="13458"/>13458:                            ?SEV_AWAIT_READY(Client, client, owner),
<a name="13459"/>13459:                            ok
<a name="13460"/>13460:                    end},
<a name="13461"/>13461:          #{desc =&gt; &quot;verify self as controlling-process&quot;,
<a name="13462"/>13462:            cmd  =&gt; fun(#{sock := Sock} = _State) -&gt;
<a name="13463"/>13463:                            Self = self(),
<a name="13464"/>13464:                            case Get(Sock, controlling_process) of
<a name="13465"/>13465:                                {ok, Self} -&gt;
<a name="13466"/>13466:                                    ok;
<a name="13467"/>13467:                                {ok, _} = OK -&gt;
<a name="13468"/>13468:                                    {error, OK};
<a name="13469"/>13469:                                {error, _} = ERROR -&gt;
<a name="13470"/>13470:                                    ERROR
<a name="13471"/>13471:                            end
<a name="13472"/>13472:                    end},
<a name="13473"/>13473: 
<a name="13474"/>13474:          %% *** Termination ***
<a name="13475"/>13475:          #{desc =&gt; &quot;order (client) terminate&quot;,
<a name="13476"/>13476:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="13477"/>13477:                            ?SEV_ANNOUNCE_TERMINATE(Client),
<a name="13478"/>13478:                            ok
<a name="13479"/>13479:                    end},
<a name="13480"/>13480:          #{desc =&gt; &quot;await client termination&quot;,
<a name="13481"/>13481:            cmd  =&gt; fun(#{client := Client} = State) -&gt;
<a name="13482"/>13482:                            ?SEV_AWAIT_TERMINATION(Client),
<a name="13483"/>13483:                            {ok, maps:remove(client, State)}
<a name="13484"/>13484:                    end},
<a name="13485"/>13485:          #{desc =&gt; &quot;close socket&quot;,
<a name="13486"/>13486:            cmd  =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="13487"/>13487:                            sock_close(Sock),
<a name="13488"/>13488:                            {ok, maps:remove(sock, State)}
<a name="13489"/>13489:                    end},
<a name="13490"/>13490: 
<a name="13491"/>13491:          %% *** We are done ***
<a name="13492"/>13492:          ?SEV_FINISH_NORMAL
<a name="13493"/>13493:         ],
<a name="13494"/>13494: 
<a name="13495"/>13495:     i(&quot;start tcp (stream) client evaluator&quot;),
<a name="13496"/>13496:     ClientInitState1 = #{},
<a name="13497"/>13497:     Client1 = ?SEV_START(&quot;tcp-client&quot;, ClientSeq, ClientInitState1),
<a name="13498"/>13498: 
<a name="13499"/>13499:     i(&quot;start tcp (stream) tester evaluator&quot;),
<a name="13500"/>13500:     TesterInitState1 = #{domain   =&gt; inet,
<a name="13501"/>13501:                          type     =&gt; stream, 
<a name="13502"/>13502:                          protocol =&gt; tcp,
<a name="13503"/>13503:                          client   =&gt; Client1#ev.pid},
<a name="13504"/>13504:     Tester1 = ?SEV_START(&quot;tcp-tester&quot;, TesterSeq, TesterInitState1),
<a name="13505"/>13505: 
<a name="13506"/>13506:     i(&quot;await tcp evaluator(s)&quot;),
<a name="13507"/>13507:     ok = ?SEV_AWAIT_FINISH([Tester1, Client1]),
<a name="13508"/>13508: 
<a name="13509"/>13509:     i(&quot;start udp (dgram) client evaluator&quot;),
<a name="13510"/>13510:     ClientInitState2 = #{},
<a name="13511"/>13511:     Client2 = ?SEV_START(&quot;udp-client&quot;, ClientSeq, ClientInitState2),
<a name="13512"/>13512: 
<a name="13513"/>13513:     i(&quot;start udp (dgram) tester evaluator&quot;),
<a name="13514"/>13514:     TesterInitState2 = #{domain   =&gt; inet,
<a name="13515"/>13515:                          type     =&gt; dgram, 
<a name="13516"/>13516:                          protocol =&gt; udp,
<a name="13517"/>13517:                          client   =&gt; Client2#ev.pid},
<a name="13518"/>13518:     Tester2 = ?SEV_START(&quot;udp-tester&quot;, TesterSeq, TesterInitState2),
<a name="13519"/>13519: 
<a name="13520"/>13520:     i(&quot;await udp evaluator(s)&quot;),
<a name="api_opt_simple_otp_controlling_process-last_expr"/><a name="13521"/>13521: <b>    ok = ?SEV_AWAIT_FINISH</b>([Tester2, Client2]).
<a name="13522"/>13522: 
<a name="13523"/>13523: 
<a name="13524"/>13524: 
<a name="13525"/>13525: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="13526"/>13526: 
<a name="13527"/>13527: <i>%% Tests the socket option acceptconn for UDP.</i>
<a name="13528"/>13528: <i>%% This should be possible to get but not set.</i>
<a name="13529"/>13529: 
<a name="api_opt_sock_acceptconn_udp-1"/><a name="13530"/>13530: <b>api_opt_sock_acceptconn_udp</b>(_Config) when is_list(_Config) -&gt;
<a name="13531"/>13531:     ?TT(?SECS(30)),
<a name="api_opt_sock_acceptconn_udp-last_expr"/><a name="13532"/>13532: <b>    tc_try</b>(api_opt_sock_acceptconn_udp,
<a name="13533"/>13533:            fun() -&gt;
<a name="13534"/>13534:                    has_support_sock_acceptconn()
<a name="13535"/>13535:            end,
<a name="13536"/>13536:            fun() -&gt; api_opt_sock_acceptconn_udp() end).
<a name="13537"/>13537: 
<a name="13538"/>13538: 
<a name="13539"/>13539: 
<a name="api_opt_sock_acceptconn_udp-0"/><a name="13540"/>13540: <b>api_opt_sock_acceptconn_udp</b>() -&gt;
<a name="13541"/>13541:     Opt = acceptconn,
<a name="13542"/>13542:     Set = fun(S, Val) -&gt;
<a name="13543"/>13543:                   socket:setopt(S, socket, Opt, Val)
<a name="13544"/>13544:           end,
<a name="13545"/>13545:     Get = fun(S) -&gt;
<a name="13546"/>13546:                   socket:getopt(S, socket, Opt)
<a name="13547"/>13547:           end,
<a name="13548"/>13548: 
<a name="13549"/>13549:     TesterSeq =
<a name="13550"/>13550:         [
<a name="13551"/>13551:          #{desc =&gt; &quot;which local address&quot;,
<a name="13552"/>13552:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="13553"/>13553:                            LSA = which_local_socket_addr(Domain),
<a name="13554"/>13554:                            {ok, State#{local_sa =&gt; LSA}}
<a name="13555"/>13555:                    end},
<a name="13556"/>13556:          #{desc =&gt; &quot;create socket&quot;,
<a name="13557"/>13557:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="13558"/>13558:                            case socket:open(Domain, dgram, udp) of
<a name="13559"/>13559:                                {ok, Sock} -&gt;
<a name="13560"/>13560:                                    {ok, State#{sock =&gt; Sock}};
<a name="13561"/>13561:                                {error, _} = ERROR -&gt;
<a name="13562"/>13562:                                    ERROR
<a name="13563"/>13563:                            end
<a name="13564"/>13564:                    end},
<a name="13565"/>13565: 
<a name="13566"/>13566:          #{desc =&gt; &quot;[get] verify socket (before bind)&quot;,
<a name="13567"/>13567:            cmd  =&gt; fun(#{sock := Sock} = _State) -&gt;
<a name="13568"/>13568:                            case Get(Sock) of
<a name="13569"/>13569:                                {ok, false} -&gt;
<a name="13570"/>13570:                                    ?SEV_IPRINT(&quot;Expected Success: &quot;
<a name="13571"/>13571:                                                &quot;Not accepting connections&quot;),
<a name="13572"/>13572:                                    ok;
<a name="13573"/>13573:                                {ok, true} -&gt;
<a name="13574"/>13574:                                    ?SEV_EPRINT(&quot;Unexpected Success: &quot;
<a name="13575"/>13575:                                                &quot;Accepting connections&quot;),
<a name="13576"/>13576:                                    {error, {unexpected_success, {Opt, true}}};
<a name="13577"/>13577:                                {error, enoprotoopt = Reason} -&gt;
<a name="13578"/>13578:                                    %% On some platforms this is not accepted
<a name="13579"/>13579:                                    %% for UDP, so skip this part (UDP).
<a name="13580"/>13580:                                    ?SEV_EPRINT(&quot;Expected Failure: &quot;
<a name="13581"/>13581:                                                &quot;~p =&gt; SKIP&quot;, [Reason]),
<a name="13582"/>13582:                                    (catch socket:close(Sock)),
<a name="13583"/>13583:                                    {skip, Reason};
<a name="13584"/>13584:                                {error, Reason} = ERROR -&gt;
<a name="13585"/>13585:                                    ?SEV_EPRINT(&quot;Unexpected Failure: ~p&quot;,
<a name="13586"/>13586:                                                [Reason]),
<a name="13587"/>13587:                                    ERROR
<a name="13588"/>13588:                            end
<a name="13589"/>13589:                    end},
<a name="13590"/>13590:          #{desc =&gt; &quot;[set] verify socket (before bind)&quot;,
<a name="13591"/>13591:            cmd  =&gt; fun(#{sock := Sock} = _State) -&gt;
<a name="13592"/>13592:                            case Set(Sock, true) of
<a name="13593"/>13593:                                {error, Reason} -&gt;
<a name="13594"/>13594:                                    ?SEV_IPRINT(&quot;Expected Failure: ~p&quot;,
<a name="13595"/>13595:                                                [Reason]),
<a name="13596"/>13596:                                    ok;
<a name="13597"/>13597:                                ok -&gt;
<a name="13598"/>13598:                                    ?SEV_EPRINT(&quot;Unexpected Success: &quot;
<a name="13599"/>13599:                                                &quot;Set acceptconn (=true)&quot;),
<a name="13600"/>13600:                                    {error, unexpected_success}
<a name="13601"/>13601:                            end
<a name="13602"/>13602:                    end},
<a name="13603"/>13603: 
<a name="13604"/>13604:          #{desc =&gt; &quot;bind socket to local address&quot;,
<a name="13605"/>13605:            cmd  =&gt; fun(#{sock := Sock, local_sa := LSA} = _State) -&gt;
<a name="13606"/>13606:                            case sock_bind(Sock, LSA) of
<a name="13607"/>13607:                                ok -&gt;
<a name="13608"/>13608:                                    ok;
<a name="13609"/>13609:                                {error, _} = ERROR -&gt;
<a name="13610"/>13610:                                    ERROR
<a name="13611"/>13611:                            end
<a name="13612"/>13612:                    end},
<a name="13613"/>13613: 
<a name="13614"/>13614:          ?SEV_SLEEP(?SECS(1)),
<a name="13615"/>13615: 
<a name="13616"/>13616:          #{desc =&gt; &quot;[get] verify socket (after bind)&quot;,
<a name="13617"/>13617:            cmd  =&gt; fun(#{sock := Sock} = _State) -&gt;
<a name="13618"/>13618:                            case Get(Sock) of
<a name="13619"/>13619:                                {ok, false} -&gt;
<a name="13620"/>13620:                                    ?SEV_IPRINT(&quot;Expected Success: &quot;
<a name="13621"/>13621:                                                &quot;Not accepting connections&quot;),
<a name="13622"/>13622:                                    ok;
<a name="13623"/>13623:                                {ok, true} -&gt;
<a name="13624"/>13624:                                    ?SEV_EPRINT(&quot;Unexpected Success: &quot;
<a name="13625"/>13625:                                                &quot;Accepting connections&quot;),
<a name="13626"/>13626:                                    {error, {unexpected_success, {Opt, true}}};
<a name="13627"/>13627:                                {error, Reason} = ERROR -&gt;
<a name="13628"/>13628:                                    ?SEV_EPRINT(&quot;Unexpected Failure: ~p&quot;,
<a name="13629"/>13629:                                                [Reason]),
<a name="13630"/>13630:                                    ERROR
<a name="13631"/>13631:                            end
<a name="13632"/>13632:                    end},
<a name="13633"/>13633:          #{desc =&gt; &quot;[set] verify socket (after bind)&quot;,
<a name="13634"/>13634:            cmd  =&gt; fun(#{sock := Sock} = _State) -&gt;
<a name="13635"/>13635:                            case Set(Sock, true) of
<a name="13636"/>13636:                                {error, Reason} -&gt;
<a name="13637"/>13637:                                    ?SEV_IPRINT(&quot;Expected Failure: ~p&quot;,
<a name="13638"/>13638:                                                [Reason]),
<a name="13639"/>13639:                                    ok;
<a name="13640"/>13640:                                ok -&gt;
<a name="13641"/>13641:                                    ?SEV_EPRINT(&quot;Unexpected Success: &quot;
<a name="13642"/>13642:                                                &quot;Set acceptconn (=true)&quot;),
<a name="13643"/>13643:                                    {error, unexpected_success}
<a name="13644"/>13644:                            end
<a name="13645"/>13645:                    end},
<a name="13646"/>13646: 
<a name="13647"/>13647:          %% *** Termination ***
<a name="13648"/>13648:          #{desc =&gt; &quot;close socket&quot;,
<a name="13649"/>13649:            cmd  =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="13650"/>13650:                            socket:close(Sock),
<a name="13651"/>13651:                            {ok, maps:remove(sock, State)}
<a name="13652"/>13652:                    end},
<a name="13653"/>13653: 
<a name="13654"/>13654:          %% *** We are done ***
<a name="13655"/>13655:          ?SEV_FINISH_NORMAL
<a name="13656"/>13656:         ],
<a name="13657"/>13657: 
<a name="13658"/>13658:     Domain = inet_or_inet6(),
<a name="13659"/>13659: 
<a name="13660"/>13660:     i(&quot;start tester evaluator&quot;),
<a name="13661"/>13661:     InitState = #{domain  =&gt; Domain},
<a name="13662"/>13662:     Tester = ?SEV_START(&quot;tester&quot;, TesterSeq, InitState),
<a name="13663"/>13663: 
<a name="13664"/>13664:     i(&quot;await evaluator(s)&quot;),
<a name="api_opt_sock_acceptconn_udp-last_expr"/><a name="13665"/>13665: <b>    ok = ?SEV_AWAIT_FINISH</b>([Tester]).
<a name="13666"/>13666: 
<a name="13667"/>13667: 
<a name="13668"/>13668: 
<a name="13669"/>13669: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="13670"/>13670: 
<a name="13671"/>13671: <i>%% Tests the socket option acceptconn for TCP.</i>
<a name="13672"/>13672: <i>%% This should be possible to get but not set.</i>
<a name="13673"/>13673: 
<a name="api_opt_sock_acceptconn_tcp-1"/><a name="13674"/>13674: <b>api_opt_sock_acceptconn_tcp</b>(_Config) when is_list(_Config) -&gt;
<a name="13675"/>13675:     ?TT(?SECS(30)),
<a name="api_opt_sock_acceptconn_tcp-last_expr"/><a name="13676"/>13676: <b>    tc_try</b>(api_opt_sock_acceptconn_tcp,
<a name="13677"/>13677:            fun() -&gt;
<a name="13678"/>13678:                    has_support_sock_acceptconn()
<a name="13679"/>13679:            end,
<a name="13680"/>13680:            fun() -&gt; api_opt_sock_acceptconn_tcp() end).
<a name="13681"/>13681: 
<a name="13682"/>13682: 
<a name="13683"/>13683: 
<a name="api_opt_sock_acceptconn_tcp-0"/><a name="13684"/>13684: <b>api_opt_sock_acceptconn_tcp</b>() -&gt;
<a name="13685"/>13685:     Opt = acceptconn,
<a name="13686"/>13686:     Set = fun(S, Val) -&gt;
<a name="13687"/>13687:                   socket:setopt(S, socket, Opt, Val)
<a name="13688"/>13688:           end,
<a name="13689"/>13689:     Get = fun(S) -&gt;
<a name="13690"/>13690:                   socket:getopt(S, socket, Opt)
<a name="13691"/>13691:           end,
<a name="13692"/>13692: 
<a name="13693"/>13693:     TesterSeq =
<a name="13694"/>13694:         [
<a name="13695"/>13695:          #{desc =&gt; &quot;which local address&quot;,
<a name="13696"/>13696:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="13697"/>13697:                            LSA = which_local_socket_addr(Domain),
<a name="13698"/>13698:                            {ok, State#{local_sa =&gt; LSA}}
<a name="13699"/>13699:                    end},
<a name="13700"/>13700: 
<a name="13701"/>13701:          #{desc =&gt; &quot;create listen socket&quot;,
<a name="13702"/>13702:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="13703"/>13703:                            case socket:open(Domain, stream, tcp) of
<a name="13704"/>13704:                                {ok, Sock} -&gt;
<a name="13705"/>13705:                                    {ok, State#{lsock =&gt; Sock}};
<a name="13706"/>13706:                                {error, _} = ERROR -&gt;
<a name="13707"/>13707:                                    ERROR
<a name="13708"/>13708:                            end
<a name="13709"/>13709:                    end},
<a name="13710"/>13710: 
<a name="13711"/>13711:          #{desc =&gt; &quot;[get] verify listen socket (before bind)&quot;,
<a name="13712"/>13712:            cmd  =&gt; fun(#{lsock := Sock} = _State) -&gt;
<a name="13713"/>13713:                            case Get(Sock) of
<a name="13714"/>13714:                                {ok, false} -&gt;
<a name="13715"/>13715:                                    ?SEV_IPRINT(&quot;Expected Success: &quot;
<a name="13716"/>13716:                                                &quot;Not accepting connections&quot;),
<a name="13717"/>13717:                                    ok;
<a name="13718"/>13718:                                {ok, true} -&gt;
<a name="13719"/>13719:                                    ?SEV_EPRINT(&quot;Unexpected Success: &quot;
<a name="13720"/>13720:                                                &quot;Accepting connections&quot;),
<a name="13721"/>13721:                                    {error, {unexpected_success, {Opt, true}}};
<a name="13722"/>13722:                                {error, enoprotoopt = Reason} -&gt;
<a name="13723"/>13723:                                    ?SEV_EPRINT(&quot;Expected Failure: &quot;
<a name="13724"/>13724:                                                &quot;~p =&gt; SKIP&quot;, [Reason]),
<a name="13725"/>13725:                                    (catch socket:close(Sock)),
<a name="13726"/>13726:                                    {skip, Reason};
<a name="13727"/>13727:                                {error, Reason} = ERROR -&gt;
<a name="13728"/>13728:                                    ?SEV_EPRINT(&quot;Unexpected Failure: ~p&quot;,
<a name="13729"/>13729:                                                [Reason]),
<a name="13730"/>13730:                                    ERROR
<a name="13731"/>13731:                            end
<a name="13732"/>13732:                    end},
<a name="13733"/>13733:          #{desc =&gt; &quot;[set] verify listen socket (before bind)&quot;,
<a name="13734"/>13734:            cmd  =&gt; fun(#{lsock := Sock} = _State) -&gt;
<a name="13735"/>13735:                            case Set(Sock, true) of
<a name="13736"/>13736:                                {error, Reason} -&gt;
<a name="13737"/>13737:                                    ?SEV_IPRINT(&quot;Expected Failure: ~p&quot;, [Reason]),
<a name="13738"/>13738:                                    ok;
<a name="13739"/>13739:                                ok -&gt;
<a name="13740"/>13740:                                    ?SEV_EPRINT(&quot;Unexpected Success: &quot;
<a name="13741"/>13741:                                                &quot;Set acceptconn (=true)&quot;),
<a name="13742"/>13742:                                    {error, unexpected_success}
<a name="13743"/>13743:                            end
<a name="13744"/>13744:                    end},
<a name="13745"/>13745: 
<a name="13746"/>13746:          ?SEV_SLEEP(?SECS(1)),
<a name="13747"/>13747: 
<a name="13748"/>13748:          #{desc =&gt; &quot;bind listen socket to local address&quot;,
<a name="13749"/>13749:            cmd  =&gt; fun(#{lsock := Sock, local_sa := LSA} = State) -&gt;
<a name="13750"/>13750:                            case sock_bind(Sock, LSA) of
<a name="13751"/>13751:                                ok -&gt;
<a name="13752"/>13752:                                    Port = sock_port(Sock),
<a name="13753"/>13753:                                    {ok, State#{server_sa =&gt; LSA#{port =&gt; Port}}};
<a name="13754"/>13754:                                {error, _} = ERROR -&gt;
<a name="13755"/>13755:                                    ERROR
<a name="13756"/>13756:                            end
<a name="13757"/>13757:                    end},
<a name="13758"/>13758: 
<a name="13759"/>13759:          #{desc =&gt; &quot;[get] verify listen socket (after bind)&quot;,
<a name="13760"/>13760:            cmd  =&gt; fun(#{lsock := Sock} = _State) -&gt;
<a name="13761"/>13761:                            case Get(Sock) of
<a name="13762"/>13762:                                {ok, false} -&gt;
<a name="13763"/>13763:                                    ?SEV_IPRINT(&quot;Expected Success: &quot;
<a name="13764"/>13764:                                                &quot;Not accepting connections&quot;),
<a name="13765"/>13765:                                    ok;
<a name="13766"/>13766:                                {ok, true} -&gt;
<a name="13767"/>13767:                                    ?SEV_EPRINT(&quot;Unexpected Success: &quot;
<a name="13768"/>13768:                                                &quot;Accepting connections&quot;),
<a name="13769"/>13769:                                    {error, {unexpected_success, {Opt, true}}};
<a name="13770"/>13770:                                {error, Reason} = ERROR -&gt;
<a name="13771"/>13771:                                    ?SEV_EPRINT(&quot;Unexpected Failure: ~p&quot;, [Reason]),
<a name="13772"/>13772:                                    ERROR
<a name="13773"/>13773:                            end
<a name="13774"/>13774:                    end},
<a name="13775"/>13775:          #{desc =&gt; &quot;[set] verify listen socket (after bind)&quot;,
<a name="13776"/>13776:            cmd  =&gt; fun(#{lsock := Sock} = _State) -&gt;
<a name="13777"/>13777:                            case Set(Sock, true) of
<a name="13778"/>13778:                                {error, Reason} -&gt;
<a name="13779"/>13779:                                    ?SEV_IPRINT(&quot;Expected Failure: ~p&quot;, [Reason]),
<a name="13780"/>13780:                                    ok;
<a name="13781"/>13781:                                ok -&gt;
<a name="13782"/>13782:                                    ?SEV_EPRINT(&quot;Unexpected Success: &quot;
<a name="13783"/>13783:                                                &quot;Set acceptconn (=true)&quot;),
<a name="13784"/>13784:                                    {error, unexpected_success}
<a name="13785"/>13785:                            end
<a name="13786"/>13786:                    end},
<a name="13787"/>13787: 
<a name="13788"/>13788:          ?SEV_SLEEP(?SECS(1)),
<a name="13789"/>13789: 
<a name="13790"/>13790:          #{desc =&gt; &quot;make listen socket accept connections&quot;,
<a name="13791"/>13791:            cmd  =&gt; fun(#{lsock := Sock} = _State) -&gt;
<a name="13792"/>13792:                            case socket:listen(Sock) of
<a name="13793"/>13793:                                ok -&gt;
<a name="13794"/>13794:                                    ok;
<a name="13795"/>13795:                                {error, _} = ERROR -&gt;
<a name="13796"/>13796:                                    ERROR
<a name="13797"/>13797:                            end
<a name="13798"/>13798:                    end},
<a name="13799"/>13799: 
<a name="13800"/>13800:          #{desc =&gt; &quot;[get] verify listen socket (after listen)&quot;,
<a name="13801"/>13801:            cmd  =&gt; fun(#{lsock := Sock} = _State) -&gt;
<a name="13802"/>13802:                            case Get(Sock) of
<a name="13803"/>13803:                                {ok, true} -&gt;
<a name="13804"/>13804:                                    ?SEV_IPRINT(&quot;Expected Success: &quot;
<a name="13805"/>13805:                                                &quot;Accepting connections&quot;),
<a name="13806"/>13806:                                    ok;
<a name="13807"/>13807:                                {ok, false} -&gt;
<a name="13808"/>13808:                                    ?SEV_EPRINT(&quot;Unexpected Success: &quot;
<a name="13809"/>13809:                                                &quot;Not accepting connections&quot;),
<a name="13810"/>13810:                                    {error, {unexpected_success, {Opt, false}}};
<a name="13811"/>13811:                                {error, Reason} = ERROR -&gt;
<a name="13812"/>13812:                                    ?SEV_EPRINT(&quot;Unexpected Failure: ~p&quot;, [Reason]),
<a name="13813"/>13813:                                    ERROR
<a name="13814"/>13814:                            end
<a name="13815"/>13815:                    end},
<a name="13816"/>13816:          #{desc =&gt; &quot;[set] verify listen socket (after listen)&quot;,
<a name="13817"/>13817:            cmd  =&gt; fun(#{lsock := Sock} = _State) -&gt;
<a name="13818"/>13818:                            case Set(Sock, false) of
<a name="13819"/>13819:                                {error, Reason} -&gt;
<a name="13820"/>13820:                                    ?SEV_IPRINT(&quot;Expected Failure: ~p&quot;, [Reason]),
<a name="13821"/>13821:                                    ok;
<a name="13822"/>13822:                                ok -&gt;
<a name="13823"/>13823:                                    ?SEV_EPRINT(&quot;Unexpected Success: &quot;
<a name="13824"/>13824:                                                &quot;Set acceptconn (=false)&quot;),
<a name="13825"/>13825:                                    {error, unexpected_success}
<a name="13826"/>13826:                            end
<a name="13827"/>13827:                    end},
<a name="13828"/>13828: 
<a name="13829"/>13829:          ?SEV_SLEEP(?SECS(1)),
<a name="13830"/>13830: 
<a name="13831"/>13831:          #{desc =&gt; &quot;create (connecting) socket&quot;,
<a name="13832"/>13832:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="13833"/>13833:                            case socket:open(Domain, stream, tcp) of
<a name="13834"/>13834:                                {ok, Sock} -&gt;
<a name="13835"/>13835:                                    {ok, State#{csockc =&gt; Sock}};
<a name="13836"/>13836:                                {error, _} = ERROR -&gt;
<a name="13837"/>13837:                                    ERROR
<a name="13838"/>13838:                            end
<a name="13839"/>13839:                    end},
<a name="13840"/>13840: 
<a name="13841"/>13841:          #{desc =&gt; &quot;bind connecting socket to local address&quot;,
<a name="13842"/>13842:            cmd  =&gt; fun(#{csockc := Sock, local_sa := LSA} = _State) -&gt;
<a name="13843"/>13843:                            case sock_bind(Sock, LSA) of
<a name="13844"/>13844:                                ok -&gt;
<a name="13845"/>13845:                                    ok;
<a name="13846"/>13846:                                {error, _} = ERROR -&gt;
<a name="13847"/>13847:                                    ERROR
<a name="13848"/>13848:                            end
<a name="13849"/>13849:                    end},
<a name="13850"/>13850: 
<a name="13851"/>13851:          ?SEV_SLEEP(?SECS(1)),
<a name="13852"/>13852: 
<a name="13853"/>13853:          #{desc =&gt; &quot;[get] verify connecting socket (before connect)&quot;,
<a name="13854"/>13854:            cmd  =&gt; fun(#{csockc := Sock} = _State) -&gt;
<a name="13855"/>13855:                            case Get(Sock) of
<a name="13856"/>13856:                                {ok, false} -&gt;
<a name="13857"/>13857:                                    ?SEV_IPRINT(&quot;Expected Success: &quot;
<a name="13858"/>13858:                                                &quot;Not accepting connections&quot;),
<a name="13859"/>13859:                                    ok;
<a name="13860"/>13860:                                {ok, true} -&gt;
<a name="13861"/>13861:                                    ?SEV_EPRINT(&quot;Unexpected Success: &quot;
<a name="13862"/>13862:                                                &quot;Accepting connections&quot;),
<a name="13863"/>13863:                                    {error, {unexpected_success, {Opt, true}}};
<a name="13864"/>13864:                                {error, Reason} = ERROR -&gt;
<a name="13865"/>13865:                                    ?SEV_EPRINT(&quot;Unexpected Failure: ~p&quot;, [Reason]),
<a name="13866"/>13866:                                    ERROR
<a name="13867"/>13867:                            end
<a name="13868"/>13868:                    end},
<a name="13869"/>13869:          #{desc =&gt; &quot;[set] verify connecting socket (before connect)&quot;,
<a name="13870"/>13870:            cmd  =&gt; fun(#{csockc := Sock} = _State) -&gt;
<a name="13871"/>13871:                            case Set(Sock, true) of
<a name="13872"/>13872:                                {error, Reason} -&gt;
<a name="13873"/>13873:                                    ?SEV_IPRINT(&quot;Expected Failure: ~p&quot;, [Reason]),
<a name="13874"/>13874:                                    ok;
<a name="13875"/>13875:                                ok -&gt;
<a name="13876"/>13876:                                    ?SEV_EPRINT(&quot;Unexpected Success: &quot;
<a name="13877"/>13877:                                                &quot;Set acceptconn (=true)&quot;),
<a name="13878"/>13878:                                    {error, unexpected_success}
<a name="13879"/>13879:                            end
<a name="13880"/>13880:                    end},
<a name="13881"/>13881: 
<a name="13882"/>13882:          ?SEV_SLEEP(?SECS(1)),
<a name="13883"/>13883: 
<a name="13884"/>13884:          #{desc =&gt; &quot;connect to server&quot;,
<a name="13885"/>13885:            cmd  =&gt; fun(#{csockc := Sock, server_sa := SSA} = _State) -&gt;
<a name="13886"/>13886:                            case socket:connect(Sock, SSA) of
<a name="13887"/>13887:                                ok -&gt;
<a name="13888"/>13888:                                    ok;
<a name="13889"/>13889:                                {error, _} = ERROR -&gt;
<a name="13890"/>13890:                                    ERROR
<a name="13891"/>13891:                            end
<a name="13892"/>13892:                    end},
<a name="13893"/>13893: 
<a name="13894"/>13894:          #{desc =&gt; &quot;accept connection&quot;,
<a name="13895"/>13895:            cmd  =&gt; fun(#{lsock := Sock} = State) -&gt;
<a name="13896"/>13896:                            case socket:accept(Sock) of
<a name="13897"/>13897:                                {ok, CSock} -&gt;
<a name="13898"/>13898:                                    {ok, State#{csocks =&gt; CSock}};
<a name="13899"/>13899:                                {error, _} = ERROR -&gt;
<a name="13900"/>13900:                                    ERROR
<a name="13901"/>13901:                            end
<a name="13902"/>13902:                    end},
<a name="13903"/>13903: 
<a name="13904"/>13904:          #{desc =&gt; &quot;[get] verify connecting socket (after connect)&quot;,
<a name="13905"/>13905:            cmd  =&gt; fun(#{csockc := Sock} = _State) -&gt;
<a name="13906"/>13906:                            case Get(Sock) of
<a name="13907"/>13907:                                {ok, false} -&gt;
<a name="13908"/>13908:                                    ?SEV_IPRINT(&quot;Expected Success: &quot;
<a name="13909"/>13909:                                                &quot;Not accepting connections&quot;),
<a name="13910"/>13910:                                    ok;
<a name="13911"/>13911:                                {ok, true} -&gt;
<a name="13912"/>13912:                                    ?SEV_EPRINT(&quot;Unexpected Success: &quot;
<a name="13913"/>13913:                                                &quot;Accepting connections&quot;),
<a name="13914"/>13914:                                    {error, {unexpected_success, {Opt, true}}};
<a name="13915"/>13915:                                {error, Reason} = ERROR -&gt;
<a name="13916"/>13916:                                    ?SEV_EPRINT(&quot;Unexpected Failure: ~p&quot;, [Reason]),
<a name="13917"/>13917:                                    ERROR
<a name="13918"/>13918:                            end
<a name="13919"/>13919:                    end},
<a name="13920"/>13920:          #{desc =&gt; &quot;[set] verify connecting socket (after connect)&quot;,
<a name="13921"/>13921:            cmd  =&gt; fun(#{csockc := Sock} = _State) -&gt;
<a name="13922"/>13922:                            case Set(Sock, true) of
<a name="13923"/>13923:                                {error, Reason} -&gt;
<a name="13924"/>13924:                                    ?SEV_IPRINT(&quot;Expected Failure: ~p&quot;, [Reason]),
<a name="13925"/>13925:                                    ok;
<a name="13926"/>13926:                                ok -&gt;
<a name="13927"/>13927:                                    ?SEV_EPRINT(&quot;Unexpected Success: &quot;
<a name="13928"/>13928:                                                &quot;Set acceptconn (=true)&quot;),
<a name="13929"/>13929:                                    {error, unexpected_success}
<a name="13930"/>13930:                            end
<a name="13931"/>13931:                    end},
<a name="13932"/>13932: 
<a name="13933"/>13933:          #{desc =&gt; &quot;[get] verify connected socket&quot;,
<a name="13934"/>13934:            cmd  =&gt; fun(#{csocks := Sock} = _State) -&gt;
<a name="13935"/>13935:                            case Get(Sock) of
<a name="13936"/>13936:                                {ok, false} -&gt;
<a name="13937"/>13937:                                    ?SEV_IPRINT(&quot;Expected Success: &quot;
<a name="13938"/>13938:                                                &quot;Not accepting connections&quot;),
<a name="13939"/>13939:                                    ok;
<a name="13940"/>13940:                                {ok, true} -&gt;
<a name="13941"/>13941:                                    ?SEV_EPRINT(&quot;Unexpected Success: &quot;
<a name="13942"/>13942:                                                &quot;Accepting connections&quot;),
<a name="13943"/>13943:                                    {error, {unexpected_success, {Opt, true}}};
<a name="13944"/>13944:                                {error, Reason} = ERROR -&gt;
<a name="13945"/>13945:                                    ?SEV_EPRINT(&quot;Unexpected Failure: ~p&quot;, [Reason]),
<a name="13946"/>13946:                                    ERROR
<a name="13947"/>13947:                            end
<a name="13948"/>13948:                    end},
<a name="13949"/>13949:          #{desc =&gt; &quot;[set] verify connected socket&quot;,
<a name="13950"/>13950:            cmd  =&gt; fun(#{csocks := Sock} = _State) -&gt;
<a name="13951"/>13951:                            case Set(Sock, true) of
<a name="13952"/>13952:                                {error, Reason} -&gt;
<a name="13953"/>13953:                                    ?SEV_IPRINT(&quot;Expected Failure: ~p&quot;, [Reason]),
<a name="13954"/>13954:                                    ok;
<a name="13955"/>13955:                                ok -&gt;
<a name="13956"/>13956:                                    ?SEV_EPRINT(&quot;Unexpected Success: &quot;
<a name="13957"/>13957:                                                &quot;Set acceptconn (=true)&quot;),
<a name="13958"/>13958:                                    {error, unexpected_success}
<a name="13959"/>13959:                            end
<a name="13960"/>13960:                    end},
<a name="13961"/>13961: 
<a name="13962"/>13962:          #{desc =&gt; &quot;[get] verify listen socket (after connect)&quot;,
<a name="13963"/>13963:            cmd  =&gt; fun(#{lsock := Sock} = _State) -&gt;
<a name="13964"/>13964:                            case Get(Sock) of
<a name="13965"/>13965:                                {ok, true} -&gt;
<a name="13966"/>13966:                                    ?SEV_IPRINT(&quot;Expected Success: &quot;
<a name="13967"/>13967:                                                &quot;Accepting connections&quot;),
<a name="13968"/>13968:                                    ok;
<a name="13969"/>13969:                                {ok, false} -&gt;
<a name="13970"/>13970:                                    ?SEV_EPRINT(&quot;Unexpected Success: &quot;
<a name="13971"/>13971:                                                &quot;Not accepting connections&quot;),
<a name="13972"/>13972:                                    {error, {unexpected_success, {Opt, false}}};
<a name="13973"/>13973:                                {error, Reason} = ERROR -&gt;
<a name="13974"/>13974:                                    ?SEV_EPRINT(&quot;Unexpected Failure: ~p&quot;, [Reason]),
<a name="13975"/>13975:                                    ERROR
<a name="13976"/>13976:                            end
<a name="13977"/>13977:                    end},
<a name="13978"/>13978:          #{desc =&gt; &quot;[set] verify listen socket (after connect)&quot;,
<a name="13979"/>13979:            cmd  =&gt; fun(#{lsock := Sock} = _State) -&gt;
<a name="13980"/>13980:                            case Set(Sock, false) of
<a name="13981"/>13981:                                {error, Reason} -&gt;
<a name="13982"/>13982:                                    ?SEV_IPRINT(&quot;Expected Failure: ~p&quot;, [Reason]),
<a name="13983"/>13983:                                    ok;
<a name="13984"/>13984:                                ok -&gt;
<a name="13985"/>13985:                                    ?SEV_EPRINT(&quot;Unexpected Success: &quot;
<a name="13986"/>13986:                                                &quot;Set acceptconn (=false)&quot;),
<a name="13987"/>13987:                                    {error, unexpected_success}
<a name="13988"/>13988:                            end
<a name="13989"/>13989:                    end},
<a name="13990"/>13990: 
<a name="13991"/>13991:          %% *** Termination ***
<a name="13992"/>13992:          #{desc =&gt; &quot;close connecting socket(s)&quot;,
<a name="13993"/>13993:            cmd  =&gt; fun(#{csockc := Sock} = State0) -&gt;
<a name="13994"/>13994:                            socket:close(Sock),
<a name="13995"/>13995:                            State1 = maps:remove(csockc, State0),
<a name="13996"/>13996:                            State2 = maps:remove(csocks, State1), %% Auto-close
<a name="13997"/>13997:                            {ok, maps:remove(csockc, State2)}
<a name="13998"/>13998:                    end},
<a name="13999"/>13999:          #{desc =&gt; &quot;close listen socket&quot;,
<a name="14000"/>14000:            cmd  =&gt; fun(#{lsock := Sock} = State) -&gt;
<a name="14001"/>14001:                            socket:close(Sock),
<a name="14002"/>14002:                            {ok, maps:remove(lsock, State)}
<a name="14003"/>14003:                    end},
<a name="14004"/>14004: 
<a name="14005"/>14005:          %% *** We are done ***
<a name="14006"/>14006:          ?SEV_FINISH_NORMAL
<a name="14007"/>14007:         ],
<a name="14008"/>14008: 
<a name="14009"/>14009: 
<a name="14010"/>14010:     Domain = inet_or_inet6(),
<a name="14011"/>14011: 
<a name="14012"/>14012:     i(&quot;start tester evaluator&quot;),
<a name="14013"/>14013:     InitState = #{domain  =&gt; Domain},
<a name="14014"/>14014:     Tester = ?SEV_START(&quot;tester&quot;, TesterSeq, InitState),
<a name="14015"/>14015: 
<a name="14016"/>14016:     i(&quot;await evaluator(s)&quot;),
<a name="api_opt_sock_acceptconn_tcp-last_expr"/><a name="14017"/>14017: <b>    ok = ?SEV_AWAIT_FINISH</b>([Tester]).
<a name="14018"/>14018: 
<a name="14019"/>14019: 
<a name="14020"/>14020: 
<a name="14021"/>14021: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="14022"/>14022: 
<a name="14023"/>14023: <i>%% Tests the socket option acceptfilter. PLACEHOLDER!</i>
<a name="14024"/>14024: 
<a name="api_opt_sock_acceptfilter-1"/><a name="14025"/>14025: <b>api_opt_sock_acceptfilter</b>(_Config) when is_list(_Config) -&gt;
<a name="14026"/>14026:     ?TT(?SECS(30)),
<a name="api_opt_sock_acceptfilter-last_expr"/><a name="14027"/>14027: <b>    tc_try</b>(api_opt_sock_acceptfilter,
<a name="14028"/>14028:            fun() -&gt; not_yet_implemented() end,
<a name="14029"/>14029:            fun() -&gt; ok end).
<a name="14030"/>14030: 
<a name="14031"/>14031: 
<a name="14032"/>14032: 
<a name="14033"/>14033: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="14034"/>14034: 
<a name="14035"/>14035: <i>%% Tests the socket option bindtodevice.</i>
<a name="14036"/>14036: <i>%% It has not always been possible to 'get' this option</i>
<a name="14037"/>14037: <i>%% (at least on linux).</i>
<a name="14038"/>14038: 
<a name="api_opt_sock_bindtodevice-1"/><a name="14039"/>14039: <b>api_opt_sock_bindtodevice</b>(_Config) when is_list(_Config) -&gt;
<a name="14040"/>14040:     ?TT(?SECS(30)),
<a name="api_opt_sock_bindtodevice-last_expr"/><a name="14041"/>14041: <b>    tc_try</b>(api_opt_sock_bindtodevice,
<a name="14042"/>14042:            fun() -&gt; has_support_sock_bindtodevice() end,
<a name="14043"/>14043:            fun() -&gt; api_opt_sock_bindtodevice() end).
<a name="14044"/>14044: 
<a name="14045"/>14045: 
<a name="api_opt_sock_bindtodevice-0"/><a name="14046"/>14046: <b>api_opt_sock_bindtodevice</b>() -&gt;
<a name="14047"/>14047:     Opt = bindtodevice,
<a name="14048"/>14048:     Set = fun(S, Val) -&gt;
<a name="14049"/>14049:                   socket:setopt(S, socket, Opt, Val)
<a name="14050"/>14050:           end,
<a name="14051"/>14051:     Get = fun(S) -&gt;
<a name="14052"/>14052:                   socket:getopt(S, socket, Opt)
<a name="14053"/>14053:           end,
<a name="14054"/>14054: 
<a name="14055"/>14055:     TesterSeq =
<a name="14056"/>14056:         [
<a name="14057"/>14057:          #{desc =&gt; &quot;which local address&quot;,
<a name="14058"/>14058:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="14059"/>14059:                            case which_local_host_info(Domain) of
<a name="14060"/>14060:                                {ok, #{name := Name, addr := Addr}} -&gt;
<a name="14061"/>14061:                                    ?SEV_IPRINT(&quot;local host info (~p): &quot;
<a name="14062"/>14062:                                                &quot;~n   Name: ~p&quot;
<a name="14063"/>14063:                                                &quot;~n   Addr: ~p&quot;,
<a name="14064"/>14064:                                                [Domain, Name, Addr]),
<a name="14065"/>14065:                                    LSA = #{family =&gt; Domain,
<a name="14066"/>14066:                                            addr   =&gt; Addr},
<a name="14067"/>14067:                                    {ok, State#{dev      =&gt; Name,
<a name="14068"/>14068:                                                local_sa =&gt; LSA}};
<a name="14069"/>14069:                                {error, _} = ERROR -&gt;
<a name="14070"/>14070:                                    ERROR
<a name="14071"/>14071:                            end
<a name="14072"/>14072:                    end},
<a name="14073"/>14073:          #{desc =&gt; &quot;create UDP socket 1&quot;,
<a name="14074"/>14074:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="14075"/>14075:                            case socket:open(Domain, dgram, udp) of
<a name="14076"/>14076:                                {ok, Sock} -&gt;
<a name="14077"/>14077:                                    {ok, State#{usock1 =&gt; Sock}};
<a name="14078"/>14078:                                {error, _} = ERROR -&gt;
<a name="14079"/>14079:                                    ERROR
<a name="14080"/>14080:                            end
<a name="14081"/>14081:                    end},
<a name="14082"/>14082:          #{desc =&gt; &quot;create UDP socket 2&quot;,
<a name="14083"/>14083:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="14084"/>14084:                            case socket:open(Domain, dgram, udp) of
<a name="14085"/>14085:                                {ok, Sock} -&gt;
<a name="14086"/>14086:                                    {ok, State#{usock2 =&gt; Sock}};
<a name="14087"/>14087:                                {error, _} = ERROR -&gt;
<a name="14088"/>14088:                                    ERROR
<a name="14089"/>14089:                            end
<a name="14090"/>14090:                    end},
<a name="14091"/>14091:          #{desc =&gt; &quot;create TCP socket 1&quot;,
<a name="14092"/>14092:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="14093"/>14093:                            case socket:open(Domain, stream, tcp) of
<a name="14094"/>14094:                                {ok, Sock} -&gt;
<a name="14095"/>14095:                                    {ok, State#{tsock1 =&gt; Sock}};
<a name="14096"/>14096:                                {error, _} = ERROR -&gt;
<a name="14097"/>14097:                                    ERROR
<a name="14098"/>14098:                            end
<a name="14099"/>14099:                    end},
<a name="14100"/>14100:          #{desc =&gt; &quot;create TCP socket 2&quot;,
<a name="14101"/>14101:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="14102"/>14102:                            case socket:open(Domain, stream, tcp) of
<a name="14103"/>14103:                                {ok, Sock} -&gt;
<a name="14104"/>14104:                                    {ok, State#{tsock2 =&gt; Sock}};
<a name="14105"/>14105:                                {error, _} = ERROR -&gt;
<a name="14106"/>14106:                                    ERROR
<a name="14107"/>14107:                            end
<a name="14108"/>14108:                    end},
<a name="14109"/>14109: 
<a name="14110"/>14110:          #{desc =&gt; &quot;[get] verify UDP socket 1 (before bindtodevice)&quot;,
<a name="14111"/>14111:            cmd  =&gt; fun(#{usock1 := Sock} = _State) -&gt;
<a name="14112"/>14112:                            case Get(Sock) of
<a name="14113"/>14113:                                {ok, Dev} -&gt;
<a name="14114"/>14114:                                    ?SEV_IPRINT(&quot;Expected Success: ~p&quot;, [Dev]),
<a name="14115"/>14115:                                    ok;
<a name="14116"/>14116:                                {error, enoprotoopt = Reason} -&gt;
<a name="14117"/>14117:                                    ?SEV_EPRINT(&quot;Unexpected Failure: ~p =&gt; SKIP&quot;,
<a name="14118"/>14118: 					       [Reason]),
<a name="14119"/>14119:                                    {skip, Reason};
<a name="14120"/>14120:                                {error, Reason} = ERROR -&gt;
<a name="14121"/>14121:                                    ?SEV_EPRINT(&quot;Unexpected Failure: ~p&quot;,
<a name="14122"/>14122: 					       [Reason]),
<a name="14123"/>14123:                                    ERROR
<a name="14124"/>14124:                            end
<a name="14125"/>14125:                    end},
<a name="14126"/>14126:          #{desc =&gt; &quot;[get] verify UDP socket 2 (before bind)&quot;,
<a name="14127"/>14127:            cmd  =&gt; fun(#{usock2 := Sock} = _State) -&gt;
<a name="14128"/>14128:                            case Get(Sock) of
<a name="14129"/>14129:                                {ok, Dev} -&gt;
<a name="14130"/>14130:                                    ?SEV_IPRINT(&quot;Expected Success: ~p&quot;, [Dev]),
<a name="14131"/>14131:                                    ok;
<a name="14132"/>14132:                                {error, Reason} = ERROR -&gt;
<a name="14133"/>14133:                                    ?SEV_EPRINT(&quot;Unexpected Failure: ~p&quot;, [Reason]),
<a name="14134"/>14134:                                    ERROR
<a name="14135"/>14135:                            end
<a name="14136"/>14136:                    end},
<a name="14137"/>14137:          #{desc =&gt; &quot;[get] verify TCP socket 1 (before bindtodevice)&quot;,
<a name="14138"/>14138:            cmd  =&gt; fun(#{tsock1 := Sock} = _State) -&gt;
<a name="14139"/>14139:                            case Get(Sock) of
<a name="14140"/>14140:                                {ok, Dev} -&gt;
<a name="14141"/>14141:                                    ?SEV_IPRINT(&quot;Expected Success: ~p&quot;, [Dev]),
<a name="14142"/>14142:                                    ok;
<a name="14143"/>14143:                                {error, Reason} = ERROR -&gt;
<a name="14144"/>14144:                                    ?SEV_EPRINT(&quot;Unexpected Failure: ~p&quot;, [Reason]),
<a name="14145"/>14145:                                    ERROR
<a name="14146"/>14146:                            end
<a name="14147"/>14147:                    end},
<a name="14148"/>14148:          #{desc =&gt; &quot;[get] verify TCP socket 2 (before bind)&quot;,
<a name="14149"/>14149:            cmd  =&gt; fun(#{tsock2 := Sock} = _State) -&gt;
<a name="14150"/>14150:                            case Get(Sock) of
<a name="14151"/>14151:                                {ok, Dev} -&gt;
<a name="14152"/>14152:                                    ?SEV_IPRINT(&quot;Expected Success: ~p&quot;, [Dev]),
<a name="14153"/>14153:                                    ok;
<a name="14154"/>14154:                                {error, Reason} = ERROR -&gt;
<a name="14155"/>14155:                                    ?SEV_EPRINT(&quot;Unexpected Failure: ~p&quot;, [Reason]),
<a name="14156"/>14156:                                    ERROR
<a name="14157"/>14157:                            end
<a name="14158"/>14158:                    end},
<a name="14159"/>14159: 
<a name="14160"/>14160:          ?SEV_SLEEP(?SECS(1)),
<a name="14161"/>14161: 
<a name="14162"/>14162:          #{desc =&gt; &quot;Bind UDP socket 1 to device&quot;,
<a name="14163"/>14163:            cmd  =&gt; fun(#{usock1 := Sock, dev := Dev} = State) -&gt;
<a name="14164"/>14164:                            case Set(Sock, Dev) of
<a name="14165"/>14165:                                ok -&gt;
<a name="14166"/>14166:                                    ?SEV_IPRINT(&quot;Expected Success&quot;),
<a name="14167"/>14167:                                    ok;
<a name="14168"/>14168:                                {error, eperm = Reason} -&gt;
<a name="14169"/>14169:                                    ?SEV_IPRINT(&quot;Expected Failure: ~p&quot;, [Reason]),
<a name="14170"/>14170:                                    (catch socket:close(Sock)),
<a name="14171"/>14171:                                    {ok, State#{usock1 =&gt; skip}};
<a name="14172"/>14172:                                {error, Reason} = ERROR -&gt;
<a name="14173"/>14173:                                    ?SEV_EPRINT(&quot;Unexpected Failure: ~p&quot;, [Reason]),
<a name="14174"/>14174:                                    ERROR
<a name="14175"/>14175:                            end
<a name="14176"/>14176:                    end},
<a name="14177"/>14177:          #{desc =&gt; &quot;Bind UDP socket 2 to local address&quot;,
<a name="14178"/>14178:            cmd  =&gt; fun(#{usock2 := Sock, local_sa := LSA} = _State) -&gt;
<a name="14179"/>14179:                            case sock_bind(Sock, LSA) of
<a name="14180"/>14180:                                ok -&gt;
<a name="14181"/>14181:                                    ?SEV_IPRINT(&quot;Expected Success&quot;),
<a name="14182"/>14182:                                    ok;
<a name="14183"/>14183:                                {error, Reason} = ERROR -&gt;
<a name="14184"/>14184:                                    ?SEV_EPRINT(&quot;Unexpected Failure: ~p&quot;, [Reason]),
<a name="14185"/>14185:                                    ERROR
<a name="14186"/>14186:                            end
<a name="14187"/>14187:                    end},
<a name="14188"/>14188:          #{desc =&gt; &quot;Bind TCP socket 1 to device&quot;,
<a name="14189"/>14189:            cmd  =&gt; fun(#{usock1 := USock1,
<a name="14190"/>14190:                          tsock1 := Sock, dev := Dev} = State) -&gt;
<a name="14191"/>14191:                            case Set(Sock, Dev) of
<a name="14192"/>14192:                                ok -&gt;
<a name="14193"/>14193:                                    ?SEV_IPRINT(&quot;Expected Success&quot;),
<a name="14194"/>14194:                                    ok;
<a name="14195"/>14195:                                {error, eperm = Reason} when (USock1 =:= skip) -&gt;
<a name="14196"/>14196:                                    ?SEV_IPRINT(&quot;Expected Failure: ~p&quot;, [Reason]),
<a name="14197"/>14197:                                    {skip, Reason};
<a name="14198"/>14198:                                {error, eperm = Reason} -&gt;
<a name="14199"/>14199:                                    ?SEV_IPRINT(&quot;Expected Failure: ~p&quot;, [Reason]),
<a name="14200"/>14200:                                    (catch socket:close(Sock)),
<a name="14201"/>14201:                                    {ok, State#{tsock1 =&gt; skip}};
<a name="14202"/>14202:                                {error, Reason} = ERROR -&gt;
<a name="14203"/>14203:                                    ?SEV_EPRINT(&quot;Unexpected Failure: ~p&quot;, [Reason]),
<a name="14204"/>14204:                                    ERROR
<a name="14205"/>14205:                            end
<a name="14206"/>14206:                    end},
<a name="14207"/>14207:          #{desc =&gt; &quot;Bind TCP socket 2 to local address&quot;,
<a name="14208"/>14208:            cmd  =&gt; fun(#{tsock2 := Sock, local_sa := LSA} = _State) -&gt;
<a name="14209"/>14209:                            case sock_bind(Sock, LSA) of
<a name="14210"/>14210:                                ok -&gt;
<a name="14211"/>14211:                                    ?SEV_IPRINT(&quot;Expected Success&quot;),
<a name="14212"/>14212:                                    ok;
<a name="14213"/>14213:                                {error, Reason} = ERROR -&gt;
<a name="14214"/>14214:                                    ?SEV_EPRINT(&quot;Unexpected Failure: ~p&quot;, [Reason]),
<a name="14215"/>14215:                                    ERROR
<a name="14216"/>14216:                            end
<a name="14217"/>14217:                    end},
<a name="14218"/>14218: 
<a name="14219"/>14219:          ?SEV_SLEEP(?SECS(1)),
<a name="14220"/>14220: 
<a name="14221"/>14221:          #{desc =&gt; &quot;[get] verify UDP socket 1 (after bindtodevice)&quot;,
<a name="14222"/>14222:            cmd  =&gt; fun(#{usock1 := skip} = _State) -&gt;
<a name="14223"/>14223:                            ?SEV_IPRINT(&quot;SKIP'ed (previous eperm)&quot;),
<a name="14224"/>14224:                            ok;
<a name="14225"/>14225:                       (#{usock1 := Sock} = _State) -&gt;
<a name="14226"/>14226:                            case Get(Sock) of
<a name="14227"/>14227:                                {ok, Dev} -&gt;
<a name="14228"/>14228:                                    ?SEV_IPRINT(&quot;Expected Success: ~p&quot;, [Dev]),
<a name="14229"/>14229:                                    ok;
<a name="14230"/>14230:                                {error, Reason} = ERROR -&gt;
<a name="14231"/>14231:                                    ?SEV_EPRINT(&quot;Unexpected Failure: ~p&quot;, [Reason]),
<a name="14232"/>14232:                                    ERROR
<a name="14233"/>14233:                            end
<a name="14234"/>14234:                    end},
<a name="14235"/>14235:          #{desc =&gt; &quot;[get] verify UDP socket 2 (after bind)&quot;,
<a name="14236"/>14236:            cmd  =&gt; fun(#{usock2 := Sock} = _State) -&gt;
<a name="14237"/>14237:                            case Get(Sock) of
<a name="14238"/>14238:                                {ok, Dev} -&gt;
<a name="14239"/>14239:                                    ?SEV_IPRINT(&quot;Expected Success: ~p&quot;, [Dev]),
<a name="14240"/>14240:                                    ok;
<a name="14241"/>14241:                                {error, Reason} = ERROR -&gt;
<a name="14242"/>14242:                                    ?SEV_EPRINT(&quot;Unexpected Failure: ~p&quot;, [Reason]),
<a name="14243"/>14243:                                    ERROR
<a name="14244"/>14244:                            end
<a name="14245"/>14245:                    end},
<a name="14246"/>14246:          #{desc =&gt; &quot;[get] verify TCP socket 1 (after bindtodevice)&quot;,
<a name="14247"/>14247:            cmd  =&gt; fun(#{tsock1 := skip} = _State) -&gt;
<a name="14248"/>14248:                            ?SEV_IPRINT(&quot;SKIP'ed (previous eperm)&quot;),
<a name="14249"/>14249:                            ok;
<a name="14250"/>14250:                       (#{tsock1 := Sock} = _State) -&gt;
<a name="14251"/>14251:                            case Get(Sock) of
<a name="14252"/>14252:                                {ok, Dev} -&gt;
<a name="14253"/>14253:                                    ?SEV_IPRINT(&quot;Expected Success: ~p&quot;, [Dev]),
<a name="14254"/>14254:                                    ok;
<a name="14255"/>14255:                                {error, Reason} = ERROR -&gt;
<a name="14256"/>14256:                                    ?SEV_EPRINT(&quot;Unexpected Failure: ~p&quot;, [Reason]),
<a name="14257"/>14257:                                    ERROR
<a name="14258"/>14258:                            end
<a name="14259"/>14259:                    end},
<a name="14260"/>14260:          #{desc =&gt; &quot;[get] verify TCP socket 2 (after bind)&quot;,
<a name="14261"/>14261:            cmd  =&gt; fun(#{tsock2 := Sock} = _State) -&gt;
<a name="14262"/>14262:                            case Get(Sock) of
<a name="14263"/>14263:                                {ok, Dev} -&gt;
<a name="14264"/>14264:                                    ?SEV_IPRINT(&quot;Expected Success: ~p&quot;, [Dev]),
<a name="14265"/>14265:                                    ok;
<a name="14266"/>14266:                                {error, Reason} = ERROR -&gt;
<a name="14267"/>14267:                                    ?SEV_EPRINT(&quot;Unexpected Failure: ~p&quot;, [Reason]),
<a name="14268"/>14268:                                    ERROR
<a name="14269"/>14269:                            end
<a name="14270"/>14270:                    end},
<a name="14271"/>14271: 
<a name="14272"/>14272:          ?SEV_SLEEP(?SECS(1)),
<a name="14273"/>14273: 
<a name="14274"/>14274:          %% *** Termination ***
<a name="14275"/>14275:          #{desc =&gt; &quot;close UDP socket 1&quot;,
<a name="14276"/>14276:            cmd  =&gt; fun(#{usock1 := skip} = State) -&gt;
<a name="14277"/>14277:                            ?SEV_IPRINT(&quot;SKIP'ed (already closed)&quot;),
<a name="14278"/>14278:                            {ok, maps:remove(usock1, State)};
<a name="14279"/>14279:                       (#{usock1 := Sock} = State) -&gt;
<a name="14280"/>14280:                            socket:close(Sock),
<a name="14281"/>14281:                            {ok, maps:remove(usock1, State)}
<a name="14282"/>14282:                    end},
<a name="14283"/>14283:          #{desc =&gt; &quot;close UDP socket 2&quot;,
<a name="14284"/>14284:            cmd  =&gt; fun(#{usock2 := Sock} = State) -&gt;
<a name="14285"/>14285:                            socket:close(Sock),
<a name="14286"/>14286:                            {ok, maps:remove(usock2, State)}
<a name="14287"/>14287:                    end},
<a name="14288"/>14288:          #{desc =&gt; &quot;close TCP socket 1&quot;,
<a name="14289"/>14289:            cmd  =&gt; fun(#{tsock1 := skip} = State) -&gt;
<a name="14290"/>14290:                            ?SEV_IPRINT(&quot;SKIP'ed (already closed)&quot;),
<a name="14291"/>14291:                            {ok, maps:remove(tsock1, State)};
<a name="14292"/>14292:                       (#{tsock1 := Sock} = State) -&gt;
<a name="14293"/>14293:                            socket:close(Sock),
<a name="14294"/>14294:                            {ok, maps:remove(tsock1, State)}
<a name="14295"/>14295:                    end},
<a name="14296"/>14296:          #{desc =&gt; &quot;close TCP socket 2&quot;,
<a name="14297"/>14297:            cmd  =&gt; fun(#{tsock2 := Sock} = State) -&gt;
<a name="14298"/>14298:                            socket:close(Sock),
<a name="14299"/>14299:                            {ok, maps:remove(tsock2, State)}
<a name="14300"/>14300:                    end},
<a name="14301"/>14301: 
<a name="14302"/>14302:          %% *** We are done ***
<a name="14303"/>14303:          ?SEV_FINISH_NORMAL
<a name="14304"/>14304:         ],
<a name="14305"/>14305: 
<a name="14306"/>14306:     Domain = inet_or_inet6(),
<a name="14307"/>14307: 
<a name="14308"/>14308:     i(&quot;start tester evaluator&quot;),
<a name="14309"/>14309:     InitState = #{domain  =&gt; Domain},
<a name="14310"/>14310:     Tester = ?SEV_START(&quot;tester&quot;, TesterSeq, InitState),
<a name="14311"/>14311: 
<a name="14312"/>14312:     i(&quot;await evaluator(s)&quot;),
<a name="api_opt_sock_bindtodevice-last_expr"/><a name="14313"/>14313: <b>    ok = ?SEV_AWAIT_FINISH</b>([Tester]).
<a name="14314"/>14314: 
<a name="14315"/>14315: 
<a name="14316"/>14316: 
<a name="14317"/>14317: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="14318"/>14318: 
<a name="14319"/>14319: <i>%% Tests the socket option broadcast.</i>
<a name="14320"/>14320: <i>%% Make it possible for datagram sockets to send packets to a broadcast</i>
<a name="14321"/>14321: <i>%% address (IPv4 only).</i>
<a name="14322"/>14322: 
<a name="api_opt_sock_broadcast-1"/><a name="14323"/>14323: <b>api_opt_sock_broadcast</b>(_Config) when is_list(_Config) -&gt;
<a name="14324"/>14324:     ?TT(?SECS(30)),
<a name="api_opt_sock_broadcast-last_expr"/><a name="14325"/>14325: <b>    tc_try</b>(api_opt_sock_broadcast,
<a name="14326"/>14326:            fun() -&gt; has_support_sock_broadcast() end,
<a name="14327"/>14327:            fun() -&gt; api_opt_sock_broadcast() end).
<a name="14328"/>14328: 
<a name="14329"/>14329: 
<a name="api_opt_sock_broadcast-0"/><a name="14330"/>14330: <b>api_opt_sock_broadcast</b>() -&gt;
<a name="14331"/>14331:     Opt    = broadcast,
<a name="14332"/>14332:     Set    = fun(S, Val) when is_boolean(Val) -&gt;
<a name="14333"/>14333:                      socket:setopt(S, socket, Opt, Val)
<a name="14334"/>14334:              end,
<a name="14335"/>14335:     Get    = fun(S) -&gt;
<a name="14336"/>14336:                      socket:getopt(S, socket, Opt)
<a name="14337"/>14337:              end,
<a name="14338"/>14338: 
<a name="14339"/>14339:     TesterSeq =
<a name="14340"/>14340:         [
<a name="14341"/>14341:          #{desc =&gt; &quot;which local address&quot;,
<a name="14342"/>14342:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="14343"/>14343:                            case which_local_host_info(Domain) of
<a name="14344"/>14344:                                {ok, #{name      := Name,
<a name="14345"/>14345:                                       addr      := Addr,
<a name="14346"/>14346:                                       broadaddr := BAddr}}
<a name="14347"/>14347: 				 when (BAddr =/= undefined) -&gt;
<a name="14348"/>14348:                                    ?SEV_IPRINT(&quot;local host info: &quot;
<a name="14349"/>14349:                                                &quot;~n   Name:           ~p&quot;
<a name="14350"/>14350:                                                &quot;~n   Addr:           ~p&quot;
<a name="14351"/>14351:                                                &quot;~n   Broadcast Addr: ~p&quot;,
<a name="14352"/>14352:                                                [Name, Addr, BAddr]),
<a name="14353"/>14353:                                    LSA = #{family =&gt; Domain,
<a name="14354"/>14354:                                            addr   =&gt; Addr},
<a name="14355"/>14355:                                    BSA = #{family =&gt; Domain,
<a name="14356"/>14356:                                            addr   =&gt; BAddr},
<a name="14357"/>14357:                                    {ok, State#{lsa =&gt; LSA,
<a name="14358"/>14358:                                                bsa =&gt; BSA}};
<a name="14359"/>14359: 			       {ok, _} -&gt;
<a name="14360"/>14360: 				   {skip, no_broadcast_address};
<a name="14361"/>14361:                                {error, _} = ERROR -&gt;
<a name="14362"/>14362:                                    ERROR
<a name="14363"/>14363:                            end
<a name="14364"/>14364:                    end},
<a name="14365"/>14365: 
<a name="14366"/>14366:          #{desc =&gt; &quot;[socket 1] create UDP socket (listening 1)&quot;,
<a name="14367"/>14367:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="14368"/>14368:                            case socket:open(Domain, dgram, udp) of
<a name="14369"/>14369:                                {ok, Sock} -&gt;
<a name="14370"/>14370:                                    {ok, State#{sock1 =&gt; Sock}};
<a name="14371"/>14371:                                {error, _} = ERROR -&gt;
<a name="14372"/>14372:                                    ERROR
<a name="14373"/>14373:                            end
<a name="14374"/>14374:                    end},
<a name="14375"/>14375:          #{desc =&gt; &quot;[socket 1] Bind UDP socket (to limited broadcast address)&quot;,
<a name="14376"/>14376:            cmd  =&gt; fun(#{sock1 := Sock} = State) -&gt;
<a name="14377"/>14377: 			   BSA = #{family =&gt; inet,
<a name="14378"/>14378: 				   addr   =&gt; broadcast},
<a name="14379"/>14379:                            ?SEV_IPRINT(&quot;Try bind (socket 1) to: &quot;
<a name="14380"/>14380:                                        &quot;~n   ~p&quot;, [BSA]),
<a name="14381"/>14381:                            case socket:bind(Sock, BSA) of
<a name="14382"/>14382:                                ok -&gt;
<a name="14383"/>14383:                                    Port = sock_port(Sock),
<a name="14384"/>14384:                                    ?SEV_IPRINT(&quot;Expected Success (bound): ~p&quot;,
<a name="14385"/>14385:                                                [Port]),
<a name="14386"/>14386:                                    {ok, State#{sa1 =&gt; BSA#{port =&gt; Port}}};
<a name="14387"/>14387:                                {error, eaddrnotavail = Reason} -&gt;
<a name="14388"/>14388:                                    ?SEV_IPRINT(&quot;~p =&gt; &quot;
<a name="14389"/>14389: 					       &quot;SKIP limited broadcast test&quot;,
<a name="14390"/>14390: 					       [Reason]),
<a name="14391"/>14391:                                    {ok, State#{sa1 =&gt; skip}};
<a name="14392"/>14392:                                {error, Reason} = ERROR -&gt;
<a name="14393"/>14393:                                    ?SEV_EPRINT(&quot;Unexpected Failure: ~p&quot;,
<a name="14394"/>14394: 					       [Reason]),
<a name="14395"/>14395:                                    ERROR
<a name="14396"/>14396:                            end
<a name="14397"/>14397:                    end},
<a name="14398"/>14398:          #{desc =&gt; &quot;[socket 1] UDP socket sockname&quot;,
<a name="14399"/>14399:            cmd  =&gt; fun(#{sa1 := skip} = _State) -&gt;
<a name="14400"/>14400:                            ?SEV_IPRINT(&quot;SKIP limited broadcast test&quot;),
<a name="14401"/>14401:                            ok;
<a name="14402"/>14402: 		      (#{sock1 := Sock} = _State) -&gt;
<a name="14403"/>14403: 			   case socket:sockname(Sock) of
<a name="14404"/>14404: 			       {ok, SA} -&gt;
<a name="14405"/>14405: 				   ?SEV_IPRINT(&quot;SA: ~p&quot;, [SA]),
<a name="14406"/>14406: 				   ok;
<a name="14407"/>14407: 			       {error, _} = ERROR -&gt;
<a name="14408"/>14408: 				   ERROR
<a name="14409"/>14409: 			   end
<a name="14410"/>14410:                    end},
<a name="14411"/>14411: 
<a name="14412"/>14412:          ?SEV_SLEEP(?SECS(1)),
<a name="14413"/>14413: 
<a name="14414"/>14414:          #{desc =&gt; &quot;[socket 2] create UDP socket (listening 2)&quot;,
<a name="14415"/>14415:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="14416"/>14416:                            case socket:open(Domain, dgram, udp) of
<a name="14417"/>14417:                                {ok, Sock} -&gt;
<a name="14418"/>14418:                                    {ok, State#{sock2 =&gt; Sock}};
<a name="14419"/>14419:                                {error, _} = ERROR -&gt;
<a name="14420"/>14420:                                    ERROR
<a name="14421"/>14421:                            end
<a name="14422"/>14422:                    end},
<a name="14423"/>14423:          #{desc =&gt; &quot;[socket 2] Bind UDP socket (to subnet-directed broadcast address)&quot;,
<a name="14424"/>14424:            cmd  =&gt; fun(#{sock2 := Sock,
<a name="14425"/>14425: 			 bsa   := BSA} = State) -&gt;
<a name="14426"/>14426:                            ?SEV_IPRINT(&quot;Try bind (socket 1) to: &quot;
<a name="14427"/>14427:                                        &quot;~n   ~p&quot;, [BSA]),
<a name="14428"/>14428:                            case socket:bind(Sock, BSA) of
<a name="14429"/>14429:                                ok -&gt;
<a name="14430"/>14430:                                    Port = sock_port(Sock),
<a name="14431"/>14431:                                    ?SEV_IPRINT(&quot;Expected Success (bound): ~p&quot;,
<a name="14432"/>14432:                                                [Port]),
<a name="14433"/>14433:                                    {ok, State#{sa2 =&gt; BSA#{port =&gt; Port}}};
<a name="14434"/>14434:                                {error, eaddrnotavail = Reason} -&gt;
<a name="14435"/>14435:                                    ?SEV_IPRINT(&quot;~p =&gt; &quot;
<a name="14436"/>14436: 					       &quot;SKIP subnet-directed broadcast test&quot;,
<a name="14437"/>14437: 					       [Reason]),
<a name="14438"/>14438:                                    {ok, State#{sa2 =&gt; skip}};
<a name="14439"/>14439:                                {error, Reason} = ERROR -&gt;
<a name="14440"/>14440:                                    ?SEV_EPRINT(&quot;Unexpected Failure: ~p&quot;,
<a name="14441"/>14441: 					       [Reason]),
<a name="14442"/>14442:                                    ERROR
<a name="14443"/>14443:                            end
<a name="14444"/>14444:                    end},
<a name="14445"/>14445:          #{desc =&gt; &quot;[socket 2] UDP socket sockname&quot;,
<a name="14446"/>14446:            cmd  =&gt; fun(#{sa2 := skip} = _State) -&gt;
<a name="14447"/>14447:                            ?SEV_IPRINT(&quot;SKIP subnet-directed broadcast test&quot;),
<a name="14448"/>14448:                            ok;
<a name="14449"/>14449: 		      (#{sock2 := Sock} = _State) -&gt;
<a name="14450"/>14450:                            case socket:sockname(Sock) of
<a name="14451"/>14451:                                {ok, SA} -&gt;
<a name="14452"/>14452: 				   ?SEV_IPRINT(&quot;SA: ~p&quot;, [SA]),
<a name="14453"/>14453:                                    ok;
<a name="14454"/>14454:                                {error, _} = ERROR -&gt;
<a name="14455"/>14455:                                    ERROR
<a name="14456"/>14456:                            end
<a name="14457"/>14457:                    end},
<a name="14458"/>14458: 
<a name="14459"/>14459:          ?SEV_SLEEP(?SECS(1)),
<a name="14460"/>14460: 
<a name="14461"/>14461:          #{desc =&gt; &quot;[socket 3] create UDP socket (sender)&quot;,
<a name="14462"/>14462:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="14463"/>14463:                            case socket:open(Domain, dgram, udp) of
<a name="14464"/>14464:                                {ok, Sock} -&gt;
<a name="14465"/>14465:                                    {ok, State#{sock3 =&gt; Sock}};
<a name="14466"/>14466:                                {error, _} = ERROR -&gt;
<a name="14467"/>14467:                                    ERROR
<a name="14468"/>14468:                            end
<a name="14469"/>14469:                    end},
<a name="14470"/>14470:          #{desc =&gt; &quot;[socket 3][get] verify UDP socket (before bind and set)&quot;,
<a name="14471"/>14471:            cmd  =&gt; fun(#{sock3 := Sock} = _State) -&gt;
<a name="14472"/>14472:                            case Get(Sock) of
<a name="14473"/>14473:                                {ok, false} -&gt;
<a name="14474"/>14474:                                    ?SEV_IPRINT(&quot;Expected Success: &quot;
<a name="14475"/>14475:                                                &quot;broadcast not allowed&quot;),
<a name="14476"/>14476:                                    ok;
<a name="14477"/>14477:                                {ok, true} -&gt;
<a name="14478"/>14478:                                    ?SEV_IPRINT(&quot;Unexpected Success result: &quot;
<a name="14479"/>14479:                                                &quot;broadcast already allowed&quot;),
<a name="14480"/>14480:                                    ok;
<a name="14481"/>14481:                                {error, Reason} = ERROR -&gt;
<a name="14482"/>14482:                                    ?SEV_EPRINT(&quot;Unexpected Failure: ~p&quot;,
<a name="14483"/>14483: 					       [Reason]),
<a name="14484"/>14484:                                    ERROR
<a name="14485"/>14485:                            end
<a name="14486"/>14486:                    end},
<a name="14487"/>14487:          #{desc =&gt; &quot;[socket 3] Try make broadcast allowed&quot;,
<a name="14488"/>14488:            cmd  =&gt; fun(#{sock3 := Sock} = _State) -&gt;
<a name="14489"/>14489:                            case Set(Sock, true) of
<a name="14490"/>14490:                                ok -&gt;
<a name="14491"/>14491:                                    ?SEV_IPRINT(&quot;Expected Success: &quot;
<a name="14492"/>14492:                                                &quot;broadcast now allowed&quot;),
<a name="14493"/>14493:                                    ok;
<a name="14494"/>14494:                                {error, Reason} = ERROR -&gt;
<a name="14495"/>14495:                                    ?SEV_EPRINT(&quot;Unexpected Failure: ~p&quot;,
<a name="14496"/>14496: 					       [Reason]),
<a name="14497"/>14497:                                    ERROR
<a name="14498"/>14498:                            end
<a name="14499"/>14499:                    end},
<a name="14500"/>14500:          #{desc =&gt; &quot;[socket 3] verify UDP socket broadcast allowed&quot;,
<a name="14501"/>14501:            cmd  =&gt; fun(#{sock3 := Sock} = _State) -&gt;
<a name="14502"/>14502:                            case Get(Sock) of
<a name="14503"/>14503:                                {ok, true} -&gt;
<a name="14504"/>14504:                                    ?SEV_IPRINT(&quot;Expected Success: &quot;
<a name="14505"/>14505:                                                &quot;broadcast allowed&quot;),
<a name="14506"/>14506:                                    ok;
<a name="14507"/>14507:                                {ok, false} -&gt;
<a name="14508"/>14508:                                    ?SEV_IPRINT(&quot;Unexpected Success result: &quot;
<a name="14509"/>14509:                                                &quot;broadcast *not* allowed&quot;),
<a name="14510"/>14510:                                    ok;
<a name="14511"/>14511:                                {error, Reason} = ERROR -&gt;
<a name="14512"/>14512:                                    ?SEV_EPRINT(&quot;Unexpected Failure: ~p&quot;,
<a name="14513"/>14513: 					       [Reason]),
<a name="14514"/>14514:                                    ERROR
<a name="14515"/>14515:                            end
<a name="14516"/>14516:                    end},
<a name="14517"/>14517:          #{desc =&gt; &quot;[socket 3] Bind UDP socket (to local address)&quot;,
<a name="14518"/>14518:            cmd  =&gt; fun(#{sock3 := Sock, lsa := LSA} = State) -&gt;
<a name="14519"/>14519:                            ?SEV_IPRINT(&quot;Try bind (socket 2) to: &quot;
<a name="14520"/>14520:                                        &quot;~n   ~p&quot;, [LSA]),
<a name="14521"/>14521:                            case socket:bind(Sock, LSA) of
<a name="14522"/>14522:                                ok -&gt;
<a name="14523"/>14523:                                    Port = sock_port(Sock),
<a name="14524"/>14524:                                    ?SEV_IPRINT(&quot;Expected Success (bound): ~p&quot;,
<a name="14525"/>14525:                                                [Port]),
<a name="14526"/>14526:                                    {ok, State#{sa3 =&gt; LSA#{port =&gt; Port}}};
<a name="14527"/>14527:                                {error, Reason} = ERROR -&gt;
<a name="14528"/>14528:                                    ?SEV_EPRINT(&quot;Unexpected Failure: ~p&quot;,
<a name="14529"/>14529: 					       [Reason]),
<a name="14530"/>14530:                                    ERROR
<a name="14531"/>14531:                            end
<a name="14532"/>14532:                    end},
<a name="14533"/>14533:          #{desc =&gt; &quot;[socket 3] verify UDP socket (after set)&quot;,
<a name="14534"/>14534:            cmd  =&gt; fun(#{sock3 := Sock} = _State) -&gt;
<a name="14535"/>14535:                            case Get(Sock) of
<a name="14536"/>14536:                                {ok, true} -&gt;
<a name="14537"/>14537:                                    ?SEV_IPRINT(&quot;Expected Success: &quot;
<a name="14538"/>14538:                                                &quot;broadcast allowed&quot;),
<a name="14539"/>14539:                                    ok;
<a name="14540"/>14540:                                {ok, false} -&gt;
<a name="14541"/>14541:                                    ?SEV_IPRINT(&quot;Unexpected Success result: &quot;
<a name="14542"/>14542:                                                &quot;broadcast not allowed&quot;),
<a name="14543"/>14543:                                    {error, not_allowed};
<a name="14544"/>14544:                                {error, Reason} = ERROR -&gt;
<a name="14545"/>14545:                                    ?SEV_EPRINT(&quot;Unexpected Failure: ~p&quot;,
<a name="14546"/>14546: 					       [Reason]),
<a name="14547"/>14547:                                    ERROR
<a name="14548"/>14548:                            end
<a name="14549"/>14549:                    end},
<a name="14550"/>14550: 
<a name="14551"/>14551: 	 ?SEV_SLEEP(?SECS(1)),
<a name="14552"/>14552: 
<a name="14553"/>14553:          #{desc =&gt; &quot;[socket 3] try send to limited broadcast address&quot;,
<a name="14554"/>14554:            cmd  =&gt; fun(#{sa1 := skip} = _State) -&gt;
<a name="14555"/>14555:                            ?SEV_IPRINT(&quot;SKIP limited broadcast test (send)&quot;),
<a name="14556"/>14556: 			   ok;
<a name="14557"/>14557: 		      (#{sock3 := Sock,
<a name="14558"/>14558: 			 sa1   := Dest} = _State) -&gt;
<a name="14559"/>14559: 			   Data = list_to_binary(&quot;hejsan&quot;),
<a name="14560"/>14560: 			   ?SEV_IPRINT(&quot;try send to broadcast address: &quot;
<a name="14561"/>14561: 				       &quot;~n   ~p&quot;, [Dest]),
<a name="14562"/>14562: 			   case socket:sendto(Sock, Data, Dest) of
<a name="14563"/>14563: 			       ok -&gt;
<a name="14564"/>14564: 				   ?SEV_IPRINT(&quot;Expected Success: &quot;
<a name="14565"/>14565: 					       &quot;broadcast message sent&quot;),
<a name="14566"/>14566: 				   ok;
<a name="14567"/>14567: 			       {error, Reason} = ERROR -&gt;
<a name="14568"/>14568: 				   ?SEV_EPRINT(&quot;Unexpected Failure: ~p&quot;,
<a name="14569"/>14569: 					       [Reason]),
<a name="14570"/>14570: 				   ERROR
<a name="14571"/>14571: 			   end
<a name="14572"/>14572: 		   end},
<a name="14573"/>14573:          #{desc =&gt; &quot;[socket 1] try recv&quot;,
<a name="14574"/>14574:            cmd  =&gt; fun(#{sa1 := skip} = _State) -&gt;
<a name="14575"/>14575: 			   ?SEV_IPRINT(&quot;SKIP limited broadcast test (recv)&quot;),
<a name="14576"/>14576: 			   ok;
<a name="14577"/>14577: 		      (#{sock1 := Sock} = State) -&gt;
<a name="14578"/>14578:                            case socket:recvfrom(Sock, 0, 5000) of
<a name="14579"/>14579:                                {ok, _} -&gt;
<a name="14580"/>14580:                                    ?SEV_IPRINT(&quot;Expected Success: &quot;
<a name="14581"/>14581:                                                &quot;received message&quot;),
<a name="14582"/>14582:                                    ok;
<a name="14583"/>14583:                                {error, timeout = Reason} -&gt;
<a name="14584"/>14584:                                    %% Some platforms seem to balk at this.
<a name="14585"/>14585:                                    %% It spossible to bind to this, and
<a name="14586"/>14586:                                    %% send to it, but no data is received.
<a name="14587"/>14587:                                    %% At some point we should investigate...
<a name="14588"/>14588:                                    %% For now, we just skip this part of
<a name="14589"/>14589:                                    %% the test...
<a name="14590"/>14590:                                    ?SEV_IPRINT(&quot;Unexpected Failure: ~p&quot;,
<a name="14591"/>14591: 					       [Reason]),
<a name="14592"/>14592:                                    {ok, State#{sa1 =&gt; skip}};
<a name="14593"/>14593:                                {error, Reason} = ERROR -&gt;
<a name="14594"/>14594:                                    ?SEV_EPRINT(&quot;Unexpected Failure: ~p&quot;,
<a name="14595"/>14595: 					       [Reason]),
<a name="14596"/>14596:                                    ERROR
<a name="14597"/>14597:                            end
<a name="14598"/>14598:                    end},
<a name="14599"/>14599: 
<a name="14600"/>14600: 	 ?SEV_SLEEP(?SECS(1)),
<a name="14601"/>14601: 
<a name="14602"/>14602:          #{desc =&gt; &quot;[socket 2] try send to subnet-directed broadcast address&quot;,
<a name="14603"/>14603:            cmd  =&gt; fun(#{sa2 := skip} = _State) -&gt;
<a name="14604"/>14604: 			   ?SEV_IPRINT(&quot;SKIP subnet-directed broadcast test &quot;
<a name="14605"/>14605:                                        &quot;(send)&quot;),
<a name="14606"/>14606: 			   ok;
<a name="14607"/>14607: 		      (#{sock2 := Sock,
<a name="14608"/>14608:                          sa2   := Dest} = _State) -&gt;
<a name="14609"/>14609:                            Data = list_to_binary(&quot;hejsan&quot;),
<a name="14610"/>14610:                            ?SEV_IPRINT(&quot;try send to broadcast address: &quot;
<a name="14611"/>14611:                                        &quot;~n   ~p&quot;, [Dest]),
<a name="14612"/>14612:                            case socket:sendto(Sock, Data, Dest) of
<a name="14613"/>14613:                                ok -&gt;
<a name="14614"/>14614:                                    ?SEV_IPRINT(&quot;Expected Success: &quot;
<a name="14615"/>14615:                                                &quot;broadcast message sent&quot;),
<a name="14616"/>14616:                                    ok;
<a name="14617"/>14617:                                {error, eaddrnotavail = Reason} -&gt;
<a name="14618"/>14618:                                    ?SEV_EPRINT(&quot;Unexpected Failure: ~p =&gt; SKIP&quot;,
<a name="14619"/>14619:                                                [Reason]),
<a name="14620"/>14620:                                    {skip, Reason};
<a name="14621"/>14621:                                {error, eacces = Reason} -&gt;
<a name="14622"/>14622:                                    ?SEV_EPRINT(&quot;Unexpected Failure: ~p =&gt; SKIP&quot;,
<a name="14623"/>14623: 					       [Reason]),
<a name="14624"/>14624:                                    {skip, Reason};
<a name="14625"/>14625:                                {error, Reason} = ERROR -&gt;
<a name="14626"/>14626:                                    ?SEV_EPRINT(&quot;Unexpected Failure: ~p&quot;,
<a name="14627"/>14627: 					       [Reason]),
<a name="14628"/>14628:                                    ERROR
<a name="14629"/>14629:                            end
<a name="14630"/>14630:                    end},
<a name="14631"/>14631:          #{desc =&gt; &quot;[socket 2] try recv&quot;,
<a name="14632"/>14632:            cmd  =&gt; fun(#{sa2 := skip} = _State) -&gt;
<a name="14633"/>14633: 			   ?SEV_IPRINT(&quot;SKIP subnet-directed broadcast test &quot;
<a name="14634"/>14634:                                          &quot;(recv)&quot;),
<a name="14635"/>14635: 			   ok;
<a name="14636"/>14636: 		      (#{sock2 := Sock, sa2 := SA2} = _State) -&gt;
<a name="14637"/>14637:                            case socket:recvfrom(Sock, 0, 5000) of
<a name="14638"/>14638:                                {ok, _} -&gt;
<a name="14639"/>14639:                                    ?SEV_IPRINT(&quot;Expected Success: &quot;
<a name="14640"/>14640:                                                &quot;received message&quot;),
<a name="14641"/>14641:                                    ok;
<a name="14642"/>14642:                                {error, timeout = Reason} when (SA2 =:= skip) -&gt;
<a name="14643"/>14643:                                    ?SEV_IPRINT(&quot;Unexpected Failure: ~p&quot;,
<a name="14644"/>14644: 					       [Reason]),
<a name="14645"/>14645:                                    {skip, &quot;receive timeout&quot;};
<a name="14646"/>14646:                                {error, Reason} = ERROR -&gt;
<a name="14647"/>14647:                                    ?SEV_EPRINT(&quot;Unexpected Failure: ~p&quot;,
<a name="14648"/>14648: 					       [Reason]),
<a name="14649"/>14649:                                    ERROR
<a name="14650"/>14650:                            end
<a name="14651"/>14651:                    end},
<a name="14652"/>14652: 
<a name="14653"/>14653:          %% *** Termination ***
<a name="14654"/>14654:          #{desc =&gt; &quot;[socket 3] close UDP socket (sender)&quot;,
<a name="14655"/>14655:            cmd  =&gt; fun(#{sock3 := Sock} = State0) -&gt;
<a name="14656"/>14656:                            socket:close(Sock),
<a name="14657"/>14657: 			   State1 = maps:remove(sock3, State0),
<a name="14658"/>14658: 			   State2 = maps:remove(sa3,   State1),
<a name="14659"/>14659: 			   {ok, State2}
<a name="14660"/>14660:                    end},
<a name="14661"/>14661:          #{desc =&gt; &quot;[socket 2] close UDP socket (listener 2)&quot;,
<a name="14662"/>14662:            cmd  =&gt; fun(#{sock2 := Sock} = State0) -&gt;
<a name="14663"/>14663:                            socket:close(Sock),
<a name="14664"/>14664: 			   State1 = maps:remove(sock2, State0),
<a name="14665"/>14665: 			   State2 = maps:remove(sa2,   State1),
<a name="14666"/>14666:                            {ok, State2}
<a name="14667"/>14667:                    end},
<a name="14668"/>14668:          #{desc =&gt; &quot;[socket 1] close UDP socket (listener 1)&quot;,
<a name="14669"/>14669:            cmd  =&gt; fun(#{sock1 := Sock} = State0) -&gt;
<a name="14670"/>14670:                            socket:close(Sock),
<a name="14671"/>14671: 			   State1 = maps:remove(sock1, State0),
<a name="14672"/>14672: 			   State2 = maps:remove(sa1,   State1),
<a name="14673"/>14673:                            {ok, State2}
<a name="14674"/>14674:                    end},
<a name="14675"/>14675: 
<a name="14676"/>14676:          %% *** We are done ***
<a name="14677"/>14677:          ?SEV_FINISH_NORMAL
<a name="14678"/>14678:         ],
<a name="14679"/>14679: 
<a name="14680"/>14680:     Domain = inet_or_inet6(),
<a name="14681"/>14681: 
<a name="14682"/>14682:     i(&quot;start tester evaluator&quot;),
<a name="14683"/>14683:     InitState = #{domain =&gt; Domain},
<a name="14684"/>14684:     Tester = ?SEV_START(&quot;tester&quot;, TesterSeq, InitState),
<a name="14685"/>14685: 
<a name="14686"/>14686:     i(&quot;await evaluator(s)&quot;),
<a name="api_opt_sock_broadcast-last_expr"/><a name="14687"/>14687: <b>    ok = ?SEV_AWAIT_FINISH</b>([Tester]).
<a name="14688"/>14688: 
<a name="14689"/>14689: 
<a name="14690"/>14690: 
<a name="14691"/>14691: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="14692"/>14692: 
<a name="14693"/>14693: <i>%% Tests the socket option debug.</i>
<a name="14694"/>14694: <i>%% On linux, this test requires that the user running the test to have</i>
<a name="14695"/>14695: <i>%% CAP_NET_ADMIN capabilities or be root (effective user ID of 0), </i>
<a name="14696"/>14696: <i>%% therefore we explicitly test for the result eacces when attempting to</i>
<a name="14697"/>14697: <i>%% set, and skip if we get it.</i>
<a name="14698"/>14698: 
<a name="api_opt_sock_debug-1"/><a name="14699"/>14699: <b>api_opt_sock_debug</b>(_Config) when is_list(_Config) -&gt;
<a name="14700"/>14700:     ?TT(?SECS(10)),
<a name="api_opt_sock_debug-last_expr"/><a name="14701"/>14701: <b>    tc_try</b>(api_opt_sock_debug,
<a name="14702"/>14702:            fun() -&gt; has_support_sock_debug() end,
<a name="14703"/>14703:            fun() -&gt; api_opt_sock_debug() end).
<a name="14704"/>14704: 
<a name="14705"/>14705: 
<a name="api_opt_sock_debug-0"/><a name="14706"/>14706: <b>api_opt_sock_debug</b>() -&gt;
<a name="14707"/>14707:     Opt    = debug,
<a name="14708"/>14708:     Set    = fun(S, Val) when is_integer(Val) -&gt;
<a name="14709"/>14709:                      socket:setopt(S, socket, Opt, Val)
<a name="14710"/>14710:              end,
<a name="14711"/>14711:     Get    = fun(S) -&gt;
<a name="14712"/>14712:                      socket:getopt(S, socket, Opt)
<a name="14713"/>14713:              end,
<a name="14714"/>14714: 
<a name="14715"/>14715:     TesterSeq =
<a name="14716"/>14716:         [
<a name="14717"/>14717:          #{desc =&gt; &quot;which local address&quot;,
<a name="14718"/>14718:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="14719"/>14719:                            case which_local_host_info(Domain) of
<a name="14720"/>14720:                                {ok, #{name      := Name,
<a name="14721"/>14721:                                       addr      := Addr}} -&gt;
<a name="14722"/>14722:                                    ?SEV_IPRINT(&quot;local host info: &quot;
<a name="14723"/>14723:                                                &quot;~n   Name:           ~p&quot;
<a name="14724"/>14724:                                                &quot;~n   Addr:           ~p&quot;,
<a name="14725"/>14725:                                                [Name, Addr]),
<a name="14726"/>14726:                                    LSA = #{family =&gt; Domain,
<a name="14727"/>14727:                                            addr   =&gt; Addr},
<a name="14728"/>14728:                                    {ok, State#{lsa =&gt; LSA}};
<a name="14729"/>14729:                                {error, _} = ERROR -&gt;
<a name="14730"/>14730:                                    ERROR
<a name="14731"/>14731:                            end
<a name="14732"/>14732:                    end},
<a name="14733"/>14733: 
<a name="14734"/>14734:          #{desc =&gt; &quot;create UDP socket&quot;,
<a name="14735"/>14735:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="14736"/>14736:                            case socket:open(Domain, dgram, udp) of
<a name="14737"/>14737:                                {ok, Sock} -&gt;
<a name="14738"/>14738:                                    {ok, State#{sock =&gt; Sock}};
<a name="14739"/>14739:                                {error, _} = ERROR -&gt;
<a name="14740"/>14740:                                    ERROR
<a name="14741"/>14741:                            end
<a name="14742"/>14742:                    end},
<a name="14743"/>14743:          #{desc =&gt; &quot;Get current debug value&quot;,
<a name="14744"/>14744:            cmd  =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="14745"/>14745:                            case Get(Sock) of
<a name="14746"/>14746:                                {ok, Debug} when is_integer(Debug) -&gt;
<a name="14747"/>14747:                                    ?SEV_IPRINT(&quot;Success: ~p&quot;, [Debug]),
<a name="14748"/>14748:                                    {ok, State#{debug =&gt; Debug}};
<a name="14749"/>14749:                                {error, Reason} = ERROR -&gt;
<a name="14750"/>14750:                                    ?SEV_EPRINT(&quot;Unexpected failure: ~p&quot;,
<a name="14751"/>14751:                                                [Reason]),
<a name="14752"/>14752:                                    ERROR
<a name="14753"/>14753:                            end
<a name="14754"/>14754:                    end},
<a name="14755"/>14755:          #{desc =&gt; &quot;Try enable socket debug&quot;,
<a name="14756"/>14756:            cmd  =&gt; fun(#{sock := Sock, debug := Debug} = State) -&gt;
<a name="14757"/>14757: 			   NewDebug = Debug + 1,
<a name="14758"/>14758:                            case Set(Sock, NewDebug) of
<a name="14759"/>14759:                                ok -&gt;
<a name="14760"/>14760:                                    ?SEV_IPRINT(&quot;Expected Success&quot;),
<a name="14761"/>14761:                                    {ok, State#{debug =&gt; NewDebug}};
<a name="14762"/>14762:                                {error, eacces = Reason} -&gt;
<a name="14763"/>14763:                                    ?SEV_EPRINT(&quot;NO ACCESS =&gt; SKIP&quot;),
<a name="14764"/>14764:                                    {skip, Reason};
<a name="14765"/>14765:                                {error, Reason} = ERROR -&gt;
<a name="14766"/>14766:                                    ?SEV_EPRINT(&quot;Unexpected Failure: ~p&quot;,
<a name="14767"/>14767: 					       [Reason]),
<a name="14768"/>14768:                                    ERROR
<a name="14769"/>14769:                            end
<a name="14770"/>14770:                    end},
<a name="14771"/>14771:          #{desc =&gt; &quot;Get current (new) debug value&quot;,
<a name="14772"/>14772:            cmd  =&gt; fun(#{sock := Sock, debug := Debug} = _State) -&gt;
<a name="14773"/>14773:                            case Get(Sock) of
<a name="14774"/>14774:                                {ok, Debug} when is_integer(Debug) -&gt;
<a name="14775"/>14775:                                    ?SEV_IPRINT(&quot;Success: ~p&quot;, [Debug]),
<a name="14776"/>14776:                                    ok;
<a name="14777"/>14777:                                {error, Reason} = ERROR -&gt;
<a name="14778"/>14778:                                    ?SEV_EPRINT(&quot;Unexpected failure: ~p&quot;,
<a name="14779"/>14779:                                                [Reason]),
<a name="14780"/>14780:                                    ERROR
<a name="14781"/>14781:                            end
<a name="14782"/>14782:                    end},
<a name="14783"/>14783: 
<a name="14784"/>14784:          %% *** Termination ***
<a name="14785"/>14785:          #{desc =&gt; &quot;close UDP socket&quot;,
<a name="14786"/>14786:            cmd  =&gt; fun(#{sock := Sock} = State0) -&gt;
<a name="14787"/>14787:                            socket:close(Sock),
<a name="14788"/>14788: 			   State1 = maps:remove(sock, State0),
<a name="14789"/>14789:                            {ok, State1}
<a name="14790"/>14790:                    end},
<a name="14791"/>14791: 
<a name="14792"/>14792:          %% *** We are done ***
<a name="14793"/>14793:          ?SEV_FINISH_NORMAL
<a name="14794"/>14794:         ],
<a name="14795"/>14795: 
<a name="14796"/>14796:     Domain = inet_or_inet6(),
<a name="14797"/>14797: 
<a name="14798"/>14798:     i(&quot;start tester evaluator&quot;),
<a name="14799"/>14799:     InitState = #{domain =&gt; Domain},
<a name="14800"/>14800:     Tester = ?SEV_START(&quot;tester&quot;, TesterSeq, InitState),
<a name="14801"/>14801: 
<a name="14802"/>14802:     i(&quot;await evaluator(s)&quot;),
<a name="api_opt_sock_debug-last_expr"/><a name="14803"/>14803: <b>    ok = ?SEV_AWAIT_FINISH</b>([Tester]).
<a name="14804"/>14804: 
<a name="14805"/>14805: 
<a name="14806"/>14806: 
<a name="14807"/>14807: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="14808"/>14808: 
<a name="14809"/>14809: <i>%% Tests the socket option domain.</i>
<a name="14810"/>14810: <i>%% This is a read only option. Also not available on all platforms.</i>
<a name="14811"/>14811: 
<a name="api_opt_sock_domain-1"/><a name="14812"/>14812: <b>api_opt_sock_domain</b>(_Config) when is_list(_Config) -&gt;
<a name="14813"/>14813:     ?TT(?SECS(10)),
<a name="api_opt_sock_domain-last_expr"/><a name="14814"/>14814: <b>    tc_try</b>(api_opt_sock_domain,
<a name="14815"/>14815:            fun() -&gt; has_support_sock_domain() end,
<a name="14816"/>14816:            fun() -&gt; api_opt_sock_domain() end).
<a name="14817"/>14817: 
<a name="14818"/>14818: 
<a name="api_opt_sock_domain-0"/><a name="14819"/>14819: <b>api_opt_sock_domain</b>() -&gt;
<a name="14820"/>14820:     Opt = domain,
<a name="14821"/>14821:     Get = fun(S) -&gt;
<a name="14822"/>14822:                   socket:getopt(S, socket, Opt)
<a name="14823"/>14823:           end,
<a name="14824"/>14824: 
<a name="14825"/>14825:     TesterSeq =
<a name="14826"/>14826:         [
<a name="14827"/>14827:          #{desc =&gt; &quot;which local address&quot;,
<a name="14828"/>14828:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="14829"/>14829:                            case which_local_host_info(Domain) of
<a name="14830"/>14830:                                {ok, #{name := Name,
<a name="14831"/>14831:                                       addr := Addr}} -&gt;
<a name="14832"/>14832:                                    ?SEV_IPRINT(&quot;local host info: &quot;
<a name="14833"/>14833:                                                &quot;~n   Name: ~p&quot;
<a name="14834"/>14834:                                                &quot;~n   Addr: ~p&quot;,
<a name="14835"/>14835:                                                [Name, Addr]),
<a name="14836"/>14836:                                    LSA = #{family =&gt; Domain,
<a name="14837"/>14837:                                            addr   =&gt; Addr},
<a name="14838"/>14838:                                    {ok, State#{lsa =&gt; LSA}};
<a name="14839"/>14839:                                {error, _} = ERROR -&gt;
<a name="14840"/>14840:                                    ERROR
<a name="14841"/>14841:                            end
<a name="14842"/>14842:                    end},
<a name="14843"/>14843: 
<a name="14844"/>14844:          #{desc =&gt; &quot;create IPv4 UDP socket&quot;,
<a name="14845"/>14845:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="14846"/>14846:                            case socket:open(Domain, dgram, udp) of
<a name="14847"/>14847:                                {ok, Sock} -&gt;
<a name="14848"/>14848:                                    {ok, State#{usock =&gt; Sock}};
<a name="14849"/>14849:                                {error, _} = ERROR -&gt;
<a name="14850"/>14850:                                    ERROR
<a name="14851"/>14851:                            end
<a name="14852"/>14852:                    end},
<a name="14853"/>14853:          #{desc =&gt; &quot;Get domain for the UDP socket&quot;,
<a name="14854"/>14854:            cmd  =&gt; fun(#{domain := Domain, usock := Sock} = _State) -&gt;
<a name="14855"/>14855:                            case Get(Sock) of
<a name="14856"/>14856:                                {ok, Domain} -&gt;
<a name="14857"/>14857:                                    ?SEV_IPRINT(&quot;Success: ~p&quot;, [Domain]),
<a name="14858"/>14858:                                    ok;
<a name="14859"/>14859:                                {error, Reason} = ERROR -&gt;
<a name="14860"/>14860:                                    ?SEV_EPRINT(&quot;Unexpected failure: ~p&quot;,
<a name="14861"/>14861:                                                [Reason]),
<a name="14862"/>14862:                                    ERROR
<a name="14863"/>14863:                            end
<a name="14864"/>14864:                    end},
<a name="14865"/>14865:          #{desc =&gt; &quot;create TCP socket&quot;,
<a name="14866"/>14866:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="14867"/>14867:                            case socket:open(Domain, stream, tcp) of
<a name="14868"/>14868:                                {ok, Sock} -&gt;
<a name="14869"/>14869:                                    {ok, State#{tsock =&gt; Sock}};
<a name="14870"/>14870:                                {error, _} = ERROR -&gt;
<a name="14871"/>14871:                                    ERROR
<a name="14872"/>14872:                            end
<a name="14873"/>14873:                    end},
<a name="14874"/>14874:          #{desc =&gt; &quot;Get domain for the TCP socket&quot;,
<a name="14875"/>14875:            cmd  =&gt; fun(#{domain := Domain, tsock := Sock} = _State) -&gt;
<a name="14876"/>14876:                            case Get(Sock) of
<a name="14877"/>14877:                                {ok, Domain} -&gt;
<a name="14878"/>14878:                                    ?SEV_IPRINT(&quot;Success: ~p&quot;, [Domain]),
<a name="14879"/>14879:                                    ok;
<a name="14880"/>14880:                                {error, Reason} = ERROR -&gt;
<a name="14881"/>14881:                                    ?SEV_EPRINT(&quot;Unexpected failure: ~p&quot;,
<a name="14882"/>14882:                                                [Reason]),
<a name="14883"/>14883:                                    ERROR
<a name="14884"/>14884:                            end
<a name="14885"/>14885:                    end},
<a name="14886"/>14886: 
<a name="14887"/>14887:          %% *** Termination ***
<a name="14888"/>14888:          #{desc =&gt; &quot;close UDP socket&quot;,
<a name="14889"/>14889:            cmd  =&gt; fun(#{usock := Sock} = State0) -&gt;
<a name="14890"/>14890:                            socket:close(Sock),
<a name="14891"/>14891: 			   State1 = maps:remove(usock, State0),
<a name="14892"/>14892:                            {ok, State1}
<a name="14893"/>14893:                    end},
<a name="14894"/>14894:          #{desc =&gt; &quot;close TCP socket&quot;,
<a name="14895"/>14895:            cmd  =&gt; fun(#{tsock := Sock} = State0) -&gt;
<a name="14896"/>14896:                            socket:close(Sock),
<a name="14897"/>14897: 			   State1 = maps:remove(tsock, State0),
<a name="14898"/>14898:                            {ok, State1}
<a name="14899"/>14899:                    end},
<a name="14900"/>14900: 
<a name="14901"/>14901:          %% *** We are done ***
<a name="14902"/>14902:          ?SEV_FINISH_NORMAL
<a name="14903"/>14903:         ],
<a name="14904"/>14904: 
<a name="14905"/>14905:     Domain = inet_or_inet6(),
<a name="14906"/>14906: 
<a name="14907"/>14907:     i(&quot;start tester evaluator&quot;),
<a name="14908"/>14908:     InitState = #{domain =&gt; Domain},
<a name="14909"/>14909:     Tester = ?SEV_START(&quot;tester&quot;, TesterSeq, InitState),
<a name="14910"/>14910: 
<a name="14911"/>14911:     i(&quot;await evaluator(s)&quot;),
<a name="api_opt_sock_domain-last_expr"/><a name="14912"/>14912: <b>    ok = ?SEV_AWAIT_FINISH</b>([Tester]).
<a name="14913"/>14913: 
<a name="14914"/>14914: 
<a name="14915"/>14915: 
<a name="14916"/>14916: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="14917"/>14917: 
<a name="14918"/>14918: <i>%% Tests the socket option dontroute.</i>
<a name="14919"/>14919: <i>%% The man page has the following to say:</i>
<a name="14920"/>14920: <i>%% &quot;Don't send via a gateway, send only to directly connected hosts.</i>
<a name="14921"/>14921: <i>%%  The same effect can be achieved by setting the MSG_DONTROUTE</i>
<a name="14922"/>14922: <i>%%  flag on a socket send(2) operation.&quot;</i>
<a name="14923"/>14923: <i>%% Since its &quot;kind of&quot; difficult to check if it actually takes an </i>
<a name="14924"/>14924: <i>%% effect (you would need a gateway for that and a machine &quot;on the</i>
<a name="14925"/>14925: <i>%% other side&quot;), we only test if we can set and get the value.</i>
<a name="14926"/>14926: <i>%% Better then nothing.</i>
<a name="14927"/>14927: 
<a name="api_opt_sock_dontroute-1"/><a name="14928"/>14928: <b>api_opt_sock_dontroute</b>(_Config) when is_list(_Config) -&gt;
<a name="14929"/>14929:     ?TT(?SECS(10)),
<a name="api_opt_sock_dontroute-last_expr"/><a name="14930"/>14930: <b>    tc_try</b>(api_opt_sock_dontroute,
<a name="14931"/>14931:            fun() -&gt; has_support_sock_dontroute() end,
<a name="14932"/>14932:            fun() -&gt; api_opt_sock_dontroute() end).
<a name="14933"/>14933: 
<a name="14934"/>14934: 
<a name="api_opt_sock_dontroute-0"/><a name="14935"/>14935: <b>api_opt_sock_dontroute</b>() -&gt;
<a name="14936"/>14936:     Opt    = dontroute,
<a name="14937"/>14937:     Set    = fun(S, Val) when is_boolean(Val) -&gt;
<a name="14938"/>14938:                      socket:setopt(S, socket, Opt, Val)
<a name="14939"/>14939:              end,
<a name="14940"/>14940:     Get    = fun(S) -&gt;
<a name="14941"/>14941:                      socket:getopt(S, socket, Opt)
<a name="14942"/>14942:              end,
<a name="14943"/>14943: 
<a name="14944"/>14944:     TesterSeq =
<a name="14945"/>14945:         [
<a name="14946"/>14946:          #{desc =&gt; &quot;which local address&quot;,
<a name="14947"/>14947:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="14948"/>14948:                            case which_local_host_info(Domain) of
<a name="14949"/>14949:                                {ok, #{name := Name,
<a name="14950"/>14950:                                       addr := Addr}} -&gt;
<a name="14951"/>14951:                                    ?SEV_IPRINT(&quot;local host info: &quot;
<a name="14952"/>14952:                                                &quot;~n   Name: ~p&quot;
<a name="14953"/>14953:                                                &quot;~n   Addr: ~p&quot;,
<a name="14954"/>14954:                                                [Name, Addr]),
<a name="14955"/>14955:                                    LSA = #{family =&gt; Domain,
<a name="14956"/>14956:                                            addr   =&gt; Addr},
<a name="14957"/>14957:                                    {ok, State#{lsa =&gt; LSA}};
<a name="14958"/>14958:                                {error, _} = ERROR -&gt;
<a name="14959"/>14959:                                    ERROR
<a name="14960"/>14960:                            end
<a name="14961"/>14961:                    end},
<a name="14962"/>14962: 
<a name="14963"/>14963:          #{desc =&gt; &quot;create UDP socket&quot;,
<a name="14964"/>14964:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="14965"/>14965:                            case socket:open(Domain, dgram, udp) of
<a name="14966"/>14966:                                {ok, Sock} -&gt;
<a name="14967"/>14967:                                    {ok, State#{sock =&gt; Sock}};
<a name="14968"/>14968:                                {error, _} = ERROR -&gt;
<a name="14969"/>14969:                                    ERROR
<a name="14970"/>14970:                            end
<a name="14971"/>14971:                    end},
<a name="14972"/>14972:          #{desc =&gt; &quot;Get current value&quot;,
<a name="14973"/>14973:            cmd  =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="14974"/>14974:                            case Get(Sock) of
<a name="14975"/>14975:                                {ok, Val} when is_boolean(Val) -&gt;
<a name="14976"/>14976:                                    ?SEV_IPRINT(&quot;Success: ~p&quot;, [Val]),
<a name="14977"/>14977:                                    {ok, State#{dontroute =&gt; Val}};
<a name="14978"/>14978:                                {error, Reason} = ERROR -&gt;
<a name="14979"/>14979:                                    ?SEV_EPRINT(&quot;Unexpected failure: ~p&quot;,
<a name="14980"/>14980:                                                [Reason]),
<a name="14981"/>14981:                                    ERROR
<a name="14982"/>14982:                            end
<a name="14983"/>14983:                    end},
<a name="14984"/>14984:          #{desc =&gt; &quot;Try change value&quot;,
<a name="14985"/>14985:            cmd  =&gt; fun(#{sock := Sock, dontroute := Current} = State) -&gt;
<a name="14986"/>14986: 			   New = not Current,
<a name="14987"/>14987:                            ?SEV_IPRINT(&quot;Change from ~p to ~p&quot;, [Current, New]),
<a name="14988"/>14988:                            case Set(Sock, New) of
<a name="14989"/>14989:                                ok -&gt;
<a name="14990"/>14990:                                    ?SEV_IPRINT(&quot;Expected Success&quot;),
<a name="14991"/>14991:                                    {ok, State#{dontroute =&gt; New}};
<a name="14992"/>14992:                                {error, eopnotsupp = Reason} -&gt;
<a name="14993"/>14993:                                    ?SEV_EPRINT(&quot;Expected Failure: ~p&quot;,
<a name="14994"/>14994: 					       [Reason]),
<a name="14995"/>14995:                                    {skip, Reason};
<a name="14996"/>14996:                                {error, Reason} = ERROR -&gt;
<a name="14997"/>14997:                                    ?SEV_EPRINT(&quot;Unexpected Failure: ~p&quot;,
<a name="14998"/>14998: 					       [Reason]),
<a name="14999"/>14999:                                    ERROR
<a name="15000"/>15000:                            end
<a name="15001"/>15001:                    end},
<a name="15002"/>15002:          #{desc =&gt; &quot;Verify changed value&quot;,
<a name="15003"/>15003:            cmd  =&gt; fun(#{sock := Sock, dontroute := Val} = _State) -&gt;
<a name="15004"/>15004:                            case Get(Sock) of
<a name="15005"/>15005:                                {ok, Val} -&gt;
<a name="15006"/>15006:                                    ?SEV_IPRINT(&quot;Expected Success&quot;),
<a name="15007"/>15007:                                    ok;
<a name="15008"/>15008:                                {error, Reason} = ERROR -&gt;
<a name="15009"/>15009:                                    ?SEV_EPRINT(&quot;Unexpected failure: ~p&quot;,
<a name="15010"/>15010:                                                [Reason]),
<a name="15011"/>15011:                                    ERROR
<a name="15012"/>15012:                            end
<a name="15013"/>15013:                    end},
<a name="15014"/>15014: 
<a name="15015"/>15015:          %% *** Termination ***
<a name="15016"/>15016:          #{desc =&gt; &quot;close UDP socket&quot;,
<a name="15017"/>15017:            cmd  =&gt; fun(#{sock := Sock} = State0) -&gt;
<a name="15018"/>15018:                            socket:close(Sock),
<a name="15019"/>15019: 			   State1 = maps:remove(sock, State0),
<a name="15020"/>15020:                            {ok, State1}
<a name="15021"/>15021:                    end},
<a name="15022"/>15022: 
<a name="15023"/>15023:          %% *** We are done ***
<a name="15024"/>15024:          ?SEV_FINISH_NORMAL
<a name="15025"/>15025:         ],
<a name="15026"/>15026: 
<a name="15027"/>15027:     Domain = inet_or_inet6(),
<a name="15028"/>15028: 
<a name="15029"/>15029:     i(&quot;start tester evaluator&quot;),
<a name="15030"/>15030:     InitState = #{domain =&gt; Domain},
<a name="15031"/>15031:     Tester = ?SEV_START(&quot;tester&quot;, TesterSeq, InitState),
<a name="15032"/>15032: 
<a name="15033"/>15033:     i(&quot;await evaluator(s)&quot;),
<a name="api_opt_sock_dontroute-last_expr"/><a name="15034"/>15034: <b>    ok = ?SEV_AWAIT_FINISH</b>([Tester]).
<a name="15035"/>15035: 
<a name="15036"/>15036: 
<a name="15037"/>15037: 
<a name="15038"/>15038: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="15039"/>15039: 
<a name="15040"/>15040: <i>%% Tests the socket option error. PLACEHOLDER!</i>
<a name="15041"/>15041: 
<a name="api_opt_sock_error-1"/><a name="15042"/>15042: <b>api_opt_sock_error</b>(_Config) when is_list(_Config) -&gt;
<a name="15043"/>15043:     ?TT(?SECS(10)),
<a name="api_opt_sock_error-last_expr"/><a name="15044"/>15044: <b>    tc_try</b>(api_opt_sock_error,
<a name="15045"/>15045:            fun() -&gt; not_yet_implemented() end,
<a name="15046"/>15046:            fun() -&gt; ok end).
<a name="15047"/>15047: 
<a name="15048"/>15048: 
<a name="15049"/>15049: 
<a name="15050"/>15050: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="15051"/>15051: 
<a name="15052"/>15052: <i>%% Tests the socket option keepalive.</i>
<a name="15053"/>15053: <i>%% This is bit tricky to test, partly because we have no control over</i>
<a name="15054"/>15054: <i>%% the underlying TCP timeouts. So, for now, we just test that we can</i>
<a name="15055"/>15055: <i>%% change the value.</i>
<a name="15056"/>15056: 
<a name="api_opt_sock_keepalive-1"/><a name="15057"/>15057: <b>api_opt_sock_keepalive</b>(_Config) when is_list(_Config) -&gt;
<a name="15058"/>15058:     ?TT(?SECS(10)),
<a name="api_opt_sock_keepalive-last_expr"/><a name="15059"/>15059: <b>    tc_try</b>(api_opt_sock_keepalive,
<a name="15060"/>15060:            fun() -&gt; has_support_sock_keepalive() end,
<a name="15061"/>15061:            fun() -&gt; api_opt_sock_keepalive() end).
<a name="15062"/>15062: 
<a name="15063"/>15063: 
<a name="api_opt_sock_keepalive-0"/><a name="15064"/>15064: <b>api_opt_sock_keepalive</b>() -&gt;
<a name="15065"/>15065:     Opt    = keepalive,
<a name="15066"/>15066:     Set    = fun(S, Val) when is_boolean(Val) -&gt;
<a name="15067"/>15067:                      socket:setopt(S, socket, Opt, Val)
<a name="15068"/>15068:              end,
<a name="15069"/>15069:     Get    = fun(S) -&gt;
<a name="15070"/>15070:                      socket:getopt(S, socket, Opt)
<a name="15071"/>15071:              end,
<a name="15072"/>15072: 
<a name="15073"/>15073:     TesterSeq =
<a name="15074"/>15074:         [
<a name="15075"/>15075:          #{desc =&gt; &quot;which local address&quot;,
<a name="15076"/>15076:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="15077"/>15077:                            case which_local_host_info(Domain) of
<a name="15078"/>15078:                                {ok, #{name      := Name,
<a name="15079"/>15079:                                       addr      := Addr}} -&gt;
<a name="15080"/>15080:                                    ?SEV_IPRINT(&quot;local host info: &quot;
<a name="15081"/>15081:                                                &quot;~n   Name: ~p&quot;
<a name="15082"/>15082:                                                &quot;~n   Addr: ~p&quot;,
<a name="15083"/>15083:                                                [Name, Addr]),
<a name="15084"/>15084:                                    LSA = #{family =&gt; Domain,
<a name="15085"/>15085:                                            addr   =&gt; Addr},
<a name="15086"/>15086:                                    {ok, State#{lsa =&gt; LSA}};
<a name="15087"/>15087:                                {error, _} = ERROR -&gt;
<a name="15088"/>15088:                                    ERROR
<a name="15089"/>15089:                            end
<a name="15090"/>15090:                    end},
<a name="15091"/>15091: 
<a name="15092"/>15092:          #{desc =&gt; &quot;create TCP socket&quot;,
<a name="15093"/>15093:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="15094"/>15094:                            case socket:open(Domain, stream, tcp) of
<a name="15095"/>15095:                                {ok, Sock} -&gt;
<a name="15096"/>15096:                                    {ok, State#{sock =&gt; Sock}};
<a name="15097"/>15097:                                {error, _} = ERROR -&gt;
<a name="15098"/>15098:                                    ERROR
<a name="15099"/>15099:                            end
<a name="15100"/>15100:                    end},
<a name="15101"/>15101:          #{desc =&gt; &quot;Get current value&quot;,
<a name="15102"/>15102:            cmd  =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="15103"/>15103:                            case Get(Sock) of
<a name="15104"/>15104:                                {ok, Val} when is_boolean(Val) -&gt;
<a name="15105"/>15105:                                    ?SEV_IPRINT(&quot;Success: ~p&quot;, [Val]),
<a name="15106"/>15106:                                    {ok, State#{keepalive =&gt; Val}};
<a name="15107"/>15107:                                {error, Reason} = ERROR -&gt;
<a name="15108"/>15108:                                    ?SEV_EPRINT(&quot;Unexpected failure: ~p&quot;,
<a name="15109"/>15109:                                                [Reason]),
<a name="15110"/>15110:                                    ERROR
<a name="15111"/>15111:                            end
<a name="15112"/>15112:                    end},
<a name="15113"/>15113:          #{desc =&gt; &quot;Try change the value&quot;,
<a name="15114"/>15114:            cmd  =&gt; fun(#{sock := Sock, keepalive := Current} = State) -&gt;
<a name="15115"/>15115: 			   New = not Current,
<a name="15116"/>15116:                            ?SEV_IPRINT(&quot;Try change value from ~p to ~p&quot;, 
<a name="15117"/>15117:                                        [Current, New]),
<a name="15118"/>15118:                            case Set(Sock, New) of
<a name="15119"/>15119:                                ok -&gt;
<a name="15120"/>15120:                                    ?SEV_IPRINT(&quot;Expected Success&quot;),
<a name="15121"/>15121:                                    {ok, State#{keepalive =&gt; New}};
<a name="15122"/>15122:                                {error, Reason} = ERROR -&gt;
<a name="15123"/>15123:                                    ?SEV_EPRINT(&quot;Unexpected Failure: ~p&quot;,
<a name="15124"/>15124: 					       [Reason]),
<a name="15125"/>15125:                                    ERROR
<a name="15126"/>15126:                            end
<a name="15127"/>15127:                    end},
<a name="15128"/>15128:          #{desc =&gt; &quot;Verify (new) current value&quot;,
<a name="15129"/>15129:            cmd  =&gt; fun(#{sock := Sock, keepalive := Val} = _State) -&gt;
<a name="15130"/>15130:                            case Get(Sock) of
<a name="15131"/>15131:                                {ok, Val} -&gt;
<a name="15132"/>15132:                                    ?SEV_IPRINT(&quot;Expected Success (~p)&quot;, [Val]),
<a name="15133"/>15133:                                    ok;
<a name="15134"/>15134:                                {ok, OtherVal} -&gt;
<a name="15135"/>15135:                                    ?SEV_IPRINT(&quot;Unexpected Success: ~p&quot;,
<a name="15136"/>15136:                                                [OtherVal]),
<a name="15137"/>15137:                                    {error, {unexpected_success_value,
<a name="15138"/>15138:                                             Val, OtherVal}};
<a name="15139"/>15139:                                {error, Reason} = ERROR -&gt;
<a name="15140"/>15140:                                    ?SEV_EPRINT(&quot;Unexpected failure: ~p&quot;,
<a name="15141"/>15141:                                                [Reason]),
<a name="15142"/>15142:                                    ERROR
<a name="15143"/>15143:                            end
<a name="15144"/>15144:                    end},
<a name="15145"/>15145: 
<a name="15146"/>15146:          %% *** Termination ***
<a name="15147"/>15147:          #{desc =&gt; &quot;close UDP socket&quot;,
<a name="15148"/>15148:            cmd  =&gt; fun(#{sock := Sock} = State0) -&gt;
<a name="15149"/>15149:                            socket:close(Sock),
<a name="15150"/>15150: 			   State1 = maps:remove(sock, State0),
<a name="15151"/>15151:                            {ok, State1}
<a name="15152"/>15152:                    end},
<a name="15153"/>15153: 
<a name="15154"/>15154:          %% *** We are done ***
<a name="15155"/>15155:          ?SEV_FINISH_NORMAL
<a name="15156"/>15156:         ],
<a name="15157"/>15157: 
<a name="15158"/>15158:     Domain = inet_or_inet6(),
<a name="15159"/>15159: 
<a name="15160"/>15160:     i(&quot;start tester evaluator&quot;),
<a name="15161"/>15161:     InitState = #{domain =&gt; Domain},
<a name="15162"/>15162:     Tester = ?SEV_START(&quot;tester&quot;, TesterSeq, InitState),
<a name="15163"/>15163: 
<a name="15164"/>15164:     i(&quot;await evaluator(s)&quot;),
<a name="api_opt_sock_keepalive-last_expr"/><a name="15165"/>15165: <b>    ok = ?SEV_AWAIT_FINISH</b>([Tester]).
<a name="15166"/>15166: 
<a name="15167"/>15167: 
<a name="15168"/>15168: 
<a name="15169"/>15169: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="15170"/>15170: 
<a name="15171"/>15171: <i>%% Tests the socket option reuseaddr.</i>
<a name="15172"/>15172: <i>%% This is the most basic of tests. We only test that we can set the</i>
<a name="15173"/>15173: <i>%% option and then read back.</i>
<a name="15174"/>15174: 
<a name="api_opt_sock_reuseaddr-1"/><a name="15175"/>15175: <b>api_opt_sock_reuseaddr</b>(_Config) when is_list(_Config) -&gt;
<a name="15176"/>15176:     ?TT(?SECS(10)),
<a name="api_opt_sock_reuseaddr-last_expr"/><a name="15177"/>15177: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="15178"/>15178:            fun() -&gt;
<a name="15179"/>15179:                    %% [IPv4] Nothing to do with the option,
<a name="15180"/>15180:                    %% [IPv4] but we use it the test so make
<a name="15181"/>15181:                    %% [IPv4] use we have it.
<a name="15182"/>15182:                    has_support_ipv4(),
<a name="15183"/>15183:                    has_support_sock_reuseaddr()
<a name="15184"/>15184:            end,
<a name="15185"/>15185:            fun() -&gt; api_opt_sock_reuseaddr() end).
<a name="15186"/>15186: 
<a name="15187"/>15187: 
<a name="api_opt_sock_reuseaddr-0"/><a name="15188"/>15188: <b>api_opt_sock_reuseaddr</b>() -&gt;
<a name="api_opt_sock_reuseaddr-last_expr"/><a name="15189"/>15189: <b>    api_opt_simple_bool</b>(inet, socket, stream, reuseaddr,
<a name="15190"/>15190:                        #{bind =&gt; false}).
<a name="15191"/>15191: 
<a name="15192"/>15192: 
<a name="15193"/>15193: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="15194"/>15194: 
<a name="15195"/>15195: <i>%% Tests the socket option exclusiveaddruse.</i>
<a name="15196"/>15196: <i>%% This is the most basic of tests. We only test that we can set the</i>
<a name="15197"/>15197: <i>%% option and then read back.</i>
<a name="15198"/>15198: 
<a name="api_opt_sock_exclusiveaddruse-1"/><a name="15199"/>15199: <b>api_opt_sock_exclusiveaddruse</b>(_Config) when is_list(_Config) -&gt;
<a name="15200"/>15200:     ?TT(?SECS(10)),
<a name="api_opt_sock_exclusiveaddruse-last_expr"/><a name="15201"/>15201: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="15202"/>15202:            fun() -&gt;
<a name="15203"/>15203:                    %% [IPv4] Nothing to do with the option,
<a name="15204"/>15204:                    %% [IPv4] but we use it the test so make
<a name="15205"/>15205:                    %% [IPv4] use we have it.
<a name="15206"/>15206:                    has_support_ipv4(),
<a name="15207"/>15207:                    has_support_sock_exclusiveaddruse()
<a name="15208"/>15208:            end,
<a name="15209"/>15209:            fun() -&gt; api_opt_sock_exclusiveaddruse() end).
<a name="15210"/>15210: 
<a name="15211"/>15211: 
<a name="api_opt_sock_exclusiveaddruse-0"/><a name="15212"/>15212: <b>api_opt_sock_exclusiveaddruse</b>() -&gt;
<a name="api_opt_sock_exclusiveaddruse-last_expr"/><a name="15213"/>15213: <b>    api_opt_simple_bool</b>(inet, socket, stream, exclusiveaddruse,
<a name="15214"/>15214: 			#{bind =&gt; false}).
<a name="15215"/>15215: 
<a name="15216"/>15216: 
<a name="15217"/>15217: 
<a name="15218"/>15218: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="15219"/>15219: 
<a name="15220"/>15220: <i>%% *Simple* test for a bool option.</i>
<a name="15221"/>15221: <i>%% This basically just tests that we can set and get the option.</i>
<a name="15222"/>15222: <i>%% This assumes that the option is supported.</i>
<a name="15223"/>15223: <i>%% What if its required that the socket is bound before set/get?</i>
<a name="15224"/>15224: <i>%% What if its required that set/get is done before bind?</i>
<a name="15225"/>15225: 
<a name="api_opt_simple_bool-5"/><a name="15226"/>15226: <b>api_opt_simple_bool</b>(Domain, Level, Type, Option, InitState) -&gt;
<a name="15227"/>15227: 
<a name="15228"/>15228:     Set    = fun(S, Val) when is_boolean(Val) -&gt;
<a name="15229"/>15229:                      socket:setopt(S, Level, Option, Val)
<a name="15230"/>15230:              end,
<a name="15231"/>15231:     Get    = fun(S) -&gt;
<a name="15232"/>15232:                      socket:getopt(S, Level, Option)
<a name="15233"/>15233:              end,
<a name="15234"/>15234: 
<a name="15235"/>15235:     TesterSeq =
<a name="15236"/>15236:         [
<a name="15237"/>15237:          #{desc =&gt; &quot;(maybe) which local address&quot;,
<a name="15238"/>15238:            cmd  =&gt; fun(#{bind := true} = State) -&gt;
<a name="15239"/>15239:                            case ?LIB:which_local_host_info(Domain) of
<a name="15240"/>15240:                                {ok, #{name      := Name,
<a name="15241"/>15241:                                       addr      := Addr}} -&gt;
<a name="15242"/>15242:                                    ?SEV_IPRINT(&quot;local host info: &quot;
<a name="15243"/>15243:                                                &quot;~n   Name: ~p&quot;
<a name="15244"/>15244:                                                &quot;~n   Addr: ~p&quot;,
<a name="15245"/>15245:                                                [Name, Addr]),
<a name="15246"/>15246:                                    LSA = #{family =&gt; Domain,
<a name="15247"/>15247:                                            addr   =&gt; Addr},
<a name="15248"/>15248:                                    {ok, State#{lsa =&gt; LSA}};
<a name="15249"/>15249:                                {error, _} = ERROR -&gt;
<a name="15250"/>15250:                                    ERROR
<a name="15251"/>15251:                            end;
<a name="15252"/>15252:                       (_State) -&gt;
<a name="15253"/>15253:                            ?SEV_IPRINT(&quot;ignore get local address&quot;),
<a name="15254"/>15254:                            ok
<a name="15255"/>15255:                    end},
<a name="15256"/>15256: 
<a name="15257"/>15257:          #{desc =&gt; &quot;create socket&quot;,
<a name="15258"/>15258:            cmd  =&gt; fun(State) -&gt;
<a name="15259"/>15259:                            case socket:open(Domain, Type) of
<a name="15260"/>15260:                                {ok, Sock} -&gt;
<a name="15261"/>15261:                                    {ok, State#{sock =&gt; Sock}};
<a name="15262"/>15262:                                {error, _} = ERROR -&gt;
<a name="15263"/>15263:                                    ERROR
<a name="15264"/>15264:                            end
<a name="15265"/>15265:                    end},
<a name="15266"/>15266: 
<a name="15267"/>15267:          #{desc =&gt; &quot;(maybe) bind&quot;,
<a name="15268"/>15268:            cmd  =&gt; fun(#{bind := true, lsa := LSA, sock := Sock} = _State) -&gt;
<a name="15269"/>15269:                            ?SEV_IPRINT(&quot;try binding&quot;),
<a name="15270"/>15270:                            socket:bind(Sock, LSA);
<a name="15271"/>15271:                       (_State) -&gt;
<a name="15272"/>15272:                            ?SEV_IPRINT(&quot;ignore binding&quot;),
<a name="15273"/>15273:                            ok
<a name="15274"/>15274:                    end},
<a name="15275"/>15275: 
<a name="15276"/>15276:          #{desc =&gt; &quot;Get current value&quot;,
<a name="15277"/>15277:            cmd  =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="15278"/>15278:                            case Get(Sock) of
<a name="15279"/>15279:                                {ok, Val} when is_boolean(Val) -&gt;
<a name="15280"/>15280:                                    ?SEV_IPRINT(&quot;Success: ~p&quot;, [Val]),
<a name="15281"/>15281:                                    {ok, State#{Option =&gt; Val}};
<a name="15282"/>15282:                                {error, Reason} = ERROR -&gt;
<a name="15283"/>15283:                                    ?SEV_EPRINT(&quot;Unexpected failure: ~p&quot;,
<a name="15284"/>15284:                                                [Reason]),
<a name="15285"/>15285:                                    ERROR
<a name="15286"/>15286:                            end
<a name="15287"/>15287:                    end},
<a name="15288"/>15288:          #{desc =&gt; &quot;Try change the value&quot;,
<a name="15289"/>15289:            cmd  =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="15290"/>15290:                            Current = maps:get(Option, State),
<a name="15291"/>15291: 			   New     = not Current,
<a name="15292"/>15292:                            ?SEV_IPRINT(&quot;Try change value from ~p to ~p&quot;, 
<a name="15293"/>15293:                                        [Current, New]),
<a name="15294"/>15294:                            case Set(Sock, New) of
<a name="15295"/>15295:                                ok -&gt;
<a name="15296"/>15296:                                    ?SEV_IPRINT(&quot;Expected Success&quot;),
<a name="15297"/>15297:                                    {ok, State#{Option =&gt; New}};
<a name="15298"/>15298:                                {error, Reason} = ERROR -&gt;
<a name="15299"/>15299:                                    ?SEV_EPRINT(&quot;Unexpected Failure: ~p&quot;,
<a name="15300"/>15300: 					       [Reason]),
<a name="15301"/>15301:                                    ERROR
<a name="15302"/>15302:                            end
<a name="15303"/>15303:                    end},
<a name="15304"/>15304:          #{desc =&gt; &quot;Verify (new) current value&quot;,
<a name="15305"/>15305:            cmd  =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="15306"/>15306:                            Val = maps:get(Option, State),
<a name="15307"/>15307:                            case Get(Sock) of
<a name="15308"/>15308:                                {ok, Val} -&gt;
<a name="15309"/>15309:                                    ?SEV_IPRINT(&quot;Expected Success (~p)&quot;, [Val]),
<a name="15310"/>15310:                                    ok;
<a name="15311"/>15311:                                {ok, OtherVal} -&gt;
<a name="15312"/>15312:                                    ?SEV_IPRINT(&quot;Unexpected Success: ~p&quot;,
<a name="15313"/>15313:                                                [OtherVal]),
<a name="15314"/>15314:                                    {error, {unexpected_success_value,
<a name="15315"/>15315:                                             Val, OtherVal}};
<a name="15316"/>15316:                                {error, Reason} = ERROR -&gt;
<a name="15317"/>15317:                                    ?SEV_EPRINT(&quot;Unexpected failure: ~p&quot;,
<a name="15318"/>15318:                                                [Reason]),
<a name="15319"/>15319:                                    ERROR
<a name="15320"/>15320:                            end
<a name="15321"/>15321:                    end},
<a name="15322"/>15322: 
<a name="15323"/>15323:          %% *** Termination ***
<a name="15324"/>15324:          #{desc =&gt; &quot;close socket&quot;,
<a name="15325"/>15325:            cmd  =&gt; fun(#{sock := Sock} = State0) -&gt;
<a name="15326"/>15326:                            socket:close(Sock),
<a name="15327"/>15327: 			   State1 = maps:remove(sock, State0),
<a name="15328"/>15328:                            {ok, State1}
<a name="15329"/>15329:                    end},
<a name="15330"/>15330: 
<a name="15331"/>15331:          %% *** We are done ***
<a name="15332"/>15332:          ?SEV_FINISH_NORMAL
<a name="15333"/>15333:         ],
<a name="15334"/>15334: 
<a name="15335"/>15335:     i(&quot;start tester evaluator&quot;),
<a name="15336"/>15336:     Tester = ?SEV_START(&quot;tester&quot;, TesterSeq, InitState),
<a name="15337"/>15337: 
<a name="15338"/>15338:     i(&quot;await evaluator(s)&quot;),
<a name="api_opt_simple_bool-last_expr"/><a name="15339"/>15339: <b>    ok = ?SEV_AWAIT_FINISH</b>([Tester]).
<a name="15340"/>15340: 
<a name="15341"/>15341: 
<a name="15342"/>15342: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="15343"/>15343: 
<a name="15344"/>15344: <i>%% Tests the socket option bsp_state.</i>
<a name="15345"/>15345: <i>%% This is the most basic of tests. We test that we can,</i>
<a name="15346"/>15346: <i>%% create sockets, bind and connect and extract bsp-state</i>
<a name="15347"/>15347: <i>%% in the various state(s) of the socket.</i>
<a name="15348"/>15348: <i>%% For both dgram and stream sockets.</i>
<a name="15349"/>15349: 
<a name="api_opt_sock_bsp_state-1"/><a name="15350"/>15350: <b>api_opt_sock_bsp_state</b>(_Config) when is_list(_Config) -&gt;
<a name="15351"/>15351:     ?TT(?SECS(10)),
<a name="api_opt_sock_bsp_state-last_expr"/><a name="15352"/>15352: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="15353"/>15353:            fun() -&gt;
<a name="15354"/>15354: 		   %% This is not a 'IPv4' option,
<a name="15355"/>15355: 		   %% but since we used it in the test...
<a name="15356"/>15356:                    has_support_ipv4(),
<a name="15357"/>15357:                    has_support_sock_bsp_state()
<a name="15358"/>15358:            end,
<a name="15359"/>15359:            fun() -&gt; api_opt_sock_bsp_state() end).
<a name="15360"/>15360: 
<a name="15361"/>15361: 
<a name="api_opt_sock_bsp_state-0"/><a name="15362"/>15362: <b>api_opt_sock_bsp_state</b>() -&gt;
<a name="15363"/>15363:     LSA        = which_local_socket_addr(inet),
<a name="15364"/>15364:     BspState   = fun(S) -&gt;
<a name="15365"/>15365: 			 case socket:getopt(S, socket, bsp_state) of
<a name="15366"/>15366: 			     {ok, BS} -&gt;
<a name="15367"/>15367: 				 BS;
<a name="15368"/>15368: 			     {error, Reason} -&gt;
<a name="15369"/>15369: 				 ?FAIL({getopt_bsp_state, Reason})
<a name="15370"/>15370: 			 end
<a name="15371"/>15371: 		 end,
<a name="15372"/>15372:     CreateSock = fun(T, P) -&gt;
<a name="15373"/>15373: 			 case socket:open(inet, T, P) of
<a name="15374"/>15374: 			     {ok, Sock}      -&gt;
<a name="15375"/>15375: 				 Sock;
<a name="15376"/>15376: 			     {error, Reason} -&gt;
<a name="15377"/>15377: 				 skip({socket_create_fail, Reason})
<a name="15378"/>15378: 			 end
<a name="15379"/>15379: 		 end,
<a name="15380"/>15380:     CloseSock = fun(S) -&gt;
<a name="15381"/>15381: 			socket:close(S)
<a name="15382"/>15382: 		end,
<a name="15383"/>15383:     BindSock   = fun(S, SA) -&gt;
<a name="15384"/>15384: 			 case socket:bind(S, SA) of
<a name="15385"/>15385: 			     ok -&gt;
<a name="15386"/>15386: 				 ok;
<a name="15387"/>15387: 			     {error, Reason} -&gt;
<a name="15388"/>15388: 				 ?FAIL({bind, Reason})
<a name="15389"/>15389: 			 end
<a name="15390"/>15390: 		 end,
<a name="15391"/>15391:     Sockname   = fun(S) -&gt;
<a name="15392"/>15392: 			 case socket:sockname(S) of
<a name="15393"/>15393: 			     {ok, SA} -&gt;
<a name="15394"/>15394: 				 SA;
<a name="15395"/>15395: 			     {error, Reason} -&gt;
<a name="15396"/>15396: 				 ?FAIL({sockname, Reason})
<a name="15397"/>15397: 			 end
<a name="15398"/>15398: 		 end,
<a name="15399"/>15399:     %% Setopt      = fun(S, L, O, V) -&gt;
<a name="15400"/>15400:     %% 			  socket:setopt(S, L, O, V)
<a name="15401"/>15401:     %% 		  end,
<a name="15402"/>15402:     %% SetOtpOpt = fun(S, O, V) -&gt; Setopt(S, otp, O, V) end,
<a name="15403"/>15403:     %% SetDebug  = fun(S, D) when is_boolean(D) -&gt; SetOptOpt(S, debug, D) end,
<a name="15404"/>15404:     %% EnableDebug = fun(S) -&gt; SetDebug(S, true) end,
<a name="15405"/>15405:     ConnectSock = fun(S, SA) -&gt;
<a name="15406"/>15406: 			  case socket:connect(S, SA) of
<a name="15407"/>15407: 			      ok -&gt;
<a name="15408"/>15408: 				  ok;
<a name="15409"/>15409: 			      {error, Reason} -&gt;
<a name="15410"/>15410: 				  ?FAIL({connect, Reason})
<a name="15411"/>15411: 			  end
<a name="15412"/>15412: 		  end,
<a name="15413"/>15413:     ListenSock = fun(S) -&gt;
<a name="15414"/>15414: 			 case socket:listen(S) of
<a name="15415"/>15415: 			     ok -&gt;
<a name="15416"/>15416: 				 ok;
<a name="15417"/>15417: 			     {error, Reason} -&gt;
<a name="15418"/>15418: 				 ?FAIL({listen, Reason})
<a name="15419"/>15419: 			 end
<a name="15420"/>15420: 		 end,
<a name="15421"/>15421:     AcceptSock = fun(S) -&gt;
<a name="15422"/>15422: 			 case socket:accept(S) of
<a name="15423"/>15423: 			     {ok, A} -&gt;
<a name="15424"/>15424: 				 A;
<a name="15425"/>15425: 			     {error, Reason} -&gt;
<a name="15426"/>15426: 				 ?FAIL({accept, Reason})
<a name="15427"/>15427: 			 end
<a name="15428"/>15428: 		 end,
<a name="15429"/>15429: 
<a name="15430"/>15430:     VerifyBspState = fun(S, Type, Proto,
<a name="15431"/>15431: 			 Bound, Connected) -&gt;
<a name="15432"/>15432: 			     verify_bsp_state(S, Type, Proto,
<a name="15433"/>15433: 					      Bound, Connected)
<a name="15434"/>15434: 		     end,
<a name="15435"/>15435: 
<a name="15436"/>15436:     ?P(&quot;Create UDP socket 1:&quot;),
<a name="15437"/>15437:     US1 = CreateSock(dgram, udp),
<a name="15438"/>15438:     ?P(&quot;UDP[1] [Unbound | Unconnected] =&gt; ~p&quot;, [BspState(US1)]),
<a name="15439"/>15439:     VerifyBspState(BspState(US1), dgram, udp, false, false),
<a name="15440"/>15440: 
<a name="15441"/>15441:     ?P(&quot;Create UDP socket 2:&quot;),
<a name="15442"/>15442:     US2 = CreateSock(dgram, udp),
<a name="15443"/>15443:     ?P(&quot;UDP[2] [Unbound | Unconnected] =&gt; ~p&quot;, [BspState(US2)]),
<a name="15444"/>15444:     VerifyBspState(BspState(US2), dgram, udp, false, false),
<a name="15445"/>15445: 
<a name="15446"/>15446:     ?P(&quot;Bind UDP socket 1&quot;),
<a name="15447"/>15447:     BindSock(US1, LSA),
<a name="15448"/>15448:     ?P(&quot;UDP[1] [Bound | Unconnected]   =&gt; ~p&quot;, [BspState(US1)]),
<a name="15449"/>15449:     VerifyBspState(BspState(US1), dgram, udp, true, false),
<a name="15450"/>15450: 
<a name="15451"/>15451:     ?P(&quot;Bind UDP socket 2&quot;),
<a name="15452"/>15452:     BindSock(US2, LSA),
<a name="15453"/>15453:     ?P(&quot;UDP[2] [Bound | Unconnected]   =&gt; ~p&quot;, [BspState(US2)]),
<a name="15454"/>15454:     VerifyBspState(BspState(US2), dgram, udp, true, false),
<a name="15455"/>15455: 
<a name="15456"/>15456:     %% We have not yet implemented 'connect' for UDP on Windows,
<a name="15457"/>15457:     %% so we leave this commented for now:
<a name="15458"/>15458: 
<a name="15459"/>15459:     %% ?P(&quot;socknames&quot;),
<a name="15460"/>15460:     %% USN1 = Sockname(US1),
<a name="15461"/>15461:     %% USN2 = Sockname(US2),
<a name="15462"/>15462: 
<a name="15463"/>15463:     %% ?P(&quot;enable debug for US1&quot;),
<a name="15464"/>15464:     %% EnableDebug(US1),
<a name="15465"/>15465: 
<a name="15466"/>15466:     %% ?P(&quot;Connect UDP socket 1 to&quot;
<a name="15467"/>15467:     %%    &quot;~n   ~p&quot;, [USN2]),
<a name="15468"/>15468:     %% ConnectSock(US1, USN2),
<a name="15469"/>15469:     %% ?P(&quot;UDP[1] [Bound | Connected]     =&gt; ~p&quot;, [BspState(US1)]),
<a name="15470"/>15470: 
<a name="15471"/>15471:     %% ?P(&quot;Connect UDP socket 2 to&quot;
<a name="15472"/>15472:     %%    &quot;~n   ~p&quot;, [USN1]),
<a name="15473"/>15473:     %% ConnectSock(US2, USN1),
<a name="15474"/>15474:     %% ?P(&quot;UDP[2] [Bound | Connected]     =&gt; ~p&quot;, [BspState(US2)]),
<a name="15475"/>15475: 
<a name="15476"/>15476: 
<a name="15477"/>15477:     ?P(&quot;Create TCP socket 1:&quot;),
<a name="15478"/>15478:     TS1 = CreateSock(stream, tcp),
<a name="15479"/>15479:     ?P(&quot;TCP[1] [Unbound | Unconnected] =&gt; ~p&quot;, [BspState(TS1)]),
<a name="15480"/>15480:     VerifyBspState(BspState(TS1), stream, tcp, false, false),
<a name="15481"/>15481: 
<a name="15482"/>15482:     ?P(&quot;Create TCP socket 2 (listen):&quot;),
<a name="15483"/>15483:     TS2 = CreateSock(stream, tcp),
<a name="15484"/>15484:     ?P(&quot;TCP[2] [Unbound | Unconnected] =&gt; ~p&quot;, [BspState(TS2)]),
<a name="15485"/>15485:     VerifyBspState(BspState(TS2), stream, tcp, false, false),
<a name="15486"/>15486: 
<a name="15487"/>15487:     ?P(&quot;Bind TCP socket 1&quot;),
<a name="15488"/>15488:     BindSock(TS1, LSA),
<a name="15489"/>15489:     ?P(&quot;TCP[1] [Bound | Unconnected]   =&gt; ~p&quot;, [BspState(TS1)]),
<a name="15490"/>15490:     VerifyBspState(BspState(TS1), stream, tcp, true, false),
<a name="15491"/>15491: 
<a name="15492"/>15492:     ?P(&quot;Bind TCP socket 2&quot;),
<a name="15493"/>15493:     BindSock(TS2, LSA),
<a name="15494"/>15494:     ?P(&quot;TCP[2] [Bound | Unconnected]   =&gt; ~p&quot;, [BspState(TS2)]),
<a name="15495"/>15495:     VerifyBspState(BspState(TS2), stream, tcp, true, false),
<a name="15496"/>15496: 
<a name="15497"/>15497:     ?P(&quot;Make TCP socket 2 listen&quot;),
<a name="15498"/>15498:     ListenSock(TS2),
<a name="15499"/>15499: 
<a name="15500"/>15500:     ?P(&quot;socknames&quot;),
<a name="15501"/>15501:     TSN2 = Sockname(TS2),
<a name="15502"/>15502: 
<a name="15503"/>15503:     ?P(&quot;Connect TCP socket 1 to&quot;
<a name="15504"/>15504:        &quot;~n   ~p&quot;, [TSN2]),
<a name="15505"/>15505:     ConnectSock(TS1, TSN2),
<a name="15506"/>15506:     ?P(&quot;TCP[1] [Bound | Connected]   =&gt; ~p&quot;, [BspState(TS1)]),
<a name="15507"/>15507:     VerifyBspState(BspState(TS1), stream, tcp, true, true),
<a name="15508"/>15508: 
<a name="15509"/>15509:     ?P(&quot;Accept TCP socket 3&quot;),
<a name="15510"/>15510:     TS3 = AcceptSock(TS2),
<a name="15511"/>15511:     ?P(&quot;TCP[3] [Bound | Connected]   =&gt; ~p&quot;, [BspState(TS3)]),
<a name="15512"/>15512:     VerifyBspState(BspState(TS3), stream, tcp, true, true),
<a name="15513"/>15513: 
<a name="15514"/>15514:     ?P(&quot;Close socket(s)&quot;),
<a name="15515"/>15515:     CloseSock(TS3),
<a name="15516"/>15516:     CloseSock(TS2),
<a name="15517"/>15517:     CloseSock(TS1),
<a name="15518"/>15518: 
<a name="15519"/>15519:     ?P(&quot;done&quot;),
<a name="api_opt_sock_bsp_state-last_expr"/><a name="15520"/>15520:     ok.
<a name="15521"/>15521: 
<a name="15522"/>15522: 
<a name="verify_bsp_state-5"/><a name="15523"/>15523: <b>verify_bsp_state</b>(#{type        := T,
<a name="15524"/>15524: 		   protocol    := P,
<a name="15525"/>15525: 		   local_addr  := LA,
<a name="15526"/>15526: 		   remote_addr := RA},
<a name="15527"/>15527: 		 Type, Proto,
<a name="15528"/>15528: 		 Bound, Connected) when (T =:= Type) andalso (P =:= Proto) -&gt;
<a name="15529"/>15529:     case {Bound, LA} of
<a name="15530"/>15530: 	{false, undefined} -&gt;
<a name="15531"/>15531: 	    ok;
<a name="15532"/>15532: 	{true, _} when (LA =/= undefined) -&gt;
<a name="15533"/>15533: 	    ok;
<a name="15534"/>15534: 	_ -&gt;
<a name="15535"/>15535: 	    ?FAIL({invalid_bound_la, Bound, LA})
<a name="15536"/>15536:     end,
<a name="15537"/>15537:     case {Connected, RA} of
<a name="15538"/>15538: 	{false, undefined} -&gt;
<a name="15539"/>15539: 	    ok;
<a name="15540"/>15540: 	{true, _} when (RA =/= undefined) -&gt;
<a name="15541"/>15541: 	    ok;
<a name="15542"/>15542: 	_ -&gt;
<a name="15543"/>15543: 	    ?FAIL({invalid_connected_ra, Connected, RA})
<a name="15544"/>15544:     end,
<a name="15545"/>15545:     ok;
<a name="15546"/>15546: <b>verify_bsp_state</b>(#{type     := T,
<a name="15547"/>15547: 		   protocol := P},
<a name="15548"/>15548: 		 Type, Proto,
<a name="15549"/>15549: 		 _Bound, _Connected) -&gt;
<a name="verify_bsp_state-last_expr"/><a name="15550"/>15550: <b>    ?FAIL</b>({invalid_type_or_proto, {T, Type}, {P, Proto}}).
<a name="15551"/>15551: 
<a name="15552"/>15552: 
<a name="15553"/>15553:     
<a name="15554"/>15554: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="15555"/>15555: 
<a name="15556"/>15556: <i>%% Tests the socket option linger. PLACEHOLDER!</i>
<a name="15557"/>15557: 
<a name="api_opt_sock_linger-1"/><a name="15558"/>15558: <b>api_opt_sock_linger</b>(_Config) when is_list(_Config) -&gt;
<a name="15559"/>15559:     ?TT(?SECS(10)),
<a name="api_opt_sock_linger-last_expr"/><a name="15560"/>15560: <b>    tc_try</b>(api_opt_sock_linger,
<a name="15561"/>15561:            fun() -&gt; not_yet_implemented() end,
<a name="15562"/>15562:            fun() -&gt; ok end).
<a name="15563"/>15563: 
<a name="15564"/>15564: 
<a name="15565"/>15565: 
<a name="15566"/>15566: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="15567"/>15567: 
<a name="15568"/>15568: <i>%% Tests the socket option mark. PLACEHOLDER!</i>
<a name="15569"/>15569: 
<a name="api_opt_sock_mark-1"/><a name="15570"/>15570: <b>api_opt_sock_mark</b>(_Config) when is_list(_Config) -&gt;
<a name="15571"/>15571:     ?TT(?SECS(10)),
<a name="api_opt_sock_mark-last_expr"/><a name="15572"/>15572: <b>    tc_try</b>(api_opt_sock_mark,
<a name="15573"/>15573:            fun() -&gt; not_yet_implemented() end,
<a name="15574"/>15574:            fun() -&gt; ok end).
<a name="15575"/>15575: 
<a name="15576"/>15576: 
<a name="15577"/>15577: 
<a name="15578"/>15578: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="15579"/>15579: 
<a name="15580"/>15580: <i>%% Tests the socket option maxdg.</i>
<a name="15581"/>15581: 
<a name="api_opt_sock_maxdg-1"/><a name="15582"/>15582: <b>api_opt_sock_maxdg</b>(_Config) when is_list(_Config) -&gt;
<a name="15583"/>15583:     ?TT(?SECS(10)),
<a name="api_opt_sock_maxdg-last_expr"/><a name="15584"/>15584: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="15585"/>15585: 	   fun() -&gt;
<a name="15586"/>15586: 		   %% This is not a 'IPv4' option,
<a name="15587"/>15587: 		   %% but since we used it in the test...
<a name="15588"/>15588:                    has_support_ipv4(),
<a name="15589"/>15589:                    has_support_sock_maxdg()
<a name="15590"/>15590:            end,
<a name="15591"/>15591:            fun() -&gt; do_api_opt_sock_maxdg() end).
<a name="15592"/>15592: 
<a name="do_api_opt_sock_maxdg-0"/><a name="15593"/>15593: <b>do_api_opt_sock_maxdg</b>() -&gt;
<a name="15594"/>15594:     ?P(&quot;create DGRAM socket&quot;),
<a name="15595"/>15595:     {ok, S} = socket:open(inet, dgram),
<a name="15596"/>15596:     ?P(&quot;get maxdg&quot;),
<a name="do_api_opt_sock_maxdg-last_expr"/><a name="15597"/>15597: <b>    case socket:getopt</b>(S, socket, maxdg) of
<a name="15598"/>15598: 	{ok, Sz} -&gt;
<a name="15599"/>15599: 	    ?P(&quot;success: Sz = ~p&quot;, [Sz]),
<a name="15600"/>15600: 	    ok;
<a name="15601"/>15601: 	{error, Reason} -&gt;
<a name="15602"/>15602: 	    ?FAIL({failed_get_maxdg, Reason})
<a name="15603"/>15603:     end.
<a name="15604"/>15604: 
<a name="15605"/>15605: 
<a name="15606"/>15606: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="15607"/>15607: 
<a name="15608"/>15608: <i>%% Tests the socket option max_msg_size.</i>
<a name="15609"/>15609: 
<a name="api_opt_sock_max_msg_size-1"/><a name="15610"/>15610: <b>api_opt_sock_max_msg_size</b>(_Config) when is_list(_Config) -&gt;
<a name="15611"/>15611:     ?TT(?SECS(10)),
<a name="api_opt_sock_max_msg_size-last_expr"/><a name="15612"/>15612: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="15613"/>15613: 	   fun() -&gt;
<a name="15614"/>15614: 		   %% This is not a 'IPv4' option,
<a name="15615"/>15615: 		   %% but since we used it in the test...
<a name="15616"/>15616:                    has_support_ipv4(),
<a name="15617"/>15617:                    has_support_sock_max_msg_size()
<a name="15618"/>15618:            end,
<a name="15619"/>15619:            fun() -&gt; do_api_opt_sock_max_msg_size() end).
<a name="15620"/>15620: 
<a name="do_api_opt_sock_max_msg_size-0"/><a name="15621"/>15621: <b>do_api_opt_sock_max_msg_size</b>() -&gt;
<a name="15622"/>15622:     {ok, S} = socket:open(inet, dgram),
<a name="do_api_opt_sock_max_msg_size-last_expr"/><a name="15623"/>15623: <b>    case socket:getopt</b>(S, socket, max_msg_size) of
<a name="15624"/>15624: 	{ok, Sz} -&gt;
<a name="15625"/>15625: 	    ?P(&quot;success: Sz = ~p&quot;, [Sz]),
<a name="15626"/>15626: 	    ok;
<a name="15627"/>15627: 	{error, Reason} -&gt;
<a name="15628"/>15628: 	    ?FAIL({failed_get_max_msg_size, Reason})
<a name="15629"/>15629:     end.
<a name="15630"/>15630: 
<a name="15631"/>15631: 
<a name="15632"/>15632: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="15633"/>15633: 
<a name="15634"/>15634: <i>%% This test case tries to test that the oobinline socket 'socket' option</i>
<a name="15635"/>15635: <i>%% works.</i>
<a name="15636"/>15636: <i>%% So, this is done on the receiving side: </i>
<a name="15637"/>15637: <i>%%</i>
<a name="15638"/>15638: <i>%%               socket:setopt(Sock, socket, oobinline, boolean()).</i>
<a name="15639"/>15639: <i>%%</i>
<a name="15640"/>15640: <i>%% This works on linux of some version (at least linux kernel 4.15.0),</i>
<a name="15641"/>15641: <i>%% but not on FreeBSD (12) for some reason. Until we have figured out</i>
<a name="15642"/>15642: <i>%% exctly why, we skip a bunch of OSs...</i>
<a name="15643"/>15643: <i>%%</i>
<a name="15644"/>15644: <i>%% Do we need to make sure the two entities does not run in the same</i>
<a name="15645"/>15645: <i>%% process? This test case does not currently do that (which works in'</i>
<a name="15646"/>15646: <i>%% linux but maybe not in, say, FreeBSD).</i>
<a name="15647"/>15647: <i>%%</i>
<a name="15648"/>15648: 
<a name="api_opt_sock_oobinline-1"/><a name="15649"/>15649: <b>api_opt_sock_oobinline</b>(_Config) when is_list(_Config) -&gt;
<a name="15650"/>15650:     ?TT(?SECS(5)),
<a name="api_opt_sock_oobinline-last_expr"/><a name="15651"/>15651: <b>    tc_try</b>(api_opt_sock_ooinline,
<a name="15652"/>15652:            fun() -&gt;
<a name="15653"/>15653:                    has_support_sock_oobinline(),
<a name="15654"/>15654:                    has_support_msg_flag(oob),
<a name="15655"/>15655:                    is_valid_oobinline_platform()
<a name="15656"/>15656:            end,
<a name="15657"/>15657:            fun() -&gt;
<a name="15658"/>15658:                    Set  = fun(Sock, Value) -&gt;
<a name="15659"/>15659:                                   socket:setopt(Sock, socket, oobinline, Value)
<a name="15660"/>15660:                           end,
<a name="15661"/>15661:                    Get  = fun(Sock) -&gt;
<a name="15662"/>15662:                                   socket:getopt(Sock, socket, oobinline)
<a name="15663"/>15663:                           end,
<a name="15664"/>15664:                    Send = fun(Sock, Data, true) -&gt;
<a name="15665"/>15665:                                   socket:send(Sock, Data, [oob]);
<a name="15666"/>15666:                              (Sock, Data, false) -&gt;
<a name="15667"/>15667:                                      socket:send(Sock, Data)
<a name="15668"/>15668:                           end,
<a name="15669"/>15669:                    Recv = fun(Sock, true) -&gt;
<a name="15670"/>15670:                                   socket:recv(Sock, 0, [oob]);
<a name="15671"/>15671:                              (Sock, false) -&gt;
<a name="15672"/>15672:                                   socket:recv(Sock)
<a name="15673"/>15673:                           end,
<a name="15674"/>15674:                    InitState = #{domain =&gt; inet_or_inet6(),
<a name="15675"/>15675:                                  proto  =&gt; tcp,
<a name="15676"/>15676:                                  send   =&gt; Send,
<a name="15677"/>15677:                                  recv   =&gt; Recv,
<a name="15678"/>15678:                                  set    =&gt; Set,
<a name="15679"/>15679:                                  get    =&gt; Get},
<a name="15680"/>15680:                    ok = do_api_opt_sock_oobinline(InitState)
<a name="15681"/>15681:            end).
<a name="15682"/>15682: 
<a name="15683"/>15683: <i>%% Hopefully this is a temporary solution...</i>
<a name="is_valid_oobinline_platform-0"/><a name="15684"/>15684: <b>is_valid_oobinline_platform</b>() -&gt;
<a name="is_valid_oobinline_platform-last_expr"/><a name="15685"/>15685: <b>    case os:type</b>() of
<a name="15686"/>15686:         {unix, linux} -&gt;
<a name="15687"/>15687:             ok;
<a name="15688"/>15688: 
<a name="15689"/>15689:         Type -&gt;
<a name="15690"/>15690:             %% Actually, all we know is that the
<a name="15691"/>15691:             %% test case only work for linux, but
<a name="15692"/>15692:             %% it *should* for FreeBSD and Solaris
<a name="15693"/>15693:             %% also...
<a name="15694"/>15694:             not_supported(Type)
<a name="15695"/>15695:     end.
<a name="15696"/>15696:     
<a name="15697"/>15697: 
<a name="15698"/>15698: 
<a name="15699"/>15699: 
<a name="15700"/>15700: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="15701"/>15701: 
<a name="do_api_opt_sock_oobinline-1"/><a name="15702"/>15702: <b>do_api_opt_sock_oobinline</b>(InitState) -&gt;
<a name="15703"/>15703:     process_flag(trap_exit, true),
<a name="15704"/>15704:     ServerSeq =
<a name="15705"/>15705:         [
<a name="15706"/>15706:          %% *** Wait for start order ***
<a name="15707"/>15707:          #{desc =&gt; &quot;await start (from tester)&quot;,
<a name="15708"/>15708:            cmd  =&gt; fun(State) -&gt;
<a name="15709"/>15709:                            Tester = ?SEV_AWAIT_START(),
<a name="15710"/>15710:                            {ok, State#{tester =&gt; Tester}}
<a name="15711"/>15711:                    end},
<a name="15712"/>15712:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="15713"/>15713:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="15714"/>15714:                            _MRef = erlang:monitor(process, Tester),
<a name="15715"/>15715:                            ok
<a name="15716"/>15716:                    end},
<a name="15717"/>15717: 
<a name="15718"/>15718:          %% *** Init part ***
<a name="15719"/>15719:          #{desc =&gt; &quot;which local address&quot;,
<a name="15720"/>15720:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="15721"/>15721:                            LSA = which_local_socket_addr(Domain),
<a name="15722"/>15722:                            {ok, State#{lsa =&gt; LSA}}
<a name="15723"/>15723:                    end},
<a name="15724"/>15724:          #{desc =&gt; &quot;create listen socket&quot;,
<a name="15725"/>15725:            cmd  =&gt; fun(#{domain := Domain,
<a name="15726"/>15726:                          proto  := Proto} = State) -&gt;
<a name="15727"/>15727:                            case socket:open(Domain, stream, Proto) of
<a name="15728"/>15728:                                {ok, Sock} -&gt;
<a name="15729"/>15729:                                    {ok, State#{lsock =&gt; Sock}};
<a name="15730"/>15730:                                {error, _} = ERROR -&gt;
<a name="15731"/>15731:                                    ERROR
<a name="15732"/>15732:                            end
<a name="15733"/>15733:                    end},
<a name="15734"/>15734:          #{desc =&gt; &quot;bind to local address&quot;,
<a name="15735"/>15735:            cmd  =&gt; fun(#{domain := local,
<a name="15736"/>15736:                          lsock  := LSock,
<a name="15737"/>15737:                          lsa    := LSA} = _State) -&gt;
<a name="15738"/>15738:                            case socket:bind(LSock, LSA) of
<a name="15739"/>15739:                                ok -&gt;
<a name="15740"/>15740:                                    ok; % We do not care about the port for local
<a name="15741"/>15741:                                {error, _} = ERROR -&gt;
<a name="15742"/>15742:                                    ERROR
<a name="15743"/>15743:                            end;
<a name="15744"/>15744:                       (#{lsock := LSock, lsa := LSA} = State) -&gt;
<a name="15745"/>15745:                            case sock_bind(LSock, LSA) of
<a name="15746"/>15746:                                ok -&gt;
<a name="15747"/>15747:                                    Port = sock_port(LSock),
<a name="15748"/>15748:                                    ?SEV_IPRINT(&quot;bound to port: ~w&quot;, [Port]),
<a name="15749"/>15749:                                    {ok, State#{lport =&gt; Port}};
<a name="15750"/>15750:                                {error, _} = ERROR -&gt;
<a name="15751"/>15751:                                    ERROR
<a name="15752"/>15752:                            end
<a name="15753"/>15753:                    end},
<a name="15754"/>15754:          #{desc =&gt; &quot;make listen socket&quot;,
<a name="15755"/>15755:            cmd  =&gt; fun(#{lsock := LSock}) -&gt;
<a name="15756"/>15756:                            socket:listen(LSock)
<a name="15757"/>15757:                    end},
<a name="15758"/>15758:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="15759"/>15759:            cmd  =&gt; fun(#{domain := local,
<a name="15760"/>15760:                          tester := Tester, lsa := #{path := Path}}) -&gt;
<a name="15761"/>15761:                            ?SEV_ANNOUNCE_READY(Tester, init, Path),
<a name="15762"/>15762:                            ok;
<a name="15763"/>15763:                       (#{tester := Tester, lport := Port}) -&gt;
<a name="15764"/>15764:                            %% This is actually not used for unix domain socket
<a name="15765"/>15765:                            ?SEV_ANNOUNCE_READY(Tester, init, Port),
<a name="15766"/>15766:                            ok
<a name="15767"/>15767:                    end},
<a name="15768"/>15768: 
<a name="15769"/>15769: 
<a name="15770"/>15770:          %% The actual test
<a name="15771"/>15771:          #{desc =&gt; &quot;await continue (accept)&quot;,
<a name="15772"/>15772:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="15773"/>15773:                            ?SEV_AWAIT_CONTINUE(Tester, tester, accept)
<a name="15774"/>15774:                    end},
<a name="15775"/>15775:          #{desc =&gt; &quot;await connection&quot;,
<a name="15776"/>15776:            cmd  =&gt; fun(#{lsock := LSock} = State) -&gt;
<a name="15777"/>15777:                            case socket:accept(LSock) of
<a name="15778"/>15778:                                {ok, Sock} -&gt;
<a name="15779"/>15779:                                    ?SEV_IPRINT(&quot;accepted: ~n   ~p&quot;, [Sock]),
<a name="15780"/>15780:                                    {ok, State#{csock =&gt; Sock}};
<a name="15781"/>15781:                                {error, _} = ERROR -&gt;
<a name="15782"/>15782:                                    ERROR
<a name="15783"/>15783:                            end
<a name="15784"/>15784:                    end},
<a name="15785"/>15785:          #{desc =&gt; &quot;announce ready (accept)&quot;,
<a name="15786"/>15786:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="15787"/>15787:                            ?SEV_ANNOUNCE_READY(Tester, accept),
<a name="15788"/>15788:                            ok
<a name="15789"/>15789:                    end},
<a name="15790"/>15790: 
<a name="15791"/>15791:          %% *** no oobinline ***
<a name="15792"/>15792: 
<a name="15793"/>15793:          #{desc =&gt; &quot;await continue (verify no oobinline)&quot;,
<a name="15794"/>15794:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="15795"/>15795:                            ?SEV_AWAIT_CONTINUE(Tester, tester, verify_oobinline)
<a name="15796"/>15796:                    end},
<a name="15797"/>15797:          #{desc =&gt; &quot;verify no oobinline&quot;,
<a name="15798"/>15798:            cmd  =&gt; fun(#{csock := Sock, get := Get} = _State) -&gt;
<a name="15799"/>15799:                            case Get(Sock) of
<a name="15800"/>15800:                                {ok, false = _Value} -&gt;
<a name="15801"/>15801:                                    ?SEV_IPRINT(&quot;oobinline: ~p&quot;, [_Value]),
<a name="15802"/>15802:                                    ok;
<a name="15803"/>15803:                                {ok, Unexpected} -&gt;
<a name="15804"/>15804:                                    ?SEV_EPRINT(&quot;Unexpected oobinline: ~p&quot;,
<a name="15805"/>15805:                                                [Unexpected]),
<a name="15806"/>15806:                                    {error, {unexpected_oobinline, Unexpected}};
<a name="15807"/>15807:                                {error, Reason} = ERROR -&gt;
<a name="15808"/>15808:                                    ?SEV_EPRINT(&quot;Failed getting oobinline:&quot;
<a name="15809"/>15809:                                                &quot;   ~p&quot;, [Reason]),
<a name="15810"/>15810:                                    ERROR
<a name="15811"/>15811:                            end                                   
<a name="15812"/>15812:                    end},
<a name="15813"/>15813:          #{desc =&gt; &quot;announce ready (no oobinline)&quot;,
<a name="15814"/>15814:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="15815"/>15815:                            ?SEV_ANNOUNCE_READY(Tester, no_oobinline),
<a name="15816"/>15816:                            ok
<a name="15817"/>15817:                    end},
<a name="15818"/>15818: 
<a name="15819"/>15819:          #{desc =&gt; &quot;await continue (recv no oobinline)&quot;,
<a name="15820"/>15820:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="15821"/>15821:                            ?SEV_AWAIT_CONTINUE(Tester, tester, recv)
<a name="15822"/>15822:                    end},
<a name="15823"/>15823:          #{desc =&gt; &quot;await plain data&quot;,
<a name="15824"/>15824:            cmd  =&gt; fun(#{csock := Sock, recv := Recv}) -&gt;
<a name="15825"/>15825:                            case Recv(Sock, false) of
<a name="15826"/>15826:                                {ok, &lt;&lt;&quot;a&quot;&gt;&gt;} -&gt;
<a name="15827"/>15827:                                    ?SEV_IPRINT(&quot;received plain data&quot;),
<a name="15828"/>15828:                                    ok;
<a name="15829"/>15829:                                {error, _} = ERROR -&gt;
<a name="15830"/>15830:                                    ERROR
<a name="15831"/>15831:                            end
<a name="15832"/>15832:                    end},
<a name="15833"/>15833:          #{desc =&gt; &quot;announce ready (plain data)&quot;,
<a name="15834"/>15834:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="15835"/>15835:                            ?SEV_ANNOUNCE_READY(Tester, recv_plain),
<a name="15836"/>15836:                            ok
<a name="15837"/>15837:                    end},
<a name="15838"/>15838:          #{desc =&gt; &quot;await oob data&quot;,
<a name="15839"/>15839:            cmd  =&gt; fun(#{csock := Sock, recv := Recv}) -&gt;
<a name="15840"/>15840:                            case Recv(Sock, true) of
<a name="15841"/>15841:                                {ok, &lt;&lt;&quot;b&quot;&gt;&gt;} -&gt;
<a name="15842"/>15842:                                    ?SEV_IPRINT(&quot;received oob data&quot;),
<a name="15843"/>15843:                                    ok;
<a name="15844"/>15844:                                {error, _} = ERROR -&gt;
<a name="15845"/>15845:                                    ERROR
<a name="15846"/>15846:                            end
<a name="15847"/>15847:                    end},
<a name="15848"/>15848:          #{desc =&gt; &quot;announce ready (oob data)&quot;,
<a name="15849"/>15849:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="15850"/>15850:                            ?SEV_ANNOUNCE_READY(Tester, recv_oob),
<a name="15851"/>15851:                            ok
<a name="15852"/>15852:                    end},
<a name="15853"/>15853: 
<a name="15854"/>15854:          %% *** oobinline ***
<a name="15855"/>15855: 
<a name="15856"/>15856:           #{desc =&gt; &quot;await continue (enable oobinline)&quot;,
<a name="15857"/>15857:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="15858"/>15858:                            ?SEV_AWAIT_CONTINUE(Tester, tester, enable_oobinline)
<a name="15859"/>15859:                    end},
<a name="15860"/>15860:          #{desc =&gt; &quot;enable oobinline&quot;,
<a name="15861"/>15861:            cmd  =&gt; fun(#{csock := Sock, set := Set} = _State) -&gt;
<a name="15862"/>15862:                            case Set(Sock, true) of
<a name="15863"/>15863:                                ok -&gt;
<a name="15864"/>15864:                                    ?SEV_IPRINT(&quot;oobinline enabled&quot;),
<a name="15865"/>15865:                                    ok;
<a name="15866"/>15866:                                {error, Reason} = ERROR -&gt;
<a name="15867"/>15867:                                    ?SEV_EPRINT(&quot;Failed enable oobinline:&quot;
<a name="15868"/>15868:                                                &quot;   ~p&quot;, [Reason]),
<a name="15869"/>15869:                                    ERROR
<a name="15870"/>15870:                            end                                   
<a name="15871"/>15871:                    end},
<a name="15872"/>15872:          #{desc =&gt; &quot;announce ready (oobinline)&quot;,
<a name="15873"/>15873:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="15874"/>15874:                            ?SEV_ANNOUNCE_READY(Tester, oobinline),
<a name="15875"/>15875:                            ok
<a name="15876"/>15876:                    end},
<a name="15877"/>15877: 
<a name="15878"/>15878:          #{desc =&gt; &quot;await continue (recv)&quot;,
<a name="15879"/>15879:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="15880"/>15880:                            ?SEV_AWAIT_CONTINUE(Tester, tester, recv)
<a name="15881"/>15881:                    end},
<a name="15882"/>15882:        #{desc =&gt; &quot;await (recv) data&quot;,
<a name="15883"/>15883:            cmd  =&gt; fun(#{csock := Sock, recv := Recv}) -&gt;
<a name="15884"/>15884:                            case Recv(Sock, false) of
<a name="15885"/>15885:                                {ok, &lt;&lt;&quot;ba&quot;&gt;&gt;} -&gt;
<a name="15886"/>15886:                                    ?SEV_IPRINT(&quot;received expected message: &quot;
<a name="15887"/>15887:                                                &quot;both plain and oob data&quot;),
<a name="15888"/>15888:                                    ok;
<a name="15889"/>15889:                                {ok, BadMsg} -&gt;
<a name="15890"/>15890:                                    ?SEV_EPRINT(&quot;received unexpected message: ~p&quot;,
<a name="15891"/>15891:                                                [BadMsg]),
<a name="15892"/>15892:                                    {error, {unexpected_msg, BadMsg}};
<a name="15893"/>15893:                                {error, _} = ERROR -&gt;
<a name="15894"/>15894:                                    ERROR
<a name="15895"/>15895:                            end
<a name="15896"/>15896:                    end},
<a name="15897"/>15897:          #{desc =&gt; &quot;announce ready (recv)&quot;,
<a name="15898"/>15898:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="15899"/>15899:                            ?SEV_ANNOUNCE_READY(Tester, recv),
<a name="15900"/>15900:                            ok
<a name="15901"/>15901:                    end},
<a name="15902"/>15902: 
<a name="15903"/>15903:          %% *** Termination ***
<a name="15904"/>15904:          #{desc =&gt; &quot;await terminate&quot;,
<a name="15905"/>15905:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="15906"/>15906:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="15907"/>15907:                                ok -&gt;
<a name="15908"/>15908:                                    {ok, maps:remove(tester, State)};
<a name="15909"/>15909:                                {error, _} = ERROR -&gt;
<a name="15910"/>15910:                                    ERROR
<a name="15911"/>15911:                            end
<a name="15912"/>15912:                    end},
<a name="15913"/>15913:          #{desc =&gt; &quot;close connection socket&quot;,
<a name="15914"/>15914:            cmd  =&gt; fun(#{csock := Sock} = State) -&gt;
<a name="15915"/>15915:                            ok = socket:close(Sock),
<a name="15916"/>15916:                            {ok, maps:remove(csock, State)}
<a name="15917"/>15917:                    end},
<a name="15918"/>15918:          #{desc =&gt; &quot;close listen socket&quot;,
<a name="15919"/>15919:            cmd  =&gt; fun(#{domain   := local,
<a name="15920"/>15920:                          lsock    := Sock,
<a name="15921"/>15921:                          local_sa := #{path := Path}} = State) -&gt;
<a name="15922"/>15922:                            ok = socket:close(Sock),
<a name="15923"/>15923:                            State1 =
<a name="15924"/>15924:                                unlink_path(Path,
<a name="15925"/>15925:                                            fun() -&gt;
<a name="15926"/>15926:                                                    maps:remove(local_sa, State)
<a name="15927"/>15927:                                            end,
<a name="15928"/>15928:                                            fun() -&gt; State end),
<a name="15929"/>15929:                            {ok, maps:remove(lsock, State1)};
<a name="15930"/>15930:                       (#{lsock := LSock} = State) -&gt;
<a name="15931"/>15931:                            case socket:close(LSock) of
<a name="15932"/>15932:                                ok -&gt;
<a name="15933"/>15933:                                    {ok, maps:remove(lsock, State)};
<a name="15934"/>15934:                                {error, _} = ERROR -&gt;
<a name="15935"/>15935:                                    ERROR
<a name="15936"/>15936:                            end
<a name="15937"/>15937:                    end},
<a name="15938"/>15938: 
<a name="15939"/>15939:          %% *** We are done ***
<a name="15940"/>15940:          ?SEV_FINISH_NORMAL
<a name="15941"/>15941:         ],
<a name="15942"/>15942: 
<a name="15943"/>15943: 
<a name="15944"/>15944:     ClientSeq =
<a name="15945"/>15945:         [
<a name="15946"/>15946:          %% *** Wait for start order ***
<a name="15947"/>15947:          #{desc =&gt; &quot;await start (from tester)&quot;,
<a name="15948"/>15948:            cmd  =&gt; fun(#{domain := local} = State) -&gt;
<a name="15949"/>15949:                            {Tester, Path} = ?SEV_AWAIT_START(),
<a name="15950"/>15950:                            {ok, State#{tester =&gt; Tester, server_path =&gt; Path}};
<a name="15951"/>15951:                       (State) -&gt;
<a name="15952"/>15952:                            {Tester, Port} = ?SEV_AWAIT_START(),
<a name="15953"/>15953:                            {ok, State#{tester =&gt; Tester, server_port =&gt; Port}}
<a name="15954"/>15954:                    end},
<a name="15955"/>15955:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="15956"/>15956:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="15957"/>15957:                            _MRef = erlang:monitor(process, Tester),
<a name="15958"/>15958:                            ok
<a name="15959"/>15959:                    end},
<a name="15960"/>15960: 
<a name="15961"/>15961:          %% *** The init part ***
<a name="15962"/>15962:          #{desc =&gt; &quot;which server (local) address&quot;,
<a name="15963"/>15963:            cmd  =&gt; fun(#{domain      := local = Domain,
<a name="15964"/>15964:                          server_path := Path} = State) -&gt;
<a name="15965"/>15965:                            LSA = which_local_socket_addr(Domain),
<a name="15966"/>15966:                            SSA = #{family =&gt; Domain, path =&gt; Path},
<a name="15967"/>15967:                            {ok, State#{local_sa =&gt; LSA, server_sa =&gt; SSA}};
<a name="15968"/>15968:                       (#{domain := Domain, server_port := Port} = State) -&gt;
<a name="15969"/>15969:                            LSA = which_local_socket_addr(Domain),
<a name="15970"/>15970:                            SSA = LSA#{port =&gt; Port},
<a name="15971"/>15971:                            {ok, State#{local_sa =&gt; LSA, server_sa =&gt; SSA}}
<a name="15972"/>15972:                    end},
<a name="15973"/>15973:          #{desc =&gt; &quot;create socket&quot;,
<a name="15974"/>15974:            cmd  =&gt; fun(#{domain := Domain,
<a name="15975"/>15975:                          proto  := Proto} = State) -&gt;
<a name="15976"/>15976:                            case socket:open(Domain, stream, Proto) of
<a name="15977"/>15977:                                {ok, Sock} -&gt;
<a name="15978"/>15978:                                    {ok, State#{sock =&gt; Sock}};
<a name="15979"/>15979:                                {error, _} = ERROR -&gt;
<a name="15980"/>15980:                                    ERROR
<a name="15981"/>15981:                            end
<a name="15982"/>15982:                    end},
<a name="15983"/>15983:          #{desc =&gt; &quot;bind to local address&quot;,
<a name="15984"/>15984:            cmd  =&gt; fun(#{sock := Sock, local_sa := LSA} = _State) -&gt;
<a name="15985"/>15985:                            case sock_bind(Sock, LSA) of
<a name="15986"/>15986:                                ok -&gt;
<a name="15987"/>15987:                                    ok;
<a name="15988"/>15988:                                {error, _} = ERROR -&gt;
<a name="15989"/>15989:                                    ERROR
<a name="15990"/>15990:                            end
<a name="15991"/>15991:                    end},
<a name="15992"/>15992:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="15993"/>15993:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="15994"/>15994:                            ?SEV_ANNOUNCE_READY(Tester, init),
<a name="15995"/>15995:                            ok
<a name="15996"/>15996:                    end},
<a name="15997"/>15997: 
<a name="15998"/>15998:          %% *** The actual test ***
<a name="15999"/>15999:          #{desc =&gt; &quot;await continue (connect)&quot;,
<a name="16000"/>16000:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="16001"/>16001:                            ?SEV_AWAIT_CONTINUE(Tester, tester, connect)
<a name="16002"/>16002:                    end},
<a name="16003"/>16003:          #{desc =&gt; &quot;connect to server&quot;,
<a name="16004"/>16004:            cmd  =&gt; fun(#{sock := Sock, server_sa := SSA}) -&gt;
<a name="16005"/>16005:                            socket:connect(Sock, SSA)
<a name="16006"/>16006:                    end},
<a name="16007"/>16007:          #{desc =&gt; &quot;announce ready (connect)&quot;,
<a name="16008"/>16008:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="16009"/>16009:                            ?SEV_ANNOUNCE_READY(Tester, connect),
<a name="16010"/>16010:                            ok
<a name="16011"/>16011:                    end},
<a name="16012"/>16012: 
<a name="16013"/>16013:          %% *** First batch of data (no oobinline) ***
<a name="16014"/>16014: 
<a name="16015"/>16015:          #{desc =&gt; &quot;await continue (send data)&quot;,
<a name="16016"/>16016:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="16017"/>16017:                            ?SEV_AWAIT_CONTINUE(Tester, tester, send)
<a name="16018"/>16018:                    end},
<a name="16019"/>16019:          #{desc =&gt; &quot;send plain data&quot;,
<a name="16020"/>16020:            cmd  =&gt; fun(#{sock := Sock, send := Send}) -&gt;
<a name="16021"/>16021:                            Send(Sock, &lt;&lt;&quot;a&quot;&gt;&gt;, false)
<a name="16022"/>16022:                    end},
<a name="16023"/>16023:          %% #{desc =&gt; &quot;enable (socket &amp; global) debug&quot;,
<a name="16024"/>16024:          %%   cmd  =&gt; fun(#{sock := Sock}) -&gt;
<a name="16025"/>16025:          %%                   ok = socket:setopt(Sock, otp, debug, true),
<a name="16026"/>16026:          %%                   ok = socket:debug(true)
<a name="16027"/>16027:          %%           end},
<a name="16028"/>16028:          #{desc =&gt; &quot;send oob data&quot;,
<a name="16029"/>16029:            cmd  =&gt; fun(#{sock := Sock, send := Send}) -&gt;
<a name="16030"/>16030:                            Send(Sock, &lt;&lt;&quot;b&quot;&gt;&gt;, true)
<a name="16031"/>16031:                    end},
<a name="16032"/>16032:          %% #{desc =&gt; &quot;disable (socket) debug&quot;,
<a name="16033"/>16033:          %%   cmd  =&gt; fun(#{sock := Sock}) -&gt;
<a name="16034"/>16034:          %%                   ok = socket:debug(true),
<a name="16035"/>16035:          %%                   ok = socket:setopt(Sock, otp, debug, false)
<a name="16036"/>16036:          %%           end},
<a name="16037"/>16037:          #{desc =&gt; &quot;announce ready (send)&quot;,
<a name="16038"/>16038:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="16039"/>16039:                            ?SEV_ANNOUNCE_READY(Tester, send),
<a name="16040"/>16040:                            ok
<a name="16041"/>16041:                    end},
<a name="16042"/>16042: 
<a name="16043"/>16043:          %% *** Second batch of data (oobinline) ***
<a name="16044"/>16044: 
<a name="16045"/>16045:          #{desc =&gt; &quot;await continue (send data)&quot;,
<a name="16046"/>16046:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="16047"/>16047:                            ?SEV_AWAIT_CONTINUE(Tester, tester, send)
<a name="16048"/>16048:                    end},
<a name="16049"/>16049:          #{desc =&gt; &quot;send plain data&quot;,
<a name="16050"/>16050:            cmd  =&gt; fun(#{sock := Sock, send := Send}) -&gt;
<a name="16051"/>16051:                            Send(Sock, &lt;&lt;&quot;a&quot;&gt;&gt;, false)
<a name="16052"/>16052:                    end},
<a name="16053"/>16053:          #{desc =&gt; &quot;send oob data&quot;,
<a name="16054"/>16054:            cmd  =&gt; fun(#{sock := Sock, send := Send}) -&gt;
<a name="16055"/>16055:                            Send(Sock, &lt;&lt;&quot;b&quot;&gt;&gt;, true)
<a name="16056"/>16056:                    end},
<a name="16057"/>16057:          #{desc =&gt; &quot;announce ready (send)&quot;,
<a name="16058"/>16058:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="16059"/>16059:                            ?SEV_ANNOUNCE_READY(Tester, send),
<a name="16060"/>16060:                            ok
<a name="16061"/>16061:                    end},
<a name="16062"/>16062: 
<a name="16063"/>16063:          %% *** Termination ***
<a name="16064"/>16064:          #{desc =&gt; &quot;await terminate&quot;,
<a name="16065"/>16065:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="16066"/>16066:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="16067"/>16067:                                ok -&gt;
<a name="16068"/>16068:                                    {ok, maps:remove(tester, State)};
<a name="16069"/>16069:                                {error, _} = ERROR -&gt;
<a name="16070"/>16070:                                    ERROR
<a name="16071"/>16071:                            end
<a name="16072"/>16072:                    end},
<a name="16073"/>16073:          #{desc =&gt; &quot;close socket&quot;,
<a name="16074"/>16074:            cmd  =&gt; fun(#{domain   := local,
<a name="16075"/>16075:                          sock     := Sock,
<a name="16076"/>16076:                          local_sa := #{path := Path}} = State) -&gt;
<a name="16077"/>16077:                            ok = socket:close(Sock),
<a name="16078"/>16078:                            State1 =
<a name="16079"/>16079:                                unlink_path(Path,
<a name="16080"/>16080:                                            fun() -&gt;
<a name="16081"/>16081:                                                    maps:remove(local_sa, State)
<a name="16082"/>16082:                                            end,
<a name="16083"/>16083:                                            fun() -&gt; State end),
<a name="16084"/>16084:                            {ok, maps:remove(sock, State1)};
<a name="16085"/>16085:                       (#{sock := Sock} = State) -&gt;
<a name="16086"/>16086:                            ok = socket:close(Sock),
<a name="16087"/>16087:                            {ok, maps:remove(sock, State)}
<a name="16088"/>16088:                    end},
<a name="16089"/>16089: 
<a name="16090"/>16090:          %% *** We are done ***
<a name="16091"/>16091:          ?SEV_FINISH_NORMAL
<a name="16092"/>16092:         ],
<a name="16093"/>16093: 
<a name="16094"/>16094: 
<a name="16095"/>16095:     TesterSeq =
<a name="16096"/>16096:         [
<a name="16097"/>16097:          %% *** Init part ***
<a name="16098"/>16098:          #{desc =&gt; &quot;monitor server&quot;,
<a name="16099"/>16099:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="16100"/>16100:                            _MRef = erlang:monitor(process, Pid),
<a name="16101"/>16101:                            ok
<a name="16102"/>16102:                    end},
<a name="16103"/>16103:          #{desc =&gt; &quot;monitor client&quot;,
<a name="16104"/>16104:            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;
<a name="16105"/>16105:                            _MRef = erlang:monitor(process, Pid),
<a name="16106"/>16106:                            ok
<a name="16107"/>16107:                    end},
<a name="16108"/>16108: 
<a name="16109"/>16109:          %% Start the server
<a name="16110"/>16110:          #{desc =&gt; &quot;order server start&quot;,
<a name="16111"/>16111:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="16112"/>16112:                            ?SEV_ANNOUNCE_START(Pid),
<a name="16113"/>16113:                            ok
<a name="16114"/>16114:                    end},
<a name="16115"/>16115:          #{desc =&gt; &quot;await server ready (init)&quot;,
<a name="16116"/>16116:            cmd  =&gt; fun(#{server := Pid} = State) -&gt;
<a name="16117"/>16117:                            {ok, Port} = ?SEV_AWAIT_READY(Pid, server, init),
<a name="16118"/>16118:                            {ok, State#{server_port =&gt; Port}}
<a name="16119"/>16119:                    end},
<a name="16120"/>16120: 
<a name="16121"/>16121:          %% Start the client
<a name="16122"/>16122:          #{desc =&gt; &quot;order client start&quot;,
<a name="16123"/>16123:            cmd  =&gt; fun(#{client := Pid, server_port := Port} = _State) -&gt;
<a name="16124"/>16124:                            ?SEV_ANNOUNCE_START(Pid, Port),
<a name="16125"/>16125:                            ok
<a name="16126"/>16126:                    end},
<a name="16127"/>16127:          #{desc =&gt; &quot;await client ready (init)&quot;,
<a name="16128"/>16128:            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;
<a name="16129"/>16129:                            ok = ?SEV_AWAIT_READY(Pid, client, init)
<a name="16130"/>16130:                    end},
<a name="16131"/>16131: 
<a name="16132"/>16132:          %% *** The actual test ***
<a name="16133"/>16133:          #{desc =&gt; &quot;order server to continue (with accept)&quot;,
<a name="16134"/>16134:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="16135"/>16135:                            ?SEV_ANNOUNCE_CONTINUE(Server, accept),
<a name="16136"/>16136:                            ok
<a name="16137"/>16137:                    end},
<a name="16138"/>16138:          ?SEV_SLEEP(?SECS(1)),
<a name="16139"/>16139:          #{desc =&gt; &quot;order client to continue (with connect)&quot;,
<a name="16140"/>16140:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="16141"/>16141:                            ?SEV_ANNOUNCE_CONTINUE(Client, connect),
<a name="16142"/>16142:                            ok
<a name="16143"/>16143:                    end},
<a name="16144"/>16144:          #{desc =&gt; &quot;await client ready (connect)&quot;,
<a name="16145"/>16145:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="16146"/>16146:                            ?SEV_AWAIT_READY(Client, client, connect)
<a name="16147"/>16147:                    end},
<a name="16148"/>16148:          #{desc =&gt; &quot;await server ready (accept)&quot;,
<a name="16149"/>16149:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="16150"/>16150:                            ?SEV_AWAIT_READY(Server, server, accept)
<a name="16151"/>16151:                    end},
<a name="16152"/>16152: 
<a name="16153"/>16153:          %% *** First batch of data (no oobinline) ***
<a name="16154"/>16154: 
<a name="16155"/>16155:          #{desc =&gt; &quot;order server to continue (with verify no oobinline)&quot;,
<a name="16156"/>16156:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="16157"/>16157:                            ?SEV_ANNOUNCE_CONTINUE(Server, verify_oobinline),
<a name="16158"/>16158:                            ok
<a name="16159"/>16159:                    end},
<a name="16160"/>16160:          #{desc =&gt; &quot;await server ready (no oobinline)&quot;,
<a name="16161"/>16161:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="16162"/>16162:                            ?SEV_AWAIT_READY(Server, server, no_oobinline)
<a name="16163"/>16163:                    end},
<a name="16164"/>16164: 
<a name="16165"/>16165:          #{desc =&gt; &quot;order client to continue (with send)&quot;,
<a name="16166"/>16166:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="16167"/>16167:                            ?SEV_ANNOUNCE_CONTINUE(Client, send),
<a name="16168"/>16168:                            ok
<a name="16169"/>16169:                    end},
<a name="16170"/>16170:          #{desc =&gt; &quot;await client ready (with send)&quot;,
<a name="16171"/>16171:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="16172"/>16172:                            ?SEV_AWAIT_READY(Client, client, send)
<a name="16173"/>16173:                    end},
<a name="16174"/>16174:          #{desc =&gt; &quot;order server to continue (with recv plain)&quot;,
<a name="16175"/>16175:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="16176"/>16176:                            ?SEV_ANNOUNCE_CONTINUE(Server, recv),
<a name="16177"/>16177:                            ok
<a name="16178"/>16178:                    end},
<a name="16179"/>16179:          #{desc =&gt; &quot;await server ready (recv plain)&quot;,
<a name="16180"/>16180:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="16181"/>16181:                            ?SEV_AWAIT_READY(Server, server, recv_plain)
<a name="16182"/>16182:                    end},
<a name="16183"/>16183:          #{desc =&gt; &quot;await server ready (recv oob)&quot;,
<a name="16184"/>16184:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="16185"/>16185:                            ?SEV_AWAIT_READY(Server, server, recv_oob)
<a name="16186"/>16186:                    end},
<a name="16187"/>16187: 
<a name="16188"/>16188:          %% Second message (w timestamp)
<a name="16189"/>16189: 
<a name="16190"/>16190:          #{desc =&gt; &quot;order server to continue (with enable oobinline)&quot;,
<a name="16191"/>16191:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="16192"/>16192:                            ?SEV_ANNOUNCE_CONTINUE(Server, enable_oobinline),
<a name="16193"/>16193:                            ok
<a name="16194"/>16194:                    end},
<a name="16195"/>16195:          #{desc =&gt; &quot;await server ready (oobinline)&quot;,
<a name="16196"/>16196:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="16197"/>16197:                            ?SEV_AWAIT_READY(Server, server, oobinline)
<a name="16198"/>16198:                    end},
<a name="16199"/>16199: 
<a name="16200"/>16200:          #{desc =&gt; &quot;order client to continue (with send)&quot;,
<a name="16201"/>16201:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="16202"/>16202:                            ?SEV_ANNOUNCE_CONTINUE(Client, send),
<a name="16203"/>16203:                            ok
<a name="16204"/>16204:                    end},
<a name="16205"/>16205:          #{desc =&gt; &quot;await client ready (with send)&quot;,
<a name="16206"/>16206:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="16207"/>16207:                            ?SEV_AWAIT_READY(Client, client, send)
<a name="16208"/>16208:                    end},
<a name="16209"/>16209:          #{desc =&gt; &quot;order server to continue (with recv)&quot;,
<a name="16210"/>16210:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="16211"/>16211:                            ?SEV_ANNOUNCE_CONTINUE(Server, recv),
<a name="16212"/>16212:                            ok
<a name="16213"/>16213:                    end},
<a name="16214"/>16214:          #{desc =&gt; &quot;await server ready (recv plain)&quot;,
<a name="16215"/>16215:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="16216"/>16216:                            ?SEV_AWAIT_READY(Server, server, recv)
<a name="16217"/>16217:                    end},
<a name="16218"/>16218: 
<a name="16219"/>16219: 
<a name="16220"/>16220:          %% *** Termination ***
<a name="16221"/>16221:          #{desc =&gt; &quot;order client to terminate&quot;,
<a name="16222"/>16222:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="16223"/>16223:                            ?SEV_ANNOUNCE_TERMINATE(Client),
<a name="16224"/>16224:                            ok
<a name="16225"/>16225:                    end},
<a name="16226"/>16226:          #{desc =&gt; &quot;await client termination&quot;,
<a name="16227"/>16227:            cmd  =&gt; fun(#{client := Client} = State) -&gt;
<a name="16228"/>16228:                            ?SEV_AWAIT_TERMINATION(Client),
<a name="16229"/>16229:                            State1 = maps:remove(client, State),
<a name="16230"/>16230:                            {ok, State1}
<a name="16231"/>16231:                    end},
<a name="16232"/>16232:          #{desc =&gt; &quot;order server to terminate&quot;,
<a name="16233"/>16233:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="16234"/>16234:                            ?SEV_ANNOUNCE_TERMINATE(Server),
<a name="16235"/>16235:                            ok
<a name="16236"/>16236:                    end},
<a name="16237"/>16237:          #{desc =&gt; &quot;await server termination&quot;,
<a name="16238"/>16238:            cmd  =&gt; fun(#{server := Server} = State) -&gt;
<a name="16239"/>16239:                            ?SEV_AWAIT_TERMINATION(Server),
<a name="16240"/>16240:                            State1 = maps:remove(server, State),
<a name="16241"/>16241:                            {ok, State1}
<a name="16242"/>16242:                    end},
<a name="16243"/>16243: 
<a name="16244"/>16244:          %% *** We are done ***
<a name="16245"/>16245:          ?SEV_FINISH_NORMAL
<a name="16246"/>16246:         ],
<a name="16247"/>16247: 
<a name="16248"/>16248: 
<a name="16249"/>16249:     i(&quot;start server evaluator&quot;),
<a name="16250"/>16250:     Server = ?SEV_START(&quot;server&quot;, ServerSeq, InitState),
<a name="16251"/>16251: 
<a name="16252"/>16252:     i(&quot;start client evaluator&quot;),
<a name="16253"/>16253:     Client = ?SEV_START(&quot;client&quot;, ClientSeq, InitState),
<a name="16254"/>16254: 
<a name="16255"/>16255:     i(&quot;start tester evaluator&quot;),
<a name="16256"/>16256:     TesterInitState = #{server =&gt; Server#ev.pid,
<a name="16257"/>16257:                         client =&gt; Client#ev.pid},
<a name="16258"/>16258:     Tester = ?SEV_START(&quot;tester&quot;, TesterSeq, TesterInitState),
<a name="16259"/>16259: 
<a name="do_api_opt_sock_oobinline-last_expr"/><a name="16260"/>16260: <b>    ok = ?SEV_AWAIT_FINISH</b>([Server, Client, Tester]).
<a name="16261"/>16261: 
<a name="16262"/>16262: 
<a name="16263"/>16263: 
<a name="16264"/>16264: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="16265"/>16265: 
<a name="16266"/>16266: <i>%% Tests that the credentials control message header is received when</i>
<a name="16267"/>16267: <i>%% setting the socket 'socket' option true when using sendmsg/recvmsg</i>
<a name="16268"/>16268: <i>%% on an IPv4 TCP (stream) socket.</i>
<a name="16269"/>16269: <i>%% So, this is done on the receiving side: </i>
<a name="16270"/>16270: <i>%%</i>
<a name="16271"/>16271: <i>%%               socket:setopt(Sock, socket, passcred, boolean()).</i>
<a name="16272"/>16272: <i>%%</i>
<a name="16273"/>16273: <i>%% We *may* need to run the different entities (server and client) in </i>
<a name="16274"/>16274: <i>%% separate VM (os processes) for this to actually work.</i>
<a name="16275"/>16275: <i>%% As it is now, the client does *not* get any credentials!</i>
<a name="16276"/>16276: <i>%% Until this has been done, this case is skipped!.</i>
<a name="16277"/>16277: 
<a name="api_opt_sock_passcred_tcp4-1"/><a name="16278"/>16278: <b>api_opt_sock_passcred_tcp4</b>(_Config) when is_list(_Config) -&gt;
<a name="16279"/>16279:     ?TT(?SECS(5)),
<a name="api_opt_sock_passcred_tcp4-last_expr"/><a name="16280"/>16280: <b>    tc_try</b>(api_opt_sock_passcred_tcp4,
<a name="16281"/>16281:            fun() -&gt; has_support_sock_passcred(),
<a name="16282"/>16282:                     not_yet_implemented()
<a name="16283"/>16283:            end,
<a name="16284"/>16284:            fun() -&gt;
<a name="16285"/>16285:                    Set  = fun(Sock, Value) -&gt;
<a name="16286"/>16286:                                   socket:setopt(Sock, socket, passcred, Value)
<a name="16287"/>16287:                           end,
<a name="16288"/>16288:                    Get  = fun(Sock) -&gt;
<a name="16289"/>16289:                                   socket:getopt(Sock, socket, passcred)
<a name="16290"/>16290:                           end,
<a name="16291"/>16291:                    Send = fun(Sock, Data) -&gt;
<a name="16292"/>16292:                                   Msg = #{iov  =&gt; [Data]},
<a name="16293"/>16293:                                   socket:sendmsg(Sock, Msg)
<a name="16294"/>16294:                           end,
<a name="16295"/>16295:                    Recv = fun(Sock) -&gt;
<a name="16296"/>16296:                                   case socket:recvmsg(Sock) of
<a name="16297"/>16297:                                       {ok, #{ctrl := CMsgs,
<a name="16298"/>16298:                                              iov  := [Data]}} -&gt;
<a name="16299"/>16299:                                           {ok, {CMsgs, Data}};
<a name="16300"/>16300:                                       {error, _} = ERROR -&gt;
<a name="16301"/>16301:                                           ERROR
<a name="16302"/>16302:                                   end
<a name="16303"/>16303:                           end,
<a name="16304"/>16304:                    InitState = #{domain =&gt; inet,
<a name="16305"/>16305:                                  proto  =&gt; tcp,
<a name="16306"/>16306:                                  send   =&gt; Send,
<a name="16307"/>16307:                                  recv   =&gt; Recv,
<a name="16308"/>16308:                                  set    =&gt; Set,
<a name="16309"/>16309:                                  get    =&gt; Get},
<a name="16310"/>16310:                    ok = api_opt_sock_passcred_tcp(InitState)
<a name="16311"/>16311:            end).
<a name="16312"/>16312: 
<a name="16313"/>16313: 
<a name="16314"/>16314: 
<a name="16315"/>16315: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="16316"/>16316: 
<a name="api_opt_sock_passcred_tcp-1"/><a name="16317"/>16317: <b>api_opt_sock_passcred_tcp</b>(InitState) -&gt;
<a name="16318"/>16318:     process_flag(trap_exit, true),
<a name="16319"/>16319:     ServerSeq =
<a name="16320"/>16320:         [
<a name="16321"/>16321:          %% *** Wait for start order ***
<a name="16322"/>16322:          #{desc =&gt; &quot;await start (from tester)&quot;,
<a name="16323"/>16323:            cmd  =&gt; fun(State) -&gt;
<a name="16324"/>16324:                            Tester = ?SEV_AWAIT_START(),
<a name="16325"/>16325:                            {ok, State#{tester =&gt; Tester}}
<a name="16326"/>16326:                    end},
<a name="16327"/>16327:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="16328"/>16328:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="16329"/>16329:                            _MRef = erlang:monitor(process, Tester),
<a name="16330"/>16330:                            ok
<a name="16331"/>16331:                    end},
<a name="16332"/>16332: 
<a name="16333"/>16333:          %% *** Init part ***
<a name="16334"/>16334:          #{desc =&gt; &quot;which local address&quot;,
<a name="16335"/>16335:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="16336"/>16336:                            LSA = which_local_socket_addr(Domain),
<a name="16337"/>16337:                            {ok, State#{lsa =&gt; LSA}}
<a name="16338"/>16338:                    end},
<a name="16339"/>16339:          #{desc =&gt; &quot;create listen socket&quot;,
<a name="16340"/>16340:            cmd  =&gt; fun(#{domain := Domain,
<a name="16341"/>16341:                          proto  := Proto} = State) -&gt;
<a name="16342"/>16342:                            case socket:open(Domain, stream, Proto) of
<a name="16343"/>16343:                                {ok, Sock} -&gt;
<a name="16344"/>16344:                                    {ok, State#{lsock =&gt; Sock}};
<a name="16345"/>16345:                                {error, _} = ERROR -&gt;
<a name="16346"/>16346:                                    ERROR
<a name="16347"/>16347:                            end
<a name="16348"/>16348:                    end},
<a name="16349"/>16349:          #{desc =&gt; &quot;bind to local address&quot;,
<a name="16350"/>16350:            cmd  =&gt; fun(#{domain := local,
<a name="16351"/>16351:                          lsock  := LSock,
<a name="16352"/>16352:                          lsa    := LSA} = _State) -&gt;
<a name="16353"/>16353:                            case socket:bind(LSock, LSA) of
<a name="16354"/>16354:                                ok -&gt;
<a name="16355"/>16355:                                    ok; % We do not care about the port for local
<a name="16356"/>16356:                                {error, _} = ERROR -&gt;
<a name="16357"/>16357:                                    ERROR
<a name="16358"/>16358:                            end;
<a name="16359"/>16359:                       (#{lsock := LSock, lsa := LSA} = State) -&gt;
<a name="16360"/>16360:                            case sock_bind(LSock, LSA) of
<a name="16361"/>16361:                                ok -&gt;
<a name="16362"/>16362:                                    Port = sock_port(LSock),
<a name="16363"/>16363:                                    ?SEV_IPRINT(&quot;bound to port: ~w&quot;, [Port]),
<a name="16364"/>16364:                                    {ok, State#{lport =&gt; Port}};
<a name="16365"/>16365:                                {error, _} = ERROR -&gt;
<a name="16366"/>16366:                                    ERROR
<a name="16367"/>16367:                            end
<a name="16368"/>16368:                    end},
<a name="16369"/>16369:          #{desc =&gt; &quot;make listen socket&quot;,
<a name="16370"/>16370:            cmd  =&gt; fun(#{lsock := LSock}) -&gt;
<a name="16371"/>16371:                            socket:listen(LSock)
<a name="16372"/>16372:                    end},
<a name="16373"/>16373:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="16374"/>16374:            cmd  =&gt; fun(#{domain := local,
<a name="16375"/>16375:                          tester := Tester, lsa := #{path := Path}}) -&gt;
<a name="16376"/>16376:                            ?SEV_ANNOUNCE_READY(Tester, init, Path),
<a name="16377"/>16377:                            ok;
<a name="16378"/>16378:                       (#{tester := Tester, lport := Port}) -&gt;
<a name="16379"/>16379:                            %% This is actually not used for unix domain socket
<a name="16380"/>16380:                            ?SEV_ANNOUNCE_READY(Tester, init, Port),
<a name="16381"/>16381:                            ok
<a name="16382"/>16382:                    end},
<a name="16383"/>16383: 
<a name="16384"/>16384: 
<a name="16385"/>16385:          %% The actual test
<a name="16386"/>16386:          #{desc =&gt; &quot;await continue (accept)&quot;,
<a name="16387"/>16387:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="16388"/>16388:                            ?SEV_AWAIT_CONTINUE(Tester, tester, accept)
<a name="16389"/>16389:                    end},
<a name="16390"/>16390:          #{desc =&gt; &quot;await connection&quot;,
<a name="16391"/>16391:            cmd  =&gt; fun(#{lsock := LSock} = State) -&gt;
<a name="16392"/>16392:                            case socket:accept(LSock) of
<a name="16393"/>16393:                                {ok, Sock} -&gt;
<a name="16394"/>16394:                                    ?SEV_IPRINT(&quot;accepted: ~n   ~p&quot;, [Sock]),
<a name="16395"/>16395:                                    {ok, State#{csock =&gt; Sock}};
<a name="16396"/>16396:                                {error, _} = ERROR -&gt;
<a name="16397"/>16397:                                    ERROR
<a name="16398"/>16398:                            end
<a name="16399"/>16399:                    end},
<a name="16400"/>16400:          #{desc =&gt; &quot;announce ready (accept)&quot;,
<a name="16401"/>16401:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="16402"/>16402:                            ?SEV_ANNOUNCE_READY(Tester, accept),
<a name="16403"/>16403:                            ok
<a name="16404"/>16404:                    end},
<a name="16405"/>16405: 
<a name="16406"/>16406:          %% *** First message ***
<a name="16407"/>16407: 
<a name="16408"/>16408:          #{desc =&gt; &quot;await (recv) request 1&quot;,
<a name="16409"/>16409:            cmd  =&gt; fun(#{csock := Sock, recv := Recv}) -&gt;
<a name="16410"/>16410:                            case Recv(Sock) of
<a name="16411"/>16411:                                {ok, {[], ?BASIC_REQ}} -&gt;
<a name="16412"/>16412:                                    ok;
<a name="16413"/>16413:                                {error, _} = ERROR -&gt;
<a name="16414"/>16414:                                    ERROR
<a name="16415"/>16415:                            end
<a name="16416"/>16416:                    end},
<a name="16417"/>16417:          #{desc =&gt; &quot;announce ready (recv request)&quot;,
<a name="16418"/>16418:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="16419"/>16419:                            ?SEV_ANNOUNCE_READY(Tester, recv_req),
<a name="16420"/>16420:                            ok
<a name="16421"/>16421:                    end},
<a name="16422"/>16422:          #{desc =&gt; &quot;await continue (with send reply)&quot;,
<a name="16423"/>16423:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="16424"/>16424:                            ?SEV_AWAIT_CONTINUE(Tester, tester, send_reply)
<a name="16425"/>16425:                    end},
<a name="16426"/>16426:          #{desc =&gt; &quot;send reply&quot;,
<a name="16427"/>16427:            cmd  =&gt; fun(#{csock := Sock, send := Send}) -&gt;
<a name="16428"/>16428:                            Send(Sock, ?BASIC_REP)
<a name="16429"/>16429:                    end},
<a name="16430"/>16430:          #{desc =&gt; &quot;announce ready (send reply)&quot;,
<a name="16431"/>16431:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="16432"/>16432:                            ?SEV_ANNOUNCE_READY(Tester, send_reply),
<a name="16433"/>16433:                            ok
<a name="16434"/>16434:                    end},
<a name="16435"/>16435: 
<a name="16436"/>16436:          %% *** Second message ***
<a name="16437"/>16437: 
<a name="16438"/>16438:          #{desc =&gt; &quot;await (recv) request 2&quot;,
<a name="16439"/>16439:            cmd  =&gt; fun(#{csock := Sock, recv := Recv}) -&gt;
<a name="16440"/>16440:                            case Recv(Sock) of
<a name="16441"/>16441:                                {ok, {[], ?BASIC_REQ}} -&gt;
<a name="16442"/>16442:                                    ok;
<a name="16443"/>16443:                                {error, _} = ERROR -&gt;
<a name="16444"/>16444:                                    ERROR
<a name="16445"/>16445:                            end
<a name="16446"/>16446:                    end},
<a name="16447"/>16447:          #{desc =&gt; &quot;announce ready (recv request)&quot;,
<a name="16448"/>16448:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="16449"/>16449:                            ?SEV_ANNOUNCE_READY(Tester, recv_req),
<a name="16450"/>16450:                            ok
<a name="16451"/>16451:                    end},
<a name="16452"/>16452:          #{desc =&gt; &quot;await continue (with send reply)&quot;,
<a name="16453"/>16453:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="16454"/>16454:                            ?SEV_AWAIT_CONTINUE(Tester, tester, send_reply)
<a name="16455"/>16455:                    end},
<a name="16456"/>16456:          #{desc =&gt; &quot;send reply&quot;,
<a name="16457"/>16457:            cmd  =&gt; fun(#{csock := Sock, send := Send}) -&gt;
<a name="16458"/>16458:                            Send(Sock, ?BASIC_REP)
<a name="16459"/>16459:                    end},
<a name="16460"/>16460:          #{desc =&gt; &quot;announce ready (send reply)&quot;,
<a name="16461"/>16461:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="16462"/>16462:                            ?SEV_ANNOUNCE_READY(Tester, send_reply),
<a name="16463"/>16463:                            ok
<a name="16464"/>16464:                    end},
<a name="16465"/>16465: 
<a name="16466"/>16466:          %% *** Third message ***
<a name="16467"/>16467: 
<a name="16468"/>16468:          #{desc =&gt; &quot;await (recv) request 3&quot;,
<a name="16469"/>16469:            cmd  =&gt; fun(#{csock := Sock, recv := Recv}) -&gt;
<a name="16470"/>16470:                            case Recv(Sock) of
<a name="16471"/>16471:                                {ok, {[], ?BASIC_REQ}} -&gt;
<a name="16472"/>16472:                                    ok;
<a name="16473"/>16473:                                {error, _} = ERROR -&gt;
<a name="16474"/>16474:                                    ERROR
<a name="16475"/>16475:                            end
<a name="16476"/>16476:                    end},
<a name="16477"/>16477:          #{desc =&gt; &quot;announce ready (recv request)&quot;,
<a name="16478"/>16478:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="16479"/>16479:                            ?SEV_ANNOUNCE_READY(Tester, recv_req),
<a name="16480"/>16480:                            ok
<a name="16481"/>16481:                    end},
<a name="16482"/>16482:          #{desc =&gt; &quot;await continue (with send reply)&quot;,
<a name="16483"/>16483:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="16484"/>16484:                            ?SEV_AWAIT_CONTINUE(Tester, tester, send_reply)
<a name="16485"/>16485:                    end},
<a name="16486"/>16486:          #{desc =&gt; &quot;send reply&quot;,
<a name="16487"/>16487:            cmd  =&gt; fun(#{csock := Sock, send := Send}) -&gt;
<a name="16488"/>16488:                            Send(Sock, ?BASIC_REP)
<a name="16489"/>16489:                    end},
<a name="16490"/>16490:          #{desc =&gt; &quot;announce ready (send reply)&quot;,
<a name="16491"/>16491:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="16492"/>16492:                            ?SEV_ANNOUNCE_READY(Tester, send_reply),
<a name="16493"/>16493:                            ok
<a name="16494"/>16494:                    end},
<a name="16495"/>16495: 
<a name="16496"/>16496:          %% *** Termination ***
<a name="16497"/>16497:          #{desc =&gt; &quot;await terminate&quot;,
<a name="16498"/>16498:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="16499"/>16499:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="16500"/>16500:                                ok -&gt;
<a name="16501"/>16501:                                    {ok, maps:remove(tester, State)};
<a name="16502"/>16502:                                {error, _} = ERROR -&gt;
<a name="16503"/>16503:                                    ERROR
<a name="16504"/>16504:                            end
<a name="16505"/>16505:                    end},
<a name="16506"/>16506:          #{desc =&gt; &quot;close connection socket&quot;,
<a name="16507"/>16507:            cmd  =&gt; fun(#{csock := Sock} = State) -&gt;
<a name="16508"/>16508:                            ok = socket:close(Sock),
<a name="16509"/>16509:                            {ok, maps:remove(csock, State)}
<a name="16510"/>16510:                    end},
<a name="16511"/>16511:          #{desc =&gt; &quot;close listen socket&quot;,
<a name="16512"/>16512:            cmd  =&gt; fun(#{domain   := local,
<a name="16513"/>16513:                          lsock    := Sock,
<a name="16514"/>16514:                          local_sa := #{path := Path}} = State) -&gt;
<a name="16515"/>16515:                            ok = socket:close(Sock),
<a name="16516"/>16516:                            State1 =
<a name="16517"/>16517:                                unlink_path(Path,
<a name="16518"/>16518:                                            fun() -&gt;
<a name="16519"/>16519:                                                    maps:remove(local_sa, State)
<a name="16520"/>16520:                                            end,
<a name="16521"/>16521:                                            fun() -&gt; State end),
<a name="16522"/>16522:                            {ok, maps:remove(lsock, State1)};
<a name="16523"/>16523:                       (#{lsock := LSock} = State) -&gt;
<a name="16524"/>16524:                            case socket:close(LSock) of
<a name="16525"/>16525:                                ok -&gt;
<a name="16526"/>16526:                                    {ok, maps:remove(lsock, State)};
<a name="16527"/>16527:                                {error, _} = ERROR -&gt;
<a name="16528"/>16528:                                    ERROR
<a name="16529"/>16529:                            end
<a name="16530"/>16530:                    end},
<a name="16531"/>16531: 
<a name="16532"/>16532:          %% *** We are done ***
<a name="16533"/>16533:          ?SEV_FINISH_NORMAL
<a name="16534"/>16534:         ],
<a name="16535"/>16535: 
<a name="16536"/>16536: 
<a name="16537"/>16537:     ClientSeq =
<a name="16538"/>16538:         [
<a name="16539"/>16539:          %% *** Wait for start order ***
<a name="16540"/>16540:          #{desc =&gt; &quot;await start (from tester)&quot;,
<a name="16541"/>16541:            cmd  =&gt; fun(#{domain := local} = State) -&gt;
<a name="16542"/>16542:                            {Tester, Path} = ?SEV_AWAIT_START(),
<a name="16543"/>16543:                            {ok, State#{tester =&gt; Tester, server_path =&gt; Path}};
<a name="16544"/>16544:                       (State) -&gt;
<a name="16545"/>16545:                            {Tester, Port} = ?SEV_AWAIT_START(),
<a name="16546"/>16546:                            {ok, State#{tester =&gt; Tester, server_port =&gt; Port}}
<a name="16547"/>16547:                    end},
<a name="16548"/>16548:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="16549"/>16549:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="16550"/>16550:                            _MRef = erlang:monitor(process, Tester),
<a name="16551"/>16551:                            ok
<a name="16552"/>16552:                    end},
<a name="16553"/>16553: 
<a name="16554"/>16554:          %% *** The init part ***
<a name="16555"/>16555:          #{desc =&gt; &quot;which server (local) address&quot;,
<a name="16556"/>16556:            cmd  =&gt; fun(#{domain      := local = Domain,
<a name="16557"/>16557:                          server_path := Path} = State) -&gt;
<a name="16558"/>16558:                            LSA = which_local_socket_addr(Domain),
<a name="16559"/>16559:                            SSA = #{family =&gt; Domain, path =&gt; Path},
<a name="16560"/>16560:                            {ok, State#{local_sa =&gt; LSA, server_sa =&gt; SSA}};
<a name="16561"/>16561:                       (#{domain := Domain, server_port := Port} = State) -&gt;
<a name="16562"/>16562:                            LSA = which_local_socket_addr(Domain),
<a name="16563"/>16563:                            SSA = LSA#{port =&gt; Port},
<a name="16564"/>16564:                            {ok, State#{local_sa =&gt; LSA, server_sa =&gt; SSA}}
<a name="16565"/>16565:                    end},
<a name="16566"/>16566:          #{desc =&gt; &quot;create socket&quot;,
<a name="16567"/>16567:            cmd  =&gt; fun(#{domain := Domain,
<a name="16568"/>16568:                          proto  := Proto} = State) -&gt;
<a name="16569"/>16569:                            case socket:open(Domain, stream, Proto) of
<a name="16570"/>16570:                                {ok, Sock} -&gt;
<a name="16571"/>16571:                                    {ok, State#{sock =&gt; Sock}};
<a name="16572"/>16572:                                {error, _} = ERROR -&gt;
<a name="16573"/>16573:                                    ERROR
<a name="16574"/>16574:                            end
<a name="16575"/>16575:                    end},
<a name="16576"/>16576:          #{desc =&gt; &quot;bind to local address&quot;,
<a name="16577"/>16577:            cmd  =&gt; fun(#{sock := Sock, local_sa := LSA} = _State) -&gt;
<a name="16578"/>16578:                            case sock_bind(Sock, LSA) of
<a name="16579"/>16579:                                ok -&gt;
<a name="16580"/>16580:                                    ok;
<a name="16581"/>16581:                                {error, _} = ERROR -&gt;
<a name="16582"/>16582:                                    ERROR
<a name="16583"/>16583:                            end
<a name="16584"/>16584:                    end},
<a name="16585"/>16585:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="16586"/>16586:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="16587"/>16587:                            ?SEV_ANNOUNCE_READY(Tester, init),
<a name="16588"/>16588:                            ok
<a name="16589"/>16589:                    end},
<a name="16590"/>16590: 
<a name="16591"/>16591:          %% *** The actual test ***
<a name="16592"/>16592:          #{desc =&gt; &quot;await continue (connect)&quot;,
<a name="16593"/>16593:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="16594"/>16594:                            ?SEV_AWAIT_CONTINUE(Tester, tester, connect)
<a name="16595"/>16595:                    end},
<a name="16596"/>16596:          #{desc =&gt; &quot;connect to server&quot;,
<a name="16597"/>16597:            cmd  =&gt; fun(#{sock := Sock, server_sa := SSA}) -&gt;
<a name="16598"/>16598:                            socket:connect(Sock, SSA)
<a name="16599"/>16599:                    end},
<a name="16600"/>16600:          #{desc =&gt; &quot;announce ready (connect)&quot;,
<a name="16601"/>16601:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="16602"/>16602:                            ?SEV_ANNOUNCE_READY(Tester, connect),
<a name="16603"/>16603:                            ok
<a name="16604"/>16604:                    end},
<a name="16605"/>16605: 
<a name="16606"/>16606:          %% *** First message (default=wo passcred) ***
<a name="16607"/>16607: 
<a name="16608"/>16608:          #{desc =&gt; &quot;await continue (verify timestamp off)&quot;,
<a name="16609"/>16609:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="16610"/>16610:                            ?SEV_AWAIT_CONTINUE(Tester, tester, verify_passcred)
<a name="16611"/>16611:                    end},
<a name="16612"/>16612:          #{desc =&gt; &quot;verify passcred off&quot;,
<a name="16613"/>16613:            cmd  =&gt; fun(#{sock := Sock, get := Get} = _State) -&gt;
<a name="16614"/>16614:                            case Get(Sock) of
<a name="16615"/>16615:                                {ok, false = _Value} -&gt;
<a name="16616"/>16616:                                    ?SEV_IPRINT(&quot;passcred: ~p&quot;, [_Value]),
<a name="16617"/>16617:                                    ok;
<a name="16618"/>16618:                                {ok, Unexpected} -&gt;
<a name="16619"/>16619:                                    ?SEV_EPRINT(&quot;Unexpected passcred: ~p&quot;,
<a name="16620"/>16620:                                                [Unexpected]),
<a name="16621"/>16621:                                    {error, {unexpected_passcred, Unexpected}};
<a name="16622"/>16622:                                {error, Reason} = ERROR -&gt;
<a name="16623"/>16623:                                    ?SEV_EPRINT(&quot;Failed getting passcred:&quot;
<a name="16624"/>16624:                                                &quot;   ~p&quot;, [Reason]),
<a name="16625"/>16625:                                    ERROR
<a name="16626"/>16626:                            end                                   
<a name="16627"/>16627:                    end},
<a name="16628"/>16628:          #{desc =&gt; &quot;announce ready (passcred off)&quot;,
<a name="16629"/>16629:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="16630"/>16630:                            ?SEV_ANNOUNCE_READY(Tester, passcred_off),
<a name="16631"/>16631:                            ok
<a name="16632"/>16632:                    end},
<a name="16633"/>16633: 
<a name="16634"/>16634:          #{desc =&gt; &quot;await continue (send request)&quot;,
<a name="16635"/>16635:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="16636"/>16636:                            ?SEV_AWAIT_CONTINUE(Tester, tester, send_req)
<a name="16637"/>16637:                    end},
<a name="16638"/>16638:          #{desc =&gt; &quot;send request 1 (to server)&quot;,
<a name="16639"/>16639:            cmd  =&gt; fun(#{sock := Sock, send := Send}) -&gt;
<a name="16640"/>16640:                            Send(Sock, ?BASIC_REQ)
<a name="16641"/>16641:                    end},
<a name="16642"/>16642:          #{desc =&gt; &quot;announce ready (send request)&quot;,
<a name="16643"/>16643:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="16644"/>16644:                            ?SEV_ANNOUNCE_READY(Tester, send_req),
<a name="16645"/>16645:                            ok
<a name="16646"/>16646:                    end},
<a name="16647"/>16647:          #{desc =&gt; &quot;await recv reply 1 (from server, wo passcred)&quot;,
<a name="16648"/>16648:            cmd  =&gt; fun(#{sock := Sock, recv := Recv}) -&gt;
<a name="16649"/>16649:                            case Recv(Sock) of
<a name="16650"/>16650:                                {ok, {[], ?BASIC_REP}} -&gt;
<a name="16651"/>16651:                                    ok;
<a name="16652"/>16652:                                {ok, {[], UnexpData}} -&gt;
<a name="16653"/>16653:                                    {error, {unexpected_reply_data, UnexpData}};
<a name="16654"/>16654:                                {ok, {BadCMsgs, ?BASIC_REP}} -&gt;
<a name="16655"/>16655:                                    {error, {unexpected_reply_cmsgs,
<a name="16656"/>16656:                                             BadCMsgs}};
<a name="16657"/>16657:                                {ok, BadReply} -&gt;
<a name="16658"/>16658:                                    {error, {unexpected_reply, BadReply}};
<a name="16659"/>16659:                                {error, _} = ERROR -&gt;
<a name="16660"/>16660:                                    ERROR
<a name="16661"/>16661:                            end
<a name="16662"/>16662:                    end},
<a name="16663"/>16663:          #{desc =&gt; &quot;announce ready 1 (recv reply)&quot;,
<a name="16664"/>16664:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="16665"/>16665:                            ?SEV_ANNOUNCE_READY(Tester, recv_reply),
<a name="16666"/>16666:                            ok
<a name="16667"/>16667:                    end},
<a name="16668"/>16668: 
<a name="16669"/>16669:          %% *** Second message (w passcred) ***
<a name="16670"/>16670: 
<a name="16671"/>16671:          #{desc =&gt; &quot;await continue (enable passcred)&quot;,
<a name="16672"/>16672:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="16673"/>16673:                            ?SEV_AWAIT_CONTINUE(Tester, tester, enable_passcred)
<a name="16674"/>16674:                    end},
<a name="16675"/>16675:          #{desc =&gt; &quot;enable passcred&quot;,
<a name="16676"/>16676:            cmd  =&gt; fun(#{sock := Sock, set := Set} = _State) -&gt;
<a name="16677"/>16677:                            case Set(Sock, true) of
<a name="16678"/>16678:                                ok -&gt;
<a name="16679"/>16679:                                    ?SEV_IPRINT(&quot;passcred enabled&quot;),
<a name="16680"/>16680:                                    ok;
<a name="16681"/>16681:                                {error, Reason} = ERROR -&gt;
<a name="16682"/>16682:                                    ?SEV_EPRINT(&quot;Failed enable passcred:&quot;
<a name="16683"/>16683:                                                &quot;   ~p&quot;, [Reason]),
<a name="16684"/>16684:                                    ERROR
<a name="16685"/>16685:                            end                                   
<a name="16686"/>16686:                    end},
<a name="16687"/>16687:          #{desc =&gt; &quot;announce ready (passcred on)&quot;,
<a name="16688"/>16688:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="16689"/>16689:                            ?SEV_ANNOUNCE_READY(Tester, passcred_on),
<a name="16690"/>16690:                            ok
<a name="16691"/>16691:                    end},
<a name="16692"/>16692: 
<a name="16693"/>16693:          #{desc =&gt; &quot;await continue (send request 2)&quot;,
<a name="16694"/>16694:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="16695"/>16695:                            ?SEV_AWAIT_CONTINUE(Tester, tester, send_req)
<a name="16696"/>16696:                    end},
<a name="16697"/>16697:          #{desc =&gt; &quot;send request 2 (to server)&quot;,
<a name="16698"/>16698:            cmd  =&gt; fun(#{sock := Sock, send := Send}) -&gt;
<a name="16699"/>16699:                            Send(Sock, ?BASIC_REQ)
<a name="16700"/>16700:                    end},
<a name="16701"/>16701:          #{desc =&gt; &quot;announce ready (send request 2)&quot;,
<a name="16702"/>16702:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="16703"/>16703:                            ?SEV_ANNOUNCE_READY(Tester, send_req),
<a name="16704"/>16704:                            ok
<a name="16705"/>16705:                    end},
<a name="16706"/>16706:          #{desc =&gt; &quot;await recv reply 2 (from server, w passcred)&quot;,
<a name="16707"/>16707:            cmd  =&gt; fun(#{sock := Sock, recv := Recv}) -&gt;
<a name="16708"/>16708:                            %% socket:setopt(Sock, otp, debug, true),
<a name="16709"/>16709:                            case Recv(Sock) of
<a name="16710"/>16710:                                {ok, {[#{level := socket,
<a name="16711"/>16711:                                         type  := passcred,
<a name="16712"/>16712:                                         value := Cred}], ?BASIC_REP}} -&gt;
<a name="16713"/>16713:                                    %% socket:setopt(Sock, otp, debug, false),
<a name="16714"/>16714:                                    ?SEV_IPRINT(&quot;received reply *with* &quot;
<a name="16715"/>16715:                                                &quot;expected passcred: &quot;
<a name="16716"/>16716:                                                &quot;~n   ~p&quot;, [Cred]),
<a name="16717"/>16717:                                    ok;
<a name="16718"/>16718:                                {ok, {BadCMsgs, ?BASIC_REP}} -&gt;
<a name="16719"/>16719:                                    %% socket:setopt(Sock, otp, debug, false),
<a name="16720"/>16720:                                    {error, {unexpected_reply_cmsgs,
<a name="16721"/>16721:                                             BadCMsgs}};
<a name="16722"/>16722:                                {ok, {[#{level := socket,
<a name="16723"/>16723:                                         type  := passcred,
<a name="16724"/>16724:                                         value := _Cred}], BadData}} -&gt;
<a name="16725"/>16725:                                    %% socket:setopt(Sock, otp, debug, false),
<a name="16726"/>16726:                                    {error, {unexpected_reply_data,
<a name="16727"/>16727:                                             BadData}};
<a name="16728"/>16728:                                {ok, BadReply} -&gt;
<a name="16729"/>16729:                                    %% socket:setopt(Sock, otp, debug, false),
<a name="16730"/>16730:                                    {error, {unexpected_reply, BadReply}};
<a name="16731"/>16731:                                {error, _} = ERROR -&gt;
<a name="16732"/>16732:                                    %% socket:setopt(Sock, otp, debug, false),
<a name="16733"/>16733:                                    ERROR
<a name="16734"/>16734:                            end
<a name="16735"/>16735:                    end},
<a name="16736"/>16736:          #{desc =&gt; &quot;announce ready 2 (recv reply)&quot;,
<a name="16737"/>16737:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="16738"/>16738:                            ?SEV_ANNOUNCE_READY(Tester, recv_reply),
<a name="16739"/>16739:                            ok
<a name="16740"/>16740:                    end},
<a name="16741"/>16741: 
<a name="16742"/>16742:          %% *** Third message (wo passcred) ***
<a name="16743"/>16743: 
<a name="16744"/>16744:          #{desc =&gt; &quot;await continue (disable passcred)&quot;,
<a name="16745"/>16745:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="16746"/>16746:                            ?SEV_AWAIT_CONTINUE(Tester, tester, disable_passcred)
<a name="16747"/>16747:                    end},
<a name="16748"/>16748:          #{desc =&gt; &quot;disable passcred&quot;,
<a name="16749"/>16749:            cmd  =&gt; fun(#{sock := Sock, set := Set} = _State) -&gt;
<a name="16750"/>16750:                            case Set(Sock, false) of
<a name="16751"/>16751:                                ok -&gt;
<a name="16752"/>16752:                                    ?SEV_IPRINT(&quot;passcred disabled&quot;),
<a name="16753"/>16753:                                    ok;
<a name="16754"/>16754:                                {error, Reason} = ERROR -&gt;
<a name="16755"/>16755:                                    ?SEV_EPRINT(&quot;Failed disable timestamp:&quot;
<a name="16756"/>16756:                                                &quot;   ~p&quot;, [Reason]),
<a name="16757"/>16757:                                    ERROR
<a name="16758"/>16758:                            end                                   
<a name="16759"/>16759:                    end},
<a name="16760"/>16760:          #{desc =&gt; &quot;announce ready (passcred off)&quot;,
<a name="16761"/>16761:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="16762"/>16762:                            ?SEV_ANNOUNCE_READY(Tester, passcred_off),
<a name="16763"/>16763:                            ok
<a name="16764"/>16764:                    end},
<a name="16765"/>16765: 
<a name="16766"/>16766:          #{desc =&gt; &quot;await continue (send request 3)&quot;,
<a name="16767"/>16767:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="16768"/>16768:                            ?SEV_AWAIT_CONTINUE(Tester, tester, send_req)
<a name="16769"/>16769:                    end},
<a name="16770"/>16770:          #{desc =&gt; &quot;send request 3 (to server)&quot;,
<a name="16771"/>16771:            cmd  =&gt; fun(#{sock := Sock, send := Send}) -&gt;
<a name="16772"/>16772:                            Send(Sock, ?BASIC_REQ)
<a name="16773"/>16773:                    end},
<a name="16774"/>16774:          #{desc =&gt; &quot;announce ready (send request 3)&quot;,
<a name="16775"/>16775:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="16776"/>16776:                            ?SEV_ANNOUNCE_READY(Tester, send_req),
<a name="16777"/>16777:                            ok
<a name="16778"/>16778:                    end},
<a name="16779"/>16779:          #{desc =&gt; &quot;await recv reply 3 (from server, wo passcred)&quot;,
<a name="16780"/>16780:            cmd  =&gt; fun(#{sock := Sock, recv := Recv}) -&gt;
<a name="16781"/>16781:                            case Recv(Sock) of
<a name="16782"/>16782:                                {ok, {[], ?BASIC_REP}} -&gt;
<a name="16783"/>16783:                                    ?SEV_IPRINT(&quot;received reply *without* &quot;
<a name="16784"/>16784:                                                &quot;passcred&quot;),
<a name="16785"/>16785:                                    ok;
<a name="16786"/>16786:                                {ok, {BadCMsgs, ?BASIC_REP}} -&gt;
<a name="16787"/>16787:                                    {error, {unexpected_reply_cmsgs,
<a name="16788"/>16788:                                             BadCMsgs}};
<a name="16789"/>16789:                                {ok, {[], BadData}} -&gt;
<a name="16790"/>16790:                                    {error, {unexpected_reply_data,
<a name="16791"/>16791:                                             BadData}};
<a name="16792"/>16792:                                {ok, BadReply} -&gt;
<a name="16793"/>16793:                                    {error, {unexpected_reply, BadReply}};
<a name="16794"/>16794:                                {error, _} = ERROR -&gt;
<a name="16795"/>16795:                                    ERROR
<a name="16796"/>16796:                            end
<a name="16797"/>16797:                    end},
<a name="16798"/>16798:          #{desc =&gt; &quot;announce ready 3 (recv reply)&quot;,
<a name="16799"/>16799:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="16800"/>16800:                            ?SEV_ANNOUNCE_READY(Tester, recv_reply),
<a name="16801"/>16801:                            ok
<a name="16802"/>16802:                    end},
<a name="16803"/>16803: 
<a name="16804"/>16804:          %% *** Termination ***
<a name="16805"/>16805:          #{desc =&gt; &quot;await terminate&quot;,
<a name="16806"/>16806:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="16807"/>16807:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="16808"/>16808:                                ok -&gt;
<a name="16809"/>16809:                                    {ok, maps:remove(tester, State)};
<a name="16810"/>16810:                                {error, _} = ERROR -&gt;
<a name="16811"/>16811:                                    ERROR
<a name="16812"/>16812:                            end
<a name="16813"/>16813:                    end},
<a name="16814"/>16814:          #{desc =&gt; &quot;close socket&quot;,
<a name="16815"/>16815:            cmd  =&gt; fun(#{domain   := local,
<a name="16816"/>16816:                          sock     := Sock,
<a name="16817"/>16817:                          local_sa := #{path := Path}} = State) -&gt;
<a name="16818"/>16818:                            ok = socket:close(Sock),
<a name="16819"/>16819:                            State1 =
<a name="16820"/>16820:                                unlink_path(Path,
<a name="16821"/>16821:                                            fun() -&gt;
<a name="16822"/>16822:                                                    maps:remove(local_sa, State)
<a name="16823"/>16823:                                            end,
<a name="16824"/>16824:                                            fun() -&gt; State end),
<a name="16825"/>16825:                            {ok, maps:remove(sock, State1)};
<a name="16826"/>16826:                       (#{sock := Sock} = State) -&gt;
<a name="16827"/>16827:                            ok = socket:close(Sock),
<a name="16828"/>16828:                            {ok, maps:remove(sock, State)}
<a name="16829"/>16829:                    end},
<a name="16830"/>16830: 
<a name="16831"/>16831:          %% *** We are done ***
<a name="16832"/>16832:          ?SEV_FINISH_NORMAL
<a name="16833"/>16833:         ],
<a name="16834"/>16834: 
<a name="16835"/>16835: 
<a name="16836"/>16836:     TesterSeq =
<a name="16837"/>16837:         [
<a name="16838"/>16838:          %% *** Init part ***
<a name="16839"/>16839:          #{desc =&gt; &quot;monitor server&quot;,
<a name="16840"/>16840:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="16841"/>16841:                            _MRef = erlang:monitor(process, Pid),
<a name="16842"/>16842:                            ok
<a name="16843"/>16843:                    end},
<a name="16844"/>16844:          #{desc =&gt; &quot;monitor client&quot;,
<a name="16845"/>16845:            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;
<a name="16846"/>16846:                            _MRef = erlang:monitor(process, Pid),
<a name="16847"/>16847:                            ok
<a name="16848"/>16848:                    end},
<a name="16849"/>16849: 
<a name="16850"/>16850:          %% Start the server
<a name="16851"/>16851:          #{desc =&gt; &quot;order server start&quot;,
<a name="16852"/>16852:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="16853"/>16853:                            ?SEV_ANNOUNCE_START(Pid),
<a name="16854"/>16854:                            ok
<a name="16855"/>16855:                    end},
<a name="16856"/>16856:          #{desc =&gt; &quot;await server ready (init)&quot;,
<a name="16857"/>16857:            cmd  =&gt; fun(#{server := Pid} = State) -&gt;
<a name="16858"/>16858:                            {ok, Port} = ?SEV_AWAIT_READY(Pid, server, init),
<a name="16859"/>16859:                            {ok, State#{server_port =&gt; Port}}
<a name="16860"/>16860:                    end},
<a name="16861"/>16861: 
<a name="16862"/>16862:          %% Start the client
<a name="16863"/>16863:          #{desc =&gt; &quot;order client start&quot;,
<a name="16864"/>16864:            cmd  =&gt; fun(#{client := Pid, server_port := Port} = _State) -&gt;
<a name="16865"/>16865:                            ?SEV_ANNOUNCE_START(Pid, Port),
<a name="16866"/>16866:                            ok
<a name="16867"/>16867:                    end},
<a name="16868"/>16868:          #{desc =&gt; &quot;await client ready (init)&quot;,
<a name="16869"/>16869:            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;
<a name="16870"/>16870:                            ok = ?SEV_AWAIT_READY(Pid, client, init)
<a name="16871"/>16871:                    end},
<a name="16872"/>16872: 
<a name="16873"/>16873:          %% *** The actual test ***
<a name="16874"/>16874:          #{desc =&gt; &quot;order server to continue (with accept)&quot;,
<a name="16875"/>16875:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="16876"/>16876:                            ?SEV_ANNOUNCE_CONTINUE(Server, accept),
<a name="16877"/>16877:                            ok
<a name="16878"/>16878:                    end},
<a name="16879"/>16879:          ?SEV_SLEEP(?SECS(1)),
<a name="16880"/>16880:          #{desc =&gt; &quot;order client to continue (with connect)&quot;,
<a name="16881"/>16881:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="16882"/>16882:                            ?SEV_ANNOUNCE_CONTINUE(Client, connect),
<a name="16883"/>16883:                            ok
<a name="16884"/>16884:                    end},
<a name="16885"/>16885:          #{desc =&gt; &quot;await client ready (connect)&quot;,
<a name="16886"/>16886:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="16887"/>16887:                            ?SEV_AWAIT_READY(Client, client, connect)
<a name="16888"/>16888:                    end},
<a name="16889"/>16889:          #{desc =&gt; &quot;await server ready (accept)&quot;,
<a name="16890"/>16890:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="16891"/>16891:                            ?SEV_AWAIT_READY(Server, server, accept)
<a name="16892"/>16892:                    end},
<a name="16893"/>16893: 
<a name="16894"/>16894:          %% *** First message (default=wo passcred) ***
<a name="16895"/>16895: 
<a name="16896"/>16896:          #{desc =&gt; &quot;order client to continue (with verify timestamp off)&quot;,
<a name="16897"/>16897:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="16898"/>16898:                            ?SEV_ANNOUNCE_CONTINUE(Client, verify_passcred),
<a name="16899"/>16899:                            ok
<a name="16900"/>16900:                    end},
<a name="16901"/>16901:          #{desc =&gt; &quot;await client ready (passcred off)&quot;,
<a name="16902"/>16902:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="16903"/>16903:                            ?SEV_AWAIT_READY(Client, client, passcred_off)
<a name="16904"/>16904:                    end},
<a name="16905"/>16905: 
<a name="16906"/>16906:          #{desc =&gt; &quot;order client to continue (with send request 1)&quot;,
<a name="16907"/>16907:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="16908"/>16908:                            ?SEV_ANNOUNCE_CONTINUE(Client, send_req),
<a name="16909"/>16909:                            ok
<a name="16910"/>16910:                    end},
<a name="16911"/>16911:          #{desc =&gt; &quot;await client ready (with send request 1)&quot;,
<a name="16912"/>16912:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="16913"/>16913:                            ?SEV_AWAIT_READY(Client, client, send_req)
<a name="16914"/>16914:                    end},
<a name="16915"/>16915:          #{desc =&gt; &quot;await server ready (request recv 1)&quot;,
<a name="16916"/>16916:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="16917"/>16917:                            ?SEV_AWAIT_READY(Server, server, recv_req)
<a name="16918"/>16918:                    end},
<a name="16919"/>16919:          #{desc =&gt; &quot;order server to continue (with send reply)&quot;,
<a name="16920"/>16920:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="16921"/>16921:                            ?SEV_ANNOUNCE_CONTINUE(Server, send_reply),
<a name="16922"/>16922:                            ok
<a name="16923"/>16923:                    end},
<a name="16924"/>16924:          #{desc =&gt; &quot;await server ready (with reply sent)&quot;,
<a name="16925"/>16925:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="16926"/>16926:                            ?SEV_AWAIT_READY(Server, server, send_reply)
<a name="16927"/>16927:                    end},
<a name="16928"/>16928:          #{desc =&gt; &quot;await client ready (reply recv)&quot;,
<a name="16929"/>16929:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="16930"/>16930:                            ?SEV_AWAIT_READY(Client, client, recv_reply)
<a name="16931"/>16931:                    end},
<a name="16932"/>16932: 
<a name="16933"/>16933:          %% Second message (w passcred)
<a name="16934"/>16934: 
<a name="16935"/>16935:          #{desc =&gt; &quot;order client to continue (with enable passcred)&quot;,
<a name="16936"/>16936:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="16937"/>16937:                            ?SEV_ANNOUNCE_CONTINUE(Client, enable_passcred),
<a name="16938"/>16938:                            ok
<a name="16939"/>16939:                    end},
<a name="16940"/>16940:          #{desc =&gt; &quot;await client ready (passcred on)&quot;,
<a name="16941"/>16941:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="16942"/>16942:                            ?SEV_AWAIT_READY(Client, client, passcred_on)
<a name="16943"/>16943:                    end},
<a name="16944"/>16944: 
<a name="16945"/>16945:          #{desc =&gt; &quot;order client to continue (with send request 2)&quot;,
<a name="16946"/>16946:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="16947"/>16947:                            ?SEV_ANNOUNCE_CONTINUE(Client, send_req),
<a name="16948"/>16948:                            ok
<a name="16949"/>16949:                    end},
<a name="16950"/>16950:          #{desc =&gt; &quot;await client ready (with send request 2)&quot;,
<a name="16951"/>16951:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="16952"/>16952:                            ?SEV_AWAIT_READY(Client, client, send_req)
<a name="16953"/>16953:                    end},
<a name="16954"/>16954:          #{desc =&gt; &quot;await server ready (request recv 2)&quot;,
<a name="16955"/>16955:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="16956"/>16956:                            ?SEV_AWAIT_READY(Server, server, recv_req)
<a name="16957"/>16957:                    end},
<a name="16958"/>16958:          #{desc =&gt; &quot;order server to continue (with send reply 2)&quot;,
<a name="16959"/>16959:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="16960"/>16960:                            ?SEV_ANNOUNCE_CONTINUE(Server, send_reply),
<a name="16961"/>16961:                            ok
<a name="16962"/>16962:                    end},
<a name="16963"/>16963:          #{desc =&gt; &quot;await server ready (with reply sent 2)&quot;,
<a name="16964"/>16964:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="16965"/>16965:                            ?SEV_AWAIT_READY(Server, server, send_reply)
<a name="16966"/>16966:                    end},
<a name="16967"/>16967:          #{desc =&gt; &quot;await client ready (reply recv 2)&quot;,
<a name="16968"/>16968:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="16969"/>16969:                            ?SEV_AWAIT_READY(Client, client, recv_reply)
<a name="16970"/>16970:                    end},
<a name="16971"/>16971: 
<a name="16972"/>16972:          %% Third message (wo passcred)
<a name="16973"/>16973: 
<a name="16974"/>16974:          #{desc =&gt; &quot;order client to continue (with disable passcred)&quot;,
<a name="16975"/>16975:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="16976"/>16976:                            ?SEV_ANNOUNCE_CONTINUE(Client, disable_passcred),
<a name="16977"/>16977:                            ok
<a name="16978"/>16978:                    end},
<a name="16979"/>16979:          #{desc =&gt; &quot;await client ready (passcred off)&quot;,
<a name="16980"/>16980:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="16981"/>16981:                            ?SEV_AWAIT_READY(Client, client, passcred_off)
<a name="16982"/>16982:                    end},
<a name="16983"/>16983: 
<a name="16984"/>16984:          #{desc =&gt; &quot;order client to continue (with send request 3)&quot;,
<a name="16985"/>16985:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="16986"/>16986:                            ?SEV_ANNOUNCE_CONTINUE(Client, send_req),
<a name="16987"/>16987:                            ok
<a name="16988"/>16988:                    end},
<a name="16989"/>16989:          #{desc =&gt; &quot;await client ready (with send request 3)&quot;,
<a name="16990"/>16990:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="16991"/>16991:                            ?SEV_AWAIT_READY(Client, client, send_req)
<a name="16992"/>16992:                    end},
<a name="16993"/>16993:          #{desc =&gt; &quot;await server ready (request recv 3)&quot;,
<a name="16994"/>16994:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="16995"/>16995:                            ?SEV_AWAIT_READY(Server, server, recv_req)
<a name="16996"/>16996:                    end},
<a name="16997"/>16997:          #{desc =&gt; &quot;order server to continue (with send reply 3)&quot;,
<a name="16998"/>16998:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="16999"/>16999:                            ?SEV_ANNOUNCE_CONTINUE(Server, send_reply),
<a name="17000"/>17000:                            ok
<a name="17001"/>17001:                    end},
<a name="17002"/>17002:          #{desc =&gt; &quot;await server ready (with reply sent 3)&quot;,
<a name="17003"/>17003:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="17004"/>17004:                            ?SEV_AWAIT_READY(Server, server, send_reply)
<a name="17005"/>17005:                    end},
<a name="17006"/>17006:          #{desc =&gt; &quot;await client ready (reply recv 3)&quot;,
<a name="17007"/>17007:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="17008"/>17008:                            ?SEV_AWAIT_READY(Client, client, recv_reply)
<a name="17009"/>17009:                    end},
<a name="17010"/>17010: 
<a name="17011"/>17011: 
<a name="17012"/>17012:          %% *** Termination ***
<a name="17013"/>17013:          #{desc =&gt; &quot;order client to terminate&quot;,
<a name="17014"/>17014:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="17015"/>17015:                            ?SEV_ANNOUNCE_TERMINATE(Client),
<a name="17016"/>17016:                            ok
<a name="17017"/>17017:                    end},
<a name="17018"/>17018:          #{desc =&gt; &quot;await client termination&quot;,
<a name="17019"/>17019:            cmd  =&gt; fun(#{client := Client} = State) -&gt;
<a name="17020"/>17020:                            ?SEV_AWAIT_TERMINATION(Client),
<a name="17021"/>17021:                            State1 = maps:remove(client, State),
<a name="17022"/>17022:                            {ok, State1}
<a name="17023"/>17023:                    end},
<a name="17024"/>17024:          #{desc =&gt; &quot;order server to terminate&quot;,
<a name="17025"/>17025:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="17026"/>17026:                            ?SEV_ANNOUNCE_TERMINATE(Server),
<a name="17027"/>17027:                            ok
<a name="17028"/>17028:                    end},
<a name="17029"/>17029:          #{desc =&gt; &quot;await server termination&quot;,
<a name="17030"/>17030:            cmd  =&gt; fun(#{server := Server} = State) -&gt;
<a name="17031"/>17031:                            ?SEV_AWAIT_TERMINATION(Server),
<a name="17032"/>17032:                            State1 = maps:remove(server, State),
<a name="17033"/>17033:                            {ok, State1}
<a name="17034"/>17034:                    end},
<a name="17035"/>17035: 
<a name="17036"/>17036:          %% *** We are done ***
<a name="17037"/>17037:          ?SEV_FINISH_NORMAL
<a name="17038"/>17038:         ],
<a name="17039"/>17039: 
<a name="17040"/>17040: 
<a name="17041"/>17041:     i(&quot;start server evaluator&quot;),
<a name="17042"/>17042:     Server = ?SEV_START(&quot;server&quot;, ServerSeq, InitState),
<a name="17043"/>17043: 
<a name="17044"/>17044:     i(&quot;start client evaluator&quot;),
<a name="17045"/>17045:     Client = ?SEV_START(&quot;client&quot;, ClientSeq, InitState),
<a name="17046"/>17046: 
<a name="17047"/>17047:     i(&quot;start tester evaluator&quot;),
<a name="17048"/>17048:     TesterInitState = #{server =&gt; Server#ev.pid,
<a name="17049"/>17049:                         client =&gt; Client#ev.pid},
<a name="17050"/>17050:     Tester = ?SEV_START(&quot;tester&quot;, TesterSeq, TesterInitState),
<a name="17051"/>17051: 
<a name="api_opt_sock_passcred_tcp-last_expr"/><a name="17052"/>17052: <b>    ok = ?SEV_AWAIT_FINISH</b>([Server, Client, Tester]).
<a name="17053"/>17053: 
<a name="17054"/>17054: 
<a name="17055"/>17055: 
<a name="17056"/>17056: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="17057"/>17057: 
<a name="17058"/>17058: <i>%% Tests the the peek-off socket option for a unix domain socket</i>
<a name="17059"/>17059: <i>%% (stream TCP in this case).</i>
<a name="17060"/>17060: <i>%%</i>
<a name="17061"/>17061: <i>%% THIS IS A PLACEHOLDER!!</i>
<a name="17062"/>17062: <i>%%</i>
<a name="17063"/>17063: <i>%%</i>
<a name="17064"/>17064: 
<a name="api_opt_sock_peek_off_tcpL-1"/><a name="17065"/>17065: <b>api_opt_sock_peek_off_tcpL</b>(_Config) when is_list(_Config) -&gt;
<a name="17066"/>17066:     ?TT(?SECS(5)),
<a name="api_opt_sock_peek_off_tcpL-last_expr"/><a name="17067"/>17067: <b>    tc_try</b>(api_opt_sock_peek_off_tcpL,
<a name="17068"/>17068:            fun() -&gt;
<a name="17069"/>17069:                    has_support_unix_domain_socket(),
<a name="17070"/>17070:                    has_support_sock_peek_off(),
<a name="17071"/>17071:                    has_support_msg_flag(peek)
<a name="17072"/>17072:            end,
<a name="17073"/>17073:            fun() -&gt;
<a name="17074"/>17074:                    Set  = fun(Sock, Val) when is_integer(Val) -&gt;
<a name="17075"/>17075:                                   socket:setopt(Sock, socket, peek_off, Val)
<a name="17076"/>17076:                           end,
<a name="17077"/>17077:                    Get  = fun(Sock) -&gt;
<a name="17078"/>17078:                                   socket:getopt(Sock, socket, peek_off)
<a name="17079"/>17079:                           end,
<a name="17080"/>17080:                    Send = fun(Sock, Data) -&gt;
<a name="17081"/>17081:                                   socket:send(Sock, Data)
<a name="17082"/>17082:                           end,
<a name="17083"/>17083:                    Recv = fun(Sock, L, false) -&gt;
<a name="17084"/>17084:                                   socket:recv(Sock, L);
<a name="17085"/>17085:                              (Sock, L, true) -&gt;
<a name="17086"/>17086:                                   socket:recv(Sock, L, [peek])
<a name="17087"/>17087:                           end,
<a name="17088"/>17088:                    InitState = #{domain =&gt; local,
<a name="17089"/>17089:                                  proto  =&gt; default, % Type = stream =&gt; tcp
<a name="17090"/>17090:                                  set    =&gt; Set,
<a name="17091"/>17091:                                  get    =&gt; Get,
<a name="17092"/>17092:                                  send   =&gt; Send,
<a name="17093"/>17093:                                  recv   =&gt; Recv},
<a name="17094"/>17094:                    ok = api_opt_sock_peek_off(InitState)
<a name="17095"/>17095:            end).
<a name="17096"/>17096: 
<a name="api_opt_sock_peek_off-1"/><a name="17097"/>17097: <b>api_opt_sock_peek_off</b>(InitState) -&gt;
<a name="17098"/>17098:     process_flag(trap_exit, true),
<a name="17099"/>17099:     ServerSeq = 
<a name="17100"/>17100:         [
<a name="17101"/>17101:          %% *** Wait for start order ***
<a name="17102"/>17102:          #{desc =&gt; &quot;await start (from tester)&quot;,
<a name="17103"/>17103:            cmd  =&gt; fun(State) -&gt;
<a name="17104"/>17104:                            Tester = ?SEV_AWAIT_START(),
<a name="17105"/>17105:                            {ok, State#{tester =&gt; Tester}}
<a name="17106"/>17106:                    end},
<a name="17107"/>17107:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="17108"/>17108:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="17109"/>17109:                            _MRef = erlang:monitor(process, Tester),
<a name="17110"/>17110:                            ok
<a name="17111"/>17111:                    end},
<a name="17112"/>17112: 
<a name="17113"/>17113:          %% *** Init part ***
<a name="17114"/>17114:          #{desc =&gt; &quot;which local address&quot;,
<a name="17115"/>17115:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="17116"/>17116:                            LSA = which_local_socket_addr(Domain),
<a name="17117"/>17117:                            {ok, State#{lsa =&gt; LSA}}
<a name="17118"/>17118:                    end},
<a name="17119"/>17119:          #{desc =&gt; &quot;create listen socket&quot;,
<a name="17120"/>17120:            cmd  =&gt; fun(#{domain := Domain,
<a name="17121"/>17121:                          proto  := Proto} = State) -&gt;
<a name="17122"/>17122:                            case socket:open(Domain, stream, Proto) of
<a name="17123"/>17123:                                {ok, Sock} -&gt;
<a name="17124"/>17124:                                    {ok, State#{lsock =&gt; Sock}};
<a name="17125"/>17125:                                {error, _} = ERROR -&gt;
<a name="17126"/>17126:                                    ERROR
<a name="17127"/>17127:                            end
<a name="17128"/>17128:                    end},
<a name="17129"/>17129:          #{desc =&gt; &quot;bind to local address&quot;,
<a name="17130"/>17130:            cmd  =&gt; fun(#{lsock := LSock,
<a name="17131"/>17131:                          lsa   := LSA} = _State) -&gt;
<a name="17132"/>17132:                            case sock_bind(LSock, LSA) of
<a name="17133"/>17133:                                ok -&gt;
<a name="17134"/>17134:                                    %% We do not care about the port for local
<a name="17135"/>17135:                                    ok;
<a name="17136"/>17136:                                {error, _} = ERROR -&gt;
<a name="17137"/>17137:                                    ERROR
<a name="17138"/>17138:                            end
<a name="17139"/>17139:                    end},
<a name="17140"/>17140:          #{desc =&gt; &quot;make listen socket&quot;,
<a name="17141"/>17141:            cmd  =&gt; fun(#{lsock := LSock}) -&gt;
<a name="17142"/>17142:                            socket:listen(LSock)
<a name="17143"/>17143:                    end},
<a name="17144"/>17144:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="17145"/>17145:            cmd  =&gt; fun(#{tester := Tester, lsa := #{path := Path}}) -&gt;
<a name="17146"/>17146:                            ?SEV_ANNOUNCE_READY(Tester, init, Path),
<a name="17147"/>17147:                            ok
<a name="17148"/>17148:                    end},
<a name="17149"/>17149: 
<a name="17150"/>17150:          #{desc =&gt; &quot;await continue (accept)&quot;,
<a name="17151"/>17151:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="17152"/>17152:                            ?SEV_AWAIT_CONTINUE(Tester, tester, accept)
<a name="17153"/>17153:                    end},
<a name="17154"/>17154:          #{desc =&gt; &quot;await connection&quot;,
<a name="17155"/>17155:            cmd  =&gt; fun(#{lsock := LSock} = State) -&gt;
<a name="17156"/>17156:                            case socket:accept(LSock) of
<a name="17157"/>17157:                                {ok, Sock} -&gt;
<a name="17158"/>17158:                                    ?SEV_IPRINT(&quot;accepted: ~n   ~p&quot;, [Sock]),
<a name="17159"/>17159:                                    {ok, State#{csock =&gt; Sock}};
<a name="17160"/>17160:                                {error, _} = ERROR -&gt;
<a name="17161"/>17161:                                    ERROR
<a name="17162"/>17162:                            end
<a name="17163"/>17163:                    end},
<a name="17164"/>17164:          #{desc =&gt; &quot;announce ready (accept)&quot;,
<a name="17165"/>17165:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="17166"/>17166:                            ?SEV_ANNOUNCE_READY(Tester, accept),
<a name="17167"/>17167:                            ok
<a name="17168"/>17168:                    end},
<a name="17169"/>17169: 
<a name="17170"/>17170: 
<a name="17171"/>17171:          %% The actual test
<a name="17172"/>17172: 
<a name="17173"/>17173:          %% 1) peek (0 = everything: 1,2,3,4,5,6,7,8)
<a name="17174"/>17174:          #{desc =&gt; &quot;1a: await continue (peek)&quot;,
<a name="17175"/>17175:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="17176"/>17176:                            ?SEV_AWAIT_CONTINUE(Tester, tester, peek)
<a name="17177"/>17177:                    end},
<a name="17178"/>17178:          #{desc =&gt; &quot;1a: peek read&quot;,
<a name="17179"/>17179:            cmd  =&gt; fun(#{csock := Sock,
<a name="17180"/>17180:                          recv  := Recv} = _State) -&gt;
<a name="17181"/>17181:                            case Recv(Sock, 0, true) of
<a name="17182"/>17182:                                {ok, &lt;&lt;1,2,3,4,5,6,7,8&gt;&gt;} -&gt;
<a name="17183"/>17183:                                    ?SEV_IPRINT(&quot;peek'ed expected data&quot;),
<a name="17184"/>17184:                                    ok;
<a name="17185"/>17185:                                {error, _} = ERROR -&gt;
<a name="17186"/>17186:                                    ERROR
<a name="17187"/>17187:                            end
<a name="17188"/>17188:                    end},
<a name="17189"/>17189:          #{desc =&gt; &quot;1a: announce ready (peek)&quot;,
<a name="17190"/>17190:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="17191"/>17191:                            ?SEV_ANNOUNCE_READY(Tester, peek),
<a name="17192"/>17192:                            ok
<a name="17193"/>17193:                    end},
<a name="17194"/>17194: 
<a name="17195"/>17195:          #{desc =&gt; &quot;1b: await continue (verify peek-off)&quot;,
<a name="17196"/>17196:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="17197"/>17197:                            ?SEV_AWAIT_CONTINUE(Tester, tester, verify_peek_off)
<a name="17198"/>17198:                    end},
<a name="17199"/>17199:          #{desc =&gt; &quot;1b: verify peek-off&quot;,
<a name="17200"/>17200:            cmd  =&gt; fun(#{csock := Sock,
<a name="17201"/>17201:                          get   := Get} = _State) -&gt;
<a name="17202"/>17202:                            case Get(Sock) of
<a name="17203"/>17203:                                {ok, DefaultPeekOff} -&gt;
<a name="17204"/>17204:                                    ?SEV_IPRINT(&quot;verify peek-off: ~w&quot;,
<a name="17205"/>17205:                                                [DefaultPeekOff]),
<a name="17206"/>17206:                                    ok;
<a name="17207"/>17207:                                {error, {not_supported, {socket, peek_off}}} -&gt;
<a name="17208"/>17208:                                    {skip, &quot;Not supported&quot;};
<a name="17209"/>17209:                                {error, _} = ERROR -&gt;
<a name="17210"/>17210:                                    ERROR
<a name="17211"/>17211:                            end
<a name="17212"/>17212:                    end},
<a name="17213"/>17213:          #{desc =&gt; &quot;1b: announce ready (verify peek-off)&quot;,
<a name="17214"/>17214:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="17215"/>17215:                            ?SEV_ANNOUNCE_READY(Tester, verify_peek_off),
<a name="17216"/>17216:                            ok
<a name="17217"/>17217:                    end},
<a name="17218"/>17218: 
<a name="17219"/>17219: 
<a name="17220"/>17220:          %% 2) set peek-off to 4
<a name="17221"/>17221:          #{desc =&gt; &quot;2a: await continue (set peek-off: 4)&quot;,
<a name="17222"/>17222:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="17223"/>17223:                            ?SEV_AWAIT_CONTINUE(Tester, tester, set_peek_off)
<a name="17224"/>17224:                    end},
<a name="17225"/>17225:          #{desc =&gt; &quot;2a: set peek-off: 4&quot;,
<a name="17226"/>17226:            cmd  =&gt; fun(#{csock := Sock,
<a name="17227"/>17227:                          set   := Set} = _State) -&gt;
<a name="17228"/>17228:                            case Set(Sock, 4) of
<a name="17229"/>17229:                                ok -&gt;
<a name="17230"/>17230:                                    ok;
<a name="17231"/>17231:                                {error, _} = ERROR -&gt;
<a name="17232"/>17232:                                    ERROR
<a name="17233"/>17233:                            end
<a name="17234"/>17234:                    end},
<a name="17235"/>17235:          #{desc =&gt; &quot;2a: announce ready (set peek-off: 4)&quot;,
<a name="17236"/>17236:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="17237"/>17237:                            ?SEV_ANNOUNCE_READY(Tester, set_peek_off),
<a name="17238"/>17238:                            ok
<a name="17239"/>17239:                    end},
<a name="17240"/>17240: 
<a name="17241"/>17241:          #{desc =&gt; &quot;2b: await continue (verify peek-off)&quot;,
<a name="17242"/>17242:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="17243"/>17243:                            ?SEV_AWAIT_CONTINUE(Tester, tester, verify_peek_off)
<a name="17244"/>17244:                    end},
<a name="17245"/>17245:          #{desc =&gt; &quot;2b: verify peek-off&quot;,
<a name="17246"/>17246:            cmd  =&gt; fun(#{csock := Sock,
<a name="17247"/>17247:                          get   := Get} = _State) -&gt;
<a name="17248"/>17248:                            case Get(Sock) of
<a name="17249"/>17249:                                {ok, 4 = PeekOff} -&gt;
<a name="17250"/>17250:                                    ?SEV_IPRINT(&quot;verify peek-off: ~w&quot;, [PeekOff]),
<a name="17251"/>17251:                                    ok;
<a name="17252"/>17252:                                {error, _} = ERROR -&gt;
<a name="17253"/>17253:                                    ERROR
<a name="17254"/>17254:                            end
<a name="17255"/>17255:                    end},
<a name="17256"/>17256:          #{desc =&gt; &quot;2b: announce ready (verify peek-off)&quot;,
<a name="17257"/>17257:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="17258"/>17258:                            ?SEV_ANNOUNCE_READY(Tester, verify_peek_off),
<a name="17259"/>17259:                            ok
<a name="17260"/>17260:                    end},
<a name="17261"/>17261: 
<a name="17262"/>17262: 
<a name="17263"/>17263:          %% 3) peek (0 = everything: 5,6,7,8)
<a name="17264"/>17264:          %%    NOTE THAT THIS WILL MOVE THE PEEK-OFF &quot;POINTER&quot; TO THE END OF 
<a name="17265"/>17265:          %%    THE *CURRENT* DATA POSITION IN THE BUFFER (READY FOR NEXT BATCH
<a name="17266"/>17266:          %%    OF DATA).
<a name="17267"/>17267:          #{desc =&gt; &quot;3a: await continue (peek)&quot;,
<a name="17268"/>17268:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="17269"/>17269:                            ?SEV_AWAIT_CONTINUE(Tester, tester, peek)
<a name="17270"/>17270:                    end},
<a name="17271"/>17271:          #{desc =&gt; &quot;3a: peek read&quot;,
<a name="17272"/>17272:            cmd  =&gt; fun(#{csock := Sock,
<a name="17273"/>17273:                          recv  := Recv} = _State) -&gt;
<a name="17274"/>17274:                            case Recv(Sock, 0, true) of
<a name="17275"/>17275:                                {ok, &lt;&lt;5,6,7,8&gt;&gt;} -&gt;
<a name="17276"/>17276:                                    ?SEV_IPRINT(&quot;peek'ed expected data&quot;),
<a name="17277"/>17277:                                    ok;
<a name="17278"/>17278:                                {error, _} = ERROR -&gt;
<a name="17279"/>17279:                                    ERROR
<a name="17280"/>17280:                            end
<a name="17281"/>17281:                    end},
<a name="17282"/>17282:          #{desc =&gt; &quot;3a: announce ready (peek)&quot;,
<a name="17283"/>17283:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="17284"/>17284:                            ?SEV_ANNOUNCE_READY(Tester, peek),
<a name="17285"/>17285:                            ok
<a name="17286"/>17286:                    end},
<a name="17287"/>17287: 
<a name="17288"/>17288:          #{desc =&gt; &quot;3b: await continue (verify peek-off)&quot;,
<a name="17289"/>17289:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="17290"/>17290:                            ?SEV_AWAIT_CONTINUE(Tester, tester, verify_peek_off)
<a name="17291"/>17291:                    end},
<a name="17292"/>17292:          #{desc =&gt; &quot;3b: verify peek-off&quot;,
<a name="17293"/>17293:            cmd  =&gt; fun(#{csock := Sock,
<a name="17294"/>17294:                          get   := Get} = _State) -&gt;
<a name="17295"/>17295:                            case Get(Sock) of
<a name="17296"/>17296:                                {ok, 8 = PeekOff} -&gt;
<a name="17297"/>17297:                                    ?SEV_IPRINT(&quot;verify peek-off: ~w&quot;, [PeekOff]),
<a name="17298"/>17298:                                    ok;
<a name="17299"/>17299:                                {error, _} = ERROR -&gt;
<a name="17300"/>17300:                                    ERROR
<a name="17301"/>17301:                            end
<a name="17302"/>17302:                    end},
<a name="17303"/>17303:          #{desc =&gt; &quot;3b: announce ready (verify peek-off)&quot;,
<a name="17304"/>17304:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="17305"/>17305:                            ?SEV_ANNOUNCE_READY(Tester, verify_peek_off),
<a name="17306"/>17306:                            ok
<a name="17307"/>17307:                    end},
<a name="17308"/>17308: 
<a name="17309"/>17309: 
<a name="17310"/>17310:          %% 4) read two byte(s): 1,2
<a name="17311"/>17311:          #{desc =&gt; &quot;4a: await continue (read 2 byte)&quot;,
<a name="17312"/>17312:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="17313"/>17313:                            ?SEV_AWAIT_CONTINUE(Tester, tester, read)
<a name="17314"/>17314:                    end},
<a name="17315"/>17315:          #{desc =&gt; &quot;4a: read (2 bytes)&quot;,
<a name="17316"/>17316:            cmd  =&gt; fun(#{csock := Sock,
<a name="17317"/>17317:                          recv  := Recv} = _State) -&gt;
<a name="17318"/>17318:                            case Recv(Sock, 2, false) of
<a name="17319"/>17319:                                {ok, &lt;&lt;1,2&gt;&gt;} -&gt;
<a name="17320"/>17320:                                    ?SEV_IPRINT(&quot;read expected data&quot;),
<a name="17321"/>17321:                                    ok;
<a name="17322"/>17322:                                {error, _} = ERROR -&gt;
<a name="17323"/>17323:                                    ERROR
<a name="17324"/>17324:                            end
<a name="17325"/>17325:                    end},
<a name="17326"/>17326:          #{desc =&gt; &quot;4a: announce ready (read)&quot;,
<a name="17327"/>17327:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="17328"/>17328:                            ?SEV_ANNOUNCE_READY(Tester, read),
<a name="17329"/>17329:                            ok
<a name="17330"/>17330:                    end},
<a name="17331"/>17331: 
<a name="17332"/>17332:          #{desc =&gt; &quot;4b: await continue (verify peek-off)&quot;,
<a name="17333"/>17333:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="17334"/>17334:                            ?SEV_AWAIT_CONTINUE(Tester, tester, verify_peek_off)
<a name="17335"/>17335:                    end},
<a name="17336"/>17336:          #{desc =&gt; &quot;4b: verify peek-off&quot;,
<a name="17337"/>17337:            cmd  =&gt; fun(#{csock := Sock,
<a name="17338"/>17338:                          get   := Get} = _State) -&gt;
<a name="17339"/>17339:                            case Get(Sock) of
<a name="17340"/>17340:                                {ok, 6 = PeekOff} -&gt;
<a name="17341"/>17341:                                    ?SEV_IPRINT(&quot;verify peek-off: ~w&quot;, [PeekOff]),
<a name="17342"/>17342:                                    ok;
<a name="17343"/>17343:                                {error, _} = ERROR -&gt;
<a name="17344"/>17344:                                    ERROR
<a name="17345"/>17345:                            end
<a name="17346"/>17346:                    end},
<a name="17347"/>17347:          #{desc =&gt; &quot;4b: announce ready (verify peek-off)&quot;,
<a name="17348"/>17348:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="17349"/>17349:                            ?SEV_ANNOUNCE_READY(Tester, verify_peek_off),
<a name="17350"/>17350:                            ok
<a name="17351"/>17351:                    end},
<a name="17352"/>17352: 
<a name="17353"/>17353: 
<a name="17354"/>17354:          %% 5) read the rest: 3,4,5,6,7,8)
<a name="17355"/>17355:          #{desc =&gt; &quot;5a: await continue (read the rest)&quot;,
<a name="17356"/>17356:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="17357"/>17357:                            ?SEV_AWAIT_CONTINUE(Tester, tester, read)
<a name="17358"/>17358:                    end},
<a name="17359"/>17359:          #{desc =&gt; &quot;5a: read (the rest)&quot;,
<a name="17360"/>17360:            cmd  =&gt; fun(#{csock := Sock,
<a name="17361"/>17361:                          recv  := Recv} = _State) -&gt;
<a name="17362"/>17362:                            case Recv(Sock, 0, false) of
<a name="17363"/>17363:                                {ok, &lt;&lt;3,4,5,6,7,8&gt;&gt;} -&gt;
<a name="17364"/>17364:                                    ?SEV_IPRINT(&quot;read expected data&quot;),
<a name="17365"/>17365:                                    ok;
<a name="17366"/>17366:                                {error, _} = ERROR -&gt;
<a name="17367"/>17367:                                    ERROR
<a name="17368"/>17368:                            end
<a name="17369"/>17369:                    end},
<a name="17370"/>17370:          #{desc =&gt; &quot;5a: announce ready (read)&quot;,
<a name="17371"/>17371:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="17372"/>17372:                            ?SEV_ANNOUNCE_READY(Tester, read),
<a name="17373"/>17373:                            ok
<a name="17374"/>17374:                    end},
<a name="17375"/>17375: 
<a name="17376"/>17376:          #{desc =&gt; &quot;5b: await continue (verify peek-off)&quot;,
<a name="17377"/>17377:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="17378"/>17378:                            ?SEV_AWAIT_CONTINUE(Tester, tester, verify_peek_off)
<a name="17379"/>17379:                    end},
<a name="17380"/>17380:          #{desc =&gt; &quot;5b: verify peek-off&quot;,
<a name="17381"/>17381:            cmd  =&gt; fun(#{csock := Sock,
<a name="17382"/>17382:                          get   := Get} = _State) -&gt;
<a name="17383"/>17383:                            case Get(Sock) of
<a name="17384"/>17384:                                {ok, PeekOff} -&gt;
<a name="17385"/>17385:                                    ?SEV_IPRINT(&quot;verify peek-off: ~w&quot;, [PeekOff]),
<a name="17386"/>17386:                                    ok;
<a name="17387"/>17387:                                {error, _} = ERROR -&gt;
<a name="17388"/>17388:                                    ERROR
<a name="17389"/>17389:                            end
<a name="17390"/>17390:                    end},
<a name="17391"/>17391:          #{desc =&gt; &quot;5b: announce ready (verify peek-off)&quot;,
<a name="17392"/>17392:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="17393"/>17393:                            ?SEV_ANNOUNCE_READY(Tester, verify_peek_off),
<a name="17394"/>17394:                            ok
<a name="17395"/>17395:                    end},
<a name="17396"/>17396: 
<a name="17397"/>17397: 
<a name="17398"/>17398:          %% *** Termination ***
<a name="17399"/>17399:          #{desc =&gt; &quot;await terminate&quot;,
<a name="17400"/>17400:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="17401"/>17401:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="17402"/>17402:                                ok -&gt;
<a name="17403"/>17403:                                    {ok, maps:remove(tester, State)};
<a name="17404"/>17404:                                {error, _} = ERROR -&gt;
<a name="17405"/>17405:                                    ERROR
<a name="17406"/>17406:                            end
<a name="17407"/>17407:                    end},
<a name="17408"/>17408:          #{desc =&gt; &quot;close connection socket&quot;,
<a name="17409"/>17409:            cmd  =&gt; fun(#{csock := Sock} = State) -&gt;
<a name="17410"/>17410:                            ok = socket:close(Sock),
<a name="17411"/>17411:                            {ok, maps:remove(csock, State)}
<a name="17412"/>17412:                    end},
<a name="17413"/>17413:          #{desc =&gt; &quot;close listen socket&quot;,
<a name="17414"/>17414:            cmd  =&gt; fun(#{lsock := Sock,
<a name="17415"/>17415:                          lsa   := #{path := Path}} = State) -&gt;
<a name="17416"/>17416:                            ok = socket:close(Sock),
<a name="17417"/>17417:                            State1 =
<a name="17418"/>17418:                                unlink_path(Path,
<a name="17419"/>17419:                                            fun() -&gt;
<a name="17420"/>17420:                                                    maps:remove(local_sa, State)
<a name="17421"/>17421:                                            end,
<a name="17422"/>17422:                                            fun() -&gt; State end),
<a name="17423"/>17423:                            {ok, maps:remove(lsock, State1)}
<a name="17424"/>17424:                    end},
<a name="17425"/>17425: 
<a name="17426"/>17426:          %% *** We are done ***
<a name="17427"/>17427:          ?SEV_FINISH_NORMAL
<a name="17428"/>17428:         ],
<a name="17429"/>17429: 
<a name="17430"/>17430:     ClientSeq = 
<a name="17431"/>17431:         [
<a name="17432"/>17432:          %% *** Wait for start order ***
<a name="17433"/>17433:          #{desc =&gt; &quot;await start (from tester)&quot;,
<a name="17434"/>17434:            cmd  =&gt; fun(#{domain := local} = State) -&gt;
<a name="17435"/>17435:                            {Tester, Path} = ?SEV_AWAIT_START(),
<a name="17436"/>17436:                            {ok, State#{tester =&gt; Tester, server_path =&gt; Path}}
<a name="17437"/>17437:                    end},
<a name="17438"/>17438:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="17439"/>17439:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="17440"/>17440:                            _MRef = erlang:monitor(process, Tester),
<a name="17441"/>17441:                            ok
<a name="17442"/>17442:                    end},
<a name="17443"/>17443: 
<a name="17444"/>17444:          %% *** The init part ***
<a name="17445"/>17445:          #{desc =&gt; &quot;which server (local) address&quot;,
<a name="17446"/>17446:            cmd  =&gt; fun(#{domain      := local = Domain,
<a name="17447"/>17447:                          server_path := Path} = State) -&gt;
<a name="17448"/>17448:                            LSA = which_local_socket_addr(Domain),
<a name="17449"/>17449:                            SSA = #{family =&gt; Domain, path =&gt; Path},
<a name="17450"/>17450:                            {ok, State#{local_sa =&gt; LSA, server_sa =&gt; SSA}}
<a name="17451"/>17451:                    end},
<a name="17452"/>17452:          #{desc =&gt; &quot;create socket&quot;,
<a name="17453"/>17453:            cmd  =&gt; fun(#{domain := Domain,
<a name="17454"/>17454:                          proto  := Proto} = State) -&gt;
<a name="17455"/>17455:                            case socket:open(Domain, stream, Proto) of
<a name="17456"/>17456:                                {ok, Sock} -&gt;
<a name="17457"/>17457:                                    {ok, State#{sock =&gt; Sock}};
<a name="17458"/>17458:                                {error, _} = ERROR -&gt;
<a name="17459"/>17459:                                    ERROR
<a name="17460"/>17460:                            end
<a name="17461"/>17461:                    end},
<a name="17462"/>17462:          #{desc =&gt; &quot;bind to local address&quot;,
<a name="17463"/>17463:            cmd  =&gt; fun(#{sock := Sock, local_sa := LSA} = _State) -&gt;
<a name="17464"/>17464:                            case sock_bind(Sock, LSA) of
<a name="17465"/>17465:                                ok -&gt;
<a name="17466"/>17466:                                    ok;
<a name="17467"/>17467:                                {error, _} = ERROR -&gt;
<a name="17468"/>17468:                                    ERROR
<a name="17469"/>17469:                            end
<a name="17470"/>17470:                    end},
<a name="17471"/>17471:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="17472"/>17472:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="17473"/>17473:                            ?SEV_ANNOUNCE_READY(Tester, init),
<a name="17474"/>17474:                            ok
<a name="17475"/>17475:                    end},
<a name="17476"/>17476: 
<a name="17477"/>17477:          #{desc =&gt; &quot;await continue (connect)&quot;,
<a name="17478"/>17478:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="17479"/>17479:                            ?SEV_AWAIT_CONTINUE(Tester, tester, connect)
<a name="17480"/>17480:                    end},
<a name="17481"/>17481:          #{desc =&gt; &quot;connect to server&quot;,
<a name="17482"/>17482:            cmd  =&gt; fun(#{sock := Sock, server_sa := SSA}) -&gt;
<a name="17483"/>17483:                            socket:connect(Sock, SSA)
<a name="17484"/>17484:                    end},
<a name="17485"/>17485:          #{desc =&gt; &quot;announce ready (connect)&quot;,
<a name="17486"/>17486:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="17487"/>17487:                            ?SEV_ANNOUNCE_READY(Tester, connect),
<a name="17488"/>17488:                            ok
<a name="17489"/>17489:                    end},
<a name="17490"/>17490: 
<a name="17491"/>17491: 
<a name="17492"/>17492:          %% *** The actual test ***
<a name="17493"/>17493:          #{desc =&gt; &quot;await continue (send data)&quot;,
<a name="17494"/>17494:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="17495"/>17495:                            ?SEV_AWAIT_CONTINUE(Tester, tester, send_data)
<a name="17496"/>17496:                    end},
<a name="17497"/>17497:          #{desc =&gt; &quot;send data (to server)&quot;,
<a name="17498"/>17498:            cmd  =&gt; fun(#{sock := Sock, send := Send}) -&gt;
<a name="17499"/>17499:                            Send(Sock, &lt;&lt;1:8/integer,
<a name="17500"/>17500:                                         2:8/integer,
<a name="17501"/>17501:                                         3:8/integer,
<a name="17502"/>17502:                                         4:8/integer,
<a name="17503"/>17503:                                         5:8/integer,
<a name="17504"/>17504:                                         6:8/integer,
<a name="17505"/>17505:                                         7:8/integer,
<a name="17506"/>17506:                                         8:8/integer&gt;&gt;)
<a name="17507"/>17507:                    end},
<a name="17508"/>17508:          #{desc =&gt; &quot;announce ready (send data)&quot;,
<a name="17509"/>17509:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="17510"/>17510:                            ?SEV_ANNOUNCE_READY(Tester, send_data),
<a name="17511"/>17511:                            ok
<a name="17512"/>17512:                    end},
<a name="17513"/>17513: 
<a name="17514"/>17514:          %% *** Termination ***
<a name="17515"/>17515:          #{desc =&gt; &quot;await terminate&quot;,
<a name="17516"/>17516:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="17517"/>17517:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="17518"/>17518:                                ok -&gt;
<a name="17519"/>17519:                                    {ok, maps:remove(tester, State)};
<a name="17520"/>17520:                                {error, _} = ERROR -&gt;
<a name="17521"/>17521:                                    ERROR
<a name="17522"/>17522:                            end
<a name="17523"/>17523:                    end},
<a name="17524"/>17524:          #{desc =&gt; &quot;close socket&quot;,
<a name="17525"/>17525:            cmd  =&gt; fun(#{sock     := Sock,
<a name="17526"/>17526:                          local_sa := #{path := Path}} = State) -&gt;
<a name="17527"/>17527:                            ok = socket:close(Sock),
<a name="17528"/>17528:                            State1 =
<a name="17529"/>17529:                                unlink_path(Path,
<a name="17530"/>17530:                                            fun() -&gt;
<a name="17531"/>17531:                                                    maps:remove(local_sa, State)
<a name="17532"/>17532:                                            end,
<a name="17533"/>17533:                                            fun() -&gt; State end),
<a name="17534"/>17534:                            {ok, maps:remove(sock, State1)}
<a name="17535"/>17535:                    end},
<a name="17536"/>17536: 
<a name="17537"/>17537:          %% *** We are done ***
<a name="17538"/>17538:          ?SEV_FINISH_NORMAL
<a name="17539"/>17539:         ],
<a name="17540"/>17540: 
<a name="17541"/>17541:     TesterSeq =
<a name="17542"/>17542:         [
<a name="17543"/>17543:          %% *** Init part ***
<a name="17544"/>17544:          #{desc =&gt; &quot;monitor server&quot;,
<a name="17545"/>17545:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="17546"/>17546:                            _MRef = erlang:monitor(process, Pid),
<a name="17547"/>17547:                            ok
<a name="17548"/>17548:                    end},
<a name="17549"/>17549:          #{desc =&gt; &quot;monitor client&quot;,
<a name="17550"/>17550:            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;
<a name="17551"/>17551:                            _MRef = erlang:monitor(process, Pid),
<a name="17552"/>17552:                            ok
<a name="17553"/>17553:                    end},
<a name="17554"/>17554: 
<a name="17555"/>17555:          %% Start the server
<a name="17556"/>17556:          #{desc =&gt; &quot;order server start&quot;,
<a name="17557"/>17557:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="17558"/>17558:                            ?SEV_ANNOUNCE_START(Pid),
<a name="17559"/>17559:                            ok
<a name="17560"/>17560:                    end},
<a name="17561"/>17561:          #{desc =&gt; &quot;await server ready (init)&quot;,
<a name="17562"/>17562:            cmd  =&gt; fun(#{server := Pid} = State) -&gt;
<a name="17563"/>17563:                            {ok, Port} = ?SEV_AWAIT_READY(Pid, server, init),
<a name="17564"/>17564:                            {ok, State#{server_port =&gt; Port}}
<a name="17565"/>17565:                    end},
<a name="17566"/>17566: 
<a name="17567"/>17567:          %% Start the client
<a name="17568"/>17568:          #{desc =&gt; &quot;order client start&quot;,
<a name="17569"/>17569:            cmd  =&gt; fun(#{client := Pid, server_port := Port} = _State) -&gt;
<a name="17570"/>17570:                            ?SEV_ANNOUNCE_START(Pid, Port),
<a name="17571"/>17571:                            ok
<a name="17572"/>17572:                    end},
<a name="17573"/>17573:          #{desc =&gt; &quot;await client ready (init)&quot;,
<a name="17574"/>17574:            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;
<a name="17575"/>17575:                            ok = ?SEV_AWAIT_READY(Pid, client, init)
<a name="17576"/>17576:                    end},
<a name="17577"/>17577: 
<a name="17578"/>17578:          %% Establish the connection
<a name="17579"/>17579:          #{desc =&gt; &quot;order server to continue (with accept)&quot;,
<a name="17580"/>17580:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="17581"/>17581:                            ?SEV_ANNOUNCE_CONTINUE(Server, accept),
<a name="17582"/>17582:                            ok
<a name="17583"/>17583:                    end},
<a name="17584"/>17584:          #{desc =&gt; &quot;order client to continue (with connect)&quot;,
<a name="17585"/>17585:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="17586"/>17586:                            ?SEV_ANNOUNCE_CONTINUE(Client, connect),
<a name="17587"/>17587:                            ok
<a name="17588"/>17588:                    end},
<a name="17589"/>17589:          #{desc =&gt; &quot;await client ready (connect)&quot;,
<a name="17590"/>17590:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="17591"/>17591:                            ?SEV_AWAIT_READY(Client, client, connect)
<a name="17592"/>17592:                    end},
<a name="17593"/>17593:          #{desc =&gt; &quot;await server ready (accept)&quot;,
<a name="17594"/>17594:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="17595"/>17595:                            ?SEV_AWAIT_READY(Server, server, accept)
<a name="17596"/>17596:                    end},
<a name="17597"/>17597: 
<a name="17598"/>17598: 
<a name="17599"/>17599:          %% *** The actual test ***
<a name="17600"/>17600:          #{desc =&gt; &quot;order client to continue (with send data)&quot;,
<a name="17601"/>17601:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="17602"/>17602:                            ?SEV_ANNOUNCE_CONTINUE(Client, send_data),
<a name="17603"/>17603:                            ok
<a name="17604"/>17604:                    end},
<a name="17605"/>17605:          #{desc =&gt; &quot;await client ready (with send data)&quot;,
<a name="17606"/>17606:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="17607"/>17607:                            ?SEV_AWAIT_READY(Client, client, send_data)
<a name="17608"/>17608:                    end},
<a name="17609"/>17609: 
<a name="17610"/>17610:          %% There is no way to be sure that the data has actually arrived,
<a name="17611"/>17611:          %% and with no data on the server side, the peek will fail.
<a name="17612"/>17612:          %% Hopefully a sleep will take care of this...
<a name="17613"/>17613:          ?SEV_SLEEP(?SECS(1)),
<a name="17614"/>17614: 
<a name="17615"/>17615:          %% 1) peek
<a name="17616"/>17616:          #{desc =&gt; &quot;1a: order server to continue (peek)&quot;,
<a name="17617"/>17617:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="17618"/>17618:                            ?SEV_ANNOUNCE_CONTINUE(Server, peek),
<a name="17619"/>17619:                            ok
<a name="17620"/>17620:                    end},
<a name="17621"/>17621:          #{desc =&gt; &quot;1a: await server ready (peek)&quot;,
<a name="17622"/>17622:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="17623"/>17623:                            ?SEV_AWAIT_READY(Server, server, peek)
<a name="17624"/>17624:                    end},
<a name="17625"/>17625: 
<a name="17626"/>17626:          #{desc =&gt; &quot;1b: order server to continue (verify peek-off)&quot;,
<a name="17627"/>17627:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="17628"/>17628:                            ?SEV_ANNOUNCE_CONTINUE(Server, verify_peek_off),
<a name="17629"/>17629:                            ok
<a name="17630"/>17630:                    end},
<a name="17631"/>17631:          #{desc =&gt; &quot;1b: await server ready (verify peek-off)&quot;,
<a name="17632"/>17632:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="17633"/>17633:                            ?SEV_AWAIT_READY(Server, server, verify_peek_off)
<a name="17634"/>17634:                    end},
<a name="17635"/>17635: 
<a name="17636"/>17636: 
<a name="17637"/>17637:          %% 2) set peek-off
<a name="17638"/>17638:          #{desc =&gt; &quot;2a: order server to continue (set peek-off)&quot;,
<a name="17639"/>17639:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="17640"/>17640:                            ?SEV_ANNOUNCE_CONTINUE(Server, set_peek_off),
<a name="17641"/>17641:                            ok
<a name="17642"/>17642:                    end},
<a name="17643"/>17643:          #{desc =&gt; &quot;2a: await server ready (set peek-off)&quot;,
<a name="17644"/>17644:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="17645"/>17645:                            ?SEV_AWAIT_READY(Server, server, set_peek_off)
<a name="17646"/>17646:                    end},
<a name="17647"/>17647: 
<a name="17648"/>17648:          #{desc =&gt; &quot;2b: order server to continue (verify peek-off)&quot;,
<a name="17649"/>17649:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="17650"/>17650:                            ?SEV_ANNOUNCE_CONTINUE(Server, verify_peek_off),
<a name="17651"/>17651:                            ok
<a name="17652"/>17652:                    end},
<a name="17653"/>17653:          #{desc =&gt; &quot;2b: await server ready (verify peek-off)&quot;,
<a name="17654"/>17654:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="17655"/>17655:                            ?SEV_AWAIT_READY(Server, server, verify_peek_off)
<a name="17656"/>17656:                    end},
<a name="17657"/>17657: 
<a name="17658"/>17658: 
<a name="17659"/>17659: 
<a name="17660"/>17660:          %% 3) peek
<a name="17661"/>17661:          #{desc =&gt; &quot;3a: order server to continue (peek)&quot;,
<a name="17662"/>17662:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="17663"/>17663:                            ?SEV_ANNOUNCE_CONTINUE(Server, peek),
<a name="17664"/>17664:                            ok
<a name="17665"/>17665:                    end},
<a name="17666"/>17666:          #{desc =&gt; &quot;3a: await server ready (peek)&quot;,
<a name="17667"/>17667:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="17668"/>17668:                            ?SEV_AWAIT_READY(Server, server, peek)
<a name="17669"/>17669:                    end},
<a name="17670"/>17670: 
<a name="17671"/>17671:          #{desc =&gt; &quot;3b: order server to continue (verify peek-off)&quot;,
<a name="17672"/>17672:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="17673"/>17673:                            ?SEV_ANNOUNCE_CONTINUE(Server, verify_peek_off),
<a name="17674"/>17674:                            ok
<a name="17675"/>17675:                    end},
<a name="17676"/>17676:          #{desc =&gt; &quot;3b: await server ready (verify peek-off)&quot;,
<a name="17677"/>17677:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="17678"/>17678:                            ?SEV_AWAIT_READY(Server, server, verify_peek_off)
<a name="17679"/>17679:                    end},
<a name="17680"/>17680: 
<a name="17681"/>17681: 
<a name="17682"/>17682: 
<a name="17683"/>17683:          %% 4) read part
<a name="17684"/>17684:          #{desc =&gt; &quot;4a: order server to continue (read part)&quot;,
<a name="17685"/>17685:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="17686"/>17686:                            ?SEV_ANNOUNCE_CONTINUE(Server, read),
<a name="17687"/>17687:                            ok
<a name="17688"/>17688:                    end},
<a name="17689"/>17689:          #{desc =&gt; &quot;4a: await server ready (peek)&quot;,
<a name="17690"/>17690:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="17691"/>17691:                            ?SEV_AWAIT_READY(Server, server, read)
<a name="17692"/>17692:                    end},
<a name="17693"/>17693: 
<a name="17694"/>17694:          #{desc =&gt; &quot;4b: order server to continue (verify peek-off)&quot;,
<a name="17695"/>17695:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="17696"/>17696:                            ?SEV_ANNOUNCE_CONTINUE(Server, verify_peek_off),
<a name="17697"/>17697:                            ok
<a name="17698"/>17698:                    end},
<a name="17699"/>17699:          #{desc =&gt; &quot;4b: await server ready (verify peek-off)&quot;,
<a name="17700"/>17700:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="17701"/>17701:                            ?SEV_AWAIT_READY(Server, server, verify_peek_off)
<a name="17702"/>17702:                    end},
<a name="17703"/>17703: 
<a name="17704"/>17704: 
<a name="17705"/>17705:          %% 5) read (the rest)
<a name="17706"/>17706:          #{desc =&gt; &quot;5a: order server to continue (read the rest)&quot;,
<a name="17707"/>17707:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="17708"/>17708:                            ?SEV_ANNOUNCE_CONTINUE(Server, read),
<a name="17709"/>17709:                            ok
<a name="17710"/>17710:                    end},
<a name="17711"/>17711:          #{desc =&gt; &quot;5a: await server ready (peek)&quot;,
<a name="17712"/>17712:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="17713"/>17713:                            ?SEV_AWAIT_READY(Server, server, read)
<a name="17714"/>17714:                    end},
<a name="17715"/>17715: 
<a name="17716"/>17716:          #{desc =&gt; &quot;5b: order server to continue (verify peek-off)&quot;,
<a name="17717"/>17717:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="17718"/>17718:                            ?SEV_ANNOUNCE_CONTINUE(Server, verify_peek_off),
<a name="17719"/>17719:                            ok
<a name="17720"/>17720:                    end},
<a name="17721"/>17721:          #{desc =&gt; &quot;5b: await server ready (verify peek-off)&quot;,
<a name="17722"/>17722:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="17723"/>17723:                            ?SEV_AWAIT_READY(Server, server, verify_peek_off)
<a name="17724"/>17724:                    end},
<a name="17725"/>17725: 
<a name="17726"/>17726: 
<a name="17727"/>17727:          %% *** Termination ***
<a name="17728"/>17728:          #{desc =&gt; &quot;order client to terminate&quot;,
<a name="17729"/>17729:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="17730"/>17730:                            ?SEV_ANNOUNCE_TERMINATE(Client),
<a name="17731"/>17731:                            ok
<a name="17732"/>17732:                    end},
<a name="17733"/>17733:          #{desc =&gt; &quot;await client termination&quot;,
<a name="17734"/>17734:            cmd  =&gt; fun(#{client := Client} = State) -&gt;
<a name="17735"/>17735:                            ?SEV_AWAIT_TERMINATION(Client),
<a name="17736"/>17736:                            State1 = maps:remove(client, State),
<a name="17737"/>17737:                            {ok, State1}
<a name="17738"/>17738:                    end},
<a name="17739"/>17739:          #{desc =&gt; &quot;order server to terminate&quot;,
<a name="17740"/>17740:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="17741"/>17741:                            ?SEV_ANNOUNCE_TERMINATE(Server),
<a name="17742"/>17742:                            ok
<a name="17743"/>17743:                    end},
<a name="17744"/>17744:          #{desc =&gt; &quot;await server termination&quot;,
<a name="17745"/>17745:            cmd  =&gt; fun(#{server := Server} = State) -&gt;
<a name="17746"/>17746:                            ?SEV_AWAIT_TERMINATION(Server),
<a name="17747"/>17747:                            State1 = maps:remove(server, State),
<a name="17748"/>17748:                            {ok, State1}
<a name="17749"/>17749:                    end},
<a name="17750"/>17750: 
<a name="17751"/>17751:          %% *** We are done ***
<a name="17752"/>17752:          ?SEV_FINISH_NORMAL
<a name="17753"/>17753:         ],
<a name="17754"/>17754: 
<a name="17755"/>17755:     i(&quot;start server evaluator&quot;),
<a name="17756"/>17756:     Server = ?SEV_START(&quot;server&quot;, ServerSeq, InitState),
<a name="17757"/>17757: 
<a name="17758"/>17758:     i(&quot;start client evaluator&quot;),
<a name="17759"/>17759:     Client = ?SEV_START(&quot;client&quot;, ClientSeq, InitState),
<a name="17760"/>17760:     i(&quot;await evaluator(s)&quot;),
<a name="17761"/>17761: 
<a name="17762"/>17762:     i(&quot;start tester evaluator&quot;),
<a name="17763"/>17763:     TesterInitState = #{server =&gt; Server#ev.pid,
<a name="17764"/>17764:                         client =&gt; Client#ev.pid},
<a name="17765"/>17765:     Tester = ?SEV_START(&quot;tester&quot;, TesterSeq, TesterInitState),
<a name="17766"/>17766: 
<a name="api_opt_sock_peek_off-last_expr"/><a name="17767"/>17767: <b>    ok = ?SEV_AWAIT_FINISH</b>([Server, Client, Tester]).
<a name="17768"/>17768: 
<a name="17769"/>17769: 
<a name="17770"/>17770: 
<a name="17771"/>17771: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="17772"/>17772: 
<a name="17773"/>17773: <i>%% Tests that we get the peer credentials for a connected unix domain</i>
<a name="17774"/>17774: <i>%% TCP (stream) socket.</i>
<a name="17775"/>17775: <i>%% That is, all we need to do is to create a node, and have </i>
<a name="17776"/>17776: <i>%% process connect from that to a local (unix domain socket) socket.</i>
<a name="17777"/>17777: <i>%%</i>
<a name="17778"/>17778: <i>%% THIS IS A PLACEHOLDER!!</i>
<a name="17779"/>17779: <i>%%</i>
<a name="17780"/>17780: <i>%% We need to figure out what the ucred structure looks like,</i>
<a name="17781"/>17781: <i>%% and decode it...</i>
<a name="17782"/>17782: <i>%%</i>
<a name="17783"/>17783: 
<a name="api_opt_sock_peercred_tcpL-1"/><a name="17784"/>17784: <b>api_opt_sock_peercred_tcpL</b>(_Config) when is_list(_Config) -&gt;
<a name="17785"/>17785:     ?TT(?SECS(5)),
<a name="api_opt_sock_peercred_tcpL-last_expr"/><a name="17786"/>17786: <b>    tc_try</b>(api_opt_sock_peercred_tcpL,
<a name="17787"/>17787:            fun() -&gt;
<a name="17788"/>17788:                    has_support_unix_domain_socket(),
<a name="17789"/>17789:                    has_support_sock_peercred(),
<a name="17790"/>17790:                    not_yet_implemented()
<a name="17791"/>17791:            end,
<a name="17792"/>17792:            fun() -&gt;
<a name="17793"/>17793:                    Get  = fun(Sock) -&gt;
<a name="17794"/>17794:                                   socket:getopt(Sock, socket, peercred)
<a name="17795"/>17795:                           end,
<a name="17796"/>17796:                    InitState = #{domain =&gt; local,
<a name="17797"/>17797:                                  proto  =&gt; default, % Type = stream =&gt; tcp
<a name="17798"/>17798:                                  get    =&gt; Get},
<a name="17799"/>17799:                    ok = api_opt_sock_peercred_tcp(InitState)
<a name="17800"/>17800:            end).
<a name="17801"/>17801: 
<a name="17802"/>17802: 
<a name="api_opt_sock_peercred_tcp-1"/><a name="17803"/>17803: <b>api_opt_sock_peercred_tcp</b>(_InitState) -&gt;
<a name="17804"/>17804:     %% ServerSeq =
<a name="17805"/>17805:     %%     [
<a name="17806"/>17806:     %%      %% *** Wait for start order part ***
<a name="17807"/>17807:     %%      #{desc =&gt; &quot;await start (from tester)&quot;,
<a name="17808"/>17808:     %%        cmd  =&gt; fun(State) -&gt;
<a name="17809"/>17809:     %%                        {Tester, Backlog} = ?SEV_AWAIT_START(),
<a name="17810"/>17810:     %%                        {ok, State#{tester  =&gt; Tester,
<a name="17811"/>17811:     %%                                    backlog =&gt; Backlog}}
<a name="17812"/>17812:     %%                end},
<a name="17813"/>17813:     %%      #{desc =&gt; &quot;monitor tester&quot;,
<a name="17814"/>17814:     %%        cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="17815"/>17815:     %%                        _MRef = erlang:monitor(process, Tester),
<a name="17816"/>17816:     %%                        ok
<a name="17817"/>17817:     %%                end},
<a name="17818"/>17818: 
<a name="17819"/>17819:     %%      %% *** Init part ***
<a name="17820"/>17820:     %%      #{desc =&gt; &quot;which local address&quot;,
<a name="17821"/>17821:     %%        cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="17822"/>17822:     %%                        LSA = which_local_socket_addr(Domain),
<a name="17823"/>17823:     %%                        {ok, State#{lsa =&gt; LSA}}
<a name="17824"/>17824:     %%                end},
<a name="17825"/>17825:     %%      #{desc =&gt; &quot;create listen socket&quot;,
<a name="17826"/>17826:     %%        cmd  =&gt; fun(#{domain := Domain, proto := Proto} = State) -&gt;
<a name="17827"/>17827:     %%                        case socket:open(Domain, stream, Proto) of
<a name="17828"/>17828:     %%                            {ok, Sock} -&gt;
<a name="17829"/>17829:     %%                                {ok, State#{lsock =&gt; Sock}};
<a name="17830"/>17830:     %%                            {error, _} = ERROR -&gt;
<a name="17831"/>17831:     %%                                ERROR
<a name="17832"/>17832:     %%                        end
<a name="17833"/>17833:     %%                end},
<a name="17834"/>17834:     %%      #{desc =&gt; &quot;bind to local address&quot;,
<a name="17835"/>17835:     %%        cmd  =&gt; fun(#{domain := local,
<a name="17836"/>17836:     %%                      lsock  := LSock,
<a name="17837"/>17837:     %%                      lsa    := LSA} = _State) -&gt;
<a name="17838"/>17838:     %%                        case socket:bind(LSock, LSA) of
<a name="17839"/>17839:     %%                            ok -&gt;
<a name="17840"/>17840:     %%                                ok;
<a name="17841"/>17841:     %%                            {error, _} = ERROR -&gt;
<a name="17842"/>17842:     %%                                ERROR
<a name="17843"/>17843:     %%                        end
<a name="17844"/>17844:     %%                end},
<a name="17845"/>17845:     %%      #{desc =&gt; &quot;make listen socket&quot;,
<a name="17846"/>17846:     %%        cmd  =&gt; fun(#{lsock := LSock}) -&gt;
<a name="17847"/>17847:     %%                        socket:listen(LSock)
<a name="17848"/>17848:     %%                end},
<a name="17849"/>17849:     %%      #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="17850"/>17850:     %%        cmd  =&gt; fun(#{domain := local,
<a name="17851"/>17851:     %%                      tester := Tester, lsa := #{path := Path}}) -&gt;
<a name="17852"/>17852:     %%                        ?SEV_ANNOUNCE_READY(Tester, init, Path),
<a name="17853"/>17853:     %%                        ok
<a name="17854"/>17854:     %%                end},
<a name="17855"/>17855: 
<a name="17856"/>17856: 
<a name="17857"/>17857:     %%      %% The actual test
<a name="17858"/>17858:     %%      #{desc =&gt; &quot;await continue (accept)&quot;,
<a name="17859"/>17859:     %%        cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="17860"/>17860:     %%                        ?SEV_AWAIT_CONTINUE(Tester, tester, accept)
<a name="17861"/>17861:     %%                end},
<a name="17862"/>17862:     %%      #{desc =&gt; &quot;await connection&quot;,
<a name="17863"/>17863:     %%        cmd  =&gt; fun(#{lsock := LSock} = State) -&gt;
<a name="17864"/>17864:     %%                        case socket:accept(LSock) of
<a name="17865"/>17865:     %%                            {ok, Sock} -&gt;
<a name="17866"/>17866:     %%                                ?SEV_IPRINT(&quot;accepted: ~n   ~p&quot;, [Sock]),
<a name="17867"/>17867:     %%                                {ok, State#{csock =&gt; Sock}};
<a name="17868"/>17868:     %%                            {error, _} = ERROR -&gt;
<a name="17869"/>17869:     %%                                ERROR
<a name="17870"/>17870:     %%                        end
<a name="17871"/>17871:     %%                end},
<a name="17872"/>17872:     %%      #{desc =&gt; &quot;announce ready (accept)&quot;,
<a name="17873"/>17873:     %%        cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="17874"/>17874:     %%                        ?SEV_ANNOUNCE_READY(Tester, accept),
<a name="17875"/>17875:     %%                        ok
<a name="17876"/>17876:     %%                end},
<a name="17877"/>17877: 
<a name="17878"/>17878:     %%      #{desc =&gt; &quot;await continue (peercred)&quot;,
<a name="17879"/>17879:     %%        cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="17880"/>17880:     %%                        ?SEV_AWAIT_CONTINUE(Tester, tester, peercred)
<a name="17881"/>17881:     %%                end},
<a name="17882"/>17882:     %%      #{desc =&gt; &quot;get peercred&quot;,
<a name="17883"/>17883:     %%        cmd  =&gt; fun(#{csock := Sock, get := Get} = _State) -&gt;
<a name="17884"/>17884:     %%                        case Get(Sock) of
<a name="17885"/>17885:     %%                            {ok, PeerCred} -&gt;
<a name="17886"/>17886:     %%                                ?SEV_IPRINT(&quot;PeerCred: ~n   ~p&quot;, [PeerCred]),
<a name="17887"/>17887:     %%                                ok;
<a name="17888"/>17888:     %%                            {error, _} = ERROR -&gt;
<a name="17889"/>17889:     %%                                ERROR
<a name="17890"/>17890:     %%                        end
<a name="17891"/>17891:     %%                end},
<a name="17892"/>17892:     %%      #{desc =&gt; &quot;announce ready (peercred)&quot;,
<a name="17893"/>17893:     %%        cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="17894"/>17894:     %%                        ?SEV_ANNOUNCE_READY(Tester, peercred),
<a name="17895"/>17895:     %%                        ok
<a name="17896"/>17896:     %%                end},
<a name="17897"/>17897: 
<a name="17898"/>17898: 
<a name="17899"/>17899:     %%      %% Termination
<a name="17900"/>17900:     %%      #{desc =&gt; &quot;await terminate&quot;,
<a name="17901"/>17901:     %%        cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="17902"/>17902:     %%                        case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="17903"/>17903:     %%                            ok -&gt;
<a name="17904"/>17904:     %%                                {ok, maps:remove(tester, State)};
<a name="17905"/>17905:     %%                            {error, _} = ERROR -&gt;
<a name="17906"/>17906:     %%                                ERROR
<a name="17907"/>17907:     %%                        end
<a name="17908"/>17908:     %%                end},
<a name="17909"/>17909:     %%      #{desc =&gt; &quot;close connection socket&quot;,
<a name="17910"/>17910:     %%        cmd  =&gt; fun(#{csock := Sock} = State) -&gt;
<a name="17911"/>17911:     %%                        ok = socket:close(Sock),
<a name="17912"/>17912:     %%                        {ok, maps:remove(csock, State)}
<a name="17913"/>17913:     %%                end},
<a name="17914"/>17914:     %%      #{desc =&gt; &quot;close listen socket&quot;,
<a name="17915"/>17915:     %%        cmd  =&gt; fun(#{domain := local,
<a name="17916"/>17916:     %%                      lsock  := Sock,
<a name="17917"/>17917:     %%                      lsa    := #{path := Path}} = State) -&gt;
<a name="17918"/>17918:     %%                        ok = socket:close(Sock),
<a name="17919"/>17919:     %%                        State1 =
<a name="17920"/>17920:     %%                            unlink_path(Path,
<a name="17921"/>17921:     %%                                        fun() -&gt;
<a name="17922"/>17922:     %%                                                maps:remove(lsa, State)
<a name="17923"/>17923:     %%                                        end,
<a name="17924"/>17924:     %%                                        fun() -&gt; State end),
<a name="17925"/>17925:     %%                        {ok, maps:remove(lsock, State1)}
<a name="17926"/>17926:     %%                end},
<a name="17927"/>17927: 
<a name="17928"/>17928:     %%      %% *** We are done ***
<a name="17929"/>17929:     %%      ?SEV_FINISH_NORMAL
<a name="17930"/>17930:     %%     ],
<a name="17931"/>17931: 
<a name="17932"/>17932: 
<a name="17933"/>17933:     %% ClientSeq =
<a name="17934"/>17934:     %%     [
<a name="17935"/>17935:     %%      %% *** Wait for start order part ***
<a name="17936"/>17936:     %%      #{desc =&gt; &quot;await start&quot;,
<a name="17937"/>17937:     %%        cmd  =&gt; fun(#{domain := local} = State) -&gt;
<a name="17938"/>17938:     %%                        {Tester, Path} = ?SEV_AWAIT_START(),
<a name="17939"/>17939:     %%                        {ok, State#{tester    =&gt; Tester,
<a name="17940"/>17940:     %%                                    server_path =&gt; Path}}
<a name="17941"/>17941:     %%                end},
<a name="17942"/>17942:     %%      #{desc =&gt; &quot;monitor tester&quot;,
<a name="17943"/>17943:     %%        cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="17944"/>17944:     %%                        _MRef = erlang:monitor(process, Tester),
<a name="17945"/>17945:     %%                        ok
<a name="17946"/>17946:     %%                end},
<a name="17947"/>17947: 
<a name="17948"/>17948: 
<a name="17949"/>17949:     %%      %% *** Init part ***
<a name="17950"/>17950:     %%      #{desc =&gt; &quot;which local address&quot;,
<a name="17951"/>17951:     %%        cmd  =&gt; fun(#{domain      := local = Domain,
<a name="17952"/>17952:     %%                      server_path := Path} = State) -&gt;
<a name="17953"/>17953:     %%                        LSA = which_local_socket_addr(Domain),
<a name="17954"/>17954:     %%                        SSA = #{family =&gt; Domain, path =&gt; Path},
<a name="17955"/>17955:     %%                        {ok, State#{local_sa =&gt; LSA, server_sa =&gt; SSA}}
<a name="17956"/>17956:     %%                end},
<a name="17957"/>17957:     %%      #{desc =&gt; &quot;create node&quot;,
<a name="17958"/>17958:     %%        cmd  =&gt; fun(#{host := Host} = State) -&gt;
<a name="17959"/>17959:     %%     		   ?SEV_IPRINT(&quot;try create node on ~p&quot;, [Host]),
<a name="17960"/>17960:     %%                        case ?CT_PEER() of
<a name="17961"/>17961:     %%                            {ok, Peer, Node} -&gt;
<a name="17962"/>17962:     %%                                ?SEV_IPRINT(&quot;client node ~p started&quot;,
<a name="17963"/>17963:     %%                                            [Node]),
<a name="17964"/>17964:     %%                                {ok, State#{node =&gt; Node, peer =&gt; Peer}};
<a name="17965"/>17965:     %%                            {error, Reason} -&gt;
<a name="17966"/>17966:     %%                                {skip, Reason}
<a name="17967"/>17967:     %%                        end
<a name="17968"/>17968:     %%                end},
<a name="17969"/>17969:     %%       #{desc =&gt; &quot;monitor client node&quot;,
<a name="17970"/>17970:     %%        cmd  =&gt; fun(#{node := Node} = _State) -&gt;
<a name="17971"/>17971:     %%                        true = erlang:monitor_node(Node, true),
<a name="17972"/>17972:     %%                        ok
<a name="17973"/>17973:     %%                end},
<a name="17974"/>17974:     %%      #{desc =&gt; &quot;start remote client on client node&quot;,
<a name="17975"/>17975:     %%        cmd  =&gt; fun(#{node := Node} = State) -&gt;
<a name="17976"/>17976:     %%                        Pid = api_opt_sock_peercred_tcp_client_start(Node),
<a name="17977"/>17977:     %%                        ?SEV_IPRINT(&quot;remote client ~p started&quot;, [Pid]),
<a name="17978"/>17978:     %%                        {ok, State#{rclient =&gt; Pid}}
<a name="17979"/>17979:     %%                end},
<a name="17980"/>17980:     %%      #{desc =&gt; &quot;monitor remote client&quot;,
<a name="17981"/>17981:     %%        cmd  =&gt; fun(#{rclient := Pid}) -&gt;
<a name="17982"/>17982:     %%                        _MRef = erlang:monitor(process, Pid),
<a name="17983"/>17983:     %%                        ok
<a name="17984"/>17984:     %%                end},
<a name="17985"/>17985:     %%      #{desc =&gt; &quot;order remote client to start&quot;,
<a name="17986"/>17986:     %%        cmd  =&gt; fun(#{rclient   := Client,
<a name="17987"/>17987:     %%                     proto      := Proto,
<a name="17988"/>17988:     %%                      server_sa := ServerSA}) -&gt;
<a name="17989"/>17989:     %%                        ?SEV_ANNOUNCE_START(Client, {Proto, ServerSA}),
<a name="17990"/>17990:     %%                        ok
<a name="17991"/>17991:     %%                end},
<a name="17992"/>17992:     %%      #{desc =&gt; &quot;await remote client ready&quot;,
<a name="17993"/>17993:     %%        cmd  =&gt; fun(#{tester  := Tester,
<a name="17994"/>17994:     %%                      rclient := Client} = _State) -&gt;
<a name="17995"/>17995:     %%                        ?SEV_AWAIT_READY(Client, rclient, init,
<a name="17996"/>17996:     %%                                         [{tester, Tester}])
<a name="17997"/>17997:     %%                end},
<a name="17998"/>17998:     %%      #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="17999"/>17999:     %%        cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="18000"/>18000:     %%                        ?SEV_ANNOUNCE_READY(Tester, init),
<a name="18001"/>18001:     %%                        ok
<a name="18002"/>18002:     %%                end},
<a name="18003"/>18003: 
<a name="18004"/>18004: 
<a name="18005"/>18005:     %%      %% The actual test
<a name="18006"/>18006:     %%      #{desc =&gt; &quot;await continue (connect)&quot;,
<a name="18007"/>18007:     %%        cmd  =&gt; fun(#{tester  := Tester,
<a name="18008"/>18008:     %%                      rclient := Client} = State) -&gt;
<a name="18009"/>18009:     %%                        case ?SEV_AWAIT_CONTINUE(Tester, tester, connect,
<a name="18010"/>18010:     %%                                                 [{rclient, Client}]) of
<a name="18011"/>18011:     %%                            {ok, {ConTimeout, ConLimit}} -&gt;
<a name="18012"/>18012:     %%                                {ok, State#{connect_timeout =&gt; ConTimeout,
<a name="18013"/>18013:     %%                                            connect_limit   =&gt; ConLimit}};
<a name="18014"/>18014:     %%                            {error, _} = ERROR -&gt;
<a name="18015"/>18015:     %%                                ERROR
<a name="18016"/>18016:     %%                        end
<a name="18017"/>18017:     %%                end},
<a name="18018"/>18018:     %%      #{desc =&gt; &quot;order remote client to continue (connect)&quot;,
<a name="18019"/>18019:     %%        cmd  =&gt; fun(#{rclient         := RClient,
<a name="18020"/>18020:     %%                      connect_timeout := ConTimeout,
<a name="18021"/>18021:     %%                      connect_limit   := ConLimit}) -&gt;
<a name="18022"/>18022:     %%                        ?SEV_ANNOUNCE_CONTINUE(RClient, connect,
<a name="18023"/>18023:     %%                                               {ConTimeout, ConLimit}),
<a name="18024"/>18024:     %%                        ok
<a name="18025"/>18025:     %%                end},
<a name="18026"/>18026:     %%      #{desc =&gt; &quot;await remote client ready (connect)&quot;,
<a name="18027"/>18027:     %%        cmd  =&gt; fun(#{tester  := Tester,
<a name="18028"/>18028:     %%                      rclient := RClient} = State) -&gt;
<a name="18029"/>18029:     %%                        case ?SEV_AWAIT_READY(RClient, rclient, connect,
<a name="18030"/>18030:     %%                                              [{tester, Tester}]) of
<a name="18031"/>18031:     %%                            {ok, ok = _Result} -&gt;
<a name="18032"/>18032:     %%                                {ok, maps:remove(connect_limit, State)};
<a name="18033"/>18033:     %%                            {ok, {error, {connect_limit_reached,R,L}}} -&gt;
<a name="18034"/>18034:     %%                                {skip,
<a name="18035"/>18035:     %%                                 ?LIB:f(&quot;Connect limit reached ~w: ~w&quot;,
<a name="18036"/>18036:     %%                                        [L, R])};
<a name="18037"/>18037:     %%                            {ok, Result} -&gt;
<a name="18038"/>18038:     %%                                Result;
<a name="18039"/>18039:     %%                            {error, _} = ERROR -&gt;
<a name="18040"/>18040:     %%                                ERROR
<a name="18041"/>18041:     %%                        end
<a name="18042"/>18042:     %%                end},
<a name="18043"/>18043:     %%      #{desc =&gt; &quot;announce ready (connect)&quot;,
<a name="18044"/>18044:     %%        cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="18045"/>18045:     %%                        ?SEV_ANNOUNCE_READY(Tester, connect),
<a name="18046"/>18046:     %%                        ok
<a name="18047"/>18047:     %%                end},
<a name="18048"/>18048: 
<a name="18049"/>18049:     %%      %% Termination
<a name="18050"/>18050:     %%      #{desc =&gt; &quot;await terminate (from tester)&quot;,
<a name="18051"/>18051:     %%        cmd  =&gt; fun(#{tester  := Tester,
<a name="18052"/>18052:     %%                      rclient := RClient} = State) -&gt;
<a name="18053"/>18053:     %%                        case ?SEV_AWAIT_TERMINATE(Tester, tester,
<a name="18054"/>18054:     %%                                                  [{rclient, RClient}]) of
<a name="18055"/>18055:     %%                            ok -&gt;
<a name="18056"/>18056:     %%                                {ok, maps:remove(tester, State)};
<a name="18057"/>18057:     %%                            {error, _} = ERROR -&gt;
<a name="18058"/>18058:     %%                                ERROR
<a name="18059"/>18059:     %%                        end
<a name="18060"/>18060:     %%                end},
<a name="18061"/>18061:     %%      #{desc =&gt; &quot;kill remote client&quot;,
<a name="18062"/>18062:     %%        cmd  =&gt; fun(#{rclient := Client}) -&gt;
<a name="18063"/>18063:     %%                        ?SEV_ANNOUNCE_TERMINATE(Client),
<a name="18064"/>18064:     %%                        ok
<a name="18065"/>18065:     %%                end},
<a name="18066"/>18066:     %%      #{desc =&gt; &quot;await remote client termination&quot;,
<a name="18067"/>18067:     %%        cmd  =&gt; fun(#{rclient := Client} = State) -&gt;
<a name="18068"/>18068:     %%                        ?SEV_AWAIT_TERMINATION(Client),
<a name="18069"/>18069:     %%                        State1 = maps:remove(rclient, State),
<a name="18070"/>18070:     %%                        {ok, State1}
<a name="18071"/>18071:     %%                end},
<a name="18072"/>18072:     %%      #{desc =&gt; &quot;stop client node&quot;,
<a name="18073"/>18073:     %%        cmd  =&gt; fun(#{peer := Peer} = _State) -&gt;
<a name="18074"/>18074:     %%                        peer:stop(Peer)
<a name="18075"/>18075:     %%                end},
<a name="18076"/>18076:     %%      #{desc =&gt; &quot;await client node termination&quot;,
<a name="18077"/>18077:     %%        cmd  =&gt; fun(#{node := Node} = State) -&gt;
<a name="18078"/>18078:     %%                        receive
<a name="18079"/>18079:     %%                            {nodedown, Node} -&gt;
<a name="18080"/>18080:     %%                                State1 = maps:remove(node_id, State),
<a name="18081"/>18081:     %%                                State2 = maps:remove(node,    State1),
<a name="18082"/>18082:     %%                                {ok, State2}
<a name="18083"/>18083:     %%                        end
<a name="18084"/>18084:     %%                end},
<a name="18085"/>18085: 
<a name="18086"/>18086:     %%      %% *** We are done ***
<a name="18087"/>18087:     %%      ?SEV_FINISH_NORMAL
<a name="18088"/>18088:     %%    ],
<a name="18089"/>18089: 
<a name="18090"/>18090:     %% TesterSeq =
<a name="18091"/>18091:     %%     [
<a name="18092"/>18092:     %%      %% *** Init part ***
<a name="18093"/>18093:     %%      #{desc =&gt; &quot;monitor server&quot;,
<a name="18094"/>18094:     %%        cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="18095"/>18095:     %%                        _MRef = erlang:monitor(process, Server),
<a name="18096"/>18096:     %%                        ok
<a name="18097"/>18097:     %%                end},
<a name="18098"/>18098:     %%      #{desc =&gt; &quot;monitor client&quot;,
<a name="18099"/>18099:     %%        cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="18100"/>18100:     %%                        _MRef = erlang:monitor(process, Client),
<a name="18101"/>18101:     %%                        ok
<a name="18102"/>18102:     %%                end},
<a name="18103"/>18103:     %%      #{desc =&gt; &quot;which local address&quot;,
<a name="18104"/>18104:     %%        cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="18105"/>18105:     %%                        LSA = which_local_socket_addr(Domain),
<a name="18106"/>18106:     %%                        {ok, State#{local_sa =&gt; LSA}}
<a name="18107"/>18107:     %%                end},
<a name="18108"/>18108:     %%      #{desc =&gt; &quot;order server start&quot;,
<a name="18109"/>18109:     %%        cmd  =&gt; fun(#{server  := Server,
<a name="18110"/>18110:     %%                      backlog := Backlog}) -&gt;
<a name="18111"/>18111:     %%                        ?SEV_ANNOUNCE_START(Server, Backlog),
<a name="18112"/>18112:     %%                        ok
<a name="18113"/>18113:     %%                end},
<a name="18114"/>18114:     %%      #{desc =&gt; &quot;await server ready (init)&quot;,
<a name="18115"/>18115:     %%        cmd  =&gt; fun(#{server := Server, local_sa := LSA} = State) -&gt;
<a name="18116"/>18116:     %%                        {ok, Port} = ?SEV_AWAIT_READY(Server, server, init),
<a name="18117"/>18117:     %%                        ServerSA = LSA#{port =&gt; Port},
<a name="18118"/>18118:     %%                        {ok, State#{server_sa =&gt; ServerSA}}
<a name="18119"/>18119:     %%                end},
<a name="18120"/>18120:     %%      #{desc =&gt; &quot;order client start&quot;,
<a name="18121"/>18121:     %%        cmd  =&gt; fun(#{client    := Client,
<a name="18122"/>18122:     %%                      server_sa := ServerSA}) -&gt;
<a name="18123"/>18123:     %%                        ?SEV_ANNOUNCE_START(Client, ServerSA),
<a name="18124"/>18124:     %%                        ok
<a name="18125"/>18125:     %%                end},
<a name="18126"/>18126:     %%      #{desc =&gt; &quot;await client ready (init)&quot;,
<a name="18127"/>18127:     %%        cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="18128"/>18128:     %%                        ?SEV_AWAIT_READY(Client, client, init),
<a name="18129"/>18129:     %%                        ok
<a name="18130"/>18130:     %%                end},
<a name="18131"/>18131: 
<a name="18132"/>18132: 
<a name="18133"/>18133:     %%      %% The actual test
<a name="18134"/>18134:     %%      %% The server accepts the connect from the client, announces
<a name="18135"/>18135:     %%      %% this to us (accept) and then attempts to get peercred.
<a name="18136"/>18136:     %%      #{desc =&gt; &quot;order client continue (connect)&quot;,
<a name="18137"/>18137:     %%        cmd  =&gt; fun(#{client        := Client,
<a name="18138"/>18138:     %%                      timeout       := Timeout,
<a name="18139"/>18139:     %%                      connect_limit := ConLimit} = _State) -&gt;
<a name="18140"/>18140:     %%                        ?SEV_ANNOUNCE_CONTINUE(Client, connect,
<a name="18141"/>18141:     %%                                               {Timeout, ConLimit}),
<a name="18142"/>18142:     %%                        ok
<a name="18143"/>18143:     %%                end},
<a name="18144"/>18144:     %%      #{desc =&gt; &quot;await client ready (connect)&quot;,
<a name="18145"/>18145:     %%        cmd  =&gt; fun(#{server := Server,
<a name="18146"/>18146:     %%                      client := Client} = _State) -&gt;
<a name="18147"/>18147:     %%                        case ?SEV_AWAIT_READY(Client, client, connect,
<a name="18148"/>18148:     %%                                              [{server, Server}]) of
<a name="18149"/>18149:     %%                            ok -&gt;
<a name="18150"/>18150:     %%                                ok;
<a name="18151"/>18151:     %%                            {error, _} = ERROR -&gt;
<a name="18152"/>18152:     %%                                ERROR
<a name="18153"/>18153:     %%                        end
<a name="18154"/>18154:     %%                end},
<a name="18155"/>18155:     %%      #{desc =&gt; &quot;await server ready (accept)&quot;,
<a name="18156"/>18156:     %%        cmd  =&gt; fun(#{server := Server,
<a name="18157"/>18157:     %%                      client := Client} = _State) -&gt;
<a name="18158"/>18158:     %%                        case ?SEV_AWAIT_READY(Server, server, accept,
<a name="18159"/>18159:     %%                                              [{client, Client}]) of
<a name="18160"/>18160:     %%                            ok -&gt;
<a name="18161"/>18161:     %%                                ok;
<a name="18162"/>18162:     %%                            {error, _} = ERROR -&gt;
<a name="18163"/>18163:     %%                                ERROR
<a name="18164"/>18164:     %%                        end
<a name="18165"/>18165:     %%                end},
<a name="18166"/>18166:     %%      #{desc =&gt; &quot;await server ready (peercred)&quot;,
<a name="18167"/>18167:     %%        cmd  =&gt; fun(#{server := Server,
<a name="18168"/>18168:     %%                      client := Client} = _State) -&gt;
<a name="18169"/>18169:     %%                        case ?SEV_AWAIT_READY(Server, server, peercred,
<a name="18170"/>18170:     %%                                              [{client, Client}]) of
<a name="18171"/>18171:     %%                            ok -&gt;
<a name="18172"/>18172:     %%                                ok;
<a name="18173"/>18173:     %%                            {error, _} = ERROR -&gt;
<a name="18174"/>18174:     %%                                ERROR
<a name="18175"/>18175:     %%                        end
<a name="18176"/>18176:     %%                end},
<a name="18177"/>18177: 
<a name="18178"/>18178: 
<a name="18179"/>18179:     %%      %% *** Terminate server ***
<a name="18180"/>18180:     %%      #{desc =&gt; &quot;order client terminate&quot;,
<a name="18181"/>18181:     %%        cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="18182"/>18182:     %%                        ?SEV_ANNOUNCE_TERMINATE(Client),
<a name="18183"/>18183:     %%                        ok
<a name="18184"/>18184:     %%                end},
<a name="18185"/>18185:     %%      #{desc =&gt; &quot;await client down&quot;,
<a name="18186"/>18186:     %%        cmd  =&gt; fun(#{client := Client} = State) -&gt;
<a name="18187"/>18187:     %%                        ?SEV_AWAIT_TERMINATION(Client),
<a name="18188"/>18188:     %%                        State1 = maps:remove(client,    State),
<a name="18189"/>18189:     %%                        {ok, State1}
<a name="18190"/>18190:     %%                end},
<a name="18191"/>18191:     %%      #{desc =&gt; &quot;order server terminate&quot;,
<a name="18192"/>18192:     %%        cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="18193"/>18193:     %%                        ?SEV_ANNOUNCE_TERMINATE(Server),
<a name="18194"/>18194:     %%                        ok
<a name="18195"/>18195:     %%                end},
<a name="18196"/>18196:     %%      #{desc =&gt; &quot;await server down&quot;,
<a name="18197"/>18197:     %%        cmd  =&gt; fun(#{server := Server} = State) -&gt;
<a name="18198"/>18198:     %%                        ?SEV_AWAIT_TERMINATION(Server),
<a name="18199"/>18199:     %%                        State1 = maps:remove(server,    State),
<a name="18200"/>18200:     %%                        State2 = maps:remove(server_sa, State1),
<a name="18201"/>18201:     %%                        {ok, State2}
<a name="18202"/>18202:     %%                end},
<a name="18203"/>18203: 
<a name="18204"/>18204:     %%      %% *** We are done ***
<a name="18205"/>18205:     %%      ?SEV_FINISH_NORMAL
<a name="18206"/>18206:     %%     ],
<a name="18207"/>18207: 
<a name="18208"/>18208:     %% i(&quot;create server evaluator&quot;),
<a name="18209"/>18209:     %% ServerInitState = #{domain =&gt; maps:get(domain, InitState)},
<a name="18210"/>18210:     %% Server          = ?SEV_START(&quot;server&quot;, ServerSeq, ServerInitState),
<a name="18211"/>18211: 
<a name="18212"/>18212:     %% i(&quot;create client evaluator&quot;),
<a name="18213"/>18213:     %% ClientInitState = #{host   =&gt; local_host(),
<a name="18214"/>18214:     %%                     domain =&gt; maps:get(domain, InitState)},
<a name="18215"/>18215:     %% Client          = ?SEV_START(&quot;client&quot;, ClientSeq, ClientInitState),
<a name="18216"/>18216: 
<a name="18217"/>18217:     %% i(&quot;create tester evaluator&quot;),
<a name="18218"/>18218:     %% TesterInitState = InitState#{server =&gt; Server#ev.pid,
<a name="18219"/>18219:     %%                              client =&gt; Client#ev.pid},
<a name="18220"/>18220:     %% Tester          = ?SEV_START(&quot;tester&quot;, TesterSeq, TesterInitState),
<a name="18221"/>18221: 
<a name="18222"/>18222:     %% i(&quot;await evaluator(s)&quot;),
<a name="18223"/>18223:     %% ok = ?SEV_AWAIT_FINISH([Server, Client, Tester]).
<a name="18224"/>18224: 
<a name="18225"/>18225: 
<a name="18226"/>18226:     %% This should actually never be called (the conditions should cause a skip),
<a name="18227"/>18227:     %% but just to be on the safe side...
<a name="api_opt_sock_peercred_tcp-last_expr"/><a name="18228"/>18228:     skip.
<a name="18229"/>18229: 
<a name="18230"/>18230: 
<a name="18231"/>18231: <i>%% api_opt_sock_peercred_tcp_client_start(Node) -&gt;</i>
<a name="18232"/>18232: <i>%%     Self = self(),</i>
<a name="18233"/>18233: <i>%%     Fun  = fun() -&gt; api_opt_sock_peercred_tcp_client(Self) end,</i>
<a name="18234"/>18234: <i>%%     erlang:spawn(Node, Fun).</i>
<a name="18235"/>18235: 
<a name="18236"/>18236: <i>%% api_opt_sock_peercred_tcp_client(Parent) -&gt;</i>
<a name="18237"/>18237: <i>%%     api_opt_sock_peercred_tcp_client_init(Parent),</i>
<a name="18238"/>18238: <i>%%     {Proto, ServerSA} = api_opt_sock_peercred_tcp_client_await_start(Parent),</i>
<a name="18239"/>18239: <i>%%     Domain   = maps:get(family, ServerSA),</i>
<a name="18240"/>18240: <i>%%     api_opt_sock_peercred_tcp_client_announce_ready(Parent, init),</i>
<a name="18241"/>18241: <i>%%     api_opt_sock_peercred_tcp_client_await_continue(Parent, connect),</i>
<a name="18242"/>18242: <i>%%     Result = api_opt_sock_peercred_tcp_client_connect(Domain, Proto, ServerSA),</i>
<a name="18243"/>18243: <i>%%     ?SEV_IPRINT(&quot;result: ~p&quot;, [Result]),</i>
<a name="18244"/>18244: <i>%%     api_opt_sock_peercred_tcp_client_announce_ready(Parent, connect, Result),</i>
<a name="18245"/>18245: <i>%%     Reason = api_opt_sock_peercred_tcp_client_await_terminate(Parent),</i>
<a name="18246"/>18246: <i>%%     api_opt_sock_peercred_tcp_client_close(Result),</i>
<a name="18247"/>18247: <i>%%     exit(Reason).</i>
<a name="18248"/>18248: 
<a name="18249"/>18249: <i>%% api_opt_sock_peercred_tcp_client_init(Parent) -&gt;</i>
<a name="18250"/>18250: <i>%%     put(sname, &quot;rclient&quot;),</i>
<a name="18251"/>18251: <i>%%     _MRef = erlang:monitor(process, Parent),</i>
<a name="18252"/>18252: <i>%%     ok.</i>
<a name="18253"/>18253: 
<a name="18254"/>18254: <i>%% api_opt_sock_peercred_tcp_client_await_start(Parent) -&gt;</i>
<a name="18255"/>18255: <i>%%     ?SEV_AWAIT_START(Parent).</i>
<a name="18256"/>18256: 
<a name="18257"/>18257: <i>%% api_opt_sock_peercred_tcp_client_announce_ready(Parent, Slogan) -&gt;</i>
<a name="18258"/>18258: <i>%%     ?SEV_ANNOUNCE_READY(Parent, Slogan).</i>
<a name="18259"/>18259: <i>%% api_opt_sock_peercred_tcp_client_announce_ready(Parent, Slogan, Result) -&gt;</i>
<a name="18260"/>18260: <i>%%     ?SEV_ANNOUNCE_READY(Parent, Slogan, Result).</i>
<a name="18261"/>18261: 
<a name="18262"/>18262: <i>%% api_opt_sock_peercred_tcp_client_await_continue(Parent, Slogan) -&gt;</i>
<a name="18263"/>18263: <i>%%     case ?SEV_AWAIT_CONTINUE(Parent, parent, Slogan) of</i>
<a name="18264"/>18264: <i>%%         ok -&gt;</i>
<a name="18265"/>18265: <i>%%             ok;</i>
<a name="18266"/>18266: <i>%%         {ok, Extra} -&gt;</i>
<a name="18267"/>18267: <i>%%             Extra;</i>
<a name="18268"/>18268: <i>%%         {error, Reason} -&gt;</i>
<a name="18269"/>18269: <i>%%             exit({await_continue, Slogan, Reason})</i>
<a name="18270"/>18270: <i>%%     end.</i>
<a name="18271"/>18271: 
<a name="18272"/>18272: <i>%% api_opt_sock_peercred_tcp_client_await_terminate(Parent) -&gt;</i>
<a name="18273"/>18273: <i>%%     case ?SEV_AWAIT_TERMINATE(Parent, parent) of</i>
<a name="18274"/>18274: <i>%%         ok -&gt;</i>
<a name="18275"/>18275: <i>%%             ok;</i>
<a name="18276"/>18276: <i>%%         {error, Reason} -&gt;</i>
<a name="18277"/>18277: <i>%%             Reason</i>
<a name="18278"/>18278: <i>%%     end.</i>
<a name="18279"/>18279: 
<a name="18280"/>18280: <i>%% api_opt_sock_peercred_tcp_client_connect(Domain, Proto, ServerSA) -&gt;</i>
<a name="18281"/>18281: <i>%%     LSA  = which_local_socket_addr(Domain),</i>
<a name="18282"/>18282: <i>%%     Sock = case socket:open(Domain, stream, Proto) of</i>
<a name="18283"/>18283: <i>%%                {ok, S} -&gt;</i>
<a name="18284"/>18284: <i>%%                    S;</i>
<a name="18285"/>18285: <i>%%                {error, OReason} -&gt;</i>
<a name="18286"/>18286: <i>%%                    ?FAIL({open, OReason})</i>
<a name="18287"/>18287: <i>%%            end,</i>
<a name="18288"/>18288: <i>%%     case socket:bind(Sock, LSA) of</i>
<a name="18289"/>18289: <i>%%         ok -&gt;</i>
<a name="18290"/>18290: <i>%%             ok;</i>
<a name="18291"/>18291: <i>%%         {error, BReason} -&gt;</i>
<a name="18292"/>18292: <i>%%             (catch socket:close(Sock)),</i>
<a name="18293"/>18293: <i>%%             ?FAIL({bind, BReason})</i>
<a name="18294"/>18294: <i>%%     end,</i>
<a name="18295"/>18295: <i>%%     case socket:connect(Sock, ServerSA) of</i>
<a name="18296"/>18296: <i>%%         ok -&gt;</i>
<a name="18297"/>18297: <i>%%             {ok, Sock};</i>
<a name="18298"/>18298: <i>%%         {error, Reason} -&gt;</i>
<a name="18299"/>18299: <i>%%             (catch socket:close(Sock)),</i>
<a name="18300"/>18300: <i>%%             ?FAIL({connect, Reason})</i>
<a name="18301"/>18301: <i>%%     end.</i>
<a name="18302"/>18302: 
<a name="18303"/>18303: <i>%% api_opt_sock_peercred_tcp_client_close({ok, Sock}) -&gt;</i>
<a name="18304"/>18304: <i>%%     (catch socket:close(Sock));</i>
<a name="18305"/>18305: <i>%% api_opt_sock_peercred_tcp_client_close(_) -&gt;</i>
<a name="18306"/>18306: <i>%%     ok.</i>
<a name="18307"/>18307: 
<a name="18308"/>18308: 
<a name="18309"/>18309: 
<a name="18310"/>18310: 
<a name="18311"/>18311: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="18312"/>18312: 
<a name="18313"/>18313: <i>%% Tests the 'PRIORITY' socket 'socket' option with IPv4 UDP:</i>
<a name="18314"/>18314: <i>%%</i>
<a name="18315"/>18315: <i>%%               socket:setopt(Sock, socket, priority, integer()).</i>
<a name="18316"/>18316: <i>%%</i>
<a name="18317"/>18317: <i>%%</i>
<a name="18318"/>18318: 
<a name="api_opt_sock_priority_udp4-1"/><a name="18319"/>18319: <b>api_opt_sock_priority_udp4</b>(_Config) when is_list(_Config) -&gt;
<a name="18320"/>18320:     ?TT(?SECS(5)),
<a name="api_opt_sock_priority_udp4-last_expr"/><a name="18321"/>18321: <b>    tc_try</b>(api_opt_sock_priority_udp4,
<a name="18322"/>18322:            fun() -&gt; has_support_ipv4(), has_support_sock_priority() end,
<a name="18323"/>18323:            fun() -&gt;
<a name="18324"/>18324:                    Set  = fun(Sock, Value) -&gt;
<a name="18325"/>18325:                                   socket:setopt(Sock, socket, priority, Value)
<a name="18326"/>18326:                           end,
<a name="18327"/>18327:                    Get  = fun(Sock) -&gt;
<a name="18328"/>18328:                                   socket:getopt(Sock, socket, priority)
<a name="18329"/>18329:                           end,
<a name="18330"/>18330:                    InitState = #{domain =&gt; inet,
<a name="18331"/>18331:                                  type   =&gt; dgram,
<a name="18332"/>18332:                                  proto  =&gt; udp,
<a name="18333"/>18333:                                  set    =&gt; Set,
<a name="18334"/>18334:                                  get    =&gt; Get},
<a name="18335"/>18335:                    ok = api_opt_sock_priority(InitState)
<a name="18336"/>18336:            end).
<a name="18337"/>18337: 
<a name="18338"/>18338: 
<a name="18339"/>18339: 
<a name="18340"/>18340: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="18341"/>18341: 
<a name="18342"/>18342: <i>%% Tests the 'PRIORITY' socket 'socket' option with IPv4 TCP:</i>
<a name="18343"/>18343: <i>%%</i>
<a name="18344"/>18344: <i>%%               socket:setopt(Sock, socket, priority, integer()).</i>
<a name="18345"/>18345: <i>%%</i>
<a name="18346"/>18346: <i>%%</i>
<a name="18347"/>18347: 
<a name="api_opt_sock_priority_tcp4-1"/><a name="18348"/>18348: <b>api_opt_sock_priority_tcp4</b>(_Config) when is_list(_Config) -&gt;
<a name="18349"/>18349:     ?TT(?SECS(5)),
<a name="api_opt_sock_priority_tcp4-last_expr"/><a name="18350"/>18350: <b>    tc_try</b>(api_opt_sock_priority_tcp4,
<a name="18351"/>18351:            fun() -&gt; has_support_ipv4(), has_support_sock_priority() end,
<a name="18352"/>18352:            fun() -&gt;
<a name="18353"/>18353:                    Set  = fun(Sock, Value) -&gt;
<a name="18354"/>18354:                                   socket:setopt(Sock, socket, priority, Value)
<a name="18355"/>18355:                           end,
<a name="18356"/>18356:                    Get  = fun(Sock) -&gt;
<a name="18357"/>18357:                                   socket:getopt(Sock, socket, priority)
<a name="18358"/>18358:                           end,
<a name="18359"/>18359:                    InitState = #{domain =&gt; inet,
<a name="18360"/>18360:                                  type   =&gt; stream,
<a name="18361"/>18361:                                  proto  =&gt; tcp,
<a name="18362"/>18362:                                  set    =&gt; Set,
<a name="18363"/>18363:                                  get    =&gt; Get},
<a name="18364"/>18364:                    ok = api_opt_sock_priority(InitState)
<a name="18365"/>18365:            end).
<a name="18366"/>18366: 
<a name="18367"/>18367: 
<a name="18368"/>18368: 
<a name="18369"/>18369: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="18370"/>18370: 
<a name="api_opt_sock_priority-1"/><a name="18371"/>18371: <b>api_opt_sock_priority</b>(InitState) -&gt;
<a name="18372"/>18372:     Seq = 
<a name="18373"/>18373:         [
<a name="18374"/>18374:          #{desc =&gt; &quot;local address&quot;,
<a name="18375"/>18375:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="18376"/>18376:                            LSA = which_local_socket_addr(Domain),
<a name="18377"/>18377:                            {ok, State#{lsa =&gt; LSA}}
<a name="18378"/>18378:                    end},
<a name="18379"/>18379: 
<a name="18380"/>18380:          #{desc =&gt; &quot;open socket&quot;,
<a name="18381"/>18381:            cmd  =&gt; fun(#{domain := Domain,
<a name="18382"/>18382:                          type   := Type,
<a name="18383"/>18383:                          proto  := Proto} = State) -&gt;
<a name="18384"/>18384:                            Sock = sock_open(Domain, Type, Proto),
<a name="18385"/>18385:                            {ok, State#{sock =&gt; Sock}}
<a name="18386"/>18386:                    end},
<a name="18387"/>18387:          #{desc =&gt; &quot;bind&quot;,
<a name="18388"/>18388:            cmd  =&gt; fun(#{sock := Sock, lsa := LSA}) -&gt;
<a name="18389"/>18389:                            case sock_bind(Sock, LSA) of
<a name="18390"/>18390:                                ok -&gt;
<a name="18391"/>18391:                                    ?SEV_IPRINT(&quot;bound&quot;),
<a name="18392"/>18392:                                    ok;
<a name="18393"/>18393:                                {error, Reason} = ERROR -&gt;
<a name="18394"/>18394:                                    ?SEV_EPRINT(&quot;bind failed: ~p&quot;, [Reason]),
<a name="18395"/>18395:                                    ERROR
<a name="18396"/>18396:                            end
<a name="18397"/>18397:                    end},
<a name="18398"/>18398:          #{desc =&gt; &quot;get current (default) priority&quot;,
<a name="18399"/>18399:            cmd  =&gt; fun(#{sock := Sock, get := Get} = State) -&gt;
<a name="18400"/>18400:                            case Get(Sock) of
<a name="18401"/>18401:                                {ok, Prio} -&gt;
<a name="18402"/>18402:                                    ?SEV_IPRINT(&quot;(default) priority: ~p&quot;,
<a name="18403"/>18403:                                                [Prio]),
<a name="18404"/>18404:                                    {ok, State#{default =&gt; Prio}};
<a name="18405"/>18405:                                {error, Reason} = ERROR -&gt;
<a name="18406"/>18406:                                    ?SEV_EPRINT(&quot;Failed getting (default) &quot;
<a name="18407"/>18407:                                                &quot;priority:&quot;
<a name="18408"/>18408:                                                &quot;   ~p&quot;, [Reason]),
<a name="18409"/>18409:                                    ERROR
<a name="18410"/>18410:                            end
<a name="18411"/>18411:                    end},
<a name="18412"/>18412: 
<a name="18413"/>18413:          #{desc =&gt; &quot;change priority (to within non-root range)&quot;,
<a name="18414"/>18414:            cmd  =&gt; fun(#{sock    := Sock,
<a name="18415"/>18415:                          default := DefaultPrio,
<a name="18416"/>18416:                          set     := Set} = _State) -&gt;
<a name="18417"/>18417:                            NewPrio =
<a name="18418"/>18418:                                if
<a name="18419"/>18419:                                    (DefaultPrio =&lt; 0) andalso
<a name="18420"/>18420:                                    (DefaultPrio &lt; 6) -&gt;
<a name="18421"/>18421:                                        DefaultPrio+1;
<a name="18422"/>18422:                                    (DefaultPrio =:= 6) -&gt;
<a name="18423"/>18423:                                        DefaultPrio-1;
<a name="18424"/>18424:                                    true -&gt;
<a name="18425"/>18425:                                        3 % ...
<a name="18426"/>18426:                                end,
<a name="18427"/>18427:                            ?SEV_IPRINT(&quot;try set new priority (to ~p)&quot;,
<a name="18428"/>18428:                                        [NewPrio]),
<a name="18429"/>18429:                            case Set(Sock, NewPrio) of
<a name="18430"/>18430:                                ok -&gt;
<a name="18431"/>18431:                                    ?SEV_IPRINT(&quot;priority changed (to ~p)&quot;,
<a name="18432"/>18432:                                                [NewPrio]),
<a name="18433"/>18433:                                    ok;
<a name="18434"/>18434:                                {error, Reason} = ERROR -&gt;
<a name="18435"/>18435:                                    ?SEV_EPRINT(&quot;Failed setting timestamp:&quot;
<a name="18436"/>18436:                                                &quot;   ~p&quot;, [Reason]),
<a name="18437"/>18437:                                    ERROR
<a name="18438"/>18438:                            end
<a name="18439"/>18439:                    end},
<a name="18440"/>18440: 
<a name="18441"/>18441:          #{desc =&gt; &quot;change priority (to outside root-range)&quot;,
<a name="18442"/>18442:            cmd  =&gt; fun(#{sock := Sock,
<a name="18443"/>18443:                          set  := Set} = _State) -&gt;
<a name="18444"/>18444:                            NewPrio = 42,
<a name="18445"/>18445:                            ?SEV_IPRINT(&quot;try set new priority (to ~p)&quot;,
<a name="18446"/>18446:                                        [NewPrio]),
<a name="18447"/>18447:                            case Set(Sock, NewPrio) of
<a name="18448"/>18448:                                ok -&gt;
<a name="18449"/>18449:                                    ?SEV_IPRINT(&quot;priority changed (to ~p)&quot;,
<a name="18450"/>18450:                                                [NewPrio]),
<a name="18451"/>18451:                                    ok;
<a name="18452"/>18452:                                {error, eperm} -&gt;
<a name="18453"/>18453:                                    ?SEV_IPRINT(&quot;priority change not allowed&quot;),
<a name="18454"/>18454:                                    ok;
<a name="18455"/>18455:                                {error, Reason} = ERROR -&gt;
<a name="18456"/>18456:                                    ?SEV_EPRINT(&quot;Failed setting timestamp:&quot;
<a name="18457"/>18457:                                                &quot;   ~p&quot;, [Reason]),
<a name="18458"/>18458:                                    ERROR
<a name="18459"/>18459:                            end
<a name="18460"/>18460:                    end},
<a name="18461"/>18461: 
<a name="18462"/>18462:          #{desc =&gt; &quot;close socket&quot;,
<a name="18463"/>18463:            cmd  =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="18464"/>18464:                            ok = socket:close(Sock),
<a name="18465"/>18465:                            {ok, maps:remove(sock, State)}
<a name="18466"/>18466:                    end},
<a name="18467"/>18467: 
<a name="18468"/>18468:          %% *** We are done ***
<a name="18469"/>18469:          ?SEV_FINISH_NORMAL
<a name="18470"/>18470:         ],
<a name="18471"/>18471:     Evaluator = ?SEV_START(&quot;tester&quot;, Seq, InitState),
<a name="api_opt_sock_priority-last_expr"/><a name="18472"/>18472: <b>    ok = ?SEV_AWAIT_FINISH</b>([Evaluator]).
<a name="18473"/>18473: 
<a name="18474"/>18474: 
<a name="18475"/>18475: 
<a name="18476"/>18476: 
<a name="18477"/>18477: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="18478"/>18478: 
<a name="18479"/>18479: <i>%% Tests the 'SNDBUF' socket 'socket' option with IPv4 UDP:</i>
<a name="18480"/>18480: <i>%%</i>
<a name="18481"/>18481: <i>%%               socket:setopt(Sock, socket, sndbuf, integer()).</i>
<a name="18482"/>18482: <i>%%</i>
<a name="18483"/>18483: <i>%%</i>
<a name="18484"/>18484: 
<a name="api_opt_sock_rcvbuf_udp4-1"/><a name="18485"/>18485: <b>api_opt_sock_rcvbuf_udp4</b>(_Config) when is_list(_Config) -&gt;
<a name="18486"/>18486:     ?TT(?SECS(5)),
<a name="api_opt_sock_rcvbuf_udp4-last_expr"/><a name="18487"/>18487: <b>    tc_try</b>(api_opt_sock_rcvbuf_udp4,
<a name="18488"/>18488:            fun() -&gt; has_support_ipv4(), has_support_sock_rcvbuf() end,
<a name="18489"/>18489:            fun() -&gt;
<a name="18490"/>18490:                    ok = api_opt_sock_buf_udp4(rcvbuf)
<a name="18491"/>18491:            end).
<a name="18492"/>18492: 
<a name="18493"/>18493: 
<a name="18494"/>18494: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="18495"/>18495: 
<a name="18496"/>18496: <i>%% Tests the 'RCVBUF' socket 'socket' option with IPv4 UDP:</i>
<a name="18497"/>18497: <i>%%</i>
<a name="18498"/>18498: <i>%%               socket:setopt(Sock, socket, rcvbuf, integer()).</i>
<a name="18499"/>18499: <i>%%</i>
<a name="18500"/>18500: <i>%%</i>
<a name="18501"/>18501: 
<a name="api_opt_sock_sndbuf_udp4-1"/><a name="18502"/>18502: <b>api_opt_sock_sndbuf_udp4</b>(_Config) when is_list(_Config) -&gt;
<a name="18503"/>18503:     ?TT(?SECS(5)),
<a name="api_opt_sock_sndbuf_udp4-last_expr"/><a name="18504"/>18504: <b>    tc_try</b>(api_opt_sock_sndbuf_udp4,
<a name="18505"/>18505:            fun() -&gt; has_support_ipv4(), has_support_sock_sndbuf() end,
<a name="18506"/>18506:            fun() -&gt;
<a name="18507"/>18507:                    ok = api_opt_sock_buf_udp4(sndbuf)
<a name="18508"/>18508:            end).
<a name="18509"/>18509: 
<a name="18510"/>18510: 
<a name="18511"/>18511: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="18512"/>18512: 
<a name="api_opt_sock_buf_udp4-1"/><a name="18513"/>18513: <b>api_opt_sock_buf_udp4</b>(Opt) -&gt;
<a name="18514"/>18514:     Set  = fun(Sock, Value) -&gt;
<a name="18515"/>18515:                    socket:setopt(Sock, socket, Opt, Value)
<a name="18516"/>18516:            end,
<a name="18517"/>18517:     Get  = fun(Sock) -&gt;
<a name="18518"/>18518:                    socket:getopt(Sock, socket, Opt)
<a name="18519"/>18519:            end,
<a name="18520"/>18520:     InitState = #{domain =&gt; inet,
<a name="18521"/>18521:                   type   =&gt; dgram,
<a name="18522"/>18522:                   proto  =&gt; udp,
<a name="18523"/>18523:                   set    =&gt; Set,
<a name="18524"/>18524:                   get    =&gt; Get},
<a name="api_opt_sock_buf_udp4-last_expr"/><a name="18525"/>18525: <b>    ok = api_opt_sock_buf</b>(InitState).
<a name="18526"/>18526: 
<a name="18527"/>18527: 
<a name="api_opt_sock_buf-1"/><a name="18528"/>18528: <b>api_opt_sock_buf</b>(InitState) -&gt;
<a name="18529"/>18529:     Seq = 
<a name="18530"/>18530:         [
<a name="18531"/>18531:          #{desc =&gt; &quot;local address&quot;,
<a name="18532"/>18532:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="18533"/>18533:                            LSA = which_local_socket_addr(Domain),
<a name="18534"/>18534:                            {ok, State#{lsa =&gt; LSA}}
<a name="18535"/>18535:                    end},
<a name="18536"/>18536: 
<a name="18537"/>18537:          #{desc =&gt; &quot;open socket&quot;,
<a name="18538"/>18538:            cmd  =&gt; fun(#{domain := Domain,
<a name="18539"/>18539:                          type   := Type,
<a name="18540"/>18540:                          proto  := Proto} = State) -&gt;
<a name="18541"/>18541:                            Sock = sock_open(Domain, Type, Proto),
<a name="18542"/>18542:                            {ok, State#{sock =&gt; Sock}}
<a name="18543"/>18543:                    end},
<a name="18544"/>18544:          #{desc =&gt; &quot;bind&quot;,
<a name="18545"/>18545:            cmd  =&gt; fun(#{sock := Sock, lsa := LSA}) -&gt;
<a name="18546"/>18546:                            case sock_bind(Sock, LSA) of
<a name="18547"/>18547:                                ok -&gt;
<a name="18548"/>18548:                                    ?SEV_IPRINT(&quot;bound&quot;),
<a name="18549"/>18549:                                    ok;
<a name="18550"/>18550:                                {error, Reason} = ERROR -&gt;
<a name="18551"/>18551:                                    ?SEV_EPRINT(&quot;bind failed: ~p&quot;, [Reason]),
<a name="18552"/>18552:                                    ERROR
<a name="18553"/>18553:                            end
<a name="18554"/>18554:                    end},
<a name="18555"/>18555:          #{desc =&gt; &quot;get current (default) buffer size&quot;,
<a name="18556"/>18556:            cmd  =&gt; fun(#{sock := Sock, get := Get} = State) -&gt;
<a name="18557"/>18557:                            case Get(Sock) of
<a name="18558"/>18558:                                {ok, Sz} -&gt;
<a name="18559"/>18559:                                    ?SEV_IPRINT(&quot;(default) buffer: ~p&quot;,
<a name="18560"/>18560:                                                [Sz]),
<a name="18561"/>18561:                                    {ok, State#{default_sz =&gt; Sz}};
<a name="18562"/>18562:                                {error, Reason} = ERROR -&gt;
<a name="18563"/>18563:                                    ?SEV_EPRINT(&quot;Failed getting (default) &quot;
<a name="18564"/>18564:                                                &quot;buffer size:&quot;
<a name="18565"/>18565:                                                &quot;   ~p&quot;, [Reason]),
<a name="18566"/>18566:                                    ERROR
<a name="18567"/>18567:                            end
<a name="18568"/>18568:                    end},
<a name="18569"/>18569: 
<a name="18570"/>18570:          #{desc =&gt; &quot;change buffer size (default + 1024)&quot;,
<a name="18571"/>18571:            cmd  =&gt; fun(#{sock       := Sock,
<a name="18572"/>18572:                          default_sz := DefaultSz,
<a name="18573"/>18573:                          set        := Set} = State) -&gt;
<a name="18574"/>18574:                            NewSz = DefaultSz + 1024,
<a name="18575"/>18575:                            ?SEV_IPRINT(&quot;try set new buffer size to ~w&quot;, [NewSz]),
<a name="18576"/>18576:                            case Set(Sock, NewSz) of
<a name="18577"/>18577:                                ok -&gt;
<a name="18578"/>18578:                                    ?SEV_IPRINT(&quot;Buffer size change success&quot;, []),
<a name="18579"/>18579:                                    {ok, State#{new_sz =&gt; NewSz}};
<a name="18580"/>18580:                                {error, Reason} = ERROR -&gt;
<a name="18581"/>18581:                                    ?SEV_EPRINT(&quot;Failed changing buffer size:&quot;
<a name="18582"/>18582:                                                &quot;   ~p&quot;, [Reason]),
<a name="18583"/>18583:                                    ERROR
<a name="18584"/>18584:                            end
<a name="18585"/>18585:                    end},
<a name="18586"/>18586: 
<a name="18587"/>18587:          #{desc =&gt; &quot;validate buffer change&quot;,
<a name="18588"/>18588:            cmd  =&gt; fun(#{sock   := Sock,
<a name="18589"/>18589:                          get    := Get,
<a name="18590"/>18590:                          new_sz := ExpSz} = _State) -&gt;
<a name="18591"/>18591:                            ?SEV_IPRINT(&quot;try validate buffer size (~w)&quot;, [ExpSz]),
<a name="18592"/>18592:                            case Get(Sock) of
<a name="18593"/>18593:                                {ok, Sz} when (Sz &gt;= ExpSz) -&gt;
<a name="18594"/>18594:                                    ?SEV_IPRINT(&quot;buffer size validated:&quot;
<a name="18595"/>18595:                                                &quot;~n   Sz: ~w (~w)&quot;, [Sz, ExpSz]),
<a name="18596"/>18596:                                    ok;
<a name="18597"/>18597:                                {ok, Sz} -&gt;
<a name="18598"/>18598:                                    ?SEV_EPRINT(&quot;buffer size invalid:&quot;
<a name="18599"/>18599:                                                &quot;~n   Sz:          ~w&quot;
<a name="18600"/>18600:                                                &quot;~n   Expected Sz: ~w&quot;, [Sz, ExpSz]),
<a name="18601"/>18601:                                    {error, {invalid_size, Sz, ExpSz}};
<a name="18602"/>18602:                                {error, Reason} = ERROR -&gt;
<a name="18603"/>18603:                                    ?SEV_EPRINT(&quot;Failed get buffer size:&quot;
<a name="18604"/>18604:                                                &quot;   ~p&quot;, [Reason]),
<a name="18605"/>18605:                                    ERROR
<a name="18606"/>18606:                            end
<a name="18607"/>18607:                    end},
<a name="18608"/>18608: 
<a name="18609"/>18609:          #{desc =&gt; &quot;close socket&quot;,
<a name="18610"/>18610:            cmd  =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="18611"/>18611:                            ok = socket:close(Sock),
<a name="18612"/>18612:                            {ok, maps:remove(sock, State)}
<a name="18613"/>18613:                    end},
<a name="18614"/>18614: 
<a name="18615"/>18615:          %% *** We are done ***
<a name="18616"/>18616:          ?SEV_FINISH_NORMAL
<a name="18617"/>18617:         ],
<a name="18618"/>18618:     Evaluator = ?SEV_START(&quot;tester&quot;, Seq, InitState),
<a name="api_opt_sock_buf-last_expr"/><a name="18619"/>18619: <b>    ok = ?SEV_AWAIT_FINISH</b>([Evaluator]).
<a name="18620"/>18620: 
<a name="18621"/>18621: 
<a name="18622"/>18622: 
<a name="18623"/>18623: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="18624"/>18624: 
<a name="18625"/>18625: <i>%% Tests the 'RCVTIMEO' socket 'socket' option with IPv4 UDP:</i>
<a name="18626"/>18626: <i>%%</i>
<a name="18627"/>18627: <i>%%               socket:setopt(Sock, socket, rcvtimeo, #{sec  =&gt; integer(),</i>
<a name="18628"/>18628: <i>%%                                                       usec =&gt; integer()}).</i>
<a name="18629"/>18629: <i>%%</i>
<a name="18630"/>18630: <i>%% We should really test that the receive behaves as expected,</i>
<a name="18631"/>18631: <i>%% but we don't (we just set the value and read it back...)</i>
<a name="18632"/>18632: <i>%%</i>
<a name="18633"/>18633: 
<a name="api_opt_sock_rcvtimeo_udp4-1"/><a name="18634"/>18634: <b>api_opt_sock_rcvtimeo_udp4</b>(_Config) when is_list(_Config) -&gt;
<a name="18635"/>18635:     ?TT(?SECS(5)),
<a name="api_opt_sock_rcvtimeo_udp4-last_expr"/><a name="18636"/>18636: <b>    tc_try</b>(api_opt_sock_rcvtimeo_udp4,
<a name="18637"/>18637:            fun() -&gt; has_support_ipv4(), has_support_sock_rcvtimeo() end,
<a name="18638"/>18638:            fun() -&gt;
<a name="18639"/>18639:                    ok = api_opt_sock_timeo_udp4(rcvtimeo)
<a name="18640"/>18640:            end).
<a name="18641"/>18641: 
<a name="18642"/>18642: 
<a name="18643"/>18643: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="18644"/>18644: 
<a name="18645"/>18645: <i>%% Tests the 'SNDTIMEO' socket 'socket' option with IPv4 UDP:</i>
<a name="18646"/>18646: <i>%%</i>
<a name="18647"/>18647: <i>%%               socket:setopt(Sock, socket, sndtimeo, integer()).</i>
<a name="18648"/>18648: <i>%%</i>
<a name="18649"/>18649: <i>%%</i>
<a name="18650"/>18650: 
<a name="api_opt_sock_sndtimeo_udp4-1"/><a name="18651"/>18651: <b>api_opt_sock_sndtimeo_udp4</b>(_Config) when is_list(_Config) -&gt;
<a name="18652"/>18652:     ?TT(?SECS(5)),
<a name="api_opt_sock_sndtimeo_udp4-last_expr"/><a name="18653"/>18653: <b>    tc_try</b>(api_opt_sock_sndtimeo_udp4,
<a name="18654"/>18654:            fun() -&gt; has_support_ipv4(), has_support_sock_sndtimeo() end,
<a name="18655"/>18655:            fun() -&gt;
<a name="18656"/>18656:                    ok = api_opt_sock_timeo_udp4(sndtimeo)
<a name="18657"/>18657:            end).
<a name="18658"/>18658: 
<a name="18659"/>18659: 
<a name="18660"/>18660: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="18661"/>18661: 
<a name="api_opt_sock_timeo_udp4-1"/><a name="18662"/>18662: <b>api_opt_sock_timeo_udp4</b>(Opt) -&gt;
<a name="18663"/>18663:     Set  = fun(Sock, Value) -&gt;
<a name="18664"/>18664:                    socket:setopt(Sock, socket, Opt, Value)
<a name="18665"/>18665:            end,
<a name="18666"/>18666:     Get  = fun(Sock) -&gt;
<a name="18667"/>18667:                    socket:getopt(Sock, socket, Opt)
<a name="18668"/>18668:            end,
<a name="18669"/>18669:     InitState = #{domain =&gt; inet,
<a name="18670"/>18670:                   type   =&gt; dgram,
<a name="18671"/>18671:                   proto  =&gt; udp,
<a name="18672"/>18672: 		  opt   =&gt; Opt,
<a name="18673"/>18673:                   set    =&gt; Set,
<a name="18674"/>18674:                   get    =&gt; Get},
<a name="api_opt_sock_timeo_udp4-last_expr"/><a name="18675"/>18675: <b>    ok = api_opt_sock_timeo</b>(InitState).
<a name="18676"/>18676: 
<a name="18677"/>18677: 
<a name="api_opt_sock_timeo-1"/><a name="18678"/>18678: <b>api_opt_sock_timeo</b>(InitState) -&gt;
<a name="18679"/>18679:     Seq = 
<a name="18680"/>18680:         [
<a name="18681"/>18681:          #{desc =&gt; &quot;local address&quot;,
<a name="18682"/>18682:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="18683"/>18683:                            LSA = which_local_socket_addr(Domain),
<a name="18684"/>18684:                            {ok, State#{lsa =&gt; LSA}}
<a name="18685"/>18685:                    end},
<a name="18686"/>18686: 
<a name="18687"/>18687:          #{desc =&gt; &quot;open socket&quot;,
<a name="18688"/>18688:            cmd  =&gt; fun(#{domain := Domain,
<a name="18689"/>18689:                          type   := Type,
<a name="18690"/>18690:                          proto  := Proto} = State) -&gt;
<a name="18691"/>18691:                            Sock = sock_open(Domain, Type, Proto),
<a name="18692"/>18692:                            {ok, State#{sock =&gt; Sock}}
<a name="18693"/>18693:                    end},
<a name="18694"/>18694:          #{desc =&gt; &quot;bind&quot;,
<a name="18695"/>18695:            cmd  =&gt; fun(#{sock := Sock, lsa := LSA}) -&gt;
<a name="18696"/>18696:                            case sock_bind(Sock, LSA) of
<a name="18697"/>18697:                                ok -&gt;
<a name="18698"/>18698:                                    ?SEV_IPRINT(&quot;bound&quot;),
<a name="18699"/>18699:                                    ok;
<a name="18700"/>18700:                                {error, Reason} = ERROR -&gt;
<a name="18701"/>18701:                                    ?SEV_EPRINT(&quot;bind failed: ~p&quot;, [Reason]),
<a name="18702"/>18702:                                    ERROR
<a name="18703"/>18703:                            end
<a name="18704"/>18704:                    end},
<a name="18705"/>18705:          #{desc =&gt; &quot;get current (default) timeout&quot;,
<a name="18706"/>18706:            cmd  =&gt; fun(#{sock := Sock, get := Get} = State) -&gt;
<a name="18707"/>18707:                            case Get(Sock) of
<a name="18708"/>18708:                                {ok, #{sec := _, usec := _} = TO} -&gt;
<a name="18709"/>18709:                                    ?SEV_IPRINT(&quot;(default) timeout: ~p&quot;, [TO]),
<a name="18710"/>18710:                                    {ok, State#{default_timeo =&gt; TO}};
<a name="18711"/>18711:                                {error, enoprotoopt = Reason} -&gt;
<a name="18712"/>18712:                                    ?SEV_IPRINT(&quot;Failed getting (default) timeout:&quot;
<a name="18713"/>18713:                                                &quot;   ~p&quot;, [Reason]),
<a name="18714"/>18714:                                    {skip, Reason};
<a name="18715"/>18715:                                {error, Reason} = ERROR -&gt;
<a name="18716"/>18716:                                    ?SEV_EPRINT(&quot;Failed getting (default) timeout:&quot;
<a name="18717"/>18717:                                                &quot;   ~p&quot;, [Reason]),
<a name="18718"/>18718:                                    ERROR
<a name="18719"/>18719:                            end
<a name="18720"/>18720:                    end},
<a name="18721"/>18721: 
<a name="18722"/>18722:          #{desc =&gt; &quot;change timeout&quot;,
<a name="18723"/>18723:            cmd  =&gt; fun(#{sock          := Sock,
<a name="18724"/>18724:                          default_timeo := #{sec := DefaultSec} = DefaultTO,
<a name="18725"/>18725:                          set           := Set} = State) -&gt;
<a name="18726"/>18726:                            NewTO = DefaultTO#{sec =&gt; DefaultSec + 100},
<a name="18727"/>18727:                            ?SEV_IPRINT(&quot;try set new timeout to ~w&quot;, [NewTO]),
<a name="18728"/>18728:                            case Set(Sock, NewTO) of
<a name="18729"/>18729:                                ok -&gt;
<a name="18730"/>18730:                                    ?SEV_IPRINT(&quot;Timeout change success&quot;, []),
<a name="18731"/>18731:                                    {ok, State#{new_timeo =&gt; NewTO}};
<a name="18732"/>18732:                                {error, Reason} = ERROR -&gt;
<a name="18733"/>18733:                                    ?SEV_EPRINT(&quot;Failed changing timeout:&quot;
<a name="18734"/>18734:                                                &quot;   ~p&quot;, [Reason]),
<a name="18735"/>18735:                                    ERROR
<a name="18736"/>18736:                            end
<a name="18737"/>18737:                    end},
<a name="18738"/>18738: 
<a name="18739"/>18739:          #{desc =&gt; &quot;validate timeout change&quot;,
<a name="18740"/>18740:            cmd  =&gt; fun(#{sock      := Sock,
<a name="18741"/>18741:                          get       := Get,
<a name="18742"/>18742:                          new_timeo := #{sec := ExpSec} = ExpTO} = _State) -&gt;
<a name="18743"/>18743:                            ?SEV_IPRINT(&quot;try validate timeout (~w)&quot;, [ExpTO]),
<a name="18744"/>18744:                            case Get(Sock) of
<a name="18745"/>18745:                                {ok, ExpTO} -&gt;
<a name="18746"/>18746:                                    ?SEV_IPRINT(&quot;timeout (exactly) validated&quot;),
<a name="18747"/>18747:                                    ok;
<a name="18748"/>18748:                                {ok, #{sec := Sec}} when (ExpSec =:= Sec) -&gt;
<a name="18749"/>18749: 				   %% For some reason OpenBSD &quot;adjusts&quot; the timeout,
<a name="18750"/>18750: 				   %% so that usec does not (always match)
<a name="18751"/>18751:                                    ?SEV_IPRINT(&quot;timeout (approx) validated&quot;),
<a name="18752"/>18752:                                    ok;
<a name="18753"/>18753:                                {ok, TO} -&gt;
<a name="18754"/>18754:                                    ?SEV_EPRINT(&quot;timeout invalid:&quot;
<a name="18755"/>18755:                                                &quot;~n   Timeout:          ~w&quot;
<a name="18756"/>18756:                                                &quot;~n   Expected Timeout: ~w&quot;,
<a name="18757"/>18757:                                                [TO, ExpTO]),
<a name="18758"/>18758:                                    {error, {invalid_timeo, TO, ExpTO}};
<a name="18759"/>18759:                                {error, edom = Reason} -&gt;
<a name="18760"/>18760: 				   %% On OpenBSD (at least) its possible that if the value
<a name="18761"/>18761: 				   %% is too far &quot;out of bounds&quot;, this will be the result:
<a name="18762"/>18762: 				   %%
<a name="18763"/>18763: 				   %%     &quot;Numerical argument out of domain&quot;
<a name="18764"/>18764: 				   %%
<a name="18765"/>18765:                                    ?SEV_IPRINT(&quot;Failed get timeout:&quot;
<a name="18766"/>18766:                                                &quot;   ~p&quot;, [Reason]),
<a name="18767"/>18767:                                    {skip, Reason};
<a name="18768"/>18768:                                {error, Reason} = ERROR -&gt;
<a name="18769"/>18769:                                    ?SEV_EPRINT(&quot;Failed get timeout:&quot;
<a name="18770"/>18770:                                                &quot;   ~p&quot;, [Reason]),
<a name="18771"/>18771:                                    ERROR
<a name="18772"/>18772:                            end
<a name="18773"/>18773:                    end},
<a name="18774"/>18774: 
<a name="18775"/>18775:          #{desc =&gt; &quot;close socket&quot;,
<a name="18776"/>18776:            cmd  =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="18777"/>18777:                            ok = socket:close(Sock),
<a name="18778"/>18778:                            {ok, maps:remove(sock, State)}
<a name="18779"/>18779:                    end},
<a name="18780"/>18780: 
<a name="18781"/>18781:          %% *** We are done ***
<a name="18782"/>18782:          ?SEV_FINISH_NORMAL
<a name="18783"/>18783:         ],
<a name="18784"/>18784:     Evaluator = ?SEV_START(&quot;tester&quot;, Seq, InitState),
<a name="api_opt_sock_timeo-last_expr"/><a name="18785"/>18785: <b>    ok = ?SEV_AWAIT_FINISH</b>([Evaluator]).
<a name="18786"/>18786: 
<a name="18787"/>18787: 
<a name="18788"/>18788: 
<a name="18789"/>18789: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="18790"/>18790: 
<a name="18791"/>18791: <i>%% Tests the 'RCVLOWAT' socket 'socket' option with IPv4 UDP:</i>
<a name="18792"/>18792: <i>%%</i>
<a name="18793"/>18793: <i>%%               socket:setopt(Sock, socket, rcvlowat, integer()).</i>
<a name="18794"/>18794: <i>%%</i>
<a name="18795"/>18795: <i>%%</i>
<a name="18796"/>18796: 
<a name="api_opt_sock_rcvlowat_udp4-1"/><a name="18797"/>18797: <b>api_opt_sock_rcvlowat_udp4</b>(_Config) when is_list(_Config) -&gt;
<a name="18798"/>18798:     ?TT(?SECS(5)),
<a name="api_opt_sock_rcvlowat_udp4-last_expr"/><a name="18799"/>18799: <b>    tc_try</b>(api_opt_sock_rcvlowat_udp4,
<a name="18800"/>18800:            fun() -&gt;
<a name="18801"/>18801:                    is_not_windows(), % einval on Windows
<a name="18802"/>18802:                    has_support_ipv4(),
<a name="18803"/>18803:                    has_support_sock_rcvlowat()
<a name="18804"/>18804:            end,
<a name="18805"/>18805:            fun() -&gt;
<a name="18806"/>18806:                    ok = api_opt_sock_lowat_udp4(rcvlowat)
<a name="18807"/>18807:            end).
<a name="18808"/>18808: 
<a name="18809"/>18809: 
<a name="18810"/>18810: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="18811"/>18811: 
<a name="18812"/>18812: <i>%% Tests the 'SNDLOWAT' socket 'socket' option with IPv4 UDP:</i>
<a name="18813"/>18813: <i>%%</i>
<a name="18814"/>18814: <i>%%               socket:setopt(Sock, socket, sndlowat, integer()).</i>
<a name="18815"/>18815: <i>%%</i>
<a name="18816"/>18816: <i>%% This is (currently) not changeable on linux (among others),</i>
<a name="18817"/>18817: <i>%% so we skip if we get ENOPROTOOPT when attempting a change.</i>
<a name="18818"/>18818: <i>%%</i>
<a name="18819"/>18819: 
<a name="api_opt_sock_sndlowat_udp4-1"/><a name="18820"/>18820: <b>api_opt_sock_sndlowat_udp4</b>(_Config) when is_list(_Config) -&gt;
<a name="18821"/>18821:     ?TT(?SECS(5)),
<a name="api_opt_sock_sndlowat_udp4-last_expr"/><a name="18822"/>18822: <b>    tc_try</b>(api_opt_sock_sndlowat_udp4,
<a name="18823"/>18823:            fun() -&gt;
<a name="18824"/>18824:                    is_not_windows(), % einval on Windows
<a name="18825"/>18825:                    has_support_ipv4(),
<a name="18826"/>18826:                    has_support_sock_sndlowat()
<a name="18827"/>18827:            end,
<a name="18828"/>18828:            fun() -&gt;
<a name="18829"/>18829:                    ok = api_opt_sock_lowat_udp4(sndlowat)
<a name="18830"/>18830:            end).
<a name="18831"/>18831: 
<a name="18832"/>18832: 
<a name="18833"/>18833: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="18834"/>18834: 
<a name="api_opt_sock_lowat_udp4-1"/><a name="18835"/>18835: <b>api_opt_sock_lowat_udp4</b>(Opt) -&gt;
<a name="18836"/>18836:     Set  = fun(Sock, Value) -&gt;
<a name="18837"/>18837:                    socket:setopt(Sock, socket, Opt, Value)
<a name="18838"/>18838:            end,
<a name="18839"/>18839:     Get  = fun(Sock) -&gt;
<a name="18840"/>18840:                    socket:getopt(Sock, socket, Opt)
<a name="18841"/>18841:            end,
<a name="18842"/>18842:     InitState = #{domain =&gt; inet,
<a name="18843"/>18843:                   type   =&gt; dgram,
<a name="18844"/>18844:                   proto  =&gt; udp,
<a name="18845"/>18845:                   set    =&gt; Set,
<a name="18846"/>18846:                   get    =&gt; Get},
<a name="api_opt_sock_lowat_udp4-last_expr"/><a name="18847"/>18847: <b>    ok = api_opt_sock_lowat</b>(InitState).
<a name="18848"/>18848: 
<a name="18849"/>18849: 
<a name="api_opt_sock_lowat-1"/><a name="18850"/>18850: <b>api_opt_sock_lowat</b>(InitState) -&gt;
<a name="18851"/>18851:     Seq = 
<a name="18852"/>18852:         [
<a name="18853"/>18853:          #{desc =&gt; &quot;local address&quot;,
<a name="18854"/>18854:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="18855"/>18855:                            LSA = which_local_socket_addr(Domain),
<a name="18856"/>18856:                            {ok, State#{lsa =&gt; LSA}}
<a name="18857"/>18857:                    end},
<a name="18858"/>18858: 
<a name="18859"/>18859:          #{desc =&gt; &quot;open socket&quot;,
<a name="18860"/>18860:            cmd  =&gt; fun(#{domain := Domain,
<a name="18861"/>18861:                          type   := Type,
<a name="18862"/>18862:                          proto  := Proto} = State) -&gt;
<a name="18863"/>18863:                            Sock = sock_open(Domain, Type, Proto),
<a name="18864"/>18864:                            {ok, State#{sock =&gt; Sock}}
<a name="18865"/>18865:                    end},
<a name="18866"/>18866:          #{desc =&gt; &quot;bind&quot;,
<a name="18867"/>18867:            cmd  =&gt; fun(#{sock := Sock, lsa := LSA}) -&gt;
<a name="18868"/>18868:                            case sock_bind(Sock, LSA) of
<a name="18869"/>18869:                                ok -&gt;
<a name="18870"/>18870:                                    ?SEV_IPRINT(&quot;bound&quot;),
<a name="18871"/>18871:                                    ok;
<a name="18872"/>18872:                                {error, Reason} = ERROR -&gt;
<a name="18873"/>18873:                                    ?SEV_EPRINT(&quot;bind failed: ~p&quot;, [Reason]),
<a name="18874"/>18874:                                    ERROR
<a name="18875"/>18875:                            end
<a name="18876"/>18876:                    end},
<a name="18877"/>18877:          #{desc =&gt; &quot;get current (default) lowat&quot;,
<a name="18878"/>18878:            cmd  =&gt; fun(#{sock := Sock, get := Get} = State) -&gt;
<a name="18879"/>18879:                            case Get(Sock) of
<a name="18880"/>18880:                                {ok, LOWAT} -&gt;
<a name="18881"/>18881:                                    ?SEV_IPRINT(&quot;(default) lowat: ~p&quot;,
<a name="18882"/>18882:                                                [LOWAT]),
<a name="18883"/>18883:                                    {ok, State#{default_lowat =&gt; LOWAT}};
<a name="18884"/>18884:                                {error, enoprotoopt = Reason} -&gt;
<a name="18885"/>18885:                                    ?SEV_IPRINT(&quot;Failed getting (default) lowat:&quot;
<a name="18886"/>18886:                                                &quot;   ~p&quot;, [Reason]),
<a name="18887"/>18887:                                    {skip, Reason};
<a name="18888"/>18888:                                {error, Reason} = ERROR -&gt;
<a name="18889"/>18889:                                    ?SEV_EPRINT(&quot;Failed getting (default) lowat:&quot;
<a name="18890"/>18890:                                                &quot;   ~p&quot;, [Reason]),
<a name="18891"/>18891:                                    ERROR
<a name="18892"/>18892:                            end
<a name="18893"/>18893:                    end},
<a name="18894"/>18894: 
<a name="18895"/>18895:          #{desc =&gt; &quot;change lowat ( + 1 )&quot;,
<a name="18896"/>18896:            cmd  =&gt; fun(#{sock          := Sock,
<a name="18897"/>18897:                          default_lowat := DefaultLOWAT,
<a name="18898"/>18898:                          set           := Set} = State) -&gt;
<a name="18899"/>18899:                            NewLOWAT = DefaultLOWAT + 1,
<a name="18900"/>18900:                            ?SEV_IPRINT(&quot;try set new lowat to ~w&quot;, [NewLOWAT]),
<a name="18901"/>18901:                            case Set(Sock, NewLOWAT) of
<a name="18902"/>18902:                                ok -&gt;
<a name="18903"/>18903:                                    ?SEV_IPRINT(&quot;LOWAT change success&quot;, []),
<a name="18904"/>18904:                                    {ok, State#{new_lowat =&gt; NewLOWAT}};
<a name="18905"/>18905:                                {error, enoprotoopt} -&gt;
<a name="18906"/>18906:                                    ?SEV_IPRINT(&quot;LOWAT not changeable&quot;, []),
<a name="18907"/>18907:                                    {skip, &quot;Not changeable&quot;};
<a name="18908"/>18908:                                {error, Reason} = ERROR -&gt;
<a name="18909"/>18909:                                    ?SEV_EPRINT(&quot;Failed changing buffer size:&quot;
<a name="18910"/>18910:                                                &quot;   ~p&quot;, [Reason]),
<a name="18911"/>18911:                                    ERROR
<a name="18912"/>18912:                            end
<a name="18913"/>18913:                    end},
<a name="18914"/>18914: 
<a name="18915"/>18915:          #{desc =&gt; &quot;validate lowat&quot;,
<a name="18916"/>18916:            cmd  =&gt; fun(#{sock      := Sock,
<a name="18917"/>18917:                          get       := Get,
<a name="18918"/>18918:                          new_lowat := ExpLOWAT} = _State) -&gt;
<a name="18919"/>18919:                            ?SEV_IPRINT(&quot;try validate lowat (~w)&quot;, [ExpLOWAT]),
<a name="18920"/>18920:                            case Get(Sock) of
<a name="18921"/>18921:                                {ok, ExpLOWAT} -&gt;
<a name="18922"/>18922:                                    ?SEV_IPRINT(&quot;lowat validated:&quot;
<a name="18923"/>18923:                                                &quot;~n   LOWAT: ~w&quot;, [ExpLOWAT]),
<a name="18924"/>18924:                                    ok;
<a name="18925"/>18925:                                {ok, LOWAT} -&gt;
<a name="18926"/>18926:                                    ?SEV_EPRINT(&quot;lowat invalid:&quot;
<a name="18927"/>18927:                                                &quot;~n   LOWAT:          ~w&quot;
<a name="18928"/>18928:                                                &quot;~n   Expected LOWAT: ~w&quot;,
<a name="18929"/>18929:                                                [LOWAT, ExpLOWAT]),
<a name="18930"/>18930:                                    {error, {invalid_lowat, LOWAT, ExpLOWAT}};
<a name="18931"/>18931:                                {error, Reason} = ERROR -&gt;
<a name="18932"/>18932:                                    ?SEV_EPRINT(&quot;Failed get lowat:&quot;
<a name="18933"/>18933:                                                &quot;   ~p&quot;, [Reason]),
<a name="18934"/>18934:                                    ERROR
<a name="18935"/>18935:                            end
<a name="18936"/>18936:                    end},
<a name="18937"/>18937: 
<a name="18938"/>18938:          #{desc =&gt; &quot;close socket&quot;,
<a name="18939"/>18939:            cmd  =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="18940"/>18940:                            ok = socket:close(Sock),
<a name="18941"/>18941:                            {ok, maps:remove(sock, State)}
<a name="18942"/>18942:                    end},
<a name="18943"/>18943: 
<a name="18944"/>18944:          %% *** We are done ***
<a name="18945"/>18945:          ?SEV_FINISH_NORMAL
<a name="18946"/>18946:         ],
<a name="18947"/>18947:     Evaluator = ?SEV_START(&quot;tester&quot;, Seq, InitState),
<a name="api_opt_sock_lowat-last_expr"/><a name="18948"/>18948: <b>    ok = ?SEV_AWAIT_FINISH</b>([Evaluator]).
<a name="18949"/>18949: 
<a name="18950"/>18950: 
<a name="18951"/>18951: 
<a name="18952"/>18952: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="18953"/>18953: 
<a name="18954"/>18954: <i>%% Tests that the timestamp control message header is received when</i>
<a name="18955"/>18955: <i>%% setting the socket 'socket' option true when using sendmsg/recvmsg</i>
<a name="18956"/>18956: <i>%% on an IPv4 UDP (dgram) socket.</i>
<a name="18957"/>18957: <i>%% So, this is done on the receiving side: </i>
<a name="18958"/>18958: <i>%%</i>
<a name="18959"/>18959: <i>%%               socket:setopt(Sock, socket, timestamp, boolean()).</i>
<a name="18960"/>18960: <i>%%</i>
<a name="18961"/>18961: <i>%% All subsequent *received* messages will be timestamped.</i>
<a name="18962"/>18962: <i>%%</i>
<a name="18963"/>18963: 
<a name="api_opt_sock_timestamp_udp4-1"/><a name="18964"/>18964: <b>api_opt_sock_timestamp_udp4</b>(_Config) when is_list(_Config) -&gt;
<a name="18965"/>18965:     ?TT(?SECS(5)),
<a name="api_opt_sock_timestamp_udp4-last_expr"/><a name="18966"/>18966: <b>    tc_try</b>(api_opt_sock_timestamp_udp4,
<a name="18967"/>18967:            fun() -&gt; has_support_ipv4(), has_support_sock_timestamp() end,
<a name="18968"/>18968:            fun() -&gt;
<a name="18969"/>18969:                    Set  = fun(Sock, Value) -&gt;
<a name="18970"/>18970:                                   socket:setopt(Sock, socket, timestamp, Value)
<a name="18971"/>18971:                           end,
<a name="18972"/>18972:                    Get  = fun(Sock) -&gt;
<a name="18973"/>18973:                                   socket:getopt(Sock, socket, timestamp)
<a name="18974"/>18974:                           end,
<a name="18975"/>18975:                    Send = fun(Sock, Data, Dest) -&gt;
<a name="18976"/>18976:                                   Msg = #{addr =&gt; Dest,
<a name="18977"/>18977:                                              iov  =&gt; [Data]},
<a name="18978"/>18978:                                   socket:sendmsg(Sock, Msg)
<a name="18979"/>18979:                           end,
<a name="18980"/>18980:                    Recv = fun(Sock) -&gt;
<a name="18981"/>18981:                                   case socket:recvmsg(Sock) of
<a name="18982"/>18982:                                       {ok, #{addr := Source,
<a name="18983"/>18983:                                              ctrl := CMsgs,
<a name="18984"/>18984:                                              iov  := [Data]}} -&gt;
<a name="18985"/>18985:                                           {ok, {Source, CMsgs, Data}};
<a name="18986"/>18986:                                       {error, _} = ERROR -&gt;
<a name="18987"/>18987:                                           ERROR
<a name="18988"/>18988:                                   end
<a name="18989"/>18989:                           end,
<a name="18990"/>18990:                    InitState = #{domain =&gt; inet,
<a name="18991"/>18991:                                  proto  =&gt; udp,
<a name="18992"/>18992:                                  send   =&gt; Send,
<a name="18993"/>18993:                                  recv   =&gt; Recv,
<a name="18994"/>18994:                                  set    =&gt; Set,
<a name="18995"/>18995:                                  get    =&gt; Get},
<a name="18996"/>18996:                    ok = api_opt_sock_timestamp_udp(InitState)
<a name="18997"/>18997:            end).
<a name="18998"/>18998: 
<a name="18999"/>18999: 
<a name="19000"/>19000: 
<a name="19001"/>19001: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="19002"/>19002: 
<a name="api_opt_sock_timestamp_udp-1"/><a name="19003"/>19003: <b>api_opt_sock_timestamp_udp</b>(InitState) -&gt;
<a name="19004"/>19004:     Seq = 
<a name="19005"/>19005:         [
<a name="19006"/>19006:          #{desc =&gt; &quot;local address&quot;,
<a name="19007"/>19007:            cmd  =&gt; fun(#{domain := local = Domain} = State) -&gt;
<a name="19008"/>19008:                            LSASrc = which_local_socket_addr(Domain),
<a name="19009"/>19009:                            LSADst = which_local_socket_addr(Domain),
<a name="19010"/>19010:                            {ok, State#{lsa_src =&gt; LSASrc,
<a name="19011"/>19011:                                        lsa_dst =&gt; LSADst}};
<a name="19012"/>19012:                       (#{domain := Domain} = State) -&gt;
<a name="19013"/>19013:                            LSA = which_local_socket_addr(Domain),
<a name="19014"/>19014:                            {ok, State#{lsa_src =&gt; LSA,
<a name="19015"/>19015:                                        lsa_dst =&gt; LSA}}
<a name="19016"/>19016:                    end},
<a name="19017"/>19017: 
<a name="19018"/>19018:          #{desc =&gt; &quot;open src socket&quot;,
<a name="19019"/>19019:            cmd  =&gt; fun(#{domain := Domain,
<a name="19020"/>19020:                          proto  := Proto} = State) -&gt;
<a name="19021"/>19021:                            Sock = sock_open(Domain, dgram, Proto),
<a name="19022"/>19022:                            {ok, State#{sock_src =&gt; Sock}}
<a name="19023"/>19023:                    end},
<a name="19024"/>19024:          #{desc =&gt; &quot;bind src&quot;,
<a name="19025"/>19025:            cmd  =&gt; fun(#{sock_src := Sock, lsa_src := LSA}) -&gt;
<a name="19026"/>19026:                            case sock_bind(Sock, LSA) of
<a name="19027"/>19027:                                ok -&gt;
<a name="19028"/>19028:                                    ?SEV_IPRINT(&quot;src bound&quot;),
<a name="19029"/>19029:                                    ok;
<a name="19030"/>19030:                                {error, Reason} = ERROR -&gt;
<a name="19031"/>19031:                                    ?SEV_EPRINT(&quot;src bind failed: ~p&quot;, [Reason]),
<a name="19032"/>19032:                                    ERROR
<a name="19033"/>19033:                            end
<a name="19034"/>19034:                    end},
<a name="19035"/>19035:          #{desc =&gt; &quot;sockname src socket&quot;,
<a name="19036"/>19036:            cmd  =&gt; fun(#{sock_src := Sock} = State) -&gt;
<a name="19037"/>19037:                            SASrc = sock_sockname(Sock),
<a name="19038"/>19038:                            ?SEV_IPRINT(&quot;src sockaddr: &quot;
<a name="19039"/>19039:                                        &quot;~n   ~p&quot;, [SASrc]),
<a name="19040"/>19040:                            {ok, State#{sa_src =&gt; SASrc}}
<a name="19041"/>19041:                    end},
<a name="19042"/>19042:          #{desc =&gt; &quot;get current (default) timestamp for src socket&quot;,
<a name="19043"/>19043:            cmd  =&gt; fun(#{sock_src := Sock, get := Get} = _State) -&gt;
<a name="19044"/>19044:                            case Get(Sock) of
<a name="19045"/>19045:                                {ok, false = Value} -&gt;
<a name="19046"/>19046:                                    ?SEV_IPRINT(&quot;src timestamp: ~p&quot;, [Value]),
<a name="19047"/>19047:                                    ok;
<a name="19048"/>19048:                                {ok, Unexpected} -&gt;
<a name="19049"/>19049:                                    ?SEV_EPRINT(&quot;Unexpected src timestamp: ~p&quot;,
<a name="19050"/>19050:                                                [Unexpected]),
<a name="19051"/>19051:                                    {error, {unexpected, Unexpected}};
<a name="19052"/>19052:                                {error, Reason} = ERROR -&gt;
<a name="19053"/>19053:                                    ?SEV_EPRINT(&quot;Failed getting (default) timestamp:&quot;
<a name="19054"/>19054:                                                &quot;   ~p&quot;, [Reason]),
<a name="19055"/>19055:                                    ERROR
<a name="19056"/>19056:                            end
<a name="19057"/>19057:                    end},
<a name="19058"/>19058: 
<a name="19059"/>19059:          #{desc =&gt; &quot;open dst socket&quot;,
<a name="19060"/>19060:            cmd  =&gt; fun(#{domain := Domain,
<a name="19061"/>19061:                          proto  := Proto} = State) -&gt;
<a name="19062"/>19062:                            Sock = sock_open(Domain, dgram, Proto),
<a name="19063"/>19063:                            {ok, State#{sock_dst =&gt; Sock}}
<a name="19064"/>19064:                    end},
<a name="19065"/>19065:          #{desc =&gt; &quot;bind dst&quot;,
<a name="19066"/>19066:            cmd  =&gt; fun(#{sock_dst := Sock, lsa_dst := LSA}) -&gt;
<a name="19067"/>19067:                            case sock_bind(Sock, LSA) of
<a name="19068"/>19068:                                ok -&gt;
<a name="19069"/>19069:                                    ?SEV_IPRINT(&quot;src bound&quot;),
<a name="19070"/>19070:                                    ok;
<a name="19071"/>19071:                                {error, Reason} = ERROR -&gt;
<a name="19072"/>19072:                                    ?SEV_EPRINT(&quot;src bind failed: ~p&quot;, [Reason]),
<a name="19073"/>19073:                                    ERROR
<a name="19074"/>19074:                            end
<a name="19075"/>19075:                    end},
<a name="19076"/>19076:          #{desc =&gt; &quot;sockname dst socket&quot;,
<a name="19077"/>19077:            cmd  =&gt; fun(#{sock_dst := Sock} = State) -&gt;
<a name="19078"/>19078:                            SADst = sock_sockname(Sock),
<a name="19079"/>19079:                            ?SEV_IPRINT(&quot;dst sockaddr: &quot;
<a name="19080"/>19080:                                        &quot;~n   ~p&quot;, [SADst]),
<a name="19081"/>19081:                            {ok, State#{sa_dst =&gt; SADst}}
<a name="19082"/>19082:                    end},
<a name="19083"/>19083: 
<a name="19084"/>19084:          #{desc =&gt; &quot;send req (to dst) (WO TIMESTAMP)&quot;,
<a name="19085"/>19085:            cmd  =&gt; fun(#{sock_src := Sock, sa_dst := Dst, send := Send}) -&gt;
<a name="19086"/>19086:                            Send(Sock, ?BASIC_REQ, Dst)
<a name="19087"/>19087:                    end},
<a name="19088"/>19088:          #{desc =&gt; &quot;recv req (from src)&quot;,
<a name="19089"/>19089:            cmd  =&gt; fun(#{sock_dst := Sock, sa_src := Src, recv := Recv}) -&gt;
<a name="19090"/>19090:                            case Recv(Sock) of
<a name="19091"/>19091:                                {ok, {Src, [], ?BASIC_REQ}} -&gt;
<a name="19092"/>19092:                                    ok;
<a name="19093"/>19093:                                {ok, {BadSrc, BadCHdrs, BadReq} = UnexpData} -&gt;
<a name="19094"/>19094:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="19095"/>19095:                                                &quot;~n   Expect Source: ~p&quot;
<a name="19096"/>19096:                                                &quot;~n   Recv Source:   ~p&quot;
<a name="19097"/>19097:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="19098"/>19098:                                                &quot;~n   Recv CHdrs:    ~p&quot;
<a name="19099"/>19099:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="19100"/>19100:                                                &quot;~n   Recv Msg:      ~p&quot;,
<a name="19101"/>19101:                                                [Src, BadSrc,
<a name="19102"/>19102:                                                 [], BadCHdrs,
<a name="19103"/>19103:                                                 ?BASIC_REQ, BadReq]),
<a name="19104"/>19104:                                    {error, {unexpected_data, UnexpData}};
<a name="19105"/>19105:                                {ok, UnexpData} -&gt;
<a name="19106"/>19106:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="19107"/>19107:                                                &quot;~n   Expect Source: ~p&quot;
<a name="19108"/>19108:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="19109"/>19109:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="19110"/>19110:                                                &quot;~n   Unexp Data:    ~p&quot;,
<a name="19111"/>19111:                                                [Src, [], ?BASIC_REQ, UnexpData]),
<a name="19112"/>19112:                                    {error, {unexpected_data, UnexpData}};
<a name="19113"/>19113:                                {error, _} = ERROR -&gt;
<a name="19114"/>19114:                                    %% At the moment there is no way to get
<a name="19115"/>19115:                                    %% status or state for the socket...
<a name="19116"/>19116:                                    ERROR
<a name="19117"/>19117:                            end
<a name="19118"/>19118:                    end},
<a name="19119"/>19119:          #{desc =&gt; &quot;send rep (to src)&quot;,
<a name="19120"/>19120:            cmd  =&gt; fun(#{sock_dst := Sock, sa_src := Src, send := Send}) -&gt;
<a name="19121"/>19121:                            Send(Sock, ?BASIC_REP, Src)
<a name="19122"/>19122:                    end},
<a name="19123"/>19123:          #{desc =&gt; &quot;recv rep (from dst)&quot;,
<a name="19124"/>19124:            cmd  =&gt; fun(#{sock_src := Sock, sa_dst := Dst, recv := Recv}) -&gt;
<a name="19125"/>19125:                            case Recv(Sock) of
<a name="19126"/>19126:                                {ok, {Dst, [], ?BASIC_REP}} -&gt;
<a name="19127"/>19127:                                    ok;
<a name="19128"/>19128:                                {ok, UnexpData} -&gt;
<a name="19129"/>19129:                                    {error, {unexpected_data, UnexpData}};
<a name="19130"/>19130:                                {error, _} = ERROR -&gt;
<a name="19131"/>19131:                                    %% At the moment there is no way to get
<a name="19132"/>19132:                                    %% status or state for the socket...
<a name="19133"/>19133:                                    ERROR
<a name="19134"/>19134:                            end
<a name="19135"/>19135:                    end},
<a name="19136"/>19136: 
<a name="19137"/>19137: 
<a name="19138"/>19138:          #{desc =&gt; &quot;enable timestamp on dst socket&quot;,
<a name="19139"/>19139:            cmd  =&gt; fun(#{sock_dst := Sock, set := Set} = _State) -&gt;
<a name="19140"/>19140:                            case Set(Sock, true) of
<a name="19141"/>19141:                                ok -&gt;
<a name="19142"/>19142:                                    ?SEV_IPRINT(&quot;dst timestamp enabled&quot;),
<a name="19143"/>19143:                                    ok;
<a name="19144"/>19144:                                {error, Reason} = ERROR -&gt;
<a name="19145"/>19145:                                    ?SEV_EPRINT(&quot;Failed setting timestamp:&quot;
<a name="19146"/>19146:                                                &quot;   ~p&quot;, [Reason]),
<a name="19147"/>19147:                                    ERROR
<a name="19148"/>19148:                            end
<a name="19149"/>19149:                    end},
<a name="19150"/>19150: 
<a name="19151"/>19151: 
<a name="19152"/>19152:          #{desc =&gt; &quot;send req 1 (to dst) (W TIMESTAMP)&quot;,
<a name="19153"/>19153:            cmd  =&gt; fun(#{sock_src := Sock, sa_dst := Dst, send := Send}) -&gt;
<a name="19154"/>19154:                            Send(Sock, ?BASIC_REQ, Dst)
<a name="19155"/>19155:                    end},
<a name="19156"/>19156:          #{desc =&gt; &quot;recv req (from src)&quot;,
<a name="19157"/>19157:            cmd  =&gt; fun(#{sock_dst := Sock, sa_src := Src, recv := Recv}) -&gt;
<a name="19158"/>19158:                            case Recv(Sock) of
<a name="19159"/>19159:                                {ok, {Src, [#{level := socket,
<a name="19160"/>19160:                                              type  := timestamp,
<a name="19161"/>19161:                                              value := TS}], ?BASIC_REQ}} -&gt;
<a name="19162"/>19162:                                    ?SEV_IPRINT(&quot;received req *with* &quot;
<a name="19163"/>19163:                                                &quot;expected timestamp: &quot;
<a name="19164"/>19164:                                                &quot;~n   ~p&quot;, [TS]),
<a name="19165"/>19165:                                    ok;
<a name="19166"/>19166:                                {ok, {Src, CMsgs, ?BASIC_REQ}} -&gt;
<a name="19167"/>19167:                                    ?SEV_EPRINT(&quot;Unexpected control message(s):&quot;
<a name="19168"/>19168:                                                &quot;~n   CMsgs: ~p&quot;,
<a name="19169"/>19169:                                                [CMsgs]),
<a name="19170"/>19170:                                    {error, {unexpected_cmsgs, CMsgs}};
<a name="19171"/>19171:                                {ok, UnexpData} -&gt;
<a name="19172"/>19172:                                    {error, {unexpected_data, UnexpData}};
<a name="19173"/>19173:                                {error, _} = ERROR -&gt;
<a name="19174"/>19174:                                    %% At the moment there is no way to get
<a name="19175"/>19175:                                    %% status or state for the socket...
<a name="19176"/>19176:                                    ERROR
<a name="19177"/>19177:                            end
<a name="19178"/>19178:                    end},
<a name="19179"/>19179:          #{desc =&gt; &quot;send rep (to src)&quot;,
<a name="19180"/>19180:            cmd  =&gt; fun(#{sock_dst := Sock, sa_src := Src, send := Send}) -&gt;
<a name="19181"/>19181:                            Send(Sock, ?BASIC_REP, Src)
<a name="19182"/>19182:                    end},
<a name="19183"/>19183:          #{desc =&gt; &quot;recv rep (from dst)&quot;,
<a name="19184"/>19184:            cmd  =&gt; fun(#{sock_src := Sock, sa_dst := Dst, recv := Recv}) -&gt;
<a name="19185"/>19185:                            case Recv(Sock) of
<a name="19186"/>19186:                                {ok, {Dst, [], ?BASIC_REP}} -&gt;
<a name="19187"/>19187:                                    ok;
<a name="19188"/>19188:                                {ok, UnexpData} -&gt;
<a name="19189"/>19189:                                    {error, {unexpected_data, UnexpData}};
<a name="19190"/>19190:                                {error, _} = ERROR -&gt;
<a name="19191"/>19191:                                    %% At the moment there is no way to get
<a name="19192"/>19192:                                    %% status or state for the socket...
<a name="19193"/>19193:                                    ERROR
<a name="19194"/>19194:                            end
<a name="19195"/>19195:                    end},
<a name="19196"/>19196: 
<a name="19197"/>19197: 
<a name="19198"/>19198:          #{desc =&gt; &quot;send req 2 (to dst) (W TIMESTAMP)&quot;,
<a name="19199"/>19199:            cmd  =&gt; fun(#{sock_src := Sock, sa_dst := Dst, send := Send}) -&gt;
<a name="19200"/>19200:                            Send(Sock, ?BASIC_REQ, Dst)
<a name="19201"/>19201:                    end},
<a name="19202"/>19202:          #{desc =&gt; &quot;recv req (from src)&quot;,
<a name="19203"/>19203:            cmd  =&gt; fun(#{sock_dst := Sock, sa_src := Src, recv := Recv}) -&gt;
<a name="19204"/>19204:                            case Recv(Sock) of
<a name="19205"/>19205:                                {ok, {Src, [#{level := socket,
<a name="19206"/>19206:                                              type  := timestamp,
<a name="19207"/>19207:                                              value := TS}], ?BASIC_REQ}} -&gt;
<a name="19208"/>19208:                                    ?SEV_IPRINT(&quot;received req *with* &quot;
<a name="19209"/>19209:                                                &quot;expected timestamp: &quot;
<a name="19210"/>19210:                                                &quot;~n   ~p&quot;, [TS]),
<a name="19211"/>19211:                                    ok;
<a name="19212"/>19212:                                {ok, UnexpData} -&gt;
<a name="19213"/>19213:                                    {error, {unexpected_data, UnexpData}};
<a name="19214"/>19214:                                {error, _} = ERROR -&gt;
<a name="19215"/>19215:                                    %% At the moment there is no way to get
<a name="19216"/>19216:                                    %% status or state for the socket...
<a name="19217"/>19217:                                    ERROR
<a name="19218"/>19218:                            end
<a name="19219"/>19219:                    end},
<a name="19220"/>19220:          #{desc =&gt; &quot;send rep (to src)&quot;,
<a name="19221"/>19221:            cmd  =&gt; fun(#{sock_dst := Sock, sa_src := Src, send := Send}) -&gt;
<a name="19222"/>19222:                            Send(Sock, ?BASIC_REP, Src)
<a name="19223"/>19223:                    end},
<a name="19224"/>19224:          #{desc =&gt; &quot;recv rep (from dst)&quot;,
<a name="19225"/>19225:            cmd  =&gt; fun(#{sock_src := Sock, sa_dst := Dst, recv := Recv}) -&gt;
<a name="19226"/>19226:                            case Recv(Sock) of
<a name="19227"/>19227:                                {ok, {Dst, [], ?BASIC_REP}} -&gt;
<a name="19228"/>19228:                                    ok;
<a name="19229"/>19229:                                {ok, UnexpData} -&gt;
<a name="19230"/>19230:                                    {error, {unexpected_data, UnexpData}};
<a name="19231"/>19231:                                {error, _} = ERROR -&gt;
<a name="19232"/>19232:                                    %% At the moment there is no way to get
<a name="19233"/>19233:                                    %% status or state for the socket...
<a name="19234"/>19234:                                    ERROR
<a name="19235"/>19235:                            end
<a name="19236"/>19236:                    end},
<a name="19237"/>19237: 
<a name="19238"/>19238: 
<a name="19239"/>19239:          #{desc =&gt; &quot;disable timestamps on dst socket&quot;,
<a name="19240"/>19240:            cmd  =&gt; fun(#{sock_dst := Sock, set := Set} = _State) -&gt;
<a name="19241"/>19241:                            case Set(Sock, false) of
<a name="19242"/>19242:                                ok -&gt;
<a name="19243"/>19243:                                    ?SEV_IPRINT(&quot;dst timestamp disabled&quot;),
<a name="19244"/>19244:                                    ok;
<a name="19245"/>19245:                                {error, Reason} = ERROR -&gt;
<a name="19246"/>19246:                                    ?SEV_EPRINT(&quot;Failed setting timestamp:&quot;
<a name="19247"/>19247:                                                &quot;   ~p&quot;, [Reason]),
<a name="19248"/>19248:                                    ERROR
<a name="19249"/>19249:                            end
<a name="19250"/>19250:                    end},
<a name="19251"/>19251: 
<a name="19252"/>19252: 
<a name="19253"/>19253:          #{desc =&gt; &quot;send req (to dst) (WO TIMESTAMP)&quot;,
<a name="19254"/>19254:            cmd  =&gt; fun(#{sock_src := Sock, sa_dst := Dst, send := Send}) -&gt;
<a name="19255"/>19255:                            Send(Sock, ?BASIC_REQ, Dst)
<a name="19256"/>19256:                    end},
<a name="19257"/>19257:          #{desc =&gt; &quot;recv req (from src)&quot;,
<a name="19258"/>19258:            cmd  =&gt; fun(#{sock_dst := Sock, sa_src := Src, recv := Recv}) -&gt;
<a name="19259"/>19259:                            case Recv(Sock) of
<a name="19260"/>19260:                                {ok, {Src, [], ?BASIC_REQ}} -&gt;
<a name="19261"/>19261:                                    ?SEV_IPRINT(&quot;received req *without* timestamp&quot;),
<a name="19262"/>19262:                                    ok;
<a name="19263"/>19263:                                {ok, UnexpData} -&gt;
<a name="19264"/>19264:                                    {error, {unexpected_data, UnexpData}};
<a name="19265"/>19265:                                {error, _} = ERROR -&gt;
<a name="19266"/>19266:                                    %% At the moment there is no way to get
<a name="19267"/>19267:                                    %% status or state for the socket...
<a name="19268"/>19268:                                    ERROR
<a name="19269"/>19269:                            end
<a name="19270"/>19270:                    end},
<a name="19271"/>19271:          #{desc =&gt; &quot;send rep (to src)&quot;,
<a name="19272"/>19272:            cmd  =&gt; fun(#{sock_dst := Sock, sa_src := Src, send := Send}) -&gt;
<a name="19273"/>19273:                            Send(Sock, ?BASIC_REP, Src)
<a name="19274"/>19274:                    end},
<a name="19275"/>19275:          #{desc =&gt; &quot;recv rep (from dst)&quot;,
<a name="19276"/>19276:            cmd  =&gt; fun(#{sock_src := Sock, sa_dst := Dst, recv := Recv}) -&gt;
<a name="19277"/>19277:                            case Recv(Sock) of
<a name="19278"/>19278:                                {ok, {Dst, [], ?BASIC_REP}} -&gt;
<a name="19279"/>19279:                                    ok;
<a name="19280"/>19280:                                {ok, UnexpData} -&gt;
<a name="19281"/>19281:                                    {error, {unexpected_data, UnexpData}};
<a name="19282"/>19282:                                {error, _} = ERROR -&gt;
<a name="19283"/>19283:                                    %% At the moment there is no way to get
<a name="19284"/>19284:                                    %% status or state for the socket...
<a name="19285"/>19285:                                    ERROR
<a name="19286"/>19286:                            end
<a name="19287"/>19287:                    end},
<a name="19288"/>19288: 
<a name="19289"/>19289: 
<a name="19290"/>19290:          #{desc =&gt; &quot;close src socket&quot;,
<a name="19291"/>19291:            cmd  =&gt; fun(#{domain   := local,
<a name="19292"/>19292:                          sock_src := Sock,
<a name="19293"/>19293:                          lsa_src  := #{path := Path}} = State) -&gt;
<a name="19294"/>19294:                            ok = socket:close(Sock),
<a name="19295"/>19295:                            State1 =
<a name="19296"/>19296:                                unlink_path(Path,
<a name="19297"/>19297:                                            fun() -&gt; maps:remove(lsa_src, State) end,
<a name="19298"/>19298:                                            fun() -&gt; State end),
<a name="19299"/>19299:                            {ok, maps:remove(sock_src, State1)};
<a name="19300"/>19300:                       (#{sock_src := Sock} = State) -&gt;
<a name="19301"/>19301:                            ok = socket:close(Sock),
<a name="19302"/>19302:                            {ok, maps:remove(sock_src, State)}
<a name="19303"/>19303:                    end},
<a name="19304"/>19304:          #{desc =&gt; &quot;close dst socket&quot;,
<a name="19305"/>19305:            cmd  =&gt; fun(#{domain   := local,
<a name="19306"/>19306:                          sock_dst := Sock,
<a name="19307"/>19307:                          lsa_dst  := #{path := Path}} = State) -&gt;
<a name="19308"/>19308:                            ok = socket:close(Sock),
<a name="19309"/>19309:                            State1 =
<a name="19310"/>19310:                                unlink_path(Path,
<a name="19311"/>19311:                                            fun() -&gt; maps:remove(lsa_dst, State) end,
<a name="19312"/>19312:                                            fun() -&gt; State end),
<a name="19313"/>19313:                            {ok, maps:remove(sock_dst, State1)};
<a name="19314"/>19314:                       (#{sock_dst := Sock} = State) -&gt;
<a name="19315"/>19315:                            ok = socket:close(Sock),
<a name="19316"/>19316:                            {ok, maps:remove(sock_dst, State)}
<a name="19317"/>19317:                    end},
<a name="19318"/>19318: 
<a name="19319"/>19319:          %% *** We are done ***
<a name="19320"/>19320:          ?SEV_FINISH_NORMAL
<a name="19321"/>19321:         ],
<a name="19322"/>19322:     Evaluator = ?SEV_START(&quot;tester&quot;, Seq, InitState),
<a name="api_opt_sock_timestamp_udp-last_expr"/><a name="19323"/>19323: <b>    ok = ?SEV_AWAIT_FINISH</b>([Evaluator]).
<a name="19324"/>19324: 
<a name="19325"/>19325: 
<a name="19326"/>19326: 
<a name="19327"/>19327: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="19328"/>19328: 
<a name="19329"/>19329: <i>%% Tests that the timestamp control message header is received when</i>
<a name="19330"/>19330: <i>%% setting the socket 'socket' option true when using sendmsg/recvmsg</i>
<a name="19331"/>19331: <i>%% on an IPv4 TCP (stream) socket.</i>
<a name="19332"/>19332: <i>%% So, this is done on the receiving side: </i>
<a name="19333"/>19333: <i>%%</i>
<a name="19334"/>19334: <i>%%               socket:setopt(Sock, socket, timestamp, boolean()).</i>
<a name="19335"/>19335: <i>%%</i>
<a name="19336"/>19336: <i>%% All subsequent *received* messages will be timestamped.</i>
<a name="19337"/>19337: <i>%%</i>
<a name="19338"/>19338: <i>%% There is no mention of this not working for TCP in the man page</i>
<a name="19339"/>19339: <i>%% on a SLES 11 SP4 machine (=&gt; 3.0.101-108.87), but it does not</i>
<a name="19340"/>19340: <i>%% (we don't get a timestamp control message header when its enabled).</i>
<a name="19341"/>19341: <i>%% It also does not work on SLES 12 SP2 (=&gt; 4.4.120-92.70), </i>
<a name="19342"/>19342: <i>%% so we start by skipping from that version (4.4.120) or older!</i>
<a name="19343"/>19343: <i>%% Don't actually know if its the distro or the (kernel) version...</i>
<a name="19344"/>19344: <i>%%</i>
<a name="19345"/>19345: 
<a name="api_opt_sock_timestamp_tcp4-1"/><a name="19346"/>19346: <b>api_opt_sock_timestamp_tcp4</b>(_Config) when is_list(_Config) -&gt;
<a name="19347"/>19347:     ?TT(?SECS(5)),
<a name="api_opt_sock_timestamp_tcp4-last_expr"/><a name="19348"/>19348: <b>    tc_try</b>(api_opt_sock_timestamp_tcp4,
<a name="19349"/>19349:            fun() -&gt;
<a name="19350"/>19350:                    has_support_ipv4(),
<a name="19351"/>19351:                    has_support_sock_timestamp(),
<a name="19352"/>19352:                    is_good_enough_linux({4,4,120}),
<a name="19353"/>19353:                    is_not_freebsd(),
<a name="19354"/>19354:                    is_not_openbsd(),
<a name="19355"/>19355:                    is_not_netbsd(),
<a name="19356"/>19356:                    is_not_darwin()
<a name="19357"/>19357:            end,
<a name="19358"/>19358:            fun() -&gt;
<a name="19359"/>19359:                    Set  = fun(Sock, Value) -&gt;
<a name="19360"/>19360:                                   socket:setopt(Sock, socket, timestamp, Value)
<a name="19361"/>19361:                           end,
<a name="19362"/>19362:                    Get  = fun(Sock) -&gt;
<a name="19363"/>19363:                                   socket:getopt(Sock, socket, timestamp)
<a name="19364"/>19364:                           end,
<a name="19365"/>19365:                    Send = fun(Sock, Data) -&gt;
<a name="19366"/>19366:                                   Msg = #{iov  =&gt; [Data]},
<a name="19367"/>19367:                                   socket:sendmsg(Sock, Msg)
<a name="19368"/>19368:                           end,
<a name="19369"/>19369:                    Recv = fun(Sock) -&gt;
<a name="19370"/>19370:                                   case socket:recvmsg(Sock) of
<a name="19371"/>19371:                                       {ok, #{ctrl := CMsgs,
<a name="19372"/>19372:                                              iov  := [Data]}} -&gt;
<a name="19373"/>19373:                                           {ok, {CMsgs, Data}};
<a name="19374"/>19374:                                       {error, _} = ERROR -&gt;
<a name="19375"/>19375:                                           ERROR
<a name="19376"/>19376:                                   end
<a name="19377"/>19377:                           end,
<a name="19378"/>19378:                    InitState = #{domain =&gt; inet,
<a name="19379"/>19379:                                  proto  =&gt; tcp,
<a name="19380"/>19380:                                  send   =&gt; Send,
<a name="19381"/>19381:                                  recv   =&gt; Recv,
<a name="19382"/>19382:                                  set    =&gt; Set,
<a name="19383"/>19383:                                  get    =&gt; Get},
<a name="19384"/>19384:                    ok = api_opt_sock_timestamp_tcp(InitState)
<a name="19385"/>19385:            end).
<a name="19386"/>19386: 
<a name="19387"/>19387: 
<a name="19388"/>19388: 
<a name="19389"/>19389: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="19390"/>19390: 
<a name="api_opt_sock_timestamp_tcp-1"/><a name="19391"/>19391: <b>api_opt_sock_timestamp_tcp</b>(InitState) -&gt;
<a name="19392"/>19392:     process_flag(trap_exit, true),
<a name="19393"/>19393:     ServerSeq =
<a name="19394"/>19394:         [
<a name="19395"/>19395:          %% *** Wait for start order ***
<a name="19396"/>19396:          #{desc =&gt; &quot;await start (from tester)&quot;,
<a name="19397"/>19397:            cmd  =&gt; fun(State) -&gt;
<a name="19398"/>19398:                            Tester = ?SEV_AWAIT_START(),
<a name="19399"/>19399:                            {ok, State#{tester =&gt; Tester}}
<a name="19400"/>19400:                    end},
<a name="19401"/>19401:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="19402"/>19402:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="19403"/>19403:                            _MRef = erlang:monitor(process, Tester),
<a name="19404"/>19404:                            ok
<a name="19405"/>19405:                    end},
<a name="19406"/>19406: 
<a name="19407"/>19407:          %% *** Init part ***
<a name="19408"/>19408:          #{desc =&gt; &quot;which local address&quot;,
<a name="19409"/>19409:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="19410"/>19410:                            LSA = which_local_socket_addr(Domain),
<a name="19411"/>19411:                            {ok, State#{lsa =&gt; LSA}}
<a name="19412"/>19412:                    end},
<a name="19413"/>19413:          #{desc =&gt; &quot;create listen socket&quot;,
<a name="19414"/>19414:            cmd  =&gt; fun(#{domain := Domain,
<a name="19415"/>19415:                          proto  := Proto} = State) -&gt;
<a name="19416"/>19416:                            case socket:open(Domain, stream, Proto) of
<a name="19417"/>19417:                                {ok, Sock} -&gt;
<a name="19418"/>19418:                                    {ok, State#{lsock =&gt; Sock}};
<a name="19419"/>19419:                                {error, _} = ERROR -&gt;
<a name="19420"/>19420:                                    ERROR
<a name="19421"/>19421:                            end
<a name="19422"/>19422:                    end},
<a name="19423"/>19423:          #{desc =&gt; &quot;bind to local address&quot;,
<a name="19424"/>19424:            cmd  =&gt; fun(#{domain := local,
<a name="19425"/>19425:                          lsock  := LSock,
<a name="19426"/>19426:                          lsa    := LSA} = _State) -&gt;
<a name="19427"/>19427:                            case socket:bind(LSock, LSA) of
<a name="19428"/>19428:                                ok -&gt;
<a name="19429"/>19429:                                    ok; % We do not care about the port for local
<a name="19430"/>19430:                                {error, _} = ERROR -&gt;
<a name="19431"/>19431:                                    ERROR
<a name="19432"/>19432:                            end;
<a name="19433"/>19433:                       (#{lsock := LSock, lsa := LSA} = State) -&gt;
<a name="19434"/>19434:                            case sock_bind(LSock, LSA) of
<a name="19435"/>19435:                                ok -&gt;
<a name="19436"/>19436:                                    Port = sock_port(LSock),
<a name="19437"/>19437:                                    ?SEV_IPRINT(&quot;bound to port: ~w&quot;, [Port]),
<a name="19438"/>19438:                                    {ok, State#{lport =&gt; Port}};
<a name="19439"/>19439:                                {error, _} = ERROR -&gt;
<a name="19440"/>19440:                                    ERROR
<a name="19441"/>19441:                            end
<a name="19442"/>19442:                    end},
<a name="19443"/>19443:          #{desc =&gt; &quot;make listen socket&quot;,
<a name="19444"/>19444:            cmd  =&gt; fun(#{lsock := LSock}) -&gt;
<a name="19445"/>19445:                            socket:listen(LSock)
<a name="19446"/>19446:                    end},
<a name="19447"/>19447:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="19448"/>19448:            cmd  =&gt; fun(#{domain := local,
<a name="19449"/>19449:                          tester := Tester, lsa := #{path := Path}}) -&gt;
<a name="19450"/>19450:                            ?SEV_ANNOUNCE_READY(Tester, init, Path),
<a name="19451"/>19451:                            ok;
<a name="19452"/>19452:                       (#{tester := Tester, lport := Port}) -&gt;
<a name="19453"/>19453:                            %% This is actually not used for unix domain socket
<a name="19454"/>19454:                            ?SEV_ANNOUNCE_READY(Tester, init, Port),
<a name="19455"/>19455:                            ok
<a name="19456"/>19456:                    end},
<a name="19457"/>19457: 
<a name="19458"/>19458: 
<a name="19459"/>19459:          %% The actual test
<a name="19460"/>19460:          #{desc =&gt; &quot;await continue (accept)&quot;,
<a name="19461"/>19461:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="19462"/>19462:                            ?SEV_AWAIT_CONTINUE(Tester, tester, accept)
<a name="19463"/>19463:                    end},
<a name="19464"/>19464:          #{desc =&gt; &quot;await connection&quot;,
<a name="19465"/>19465:            cmd  =&gt; fun(#{lsock := LSock} = State) -&gt;
<a name="19466"/>19466:                            case socket:accept(LSock) of
<a name="19467"/>19467:                                {ok, Sock} -&gt;
<a name="19468"/>19468:                                    ?SEV_IPRINT(&quot;accepted: ~n   ~p&quot;, [Sock]),
<a name="19469"/>19469:                                    {ok, State#{csock =&gt; Sock}};
<a name="19470"/>19470:                                {error, _} = ERROR -&gt;
<a name="19471"/>19471:                                    ERROR
<a name="19472"/>19472:                            end
<a name="19473"/>19473:                    end},
<a name="19474"/>19474:          #{desc =&gt; &quot;announce ready (accept)&quot;,
<a name="19475"/>19475:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="19476"/>19476:                            ?SEV_ANNOUNCE_READY(Tester, accept),
<a name="19477"/>19477:                            ok
<a name="19478"/>19478:                    end},
<a name="19479"/>19479: 
<a name="19480"/>19480:          %% *** First message ***
<a name="19481"/>19481: 
<a name="19482"/>19482:          #{desc =&gt; &quot;await (recv) request 1&quot;,
<a name="19483"/>19483:            cmd  =&gt; fun(#{csock := Sock, recv := Recv}) -&gt;
<a name="19484"/>19484:                            case Recv(Sock) of
<a name="19485"/>19485:                                {ok, {[], ?BASIC_REQ}} -&gt;
<a name="19486"/>19486:                                    ok;
<a name="19487"/>19487:                                {error, _} = ERROR -&gt;
<a name="19488"/>19488:                                    ERROR
<a name="19489"/>19489:                            end
<a name="19490"/>19490:                    end},
<a name="19491"/>19491:          #{desc =&gt; &quot;announce ready (recv request)&quot;,
<a name="19492"/>19492:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="19493"/>19493:                            ?SEV_ANNOUNCE_READY(Tester, recv_req),
<a name="19494"/>19494:                            ok
<a name="19495"/>19495:                    end},
<a name="19496"/>19496:          #{desc =&gt; &quot;await continue (with send reply)&quot;,
<a name="19497"/>19497:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="19498"/>19498:                            ?SEV_AWAIT_CONTINUE(Tester, tester, send_reply)
<a name="19499"/>19499:                    end},
<a name="19500"/>19500:          #{desc =&gt; &quot;send reply&quot;,
<a name="19501"/>19501:            cmd  =&gt; fun(#{csock := Sock, send := Send}) -&gt;
<a name="19502"/>19502:                            Send(Sock, ?BASIC_REP)
<a name="19503"/>19503:                    end},
<a name="19504"/>19504:          #{desc =&gt; &quot;announce ready (send reply)&quot;,
<a name="19505"/>19505:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="19506"/>19506:                            ?SEV_ANNOUNCE_READY(Tester, send_reply),
<a name="19507"/>19507:                            ok
<a name="19508"/>19508:                    end},
<a name="19509"/>19509: 
<a name="19510"/>19510:          %% *** Second message ***
<a name="19511"/>19511: 
<a name="19512"/>19512:          #{desc =&gt; &quot;await (recv) request 2&quot;,
<a name="19513"/>19513:            cmd  =&gt; fun(#{csock := Sock, recv := Recv}) -&gt;
<a name="19514"/>19514:                            case Recv(Sock) of
<a name="19515"/>19515:                                {ok, {[], ?BASIC_REQ}} -&gt;
<a name="19516"/>19516:                                    ok;
<a name="19517"/>19517:                                {error, _} = ERROR -&gt;
<a name="19518"/>19518:                                    ERROR
<a name="19519"/>19519:                            end
<a name="19520"/>19520:                    end},
<a name="19521"/>19521:          #{desc =&gt; &quot;announce ready (recv request)&quot;,
<a name="19522"/>19522:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="19523"/>19523:                            ?SEV_ANNOUNCE_READY(Tester, recv_req),
<a name="19524"/>19524:                            ok
<a name="19525"/>19525:                    end},
<a name="19526"/>19526:          #{desc =&gt; &quot;await continue (with send reply)&quot;,
<a name="19527"/>19527:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="19528"/>19528:                            ?SEV_AWAIT_CONTINUE(Tester, tester, send_reply)
<a name="19529"/>19529:                    end},
<a name="19530"/>19530:          #{desc =&gt; &quot;send reply&quot;,
<a name="19531"/>19531:            cmd  =&gt; fun(#{csock := Sock, send := Send}) -&gt;
<a name="19532"/>19532:                            Send(Sock, ?BASIC_REP)
<a name="19533"/>19533:                    end},
<a name="19534"/>19534:          #{desc =&gt; &quot;announce ready (send reply)&quot;,
<a name="19535"/>19535:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="19536"/>19536:                            ?SEV_ANNOUNCE_READY(Tester, send_reply),
<a name="19537"/>19537:                            ok
<a name="19538"/>19538:                    end},
<a name="19539"/>19539: 
<a name="19540"/>19540:          %% *** Third message ***
<a name="19541"/>19541: 
<a name="19542"/>19542:          #{desc =&gt; &quot;await (recv) request 3&quot;,
<a name="19543"/>19543:            cmd  =&gt; fun(#{csock := Sock, recv := Recv}) -&gt;
<a name="19544"/>19544:                            case Recv(Sock) of
<a name="19545"/>19545:                                {ok, {[], ?BASIC_REQ}} -&gt;
<a name="19546"/>19546:                                    ok;
<a name="19547"/>19547:                                {error, _} = ERROR -&gt;
<a name="19548"/>19548:                                    ERROR
<a name="19549"/>19549:                            end
<a name="19550"/>19550:                    end},
<a name="19551"/>19551:          #{desc =&gt; &quot;announce ready (recv request)&quot;,
<a name="19552"/>19552:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="19553"/>19553:                            ?SEV_ANNOUNCE_READY(Tester, recv_req),
<a name="19554"/>19554:                            ok
<a name="19555"/>19555:                    end},
<a name="19556"/>19556:          #{desc =&gt; &quot;await continue (with send reply)&quot;,
<a name="19557"/>19557:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="19558"/>19558:                            ?SEV_AWAIT_CONTINUE(Tester, tester, send_reply)
<a name="19559"/>19559:                    end},
<a name="19560"/>19560:          #{desc =&gt; &quot;send reply&quot;,
<a name="19561"/>19561:            cmd  =&gt; fun(#{csock := Sock, send := Send}) -&gt;
<a name="19562"/>19562:                            Send(Sock, ?BASIC_REP)
<a name="19563"/>19563:                    end},
<a name="19564"/>19564:          #{desc =&gt; &quot;announce ready (send reply)&quot;,
<a name="19565"/>19565:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="19566"/>19566:                            ?SEV_ANNOUNCE_READY(Tester, send_reply),
<a name="19567"/>19567:                            ok
<a name="19568"/>19568:                    end},
<a name="19569"/>19569: 
<a name="19570"/>19570:          %% *** Termination ***
<a name="19571"/>19571:          #{desc =&gt; &quot;await terminate&quot;,
<a name="19572"/>19572:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="19573"/>19573:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="19574"/>19574:                                ok -&gt;
<a name="19575"/>19575:                                    {ok, maps:remove(tester, State)};
<a name="19576"/>19576:                                {error, _} = ERROR -&gt;
<a name="19577"/>19577:                                    ERROR
<a name="19578"/>19578:                            end
<a name="19579"/>19579:                    end},
<a name="19580"/>19580:          #{desc =&gt; &quot;close connection socket&quot;,
<a name="19581"/>19581:            cmd  =&gt; fun(#{csock := Sock} = State) -&gt;
<a name="19582"/>19582:                            ok = socket:close(Sock),
<a name="19583"/>19583:                            {ok, maps:remove(csock, State)}
<a name="19584"/>19584:                    end},
<a name="19585"/>19585:          #{desc =&gt; &quot;close listen socket&quot;,
<a name="19586"/>19586:            cmd  =&gt; fun(#{domain   := local,
<a name="19587"/>19587:                          lsock    := Sock,
<a name="19588"/>19588:                          local_sa := #{path := Path}} = State) -&gt;
<a name="19589"/>19589:                            ok = socket:close(Sock),
<a name="19590"/>19590:                            State1 =
<a name="19591"/>19591:                                unlink_path(Path,
<a name="19592"/>19592:                                            fun() -&gt;
<a name="19593"/>19593:                                                    maps:remove(local_sa, State)
<a name="19594"/>19594:                                            end,
<a name="19595"/>19595:                                            fun() -&gt; State end),
<a name="19596"/>19596:                            {ok, maps:remove(lsock, State1)};
<a name="19597"/>19597:                       (#{lsock := LSock} = State) -&gt;
<a name="19598"/>19598:                            case socket:close(LSock) of
<a name="19599"/>19599:                                ok -&gt;
<a name="19600"/>19600:                                    {ok, maps:remove(lsock, State)};
<a name="19601"/>19601:                                {error, _} = ERROR -&gt;
<a name="19602"/>19602:                                    ERROR
<a name="19603"/>19603:                            end
<a name="19604"/>19604:                    end},
<a name="19605"/>19605: 
<a name="19606"/>19606:          %% *** We are done ***
<a name="19607"/>19607:          ?SEV_FINISH_NORMAL
<a name="19608"/>19608:         ],
<a name="19609"/>19609: 
<a name="19610"/>19610: 
<a name="19611"/>19611:     ClientSeq =
<a name="19612"/>19612:         [
<a name="19613"/>19613:          %% *** Wait for start order ***
<a name="19614"/>19614:          #{desc =&gt; &quot;await start (from tester)&quot;,
<a name="19615"/>19615:            cmd  =&gt; fun(#{domain := local} = State) -&gt;
<a name="19616"/>19616:                            {Tester, Path} = ?SEV_AWAIT_START(),
<a name="19617"/>19617:                            {ok, State#{tester =&gt; Tester, server_path =&gt; Path}};
<a name="19618"/>19618:                       (State) -&gt;
<a name="19619"/>19619:                            {Tester, Port} = ?SEV_AWAIT_START(),
<a name="19620"/>19620:                            {ok, State#{tester =&gt; Tester, server_port =&gt; Port}}
<a name="19621"/>19621:                    end},
<a name="19622"/>19622:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="19623"/>19623:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="19624"/>19624:                            _MRef = erlang:monitor(process, Tester),
<a name="19625"/>19625:                            ok
<a name="19626"/>19626:                    end},
<a name="19627"/>19627: 
<a name="19628"/>19628:          %% *** The init part ***
<a name="19629"/>19629:          #{desc =&gt; &quot;which server (local) address&quot;,
<a name="19630"/>19630:            cmd  =&gt; fun(#{domain      := local = Domain,
<a name="19631"/>19631:                          server_path := Path} = State) -&gt;
<a name="19632"/>19632:                            LSA = which_local_socket_addr(Domain),
<a name="19633"/>19633:                            SSA = #{family =&gt; Domain, path =&gt; Path},
<a name="19634"/>19634:                            {ok, State#{local_sa =&gt; LSA, server_sa =&gt; SSA}};
<a name="19635"/>19635:                       (#{domain := Domain, server_port := Port} = State) -&gt;
<a name="19636"/>19636:                            LSA = which_local_socket_addr(Domain),
<a name="19637"/>19637:                            SSA = LSA#{port =&gt; Port},
<a name="19638"/>19638:                            {ok, State#{local_sa =&gt; LSA, server_sa =&gt; SSA}}
<a name="19639"/>19639:                    end},
<a name="19640"/>19640:          #{desc =&gt; &quot;create socket&quot;,
<a name="19641"/>19641:            cmd  =&gt; fun(#{domain := Domain,
<a name="19642"/>19642:                          proto  := Proto} = State) -&gt;
<a name="19643"/>19643:                            case socket:open(Domain, stream, Proto) of
<a name="19644"/>19644:                                {ok, Sock} -&gt;
<a name="19645"/>19645:                                    {ok, State#{sock =&gt; Sock}};
<a name="19646"/>19646:                                {error, _} = ERROR -&gt;
<a name="19647"/>19647:                                    ERROR
<a name="19648"/>19648:                            end
<a name="19649"/>19649:                    end},
<a name="19650"/>19650:          #{desc =&gt; &quot;bind to local address&quot;,
<a name="19651"/>19651:            cmd  =&gt; fun(#{sock := Sock, local_sa := LSA} = _State) -&gt;
<a name="19652"/>19652:                            case sock_bind(Sock, LSA) of
<a name="19653"/>19653:                                ok -&gt;
<a name="19654"/>19654:                                    ok;
<a name="19655"/>19655:                                {error, _} = ERROR -&gt;
<a name="19656"/>19656:                                    ERROR
<a name="19657"/>19657:                            end
<a name="19658"/>19658:                    end},
<a name="19659"/>19659:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="19660"/>19660:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="19661"/>19661:                            ?SEV_ANNOUNCE_READY(Tester, init),
<a name="19662"/>19662:                            ok
<a name="19663"/>19663:                    end},
<a name="19664"/>19664: 
<a name="19665"/>19665:          %% *** The actual test ***
<a name="19666"/>19666:          #{desc =&gt; &quot;await continue (connect)&quot;,
<a name="19667"/>19667:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="19668"/>19668:                            ?SEV_AWAIT_CONTINUE(Tester, tester, connect)
<a name="19669"/>19669:                    end},
<a name="19670"/>19670:          #{desc =&gt; &quot;connect to server&quot;,
<a name="19671"/>19671:            cmd  =&gt; fun(#{sock := Sock, server_sa := SSA}) -&gt;
<a name="19672"/>19672:                            socket:connect(Sock, SSA)
<a name="19673"/>19673:                    end},
<a name="19674"/>19674:          #{desc =&gt; &quot;announce ready (connect)&quot;,
<a name="19675"/>19675:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="19676"/>19676:                            ?SEV_ANNOUNCE_READY(Tester, connect),
<a name="19677"/>19677:                            ok
<a name="19678"/>19678:                    end},
<a name="19679"/>19679: 
<a name="19680"/>19680:          %% *** First message (default=wo timestamp) ***
<a name="19681"/>19681: 
<a name="19682"/>19682:          #{desc =&gt; &quot;await continue (verify timestamp off)&quot;,
<a name="19683"/>19683:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="19684"/>19684:                            ?SEV_AWAIT_CONTINUE(Tester, tester, verify_timestamp)
<a name="19685"/>19685:                    end},
<a name="19686"/>19686:          #{desc =&gt; &quot;verify timestamp off&quot;,
<a name="19687"/>19687:            cmd  =&gt; fun(#{sock := Sock, get := Get} = _State) -&gt;
<a name="19688"/>19688:                            case Get(Sock) of
<a name="19689"/>19689:                                {ok, false = _Value} -&gt;
<a name="19690"/>19690:                                    ?SEV_IPRINT(&quot;timestamp: ~p&quot;, [_Value]),
<a name="19691"/>19691:                                    ok;
<a name="19692"/>19692:                                {ok, Unexpected} -&gt;
<a name="19693"/>19693:                                    ?SEV_EPRINT(&quot;Unexpected timestamp: ~p&quot;,
<a name="19694"/>19694:                                                [Unexpected]),
<a name="19695"/>19695:                                    {error, {unexpected_timestamp, Unexpected}};
<a name="19696"/>19696:                                {error, enoprotoopt = Reason} -&gt;
<a name="19697"/>19697:                                    {skip, Reason};
<a name="19698"/>19698:                                {error, Reason} = ERROR -&gt;
<a name="19699"/>19699:                                    ?SEV_EPRINT(&quot;Failed getting timestamp:&quot;
<a name="19700"/>19700:                                                &quot;   ~p&quot;, [Reason]),
<a name="19701"/>19701:                                    ERROR
<a name="19702"/>19702:                            end                                   
<a name="19703"/>19703:                    end},
<a name="19704"/>19704:          #{desc =&gt; &quot;announce ready (timestamp off)&quot;,
<a name="19705"/>19705:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="19706"/>19706:                            ?SEV_ANNOUNCE_READY(Tester, timestamp_off),
<a name="19707"/>19707:                            ok
<a name="19708"/>19708:                    end},
<a name="19709"/>19709: 
<a name="19710"/>19710:          #{desc =&gt; &quot;await continue (send request)&quot;,
<a name="19711"/>19711:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="19712"/>19712:                            ?SEV_AWAIT_CONTINUE(Tester, tester, send_req)
<a name="19713"/>19713:                    end},
<a name="19714"/>19714:          #{desc =&gt; &quot;send request 1 (to server)&quot;,
<a name="19715"/>19715:            cmd  =&gt; fun(#{sock := Sock, send := Send}) -&gt;
<a name="19716"/>19716:                            Send(Sock, ?BASIC_REQ)
<a name="19717"/>19717:                    end},
<a name="19718"/>19718:          #{desc =&gt; &quot;announce ready (send request)&quot;,
<a name="19719"/>19719:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="19720"/>19720:                            ?SEV_ANNOUNCE_READY(Tester, send_req),
<a name="19721"/>19721:                            ok
<a name="19722"/>19722:                    end},
<a name="19723"/>19723:          #{desc =&gt; &quot;await recv reply 1 (from server, wo timestamp)&quot;,
<a name="19724"/>19724:            cmd  =&gt; fun(#{sock := Sock, recv := Recv}) -&gt;
<a name="19725"/>19725:                            case Recv(Sock) of
<a name="19726"/>19726:                                {ok, {[], ?BASIC_REP}} -&gt;
<a name="19727"/>19727:                                    ok;
<a name="19728"/>19728:                                {ok, {[], UnexpData}} -&gt;
<a name="19729"/>19729:                                    {error, {unexpected_reply_data, UnexpData}};
<a name="19730"/>19730:                                {ok, {BadCMsgs, ?BASIC_REP}} -&gt;
<a name="19731"/>19731:                                    {error, {unexpected_reply_cmsgs,
<a name="19732"/>19732:                                             BadCMsgs}};
<a name="19733"/>19733:                                {ok, BadReply} -&gt;
<a name="19734"/>19734:                                    {error, {unexpected_reply, BadReply}};
<a name="19735"/>19735:                                {error, _} = ERROR -&gt;
<a name="19736"/>19736:                                    ERROR
<a name="19737"/>19737:                            end
<a name="19738"/>19738:                    end},
<a name="19739"/>19739:          #{desc =&gt; &quot;announce ready 1 (recv reply)&quot;,
<a name="19740"/>19740:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="19741"/>19741:                            ?SEV_ANNOUNCE_READY(Tester, recv_reply),
<a name="19742"/>19742:                            ok
<a name="19743"/>19743:                    end},
<a name="19744"/>19744: 
<a name="19745"/>19745:          %% *** Second message (w timestamp) ***
<a name="19746"/>19746: 
<a name="19747"/>19747:          #{desc =&gt; &quot;await continue (enable timestamp)&quot;,
<a name="19748"/>19748:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="19749"/>19749:                            ?SEV_AWAIT_CONTINUE(Tester, tester, enable_timestamp)
<a name="19750"/>19750:                    end},
<a name="19751"/>19751:          #{desc =&gt; &quot;enable timestamp&quot;,
<a name="19752"/>19752:            cmd  =&gt; fun(#{sock := Sock, set := Set} = _State) -&gt;
<a name="19753"/>19753:                            case Set(Sock, true) of
<a name="19754"/>19754:                                ok -&gt;
<a name="19755"/>19755:                                    ?SEV_IPRINT(&quot;timestamp enabled&quot;),
<a name="19756"/>19756:                                    ok;
<a name="19757"/>19757:                                {error, Reason} = ERROR -&gt;
<a name="19758"/>19758:                                    ?SEV_EPRINT(&quot;Failed enable timestamp:&quot;
<a name="19759"/>19759:                                                &quot;   ~p&quot;, [Reason]),
<a name="19760"/>19760:                                    ERROR
<a name="19761"/>19761:                            end                                   
<a name="19762"/>19762:                    end},
<a name="19763"/>19763:          %% Linux peculiarity observed here...
<a name="19764"/>19764:          %% Detected on Kernel 4.15.0-72 x96_64.
<a name="19765"/>19765:          %% The option set to enable receiving timestamps just above
<a name="19766"/>19766:          %% has failed to be effective down in &quot;await recv reply 2
<a name="19767"/>19767:          %% (from server, w timestamp)&quot; below, unless we put the
<a name="19768"/>19768:          %% sleep between setting the option and informing
<a name="19769"/>19769:          %% the writer that it shall write to the other socket end.
<a name="19770"/>19770:          %% A sleep 1 ms improves a lot but does not remove
<a name="19771"/>19771:          %% problem completely. Believe it or not.
<a name="19772"/>19772:          ?SEV_SLEEP(100),
<a name="19773"/>19773:          #{desc =&gt; &quot;announce ready (timestamp on)&quot;,
<a name="19774"/>19774:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="19775"/>19775:                            ?SEV_ANNOUNCE_READY(Tester, timestamp_on),
<a name="19776"/>19776:                            ok
<a name="19777"/>19777:                    end},
<a name="19778"/>19778: 
<a name="19779"/>19779:          #{desc =&gt; &quot;await continue (send request 2)&quot;,
<a name="19780"/>19780:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="19781"/>19781:                            ?SEV_AWAIT_CONTINUE(Tester, tester, send_req)
<a name="19782"/>19782:                    end},
<a name="19783"/>19783:          #{desc =&gt; &quot;send request 2 (to server)&quot;,
<a name="19784"/>19784:            cmd  =&gt; fun(#{sock := Sock, send := Send}) -&gt;
<a name="19785"/>19785:                            Send(Sock, ?BASIC_REQ)
<a name="19786"/>19786:                    end},
<a name="19787"/>19787:          #{desc =&gt; &quot;announce ready (send request 2)&quot;,
<a name="19788"/>19788:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="19789"/>19789:                            ?SEV_ANNOUNCE_READY(Tester, send_req),
<a name="19790"/>19790:                            ok
<a name="19791"/>19791:                    end},
<a name="19792"/>19792:          #{desc =&gt; &quot;await recv reply 2 (from server, w timestamp)&quot;,
<a name="19793"/>19793:            cmd  =&gt; fun(#{sock := Sock, recv := Recv, get := Get}) -&gt;
<a name="19794"/>19794:                            case Recv(Sock) of
<a name="19795"/>19795:                                {ok, {[#{level := socket,
<a name="19796"/>19796:                                         type  := timestamp,
<a name="19797"/>19797:                                         value := TS}], ?BASIC_REP}} -&gt;
<a name="19798"/>19798:                                    ?SEV_IPRINT(&quot;received reply *with* &quot;
<a name="19799"/>19799:                                                &quot;expected timestamp: &quot;
<a name="19800"/>19800:                                                &quot;~n   ~p&quot;, [TS]),
<a name="19801"/>19801:                                    ok;
<a name="19802"/>19802:                                {ok, {BadCMsgs, ?BASIC_REP}} -&gt;
<a name="19803"/>19803:                                    ?SEV_EPRINT(&quot;received reply *with* &quot;
<a name="19804"/>19804:                                                &quot;unexpected cmsg headers:&quot;
<a name="19805"/>19805:                                                &quot;~n   ~p&quot;
<a name="19806"/>19806:                                                &quot;Current timestamp value: &quot;
<a name="19807"/>19807:                                                &quot;~n   ~p&quot;,
<a name="19808"/>19808:                                                [BadCMsgs, Get(Sock)]),
<a name="19809"/>19809:                                    {error, {unexpected_reply_cmsgs,
<a name="19810"/>19810:                                             BadCMsgs}};
<a name="19811"/>19811:                                {ok, BadReply} -&gt;
<a name="19812"/>19812:                                    {error, {unexpected_reply, BadReply}};
<a name="19813"/>19813:                                {error, _} = ERROR -&gt;
<a name="19814"/>19814:                                    ERROR
<a name="19815"/>19815:                            end
<a name="19816"/>19816:                    end},
<a name="19817"/>19817:          #{desc =&gt; &quot;announce ready 2 (recv reply)&quot;,
<a name="19818"/>19818:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="19819"/>19819:                            ?SEV_ANNOUNCE_READY(Tester, recv_reply),
<a name="19820"/>19820:                            ok
<a name="19821"/>19821:                    end},
<a name="19822"/>19822: 
<a name="19823"/>19823:          %% *** Third message (wo timestamp) ***
<a name="19824"/>19824: 
<a name="19825"/>19825:          #{desc =&gt; &quot;await continue (disable timestamp)&quot;,
<a name="19826"/>19826:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="19827"/>19827:                            ?SEV_AWAIT_CONTINUE(Tester, tester, disable_timestamp)
<a name="19828"/>19828:                    end},
<a name="19829"/>19829:          #{desc =&gt; &quot;disable timestamp&quot;,
<a name="19830"/>19830:            cmd  =&gt; fun(#{sock := Sock, set := Set} = _State) -&gt;
<a name="19831"/>19831:                            case Set(Sock, false) of
<a name="19832"/>19832:                                ok -&gt;
<a name="19833"/>19833:                                    ?SEV_IPRINT(&quot;timestamp disabled&quot;),
<a name="19834"/>19834:                                    ok;
<a name="19835"/>19835:                                {error, Reason} = ERROR -&gt;
<a name="19836"/>19836:                                    ?SEV_EPRINT(&quot;Failed disable timestamp:&quot;
<a name="19837"/>19837:                                                &quot;   ~p&quot;, [Reason]),
<a name="19838"/>19838:                                    ERROR
<a name="19839"/>19839:                            end                                   
<a name="19840"/>19840:                    end},
<a name="19841"/>19841:          #{desc =&gt; &quot;announce ready (timestamp off)&quot;,
<a name="19842"/>19842:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="19843"/>19843:                            ?SEV_ANNOUNCE_READY(Tester, timestamp_off),
<a name="19844"/>19844:                            ok
<a name="19845"/>19845:                    end},
<a name="19846"/>19846: 
<a name="19847"/>19847:          #{desc =&gt; &quot;await continue (send request 3)&quot;,
<a name="19848"/>19848:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="19849"/>19849:                            ?SEV_AWAIT_CONTINUE(Tester, tester, send_req)
<a name="19850"/>19850:                    end},
<a name="19851"/>19851:          #{desc =&gt; &quot;send request 3 (to server)&quot;,
<a name="19852"/>19852:            cmd  =&gt; fun(#{sock := Sock, send := Send}) -&gt;
<a name="19853"/>19853:                            Send(Sock, ?BASIC_REQ)
<a name="19854"/>19854:                    end},
<a name="19855"/>19855:          #{desc =&gt; &quot;announce ready (send request 3)&quot;,
<a name="19856"/>19856:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="19857"/>19857:                            ?SEV_ANNOUNCE_READY(Tester, send_req),
<a name="19858"/>19858:                            ok
<a name="19859"/>19859:                    end},
<a name="19860"/>19860:          #{desc =&gt; &quot;await recv reply 3 (from server, wo timestamp)&quot;,
<a name="19861"/>19861:            cmd  =&gt; fun(#{sock := Sock, recv := Recv}) -&gt;
<a name="19862"/>19862:                            case Recv(Sock) of
<a name="19863"/>19863:                                {ok, {[], ?BASIC_REP}} -&gt;
<a name="19864"/>19864:                                    ?SEV_IPRINT(&quot;received reply *without* &quot;
<a name="19865"/>19865:                                                &quot;timestamp&quot;),
<a name="19866"/>19866:                                    ok;
<a name="19867"/>19867:                                {ok, {BadCMsgs, ?BASIC_REP}} -&gt;
<a name="19868"/>19868:                                    {error, {unexpected_reply_cmsgs,
<a name="19869"/>19869:                                             BadCMsgs}};
<a name="19870"/>19870:                                {ok, {[], BadData}} -&gt;
<a name="19871"/>19871:                                    {error, {unexpected_reply_data,
<a name="19872"/>19872:                                             BadData}};
<a name="19873"/>19873:                                {ok, BadReply} -&gt;
<a name="19874"/>19874:                                    {error, {unexpected_reply, BadReply}};
<a name="19875"/>19875:                                {error, _} = ERROR -&gt;
<a name="19876"/>19876:                                    ERROR
<a name="19877"/>19877:                            end
<a name="19878"/>19878:                    end},
<a name="19879"/>19879:          #{desc =&gt; &quot;announce ready 3 (recv reply)&quot;,
<a name="19880"/>19880:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="19881"/>19881:                            ?SEV_ANNOUNCE_READY(Tester, recv_reply),
<a name="19882"/>19882:                            ok
<a name="19883"/>19883:                    end},
<a name="19884"/>19884: 
<a name="19885"/>19885:          %% *** Termination ***
<a name="19886"/>19886:          #{desc =&gt; &quot;await terminate&quot;,
<a name="19887"/>19887:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="19888"/>19888:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="19889"/>19889:                                ok -&gt;
<a name="19890"/>19890:                                    {ok, maps:remove(tester, State)};
<a name="19891"/>19891:                                {error, _} = ERROR -&gt;
<a name="19892"/>19892:                                    ERROR
<a name="19893"/>19893:                            end
<a name="19894"/>19894:                    end},
<a name="19895"/>19895:          #{desc =&gt; &quot;close socket&quot;,
<a name="19896"/>19896:            cmd  =&gt; fun(#{domain   := local,
<a name="19897"/>19897:                          sock     := Sock,
<a name="19898"/>19898:                          local_sa := #{path := Path}} = State) -&gt;
<a name="19899"/>19899:                            ok = socket:close(Sock),
<a name="19900"/>19900:                            State1 =
<a name="19901"/>19901:                                unlink_path(Path,
<a name="19902"/>19902:                                            fun() -&gt;
<a name="19903"/>19903:                                                    maps:remove(local_sa, State)
<a name="19904"/>19904:                                            end,
<a name="19905"/>19905:                                            fun() -&gt; State end),
<a name="19906"/>19906:                            {ok, maps:remove(sock, State1)};
<a name="19907"/>19907:                       (#{sock := Sock} = State) -&gt;
<a name="19908"/>19908:                            ok = socket:close(Sock),
<a name="19909"/>19909:                            {ok, maps:remove(sock, State)}
<a name="19910"/>19910:                    end},
<a name="19911"/>19911: 
<a name="19912"/>19912:          %% *** We are done ***
<a name="19913"/>19913:          ?SEV_FINISH_NORMAL
<a name="19914"/>19914:         ],
<a name="19915"/>19915: 
<a name="19916"/>19916: 
<a name="19917"/>19917:     TesterSeq =
<a name="19918"/>19918:         [
<a name="19919"/>19919:          %% *** Init part ***
<a name="19920"/>19920:          #{desc =&gt; &quot;monitor server&quot;,
<a name="19921"/>19921:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="19922"/>19922:                            _MRef = erlang:monitor(process, Pid),
<a name="19923"/>19923:                            ok
<a name="19924"/>19924:                    end},
<a name="19925"/>19925:          #{desc =&gt; &quot;monitor client&quot;,
<a name="19926"/>19926:            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;
<a name="19927"/>19927:                            _MRef = erlang:monitor(process, Pid),
<a name="19928"/>19928:                            ok
<a name="19929"/>19929:                    end},
<a name="19930"/>19930: 
<a name="19931"/>19931:          %% Start the server
<a name="19932"/>19932:          #{desc =&gt; &quot;order server start&quot;,
<a name="19933"/>19933:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="19934"/>19934:                            ?SEV_ANNOUNCE_START(Pid),
<a name="19935"/>19935:                            ok
<a name="19936"/>19936:                    end},
<a name="19937"/>19937:          #{desc =&gt; &quot;await server ready (init)&quot;,
<a name="19938"/>19938:            cmd  =&gt; fun(#{server := Pid} = State) -&gt;
<a name="19939"/>19939:                            {ok, Port} = ?SEV_AWAIT_READY(Pid, server, init),
<a name="19940"/>19940:                            {ok, State#{server_port =&gt; Port}}
<a name="19941"/>19941:                    end},
<a name="19942"/>19942: 
<a name="19943"/>19943:          %% Start the client
<a name="19944"/>19944:          #{desc =&gt; &quot;order client start&quot;,
<a name="19945"/>19945:            cmd  =&gt; fun(#{client := Pid, server_port := Port} = _State) -&gt;
<a name="19946"/>19946:                            ?SEV_ANNOUNCE_START(Pid, Port),
<a name="19947"/>19947:                            ok
<a name="19948"/>19948:                    end},
<a name="19949"/>19949:          #{desc =&gt; &quot;await client ready (init)&quot;,
<a name="19950"/>19950:            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;
<a name="19951"/>19951:                            ok = ?SEV_AWAIT_READY(Pid, client, init)
<a name="19952"/>19952:                    end},
<a name="19953"/>19953: 
<a name="19954"/>19954:          %% *** The actual test ***
<a name="19955"/>19955:          #{desc =&gt; &quot;order server to continue (with accept)&quot;,
<a name="19956"/>19956:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="19957"/>19957:                            ?SEV_ANNOUNCE_CONTINUE(Server, accept),
<a name="19958"/>19958:                            ok
<a name="19959"/>19959:                    end},
<a name="19960"/>19960: <i>%%%         ?SEV_SLEEP(?SECS(1)),</i>
<a name="19961"/>19961:          #{desc =&gt; &quot;order client to continue (with connect)&quot;,
<a name="19962"/>19962:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="19963"/>19963:                            ?SEV_ANNOUNCE_CONTINUE(Client, connect),
<a name="19964"/>19964:                            ok
<a name="19965"/>19965:                    end},
<a name="19966"/>19966:          #{desc =&gt; &quot;await client ready (connect)&quot;,
<a name="19967"/>19967:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="19968"/>19968:                            ?SEV_AWAIT_READY(Client, client, connect)
<a name="19969"/>19969:                    end},
<a name="19970"/>19970:          #{desc =&gt; &quot;await server ready (accept)&quot;,
<a name="19971"/>19971:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="19972"/>19972:                            ?SEV_AWAIT_READY(Server, server, accept)
<a name="19973"/>19973:                    end},
<a name="19974"/>19974: 
<a name="19975"/>19975:          %% *** First message (default=wo timestamp) ***
<a name="19976"/>19976: 
<a name="19977"/>19977:          #{desc =&gt; &quot;order client to continue (with verify timestamp off)&quot;,
<a name="19978"/>19978:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="19979"/>19979:                            ?SEV_ANNOUNCE_CONTINUE(Client, verify_timestamp),
<a name="19980"/>19980:                            ok
<a name="19981"/>19981:                    end},
<a name="19982"/>19982:          #{desc =&gt; &quot;await client ready (timestamp off)&quot;,
<a name="19983"/>19983:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="19984"/>19984:                            ?SEV_AWAIT_READY(Client, client, timestamp_off)
<a name="19985"/>19985:                    end},
<a name="19986"/>19986: 
<a name="19987"/>19987:          #{desc =&gt; &quot;order client to continue (with send request 1)&quot;,
<a name="19988"/>19988:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="19989"/>19989:                            ?SEV_ANNOUNCE_CONTINUE(Client, send_req),
<a name="19990"/>19990:                            ok
<a name="19991"/>19991:                    end},
<a name="19992"/>19992:          #{desc =&gt; &quot;await client ready (with send request 1)&quot;,
<a name="19993"/>19993:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="19994"/>19994:                            ?SEV_AWAIT_READY(Client, client, send_req)
<a name="19995"/>19995:                    end},
<a name="19996"/>19996:          #{desc =&gt; &quot;await server ready (request recv 1)&quot;,
<a name="19997"/>19997:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="19998"/>19998:                            ?SEV_AWAIT_READY(Server, server, recv_req)
<a name="19999"/>19999:                    end},
<a name="20000"/>20000:          #{desc =&gt; &quot;order server to continue (with send reply)&quot;,
<a name="20001"/>20001:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="20002"/>20002:                            ?SEV_ANNOUNCE_CONTINUE(Server, send_reply),
<a name="20003"/>20003:                            ok
<a name="20004"/>20004:                    end},
<a name="20005"/>20005:          #{desc =&gt; &quot;await server ready (with reply sent)&quot;,
<a name="20006"/>20006:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="20007"/>20007:                            ?SEV_AWAIT_READY(Server, server, send_reply)
<a name="20008"/>20008:                    end},
<a name="20009"/>20009:          #{desc =&gt; &quot;await client ready (reply recv)&quot;,
<a name="20010"/>20010:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="20011"/>20011:                            ?SEV_AWAIT_READY(Client, client, recv_reply)
<a name="20012"/>20012:                    end},
<a name="20013"/>20013: 
<a name="20014"/>20014:          %% Second message (w timestamp)
<a name="20015"/>20015: 
<a name="20016"/>20016:          #{desc =&gt; &quot;order client to continue (with enable timestamp)&quot;,
<a name="20017"/>20017:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="20018"/>20018:                            ?SEV_ANNOUNCE_CONTINUE(Client, enable_timestamp),
<a name="20019"/>20019:                            ok
<a name="20020"/>20020:                    end},
<a name="20021"/>20021:          #{desc =&gt; &quot;await client ready (timestamp on)&quot;,
<a name="20022"/>20022:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="20023"/>20023:                            ?SEV_AWAIT_READY(Client, client, timestamp_on)
<a name="20024"/>20024:                    end},
<a name="20025"/>20025: 
<a name="20026"/>20026:          #{desc =&gt; &quot;order client to continue (with send request 2)&quot;,
<a name="20027"/>20027:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="20028"/>20028:                            ?SEV_ANNOUNCE_CONTINUE(Client, send_req),
<a name="20029"/>20029:                            ok
<a name="20030"/>20030:                    end},
<a name="20031"/>20031:          #{desc =&gt; &quot;await client ready (with send request 2)&quot;,
<a name="20032"/>20032:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="20033"/>20033:                            ?SEV_AWAIT_READY(Client, client, send_req)
<a name="20034"/>20034:                    end},
<a name="20035"/>20035:          #{desc =&gt; &quot;await server ready (request recv 2)&quot;,
<a name="20036"/>20036:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="20037"/>20037:                            ?SEV_AWAIT_READY(Server, server, recv_req)
<a name="20038"/>20038:                    end},
<a name="20039"/>20039:          #{desc =&gt; &quot;order server to continue (with send reply 2)&quot;,
<a name="20040"/>20040:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="20041"/>20041:                            ?SEV_ANNOUNCE_CONTINUE(Server, send_reply),
<a name="20042"/>20042:                            ok
<a name="20043"/>20043:                    end},
<a name="20044"/>20044:          #{desc =&gt; &quot;await server ready (with reply sent 2)&quot;,
<a name="20045"/>20045:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="20046"/>20046:                            ?SEV_AWAIT_READY(Server, server, send_reply)
<a name="20047"/>20047:                    end},
<a name="20048"/>20048:          #{desc =&gt; &quot;await client ready (reply recv 2)&quot;,
<a name="20049"/>20049:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="20050"/>20050:                            ?SEV_AWAIT_READY(Client, client, recv_reply)
<a name="20051"/>20051:                    end},
<a name="20052"/>20052: 
<a name="20053"/>20053:          %% Third message (wo timestamp)
<a name="20054"/>20054: 
<a name="20055"/>20055:          #{desc =&gt; &quot;order client to continue (with disable timestamp)&quot;,
<a name="20056"/>20056:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="20057"/>20057:                            ?SEV_ANNOUNCE_CONTINUE(Client, disable_timestamp),
<a name="20058"/>20058:                            ok
<a name="20059"/>20059:                    end},
<a name="20060"/>20060:          #{desc =&gt; &quot;await client ready (timestamp off)&quot;,
<a name="20061"/>20061:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="20062"/>20062:                            ?SEV_AWAIT_READY(Client, client, timestamp_off)
<a name="20063"/>20063:                    end},
<a name="20064"/>20064: 
<a name="20065"/>20065:          #{desc =&gt; &quot;order client to continue (with send request 3)&quot;,
<a name="20066"/>20066:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="20067"/>20067:                            ?SEV_ANNOUNCE_CONTINUE(Client, send_req),
<a name="20068"/>20068:                            ok
<a name="20069"/>20069:                    end},
<a name="20070"/>20070:          #{desc =&gt; &quot;await client ready (with send request 3)&quot;,
<a name="20071"/>20071:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="20072"/>20072:                            ?SEV_AWAIT_READY(Client, client, send_req)
<a name="20073"/>20073:                    end},
<a name="20074"/>20074:          #{desc =&gt; &quot;await server ready (request recv 3)&quot;,
<a name="20075"/>20075:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="20076"/>20076:                            ?SEV_AWAIT_READY(Server, server, recv_req)
<a name="20077"/>20077:                    end},
<a name="20078"/>20078:          #{desc =&gt; &quot;order server to continue (with send reply 3)&quot;,
<a name="20079"/>20079:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="20080"/>20080:                            ?SEV_ANNOUNCE_CONTINUE(Server, send_reply),
<a name="20081"/>20081:                            ok
<a name="20082"/>20082:                    end},
<a name="20083"/>20083:          #{desc =&gt; &quot;await server ready (with reply sent 3)&quot;,
<a name="20084"/>20084:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="20085"/>20085:                            ?SEV_AWAIT_READY(Server, server, send_reply)
<a name="20086"/>20086:                    end},
<a name="20087"/>20087:          #{desc =&gt; &quot;await client ready (reply recv 3)&quot;,
<a name="20088"/>20088:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="20089"/>20089:                            ?SEV_AWAIT_READY(Client, client, recv_reply)
<a name="20090"/>20090:                    end},
<a name="20091"/>20091: 
<a name="20092"/>20092: 
<a name="20093"/>20093:          %% *** Termination ***
<a name="20094"/>20094:          #{desc =&gt; &quot;order client to terminate&quot;,
<a name="20095"/>20095:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="20096"/>20096:                            ?SEV_ANNOUNCE_TERMINATE(Client),
<a name="20097"/>20097:                            ok
<a name="20098"/>20098:                    end},
<a name="20099"/>20099:          #{desc =&gt; &quot;await client termination&quot;,
<a name="20100"/>20100:            cmd  =&gt; fun(#{client := Client} = State) -&gt;
<a name="20101"/>20101:                            ?SEV_AWAIT_TERMINATION(Client),
<a name="20102"/>20102:                            State1 = maps:remove(client, State),
<a name="20103"/>20103:                            {ok, State1}
<a name="20104"/>20104:                    end},
<a name="20105"/>20105:          #{desc =&gt; &quot;order server to terminate&quot;,
<a name="20106"/>20106:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="20107"/>20107:                            ?SEV_ANNOUNCE_TERMINATE(Server),
<a name="20108"/>20108:                            ok
<a name="20109"/>20109:                    end},
<a name="20110"/>20110:          #{desc =&gt; &quot;await server termination&quot;,
<a name="20111"/>20111:            cmd  =&gt; fun(#{server := Server} = State) -&gt;
<a name="20112"/>20112:                            ?SEV_AWAIT_TERMINATION(Server),
<a name="20113"/>20113:                            State1 = maps:remove(server, State),
<a name="20114"/>20114:                            {ok, State1}
<a name="20115"/>20115:                    end},
<a name="20116"/>20116: 
<a name="20117"/>20117:          %% *** We are done ***
<a name="20118"/>20118:          ?SEV_FINISH_NORMAL
<a name="20119"/>20119:         ],
<a name="20120"/>20120: 
<a name="20121"/>20121: 
<a name="20122"/>20122:     i(&quot;start server evaluator&quot;),
<a name="20123"/>20123:     Server = ?SEV_START(&quot;server&quot;, ServerSeq, InitState),
<a name="20124"/>20124: 
<a name="20125"/>20125:     i(&quot;start client evaluator&quot;),
<a name="20126"/>20126:     Client = ?SEV_START(&quot;client&quot;, ClientSeq, InitState),
<a name="20127"/>20127: 
<a name="20128"/>20128:     i(&quot;start tester evaluator&quot;),
<a name="20129"/>20129:     TesterInitState = #{server =&gt; Server#ev.pid,
<a name="20130"/>20130:                         client =&gt; Client#ev.pid},
<a name="20131"/>20131:     Tester = ?SEV_START(&quot;tester&quot;, TesterSeq, TesterInitState),
<a name="20132"/>20132: 
<a name="api_opt_sock_timestamp_tcp-last_expr"/><a name="20133"/>20133: <b>    ok = ?SEV_AWAIT_FINISH</b>([Server, Client, Tester]).
<a name="20134"/>20134: 
<a name="20135"/>20135: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="20136"/>20136: 
<a name="20137"/>20137: <i>%% Tests that the add_mambership and drop_membership ip options work.</i>
<a name="20138"/>20138: <i>%% We create one server and two clients. The server only send messages,</i>
<a name="20139"/>20139: <i>%% the clients only receives messages.</i>
<a name="20140"/>20140: <i>%% An UDP datagram is forbidden (RFC 1122) from having a source address</i>
<a name="20141"/>20141: <i>%% that is a multicast address (or a broadcast address).</i>
<a name="20142"/>20142: <i>%% So, the server create a socket &quot;for sending&quot; and the clients sockets</i>
<a name="20143"/>20143: <i>%% &quot;for receiving&quot;.</i>
<a name="20144"/>20144: <i>%% Sending socket:   Bound to the local address (and any port).</i>
<a name="20145"/>20145: <i>%%                   When sending, the dest will be the multicast address</i>
<a name="20146"/>20146: <i>%%                   and port of the receiving socket.</i>
<a name="20147"/>20147: <i>%% Receiving socket: Bound to the multicast address and port.</i>
<a name="api_opt_ip_add_drop_membership-0"/><a name="20148"/>20148: <b>api_opt_ip_add_drop_membership</b>() -&gt;
<a name="api_opt_ip_add_drop_membership-last_expr"/><a name="20149"/>20149: <b>    [{doc, &quot;OTP-15908 </b>(ERL-980)&quot;}].
<a name="20150"/>20150: 
<a name="api_opt_ip_add_drop_membership-1"/><a name="20151"/>20151: <b>api_opt_ip_add_drop_membership</b>(_Config) when is_list(_Config) -&gt;
<a name="20152"/>20152:     ?TT(?SECS(30)),
<a name="api_opt_ip_add_drop_membership-last_expr"/><a name="20153"/>20153: <b>    tc_try</b>(api_opt_ip_add_drop_membership,
<a name="20154"/>20154:            fun() -&gt;
<a name="20155"/>20155:                    has_support_ip_add_membership(),
<a name="20156"/>20156:                    has_support_ip_drop_membership(),
<a name="20157"/>20157:                    has_support_ip_multicast()
<a name="20158"/>20158:            end,
<a name="20159"/>20159:            fun() -&gt; api_opt_ip_add_drop_membership_do() end).
<a name="20160"/>20160: 
<a name="20161"/>20161: 
<a name="api_opt_ip_add_drop_membership_do-0"/><a name="20162"/>20162: <b>api_opt_ip_add_drop_membership_do</b>() -&gt;
<a name="20163"/>20163:     Set = fun(S, Key, Val) -&gt;
<a name="20164"/>20164:                   socket:setopt(S, ip, Key, Val)
<a name="20165"/>20165:           end,
<a name="20166"/>20166:     AddMembership  = fun(S, Val) -&gt; Set(S, add_membership,  Val) end,
<a name="20167"/>20167:     DropMembership = fun(S, Val) -&gt; Set(S, drop_membership, Val) end,
<a name="20168"/>20168: 
<a name="20169"/>20169:     ServerSeq =
<a name="20170"/>20170:         [
<a name="20171"/>20171:          %% *** Wait for start order part ***
<a name="20172"/>20172:          #{desc =&gt; &quot;await start&quot;,
<a name="20173"/>20173:            cmd  =&gt; fun(State) -&gt;
<a name="20174"/>20174:                            {Tester, MSA} = ?SEV_AWAIT_START(),
<a name="20175"/>20175:                            {ok, State#{tester =&gt; Tester, msa =&gt; MSA}}
<a name="20176"/>20176:                    end},
<a name="20177"/>20177:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="20178"/>20178:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="20179"/>20179:                            _MRef = erlang:monitor(process, Tester),
<a name="20180"/>20180:                            ok
<a name="20181"/>20181:                    end},
<a name="20182"/>20182: 
<a name="20183"/>20183:          %% *** Init part ***
<a name="20184"/>20184:          #{desc =&gt; &quot;which local address&quot;,
<a name="20185"/>20185:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="20186"/>20186:                            LSA = which_local_socket_addr(Domain),
<a name="20187"/>20187:                            {ok, State#{local_sa =&gt; LSA}}
<a name="20188"/>20188:                    end},
<a name="20189"/>20189:          #{desc =&gt; &quot;create socket&quot;,
<a name="20190"/>20190:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="20191"/>20191:                            case socket:open(Domain, dgram, udp) of
<a name="20192"/>20192:                                {ok, Sock} -&gt;
<a name="20193"/>20193:                                    {ok, State#{sock =&gt; Sock}};
<a name="20194"/>20194:                                {error, _} = ERROR -&gt;
<a name="20195"/>20195:                                    ERROR
<a name="20196"/>20196:                            end
<a name="20197"/>20197:                    end},
<a name="20198"/>20198:          #{desc =&gt; &quot;make recv socket reuse addr&quot;,
<a name="20199"/>20199:            cmd  =&gt; fun(#{sock := Sock} = _State) -&gt;
<a name="20200"/>20200:                            case socket:setopt(Sock, socket, reuseaddr, true) of
<a name="20201"/>20201:                                ok -&gt;
<a name="20202"/>20202:                                    ok;
<a name="20203"/>20203:                                {error, Reason} = ERROR -&gt;
<a name="20204"/>20204:                                    ?SEV_EPRINT(&quot;Failed set reuseaddr: &quot;
<a name="20205"/>20205:                                                &quot;~n   ~p&quot;, [Reason]),
<a name="20206"/>20206:                                    ERROR
<a name="20207"/>20207:                            end
<a name="20208"/>20208:                    end},
<a name="20209"/>20209:          #{desc =&gt; &quot;bind recv socket to multicast address&quot;,
<a name="20210"/>20210:            cmd  =&gt; fun(#{sock := Sock, msa := MSA} = State) -&gt;
<a name="20211"/>20211:                            case sock_bind(Sock, MSA) of
<a name="20212"/>20212:                                ok -&gt;
<a name="20213"/>20213:                                    Port = sock_port(Sock),
<a name="20214"/>20214:                                    ?SEV_IPRINT(&quot;bound to:&quot;
<a name="20215"/>20215:                                                &quot;~n   ~p&quot;, [Port]),
<a name="20216"/>20216:                                    {ok, State#{msa =&gt; MSA#{port =&gt; Port}}};
<a name="20217"/>20217:                                {error, _} = ERROR -&gt;
<a name="20218"/>20218:                                    ERROR
<a name="20219"/>20219:                            end
<a name="20220"/>20220:                    end},
<a name="20221"/>20221:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="20222"/>20222:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="20223"/>20223:                            ?SEV_ANNOUNCE_READY(Tester, init),
<a name="20224"/>20224:                            ok
<a name="20225"/>20225:                    end},
<a name="20226"/>20226: 
<a name="20227"/>20227:          %% The actual test
<a name="20228"/>20228:          #{desc =&gt; &quot;await continue (add_membership)&quot;,
<a name="20229"/>20229:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="20230"/>20230:                            ?SEV_AWAIT_CONTINUE(Tester, tester, add_membership)
<a name="20231"/>20231:                    end},
<a name="20232"/>20232:          #{desc =&gt; &quot;add membership&quot;,
<a name="20233"/>20233:            cmd  =&gt; fun(#{sock     := Sock,
<a name="20234"/>20234:                          msa      := #{addr := MAddr},
<a name="20235"/>20235:                          local_sa := #{addr := Addr}} = State) -&gt;
<a name="20236"/>20236:                            MReq = #{multiaddr =&gt; MAddr,
<a name="20237"/>20237:                                     interface =&gt; Addr},
<a name="20238"/>20238:                            ?SEV_IPRINT(&quot;try add membership to:&quot;
<a name="20239"/>20239:                                        &quot;~n   ~p&quot;, [MReq]),
<a name="20240"/>20240:                            case AddMembership(Sock, MReq) of
<a name="20241"/>20241:                                ok -&gt;
<a name="20242"/>20242:                                    ?SEV_IPRINT(&quot;membership added&quot;),
<a name="20243"/>20243:                                    {ok, State#{mreq =&gt; MReq}};
<a name="20244"/>20244:                                {error, Reason} = ERROR -&gt;
<a name="20245"/>20245:                                    ?SEV_EPRINT(&quot;Failed adding membership to: &quot;
<a name="20246"/>20246:                                                &quot;~n   ~p&quot;
<a name="20247"/>20247:                                                &quot;~n   Reason:  ~p&quot;,
<a name="20248"/>20248:                                                [MReq, Reason]),
<a name="20249"/>20249:                                    ERROR
<a name="20250"/>20250:                            end
<a name="20251"/>20251:                    end},
<a name="20252"/>20252:          #{desc =&gt; &quot;announce ready (add-membership)&quot;,
<a name="20253"/>20253:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="20254"/>20254:                            ?SEV_ANNOUNCE_READY(Tester, add_membership),
<a name="20255"/>20255:                            ok
<a name="20256"/>20256:                    end},
<a name="20257"/>20257: 
<a name="20258"/>20258:          #{desc =&gt; &quot;await continue (drop_membership)&quot;,
<a name="20259"/>20259:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="20260"/>20260:                            ?SEV_AWAIT_CONTINUE(Tester, tester, drop_membership)
<a name="20261"/>20261:                    end},
<a name="20262"/>20262:          #{desc =&gt; &quot;drop membership&quot;,
<a name="20263"/>20263:            cmd  =&gt; fun(#{sock := Sock,
<a name="20264"/>20264:                          mreq := MReq} = State) -&gt;
<a name="20265"/>20265:                            ?SEV_IPRINT(&quot;try drop membership from:&quot;
<a name="20266"/>20266:                                        &quot;~n   ~p&quot;, [MReq]),
<a name="20267"/>20267:                            case DropMembership(Sock, MReq) of
<a name="20268"/>20268:                                ok -&gt;
<a name="20269"/>20269:                                    ?SEV_IPRINT(&quot;membership dropped&quot;),
<a name="20270"/>20270:                                    {ok, maps:remove(mreq, State)};
<a name="20271"/>20271:                                {error, Reason} = ERROR -&gt;
<a name="20272"/>20272:                                    ?SEV_EPRINT(&quot;Failed drop membership from: &quot;
<a name="20273"/>20273:                                                &quot;~n   ~p&quot;
<a name="20274"/>20274:                                                &quot;~n   Reason:  ~p&quot;,
<a name="20275"/>20275:                                                [MReq, Reason]),
<a name="20276"/>20276:                                    ERROR
<a name="20277"/>20277:                            end
<a name="20278"/>20278:                    end},
<a name="20279"/>20279:          #{desc =&gt; &quot;announce ready (drop-membership)&quot;,
<a name="20280"/>20280:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="20281"/>20281:                            ?SEV_ANNOUNCE_READY(Tester, drop_membership),
<a name="20282"/>20282:                            ok
<a name="20283"/>20283:                    end},
<a name="20284"/>20284: 
<a name="20285"/>20285: 
<a name="20286"/>20286:          %% Termination
<a name="20287"/>20287:          #{desc =&gt; &quot;await terminate (from tester)&quot;,
<a name="20288"/>20288:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="20289"/>20289:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="20290"/>20290:                                ok -&gt;
<a name="20291"/>20291:                                    {ok, maps:remove(tester, State)};
<a name="20292"/>20292:                                {error, _} = ERROR -&gt;
<a name="20293"/>20293:                                    ERROR
<a name="20294"/>20294:                            end
<a name="20295"/>20295:                    end},
<a name="20296"/>20296:          #{desc =&gt; &quot;close socket&quot;,
<a name="20297"/>20297:            cmd  =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="20298"/>20298:                            socket:close(Sock),
<a name="20299"/>20299:                            {ok, maps:remove(sock, State)}
<a name="20300"/>20300:                    end},
<a name="20301"/>20301: 
<a name="20302"/>20302:          %% *** We are done ***
<a name="20303"/>20303:          ?SEV_FINISH_NORMAL
<a name="20304"/>20304:         ],
<a name="20305"/>20305: 
<a name="20306"/>20306: 
<a name="20307"/>20307:     TesterSeq =
<a name="20308"/>20308:         [
<a name="20309"/>20309:          %% *** Init part ***
<a name="20310"/>20310:          #{desc =&gt; &quot;monitor server&quot;,
<a name="20311"/>20311:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="20312"/>20312:                            _MRef = erlang:monitor(process, Server),
<a name="20313"/>20313:                            ok
<a name="20314"/>20314:                    end},
<a name="20315"/>20315: 
<a name="20316"/>20316:          %% Start the server
<a name="20317"/>20317:          #{desc =&gt; &quot;order server start&quot;,
<a name="20318"/>20318:            cmd  =&gt; fun(#{server := Pid, msa := MSA} = _State) -&gt;
<a name="20319"/>20319:                            ?SEV_ANNOUNCE_START(Pid, MSA),
<a name="20320"/>20320:                            ok
<a name="20321"/>20321:                    end},
<a name="20322"/>20322:          #{desc =&gt; &quot;await server ready (init)&quot;,
<a name="20323"/>20323:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="20324"/>20324:                            case ?SEV_AWAIT_READY(Pid, server, init) of
<a name="20325"/>20325:                                ok -&gt;
<a name="20326"/>20326:                                    ok;
<a name="20327"/>20327:                                {error, Reason} = ERROR -&gt;
<a name="20328"/>20328:                                    ?SEV_EPRINT(&quot;Start of server failed: &quot;
<a name="20329"/>20329:                                                &quot;~n   ~p&quot;, [Reason]),
<a name="20330"/>20330:                                    ERROR
<a name="20331"/>20331:                            end
<a name="20332"/>20332:                    end},
<a name="20333"/>20333: 
<a name="20334"/>20334: 
<a name="20335"/>20335:          %% *** The actual test ***
<a name="20336"/>20336:          #{desc =&gt; &quot;order server to continue (add-membership)&quot;,
<a name="20337"/>20337:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="20338"/>20338:                            ?SEV_ANNOUNCE_CONTINUE(Server, add_membership),
<a name="20339"/>20339:                            ok
<a name="20340"/>20340:                    end},
<a name="20341"/>20341:          #{desc =&gt; &quot;await server ready (add-membership)&quot;,
<a name="20342"/>20342:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="20343"/>20343:                            ?SEV_AWAIT_READY(Server, server, add_membership)
<a name="20344"/>20344:                    end},
<a name="20345"/>20345: 
<a name="20346"/>20346:          #{desc =&gt; &quot;order server to continue (drop-membership)&quot;,
<a name="20347"/>20347:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="20348"/>20348:                            ?SEV_ANNOUNCE_CONTINUE(Server, drop_membership),
<a name="20349"/>20349:                            ok
<a name="20350"/>20350:                    end},
<a name="20351"/>20351:          #{desc =&gt; &quot;await server ready (drop-membership)&quot;,
<a name="20352"/>20352:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="20353"/>20353:                            ?SEV_AWAIT_READY(Server, server, drop_membership)
<a name="20354"/>20354:                    end},
<a name="20355"/>20355: 
<a name="20356"/>20356:          ?SEV_SLEEP(?SECS(1)),
<a name="20357"/>20357: 
<a name="20358"/>20358:          %% *** Termination ***
<a name="20359"/>20359:          #{desc =&gt; &quot;order server terminate&quot;,
<a name="20360"/>20360:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="20361"/>20361:                            ?SEV_ANNOUNCE_TERMINATE(Server),
<a name="20362"/>20362:                            ok
<a name="20363"/>20363:                    end},
<a name="20364"/>20364:          #{desc =&gt; &quot;await server termination&quot;,
<a name="20365"/>20365:            cmd  =&gt; fun(#{server := Server} = State) -&gt;
<a name="20366"/>20366:                            ?SEV_AWAIT_TERMINATION(Server),
<a name="20367"/>20367:                            {ok, maps:remove(server, State)}
<a name="20368"/>20368:                    end},
<a name="20369"/>20369: 
<a name="20370"/>20370:          %% *** We are done ***
<a name="20371"/>20371:          ?SEV_FINISH_NORMAL
<a name="20372"/>20372:         ],
<a name="20373"/>20373: 
<a name="20374"/>20374: 
<a name="20375"/>20375:     Domain = inet,
<a name="20376"/>20376:     i(&quot;get multicast address&quot;),
<a name="20377"/>20377:     MAddr  = which_ip_multicast_address(),
<a name="20378"/>20378:     MSA    = #{family =&gt; Domain, addr =&gt; MAddr},
<a name="20379"/>20379: 
<a name="20380"/>20380:     i(&quot;start server evaluator&quot;),
<a name="20381"/>20381:     ServerInitState = #{domain =&gt; Domain},
<a name="20382"/>20382:     Server = ?SEV_START(&quot;server&quot;, ServerSeq, ServerInitState),
<a name="20383"/>20383: 
<a name="20384"/>20384:     i(&quot;start tester evaluator&quot;),
<a name="20385"/>20385:     TesterInitState = #{domain  =&gt; Domain,
<a name="20386"/>20386:                         msa     =&gt; MSA,
<a name="20387"/>20387:                         server  =&gt; Server#ev.pid},
<a name="20388"/>20388:     Tester = ?SEV_START(&quot;tester&quot;, TesterSeq, TesterInitState),
<a name="20389"/>20389: 
<a name="20390"/>20390:     i(&quot;await evaluator(s)&quot;),
<a name="api_opt_ip_add_drop_membership_do-last_expr"/><a name="20391"/>20391: <b>    ok = ?SEV_AWAIT_FINISH</b>([Tester, Server]).
<a name="20392"/>20392: 
<a name="20393"/>20393: 
<a name="20394"/>20394: 
<a name="which_ip_multicast_address-0"/><a name="20395"/>20395: <b>which_ip_multicast_address</b>() -&gt;
<a name="which_ip_multicast_address-last_expr"/><a name="20396"/>20396: <b>    which_multicast_address</b>(inet).
<a name="20397"/>20397: 
<a name="which_multicast_address-1"/><a name="20398"/>20398: <b>which_multicast_address</b>(Domain) -&gt;
<a name="which_multicast_address-last_expr"/><a name="20399"/>20399: <b>    case os:type</b>() of
<a name="20400"/>20400:         {unix, linux} -&gt;
<a name="20401"/>20401:             WhichMAddr = fun([_, _, MAddr]) -&gt; MAddr end,
<a name="20402"/>20402:             which_multicast_address2(Domain, WhichMAddr);
<a name="20403"/>20403: 
<a name="20404"/>20404:         {unix, sunos} -&gt;
<a name="20405"/>20405:             WhichMAddr = fun([_, MAddr, _]) -&gt; MAddr end,
<a name="20406"/>20406:             which_multicast_address2(Domain, WhichMAddr);
<a name="20407"/>20407: 
<a name="20408"/>20408:         Type -&gt;
<a name="20409"/>20409:             %% Actually, what is &quot;not supported&quot;. is netstat!
<a name="20410"/>20410:             not_supported({multicast, Type})
<a name="20411"/>20411:     end.
<a name="20412"/>20412: 
<a name="20413"/>20413: <i>%% Note that the 'netstat -g' table looks different on linux and SunOS</i>
<a name="20414"/>20414: <i>%% Linux: IfName - RefCnt - Group</i>
<a name="20415"/>20415: <i>%% SunOS: IfName - Group  - RefCnt</i>
<a name="20416"/>20416: 
<a name="which_multicast_address2-2"/><a name="20417"/>20417: <b>which_multicast_address2</b>(Domain, WhichMAddr) -&gt;
<a name="20418"/>20418:     IfName = which_local_host_ifname(Domain),
<a name="20419"/>20419:     %% On some platforms the netstat barfs out some crap on stderr
<a name="20420"/>20420:     %% before the actual info...
<a name="20421"/>20421:     %% ...without the 'n' (that is; just '-g') this command can take a
<a name="20422"/>20422:     %% *long* time. *With* the 'n' its much better. But just to be on
<a name="20423"/>20423:     %% the safe side, we add a timeout of 10 seconds.
<a name="which_multicast_address2-last_expr"/><a name="20424"/>20424: <b>    case ?LIB:os_cmd</b>(&quot;netstat -gn 2&gt;/dev/null | grep &quot; ++ IfName, ?SECS(10)) of
<a name="20425"/>20425:         {error, timeout} -&gt;
<a name="20426"/>20426:             skip({netstat, timeout});
<a name="20427"/>20427:         {ok, []} -&gt;
<a name="20428"/>20428:             %% Can't figure out if we support multicast or not...
<a name="20429"/>20429:             not_supported(no_netstat);
<a name="20430"/>20430:         {ok, NetstatGroupsStr} -&gt;
<a name="20431"/>20431:             try
<a name="20432"/>20432:                 begin
<a name="20433"/>20433:                     NetstatGroups0   = string:tokens(NetstatGroupsStr, [$\n]),
<a name="20434"/>20434:                     NetstatGroups    = [string:tokens(G, [$ ]) || 
<a name="20435"/>20435:                                            G &lt;- NetstatGroups0],
<a name="20436"/>20436:                     MAddrs           = [WhichMAddr(NetstatGroup) || 
<a name="20437"/>20437:                                            NetstatGroup &lt;- NetstatGroups],
<a name="20438"/>20438:                     which_multicast_address3(Domain, MAddrs)
<a name="20439"/>20439:                 end
<a name="20440"/>20440:             catch
<a name="20441"/>20441:                 throw:E:_ -&gt;
<a name="20442"/>20442:                     throw(E);
<a name="20443"/>20443:                 C:E:S -&gt;
<a name="20444"/>20444:                     not_supported({multicast, {C,E,S}})
<a name="20445"/>20445:             end
<a name="20446"/>20446:     end.
<a name="20447"/>20447: 
<a name="which_multicast_address3-2"/><a name="20448"/>20448: <b>which_multicast_address3</b>(_Domain, []) -&gt;
<a name="20449"/>20449:     not_supported({multicast, no_valid_addrs});
<a name="20450"/>20450: <b>which_multicast_address3</b>(Domain, [MAddrStr|MAddrs]) -&gt;
<a name="20451"/>20451:     %% Even on linux some of these are not actually addresses, but
<a name="20452"/>20452:     %% &quot;host names&quot;, such as all-systems.mcast.net. But both
<a name="20453"/>20453:     %% address strings, such as &quot;224.0.0.251&quot; and host name strings
<a name="20454"/>20454:     %% gets translated into an address by the inet:inet:getaddr/2.
<a name="which_multicast_address3-last_expr"/><a name="20455"/>20455: <b>    case inet:getaddr</b>(MAddrStr, Domain) of
<a name="20456"/>20456:         {ok, MAddr} -&gt;
<a name="20457"/>20457:             MAddr;
<a name="20458"/>20458:         {error, _} -&gt;
<a name="20459"/>20459:             which_multicast_address3(Domain, MAddrs)
<a name="20460"/>20460:     end.
<a name="20461"/>20461:     
<a name="which_local_host_ifname-1"/><a name="20462"/>20462: <b>which_local_host_ifname</b>(Domain) -&gt;
<a name="which_local_host_ifname-last_expr"/><a name="20463"/>20463: <b>    case ?LIB:which_local_host_info</b>(Domain) of
<a name="20464"/>20464:         {ok, #{name := Name}} -&gt;
<a name="20465"/>20465:             Name;
<a name="20466"/>20466:         {error, Reason} -&gt;
<a name="20467"/>20467:             not_supported({multicast, Reason})
<a name="20468"/>20468:     end.
<a name="20469"/>20469: 
<a name="20470"/>20470:     
<a name="20471"/>20471: 
<a name="20472"/>20472: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="20473"/>20473: 
<a name="20474"/>20474: <i>%% Tests that the pktinfo control message header is received when</i>
<a name="20475"/>20475: <i>%% setting the socket 'ip' option pktinfo is set to true when using</i>
<a name="20476"/>20476: <i>%% sendmsg/recvmsg on an IPv4 UDP (dgram) socket.</i>
<a name="20477"/>20477: <i>%% So, this is done on the receiving side: </i>
<a name="20478"/>20478: <i>%%</i>
<a name="20479"/>20479: <i>%%               socket:setopt(Sock, ip, pktinfo, boolean()).</i>
<a name="20480"/>20480: <i>%%</i>
<a name="20481"/>20481: <i>%% For all subsequent *received* messages, the pktinfo control message</i>
<a name="20482"/>20482: <i>%% header will be with the message.</i>
<a name="20483"/>20483: <i>%%</i>
<a name="20484"/>20484: <i>%% Note that it *should* be possible to explicitly send pktinfo also,</i>
<a name="20485"/>20485: <i>%% but this have not yet been implemented (in socket), so that part</i>
<a name="20486"/>20486: <i>%% we do not test!!</i>
<a name="20487"/>20487: <i>%%</i>
<a name="20488"/>20488: 
<a name="api_opt_ip_pktinfo_udp4-1"/><a name="20489"/>20489: <b>api_opt_ip_pktinfo_udp4</b>(_Config) when is_list(_Config) -&gt;
<a name="20490"/>20490:     ?TT(?SECS(5)),
<a name="api_opt_ip_pktinfo_udp4-last_expr"/><a name="20491"/>20491: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="20492"/>20492:            fun() -&gt; has_support_ipv4(), has_support_ip_pktinfo() end,
<a name="20493"/>20493:            fun() -&gt;
<a name="20494"/>20494:                    Set  = fun(Sock, Value) -&gt;
<a name="20495"/>20495:                                   socket:setopt(Sock, ip, pktinfo, Value)
<a name="20496"/>20496:                           end,
<a name="20497"/>20497:                    Get  = fun(Sock) -&gt;
<a name="20498"/>20498:                                   socket:getopt(Sock, ip, pktinfo)
<a name="20499"/>20499:                           end,
<a name="20500"/>20500:                    Send = fun(Sock, Data, Dest, default) -&gt;
<a name="20501"/>20501:                                   Msg = #{addr =&gt; Dest,
<a name="20502"/>20502:                                           iov  =&gt; [Data]},
<a name="20503"/>20503:                                   socket:sendmsg(Sock, Msg);
<a name="20504"/>20504:                              (Sock, Data, Dest, Info) -&gt;
<a name="20505"/>20505:                                   %% We do not support this at the moment!!!
<a name="20506"/>20506:                                   CMsg = #{level =&gt; ip,
<a name="20507"/>20507:                                            type  =&gt; pktinfo,
<a name="20508"/>20508:                                            data  =&gt; Info},
<a name="20509"/>20509:                                   Msg  = #{addr =&gt; Dest,
<a name="20510"/>20510:                                            ctrl =&gt; [CMsg],
<a name="20511"/>20511:                                            iov  =&gt; [Data]},
<a name="20512"/>20512:                                   socket:sendmsg(Sock, Msg)
<a name="20513"/>20513:                           end,
<a name="20514"/>20514:                    Recv = fun(Sock) -&gt;
<a name="20515"/>20515:                                   case socket:recvmsg(Sock) of
<a name="20516"/>20516:                                       {ok, #{addr := Source,
<a name="20517"/>20517:                                              ctrl := CMsgs,
<a name="20518"/>20518:                                              iov  := [Data]}} -&gt;
<a name="20519"/>20519:                                           {ok, {Source, CMsgs, Data}};
<a name="20520"/>20520:                                       {error, _} = ERROR -&gt;
<a name="20521"/>20521:                                           ERROR
<a name="20522"/>20522:                                   end
<a name="20523"/>20523:                           end,
<a name="20524"/>20524:                    InitState = #{domain =&gt; inet,
<a name="20525"/>20525:                                  proto  =&gt; udp,
<a name="20526"/>20526:                                  send   =&gt; Send,
<a name="20527"/>20527:                                  recv   =&gt; Recv,
<a name="20528"/>20528:                                  set    =&gt; Set,
<a name="20529"/>20529:                                  get    =&gt; Get},
<a name="20530"/>20530:                    ok = api_opt_ip_pktinfo_udp(InitState)
<a name="20531"/>20531:            end).
<a name="20532"/>20532: 
<a name="20533"/>20533: 
<a name="20534"/>20534: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="20535"/>20535: 
<a name="api_opt_ip_pktinfo_udp-1"/><a name="20536"/>20536: <b>api_opt_ip_pktinfo_udp</b>(InitState) -&gt;
<a name="20537"/>20537:     Seq = 
<a name="20538"/>20538:         [
<a name="20539"/>20539:          #{desc =&gt; &quot;local address&quot;,
<a name="20540"/>20540:            cmd  =&gt; fun(#{domain := local = Domain} = State) -&gt;
<a name="20541"/>20541:                            LSASrc = which_local_socket_addr(Domain),
<a name="20542"/>20542:                            LSADst = which_local_socket_addr(Domain),
<a name="20543"/>20543:                            {ok, State#{lsa_src =&gt; LSASrc,
<a name="20544"/>20544:                                        lsa_dst =&gt; LSADst}};
<a name="20545"/>20545:                       (#{domain := Domain} = State) -&gt;
<a name="20546"/>20546:                            LSA = which_local_socket_addr(Domain),
<a name="20547"/>20547:                            {ok, State#{lsa_src =&gt; LSA,
<a name="20548"/>20548:                                        lsa_dst =&gt; LSA}}
<a name="20549"/>20549:                    end},
<a name="20550"/>20550: 
<a name="20551"/>20551:          #{desc =&gt; &quot;open src socket&quot;,
<a name="20552"/>20552:            cmd  =&gt; fun(#{domain := Domain,
<a name="20553"/>20553:                          proto  := Proto} = State) -&gt;
<a name="20554"/>20554:                            Sock = sock_open(Domain, dgram, Proto),
<a name="20555"/>20555:                            {ok, State#{sock_src =&gt; Sock}}
<a name="20556"/>20556:                    end},
<a name="20557"/>20557:          #{desc =&gt; &quot;bind src&quot;,
<a name="20558"/>20558:            cmd  =&gt; fun(#{sock_src := Sock, lsa_src := LSA}) -&gt;
<a name="20559"/>20559:                            case sock_bind(Sock, LSA) of
<a name="20560"/>20560:                                ok -&gt;
<a name="20561"/>20561:                                    ?SEV_IPRINT(&quot;src bound&quot;),
<a name="20562"/>20562:                                    ok;
<a name="20563"/>20563:                                {error, Reason} = ERROR -&gt;
<a name="20564"/>20564:                                    ?SEV_EPRINT(&quot;src bind failed: ~p&quot;, [Reason]),
<a name="20565"/>20565:                                    ERROR
<a name="20566"/>20566:                            end
<a name="20567"/>20567:                    end},
<a name="20568"/>20568:          #{desc =&gt; &quot;sockname src socket&quot;,
<a name="20569"/>20569:            cmd  =&gt; fun(#{sock_src := Sock} = State) -&gt;
<a name="20570"/>20570:                            SASrc = sock_sockname(Sock),
<a name="20571"/>20571:                            ?SEV_IPRINT(&quot;src sockaddr: &quot;
<a name="20572"/>20572:                                        &quot;~n   ~p&quot;, [SASrc]),
<a name="20573"/>20573:                            {ok, State#{sa_src =&gt; SASrc}}
<a name="20574"/>20574:                    end},
<a name="20575"/>20575: 
<a name="20576"/>20576:          #{desc =&gt; &quot;open dst socket&quot;,
<a name="20577"/>20577:            cmd  =&gt; fun(#{domain := Domain,
<a name="20578"/>20578:                          proto  := Proto} = State) -&gt;
<a name="20579"/>20579:                            Sock = sock_open(Domain, dgram, Proto),
<a name="20580"/>20580:                            {ok, State#{sock_dst =&gt; Sock}}
<a name="20581"/>20581:                    end},
<a name="20582"/>20582:          #{desc =&gt; &quot;bind dst&quot;,
<a name="20583"/>20583:            cmd  =&gt; fun(#{sock_dst := Sock, lsa_dst := LSA}) -&gt;
<a name="20584"/>20584:                            case sock_bind(Sock, LSA) of
<a name="20585"/>20585:                                ok -&gt;
<a name="20586"/>20586:                                    ?SEV_IPRINT(&quot;src bound&quot;),
<a name="20587"/>20587:                                    ok;
<a name="20588"/>20588:                                {error, Reason} = ERROR -&gt;
<a name="20589"/>20589:                                    ?SEV_EPRINT(&quot;src bind failed: ~p&quot;, [Reason]),
<a name="20590"/>20590:                                    ERROR
<a name="20591"/>20591:                            end
<a name="20592"/>20592:                    end},
<a name="20593"/>20593:          #{desc =&gt; &quot;sockname dst socket&quot;,
<a name="20594"/>20594:            cmd  =&gt; fun(#{sock_dst := Sock} = State) -&gt;
<a name="20595"/>20595:                            SADst = sock_sockname(Sock),
<a name="20596"/>20596:                            ?SEV_IPRINT(&quot;dst sockaddr: &quot;
<a name="20597"/>20597:                                        &quot;~n   ~p&quot;, [SADst]),
<a name="20598"/>20598:                            {ok, State#{sa_dst =&gt; SADst}}
<a name="20599"/>20599:                    end},
<a name="20600"/>20600:          #{desc =&gt; &quot;get default pktinfo for dst socket&quot;,
<a name="20601"/>20601:            cmd  =&gt; fun(#{sock_dst := Sock, get := Get} = _State) -&gt;
<a name="20602"/>20602:                            case Get(Sock) of
<a name="20603"/>20603:                                {ok, false = Value} -&gt;
<a name="20604"/>20604:                                    ?SEV_IPRINT(&quot;dst recvttl: ~p&quot;, [Value]),
<a name="20605"/>20605:                                    ok;
<a name="20606"/>20606:                                {ok, Unexpected} -&gt;
<a name="20607"/>20607:                                    ?SEV_EPRINT(&quot;Unexpected src pktinfo: ~p&quot;,
<a name="20608"/>20608:                                                [Unexpected]),
<a name="20609"/>20609:                                    {error, {unexpected, Unexpected}};
<a name="20610"/>20610:                                {error, Reason} = ERROR -&gt;
<a name="20611"/>20611:                                    ?SEV_EPRINT(&quot;Failed getting (default) pktinfo:&quot;
<a name="20612"/>20612:                                                &quot;   ~p&quot;, [Reason]),
<a name="20613"/>20613:                                    ERROR
<a name="20614"/>20614:                            end
<a name="20615"/>20615:                    end},
<a name="20616"/>20616: 
<a name="20617"/>20617:          #{desc =&gt; &quot;send req (to dst) (wo (explicit) pktinfo)&quot;,
<a name="20618"/>20618:            cmd  =&gt; fun(#{sock_src := Sock, sa_dst := Dst, send := Send}) -&gt;
<a name="20619"/>20619:                            Send(Sock, ?BASIC_REQ, Dst, default)
<a name="20620"/>20620:                    end},
<a name="20621"/>20621:          #{desc =&gt; &quot;recv req (from src)&quot;,
<a name="20622"/>20622:            cmd  =&gt; fun(#{sock_dst := Sock, sa_src := Src, recv := Recv}) -&gt;
<a name="20623"/>20623:                            case Recv(Sock) of
<a name="20624"/>20624:                                {ok, {Src, [], ?BASIC_REQ}} -&gt;
<a name="20625"/>20625:                                    ok;
<a name="20626"/>20626:                                {ok, {BadSrc, BadCHdrs, BadReq} = UnexpData} -&gt;
<a name="20627"/>20627:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="20628"/>20628:                                                &quot;~n   Expect Source: ~p&quot;
<a name="20629"/>20629:                                                &quot;~n   Recv Source:   ~p&quot;
<a name="20630"/>20630:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="20631"/>20631:                                                &quot;~n   Recv CHdrs:    ~p&quot;
<a name="20632"/>20632:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="20633"/>20633:                                                &quot;~n   Recv Msg:      ~p&quot;,
<a name="20634"/>20634:                                                [Src, BadSrc,
<a name="20635"/>20635:                                                 [], BadCHdrs,
<a name="20636"/>20636:                                                 ?BASIC_REQ, BadReq]),
<a name="20637"/>20637:                                    {error, {unexpected_data, UnexpData}};
<a name="20638"/>20638:                                {ok, UnexpData} -&gt;
<a name="20639"/>20639:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="20640"/>20640:                                                &quot;~n   Expect Source: ~p&quot;
<a name="20641"/>20641:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="20642"/>20642:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="20643"/>20643:                                                &quot;~n   Unexp Data:    ~p&quot;,
<a name="20644"/>20644:                                                [Src, [], ?BASIC_REQ, UnexpData]),
<a name="20645"/>20645:                                    {error, {unexpected_data, UnexpData}};
<a name="20646"/>20646:                                {error, _} = ERROR -&gt;
<a name="20647"/>20647:                                    %% At the moment there is no way to get
<a name="20648"/>20648:                                    %% status or state for the socket...
<a name="20649"/>20649:                                    ERROR
<a name="20650"/>20650:                            end
<a name="20651"/>20651:                    end},
<a name="20652"/>20652: 
<a name="20653"/>20653: 
<a name="20654"/>20654:          %% *** We do not *yet* support sending pktinfo ***
<a name="20655"/>20655: 
<a name="20656"/>20656:          %% #{desc =&gt; &quot;send req (to dst) (w explicit pktinfo)&quot;,
<a name="20657"/>20657:          %%   cmd  =&gt; fun(#{sock_src := Sock, sa_dst := Dst, send := Send}) -&gt;
<a name="20658"/>20658:          %%                   Send(Sock, ?BASIC_REQ, Dst, PktInfo)
<a name="20659"/>20659:          %%           end},
<a name="20660"/>20660:          %% #{desc =&gt; &quot;recv req (from src) - wo pktinfo&quot;,
<a name="20661"/>20661:          %%   cmd  =&gt; fun(#{sock_dst := Sock, sa_src := Src, recv := Recv}) -&gt;
<a name="20662"/>20662:          %%                   case Recv(Sock) of
<a name="20663"/>20663:          %%                       {ok, {Src, [], ?BASIC_REQ}} -&gt;
<a name="20664"/>20664:          %%                           ok;
<a name="20665"/>20665:          %%                       {ok, {BadSrc, BadCHdrs, BadReq} = UnexpData} -&gt;
<a name="20666"/>20666:          %%                           ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="20667"/>20667:          %%                                       &quot;~n   Expect Source: ~p&quot;
<a name="20668"/>20668:          %%                                       &quot;~n   Recv Source:   ~p&quot;
<a name="20669"/>20669:          %%                                       &quot;~n   Expect CHdrs:  ~p&quot;
<a name="20670"/>20670:          %%                                       &quot;~n   Recv CHdrs:    ~p&quot;
<a name="20671"/>20671:          %%                                       &quot;~n   Expect Msg:    ~p&quot;
<a name="20672"/>20672:          %%                                       &quot;~n   Recv Msg:      ~p&quot;,
<a name="20673"/>20673:          %%                                       [Src, BadSrc,
<a name="20674"/>20674:          %%                                        [], BadCHdrs,
<a name="20675"/>20675:          %%                                        ?BASIC_REQ, BadReq]),
<a name="20676"/>20676:          %%                           {error, {unexpected_data, UnexpData}};
<a name="20677"/>20677:          %%                       {ok, UnexpData} -&gt;
<a name="20678"/>20678:          %%                           ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="20679"/>20679:          %%                                       &quot;~n   Expect Source: ~p&quot;
<a name="20680"/>20680:          %%                                       &quot;~n   Expect CHdrs:  ~p&quot;
<a name="20681"/>20681:          %%                                       &quot;~n   Expect Msg:    ~p&quot;
<a name="20682"/>20682:          %%                                       &quot;~n   Unexp Data:    ~p&quot;,
<a name="20683"/>20683:          %%                                       [Src, [], ?BASIC_REQ, UnexpData]),
<a name="20684"/>20684:          %%                           {error, {unexpected_data, UnexpData}};
<a name="20685"/>20685:          %%                       {error, _} = ERROR -&gt;
<a name="20686"/>20686:          %%                           %% At the moment there is no way to get
<a name="20687"/>20687:          %%                           %% status or state for the socket...
<a name="20688"/>20688:          %%                           ERROR
<a name="20689"/>20689:          %%                   end
<a name="20690"/>20690:          %%           end},
<a name="20691"/>20691: 
<a name="20692"/>20692:          #{desc =&gt; &quot;enable pktinfo on dst socket&quot;,
<a name="20693"/>20693:            cmd  =&gt; fun(#{sock_dst := Sock, set := Set} = _State) -&gt;
<a name="20694"/>20694:                            case Set(Sock, true) of
<a name="20695"/>20695:                                ok -&gt;
<a name="20696"/>20696:                                    ?SEV_IPRINT(&quot;dst pktinfo enabled&quot;),
<a name="20697"/>20697:                                    ok;
<a name="20698"/>20698:                                {error, Reason} = ERROR -&gt;
<a name="20699"/>20699:                                    ?SEV_EPRINT(&quot;Failed setting pktinfo:&quot;
<a name="20700"/>20700:                                                &quot;   ~p&quot;, [Reason]),
<a name="20701"/>20701:                                    ERROR
<a name="20702"/>20702:                            end
<a name="20703"/>20703:                    end},
<a name="20704"/>20704: 
<a name="20705"/>20705:          #{desc =&gt; &quot;send req (to dst) (wo explicit pktinfo)&quot;,
<a name="20706"/>20706:            cmd  =&gt; fun(#{sock_src := Sock, sa_dst := Dst, send := Send}) -&gt;
<a name="20707"/>20707:                            Send(Sock, ?BASIC_REQ, Dst, default)
<a name="20708"/>20708:                    end},
<a name="20709"/>20709:          #{desc =&gt; &quot;recv req (from src) - w default pktinfo&quot;,
<a name="20710"/>20710:            cmd  =&gt; fun(#{sock_dst := Sock, sa_src := Src, recv := Recv}) -&gt;
<a name="20711"/>20711:                            case Recv(Sock) of
<a name="20712"/>20712:                                {ok, {Src, [#{level := ip,
<a name="20713"/>20713:                                              type  := pktinfo,
<a name="20714"/>20714:                                              value := #{addr     := Addr,
<a name="20715"/>20715:                                                         ifindex  := IfIdx,
<a name="20716"/>20716:                                                         spec_dst := SpecDst}}],
<a name="20717"/>20717:                                      ?BASIC_REQ}} -&gt;
<a name="20718"/>20718:                                    ?SEV_IPRINT(&quot;Got (default) Pkt Info: &quot;
<a name="20719"/>20719:                                                &quot;~n   Addr:      ~p&quot;
<a name="20720"/>20720:                                                &quot;~n   If Index:  ~p&quot;
<a name="20721"/>20721:                                                &quot;~n   Spec Dst:  ~p&quot;,
<a name="20722"/>20722:                                                [Addr, IfIdx, SpecDst]),
<a name="20723"/>20723:                                    ok;
<a name="20724"/>20724:                                {ok, {BadSrc, BadCHdrs, BadReq} = UnexpData} -&gt;
<a name="20725"/>20725:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="20726"/>20726:                                                &quot;~n   Expect Source: ~p&quot;
<a name="20727"/>20727:                                                &quot;~n   Recv Source:   ~p&quot;
<a name="20728"/>20728:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="20729"/>20729:                                                &quot;~n   Recv CHdrs:    ~p&quot;
<a name="20730"/>20730:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="20731"/>20731:                                                &quot;~n   Recv Msg:      ~p&quot;,
<a name="20732"/>20732:                                                [Src, BadSrc,
<a name="20733"/>20733:                                                 [], BadCHdrs,
<a name="20734"/>20734:                                                 ?BASIC_REQ, BadReq]),
<a name="20735"/>20735:                                    {error, {unexpected_data, UnexpData}};
<a name="20736"/>20736:                                {ok, UnexpData} -&gt;
<a name="20737"/>20737:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="20738"/>20738:                                                &quot;~n   Expect Source: ~p&quot;
<a name="20739"/>20739:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="20740"/>20740:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="20741"/>20741:                                                &quot;~n   Unexp Data:    ~p&quot;,
<a name="20742"/>20742:                                                [Src, [], ?BASIC_REQ, UnexpData]),
<a name="20743"/>20743:                                    {error, {unexpected_data, UnexpData}};
<a name="20744"/>20744:                                {error, _} = ERROR -&gt;
<a name="20745"/>20745:                                    %% At the moment there is no way to get
<a name="20746"/>20746:                                    %% status or state for the socket...
<a name="20747"/>20747:                                    ERROR
<a name="20748"/>20748:                            end
<a name="20749"/>20749:                    end},
<a name="20750"/>20750: 
<a name="20751"/>20751: 
<a name="20752"/>20752:          %% *** We do not *yet* support sending pktinfo ***
<a name="20753"/>20753: 
<a name="20754"/>20754:          %% #{desc =&gt; &quot;send req (to dst) (w explicit pktinfo)&quot;,
<a name="20755"/>20755:          %%   cmd  =&gt; fun(#{sock_src := Sock, sa_dst := Dst, send := Send}) -&gt;
<a name="20756"/>20756:          %%                   Send(Sock, ?BASIC_REQ, Dst, PktInfo)
<a name="20757"/>20757:          %%           end},
<a name="20758"/>20758:          %% #{desc =&gt; &quot;recv req (from src) - w ttl = 100&quot;,
<a name="20759"/>20759:          %%   cmd  =&gt; fun(#{sock_dst := Sock, sa_src := Src, recv := Recv}) -&gt;
<a name="20760"/>20760:          %%                   case Recv(Sock) of
<a name="20761"/>20761:          %%                       {ok, {Src, [#{level := ip,
<a name="20762"/>20762:          %%                                     type  := ttl,
<a name="20763"/>20763:          %%                                     data  := PktInfo}], ?BASIC_REQ}} -&gt;
<a name="20764"/>20764:          %%                           ?SEV_IPRINT(&quot;Got Pkt Info: &quot;
<a name="20765"/>20765:          %%                                       &quot;~n   ~p&quot;, [Info]),
<a name="20766"/>20766:          %%                           ok;
<a name="20767"/>20767:          %%                       {ok, {BadSrc, BadCHdrs, BadReq} = UnexpData} -&gt;
<a name="20768"/>20768:          %%                           ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="20769"/>20769:          %%                                       &quot;~n   Expect Source: ~p&quot;
<a name="20770"/>20770:          %%                                       &quot;~n   Recv Source:   ~p&quot;
<a name="20771"/>20771:          %%                                       &quot;~n   Expect CHdrs:  ~p&quot;
<a name="20772"/>20772:          %%                                       &quot;~n   Recv CHdrs:    ~p&quot;
<a name="20773"/>20773:          %%                                       &quot;~n   Expect Msg:    ~p&quot;
<a name="20774"/>20774:          %%                                       &quot;~n   Recv Msg:      ~p&quot;,
<a name="20775"/>20775:          %%                                       [Src, BadSrc,
<a name="20776"/>20776:          %%                                        [], BadCHdrs,
<a name="20777"/>20777:          %%                                        ?BASIC_REQ, BadReq]),
<a name="20778"/>20778:          %%                           {error, {unexpected_data, UnexpData}};
<a name="20779"/>20779:          %%                       {ok, UnexpData} -&gt;
<a name="20780"/>20780:          %%                           ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="20781"/>20781:          %%                                       &quot;~n   Expect Source: ~p&quot;
<a name="20782"/>20782:          %%                                       &quot;~n   Expect CHdrs:  ~p&quot;
<a name="20783"/>20783:          %%                                       &quot;~n   Expect Msg:    ~p&quot;
<a name="20784"/>20784:          %%                                       &quot;~n   Unexp Data:    ~p&quot;,
<a name="20785"/>20785:          %%                                       [Src, [], ?BASIC_REQ, UnexpData]),
<a name="20786"/>20786:          %%                           {error, {unexpected_data, UnexpData}};
<a name="20787"/>20787:          %%                       {error, _} = ERROR -&gt;
<a name="20788"/>20788:          %%                           %% At the moment there is no way to get
<a name="20789"/>20789:          %%                           %% status or state for the socket...
<a name="20790"/>20790:          %%                           ERROR
<a name="20791"/>20791:          %%                   end
<a name="20792"/>20792:          %%           end},
<a name="20793"/>20793: 
<a name="20794"/>20794:          #{desc =&gt; &quot;close src socket&quot;,
<a name="20795"/>20795:            cmd  =&gt; fun(#{sock_src := Sock} = State) -&gt;
<a name="20796"/>20796:                            ok = socket:close(Sock),
<a name="20797"/>20797:                            {ok, maps:remove(sock_src, State)}
<a name="20798"/>20798:                    end},
<a name="20799"/>20799:          #{desc =&gt; &quot;close dst socket&quot;,
<a name="20800"/>20800:            cmd  =&gt; fun(#{sock_dst := Sock} = State) -&gt;
<a name="20801"/>20801:                            ok = socket:close(Sock),
<a name="20802"/>20802:                            {ok, maps:remove(sock_dst, State)}
<a name="20803"/>20803:                    end},
<a name="20804"/>20804: 
<a name="20805"/>20805:          %% *** We are done ***
<a name="20806"/>20806:          ?SEV_FINISH_NORMAL
<a name="20807"/>20807:         ],
<a name="20808"/>20808:     Evaluator = ?SEV_START(&quot;tester&quot;, Seq, InitState),
<a name="api_opt_ip_pktinfo_udp-last_expr"/><a name="20809"/>20809: <b>    ok = ?SEV_AWAIT_FINISH</b>([Evaluator]).
<a name="20810"/>20810: 
<a name="20811"/>20811: 
<a name="20812"/>20812: 
<a name="20813"/>20813: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="20814"/>20814: 
<a name="20815"/>20815: <i>%% Tests that the options control message header is received when</i>
<a name="20816"/>20816: <i>%% setting the socket 'ip' option recvopts is set to true when using</i>
<a name="20817"/>20817: <i>%% sendmsg/recvmsg on an IPv4 UDP (dgram) socket.</i>
<a name="20818"/>20818: <i>%% So, this is done on the receiving side: </i>
<a name="20819"/>20819: <i>%%</i>
<a name="20820"/>20820: <i>%%               socket:setopt(Sock, ip, recvopts, boolean()).</i>
<a name="20821"/>20821: <i>%%</i>
<a name="20822"/>20822: <i>%% For all subsequent *received* messages, the options control message</i>
<a name="20823"/>20823: <i>%% header will be with the message.</i>
<a name="20824"/>20824: <i>%%</i>
<a name="20825"/>20825: <i>%% Note that it *should* be possible to explicitly send options also,</i>
<a name="20826"/>20826: <i>%% but this have not yet been implemented (in socket), so that part</i>
<a name="20827"/>20827: <i>%% we do not test!!</i>
<a name="20828"/>20828: <i>%%</i>
<a name="20829"/>20829: <i>%%</i>
<a name="20830"/>20830: <i>%% &lt;NOTE&gt;</i>
<a name="20831"/>20831: <i>%%</i>
<a name="20832"/>20832: <i>%% This test does not currently work. The recvopts is supposed to</i>
<a name="20833"/>20833: <i>%% result in a IP_OPTIONS control message header but does not!</i>
<a name="20834"/>20834: <i>%% So, exactly how we are suppose to use this option is unknown.</i>
<a name="20835"/>20835: <i>%% So, let the test code remain, but skip until we have figured out</i>
<a name="20836"/>20836: <i>%% how to test this.</i>
<a name="20837"/>20837: <i>%%</i>
<a name="20838"/>20838: <i>%% &lt;/NOTE&gt;</i>
<a name="20839"/>20839: <i>%%</i>
<a name="20840"/>20840: 
<a name="api_opt_ip_recvopts_udp4-1"/><a name="20841"/>20841: <b>api_opt_ip_recvopts_udp4</b>(_Config) when is_list(_Config) -&gt;
<a name="20842"/>20842:     ?TT(?SECS(5)),
<a name="api_opt_ip_recvopts_udp4-last_expr"/><a name="20843"/>20843: <b>    tc_try</b>(api_opt_ip_recvopts_udp4,
<a name="20844"/>20844:            fun() -&gt;
<a name="20845"/>20845:                    has_support_ipv4(),
<a name="20846"/>20846:                    has_support_ip_recvopts(),
<a name="20847"/>20847:                    %% We also use the recvtos and timestamp options
<a name="20848"/>20848:                    %% in this test, so at least one of them must
<a name="20849"/>20849:                    %% be supported
<a name="20850"/>20850:                    has_support_ip_recvtos_and_or_sock_timestamp(),
<a name="20851"/>20851:                    not_yet_implemented()
<a name="20852"/>20852: 
<a name="20853"/>20853:            end,
<a name="20854"/>20854:            fun() -&gt;
<a name="20855"/>20855:                    Set  = fun(Sock, Value) -&gt;
<a name="20856"/>20856:                                   socket:setopt(Sock, ip, recvopts, Value)
<a name="20857"/>20857:                           end,
<a name="20858"/>20858:                    Get  = fun(Sock) -&gt;
<a name="20859"/>20859:                                   socket:getopt(Sock, ip, recvopts)
<a name="20860"/>20860:                           end,
<a name="20861"/>20861:                    Send = fun(Sock, Data, Dest, default) -&gt;
<a name="20862"/>20862:                                   Msg = #{addr =&gt; Dest,
<a name="20863"/>20863:                                              iov  =&gt; [Data]},
<a name="20864"/>20864:                                   socket:sendmsg(Sock, Msg);
<a name="20865"/>20865:                              (Sock, Data, Dest, Info) -&gt;
<a name="20866"/>20866:                                   %% We do not support this at the moment!!!
<a name="20867"/>20867:                                   CMsg = #{level =&gt; ip,
<a name="20868"/>20868:                                               type  =&gt; options,
<a name="20869"/>20869:                                               data  =&gt; Info},
<a name="20870"/>20870:                                   Msg  = #{addr =&gt; Dest,
<a name="20871"/>20871:                                               ctrl =&gt; [CMsg],
<a name="20872"/>20872:                                               iov  =&gt; [Data]},
<a name="20873"/>20873:                                   socket:sendmsg(Sock, Msg)
<a name="20874"/>20874:                           end,
<a name="20875"/>20875:                    Recv = fun(Sock) -&gt;
<a name="20876"/>20876:                                   case socket:recvmsg(Sock) of
<a name="20877"/>20877:                                       {ok, #{addr := Source,
<a name="20878"/>20878:                                              ctrl := CMsgs,
<a name="20879"/>20879:                                              iov  := [Data]}} -&gt;
<a name="20880"/>20880:                                           {ok, {Source, CMsgs, Data}};
<a name="20881"/>20881:                                       {error, _} = ERROR -&gt;
<a name="20882"/>20882:                                           ERROR
<a name="20883"/>20883:                                   end
<a name="20884"/>20884:                           end,
<a name="20885"/>20885:                    InitState = #{domain =&gt; inet,
<a name="20886"/>20886:                                  proto  =&gt; udp,
<a name="20887"/>20887:                                  send   =&gt; Send,
<a name="20888"/>20888:                                  recv   =&gt; Recv,
<a name="20889"/>20889:                                  set    =&gt; Set,
<a name="20890"/>20890:                                  get    =&gt; Get},
<a name="20891"/>20891:                    ok = api_opt_ip_recvopts_udp(InitState)
<a name="20892"/>20892:            end).
<a name="20893"/>20893: 
<a name="20894"/>20894: 
<a name="20895"/>20895: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="20896"/>20896: 
<a name="api_opt_ip_recvopts_udp-1"/><a name="20897"/>20897: <b>api_opt_ip_recvopts_udp</b>(InitState) -&gt;
<a name="20898"/>20898:     Seq = 
<a name="20899"/>20899:         [
<a name="20900"/>20900:          %% Start by figure out which of the ip:recvtos and/or socket:timestamp
<a name="20901"/>20901:          %% options we can use.
<a name="20902"/>20902:          #{desc =&gt; &quot;test for ip:recvtos&quot;,
<a name="20903"/>20903:            cmd  =&gt; fun(State) -&gt;
<a name="20904"/>20904:                            ?SEV_IPRINT(&quot;test for ip:recvtos&quot;),
<a name="20905"/>20905:                            case socket:is_supported(options, ip, recvtos) of
<a name="20906"/>20906:                                true -&gt;
<a name="20907"/>20907:                                    ?SEV_IPRINT(&quot;use ip:recvtos&quot;),
<a name="20908"/>20908:                                    {ok, State#{recvtos =&gt; true}};
<a name="20909"/>20909:                                false -&gt; 
<a name="20910"/>20910:                                    ?SEV_IPRINT(&quot;do *not* use ip:recvtos&quot;),
<a name="20911"/>20911:                                    {ok, State#{recvtos =&gt; false}}
<a name="20912"/>20912:                            end
<a name="20913"/>20913:                    end},
<a name="20914"/>20914:          #{desc =&gt; &quot;test for socket:timestamp&quot;,
<a name="20915"/>20915:            cmd  =&gt; fun(State) -&gt;
<a name="20916"/>20916:                            ?SEV_IPRINT(&quot;test for socket:timestamp&quot;),
<a name="20917"/>20917:                            case socket:is_supported(options, socket, timestamp) of
<a name="20918"/>20918:                                true -&gt;
<a name="20919"/>20919:                                    ?SEV_IPRINT(&quot;use socket:timestamp&quot;),
<a name="20920"/>20920:                                    {ok, State#{timestamp =&gt; true}};
<a name="20921"/>20921:                                false -&gt; 
<a name="20922"/>20922:                                    ?SEV_IPRINT(&quot;do *not* use socket:timestamp&quot;),
<a name="20923"/>20923:                                    {ok, State#{timestamp =&gt; false}}
<a name="20924"/>20924:                            end
<a name="20925"/>20925:                    end},
<a name="20926"/>20926: 
<a name="20927"/>20927:          #{desc =&gt; &quot;local address&quot;,
<a name="20928"/>20928:            cmd  =&gt; fun(#{domain := local = Domain} = State) -&gt;
<a name="20929"/>20929:                            LSASrc = which_local_socket_addr(Domain),
<a name="20930"/>20930:                            LSADst = which_local_socket_addr(Domain),
<a name="20931"/>20931:                            {ok, State#{lsa_src =&gt; LSASrc,
<a name="20932"/>20932:                                        lsa_dst =&gt; LSADst}};
<a name="20933"/>20933:                       (#{domain := Domain} = State) -&gt;
<a name="20934"/>20934:                            LSA = which_local_socket_addr(Domain),
<a name="20935"/>20935:                            {ok, State#{lsa_src =&gt; LSA,
<a name="20936"/>20936:                                        lsa_dst =&gt; LSA}}
<a name="20937"/>20937:                    end},
<a name="20938"/>20938: 
<a name="20939"/>20939:          #{desc =&gt; &quot;open src socket&quot;,
<a name="20940"/>20940:            cmd  =&gt; fun(#{domain := Domain,
<a name="20941"/>20941:                          proto  := Proto} = State) -&gt;
<a name="20942"/>20942:                            Sock = sock_open(Domain, dgram, Proto),
<a name="20943"/>20943:                            {ok, State#{sock_src =&gt; Sock}}
<a name="20944"/>20944:                    end},
<a name="20945"/>20945:          #{desc =&gt; &quot;bind src&quot;,
<a name="20946"/>20946:            cmd  =&gt; fun(#{sock_src := Sock, lsa_src := LSA}) -&gt;
<a name="20947"/>20947:                            case sock_bind(Sock, LSA) of
<a name="20948"/>20948:                                ok -&gt;
<a name="20949"/>20949:                                    ?SEV_IPRINT(&quot;src bound&quot;),
<a name="20950"/>20950:                                    ok;
<a name="20951"/>20951:                                {error, Reason} = ERROR -&gt;
<a name="20952"/>20952:                                    ?SEV_EPRINT(&quot;src bind failed: ~p&quot;, [Reason]),
<a name="20953"/>20953:                                    ERROR
<a name="20954"/>20954:                            end
<a name="20955"/>20955:                    end},
<a name="20956"/>20956:          #{desc =&gt; &quot;sockname src socket&quot;,
<a name="20957"/>20957:            cmd  =&gt; fun(#{sock_src := Sock} = State) -&gt;
<a name="20958"/>20958:                            SASrc = sock_sockname(Sock),
<a name="20959"/>20959:                            ?SEV_IPRINT(&quot;src sockaddr: &quot;
<a name="20960"/>20960:                                        &quot;~n   ~p&quot;, [SASrc]),
<a name="20961"/>20961:                            {ok, State#{sa_src =&gt; SASrc}}
<a name="20962"/>20962:                    end},
<a name="20963"/>20963: 
<a name="20964"/>20964:          #{desc =&gt; &quot;open dst socket&quot;,
<a name="20965"/>20965:            cmd  =&gt; fun(#{domain := Domain,
<a name="20966"/>20966:                          proto  := Proto} = State) -&gt;
<a name="20967"/>20967:                            Sock = sock_open(Domain, dgram, Proto),
<a name="20968"/>20968:                            {ok, State#{sock_dst =&gt; Sock}}
<a name="20969"/>20969:                    end},
<a name="20970"/>20970:          #{desc =&gt; &quot;bind dst&quot;,
<a name="20971"/>20971:            cmd  =&gt; fun(#{sock_dst := Sock, lsa_dst := LSA}) -&gt;
<a name="20972"/>20972:                            case sock_bind(Sock, LSA) of
<a name="20973"/>20973:                                ok -&gt;
<a name="20974"/>20974:                                    ?SEV_IPRINT(&quot;src bound&quot;),
<a name="20975"/>20975:                                    ok;
<a name="20976"/>20976:                                {error, Reason} = ERROR -&gt;
<a name="20977"/>20977:                                    ?SEV_EPRINT(&quot;src bind failed: ~p&quot;, [Reason]),
<a name="20978"/>20978:                                    ERROR
<a name="20979"/>20979:                            end
<a name="20980"/>20980:                    end},
<a name="20981"/>20981:          #{desc =&gt; &quot;sockname dst socket&quot;,
<a name="20982"/>20982:            cmd  =&gt; fun(#{sock_dst := Sock} = State) -&gt;
<a name="20983"/>20983:                            SADst = sock_sockname(Sock),
<a name="20984"/>20984:                            ?SEV_IPRINT(&quot;dst sockaddr: &quot;
<a name="20985"/>20985:                                        &quot;~n   ~p&quot;, [SADst]),
<a name="20986"/>20986:                            {ok, State#{sa_dst =&gt; SADst}}
<a name="20987"/>20987:                    end},
<a name="20988"/>20988:          #{desc =&gt; &quot;default recvopts for dst socket&quot;,
<a name="20989"/>20989:            cmd  =&gt; fun(#{sock_dst := Sock, get := Get} = _State) -&gt;
<a name="20990"/>20990:                            case Get(Sock) of
<a name="20991"/>20991:                                {ok, false = Value} -&gt;
<a name="20992"/>20992:                                    ?SEV_IPRINT(&quot;dst recvopts: ~p&quot;, [Value]),
<a name="20993"/>20993:                                    ok;
<a name="20994"/>20994:                                {ok, Unexpected} -&gt;
<a name="20995"/>20995:                                    ?SEV_EPRINT(&quot;Unexpected src recvtos: ~p&quot;,
<a name="20996"/>20996:                                                [Unexpected]),
<a name="20997"/>20997:                                    {error, {unexpected, Unexpected}};
<a name="20998"/>20998:                                {error, Reason} = ERROR -&gt;
<a name="20999"/>20999:                                    ?SEV_EPRINT(&quot;Failed getting (default) timestamp:&quot;
<a name="21000"/>21000:                                                &quot;   ~p&quot;, [Reason]),
<a name="21001"/>21001:                                    ERROR
<a name="21002"/>21002:                            end
<a name="21003"/>21003:                    end},
<a name="21004"/>21004: 
<a name="21005"/>21005:          #{desc =&gt; &quot;send req (to dst) (wo (explicit) options)&quot;,
<a name="21006"/>21006:            cmd  =&gt; fun(#{sock_src := Sock, sa_dst := Dst, send := Send}) -&gt;
<a name="21007"/>21007:                            Send(Sock, ?BASIC_REQ, Dst, default)
<a name="21008"/>21008:                    end},
<a name="21009"/>21009:          #{desc =&gt; &quot;recv req (from src)&quot;,
<a name="21010"/>21010:            cmd  =&gt; fun(#{sock_dst := Sock, sa_src := Src, recv := Recv}) -&gt;
<a name="21011"/>21011:                            case Recv(Sock) of
<a name="21012"/>21012:                                {ok, {Src, [], ?BASIC_REQ}} -&gt;
<a name="21013"/>21013:                                    ok;
<a name="21014"/>21014:                                {ok, {BadSrc, BadCHdrs, BadReq} = UnexpData} -&gt;
<a name="21015"/>21015:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="21016"/>21016:                                                &quot;~n   Expect Source: ~p&quot;
<a name="21017"/>21017:                                                &quot;~n   Recv Source:   ~p&quot;
<a name="21018"/>21018:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="21019"/>21019:                                                &quot;~n   Recv CHdrs:    ~p&quot;
<a name="21020"/>21020:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="21021"/>21021:                                                &quot;~n   Recv Msg:      ~p&quot;,
<a name="21022"/>21022:                                                [Src, BadSrc,
<a name="21023"/>21023:                                                 [], BadCHdrs,
<a name="21024"/>21024:                                                 ?BASIC_REQ, BadReq]),
<a name="21025"/>21025:                                    {error, {unexpected_data, UnexpData}};
<a name="21026"/>21026:                                {ok, UnexpData} -&gt;
<a name="21027"/>21027:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="21028"/>21028:                                                &quot;~n   Expect Source: ~p&quot;
<a name="21029"/>21029:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="21030"/>21030:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="21031"/>21031:                                                &quot;~n   Unexp Data:    ~p&quot;,
<a name="21032"/>21032:                                                [Src, [], ?BASIC_REQ, UnexpData]),
<a name="21033"/>21033:                                    {error, {unexpected_data, UnexpData}};
<a name="21034"/>21034:                                {error, _} = ERROR -&gt;
<a name="21035"/>21035:                                    %% At the moment there is no way to get
<a name="21036"/>21036:                                    %% status or state for the socket...
<a name="21037"/>21037:                                    ERROR
<a name="21038"/>21038:                            end
<a name="21039"/>21039:                    end},
<a name="21040"/>21040: 
<a name="21041"/>21041: 
<a name="21042"/>21042:          %% *** We do not *yet* support sending options ***
<a name="21043"/>21043: 
<a name="21044"/>21044:          %% #{desc =&gt; &quot;send req (to dst) (w explicit options)&quot;,
<a name="21045"/>21045:          %%   cmd  =&gt; fun(#{sock_src := Sock, sa_dst := Dst, send := Send}) -&gt;
<a name="21046"/>21046:          %%                   Send(Sock, ?BASIC_REQ, Dst, Opts)
<a name="21047"/>21047:          %%           end},
<a name="21048"/>21048:          %% #{desc =&gt; &quot;recv req (from src) - wo options&quot;,
<a name="21049"/>21049:          %%   cmd  =&gt; fun(#{sock_dst := Sock, sa_src := Src, recv := Recv}) -&gt;
<a name="21050"/>21050:          %%                   case Recv(Sock) of
<a name="21051"/>21051:          %%                       {ok, {Src, [], ?BASIC_REQ}} -&gt;
<a name="21052"/>21052:          %%                           ok;
<a name="21053"/>21053:          %%                       {ok, {BadSrc, BadCHdrs, BadReq} = UnexpData} -&gt;
<a name="21054"/>21054:          %%                           ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="21055"/>21055:          %%                                       &quot;~n   Expect Source: ~p&quot;
<a name="21056"/>21056:          %%                                       &quot;~n   Recv Source:   ~p&quot;
<a name="21057"/>21057:          %%                                       &quot;~n   Expect CHdrs:  ~p&quot;
<a name="21058"/>21058:          %%                                       &quot;~n   Recv CHdrs:    ~p&quot;
<a name="21059"/>21059:          %%                                       &quot;~n   Expect Msg:    ~p&quot;
<a name="21060"/>21060:          %%                                       &quot;~n   Recv Msg:      ~p&quot;,
<a name="21061"/>21061:          %%                                       [Src, BadSrc,
<a name="21062"/>21062:          %%                                        [], BadCHdrs,
<a name="21063"/>21063:          %%                                        ?BASIC_REQ, BadReq]),
<a name="21064"/>21064:          %%                           {error, {unexpected_data, UnexpData}};
<a name="21065"/>21065:          %%                       {ok, UnexpData} -&gt;
<a name="21066"/>21066:          %%                           ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="21067"/>21067:          %%                                       &quot;~n   Expect Source: ~p&quot;
<a name="21068"/>21068:          %%                                       &quot;~n   Expect CHdrs:  ~p&quot;
<a name="21069"/>21069:          %%                                       &quot;~n   Expect Msg:    ~p&quot;
<a name="21070"/>21070:          %%                                       &quot;~n   Unexp Data:    ~p&quot;,
<a name="21071"/>21071:          %%                                       [Src, [], ?BASIC_REQ, UnexpData]),
<a name="21072"/>21072:          %%                           {error, {unexpected_data, UnexpData}};
<a name="21073"/>21073:          %%                       {error, _} = ERROR -&gt;
<a name="21074"/>21074:          %%                           %% At the moment there is no way to get
<a name="21075"/>21075:          %%                           %% status or state for the socket...
<a name="21076"/>21076:          %%                           ERROR
<a name="21077"/>21077:          %%                   end
<a name="21078"/>21078:          %%           end},
<a name="21079"/>21079: 
<a name="21080"/>21080:          #{desc =&gt; &quot;enable recvopts on dst socket&quot;,
<a name="21081"/>21081:            cmd  =&gt; fun(#{sock_dst := Sock, set := Set} = _State) -&gt;
<a name="21082"/>21082:                            case Set(Sock, true) of
<a name="21083"/>21083:                                ok -&gt;
<a name="21084"/>21084:                                    ?SEV_IPRINT(&quot;dst recvopts enabled&quot;),
<a name="21085"/>21085:                                    ok;
<a name="21086"/>21086:                                {error, Reason} = ERROR -&gt;
<a name="21087"/>21087:                                    ?SEV_EPRINT(&quot;Failed setting recvopts:&quot;
<a name="21088"/>21088:                                                &quot;   ~p&quot;, [Reason]),
<a name="21089"/>21089:                                    ERROR
<a name="21090"/>21090:                            end
<a name="21091"/>21091:                    end},
<a name="21092"/>21092: 
<a name="21093"/>21093:          %% This specific option, recvtos, is tested in another test case
<a name="21094"/>21094:          %% Note that this may not actually be supported here!!
<a name="21095"/>21095:          #{desc =&gt; &quot;maybe enable ip:recvtos on dst socket&quot;,
<a name="21096"/>21096:            cmd  =&gt; fun(#{recvtos := true, sock_dst := Sock} = _State) -&gt;
<a name="21097"/>21097:                            ?SEV_IPRINT(&quot;enable ip:recvtos&quot;),
<a name="21098"/>21098:                            ok = socket:setopt(Sock, ip, recvtos, true);
<a name="21099"/>21099:                       (#{recvtos := false} = _State) -&gt;
<a name="21100"/>21100:                            ok
<a name="21101"/>21101:                    end},
<a name="21102"/>21102:          %% This specific option, timestamp, is tested in another test case
<a name="21103"/>21103:          #{desc =&gt; &quot;maybe enable socket:timestamp on dst socket&quot;,
<a name="21104"/>21104:            cmd  =&gt; fun(#{timestamp := true, sock_dst := Sock} = _State) -&gt;
<a name="21105"/>21105:                            ?SEV_IPRINT(&quot;enable socket:timestamp&quot;),
<a name="21106"/>21106:                            ok = socket:setopt(Sock, socket, timestamp, true);
<a name="21107"/>21107:                       (#{timestamp := false} = _State) -&gt;
<a name="21108"/>21108:                            ok
<a name="21109"/>21109:                    end},
<a name="21110"/>21110: 
<a name="21111"/>21111:          #{desc =&gt; &quot;send req (to dst) (wo explicit options)&quot;,
<a name="21112"/>21112:            cmd  =&gt; fun(#{sock_src := Sock, sa_dst := Dst, send := Send}) -&gt;
<a name="21113"/>21113:                            Send(Sock, ?BASIC_REQ, Dst, default)
<a name="21114"/>21114:                    end},
<a name="21115"/>21115:          #{desc =&gt; &quot;recv req (from src) - w default options&quot;,
<a name="21116"/>21116:            cmd  =&gt; fun(#{recvtos := true, timestamp := true,
<a name="21117"/>21117:                          sock_dst := Sock,
<a name="21118"/>21118:                          sa_src   := Src,
<a name="21119"/>21119:                          recv     := Recv}) -&gt;
<a name="21120"/>21120:                            case Recv(Sock) of
<a name="21121"/>21121:                                {ok, {Src, Opts, ?BASIC_REQ}} 
<a name="21122"/>21122:                                  when (length(Opts) =:= 2) -&gt;
<a name="21123"/>21123:                                    ?SEV_IPRINT(&quot;Got (default) Options: &quot;
<a name="21124"/>21124:                                                &quot;~n   Opts:  ~p&quot;, [Opts]),
<a name="21125"/>21125:                                    ok;
<a name="21126"/>21126:                                {ok, {BadSrc, BadCHdrs, BadReq} = UnexpData} -&gt;
<a name="21127"/>21127:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="21128"/>21128:                                                &quot;~n   Expect Source: ~p&quot;
<a name="21129"/>21129:                                                &quot;~n   Recv Source:   ~p&quot;
<a name="21130"/>21130:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="21131"/>21131:                                                &quot;~n   Recv CHdrs:    ~p&quot;
<a name="21132"/>21132:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="21133"/>21133:                                                &quot;~n   Recv Msg:      ~p&quot;,
<a name="21134"/>21134:                                                [Src, BadSrc,
<a name="21135"/>21135:                                                 [], BadCHdrs,
<a name="21136"/>21136:                                                 ?BASIC_REQ, BadReq]),
<a name="21137"/>21137:                                    {error, {unexpected_data, UnexpData}};
<a name="21138"/>21138:                                {ok, UnexpData} -&gt;
<a name="21139"/>21139:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="21140"/>21140:                                                &quot;~n   Expect Source: ~p&quot;
<a name="21141"/>21141:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="21142"/>21142:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="21143"/>21143:                                                &quot;~n   Unexp Data:    ~p&quot;,
<a name="21144"/>21144:                                                [Src, [], ?BASIC_REQ, UnexpData]),
<a name="21145"/>21145:                                    {error, {unexpected_data, UnexpData}};
<a name="21146"/>21146:                                {error, _} = ERROR -&gt;
<a name="21147"/>21147:                                    %% At the moment there is no way to get
<a name="21148"/>21148:                                    %% status or state for the socket...
<a name="21149"/>21149:                                    ERROR
<a name="21150"/>21150:                            end;
<a name="21151"/>21151:                       (#{timestamp := true,
<a name="21152"/>21152:                          sock_dst := Sock,
<a name="21153"/>21153:                          sa_src   := Src,
<a name="21154"/>21154:                          recv     := Recv}) -&gt;
<a name="21155"/>21155:                            case Recv(Sock) of
<a name="21156"/>21156:                                {ok, {Src, Opts, ?BASIC_REQ}} 
<a name="21157"/>21157:                                  when (length(Opts) =:= 1) -&gt;
<a name="21158"/>21158:                                    ?SEV_IPRINT(&quot;Got (default) Options: &quot;
<a name="21159"/>21159:                                                &quot;~n   Opts:  ~p&quot;, [Opts]),
<a name="21160"/>21160:                                    ok;
<a name="21161"/>21161:                                {ok, {BadSrc, BadCHdrs, BadReq} = UnexpData} -&gt;
<a name="21162"/>21162:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="21163"/>21163:                                                &quot;~n   Expect Source: ~p&quot;
<a name="21164"/>21164:                                                &quot;~n   Recv Source:   ~p&quot;
<a name="21165"/>21165:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="21166"/>21166:                                                &quot;~n   Recv CHdrs:    ~p&quot;
<a name="21167"/>21167:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="21168"/>21168:                                                &quot;~n   Recv Msg:      ~p&quot;,
<a name="21169"/>21169:                                                [Src, BadSrc,
<a name="21170"/>21170:                                                 [], BadCHdrs,
<a name="21171"/>21171:                                                 ?BASIC_REQ, BadReq]),
<a name="21172"/>21172:                                    {error, {unexpected_data, UnexpData}};
<a name="21173"/>21173:                                {ok, UnexpData} -&gt;
<a name="21174"/>21174:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="21175"/>21175:                                                &quot;~n   Expect Source: ~p&quot;
<a name="21176"/>21176:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="21177"/>21177:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="21178"/>21178:                                                &quot;~n   Unexp Data:    ~p&quot;,
<a name="21179"/>21179:                                                [Src, [], ?BASIC_REQ, UnexpData]),
<a name="21180"/>21180:                                    {error, {unexpected_data, UnexpData}};
<a name="21181"/>21181:                                {error, _} = ERROR -&gt;
<a name="21182"/>21182:                                    %% At the moment there is no way to get
<a name="21183"/>21183:                                    %% status or state for the socket...
<a name="21184"/>21184:                                    ERROR
<a name="21185"/>21185:                            end;
<a name="21186"/>21186:                       (#{recvtos := true,
<a name="21187"/>21187:                          sock_dst := Sock,
<a name="21188"/>21188:                          sa_src   := Src,
<a name="21189"/>21189:                          recv     := Recv}) -&gt;
<a name="21190"/>21190:                            case Recv(Sock) of
<a name="21191"/>21191:                                {ok, {Src, Opts, ?BASIC_REQ}} 
<a name="21192"/>21192:                                  when (length(Opts) =:= 1) -&gt;
<a name="21193"/>21193:                                    ?SEV_IPRINT(&quot;Got (default) Options: &quot;
<a name="21194"/>21194:                                                &quot;~n   Opts:  ~p&quot;, [Opts]),
<a name="21195"/>21195:                                    ok;
<a name="21196"/>21196:                                {ok, {BadSrc, BadCHdrs, BadReq} = UnexpData} -&gt;
<a name="21197"/>21197:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="21198"/>21198:                                                &quot;~n   Expect Source: ~p&quot;
<a name="21199"/>21199:                                                &quot;~n   Recv Source:   ~p&quot;
<a name="21200"/>21200:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="21201"/>21201:                                                &quot;~n   Recv CHdrs:    ~p&quot;
<a name="21202"/>21202:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="21203"/>21203:                                                &quot;~n   Recv Msg:      ~p&quot;,
<a name="21204"/>21204:                                                [Src, BadSrc,
<a name="21205"/>21205:                                                 [], BadCHdrs,
<a name="21206"/>21206:                                                 ?BASIC_REQ, BadReq]),
<a name="21207"/>21207:                                    {error, {unexpected_data, UnexpData}};
<a name="21208"/>21208:                                {ok, UnexpData} -&gt;
<a name="21209"/>21209:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="21210"/>21210:                                                &quot;~n   Expect Source: ~p&quot;
<a name="21211"/>21211:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="21212"/>21212:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="21213"/>21213:                                                &quot;~n   Unexp Data:    ~p&quot;,
<a name="21214"/>21214:                                                [Src, [], ?BASIC_REQ, UnexpData]),
<a name="21215"/>21215:                                    {error, {unexpected_data, UnexpData}};
<a name="21216"/>21216:                                {error, _} = ERROR -&gt;
<a name="21217"/>21217:                                    %% At the moment there is no way to get
<a name="21218"/>21218:                                    %% status or state for the socket...
<a name="21219"/>21219:                                    ERROR
<a name="21220"/>21220:                            end
<a name="21221"/>21221:                    end},
<a name="21222"/>21222: 
<a name="21223"/>21223: 
<a name="21224"/>21224:          %% *** We do not *yet* support sending options ***
<a name="21225"/>21225: 
<a name="21226"/>21226:          %% #{desc =&gt; &quot;send req (to dst) (w explicit options)&quot;,
<a name="21227"/>21227:          %%   cmd  =&gt; fun(#{sock_src := Sock, sa_dst := Dst, send := Send}) -&gt;
<a name="21228"/>21228:          %%                   Send(Sock, ?BASIC_REQ, Dst, Opts)
<a name="21229"/>21229:          %%           end},
<a name="21230"/>21230:          %% #{desc =&gt; &quot;recv req (from src) - w options&quot;,
<a name="21231"/>21231:          %%   cmd  =&gt; fun(#{sock_dst := Sock, sa_src := Src, recv := Recv}) -&gt;
<a name="21232"/>21232:          %%                   case Recv(Sock) of
<a name="21233"/>21233:          %%                       {ok, {Src, Opts, ?BASIC_REQ}} -&gt;
<a name="21234"/>21234:          %%                           ?SEV_IPRINT(&quot;Got Options: &quot;
<a name="21235"/>21235:          %%                                       &quot;~n   ~p&quot;, [Opts]),
<a name="21236"/>21236:          %%                           ok;
<a name="21237"/>21237:          %%                       {ok, {BadSrc, BadCHdrs, BadReq} = UnexpData} -&gt;
<a name="21238"/>21238:          %%                           ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="21239"/>21239:          %%                                       &quot;~n   Expect Source: ~p&quot;
<a name="21240"/>21240:          %%                                       &quot;~n   Recv Source:   ~p&quot;
<a name="21241"/>21241:          %%                                       &quot;~n   Expect CHdrs:  ~p&quot;
<a name="21242"/>21242:          %%                                       &quot;~n   Recv CHdrs:    ~p&quot;
<a name="21243"/>21243:          %%                                       &quot;~n   Expect Msg:    ~p&quot;
<a name="21244"/>21244:          %%                                       &quot;~n   Recv Msg:      ~p&quot;,
<a name="21245"/>21245:          %%                                       [Src, BadSrc,
<a name="21246"/>21246:          %%                                        [], BadCHdrs,
<a name="21247"/>21247:          %%                                        ?BASIC_REQ, BadReq]),
<a name="21248"/>21248:          %%                           {error, {unexpected_data, UnexpData}};
<a name="21249"/>21249:          %%                       {ok, UnexpData} -&gt;
<a name="21250"/>21250:          %%                           ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="21251"/>21251:          %%                                       &quot;~n   Expect Source: ~p&quot;
<a name="21252"/>21252:          %%                                       &quot;~n   Expect CHdrs:  ~p&quot;
<a name="21253"/>21253:          %%                                       &quot;~n   Expect Msg:    ~p&quot;
<a name="21254"/>21254:          %%                                       &quot;~n   Unexp Data:    ~p&quot;,
<a name="21255"/>21255:          %%                                       [Src, [], ?BASIC_REQ, UnexpData]),
<a name="21256"/>21256:          %%                           {error, {unexpected_data, UnexpData}};
<a name="21257"/>21257:          %%                       {error, _} = ERROR -&gt;
<a name="21258"/>21258:          %%                           %% At the moment there is no way to get
<a name="21259"/>21259:          %%                           %% status or state for the socket...
<a name="21260"/>21260:          %%                           ERROR
<a name="21261"/>21261:          %%                   end
<a name="21262"/>21262:          %%           end},
<a name="21263"/>21263: 
<a name="21264"/>21264:          #{desc =&gt; &quot;close src socket&quot;,
<a name="21265"/>21265:            cmd  =&gt; fun(#{sock_src := Sock} = State) -&gt;
<a name="21266"/>21266:                            ok = socket:close(Sock),
<a name="21267"/>21267:                            {ok, maps:remove(sock_src, State)}
<a name="21268"/>21268:                    end},
<a name="21269"/>21269:          #{desc =&gt; &quot;close dst socket&quot;,
<a name="21270"/>21270:            cmd  =&gt; fun(#{sock_dst := Sock} = State) -&gt;
<a name="21271"/>21271:                            ok = socket:close(Sock),
<a name="21272"/>21272:                            {ok, maps:remove(sock_dst, State)}
<a name="21273"/>21273:                    end},
<a name="21274"/>21274: 
<a name="21275"/>21275:          %% *** We are done ***
<a name="21276"/>21276:          ?SEV_FINISH_NORMAL
<a name="21277"/>21277:         ],
<a name="21278"/>21278:     Evaluator = ?SEV_START(&quot;tester&quot;, Seq, InitState),
<a name="api_opt_ip_recvopts_udp-last_expr"/><a name="21279"/>21279: <b>    ok = ?SEV_AWAIT_FINISH</b>([Evaluator]).
<a name="21280"/>21280: 
<a name="21281"/>21281: 
<a name="21282"/>21282: 
<a name="21283"/>21283: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="21284"/>21284: 
<a name="21285"/>21285: <i>%% Tests that the origdstaddr control message header is received when</i>
<a name="21286"/>21286: <i>%% setting the socket 'ip' option recvorigdstaddr is set to true when</i>
<a name="21287"/>21287: <i>%% using sendmsg/recvmsg on an IPv4 UDP (dgram) socket.</i>
<a name="21288"/>21288: <i>%% So, this is done on the receiving side: </i>
<a name="21289"/>21289: <i>%%</i>
<a name="21290"/>21290: <i>%%               socket:setopt(Sock, ip, recvorigdstaddr, boolean()).</i>
<a name="21291"/>21291: <i>%%</i>
<a name="21292"/>21292: <i>%% For all subsequent *received* messages, the origdstaddr control</i>
<a name="21293"/>21293: <i>%% message header will be with the message.</i>
<a name="21294"/>21294: <i>%%</i>
<a name="21295"/>21295: <i>%%</i>
<a name="21296"/>21296: 
<a name="api_opt_ip_recvorigdstaddr_udp4-1"/><a name="21297"/>21297: <b>api_opt_ip_recvorigdstaddr_udp4</b>(_Config) when is_list(_Config) -&gt;
<a name="21298"/>21298:     ?TT(?SECS(5)),
<a name="api_opt_ip_recvorigdstaddr_udp4-last_expr"/><a name="21299"/>21299: <b>    tc_try</b>(api_opt_ip_recvorigdstaddr_udp4,
<a name="21300"/>21300:            fun() -&gt; has_support_ipv4(), has_support_ip_recvorigdstaddr() end,
<a name="21301"/>21301:            fun() -&gt;
<a name="21302"/>21302:                    Set  = fun(Sock, Value) -&gt;
<a name="21303"/>21303:                                   socket:setopt(Sock, ip, recvorigdstaddr, Value)
<a name="21304"/>21304:                           end,
<a name="21305"/>21305:                    Get  = fun(Sock) -&gt;
<a name="21306"/>21306:                                   socket:getopt(Sock, ip, recvorigdstaddr)
<a name="21307"/>21307:                           end,
<a name="21308"/>21308:                    Send = fun(Sock, Data, Dest) -&gt;
<a name="21309"/>21309:                                   Msg = #{addr =&gt; Dest,
<a name="21310"/>21310:                                              iov  =&gt; [Data]},
<a name="21311"/>21311:                                   socket:sendmsg(Sock, Msg)
<a name="21312"/>21312:                           end,
<a name="21313"/>21313:                    Recv = fun(Sock) -&gt;
<a name="21314"/>21314:                                   case socket:recvmsg(Sock) of
<a name="21315"/>21315:                                       {ok, #{addr := Source,
<a name="21316"/>21316:                                              ctrl := CMsgs,
<a name="21317"/>21317:                                              iov  := [Data]}} -&gt;
<a name="21318"/>21318:                                           {ok, {Source, CMsgs, Data}};
<a name="21319"/>21319:                                       {error, _} = ERROR -&gt;
<a name="21320"/>21320:                                           ERROR
<a name="21321"/>21321:                                   end
<a name="21322"/>21322:                           end,
<a name="21323"/>21323:                    InitState = #{domain =&gt; inet,
<a name="21324"/>21324:                                  proto  =&gt; udp,
<a name="21325"/>21325:                                  send   =&gt; Send,
<a name="21326"/>21326:                                  recv   =&gt; Recv,
<a name="21327"/>21327:                                  set    =&gt; Set,
<a name="21328"/>21328:                                  get    =&gt; Get},
<a name="21329"/>21329:                    ok = api_opt_ip_recvorigdstaddr_udp(InitState)
<a name="21330"/>21330:            end).
<a name="21331"/>21331: 
<a name="21332"/>21332: 
<a name="21333"/>21333: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="21334"/>21334: 
<a name="api_opt_ip_recvorigdstaddr_udp-1"/><a name="21335"/>21335: <b>api_opt_ip_recvorigdstaddr_udp</b>(InitState) -&gt;
<a name="21336"/>21336:     Seq = 
<a name="21337"/>21337:         [
<a name="21338"/>21338:          #{desc =&gt; &quot;local address&quot;,
<a name="21339"/>21339:            cmd  =&gt; fun(#{domain := local = Domain} = State) -&gt;
<a name="21340"/>21340:                            LSASrc = which_local_socket_addr(Domain),
<a name="21341"/>21341:                            LSADst = which_local_socket_addr(Domain),
<a name="21342"/>21342:                            {ok, State#{lsa_src =&gt; LSASrc,
<a name="21343"/>21343:                                        lsa_dst =&gt; LSADst}};
<a name="21344"/>21344:                       (#{domain := Domain} = State) -&gt;
<a name="21345"/>21345:                            LSA = which_local_socket_addr(Domain),
<a name="21346"/>21346:                            {ok, State#{lsa_src =&gt; LSA,
<a name="21347"/>21347:                                        lsa_dst =&gt; LSA}}
<a name="21348"/>21348:                    end},
<a name="21349"/>21349: 
<a name="21350"/>21350:          #{desc =&gt; &quot;open src socket&quot;,
<a name="21351"/>21351:            cmd  =&gt; fun(#{domain := Domain,
<a name="21352"/>21352:                          proto  := Proto} = State) -&gt;
<a name="21353"/>21353:                            Sock = sock_open(Domain, dgram, Proto),
<a name="21354"/>21354:                            {ok, State#{sock_src =&gt; Sock}}
<a name="21355"/>21355:                    end},
<a name="21356"/>21356:          #{desc =&gt; &quot;bind src&quot;,
<a name="21357"/>21357:            cmd  =&gt; fun(#{sock_src := Sock, lsa_src := LSA}) -&gt;
<a name="21358"/>21358:                            case sock_bind(Sock, LSA) of
<a name="21359"/>21359:                                ok -&gt;
<a name="21360"/>21360:                                    ?SEV_IPRINT(&quot;src bound&quot;),
<a name="21361"/>21361:                                    ok;
<a name="21362"/>21362:                                {error, Reason} = ERROR -&gt;
<a name="21363"/>21363:                                    ?SEV_EPRINT(&quot;src bind failed: ~p&quot;, [Reason]),
<a name="21364"/>21364:                                    ERROR
<a name="21365"/>21365:                            end
<a name="21366"/>21366:                    end},
<a name="21367"/>21367:          #{desc =&gt; &quot;sockname src socket&quot;,
<a name="21368"/>21368:            cmd  =&gt; fun(#{sock_src := Sock} = State) -&gt;
<a name="21369"/>21369:                            SASrc = sock_sockname(Sock),
<a name="21370"/>21370:                            ?SEV_IPRINT(&quot;src sockaddr: &quot;
<a name="21371"/>21371:                                        &quot;~n   ~p&quot;, [SASrc]),
<a name="21372"/>21372:                            {ok, State#{sa_src =&gt; SASrc}}
<a name="21373"/>21373:                    end},
<a name="21374"/>21374: 
<a name="21375"/>21375:          #{desc =&gt; &quot;open dst socket&quot;,
<a name="21376"/>21376:            cmd  =&gt; fun(#{domain := Domain,
<a name="21377"/>21377:                          proto  := Proto} = State) -&gt;
<a name="21378"/>21378:                            Sock = sock_open(Domain, dgram, Proto),
<a name="21379"/>21379:                            {ok, State#{sock_dst =&gt; Sock}}
<a name="21380"/>21380:                    end},
<a name="21381"/>21381:          #{desc =&gt; &quot;bind dst&quot;,
<a name="21382"/>21382:            cmd  =&gt; fun(#{sock_dst := Sock, lsa_dst := LSA}) -&gt;
<a name="21383"/>21383:                            case sock_bind(Sock, LSA) of
<a name="21384"/>21384:                                ok -&gt;
<a name="21385"/>21385:                                    ?SEV_IPRINT(&quot;src bound&quot;),
<a name="21386"/>21386:                                    ok;
<a name="21387"/>21387:                                {error, Reason} = ERROR -&gt;
<a name="21388"/>21388:                                    ?SEV_EPRINT(&quot;src bind failed: ~p&quot;, [Reason]),
<a name="21389"/>21389:                                    ERROR
<a name="21390"/>21390:                            end
<a name="21391"/>21391:                    end},
<a name="21392"/>21392:          #{desc =&gt; &quot;sockname dst socket&quot;,
<a name="21393"/>21393:            cmd  =&gt; fun(#{sock_dst := Sock} = State) -&gt;
<a name="21394"/>21394:                            SADst = sock_sockname(Sock),
<a name="21395"/>21395:                            ?SEV_IPRINT(&quot;dst sockaddr: &quot;
<a name="21396"/>21396:                                        &quot;~n   ~p&quot;, [SADst]),
<a name="21397"/>21397:                            {ok, State#{sa_dst =&gt; SADst}}
<a name="21398"/>21398:                    end},
<a name="21399"/>21399:          #{desc =&gt; &quot;get default recvorigdstaddr for dst socket&quot;,
<a name="21400"/>21400:            cmd  =&gt; fun(#{sock_dst := Sock, get := Get} = _State) -&gt;
<a name="21401"/>21401:                            case Get(Sock) of
<a name="21402"/>21402:                                {ok, false = Value} -&gt;
<a name="21403"/>21403:                                    ?SEV_IPRINT(&quot;dst recvorigdstaddr: ~p&quot;, [Value]),
<a name="21404"/>21404:                                    ok;
<a name="21405"/>21405:                                {ok, Unexpected} -&gt;
<a name="21406"/>21406:                                    ?SEV_EPRINT(&quot;Unexpected src recvorigdstaddr: ~p&quot;,
<a name="21407"/>21407:                                                [Unexpected]),
<a name="21408"/>21408:                                    {error, {unexpected, Unexpected}};
<a name="21409"/>21409:                                {error, Reason} = ERROR -&gt;
<a name="21410"/>21410:                                    ?SEV_EPRINT(&quot;Failed getting (default) &quot;
<a name="21411"/>21411:                                                &quot;recvorigdstaddr:&quot;
<a name="21412"/>21412:                                                &quot;   ~p&quot;, [Reason]),
<a name="21413"/>21413:                                    ERROR
<a name="21414"/>21414:                            end
<a name="21415"/>21415:                    end},
<a name="21416"/>21416: 
<a name="21417"/>21417:          #{desc =&gt; &quot;send req (to dst) (when recvorigdstaddr disabled)&quot;,
<a name="21418"/>21418:            cmd  =&gt; fun(#{sock_src := Sock, sa_dst := Dst, send := Send}) -&gt;
<a name="21419"/>21419:                            Send(Sock, ?BASIC_REQ, Dst)
<a name="21420"/>21420:                    end},
<a name="21421"/>21421:          #{desc =&gt; &quot;recv req (from src) - wo origdstaddr&quot;,
<a name="21422"/>21422:            cmd  =&gt; fun(#{sock_dst := Sock, sa_src := Src, recv := Recv}) -&gt;
<a name="21423"/>21423:                            case Recv(Sock) of
<a name="21424"/>21424:                                {ok, {Src, [], ?BASIC_REQ}} -&gt;
<a name="21425"/>21425:                                    ok;
<a name="21426"/>21426:                                {ok, {BadSrc, BadCHdrs, BadReq} = UnexpData} -&gt;
<a name="21427"/>21427:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="21428"/>21428:                                                &quot;~n   Expect Source: ~p&quot;
<a name="21429"/>21429:                                                &quot;~n   Recv Source:   ~p&quot;
<a name="21430"/>21430:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="21431"/>21431:                                                &quot;~n   Recv CHdrs:    ~p&quot;
<a name="21432"/>21432:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="21433"/>21433:                                                &quot;~n   Recv Msg:      ~p&quot;,
<a name="21434"/>21434:                                                [Src, BadSrc,
<a name="21435"/>21435:                                                 [], BadCHdrs,
<a name="21436"/>21436:                                                 ?BASIC_REQ, BadReq]),
<a name="21437"/>21437:                                    {error, {unexpected_data, UnexpData}};
<a name="21438"/>21438:                                {ok, UnexpData} -&gt;
<a name="21439"/>21439:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="21440"/>21440:                                                &quot;~n   Expect Source: ~p&quot;
<a name="21441"/>21441:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="21442"/>21442:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="21443"/>21443:                                                &quot;~n   Unexp Data:    ~p&quot;,
<a name="21444"/>21444:                                                [Src, [], ?BASIC_REQ, UnexpData]),
<a name="21445"/>21445:                                    {error, {unexpected_data, UnexpData}};
<a name="21446"/>21446:                                {error, _} = ERROR -&gt;
<a name="21447"/>21447:                                    %% At the moment there is no way to get
<a name="21448"/>21448:                                    %% status or state for the socket...
<a name="21449"/>21449:                                    ERROR
<a name="21450"/>21450:                            end
<a name="21451"/>21451:                    end},
<a name="21452"/>21452: 
<a name="21453"/>21453:          #{desc =&gt; &quot;enable recvorigdstaddr on dst socket&quot;,
<a name="21454"/>21454:            cmd  =&gt; fun(#{sock_dst := Sock, set := Set} = _State) -&gt;
<a name="21455"/>21455:                            case Set(Sock, true) of
<a name="21456"/>21456:                                ok -&gt;
<a name="21457"/>21457:                                    ?SEV_IPRINT(&quot;dst recvorigdstaddr enabled&quot;),
<a name="21458"/>21458:                                    ok;
<a name="21459"/>21459:                                {error, Reason} = ERROR -&gt;
<a name="21460"/>21460:                                    ?SEV_EPRINT(&quot;Failed enable recvorigdstaddr:&quot;
<a name="21461"/>21461:                                                &quot;   ~p&quot;, [Reason]),
<a name="21462"/>21462:                                    ERROR
<a name="21463"/>21463:                            end
<a name="21464"/>21464:                    end},
<a name="21465"/>21465: 
<a name="21466"/>21466:          #{desc =&gt; &quot;send req (to dst) (when recvorigdstaddr enabled)&quot;,
<a name="21467"/>21467:            cmd  =&gt; fun(#{sock_src := Sock, sa_dst := Dst, send := Send}) -&gt;
<a name="21468"/>21468:                            Send(Sock, ?BASIC_REQ, Dst)
<a name="21469"/>21469:                    end},
<a name="21470"/>21470:          #{desc =&gt; &quot;recv req (from src) - w origdstaddr&quot;,
<a name="21471"/>21471:            cmd  =&gt; fun(#{sock_dst := Sock, sa_src := Src, recv := Recv}) -&gt;
<a name="21472"/>21472:                            case Recv(Sock) of
<a name="21473"/>21473:                                {ok, {Src, [#{level := ip,
<a name="21474"/>21474:                                              type  := origdstaddr,
<a name="21475"/>21475:                                              value := Addr}], ?BASIC_REQ}} -&gt;
<a name="21476"/>21476:                                    ?SEV_IPRINT(&quot;got origdstaddr &quot;
<a name="21477"/>21477:                                                &quot;control message header: &quot;
<a name="21478"/>21478:                                                &quot;~n   ~p&quot;, [Addr]),
<a name="21479"/>21479:                                    ok;
<a name="21480"/>21480:                                {ok, {BadSrc, BadCHdrs, BadReq} = UnexpData} -&gt;
<a name="21481"/>21481:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="21482"/>21482:                                                &quot;~n   Expect Source: ~p&quot;
<a name="21483"/>21483:                                                &quot;~n   Recv Source:   ~p&quot;
<a name="21484"/>21484:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="21485"/>21485:                                                &quot;~n   Recv CHdrs:    ~p&quot;
<a name="21486"/>21486:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="21487"/>21487:                                                &quot;~n   Recv Msg:      ~p&quot;,
<a name="21488"/>21488:                                                [Src, BadSrc,
<a name="21489"/>21489:                                                 [#{level =&gt; ip,
<a name="21490"/>21490:                                                    type  =&gt; origdstaddr,
<a name="21491"/>21491:                                                    data  =&gt; &quot;something&quot;}], BadCHdrs,
<a name="21492"/>21492:                                                 ?BASIC_REQ, BadReq]),
<a name="21493"/>21493:                                    {error, {unexpected_data, UnexpData}};
<a name="21494"/>21494:                                {ok, UnexpData} -&gt;
<a name="21495"/>21495:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="21496"/>21496:                                                &quot;~n   Expect Source: ~p&quot;
<a name="21497"/>21497:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="21498"/>21498:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="21499"/>21499:                                                &quot;~n   Unexp Data:    ~p&quot;,
<a name="21500"/>21500:                                                [Src,
<a name="21501"/>21501:                                                 [#{level =&gt; ip,
<a name="21502"/>21502:                                                    type  =&gt; origdstaddr,
<a name="21503"/>21503:                                                    data  =&gt; &quot;something&quot;}],
<a name="21504"/>21504:                                                 ?BASIC_REQ, UnexpData]),
<a name="21505"/>21505:                                    {error, {unexpected_data, UnexpData}};
<a name="21506"/>21506:                                {error, _} = ERROR -&gt;
<a name="21507"/>21507:                                    %% At the moment there is no way to get
<a name="21508"/>21508:                                    %% status or state for the socket...
<a name="21509"/>21509:                                    ERROR
<a name="21510"/>21510:                            end
<a name="21511"/>21511:                    end},
<a name="21512"/>21512: 
<a name="21513"/>21513:          #{desc =&gt; &quot;close src socket&quot;,
<a name="21514"/>21514:            cmd  =&gt; fun(#{sock_src := Sock} = State) -&gt;
<a name="21515"/>21515:                            ok = socket:close(Sock),
<a name="21516"/>21516:                            {ok, maps:remove(sock_src, State)}
<a name="21517"/>21517:                    end},
<a name="21518"/>21518:          #{desc =&gt; &quot;close dst socket&quot;,
<a name="21519"/>21519:            cmd  =&gt; fun(#{sock_dst := Sock} = State) -&gt;
<a name="21520"/>21520:                            ok = socket:close(Sock),
<a name="21521"/>21521:                            {ok, maps:remove(sock_dst, State)}
<a name="21522"/>21522:                    end},
<a name="21523"/>21523: 
<a name="21524"/>21524:          %% *** We are done ***
<a name="21525"/>21525:          ?SEV_FINISH_NORMAL
<a name="21526"/>21526:         ],
<a name="21527"/>21527:     Evaluator = ?SEV_START(&quot;tester&quot;, Seq, InitState),
<a name="api_opt_ip_recvorigdstaddr_udp-last_expr"/><a name="21528"/>21528: <b>    ok = ?SEV_AWAIT_FINISH</b>([Evaluator]).
<a name="21529"/>21529: 
<a name="21530"/>21530: 
<a name="21531"/>21531: 
<a name="21532"/>21532: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="21533"/>21533: 
<a name="21534"/>21534: <i>%% Tests that the tos control message header is received when</i>
<a name="21535"/>21535: <i>%% setting the socket 'ip' option recvtos is set to true when using</i>
<a name="21536"/>21536: <i>%% sendmsg/recvmsg on an IPv4 UDP (dgram) socket.</i>
<a name="21537"/>21537: <i>%% So, this is done on the receiving side: </i>
<a name="21538"/>21538: <i>%%</i>
<a name="21539"/>21539: <i>%%               socket:setopt(Sock, ip, recvtos, boolean()).</i>
<a name="21540"/>21540: <i>%%</i>
<a name="21541"/>21541: <i>%% For all subsequent *received* messages, the tos control message</i>
<a name="21542"/>21542: <i>%% header will be with the message.</i>
<a name="21543"/>21543: <i>%%</i>
<a name="21544"/>21544: <i>%% On some platforms it works sending TOS with the message (sendmsg with </i>
<a name="21545"/>21545: <i>%% a control message header), but since its not universal, we can't use</i>
<a name="21546"/>21546: <i>%% that method. Instead, set tos (true) on the sending socket.</i>
<a name="21547"/>21547: <i>%%</i>
<a name="21548"/>21548: 
<a name="api_opt_ip_recvtos_udp4-1"/><a name="21549"/>21549: <b>api_opt_ip_recvtos_udp4</b>(_Config) when is_list(_Config) -&gt;
<a name="21550"/>21550:     ?TT(?SECS(5)),
<a name="api_opt_ip_recvtos_udp4-last_expr"/><a name="21551"/>21551: <b>    tc_try</b>(api_opt_ip_recvtos_udp4,
<a name="21552"/>21552:            fun() -&gt;
<a name="21553"/>21553:                    is_not_windows(), % IP_TOS on windows
<a name="21554"/>21554:                    has_support_ipv4(),
<a name="21555"/>21555:                    has_support_ip_recvtos(),
<a name="21556"/>21556:                    has_support_ip_tos() % Used in the test
<a name="21557"/>21557:            end,
<a name="21558"/>21558:            fun() -&gt;
<a name="21559"/>21559:                    Set  = fun(Sock, Value) -&gt;
<a name="21560"/>21560:                                   socket:setopt(Sock, ip, recvtos, Value)
<a name="21561"/>21561:                           end,
<a name="21562"/>21562:                    Get  = fun(Sock) -&gt;
<a name="21563"/>21563:                                   socket:getopt(Sock, ip, recvtos)
<a name="21564"/>21564:                           end,
<a name="21565"/>21565:                    Send = fun(Sock, Data, Dest, default) -&gt;
<a name="21566"/>21566:                                   Msg = #{addr =&gt; Dest,
<a name="21567"/>21567:                                           iov  =&gt; [Data]},
<a name="21568"/>21568:                                   socket:sendmsg(Sock, Msg);
<a name="21569"/>21569:                              (Sock, Data, Dest, TOS) -&gt;
<a name="21570"/>21570:                                   CMsg = #{level =&gt; ip,
<a name="21571"/>21571:                                            type  =&gt; tos,
<a name="21572"/>21572:                                            data  =&gt; TOS},
<a name="21573"/>21573:                                   Msg  = #{addr =&gt; Dest,
<a name="21574"/>21574:                                            ctrl =&gt; [CMsg],
<a name="21575"/>21575:                                            iov  =&gt; [Data]},
<a name="21576"/>21576:                                   socket:sendmsg(Sock, Msg)
<a name="21577"/>21577:                           end,
<a name="21578"/>21578:                    Recv = fun(Sock) -&gt;
<a name="21579"/>21579:                                   case socket:recvmsg(Sock) of
<a name="21580"/>21580:                                       {ok, #{addr := Source,
<a name="21581"/>21581:                                              ctrl := CMsgs,
<a name="21582"/>21582:                                              iov  := [Data]}} -&gt;
<a name="21583"/>21583:                                           {ok, {Source, CMsgs, Data}};
<a name="21584"/>21584:                                       {error, _} = ERROR -&gt;
<a name="21585"/>21585:                                           ERROR
<a name="21586"/>21586:                                   end
<a name="21587"/>21587:                           end,
<a name="21588"/>21588:                    InitState = #{domain =&gt; inet,
<a name="21589"/>21589:                                  proto  =&gt; udp,
<a name="21590"/>21590:                                  send   =&gt; Send,
<a name="21591"/>21591:                                  recv   =&gt; Recv,
<a name="21592"/>21592:                                  set    =&gt; Set,
<a name="21593"/>21593:                                  get    =&gt; Get},
<a name="21594"/>21594:                    ok = api_opt_ip_recvtos_udp(InitState)
<a name="21595"/>21595:            end).
<a name="21596"/>21596: 
<a name="21597"/>21597: 
<a name="21598"/>21598: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="21599"/>21599: 
<a name="api_opt_ip_recvtos_udp-1"/><a name="21600"/>21600: <b>api_opt_ip_recvtos_udp</b>(InitState) -&gt;
<a name="21601"/>21601:     Seq = 
<a name="21602"/>21602:         [
<a name="21603"/>21603:          #{desc =&gt; &quot;local address&quot;,
<a name="21604"/>21604:            cmd  =&gt; fun(#{domain := local = Domain} = State) -&gt;
<a name="21605"/>21605:                            LSASrc = which_local_socket_addr(Domain),
<a name="21606"/>21606:                            LSADst = which_local_socket_addr(Domain),
<a name="21607"/>21607:                            {ok, State#{lsa_src =&gt; LSASrc,
<a name="21608"/>21608:                                        lsa_dst =&gt; LSADst}};
<a name="21609"/>21609:                       (#{domain := Domain} = State) -&gt;
<a name="21610"/>21610:                            LSA = which_local_socket_addr(Domain),
<a name="21611"/>21611:                            {ok, State#{lsa_src =&gt; LSA,
<a name="21612"/>21612:                                        lsa_dst =&gt; LSA}}
<a name="21613"/>21613:                    end},
<a name="21614"/>21614: 
<a name="21615"/>21615:          #{desc =&gt; &quot;open src socket&quot;,
<a name="21616"/>21616:            cmd  =&gt; fun(#{domain := Domain,
<a name="21617"/>21617:                          proto  := Proto} = State) -&gt;
<a name="21618"/>21618:                            Sock = sock_open(Domain, dgram, Proto),
<a name="21619"/>21619:                            {ok, State#{sock_src =&gt; Sock}}
<a name="21620"/>21620:                    end},
<a name="21621"/>21621:          #{desc =&gt; &quot;bind src&quot;,
<a name="21622"/>21622:            cmd  =&gt; fun(#{sock_src := Sock, lsa_src := LSA}) -&gt;
<a name="21623"/>21623:                            case sock_bind(Sock, LSA) of
<a name="21624"/>21624:                                ok -&gt;
<a name="21625"/>21625:                                    ?SEV_IPRINT(&quot;src bound&quot;),
<a name="21626"/>21626:                                    ok;
<a name="21627"/>21627:                                {error, Reason} = ERROR -&gt;
<a name="21628"/>21628:                                    ?SEV_EPRINT(&quot;src bind failed: ~p&quot;, [Reason]),
<a name="21629"/>21629:                                    ERROR
<a name="21630"/>21630:                            end
<a name="21631"/>21631:                    end},
<a name="21632"/>21632:          #{desc =&gt; &quot;sockname src socket&quot;,
<a name="21633"/>21633:            cmd  =&gt; fun(#{sock_src := Sock} = State) -&gt;
<a name="21634"/>21634:                            SASrc = sock_sockname(Sock),
<a name="21635"/>21635:                            ?SEV_IPRINT(&quot;src sockaddr: &quot;
<a name="21636"/>21636:                                        &quot;~n   ~p&quot;, [SASrc]),
<a name="21637"/>21637:                            {ok, State#{sa_src =&gt; SASrc}}
<a name="21638"/>21638:                    end},
<a name="21639"/>21639: 
<a name="21640"/>21640:          #{desc =&gt; &quot;open dst socket&quot;,
<a name="21641"/>21641:            cmd  =&gt; fun(#{domain := Domain,
<a name="21642"/>21642:                          proto  := Proto} = State) -&gt;
<a name="21643"/>21643:                            Sock = sock_open(Domain, dgram, Proto),
<a name="21644"/>21644:                            {ok, State#{sock_dst =&gt; Sock}}
<a name="21645"/>21645:                    end},
<a name="21646"/>21646:          #{desc =&gt; &quot;bind dst&quot;,
<a name="21647"/>21647:            cmd  =&gt; fun(#{sock_dst := Sock, lsa_dst := LSA}) -&gt;
<a name="21648"/>21648:                            case sock_bind(Sock, LSA) of
<a name="21649"/>21649:                                ok -&gt;
<a name="21650"/>21650:                                    ?SEV_IPRINT(&quot;src bound&quot;),
<a name="21651"/>21651:                                    ok;
<a name="21652"/>21652:                                {error, Reason} = ERROR -&gt;
<a name="21653"/>21653:                                    ?SEV_EPRINT(&quot;src bind failed: ~p&quot;, [Reason]),
<a name="21654"/>21654:                                    ERROR
<a name="21655"/>21655:                            end
<a name="21656"/>21656:                    end},
<a name="21657"/>21657:          #{desc =&gt; &quot;sockname dst socket&quot;,
<a name="21658"/>21658:            cmd  =&gt; fun(#{sock_dst := Sock} = State) -&gt;
<a name="21659"/>21659:                            SADst = sock_sockname(Sock),
<a name="21660"/>21660:                            ?SEV_IPRINT(&quot;dst sockaddr: &quot;
<a name="21661"/>21661:                                        &quot;~n   ~p&quot;, [SADst]),
<a name="21662"/>21662:                            {ok, State#{sa_dst =&gt; SADst}}
<a name="21663"/>21663:                    end},
<a name="21664"/>21664:          #{desc =&gt; &quot;default recvtos for dst socket&quot;,
<a name="21665"/>21665:            cmd  =&gt; fun(#{sock_dst := Sock, get := Get} = _State) -&gt;
<a name="21666"/>21666:                            case Get(Sock) of
<a name="21667"/>21667:                                {ok, false = Value} -&gt;
<a name="21668"/>21668:                                    ?SEV_IPRINT(&quot;dst recvtos: ~p&quot;, [Value]),
<a name="21669"/>21669:                                    ok;
<a name="21670"/>21670:                                {ok, Unexpected} -&gt;
<a name="21671"/>21671:                                    ?SEV_EPRINT(&quot;Unexpected src recvtos: ~p&quot;,
<a name="21672"/>21672:                                                [Unexpected]),
<a name="21673"/>21673:                                    {error, {unexpected, Unexpected}};
<a name="21674"/>21674:                                {error, Reason} = ERROR -&gt;
<a name="21675"/>21675:                                    ?SEV_EPRINT(&quot;Failed getting (default) timestamp:&quot;
<a name="21676"/>21676:                                                &quot;   ~p&quot;, [Reason]),
<a name="21677"/>21677:                                    ERROR
<a name="21678"/>21678:                            end
<a name="21679"/>21679:                    end},
<a name="21680"/>21680: 
<a name="21681"/>21681:          #{desc =&gt; &quot;send req (to dst) (wo explicit tos)&quot;,
<a name="21682"/>21682:            cmd  =&gt; fun(#{sock_src := Sock, sa_dst := Dst, send := Send}) -&gt;
<a name="21683"/>21683:                            Send(Sock, ?BASIC_REQ, Dst, default)
<a name="21684"/>21684:                    end},
<a name="21685"/>21685:          #{desc =&gt; &quot;recv req (from src)&quot;,
<a name="21686"/>21686:            cmd  =&gt; fun(#{sock_dst := Sock, sa_src := Src, recv := Recv}) -&gt;
<a name="21687"/>21687:                            case Recv(Sock) of
<a name="21688"/>21688:                                {ok, {Src, [], ?BASIC_REQ}} -&gt;
<a name="21689"/>21689:                                    ok;
<a name="21690"/>21690:                                {ok, {BadSrc, BadCHdrs, BadReq} = UnexpData} -&gt;
<a name="21691"/>21691:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="21692"/>21692:                                                &quot;~n   Expect Source: ~p&quot;
<a name="21693"/>21693:                                                &quot;~n   Recv Source:   ~p&quot;
<a name="21694"/>21694:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="21695"/>21695:                                                &quot;~n   Recv CHdrs:    ~p&quot;
<a name="21696"/>21696:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="21697"/>21697:                                                &quot;~n   Recv Msg:      ~p&quot;,
<a name="21698"/>21698:                                                [Src, BadSrc,
<a name="21699"/>21699:                                                 [], BadCHdrs,
<a name="21700"/>21700:                                                 ?BASIC_REQ, BadReq]),
<a name="21701"/>21701:                                    {error, {unexpected_data, UnexpData}};
<a name="21702"/>21702:                                {ok, UnexpData} -&gt;
<a name="21703"/>21703:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="21704"/>21704:                                                &quot;~n   Expect Source: ~p&quot;
<a name="21705"/>21705:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="21706"/>21706:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="21707"/>21707:                                                &quot;~n   Unexp Data:    ~p&quot;,
<a name="21708"/>21708:                                                [Src, [], ?BASIC_REQ, UnexpData]),
<a name="21709"/>21709:                                    {error, {unexpected_data, UnexpData}};
<a name="21710"/>21710:                                {error, _} = ERROR -&gt;
<a name="21711"/>21711:                                    %% At the moment there is no way to get
<a name="21712"/>21712:                                    %% status or state for the socket...
<a name="21713"/>21713:                                    ERROR
<a name="21714"/>21714:                            end
<a name="21715"/>21715:                    end},
<a name="21716"/>21716: 
<a name="21717"/>21717:          #{desc =&gt; &quot;set tos = reliability on src sock&quot;,
<a name="21718"/>21718:            cmd  =&gt; fun(#{sock_src := Sock}) -&gt;
<a name="21719"/>21719:                            ok = socket:setopt(Sock, ip, tos, reliability)
<a name="21720"/>21720:                    end},
<a name="21721"/>21721:          #{desc =&gt; &quot;send req (to dst) (w tos = reliability)&quot;,
<a name="21722"/>21722:            cmd  =&gt; fun(#{sock_src := Sock,
<a name="21723"/>21723:                          sa_dst   := Dst,
<a name="21724"/>21724:                          send     := Send}) -&gt;
<a name="21725"/>21725:                            Send(Sock, ?BASIC_REQ, Dst, default)
<a name="21726"/>21726:                    end},
<a name="21727"/>21727: 
<a name="21728"/>21728:          %% #{desc =&gt; &quot;send req (to dst) (w explicit tos = reliability)&quot;,
<a name="21729"/>21729:          %%   cmd  =&gt; fun(#{sock_src := Sock,
<a name="21730"/>21730:          %%                 sa_dst   := Dst,
<a name="21731"/>21731:          %%                 send     := Send}) -&gt;
<a name="21732"/>21732:          %%                   socket:setopt(Sock, otp, debug, true),
<a name="21733"/>21733:          %%                   case Send(Sock, ?BASIC_REQ, Dst, reliability) of
<a name="21734"/>21734:          %%                       ok -&gt;
<a name="21735"/>21735:          %%                           socket:setopt(Sock, otp, debug, false),
<a name="21736"/>21736:          %%                           ok;
<a name="21737"/>21737:          %%                       {error, Reason} -&gt;
<a name="21738"/>21738:          %%                           ?SEV_EPRINT(&quot;Failed sending message with tos: &quot;
<a name="21739"/>21739:          %%                                       &quot;~n   Reason: ~p&quot;, [Reason]),
<a name="21740"/>21740:          %%                           socket:setopt(Sock, otp, debug, false),
<a name="21741"/>21741:          %%                           {skip, &quot;Failed sending message with TOS&quot;}
<a name="21742"/>21742:          %%                   end
<a name="21743"/>21743:          %%           end},
<a name="21744"/>21744: 
<a name="21745"/>21745:          #{desc =&gt; &quot;recv req (from src) - wo explicit tos&quot;,
<a name="21746"/>21746:            cmd  =&gt; fun(#{sock_dst := Sock, sa_src := Src, recv := Recv}) -&gt;
<a name="21747"/>21747:                            case Recv(Sock) of
<a name="21748"/>21748:                                {ok, {Src, [], ?BASIC_REQ}} -&gt;
<a name="21749"/>21749:                                    ok;
<a name="21750"/>21750:                                {ok, {BadSrc, BadCHdrs, BadReq} = UnexpData} -&gt;
<a name="21751"/>21751:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="21752"/>21752:                                                &quot;~n   Expect Source: ~p&quot;
<a name="21753"/>21753:                                                &quot;~n   Recv Source:   ~p&quot;
<a name="21754"/>21754:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="21755"/>21755:                                                &quot;~n   Recv CHdrs:    ~p&quot;
<a name="21756"/>21756:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="21757"/>21757:                                                &quot;~n   Recv Msg:      ~p&quot;,
<a name="21758"/>21758:                                                [Src, BadSrc,
<a name="21759"/>21759:                                                 [], BadCHdrs,
<a name="21760"/>21760:                                                 ?BASIC_REQ, BadReq]),
<a name="21761"/>21761:                                    {error, {unexpected_data, UnexpData}};
<a name="21762"/>21762:                                {ok, UnexpData} -&gt;
<a name="21763"/>21763:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="21764"/>21764:                                                &quot;~n   Expect Source: ~p&quot;
<a name="21765"/>21765:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="21766"/>21766:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="21767"/>21767:                                                &quot;~n   Unexp Data:    ~p&quot;,
<a name="21768"/>21768:                                                [Src, [], ?BASIC_REQ, UnexpData]),
<a name="21769"/>21769:                                    {error, {unexpected_data, UnexpData}};
<a name="21770"/>21770:                                {error, _} = ERROR -&gt;
<a name="21771"/>21771:                                    %% At the moment there is no way to get
<a name="21772"/>21772:                                    %% status or state for the socket...
<a name="21773"/>21773:                                    ERROR
<a name="21774"/>21774:                            end
<a name="21775"/>21775:                    end},
<a name="21776"/>21776: 
<a name="21777"/>21777:          #{desc =&gt; &quot;set tos = 0 on src sock (\&quot;disabled\&quot;)&quot;,
<a name="21778"/>21778:            cmd  =&gt; fun(#{sock_src := Sock}) -&gt;
<a name="21779"/>21779:                            ok = socket:setopt(Sock, ip, tos, 0)
<a name="21780"/>21780:                    end},
<a name="21781"/>21781: 
<a name="21782"/>21782:          #{desc =&gt; &quot;enable recvtos on dst socket&quot;,
<a name="21783"/>21783:            cmd  =&gt; fun(#{sock_dst := Sock, set := Set} = _State) -&gt;
<a name="21784"/>21784:                            case Set(Sock, true) of
<a name="21785"/>21785:                                ok -&gt;
<a name="21786"/>21786:                                    ?SEV_IPRINT(&quot;dst recvtos enabled&quot;),
<a name="21787"/>21787:                                    ok;
<a name="21788"/>21788:                                {error, Reason} = ERROR -&gt;
<a name="21789"/>21789:                                    ?SEV_EPRINT(&quot;Failed setting recvtos:&quot;
<a name="21790"/>21790:                                                &quot;   ~p&quot;, [Reason]),
<a name="21791"/>21791:                                    ERROR
<a name="21792"/>21792:                            end
<a name="21793"/>21793:                    end},
<a name="21794"/>21794: 
<a name="21795"/>21795:          #{desc =&gt; &quot;send req (to dst) (wo explicit tos)&quot;,
<a name="21796"/>21796:            cmd  =&gt; fun(#{sock_src := Sock, sa_dst := Dst, send := Send}) -&gt;
<a name="21797"/>21797:                            Send(Sock, ?BASIC_REQ, Dst, default)
<a name="21798"/>21798:                    end},
<a name="21799"/>21799:          #{desc =&gt; &quot;recv req (from src) - w default tos&quot;,
<a name="21800"/>21800:            cmd  =&gt; fun(#{sock_dst := Sock, sa_src := Src, recv := Recv}) -&gt;
<a name="21801"/>21801:                            case Recv(Sock) of
<a name="21802"/>21802:                                {ok, {Src, [#{level := ip,
<a name="21803"/>21803:                                              type  := TOS,
<a name="21804"/>21804:                                              value := 0}], ?BASIC_REQ}}
<a name="21805"/>21805:                                  when ((TOS =:= tos) orelse (TOS =:= recvtos)) -&gt;
<a name="21806"/>21806:                                    ?SEV_IPRINT(&quot;got default TOS (~w) &quot;
<a name="21807"/>21807:                                                &quot;control message header&quot;, [TOS]),
<a name="21808"/>21808:                                    ok;
<a name="21809"/>21809:                                {ok, {BadSrc, BadCHdrs, BadReq} = UnexpData} -&gt;
<a name="21810"/>21810:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="21811"/>21811:                                                &quot;~n   Expect Source: ~p&quot;
<a name="21812"/>21812:                                                &quot;~n   Recv Source:   ~p&quot;
<a name="21813"/>21813:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="21814"/>21814:                                                &quot;~n   Recv CHdrs:    ~p&quot;
<a name="21815"/>21815:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="21816"/>21816:                                                &quot;~n   Recv Msg:      ~p&quot;,
<a name="21817"/>21817:                                                [Src, BadSrc,
<a name="21818"/>21818:                                                 [], BadCHdrs,
<a name="21819"/>21819:                                                 ?BASIC_REQ, BadReq]),
<a name="21820"/>21820:                                    {error, {unexpected_data, UnexpData}};
<a name="21821"/>21821:                                {ok, UnexpData} -&gt;
<a name="21822"/>21822:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="21823"/>21823:                                                &quot;~n   Expect Source: ~p&quot;
<a name="21824"/>21824:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="21825"/>21825:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="21826"/>21826:                                                &quot;~n   Unexp Data:    ~p&quot;,
<a name="21827"/>21827:                                                [Src, [], ?BASIC_REQ, UnexpData]),
<a name="21828"/>21828:                                    {error, {unexpected_data, UnexpData}};
<a name="21829"/>21829:                                {error, _} = ERROR -&gt;
<a name="21830"/>21830:                                    %% At the moment there is no way to get
<a name="21831"/>21831:                                    %% status or state for the socket...
<a name="21832"/>21832:                                    ERROR
<a name="21833"/>21833:                            end
<a name="21834"/>21834:                    end},
<a name="21835"/>21835: 
<a name="21836"/>21836:          #{desc =&gt; &quot;set tos = reliability on src sock&quot;,
<a name="21837"/>21837:            cmd  =&gt; fun(#{sock_src := Sock}) -&gt;
<a name="21838"/>21838:                            ok = socket:setopt(Sock, ip, tos, reliability)
<a name="21839"/>21839:                    end},
<a name="21840"/>21840: 
<a name="21841"/>21841:          #{desc =&gt; &quot;send req (to dst) (w tos = mincost)&quot;,
<a name="21842"/>21842:            cmd  =&gt; fun(#{sock_src := Sock, sa_dst := Dst, send := Send}) -&gt;
<a name="21843"/>21843:                            Send(Sock, ?BASIC_REQ, Dst, default)
<a name="21844"/>21844:                    end},
<a name="21845"/>21845:          #{desc =&gt; &quot;recv req (from src) - w tos = reliability&quot;,
<a name="21846"/>21846:            cmd  =&gt; fun(#{sock_dst := Sock, sa_src := Src, recv := Recv}) -&gt;
<a name="21847"/>21847:                            case Recv(Sock) of
<a name="21848"/>21848:                                {ok, {Src, [#{level := ip,
<a name="21849"/>21849:                                              type  := TOS,
<a name="21850"/>21850:                                              value := reliability = TOSData}],
<a name="21851"/>21851:                                      ?BASIC_REQ}} 
<a name="21852"/>21852:                                  when ((TOS =:= tos) orelse (TOS =:= recvtos)) -&gt;
<a name="21853"/>21853:                                    ?SEV_IPRINT(&quot;got expected TOS (~w) = ~w &quot;
<a name="21854"/>21854:                                                &quot;control message header&quot;, 
<a name="21855"/>21855:                                                [TOS, TOSData]),
<a name="21856"/>21856:                                    ok;
<a name="21857"/>21857:                                {ok, {BadSrc, BadCHdrs, BadReq} = UnexpData} -&gt;
<a name="21858"/>21858:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="21859"/>21859:                                                &quot;~n   Expect Source: ~p&quot;
<a name="21860"/>21860:                                                &quot;~n   Recv Source:   ~p&quot;
<a name="21861"/>21861:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="21862"/>21862:                                                &quot;~n   Recv CHdrs:    ~p&quot;
<a name="21863"/>21863:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="21864"/>21864:                                                &quot;~n   Recv Msg:      ~p&quot;,
<a name="21865"/>21865:                                                [Src, BadSrc,
<a name="21866"/>21866:                                                 [], BadCHdrs,
<a name="21867"/>21867:                                                 ?BASIC_REQ, BadReq]),
<a name="21868"/>21868:                                    {error, {unexpected_data, UnexpData}};
<a name="21869"/>21869:                                {ok, UnexpData} -&gt;
<a name="21870"/>21870:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="21871"/>21871:                                                &quot;~n   Expect Source: ~p&quot;
<a name="21872"/>21872:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="21873"/>21873:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="21874"/>21874:                                                &quot;~n   Unexp Data:    ~p&quot;,
<a name="21875"/>21875:                                                [Src, [], ?BASIC_REQ, UnexpData]),
<a name="21876"/>21876:                                    {error, {unexpected_data, UnexpData}};
<a name="21877"/>21877:                                {error, _} = ERROR -&gt;
<a name="21878"/>21878:                                    %% At the moment there is no way to get
<a name="21879"/>21879:                                    %% status or state for the socket...
<a name="21880"/>21880:                                    ERROR
<a name="21881"/>21881:                            end
<a name="21882"/>21882:                    end},
<a name="21883"/>21883: 
<a name="21884"/>21884:          #{desc =&gt; &quot;close src socket&quot;,
<a name="21885"/>21885:            cmd  =&gt; fun(#{sock_src := Sock} = State) -&gt;
<a name="21886"/>21886:                            ok = socket:close(Sock),
<a name="21887"/>21887:                            {ok, maps:remove(sock_src, State)}
<a name="21888"/>21888:                    end},
<a name="21889"/>21889:          #{desc =&gt; &quot;close dst socket&quot;,
<a name="21890"/>21890:            cmd  =&gt; fun(#{sock_dst := Sock} = State) -&gt;
<a name="21891"/>21891:                            ok = socket:close(Sock),
<a name="21892"/>21892:                            {ok, maps:remove(sock_dst, State)}
<a name="21893"/>21893:                    end},
<a name="21894"/>21894: 
<a name="21895"/>21895:          %% *** We are done ***
<a name="21896"/>21896:          ?SEV_FINISH_NORMAL
<a name="21897"/>21897:         ],
<a name="21898"/>21898:     Evaluator = ?SEV_START(&quot;tester&quot;, Seq, InitState),
<a name="api_opt_ip_recvtos_udp-last_expr"/><a name="21899"/>21899: <b>    ok = ?SEV_AWAIT_FINISH</b>([Evaluator]).
<a name="21900"/>21900: 
<a name="21901"/>21901: 
<a name="21902"/>21902: 
<a name="21903"/>21903: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="21904"/>21904: 
<a name="21905"/>21905: <i>%% Tests that the ttl control message header is received when</i>
<a name="21906"/>21906: <i>%% setting the socket 'ip' option recvttl is set to true when using</i>
<a name="21907"/>21907: <i>%% sendmsg/recvmsg on an IPv4 UDP (dgram) socket.</i>
<a name="21908"/>21908: <i>%% So, this is done on the receiving side: </i>
<a name="21909"/>21909: <i>%%</i>
<a name="21910"/>21910: <i>%%               socket:setopt(Sock, ip, recvttl, boolean()).</i>
<a name="21911"/>21911: <i>%%</i>
<a name="21912"/>21912: <i>%% For all subsequent *received* messages, the ttl control message</i>
<a name="21913"/>21913: <i>%% header will be with the message.</i>
<a name="21914"/>21914: <i>%%</i>
<a name="21915"/>21915: <i>%% On darwin we don't actually get the TTL we send even after we have</i>
<a name="21916"/>21916: <i>%% enabled TTL. Instead we get the default value (which was 64).</i>
<a name="21917"/>21917: <i>%% Possibly this is because we run the test in the same OS process and</i>
<a name="21918"/>21918: <i>%% even the same erlang process....</i>
<a name="21919"/>21919: <i>%% The same issue on OpenBSD (6.6).</i>
<a name="21920"/>21920: <i>%% Maybe we should send and receive from different VMs, until then</i>
<a name="21921"/>21921: <i>%% skip darwin and OpenBSD.</i>
<a name="21922"/>21922: <i>%%</i>
<a name="21923"/>21923: <i>%% Windows:</i>
<a name="21924"/>21924: <i>%% It seems like its possible to set and get the recvttl option,</i>
<a name="21925"/>21925: <i>%% but not to use the ttl control message header when sending.</i>
<a name="21926"/>21926: <i>%% The following is the list of types (for level ip) which are listed</i>
<a name="21927"/>21927: <i>%% as supported: IP_ORIGINAL_ARRIVAL_IF, IP_PKTINFO and IP_ECN</i>
<a name="21928"/>21928: 
<a name="api_opt_ip_recvttl_udp4-1"/><a name="21929"/>21929: <b>api_opt_ip_recvttl_udp4</b>(_Config) when is_list(_Config) -&gt;
<a name="21930"/>21930:     ?TT(?SECS(5)),
<a name="api_opt_ip_recvttl_udp4-last_expr"/><a name="21931"/>21931: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="21932"/>21932:            fun() -&gt;
<a name="21933"/>21933:                    has_support_ipv4(),
<a name="21934"/>21934: 		   has_support_ip_recvttl(),
<a name="21935"/>21935: 		   is_not_openbsd(),
<a name="21936"/>21936: 		   is_not_darwin()
<a name="21937"/>21937: 	   end,
<a name="21938"/>21938:            fun() -&gt;
<a name="21939"/>21939:                    Set  = fun(Sock, Value) -&gt;
<a name="21940"/>21940:                                   socket:setopt(Sock, ip, recvttl, Value)
<a name="21941"/>21941:                           end,
<a name="21942"/>21942:                    Get  = fun(Sock) -&gt;
<a name="21943"/>21943:                                   socket:getopt(Sock, ip, recvttl)
<a name="21944"/>21944:                           end,
<a name="21945"/>21945:                    Send = fun(Sock, Data, Dest, default) -&gt;
<a name="21946"/>21946:                                   Msg = #{addr =&gt; Dest,
<a name="21947"/>21947:                                           iov  =&gt; [Data]},
<a name="21948"/>21948:                                   socket:sendmsg(Sock, Msg);
<a name="21949"/>21949:                              (Sock, Data, Dest, TTL) -&gt;
<a name="21950"/>21950:                                   CMsg = #{level =&gt; ip,
<a name="21951"/>21951:                                            type  =&gt; ttl,
<a name="21952"/>21952:                                            value =&gt; TTL},
<a name="21953"/>21953:                                   Msg  = #{addr =&gt; Dest,
<a name="21954"/>21954:                                            ctrl =&gt; [CMsg],
<a name="21955"/>21955:                                            iov  =&gt; [Data]},
<a name="21956"/>21956:                                   socket:sendmsg(Sock, Msg)
<a name="21957"/>21957:                           end,
<a name="21958"/>21958:                    Recv = fun(Sock) -&gt;
<a name="21959"/>21959:                                   case socket:recvmsg(Sock) of
<a name="21960"/>21960:                                       {ok, #{addr := Source,
<a name="21961"/>21961:                                              ctrl := CMsgs,
<a name="21962"/>21962:                                              iov  := [Data]}} -&gt;
<a name="21963"/>21963:                                           {ok, {Source, CMsgs, Data}};
<a name="21964"/>21964:                                       {error, _} = ERROR -&gt;
<a name="21965"/>21965:                                           ERROR
<a name="21966"/>21966:                                   end
<a name="21967"/>21967:                           end,
<a name="21968"/>21968:                    InitState = #{domain =&gt; inet,
<a name="21969"/>21969:                                  proto  =&gt; udp,
<a name="21970"/>21970:                                  send   =&gt; Send,
<a name="21971"/>21971:                                  recv   =&gt; Recv,
<a name="21972"/>21972:                                  set    =&gt; Set,
<a name="21973"/>21973:                                  get    =&gt; Get},
<a name="21974"/>21974:                    ok = api_opt_ip_recvttl_udp(InitState)
<a name="21975"/>21975:            end).
<a name="21976"/>21976: 
<a name="21977"/>21977: 
<a name="21978"/>21978: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="21979"/>21979: 
<a name="api_opt_ip_recvttl_udp-1"/><a name="21980"/>21980: <b>api_opt_ip_recvttl_udp</b>(InitState) -&gt;
<a name="21981"/>21981:     Seq = 
<a name="21982"/>21982:         [
<a name="21983"/>21983:          #{desc =&gt; &quot;local address&quot;,
<a name="21984"/>21984:            cmd  =&gt; fun(#{domain := local = Domain} = State) -&gt;
<a name="21985"/>21985:                            LSASrc = which_local_socket_addr(Domain),
<a name="21986"/>21986:                            LSADst = which_local_socket_addr(Domain),
<a name="21987"/>21987:                            {ok, State#{lsa_src =&gt; LSASrc,
<a name="21988"/>21988:                                        lsa_dst =&gt; LSADst}};
<a name="21989"/>21989:                       (#{domain := Domain} = State) -&gt;
<a name="21990"/>21990:                            LSA = which_local_socket_addr(Domain),
<a name="21991"/>21991:                            {ok, State#{lsa_src =&gt; LSA,
<a name="21992"/>21992:                                        lsa_dst =&gt; LSA}}
<a name="21993"/>21993:                    end},
<a name="21994"/>21994: 
<a name="21995"/>21995:          #{desc =&gt; &quot;open src socket&quot;,
<a name="21996"/>21996:            cmd  =&gt; fun(#{domain := Domain,
<a name="21997"/>21997:                          proto  := Proto} = State) -&gt;
<a name="21998"/>21998:                            Sock = sock_open(Domain, dgram, Proto),
<a name="21999"/>21999:                            {ok, State#{sock_src =&gt; Sock}}
<a name="22000"/>22000:                    end},
<a name="22001"/>22001:          #{desc =&gt; &quot;bind src&quot;,
<a name="22002"/>22002:            cmd  =&gt; fun(#{sock_src := Sock, lsa_src := LSA}) -&gt;
<a name="22003"/>22003:                            case sock_bind(Sock, LSA) of
<a name="22004"/>22004:                                ok -&gt;
<a name="22005"/>22005:                                    ?SEV_IPRINT(&quot;src bound&quot;),
<a name="22006"/>22006:                                    ok;
<a name="22007"/>22007:                                {error, Reason} = ERROR -&gt;
<a name="22008"/>22008:                                    ?SEV_EPRINT(&quot;src bind failed: ~p&quot;, [Reason]),
<a name="22009"/>22009:                                    ERROR
<a name="22010"/>22010:                            end
<a name="22011"/>22011:                    end},
<a name="22012"/>22012:          #{desc =&gt; &quot;sockname src socket&quot;,
<a name="22013"/>22013:            cmd  =&gt; fun(#{sock_src := Sock} = State) -&gt;
<a name="22014"/>22014:                            SASrc = sock_sockname(Sock),
<a name="22015"/>22015:                            ?SEV_IPRINT(&quot;src sockaddr: &quot;
<a name="22016"/>22016:                                        &quot;~n   ~p&quot;, [SASrc]),
<a name="22017"/>22017:                            {ok, State#{sa_src =&gt; SASrc}}
<a name="22018"/>22018:                    end},
<a name="22019"/>22019: 
<a name="22020"/>22020:          #{desc =&gt; &quot;open dst socket&quot;,
<a name="22021"/>22021:            cmd  =&gt; fun(#{domain := Domain,
<a name="22022"/>22022:                          proto  := Proto} = State) -&gt;
<a name="22023"/>22023:                            Sock = sock_open(Domain, dgram, Proto),
<a name="22024"/>22024:                            {ok, State#{sock_dst =&gt; Sock}}
<a name="22025"/>22025:                    end},
<a name="22026"/>22026:          #{desc =&gt; &quot;bind dst&quot;,
<a name="22027"/>22027:            cmd  =&gt; fun(#{sock_dst := Sock, lsa_dst := LSA}) -&gt;
<a name="22028"/>22028:                            case sock_bind(Sock, LSA) of
<a name="22029"/>22029:                                ok -&gt;
<a name="22030"/>22030:                                    ?SEV_IPRINT(&quot;src bound&quot;),
<a name="22031"/>22031:                                    ok;
<a name="22032"/>22032:                                {error, Reason} = ERROR -&gt;
<a name="22033"/>22033:                                    ?SEV_EPRINT(&quot;src bind failed: ~p&quot;, [Reason]),
<a name="22034"/>22034:                                    ERROR
<a name="22035"/>22035:                            end
<a name="22036"/>22036:                    end},
<a name="22037"/>22037:          #{desc =&gt; &quot;sockname dst socket&quot;,
<a name="22038"/>22038:            cmd  =&gt; fun(#{sock_dst := Sock} = State) -&gt;
<a name="22039"/>22039:                            SADst = sock_sockname(Sock),
<a name="22040"/>22040:                            ?SEV_IPRINT(&quot;dst sockaddr: &quot;
<a name="22041"/>22041:                                        &quot;~n   ~p&quot;, [SADst]),
<a name="22042"/>22042:                            {ok, State#{sa_dst =&gt; SADst}}
<a name="22043"/>22043:                    end},
<a name="22044"/>22044:          #{desc =&gt; &quot;default recvttl for dst socket&quot;,
<a name="22045"/>22045:            cmd  =&gt; fun(#{sock_dst := Sock, get := Get} = _State) -&gt;
<a name="22046"/>22046:                            case Get(Sock) of
<a name="22047"/>22047:                                {ok, false = Value} -&gt;
<a name="22048"/>22048:                                    ?SEV_IPRINT(&quot;dst recvttl: ~p&quot;, [Value]),
<a name="22049"/>22049:                                    ok;
<a name="22050"/>22050:                                {ok, Unexpected} -&gt;
<a name="22051"/>22051:                                    ?SEV_EPRINT(&quot;Unexpected src recvttl: ~p&quot;,
<a name="22052"/>22052:                                                [Unexpected]),
<a name="22053"/>22053:                                    {error, {unexpected, Unexpected}};
<a name="22054"/>22054:                                {error, Reason} = ERROR -&gt;
<a name="22055"/>22055:                                    ?SEV_EPRINT(&quot;Failed getting (default) timestamp:&quot;
<a name="22056"/>22056:                                                &quot;   ~p&quot;, [Reason]),
<a name="22057"/>22057:                                    ERROR
<a name="22058"/>22058:                            end
<a name="22059"/>22059:                    end},
<a name="22060"/>22060: 
<a name="22061"/>22061:          #{desc =&gt; &quot;send req (to dst) (wo explicit ttl)&quot;,
<a name="22062"/>22062:            cmd  =&gt; fun(#{sock_src := Sock, sa_dst := Dst, send := Send}) -&gt;
<a name="22063"/>22063:                            Send(Sock, ?BASIC_REQ, Dst, default)
<a name="22064"/>22064:                    end},
<a name="22065"/>22065:          #{desc =&gt; &quot;recv req (from src)&quot;,
<a name="22066"/>22066:            cmd  =&gt; fun(#{sock_dst := Sock, sa_src := Src, recv := Recv}) -&gt;
<a name="22067"/>22067:                            case Recv(Sock) of
<a name="22068"/>22068:                                {ok, {Src, [], ?BASIC_REQ}} -&gt;
<a name="22069"/>22069:                                    ok;
<a name="22070"/>22070:                                {ok, {BadSrc, BadCHdrs, BadReq} = UnexpData} -&gt;
<a name="22071"/>22071:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="22072"/>22072:                                                &quot;~n   Expect Source: ~p&quot;
<a name="22073"/>22073:                                                &quot;~n   Recv Source:   ~p&quot;
<a name="22074"/>22074:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="22075"/>22075:                                                &quot;~n   Recv CHdrs:    ~p&quot;
<a name="22076"/>22076:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="22077"/>22077:                                                &quot;~n   Recv Msg:      ~p&quot;,
<a name="22078"/>22078:                                                [Src, BadSrc,
<a name="22079"/>22079:                                                 [], BadCHdrs,
<a name="22080"/>22080:                                                 ?BASIC_REQ, BadReq]),
<a name="22081"/>22081:                                    {error, {unexpected_data, UnexpData}};
<a name="22082"/>22082:                                {ok, UnexpData} -&gt;
<a name="22083"/>22083:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="22084"/>22084:                                                &quot;~n   Expect Source: ~p&quot;
<a name="22085"/>22085:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="22086"/>22086:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="22087"/>22087:                                                &quot;~n   Unexp Data:    ~p&quot;,
<a name="22088"/>22088:                                                [Src, [], ?BASIC_REQ, UnexpData]),
<a name="22089"/>22089:                                    {error, {unexpected_data, UnexpData}};
<a name="22090"/>22090:                                {error, _} = ERROR -&gt;
<a name="22091"/>22091:                                    %% At the moment there is no way to get
<a name="22092"/>22092:                                    %% status or state for the socket...
<a name="22093"/>22093:                                    ERROR
<a name="22094"/>22094:                            end
<a name="22095"/>22095:                    end},
<a name="22096"/>22096: 
<a name="22097"/>22097:          #{desc =&gt; &quot;send req (to dst) (w explicit ttl = 100)&quot;,
<a name="22098"/>22098:            cmd  =&gt; fun(#{sock_src := SSock,
<a name="22099"/>22099:                          sock_dst := DSock, sa_dst := Dst,
<a name="22100"/>22100:                          send     := Send}) -&gt;
<a name="22101"/>22101:                            case Send(SSock, ?BASIC_REQ, Dst, 100) of
<a name="22102"/>22102:                                ok -&gt;
<a name="22103"/>22103:                                    ok;
<a name="22104"/>22104:                                {error, einval = Reason} -&gt;
<a name="22105"/>22105:                                    %% IF we can't send it the test will not work
<a name="22106"/>22106:                                    ?SEV_EPRINT(&quot;Cannot send TTL: &quot;
<a name="22107"/>22107:                                                &quot;~p =&gt; SKIP&quot;, [Reason]),
<a name="22108"/>22108:                                    (catch socket:close(SSock)),
<a name="22109"/>22109:                                    (catch socket:close(DSock)),
<a name="22110"/>22110:                                    {skip,
<a name="22111"/>22111: 				    ?F(&quot;Cannot send with TTL: ~p&quot;, [Reason])};
<a name="22112"/>22112:                                {error, enoprotoopt = Reason} -&gt;
<a name="22113"/>22113:                                    %% On some platforms this is not
<a name="22114"/>22114:                                    %% accepted (FreeBSD), so skip.
<a name="22115"/>22115:                                    ?SEV_EPRINT(&quot;Expected Failure: &quot;
<a name="22116"/>22116:                                                &quot;~p =&gt; SKIP&quot;, [Reason]),
<a name="22117"/>22117:                                    (catch socket:close(SSock)),
<a name="22118"/>22118:                                    (catch socket:close(DSock)),
<a name="22119"/>22119:                                    {skip, Reason};
<a name="22120"/>22120: 
<a name="22121"/>22121:                                {error,
<a name="22122"/>22122:                                 {get_overlapped_result,
<a name="22123"/>22123:                                  #{file     := File,
<a name="22124"/>22124:                                    function := Function,
<a name="22125"/>22125:                                    line     := Line,
<a name="22126"/>22126:                                    raw_info := RawInfo,
<a name="22127"/>22127:                                    info     := invalid_parameter = Info}}} -&gt;
<a name="22128"/>22128:                                    %% IF we can't send it the test will not work
<a name="22129"/>22129:                                    ?SEV_EPRINT(&quot;Cannot send TTL: &quot;
<a name="22130"/>22130:                                                &quot;~p =&gt; SKIP: &quot;
<a name="22131"/>22131:                                                &quot;~n   File:     ~s&quot;
<a name="22132"/>22132:                                                &quot;~n   Function: ~s&quot;
<a name="22133"/>22133:                                                &quot;~n   Line:     ~p&quot;
<a name="22134"/>22134:                                                &quot;~n   Raw Info: ~p&quot;,
<a name="22135"/>22135:                                                [Info,
<a name="22136"/>22136:                                                 File, Function, Line,
<a name="22137"/>22137:                                                 RawInfo]),
<a name="22138"/>22138:                                    (catch socket:close(SSock)),
<a name="22139"/>22139:                                    (catch socket:close(DSock)),
<a name="22140"/>22140:                                    {skip,
<a name="22141"/>22141:                                     ?F(&quot;Cannot send with TTL: ~p&quot;, [Info])};
<a name="22142"/>22142:                                {error, {get_overlapped_result,
<a name="22143"/>22143:                                         invalid_parameter = Info}} -&gt;
<a name="22144"/>22144:                                    %% IF we can't send it the test will not work
<a name="22145"/>22145:                                    ?SEV_EPRINT(&quot;Cannot send TTL: &quot;
<a name="22146"/>22146:                                                &quot;~p =&gt; SKIP&quot;, [Info]),
<a name="22147"/>22147:                                    (catch socket:close(SSock)),
<a name="22148"/>22148:                                    (catch socket:close(DSock)),
<a name="22149"/>22149:                                    {skip,
<a name="22150"/>22150:                                     ?F(&quot;Cannot send with TTL: ~p&quot;, [Info])};
<a name="22151"/>22151: 
<a name="22152"/>22152:                                {error,
<a name="22153"/>22153:                                 {completion_status,
<a name="22154"/>22154:                                  #{file     := File,
<a name="22155"/>22155:                                    function := Function,
<a name="22156"/>22156:                                    line     := Line,
<a name="22157"/>22157:                                    raw_info := RawInfo,
<a name="22158"/>22158:                                    info     := invalid_parameter = Info}}} -&gt;
<a name="22159"/>22159:                                    %% IF we can't send it the test will not work
<a name="22160"/>22160:                                    ?SEV_EPRINT(&quot;Cannot send TTL: &quot;
<a name="22161"/>22161:                                                &quot;~p =&gt; SKIP: &quot;
<a name="22162"/>22162:                                                &quot;~n   File:     ~s&quot;
<a name="22163"/>22163:                                                &quot;~n   Function: ~s&quot;
<a name="22164"/>22164:                                                &quot;~n   Line:     ~p&quot;
<a name="22165"/>22165:                                                &quot;~n   Raw Info: ~p&quot;,
<a name="22166"/>22166:                                                [Info,
<a name="22167"/>22167:                                                 File, Function, Line,
<a name="22168"/>22168:                                                 RawInfo]),
<a name="22169"/>22169:                                    (catch socket:close(SSock)),
<a name="22170"/>22170:                                    (catch socket:close(DSock)),
<a name="22171"/>22171:                                    {skip,
<a name="22172"/>22172:                                     ?F(&quot;Cannot send with TTL: ~p&quot;, [Info])};
<a name="22173"/>22173:                                {error, {completion_status,
<a name="22174"/>22174:                                         invalid_parameter = Info}} -&gt;
<a name="22175"/>22175:                                    %% IF we can't send it the test will not work
<a name="22176"/>22176:                                    ?SEV_EPRINT(&quot;Cannot send TTL: &quot;
<a name="22177"/>22177:                                                &quot;~p =&gt; SKIP&quot;, [Info]),
<a name="22178"/>22178:                                    (catch socket:close(SSock)),
<a name="22179"/>22179:                                    (catch socket:close(DSock)),
<a name="22180"/>22180:                                    {skip,
<a name="22181"/>22181:                                     ?F(&quot;Cannot send with TTL: ~p&quot;, [Info])};
<a name="22182"/>22182: 
<a name="22183"/>22183:                                {error, _Reason} = ERROR -&gt;
<a name="22184"/>22184:                                    ERROR
<a name="22185"/>22185:                            end
<a name="22186"/>22186:                    end},
<a name="22187"/>22187:          #{desc =&gt; &quot;recv req (from src) - wo ttl&quot;,
<a name="22188"/>22188:            cmd  =&gt; fun(#{sock_dst := Sock, sa_src := Src, recv := Recv}) -&gt;
<a name="22189"/>22189:                            case Recv(Sock) of
<a name="22190"/>22190:                                {ok, {Src, [], ?BASIC_REQ}} -&gt;
<a name="22191"/>22191:                                    ok;
<a name="22192"/>22192:                                {ok, {Src, [#{level := ip,
<a name="22193"/>22193:                                              type  := TTLType,
<a name="22194"/>22194:                                              value := TTL}], ?BASIC_REQ}}
<a name="22195"/>22195:                                when ((TTLType =:= recvttl) andalso
<a name="22196"/>22196:                                      (TTL =:= 255)) -&gt;
<a name="22197"/>22197:                                    %% This is the behaviopur on Solaris (11)
<a name="22198"/>22198:                                    %% and maybe on other platforms...
<a name="22199"/>22199:                                    ?SEV_IPRINT(&quot;Got (default) TTL (~w): ~p&quot;,
<a name="22200"/>22200:                                                [TTLType, TTL]),
<a name="22201"/>22201:                                    ok;
<a name="22202"/>22202:                                {ok, {BadSrc, BadCHdrs, BadReq} = UnexpData} -&gt;
<a name="22203"/>22203:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="22204"/>22204:                                                &quot;~n   Expect Source: ~p&quot;
<a name="22205"/>22205:                                                &quot;~n   Recv Source:   ~p&quot;
<a name="22206"/>22206:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="22207"/>22207:                                                &quot;~n   Recv CHdrs:    ~p&quot;
<a name="22208"/>22208:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="22209"/>22209:                                                &quot;~n   Recv Msg:      ~p&quot;,
<a name="22210"/>22210:                                                [Src, BadSrc,
<a name="22211"/>22211:                                                 [], BadCHdrs,
<a name="22212"/>22212:                                                 ?BASIC_REQ, BadReq]),
<a name="22213"/>22213:                                    {error, {unexpected_data, UnexpData}};
<a name="22214"/>22214:                                {ok, UnexpData} -&gt;
<a name="22215"/>22215:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="22216"/>22216:                                                &quot;~n   Expect Source: ~p&quot;
<a name="22217"/>22217:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="22218"/>22218:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="22219"/>22219:                                                &quot;~n   Unexp Data:    ~p&quot;,
<a name="22220"/>22220:                                                [Src, [], ?BASIC_REQ, UnexpData]),
<a name="22221"/>22221:                                    {error, {unexpected_data, UnexpData}};
<a name="22222"/>22222:                                {error, _} = ERROR -&gt;
<a name="22223"/>22223:                                    %% At the moment there is no way to get
<a name="22224"/>22224:                                    %% status or state for the socket...
<a name="22225"/>22225:                                    ERROR
<a name="22226"/>22226:                            end
<a name="22227"/>22227:                    end},
<a name="22228"/>22228: 
<a name="22229"/>22229:          #{desc =&gt; &quot;enable recvttl on dst socket&quot;,
<a name="22230"/>22230:            cmd  =&gt; fun(#{sock_dst := Sock, set := Set} = _State) -&gt;
<a name="22231"/>22231:                            case Set(Sock, true) of
<a name="22232"/>22232:                                ok -&gt;
<a name="22233"/>22233:                                    ?SEV_IPRINT(&quot;dst recvttl enabled&quot;),
<a name="22234"/>22234:                                    ok;
<a name="22235"/>22235:                                {error, Reason} = ERROR -&gt;
<a name="22236"/>22236:                                    ?SEV_EPRINT(&quot;Failed enabling recvttl:&quot;
<a name="22237"/>22237:                                                &quot;   ~p&quot;, [Reason]),
<a name="22238"/>22238:                                    ERROR
<a name="22239"/>22239:                            end
<a name="22240"/>22240:                    end},
<a name="22241"/>22241: 
<a name="22242"/>22242:          #{desc =&gt; &quot;send req (to dst) (wo explicit ttl)&quot;,
<a name="22243"/>22243:            cmd  =&gt; fun(#{sock_src := Sock, sa_dst := Dst, send := Send}) -&gt;
<a name="22244"/>22244:                            Send(Sock, ?BASIC_REQ, Dst, default)
<a name="22245"/>22245:                    end},
<a name="22246"/>22246:          #{desc =&gt; &quot;recv req (from src) - w default ttl&quot;,
<a name="22247"/>22247:            cmd  =&gt; fun(#{sock_dst := Sock, sa_src := Src, recv := Recv}) -&gt;
<a name="22248"/>22248:                            case Recv(Sock) of
<a name="22249"/>22249:                                {ok, {Src, [#{level := ip,
<a name="22250"/>22250:                                              type  := TTLType,
<a name="22251"/>22251:                                              value := TTL}], ?BASIC_REQ}}
<a name="22252"/>22252:                                when ((TTLType =:= ttl) orelse 
<a name="22253"/>22253:                                      (TTLType =:= recvttl)) -&gt;
<a name="22254"/>22254:                                    ?SEV_IPRINT(&quot;Got (default) TTL (~w): ~p&quot;,
<a name="22255"/>22255:                                                [TTLType, TTL]),
<a name="22256"/>22256:                                    ok;
<a name="22257"/>22257:                                {ok, {BadSrc, BadCHdrs, BadReq} = UnexpData} -&gt;
<a name="22258"/>22258:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="22259"/>22259:                                                &quot;~n   Expect Source: ~p&quot;
<a name="22260"/>22260:                                                &quot;~n   Recv Source:   ~p&quot;
<a name="22261"/>22261:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="22262"/>22262:                                                &quot;~n   Recv CHdrs:    ~p&quot;
<a name="22263"/>22263:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="22264"/>22264:                                                &quot;~n   Recv Msg:      ~p&quot;,
<a name="22265"/>22265:                                                [Src, BadSrc,
<a name="22266"/>22266:                                                 [#{level =&gt; ip,
<a name="22267"/>22267: 						   type  =&gt; ttl,
<a name="22268"/>22268: 						   value =&gt; &quot;something&quot;}],
<a name="22269"/>22269: 						BadCHdrs,
<a name="22270"/>22270:                                                 ?BASIC_REQ, BadReq]),
<a name="22271"/>22271:                                    {error, {unexpected_data, UnexpData}};
<a name="22272"/>22272:                                {ok, UnexpData} -&gt;
<a name="22273"/>22273:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="22274"/>22274:                                                &quot;~n   Expect Source: ~p&quot;
<a name="22275"/>22275:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="22276"/>22276:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="22277"/>22277:                                                &quot;~n   Unexp Data:    ~p&quot;,
<a name="22278"/>22278:                                                [Src, [#{level =&gt; ip,
<a name="22279"/>22279: 							type  =&gt; ttl,
<a name="22280"/>22280: 							value =&gt; &quot;something&quot;}],
<a name="22281"/>22281: 						?BASIC_REQ, UnexpData]),
<a name="22282"/>22282:                                    {error, {unexpected_data, UnexpData}};
<a name="22283"/>22283:                                {error, _} = ERROR -&gt;
<a name="22284"/>22284:                                    %% At the moment there is no way to get
<a name="22285"/>22285:                                    %% status or state for the socket...
<a name="22286"/>22286:                                    ERROR
<a name="22287"/>22287:                            end
<a name="22288"/>22288:                    end},
<a name="22289"/>22289: 
<a name="22290"/>22290:          #{desc =&gt; &quot;send req (to dst) (w explicit ttl = 100)&quot;,
<a name="22291"/>22291:            cmd  =&gt; fun(#{sock_src := Sock, sa_dst := Dst, send := Send}) -&gt;
<a name="22292"/>22292:                            Send(Sock, ?BASIC_REQ, Dst, 100)
<a name="22293"/>22293:                    end},
<a name="22294"/>22294:          #{desc =&gt; &quot;recv req (from src) - w ttl = 100&quot;,
<a name="22295"/>22295:            cmd  =&gt; fun(#{sock_dst := Sock, sa_src := Src, recv := Recv}) -&gt;
<a name="22296"/>22296:                            case Recv(Sock) of
<a name="22297"/>22297:                                {ok, {Src, [#{level := ip,
<a name="22298"/>22298:                                              type  := TTLType,
<a name="22299"/>22299:                                              value := 100 = TTL}], ?BASIC_REQ}}
<a name="22300"/>22300:                                when ((TTLType =:= ttl) orelse
<a name="22301"/>22301:                                      (TTLType =:= recvttl)) -&gt;
<a name="22302"/>22302:                                    ?SEV_IPRINT(&quot;Got TTL (~w): ~p&quot;,
<a name="22303"/>22303:                                                [TTLType, TTL]),
<a name="22304"/>22304:                                    ok;
<a name="22305"/>22305:                                {ok, {Src, [#{level := ip,
<a name="22306"/>22306:                                              type  := TTLType,
<a name="22307"/>22307:                                              value := BadTTL}], ?BASIC_REQ}}
<a name="22308"/>22308:                                when ((TTLType =:= ttl) orelse
<a name="22309"/>22309:                                      (TTLType =:= recvttl)) -&gt;
<a name="22310"/>22310:                                    ?SEV_EPRINT(&quot;Unexpected TTL: &quot;
<a name="22311"/>22311:                                                &quot;~n   Expect TTL: ~p&quot;
<a name="22312"/>22312:                                                &quot;~n   Recv TTL:   ~p&quot;,
<a name="22313"/>22313:                                                [100, BadTTL]),
<a name="22314"/>22314:                                    {error, {unexpected_ttl, {100, BadTTL}}};
<a name="22315"/>22315:                                {ok, {BadSrc, BadCHdrs, BadReq} = UnexpData} -&gt;
<a name="22316"/>22316:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="22317"/>22317:                                                &quot;~n   Expect Source: ~p&quot;
<a name="22318"/>22318:                                                &quot;~n   Recv Source:   ~p&quot;
<a name="22319"/>22319:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="22320"/>22320:                                                &quot;~n   Recv CHdrs:    ~p&quot;
<a name="22321"/>22321:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="22322"/>22322:                                                &quot;~n   Recv Msg:      ~p&quot;,
<a name="22323"/>22323:                                                [Src, BadSrc,
<a name="22324"/>22324:                                                 [#{level =&gt; ip,
<a name="22325"/>22325: 						   type  =&gt; ttl,
<a name="22326"/>22326: 						   value =&gt; 100}], BadCHdrs,
<a name="22327"/>22327:                                                 ?BASIC_REQ, BadReq]),
<a name="22328"/>22328:                                    {error, {unexpected_data, UnexpData}};
<a name="22329"/>22329:                                {ok, UnexpData} -&gt;
<a name="22330"/>22330:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="22331"/>22331:                                                &quot;~n   Expect Source: ~p&quot;
<a name="22332"/>22332:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="22333"/>22333:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="22334"/>22334:                                                &quot;~n   Unexp Data:    ~p&quot;,
<a name="22335"/>22335:                                                [Src, [#{level =&gt; ip,
<a name="22336"/>22336: 							type  =&gt; ttl,
<a name="22337"/>22337: 							value =&gt; 100}],
<a name="22338"/>22338: 						?BASIC_REQ, UnexpData]),
<a name="22339"/>22339:                                    {error, {unexpected_data, UnexpData}};
<a name="22340"/>22340:                                {error, _} = ERROR -&gt;
<a name="22341"/>22341:                                    %% At the moment there is no way to get
<a name="22342"/>22342:                                    %% status or state for the socket...
<a name="22343"/>22343:                                    ERROR
<a name="22344"/>22344:                            end
<a name="22345"/>22345:                    end},
<a name="22346"/>22346: 
<a name="22347"/>22347:          #{desc =&gt; &quot;close src socket&quot;,
<a name="22348"/>22348:            cmd  =&gt; fun(#{sock_src := Sock} = State) -&gt;
<a name="22349"/>22349:                            ok = socket:close(Sock),
<a name="22350"/>22350:                            {ok, maps:remove(sock_src, State)}
<a name="22351"/>22351:                    end},
<a name="22352"/>22352:          #{desc =&gt; &quot;close dst socket&quot;,
<a name="22353"/>22353:            cmd  =&gt; fun(#{sock_dst := Sock} = State) -&gt;
<a name="22354"/>22354:                            ok = socket:close(Sock),
<a name="22355"/>22355:                            {ok, maps:remove(sock_dst, State)}
<a name="22356"/>22356:                    end},
<a name="22357"/>22357: 
<a name="22358"/>22358:          %% *** We are done ***
<a name="22359"/>22359:          ?SEV_FINISH_NORMAL
<a name="22360"/>22360:         ],
<a name="22361"/>22361:     Evaluator = ?SEV_START(&quot;tester&quot;, Seq, InitState),
<a name="api_opt_ip_recvttl_udp-last_expr"/><a name="22362"/>22362: <b>    ok = ?SEV_AWAIT_FINISH</b>([Evaluator]).
<a name="22363"/>22363: 
<a name="22364"/>22364: 
<a name="22365"/>22365: 
<a name="22366"/>22366: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="22367"/>22367: 
<a name="22368"/>22368: <i>%% Tests the ip socket option 'tos' can be set and retrieved from a</i>
<a name="22369"/>22369: <i>%% the socket its set on. It sets the type-of-server field in the IP</i>
<a name="22370"/>22370: <i>%% header for a TCP or UDP socket.</i>
<a name="22371"/>22371: <i>%% There is no way to fetch the value a received IP datagram.</i>
<a name="22372"/>22372: <i>%% Default value is supposed to be '0'.</i>
<a name="22373"/>22373: <i>%% </i>
<a name="22374"/>22374: 
<a name="api_opt_ip_tos_udp4-1"/><a name="22375"/>22375: <b>api_opt_ip_tos_udp4</b>(_Config) when is_list(_Config) -&gt;
<a name="22376"/>22376:     ?TT(?SECS(5)),
<a name="api_opt_ip_tos_udp4-last_expr"/><a name="22377"/>22377: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="22378"/>22378:            fun() -&gt;
<a name="22379"/>22379:                    is_not_windows(), % IP_TOS on windows
<a name="22380"/>22380:                    has_support_ipv4(),
<a name="22381"/>22381:                    has_support_ip_tos()
<a name="22382"/>22382:            end,
<a name="22383"/>22383:            fun() -&gt;
<a name="22384"/>22384:                    Set  = fun(Sock, Value) -&gt;
<a name="22385"/>22385:                                   socket:setopt(Sock, ip, tos, Value)
<a name="22386"/>22386:                           end,
<a name="22387"/>22387:                    Get  = fun(Sock) -&gt;
<a name="22388"/>22388:                                   socket:getopt(Sock, ip, tos)
<a name="22389"/>22389:                           end,
<a name="22390"/>22390:                    InitState = #{set =&gt; Set,
<a name="22391"/>22391:                                  get =&gt; Get},
<a name="22392"/>22392:                    ok = api_opt_ip_tos_udp(InitState)
<a name="22393"/>22393:            end).
<a name="22394"/>22394: 
<a name="22395"/>22395: 
<a name="22396"/>22396: 
<a name="22397"/>22397: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="22398"/>22398: 
<a name="api_opt_ip_tos_udp-1"/><a name="22399"/>22399: <b>api_opt_ip_tos_udp</b>(InitState) -&gt;
<a name="22400"/>22400:     process_flag(trap_exit, true),
<a name="22401"/>22401:     %% mincost is not supported on all platforms.
<a name="22402"/>22402:     %% For instance, Solaris 10, does not have that constant.
<a name="22403"/>22403:     %% Instead it has two others with, what appears to be,
<a name="22404"/>22404:     %% completely different meanings...
<a name="22405"/>22405:     %% So, avoid the complication by not using this value...
<a name="22406"/>22406:     %% TOS1 = mincost,     TOS1Str = atom_to_list(TOS1),
<a name="22407"/>22407:     TOS2 = throughput,  TOS2Str = atom_to_list(TOS2),
<a name="22408"/>22408:     TOS3 = reliability, TOS3Str = atom_to_list(TOS3),
<a name="22409"/>22409:     TOS4 = lowdelay,    TOS4Str = atom_to_list(TOS4),
<a name="22410"/>22410:     TOS5 = 42,          TOS5Str = integer_to_list(TOS5),
<a name="22411"/>22411:     Seq =
<a name="22412"/>22412:         [
<a name="22413"/>22413:          #{desc =&gt; &quot;local address&quot;,
<a name="22414"/>22414:            cmd  =&gt; fun(State) -&gt;
<a name="22415"/>22415:                            LSA = which_local_socket_addr(inet),
<a name="22416"/>22416:                            {ok, State#{lsa =&gt; LSA}}
<a name="22417"/>22417:                    end},
<a name="22418"/>22418: 
<a name="22419"/>22419:          #{desc =&gt; &quot;open socket&quot;,
<a name="22420"/>22420:            cmd  =&gt; fun(State) -&gt;
<a name="22421"/>22421:                            Sock = sock_open(inet, dgram, udp),
<a name="22422"/>22422:                            {ok, State#{sock =&gt; Sock}}
<a name="22423"/>22423:                    end},
<a name="22424"/>22424:          #{desc =&gt; &quot;bind&quot;,
<a name="22425"/>22425:            cmd  =&gt; fun(#{sock := Sock, lsa := LSA}) -&gt;
<a name="22426"/>22426:                            case sock_bind(Sock, LSA) of
<a name="22427"/>22427:                                ok -&gt;
<a name="22428"/>22428:                                    ?SEV_IPRINT(&quot;socket bound&quot;),
<a name="22429"/>22429:                                    ok;
<a name="22430"/>22430:                                {error, Reason} = ERROR -&gt;
<a name="22431"/>22431:                                    ?SEV_EPRINT(&quot;bind failed: ~p&quot;, [Reason]),
<a name="22432"/>22432:                                    ERROR
<a name="22433"/>22433:                            end
<a name="22434"/>22434:                    end},
<a name="22435"/>22435: 
<a name="22436"/>22436:          #{desc =&gt; &quot;get default tos&quot;,
<a name="22437"/>22437:            cmd  =&gt; fun(#{sock := Sock, get := Get} = _State) -&gt;
<a name="22438"/>22438:                            case Get(Sock) of
<a name="22439"/>22439:                                {ok, 0 = Value} -&gt;
<a name="22440"/>22440:                                    ?SEV_IPRINT(&quot;expected default tos: ~p&quot;, [Value]),
<a name="22441"/>22441:                                    ok;
<a name="22442"/>22442:                                {ok, Unexpected} -&gt;
<a name="22443"/>22443:                                    ?SEV_EPRINT(&quot;Unexpected default tos: ~p&quot;,
<a name="22444"/>22444:                                                [Unexpected]),
<a name="22445"/>22445:                                    {error, {unexpected, Unexpected}};
<a name="22446"/>22446:                                {error, Reason} = ERROR -&gt;
<a name="22447"/>22447:                                    ?SEV_EPRINT(&quot;Failed getting (default) tos:&quot;
<a name="22448"/>22448:                                                &quot;   ~p&quot;, [Reason]),
<a name="22449"/>22449:                                    ERROR
<a name="22450"/>22450:                            end
<a name="22451"/>22451:                    end},
<a name="22452"/>22452: 
<a name="22453"/>22453:          %% #{desc =&gt; &quot;set tos &quot; ++ TOS1Str,
<a name="22454"/>22454:          %%   cmd  =&gt; fun(#{sock := Sock, set := Set} = _State) -&gt;
<a name="22455"/>22455:          %%                   socket:setopt(Sock, otp, debug, true),
<a name="22456"/>22456:          %%                   case Set(Sock, TOS1) of
<a name="22457"/>22457:          %%                       ok -&gt;
<a name="22458"/>22458:          %%                           socket:setopt(Sock, otp, debug, false),
<a name="22459"/>22459:          %%                           ?SEV_IPRINT(&quot;tos set to ~p&quot;, [TOS1]),
<a name="22460"/>22460:          %%                           ok;
<a name="22461"/>22461:          %%                       {error, Reason} = ERROR -&gt;
<a name="22462"/>22462:          %%                           socket:setopt(Sock, otp, debug, false),
<a name="22463"/>22463:          %%                           ?SEV_EPRINT(&quot;Failed setting tos:&quot;
<a name="22464"/>22464:          %%                                       &quot;   ~p&quot;, [Reason]),
<a name="22465"/>22465:          %%                           ERROR
<a name="22466"/>22466:          %%                   end
<a name="22467"/>22467:          %%           end},
<a name="22468"/>22468:          %% #{desc =&gt; &quot;get tos (expect &quot; ++ TOS1Str ++ &quot;)&quot;,
<a name="22469"/>22469:          %%   cmd  =&gt; fun(#{sock := Sock, get := Get} = _State) -&gt;
<a name="22470"/>22470:          %%                   case Get(Sock) of
<a name="22471"/>22471:          %%                       {ok, TOS1 = Value} -&gt;
<a name="22472"/>22472:          %%                           ?SEV_IPRINT(&quot;expected tos (~p)&quot;, [Value]),
<a name="22473"/>22473:          %%                           ok;
<a name="22474"/>22474:          %%                       {ok, Unexpected} -&gt;
<a name="22475"/>22475:          %%                           ?SEV_EPRINT(&quot;Unexpected tos: ~p&quot;,
<a name="22476"/>22476:          %%                                       [Unexpected]),
<a name="22477"/>22477:          %%                           {error, {unexpected, Unexpected}};
<a name="22478"/>22478:          %%                       {error, Reason} = ERROR -&gt;
<a name="22479"/>22479:          %%                           ?SEV_EPRINT(&quot;Failed getting (default) tos:&quot;
<a name="22480"/>22480:          %%                                       &quot;   ~p&quot;, [Reason]),
<a name="22481"/>22481:          %%                           ERROR
<a name="22482"/>22482:          %%                   end
<a name="22483"/>22483:          %%           end},
<a name="22484"/>22484: 
<a name="22485"/>22485:          #{desc =&gt; &quot;set tos &quot; ++ TOS2Str,
<a name="22486"/>22486:            cmd  =&gt; fun(#{sock := Sock, set := Set} = _State) -&gt;
<a name="22487"/>22487:                            case Set(Sock, TOS2) of
<a name="22488"/>22488:                                ok -&gt;
<a name="22489"/>22489:                                    ?SEV_IPRINT(&quot;tos set to ~p&quot;, [TOS2]),
<a name="22490"/>22490:                                    ok;
<a name="22491"/>22491:                                {error, Reason} = ERROR -&gt;
<a name="22492"/>22492:                                    ?SEV_EPRINT(&quot;Failed setting tos:&quot;
<a name="22493"/>22493:                                                &quot;   ~p&quot;, [Reason]),
<a name="22494"/>22494:                                    ERROR
<a name="22495"/>22495:                            end
<a name="22496"/>22496:                    end},
<a name="22497"/>22497:          #{desc =&gt; &quot;get tos (expect &quot; ++ TOS2Str ++ &quot;)&quot;,
<a name="22498"/>22498:            cmd  =&gt; fun(#{sock := Sock, get := Get} = _State) -&gt;
<a name="22499"/>22499:                            case Get(Sock) of
<a name="22500"/>22500:                                {ok, TOS2 = Value} -&gt;
<a name="22501"/>22501:                                    ?SEV_IPRINT(&quot;expected tos (~p)&quot;, [Value]),
<a name="22502"/>22502:                                    ok;
<a name="22503"/>22503:                                {ok, Unexpected} -&gt;
<a name="22504"/>22504:                                    ?SEV_EPRINT(&quot;Unexpected tos: ~p&quot;,
<a name="22505"/>22505:                                                [Unexpected]),
<a name="22506"/>22506:                                    {error, {unexpected, Unexpected}};
<a name="22507"/>22507:                                {error, Reason} = ERROR -&gt;
<a name="22508"/>22508:                                    ?SEV_EPRINT(&quot;Failed getting (default) tos:&quot;
<a name="22509"/>22509:                                                &quot;   ~p&quot;, [Reason]),
<a name="22510"/>22510:                                    ERROR
<a name="22511"/>22511:                            end
<a name="22512"/>22512:                    end},
<a name="22513"/>22513: 
<a name="22514"/>22514:          #{desc =&gt; &quot;set tos &quot; ++ TOS3Str,
<a name="22515"/>22515:            cmd  =&gt; fun(#{sock := Sock, set := Set} = _State) -&gt;
<a name="22516"/>22516:                            case Set(Sock, TOS3) of
<a name="22517"/>22517:                                ok -&gt;
<a name="22518"/>22518:                                    ?SEV_IPRINT(&quot;tos set to ~p&quot;, [TOS3]),
<a name="22519"/>22519:                                    ok;
<a name="22520"/>22520:                                {error, Reason} = ERROR -&gt;
<a name="22521"/>22521:                                    ?SEV_EPRINT(&quot;Failed setting tos:&quot;
<a name="22522"/>22522:                                                &quot;   ~p&quot;, [Reason]),
<a name="22523"/>22523:                                    ERROR
<a name="22524"/>22524:                            end
<a name="22525"/>22525:                    end},
<a name="22526"/>22526:          #{desc =&gt; &quot;get tos (expect &quot; ++ TOS3Str ++ &quot;)&quot;,
<a name="22527"/>22527:            cmd  =&gt; fun(#{sock := Sock, get := Get} = _State) -&gt;
<a name="22528"/>22528:                            case Get(Sock) of
<a name="22529"/>22529:                                {ok, TOS3 = Value} -&gt;
<a name="22530"/>22530:                                    ?SEV_IPRINT(&quot;expected tos (~p)&quot;, [Value]),
<a name="22531"/>22531:                                    ok;
<a name="22532"/>22532:                                {ok, Unexpected} -&gt;
<a name="22533"/>22533:                                    ?SEV_EPRINT(&quot;Unexpected tos: ~p&quot;,
<a name="22534"/>22534:                                                [Unexpected]),
<a name="22535"/>22535:                                    {error, {unexpected, Unexpected}};
<a name="22536"/>22536:                                {error, Reason} = ERROR -&gt;
<a name="22537"/>22537:                                    ?SEV_EPRINT(&quot;Failed getting (default) tos:&quot;
<a name="22538"/>22538:                                                &quot;   ~p&quot;, [Reason]),
<a name="22539"/>22539:                                    ERROR
<a name="22540"/>22540:                            end
<a name="22541"/>22541:                    end},
<a name="22542"/>22542: 
<a name="22543"/>22543:          #{desc =&gt; &quot;set tos &quot; ++ TOS4Str,
<a name="22544"/>22544:            cmd  =&gt; fun(#{sock := Sock, set := Set} = _State) -&gt;
<a name="22545"/>22545:                            case Set(Sock, TOS4) of
<a name="22546"/>22546:                                ok -&gt;
<a name="22547"/>22547:                                    ?SEV_IPRINT(&quot;tos set to ~p&quot;, [TOS4]),
<a name="22548"/>22548:                                    ok;
<a name="22549"/>22549:                                {error, Reason} = ERROR -&gt;
<a name="22550"/>22550:                                    ?SEV_EPRINT(&quot;Failed setting tos:&quot;
<a name="22551"/>22551:                                                &quot;   ~p&quot;, [Reason]),
<a name="22552"/>22552:                                    ERROR
<a name="22553"/>22553:                            end
<a name="22554"/>22554:                    end},
<a name="22555"/>22555:          #{desc =&gt; &quot;get tos (expect &quot; ++ TOS4Str ++ &quot;)&quot;,
<a name="22556"/>22556:            cmd  =&gt; fun(#{sock := Sock, get := Get} = _State) -&gt;
<a name="22557"/>22557:                            case Get(Sock) of
<a name="22558"/>22558:                                {ok, TOS4 = Value} -&gt;
<a name="22559"/>22559:                                    ?SEV_IPRINT(&quot;expected tos (~p)&quot;, [Value]),
<a name="22560"/>22560:                                    ok;
<a name="22561"/>22561:                                {ok, Unexpected} -&gt;
<a name="22562"/>22562:                                    ?SEV_EPRINT(&quot;Unexpected tos: ~p&quot;,
<a name="22563"/>22563:                                                [Unexpected]),
<a name="22564"/>22564:                                    {error, {unexpected, Unexpected}};
<a name="22565"/>22565:                                {error, Reason} = ERROR -&gt;
<a name="22566"/>22566:                                    ?SEV_EPRINT(&quot;Failed getting (default) tos:&quot;
<a name="22567"/>22567:                                                &quot;   ~p&quot;, [Reason]),
<a name="22568"/>22568:                                    ERROR
<a name="22569"/>22569:                            end
<a name="22570"/>22570:                    end},
<a name="22571"/>22571: 
<a name="22572"/>22572:          #{desc =&gt; &quot;set tos &quot; ++ TOS5Str,
<a name="22573"/>22573:            cmd  =&gt; fun(#{sock := Sock, set := Set} = _State) -&gt;
<a name="22574"/>22574:                            case Set(Sock, TOS5) of
<a name="22575"/>22575:                                ok -&gt;
<a name="22576"/>22576:                                    ?SEV_IPRINT(&quot;tos set to ~p&quot;, [TOS5]),
<a name="22577"/>22577:                                    ok;
<a name="22578"/>22578:                                {error, Reason} = ERROR -&gt;
<a name="22579"/>22579:                                    ?SEV_EPRINT(&quot;Failed setting tos:&quot;
<a name="22580"/>22580:                                                &quot;   ~p&quot;, [Reason]),
<a name="22581"/>22581:                                    ERROR
<a name="22582"/>22582:                            end
<a name="22583"/>22583:                    end},
<a name="22584"/>22584:          #{desc =&gt; &quot;get tos (expect &quot; ++ TOS5Str ++ &quot;)&quot;,
<a name="22585"/>22585:            cmd  =&gt; fun(#{sock := Sock, get := Get} = _State) -&gt;
<a name="22586"/>22586:                            case Get(Sock) of
<a name="22587"/>22587:                                {ok, TOS5 = Value} -&gt;
<a name="22588"/>22588:                                    ?SEV_IPRINT(&quot;expected tos (~p)&quot;, [Value]),
<a name="22589"/>22589:                                    ok;
<a name="22590"/>22590:                                {ok, Unexpected} -&gt;
<a name="22591"/>22591:                                    ?SEV_EPRINT(&quot;Unexpected tos: ~p&quot;,
<a name="22592"/>22592:                                                [Unexpected]),
<a name="22593"/>22593:                                    {error, {unexpected, Unexpected}};
<a name="22594"/>22594:                                {error, Reason} = ERROR -&gt;
<a name="22595"/>22595:                                    ?SEV_EPRINT(&quot;Failed getting (default) tos:&quot;
<a name="22596"/>22596:                                                &quot;   ~p&quot;, [Reason]),
<a name="22597"/>22597:                                    ERROR
<a name="22598"/>22598:                            end
<a name="22599"/>22599:                    end},
<a name="22600"/>22600: 
<a name="22601"/>22601:          #{desc =&gt; &quot;close socket&quot;,
<a name="22602"/>22602:            cmd  =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="22603"/>22603:                            ok = socket:close(Sock),
<a name="22604"/>22604:                            {ok, maps:remove(sock, State)}
<a name="22605"/>22605:                    end},
<a name="22606"/>22606: 
<a name="22607"/>22607:          %% *** We are done ***
<a name="22608"/>22608:          ?SEV_FINISH_NORMAL
<a name="22609"/>22609:         ],
<a name="22610"/>22610:     Evaluator = ?SEV_START(&quot;tester&quot;, Seq, InitState),
<a name="api_opt_ip_tos_udp-last_expr"/><a name="22611"/>22611: <b>    ok = ?SEV_AWAIT_FINISH</b>([Evaluator]).
<a name="22612"/>22612: 
<a name="22613"/>22613: 
<a name="22614"/>22614: 
<a name="22615"/>22615: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="22616"/>22616: 
<a name="22617"/>22617: <i>%% Tests the ip socket option 'recverr' can be set and that the error</i>
<a name="22618"/>22618: <i>%% queue can be read.</i>
<a name="22619"/>22619: <i>%% </i>
<a name="22620"/>22620: 
<a name="api_opt_ip_recverr_udp4-1"/><a name="22621"/>22621: <b>api_opt_ip_recverr_udp4</b>(Config) when is_list(Config) -&gt;
<a name="22622"/>22622:     ?TT(?SECS(5)),
<a name="api_opt_ip_recverr_udp4-last_expr"/><a name="22623"/>22623: <b>    tc_try</b>(api_opt_ip_recverr_udp4,
<a name="22624"/>22624:            fun() -&gt;
<a name="22625"/>22625:                    has_support_ipv4(),
<a name="22626"/>22626:                    has_support_ip_recverr()
<a name="22627"/>22627:            end,
<a name="22628"/>22628:            fun() -&gt;
<a name="22629"/>22629:                    Set  = fun(Sock, Key, Value) -&gt;
<a name="22630"/>22630:                                   socket:setopt(Sock, ip, Key, Value)
<a name="22631"/>22631:                           end,
<a name="22632"/>22632:                    Get  = fun(Sock, Key) -&gt;
<a name="22633"/>22633:                                   socket:getopt(Sock, ip, Key)
<a name="22634"/>22634:                           end,
<a name="22635"/>22635:                    Send = fun(Sock, Data, Dest, Tmo) -&gt;
<a name="22636"/>22636:                                   socket:sendto(Sock, Data, Dest, [], Tmo)
<a name="22637"/>22637:                           end,
<a name="22638"/>22638:                    Recv = fun(Sock, Tmo) -&gt;
<a name="22639"/>22639:                                   socket:recvfrom(Sock, 0, [], Tmo)
<a name="22640"/>22640:                           end,
<a name="22641"/>22641:                    InitState = #{domain =&gt; inet,
<a name="22642"/>22642:                                  proto  =&gt; udp,
<a name="22643"/>22643:                                  send   =&gt; Send,
<a name="22644"/>22644:                                  recv   =&gt; Recv,
<a name="22645"/>22645:                                  set    =&gt; Set,
<a name="22646"/>22646:                                  get    =&gt; Get},
<a name="22647"/>22647:                    ok = api_opt_recverr_udp(Config, InitState)
<a name="22648"/>22648:            end).
<a name="22649"/>22649: 
<a name="22650"/>22650: 
<a name="22651"/>22651: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="22652"/>22652: 
<a name="22653"/>22653: <i>%% Tests the ipv6 socket option 'recverr' can be set and that the error</i>
<a name="22654"/>22654: <i>%% queue can be read.</i>
<a name="22655"/>22655: <i>%% </i>
<a name="22656"/>22656: 
<a name="api_opt_ipv6_recverr_udp6-1"/><a name="22657"/>22657: <b>api_opt_ipv6_recverr_udp6</b>(Config) when is_list(Config) -&gt;
<a name="22658"/>22658:     ?TT(?SECS(5)),
<a name="api_opt_ipv6_recverr_udp6-last_expr"/><a name="22659"/>22659: <b>    tc_try</b>(api_opt_ipv6_recverr_udp6,
<a name="22660"/>22660:            fun() -&gt;
<a name="22661"/>22661:                    has_support_ipv6(),
<a name="22662"/>22662:                    has_support_ipv6_recverr()
<a name="22663"/>22663:            end,
<a name="22664"/>22664:            fun() -&gt;
<a name="22665"/>22665:                    Set  = fun(Sock, Key, Value) -&gt;
<a name="22666"/>22666:                                   socket:setopt(Sock, ipv6, Key, Value)
<a name="22667"/>22667:                           end,
<a name="22668"/>22668:                    Get  = fun(Sock, Key) -&gt;
<a name="22669"/>22669:                                   socket:getopt(Sock, ipv6, Key)
<a name="22670"/>22670:                           end,
<a name="22671"/>22671:                    Send = fun(Sock, Data, Dest, Tmo) -&gt;
<a name="22672"/>22672:                                   socket:sendto(Sock, Data, Dest, [], Tmo)
<a name="22673"/>22673:                           end,
<a name="22674"/>22674:                    Recv = fun(Sock, Tmo) -&gt;
<a name="22675"/>22675:                                   socket:recvfrom(Sock, 0, [], Tmo)
<a name="22676"/>22676:                           end,
<a name="22677"/>22677:                    InitState = #{domain =&gt; inet6,
<a name="22678"/>22678:                                  proto  =&gt; udp,
<a name="22679"/>22679:                                  send   =&gt; Send,
<a name="22680"/>22680:                                  recv   =&gt; Recv,
<a name="22681"/>22681:                                  set    =&gt; Set,
<a name="22682"/>22682:                                  get    =&gt; Get},
<a name="22683"/>22683:                    ok = api_opt_recverr_udp(Config, InitState)
<a name="22684"/>22684:            end).
<a name="22685"/>22685: 
<a name="22686"/>22686: 
<a name="22687"/>22687: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="22688"/>22688: 
<a name="api_opt_recverr_udp-2"/><a name="22689"/>22689: <b>api_opt_recverr_udp</b>(Config, InitState) -&gt;
<a name="22690"/>22690:     Seq = 
<a name="22691"/>22691:         [
<a name="22692"/>22692:          #{desc =&gt; &quot;create socket&quot;,
<a name="22693"/>22693:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="22694"/>22694:                            ?SEV_IPRINT(&quot;test for ip:recvtos&quot;),
<a name="22695"/>22695:                            case socket:open(Domain, dgram, udp) of
<a name="22696"/>22696:                                {ok, Sock} -&gt;
<a name="22697"/>22697:                                    {ok, State#{sock =&gt; Sock}};
<a name="22698"/>22698:                                {error, _} = ERROR -&gt; 
<a name="22699"/>22699:                                    ERROR
<a name="22700"/>22700:                            end
<a name="22701"/>22701:                    end},
<a name="22702"/>22702:          #{desc =&gt; &quot;bind (to loopback)&quot;,
<a name="22703"/>22703:            cmd  =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="22704"/>22704:                            case socket:bind(Sock, loopback) of
<a name="22705"/>22705:                                ok -&gt;
<a name="22706"/>22706:                                    case socket:sockname(Sock) of
<a name="22707"/>22707:                                        {ok, Addr} -&gt;
<a name="22708"/>22708:                                            ?SEV_IPRINT(
<a name="22709"/>22709:                                               &quot;bound to ~p&quot;, [Addr]),
<a name="22710"/>22710:                                            {ok, State#{addr =&gt; Addr}};
<a name="22711"/>22711:                                        {error, _} = ERROR_1 -&gt;
<a name="22712"/>22712:                                            ERROR_1
<a name="22713"/>22713:                                    end;
<a name="22714"/>22714:                                {error, _} = ERROR_2 -&gt;
<a name="22715"/>22715:                                    ERROR_2
<a name="22716"/>22716:                            end
<a name="22717"/>22717:                    end},
<a name="22718"/>22718: 
<a name="22719"/>22719:          #{desc =&gt; &quot;enable recverr&quot;,
<a name="22720"/>22720:            cmd  =&gt; fun(#{sock := Sock, set := Set} = _State) -&gt;
<a name="22721"/>22721:                            Set(Sock, recverr, true)
<a name="22722"/>22722:                    end},
<a name="22723"/>22723: 
<a name="22724"/>22724:          #{desc =&gt; &quot;disable mtu_discover&quot;,
<a name="22725"/>22725:            cmd  =&gt; fun(#{sock := Sock, set := Set} = _State) -&gt;
<a name="22726"/>22726:                            Set(Sock, mtu_discover, dont)
<a name="22727"/>22727:                    end},
<a name="22728"/>22728: 
<a name="22729"/>22729:          #{desc =&gt; &quot;try (async) read (=&gt; select)&quot;,
<a name="22730"/>22730:            cmd  =&gt; fun(#{sock := Sock,
<a name="22731"/>22731:                          recv := Recv} = State) -&gt;
<a name="22732"/>22732:                            RecvRef = nowait(Config),
<a name="22733"/>22733:                            case Recv(Sock, RecvRef) of
<a name="22734"/>22734:                                {select, SelectInfo} when RecvRef =:= nowait -&gt;
<a name="22735"/>22735:                                    ?SEV_IPRINT(&quot;expected select nowait: &quot;
<a name="22736"/>22736: 					       &quot;~n   ~p&quot;, [SelectInfo]),
<a name="22737"/>22737:                                    {ok, State#{async_tag =&gt; select,
<a name="22738"/>22738:                                                rselect   =&gt; SelectInfo}};
<a name="22739"/>22739:                                {select,
<a name="22740"/>22740:                                 {select_info, _Tag, RecvRef} = SelectInfo}
<a name="22741"/>22741:                                  when is_reference(RecvRef) -&gt;
<a name="22742"/>22742:                                    ?SEV_IPRINT(&quot;expected select ref: &quot;
<a name="22743"/>22743: 					       &quot;~n   ~p&quot;, [SelectInfo]),
<a name="22744"/>22744:                                    {ok, State#{async_tag =&gt; select,
<a name="22745"/>22745:                                                rselect   =&gt; SelectInfo}};
<a name="22746"/>22746: 
<a name="22747"/>22747:                                {completion, CI} when RecvRef =:= nowait -&gt;
<a name="22748"/>22748:                                    ?SEV_IPRINT(&quot;expected completion nowait: &quot;
<a name="22749"/>22749: 					       &quot;~n   ~p&quot;, [CI]),
<a name="22750"/>22750:                                    {ok, State#{asynch_tag  =&gt; completion,
<a name="22751"/>22751:                                                rcompletion =&gt; CI}};
<a name="22752"/>22752:                                {completion,
<a name="22753"/>22753:                                 {completion_info, _Tag, RecvRef} = CI}
<a name="22754"/>22754:                                  when is_reference(RecvRef) -&gt;
<a name="22755"/>22755:                                    ?SEV_IPRINT(&quot;expected completion ref: &quot;
<a name="22756"/>22756: 					       &quot;~n   ~p&quot;, [CI]),
<a name="22757"/>22757:                                    {ok, State#{asynch_tag  =&gt; completion,
<a name="22758"/>22758:                                                rcompletion =&gt; CI}};
<a name="22759"/>22759: 
<a name="22760"/>22760:                                {ok, _} -&gt;
<a name="22761"/>22761:                                    ?SEV_EPRINT(&quot;unexpected success&quot;),
<a name="22762"/>22762:                                    {error, unexpected_success};
<a name="22763"/>22763: 
<a name="22764"/>22764:                                {error, Reason} = ERROR -&gt;
<a name="22765"/>22765:                                    ?SEV_EPRINT(&quot;unexpected error: ~p&quot;, [Reason]),
<a name="22766"/>22766:                                    ERROR
<a name="22767"/>22767:                            end
<a name="22768"/>22768:                    end},
<a name="22769"/>22769: 
<a name="22770"/>22770:          #{desc =&gt; &quot;try send to nowhere&quot;,
<a name="22771"/>22771:            cmd  =&gt; fun(#{domain := Domain,
<a name="22772"/>22772:                          sock   := Sock,
<a name="22773"/>22773:                          send   := Send} = State) -&gt;
<a name="22774"/>22774:                            SendRef = nowait(Config),
<a name="22775"/>22775:                            Dest = #{family =&gt; Domain,
<a name="22776"/>22776:                                     addr   =&gt; if
<a name="22777"/>22777:                                                   (Domain =:= inet) -&gt;
<a name="22778"/>22778:                                                       {127,0,0,1};
<a name="22779"/>22779:                                                   (Domain =:= inet6) -&gt;
<a name="22780"/>22780:                                                       {0,0,0,0,0,0,0,1}
<a name="22781"/>22781:                                               end,
<a name="22782"/>22782:                                     port   =&gt; 44444},
<a name="22783"/>22783:                            case Send(Sock, &lt;&lt;&quot;ping&quot;&gt;&gt;, Dest, SendRef) of
<a name="22784"/>22784:                                ok -&gt;
<a name="22785"/>22785:                                    ?SEV_IPRINT(&quot;sent&quot;),
<a name="22786"/>22786:                                    {ok, State#{sent =&gt; true}};
<a name="22787"/>22787: 
<a name="22788"/>22788:                                {select, SelectInfo}
<a name="22789"/>22789:                                  when SendRef =:= nowait -&gt;
<a name="22790"/>22790:                                    ?SEV_IPRINT(&quot;expected select nowait: ~p&quot;,
<a name="22791"/>22791: 					       [SelectInfo]),
<a name="22792"/>22792:                                    {ok, State#{sent       =&gt; false,
<a name="22793"/>22793:                                                asynch_tag =&gt; select,
<a name="22794"/>22794:                                                sselect    =&gt; SelectInfo}};
<a name="22795"/>22795:                                {select,
<a name="22796"/>22796:                                 {select_info, _Tag, SendRef} = SelectInfo}
<a name="22797"/>22797:                                  when is_reference(SendRef) -&gt;
<a name="22798"/>22798:                                    ?SEV_IPRINT(&quot;expected select ref: ~p&quot;,
<a name="22799"/>22799: 					       [SelectInfo]),
<a name="22800"/>22800:                                    {ok, State#{sent       =&gt; false,
<a name="22801"/>22801:                                                asynch_tag =&gt; select,
<a name="22802"/>22802:                                                sselect    =&gt; SelectInfo}};
<a name="22803"/>22803: 
<a name="22804"/>22804:                                {completion, CI}
<a name="22805"/>22805:                                  when SendRef =:= nowait -&gt;
<a name="22806"/>22806:                                    ?SEV_IPRINT(&quot;expected completion nowait: ~p&quot;,
<a name="22807"/>22807: 					       [CI]),
<a name="22808"/>22808:                                    {ok, State#{sent       =&gt; false,
<a name="22809"/>22809:                                                asynch_tag  =&gt; completion,
<a name="22810"/>22810:                                                scompletion =&gt; CI}};
<a name="22811"/>22811:                                {completion,
<a name="22812"/>22812:                                 {completion_info, _Tag, SendRef} = CI}
<a name="22813"/>22813:                                  when is_reference(SendRef) -&gt;
<a name="22814"/>22814:                                    ?SEV_IPRINT(&quot;expected completion ref: ~p&quot;,
<a name="22815"/>22815: 					       [CI]),
<a name="22816"/>22816:                                    {ok, State#{sent       =&gt; false,
<a name="22817"/>22817:                                                asynch_tag  =&gt; completion,
<a name="22818"/>22818:                                                scompletion =&gt; CI}};
<a name="22819"/>22819: 
<a name="22820"/>22820:                                {error, Reason} = ERROR -&gt;
<a name="22821"/>22821:                                    ?SEV_EPRINT(&quot;unexpected error: ~p&quot;,
<a name="22822"/>22822: 					       [Reason]),
<a name="22823"/>22823:                                    ERROR
<a name="22824"/>22824:                            end
<a name="22825"/>22825:                    end},
<a name="22826"/>22826: 
<a name="22827"/>22827:          #{desc =&gt; &quot;await receive select|completion message&quot;,
<a name="22828"/>22828:            cmd  =&gt; fun(#{sent       := false,
<a name="22829"/>22829:                          asynch_tag := select,
<a name="22830"/>22830:                          sock       := Sock,
<a name="22831"/>22831:                          rselect    := {select_info, _, Ref}} = _State) -&gt;
<a name="22832"/>22832:                            receive
<a name="22833"/>22833:                                {'$socket', Sock, select, Ref} -&gt;
<a name="22834"/>22834:                                    ?SEV_IPRINT(&quot;received expected (read) &quot;
<a name="22835"/>22835:                                                &quot;select message: &quot;
<a name="22836"/>22836:                                                &quot;~n   ~p&quot;, [Ref]),
<a name="22837"/>22837:                                    ok
<a name="22838"/>22838:                            end;
<a name="22839"/>22839:                       (#{sent        := false,
<a name="22840"/>22840:                          asynch_tag  := completion,
<a name="22841"/>22841:                          sock        := Sock,
<a name="22842"/>22842:                          rcompletion := {completion_info, _, Ref}} = _State) -&gt;
<a name="22843"/>22843:                            receive
<a name="22844"/>22844:                                {'$socket', Sock, completion,
<a name="22845"/>22845:                                 {Ref, {error, econnrefused = Reason}}} -&gt;
<a name="22846"/>22846:                                    ?SEV_IPRINT(&quot;expected failure: ~p&quot;,
<a name="22847"/>22847:                                                [Reason]),
<a name="22848"/>22848:                                    ok;
<a name="22849"/>22849: 
<a name="22850"/>22850:                                {'$socket', Sock, completion,
<a name="22851"/>22851:                                 {Ref, {ok, _}}} -&gt;
<a name="22852"/>22852:                                    ?SEV_EPRINT(&quot;unexpected success&quot;),
<a name="22853"/>22853:                                    {error, unexpected_success};
<a name="22854"/>22854:                                {'$socket', Sock, completion,
<a name="22855"/>22855:                                 {Ref, {error, Reason} = ERROR}} -&gt;
<a name="22856"/>22856:                                    ?SEV_IPRINT(&quot;unexpected failure: ~p&quot;,
<a name="22857"/>22857:                                                [Reason]),
<a name="22858"/>22858:                                    ERROR
<a name="22859"/>22859: 
<a name="22860"/>22860:                            end;
<a name="22861"/>22861:                       (#{sent := true} = _State) -&gt;
<a name="22862"/>22862:                            ?SEV_IPRINT(&quot;no action needed&quot;),
<a name="22863"/>22863:                            ok
<a name="22864"/>22864:                    end},
<a name="22865"/>22865: 
<a name="22866"/>22866:          #{desc =&gt; &quot;try recv - expect econnrefused&quot;,
<a name="22867"/>22867:            cmd  =&gt; fun(#{asynch_tag := completion} = _State) -&gt;
<a name="22868"/>22868:                            ?SEV_IPRINT(&quot;already processed&quot;),
<a name="22869"/>22869:                            ok;
<a name="22870"/>22870:                       (#{sock := Sock,
<a name="22871"/>22871:                          recv := Recv} = _State) -&gt;
<a name="22872"/>22872:                            case Recv(Sock, infinity) of
<a name="22873"/>22873:                                {error, econnrefused = Reason} -&gt;
<a name="22874"/>22874:                                    ?SEV_IPRINT(&quot;expected failure: ~p&quot;,
<a name="22875"/>22875:                                                [Reason]),
<a name="22876"/>22876:                                    ok;
<a name="22877"/>22877:                                {ok, _} -&gt;
<a name="22878"/>22878:                                    ?SEV_EPRINT(&quot;unexpected success&quot;),
<a name="22879"/>22879:                                    {error, unexpected_success};
<a name="22880"/>22880:                                {select, SelectInfo} -&gt;
<a name="22881"/>22881:                                    ?SEV_EPRINT(&quot;unexpected select: ~p&quot;,
<a name="22882"/>22882:                                                [SelectInfo]),
<a name="22883"/>22883:                                    {error, unexpected_success};
<a name="22884"/>22884:                                {error, Reason} = ERROR -&gt;
<a name="22885"/>22885:                                    ?SEV_EPRINT(&quot;unexpected error: ~p&quot;,
<a name="22886"/>22886:                                                [Reason]),
<a name="22887"/>22887:                                    ERROR
<a name="22888"/>22888:                            end
<a name="22889"/>22889:                    end},
<a name="22890"/>22890: 
<a name="22891"/>22891:          #{desc =&gt; &quot;send to self&quot;,
<a name="22892"/>22892:            cmd  =&gt;
<a name="22893"/>22893:                fun(#{sock := Sock,
<a name="22894"/>22894:                      send := Send,
<a name="22895"/>22895:                      addr := Addr} = _State) -&gt;
<a name="22896"/>22896:                        case Send(Sock, &lt;&lt;&quot;ring&quot;&gt;&gt;, Addr, infinity) of
<a name="22897"/>22897:                            ok -&gt;
<a name="22898"/>22898:                                ?SEV_IPRINT(&quot;sent to self&quot;),
<a name="22899"/>22899:                                ok;
<a name="22900"/>22900:                            {error, _} = Error -&gt;
<a name="22901"/>22901:                                Error
<a name="22902"/>22902:                        end
<a name="22903"/>22903:                end},
<a name="22904"/>22904: 
<a name="22905"/>22905:          #{desc =&gt; &quot;try recv - expect data sent to self&quot;,
<a name="22906"/>22906:            cmd  =&gt; fun(#{sock := Sock,
<a name="22907"/>22907:                          addr := Addr,
<a name="22908"/>22908:                          recv := Recv} = _State) -&gt;
<a name="22909"/>22909:                            case Recv(Sock, infinity) of
<a name="22910"/>22910:                                {ok, {Addr, &lt;&lt;&quot;ring&quot;&gt;&gt;}} -&gt;
<a name="22911"/>22911:                                    ?SEV_IPRINT(&quot;receive expected&quot;),
<a name="22912"/>22912:                                    ok;
<a name="22913"/>22913: 
<a name="22914"/>22914:                                {select, SelectInfo} -&gt;
<a name="22915"/>22915:                                    ?SEV_EPRINT(&quot;unexpected select: ~p&quot;,
<a name="22916"/>22916:                                                [SelectInfo]),
<a name="22917"/>22917:                                    {error, unexpected_success};
<a name="22918"/>22918: 
<a name="22919"/>22919:                                {completion, CompletionInfo} -&gt;
<a name="22920"/>22920:                                    ?SEV_EPRINT(&quot;unexpected completion: ~p&quot;,
<a name="22921"/>22921:                                                [CompletionInfo]),
<a name="22922"/>22922:                                    {error, unexpected_success};
<a name="22923"/>22923: 
<a name="22924"/>22924:                                {error, Reason} = ERROR -&gt;
<a name="22925"/>22925:                                    ?SEV_EPRINT(&quot;unexpected error: ~p&quot;,
<a name="22926"/>22926:                                                [Reason]),
<a name="22927"/>22927:                                    ERROR
<a name="22928"/>22928:                            end
<a name="22929"/>22929:                    end},
<a name="22930"/>22930: 
<a name="22931"/>22931:          #{desc =&gt; &quot;try recv error queue&quot;,
<a name="22932"/>22932:            cmd  =&gt; fun(#{domain := Domain, sock := Sock} = State) -&gt;
<a name="22933"/>22933:                            %% Note that not all platforms that support
<a name="22934"/>22934:                            %% recverr, actually supports &quot;encoding&quot; the data
<a name="22935"/>22935:                            %% part, so we need to adjust for that.
<a name="22936"/>22936: 			   Origin = 
<a name="22937"/>22937: 			       if (Domain =:= inet)  -&gt; icmp;
<a name="22938"/>22938: 				  (Domain =:= inet6) -&gt; icmp6
<a name="22939"/>22939: 			       end,
<a name="22940"/>22940: 			   Level =
<a name="22941"/>22941: 			       if (Domain =:= inet)  -&gt; ip;
<a name="22942"/>22942: 				  (Domain =:= inet6) -&gt; ipv6
<a name="22943"/>22943: 			       end,
<a name="22944"/>22944:                            case socket:recvmsg(Sock, [errqueue], 0) of
<a name="22945"/>22945:                                {ok, #{addr  := #{family := Domain,
<a name="22946"/>22946: 						 addr   := Addr},
<a name="22947"/>22947:                                       flags := [errqueue],
<a name="22948"/>22948:                                       iov   := [&lt;&lt;&quot;ping&quot;&gt;&gt;],
<a name="22949"/>22949:                                       ctrl  := [#{level := Level,
<a name="22950"/>22950:                                                   type  := recverr,
<a name="22951"/>22951:                                                   value :=
<a name="22952"/>22952:                                                       #{code     := port_unreach,
<a name="22953"/>22953:                                                         data     := 0,
<a name="22954"/>22954:                                                         error    := econnrefused,
<a name="22955"/>22955:                                                         info     := 0,
<a name="22956"/>22956:                                                         offender := #{family := Domain,
<a name="22957"/>22957: 								      addr   := Addr},
<a name="22958"/>22958:                                                         origin   := Origin,
<a name="22959"/>22959:                                                         type     := dest_unreach}
<a name="22960"/>22960:                                                  }]} = Msg} -&gt;
<a name="22961"/>22961:                                    ?SEV_IPRINT(&quot;expected error queue (decoded): &quot;
<a name="22962"/>22962:                                                &quot;~n   ~p&quot;, [Msg]),
<a name="22963"/>22963:                                    {ok, State#{asynch_tag =&gt; none}};
<a name="22964"/>22964:                                {ok, #{addr  := #{family := Domain,
<a name="22965"/>22965: 						 addr   := _Addr},
<a name="22966"/>22966:                                       flags := [errqueue],
<a name="22967"/>22967:                                       iov   := [&lt;&lt;&quot;ping&quot;&gt;&gt;],
<a name="22968"/>22968:                                       value := [#{level := Level,
<a name="22969"/>22969:                                                   type  := recverr}]} = _Msg} -&gt;
<a name="22970"/>22970:                                    ?SEV_IPRINT(&quot;expected error queue&quot;),
<a name="22971"/>22971:                                    {ok, State#{asynch_tag =&gt; none}};
<a name="22972"/>22972: 
<a name="22973"/>22973:                                {completion, CI} -&gt;
<a name="22974"/>22974:                                    ?SEV_IPRINT(&quot;completion: &quot;
<a name="22975"/>22975:                                                &quot;~n   ~p&quot;, [CI]),
<a name="22976"/>22976:                                    {ok, State#{asynch_tag =&gt; completion,
<a name="22977"/>22977:                                                completion =&gt; CI}};
<a name="22978"/>22978: 
<a name="22979"/>22979:                                {error, timeout = Reason} = ERROR -&gt;
<a name="22980"/>22980:                                    case os:type() of
<a name="22981"/>22981:                                        {win32, nt} -&gt;
<a name="22982"/>22982:                                            ?SEV_IPRINT(&quot;failed reading &quot;
<a name="22983"/>22983:                                                        &quot;error queue: &quot;
<a name="22984"/>22984:                                                        &quot;~n   ~p&quot;, [Reason]),
<a name="22985"/>22985:                                            {skip,
<a name="22986"/>22986:                                             &quot;Test case does not &quot;
<a name="22987"/>22987:                                             &quot;work on Windows&quot;};
<a name="22988"/>22988:                                        _ -&gt;
<a name="22989"/>22989:                                            ?SEV_EPRINT(&quot;failed reading &quot;
<a name="22990"/>22990:                                                        &quot;error queue: &quot;
<a name="22991"/>22991:                                                        &quot;~n   ~p&quot;, [Reason]),
<a name="22992"/>22992:                                            ERROR
<a name="22993"/>22993:                                    end;
<a name="22994"/>22994: 
<a name="22995"/>22995:                                {error, Reason} = ERROR -&gt;
<a name="22996"/>22996:                                    ?SEV_EPRINT(&quot;failed reading error queue: &quot;
<a name="22997"/>22997:                                                &quot;~n   ~p&quot;, [Reason]),
<a name="22998"/>22998:                                    ERROR
<a name="22999"/>22999:                            end
<a name="23000"/>23000:                    end},
<a name="23001"/>23001: 
<a name="23002"/>23002:          #{desc =&gt; &quot;await receive select message&quot;,
<a name="23003"/>23003:            cmd  =&gt; fun(#{asynch_tag := completion,
<a name="23004"/>23004:                          sock       := Sock,
<a name="23005"/>23005:                          completion := {completion_info, _, Ref}} = _State) -&gt;
<a name="23006"/>23006:                            receive
<a name="23007"/>23007:                                {'$socket', Sock, completion,
<a name="23008"/>23008:                                 {Ref, {ok, Info}}} -&gt;
<a name="23009"/>23009:                                    ?SEV_EPRINT(&quot;expected success: &quot;
<a name="23010"/>23010:                                                &quot;~n   ~p&quot;, [Info]),
<a name="23011"/>23011:                                    ok;
<a name="23012"/>23012: 
<a name="23013"/>23013:                                {'$socket', Sock, completion,
<a name="23014"/>23014:                                 {Ref, {error, Reason} = ERROR}} -&gt;
<a name="23015"/>23015:                                    ?SEV_IPRINT(&quot;unexpected failure: ~p&quot;,
<a name="23016"/>23016:                                                [Reason]),
<a name="23017"/>23017:                                    ERROR
<a name="23018"/>23018: 
<a name="23019"/>23019:                            end;
<a name="23020"/>23020:                       (#{asynch_tag := none} = _State) -&gt;
<a name="23021"/>23021:                            ?SEV_IPRINT(&quot;no action needed&quot;),
<a name="23022"/>23022:                            ok
<a name="23023"/>23023:                    end},
<a name="23024"/>23024: 
<a name="23025"/>23025:          #{desc =&gt; &quot;close socket&quot;,
<a name="23026"/>23026:            cmd  =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="23027"/>23027:                            ok = socket:close(Sock),
<a name="23028"/>23028:                            {ok, maps:remove(sock, State)}
<a name="23029"/>23029:                    end},
<a name="23030"/>23030: 
<a name="23031"/>23031:          %% *** We are done ***
<a name="23032"/>23032:          ?SEV_FINISH_NORMAL
<a name="23033"/>23033:         ],
<a name="23034"/>23034:     Evaluator = ?SEV_START(&quot;tester&quot;, Seq, InitState),
<a name="api_opt_recverr_udp-last_expr"/><a name="23035"/>23035: <b>    ok = ?SEV_AWAIT_FINISH</b>([Evaluator]).
<a name="23036"/>23036: 
<a name="23037"/>23037: 
<a name="23038"/>23038: 
<a name="23039"/>23039: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="23040"/>23040: 
<a name="23041"/>23041: <i>%% This intended to test &quot;all&quot; of the (currently) supported IPv4</i>
<a name="23042"/>23042: <i>%% options that results in control message header(s).</i>
<a name="23043"/>23043: <i>%% So, this is done on the receiving side:</i>
<a name="23044"/>23044: <i>%%</i>
<a name="23045"/>23045: <i>%%      socket:setopt(Sock, ip, Flag, boolean()).</i>
<a name="23046"/>23046: <i>%%</i>
<a name="23047"/>23047: <i>%% For all subsequent *received* messages, a control message header</i>
<a name="23048"/>23048: <i>%% for each of the enabled options will be received with the message.</i>
<a name="23049"/>23049: <i>%%</i>
<a name="23050"/>23050: <i>%% Only allowed for dgram and raw,</i>
<a name="23051"/>23051: <i>%% although we only test this with dgram.</i>
<a name="23052"/>23052: <i>%%</i>
<a name="23053"/>23053: <i>%% Currently we *try* to use the following opts:</i>
<a name="23054"/>23054: <i>%%</i>
<a name="23055"/>23055: <i>%%      pktinfo         =&gt; pktinfo</i>
<a name="23056"/>23056: <i>%%      recvorigdstaddr =&gt; origdstaddr</i>
<a name="23057"/>23057: <i>%%      recvtos         =&gt; tos</i>
<a name="23058"/>23058: <i>%%      recvttl         =&gt; ttl</i>
<a name="23059"/>23059: <i>%%</i>
<a name="23060"/>23060: <i>%%</i>
<a name="23061"/>23061: <i>%% Every time we add a test case for a new option (that results in</i>
<a name="23062"/>23062: <i>%% a control message hedare), we should also add it here.</i>
<a name="23063"/>23063: <i>%%</i>
<a name="23064"/>23064: <i>%% Even though this is a IPv4 test case, we add the 'socket' timestamp</i>
<a name="23065"/>23065: <i>%% option (just to fill up), but in the test to see if we should run</i>
<a name="23066"/>23066: <i>%% the test (since its a IPv4 test case).</i>
<a name="23067"/>23067: <i>%%</i>
<a name="23068"/>23068: 
<a name="api_opt_ip_mopts_udp4-1"/><a name="23069"/>23069: <b>api_opt_ip_mopts_udp4</b>(_Config) when is_list(_Config) -&gt;
<a name="23070"/>23070:     ?TT(?SECS(5)),
<a name="api_opt_ip_mopts_udp4-last_expr"/><a name="23071"/>23071: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="23072"/>23072:            fun() -&gt;
<a name="23073"/>23073:                    has_support_ipv4(),
<a name="23074"/>23074:                    Opts =
<a name="23075"/>23075:                        [{ip, pktinfo},
<a name="23076"/>23076:                         {ip, recvorigdstaddr}] ++
<a name="23077"/>23077:                        case os:type() of
<a name="23078"/>23078:                            {win32, nt} -&gt;
<a name="23079"/>23079:                                [];
<a name="23080"/>23080:                            _ -&gt;
<a name="23081"/>23081:                                [{ip, recvtos},
<a name="23082"/>23082:                                 {ip, recvttl}]
<a name="23083"/>23083:                        end,
<a name="23084"/>23084: 		   case is_any_options_supported(Opts) of
<a name="23085"/>23085: 		       true -&gt;
<a name="23086"/>23086: 			   ok;
<a name="23087"/>23087: 		       false -&gt;
<a name="23088"/>23088: 			   skip(&quot;None of the needed options are supported&quot;)
<a name="23089"/>23089: 		   end
<a name="23090"/>23090:            end,
<a name="23091"/>23091:            fun() -&gt;
<a name="23092"/>23092: 		   %% If we get this far, we *know* that at least one of the
<a name="23093"/>23093: 		   %% options are available.
<a name="23094"/>23094: 
<a name="23095"/>23095: 		   %% This is list of all the options and there resulting
<a name="23096"/>23096: 		   %% control message header type(s):
<a name="23097"/>23097: 		   %%   [{level,
<a name="23098"/>23098: 		   %%     'ipv6 socket option',
<a name="23099"/>23099:                    %%     'control message header type',
<a name="23100"/>23100: 		   %%     default | value()}]
<a name="23101"/>23101: 		   Opts =
<a name="23102"/>23102: 		       case socket:is_supported(options, socket, timestamp) of
<a name="23103"/>23103: 			   true -&gt;
<a name="23104"/>23104: 			       [{socket, timestamp, timestamp, default}];
<a name="23105"/>23105: 			   false -&gt;
<a name="23106"/>23106: 			       []
<a name="23107"/>23107: 		       end ++
<a name="23108"/>23108: 		       case socket:is_supported(options, ip, pktinfo) of
<a name="23109"/>23109: 			   true -&gt;
<a name="23110"/>23110: 			       [{ip, pktinfo, pktinfo, default}];
<a name="23111"/>23111: 			   false -&gt;
<a name="23112"/>23112: 			       []
<a name="23113"/>23113: 		       end ++
<a name="23114"/>23114: 		       case socket:is_supported(options, ip, recvorigdstaddr) of
<a name="23115"/>23115: 			   true -&gt;
<a name="23116"/>23116: 			       [{ip, recvorigdstaddr, origdstaddr, default}];
<a name="23117"/>23117: 			   false -&gt;
<a name="23118"/>23118: 			       []
<a name="23119"/>23119: 		       end ++
<a name="23120"/>23120:                        case os:type() of
<a name="23121"/>23121:                            {win32, nt} -&gt;
<a name="23122"/>23122:                                [];
<a name="23123"/>23123:                            _ -&gt;
<a name="23124"/>23124:                                case socket:is_supported(options, ip, recvtos) of
<a name="23125"/>23125:                                    true -&gt;
<a name="23126"/>23126:                                        %% It seems that sending any of the
<a name="23127"/>23127:                                        %% TOS or TTL values will fail on: 
<a name="23128"/>23128:                                        %%    FreeBSD
<a name="23129"/>23129:                                        %%    Linux when
<a name="23130"/>23130:                                        %%      version =&lt; 3.12.60 (at least)
<a name="23131"/>23131:                                        %%      Don't know when this starts
<a name="23132"/>23132:                                        %%      working, but it works on: 
<a name="23133"/>23133:                                        %%         Ubunto 16.04.6 =&gt; 4.15.0-65
<a name="23134"/>23134:                                        %%         SLES 12 SP2 =&gt; 4.4.120-92.70
<a name="23135"/>23135:                                        %% so don't!
<a name="23136"/>23136:                                        %%
<a name="23137"/>23137:                                        %% The latest we know it not to work
<a name="23138"/>23138:                                        %% was a SLES 12 (plain) at 3.12.50-52.54
<a name="23139"/>23139:                                        %%
<a name="23140"/>23140:                                        [{ip, recvtos, tos, 
<a name="23141"/>23141:                                          case os:type() of
<a name="23142"/>23142:                                              {unix, freebsd} -&gt;
<a name="23143"/>23143:                                                  default;
<a name="23144"/>23144:                                              {unix, linux} -&gt;
<a name="23145"/>23145:                                                  case os:version() of
<a name="23146"/>23146:                                                      Vsn when Vsn &gt; {3,12,60} -&gt;
<a name="23147"/>23147:                                                          42;
<a name="23148"/>23148:                                                      _ -&gt;
<a name="23149"/>23149:                                                          default
<a name="23150"/>23150:                                                  end;
<a name="23151"/>23151:                                              _ -&gt; 
<a name="23152"/>23152:                                                  42
<a name="23153"/>23153:                                          end}];
<a name="23154"/>23154:                                    false -&gt;
<a name="23155"/>23155:                                        []
<a name="23156"/>23156:                                end
<a name="23157"/>23157: 		       end ++
<a name="23158"/>23158:                        case os:type() of
<a name="23159"/>23159:                            {unix, darwin} -&gt;
<a name="23160"/>23160:                                [];
<a name="23161"/>23161:                            {win32, nt} -&gt;
<a name="23162"/>23162:                                [];
<a name="23163"/>23163:                            _ -&gt;
<a name="23164"/>23164:                                case socket:is_supported(options, ip, recvttl) of
<a name="23165"/>23165:                                    true -&gt;
<a name="23166"/>23166: 				       %% It seems that sending any of the
<a name="23167"/>23167: 				       %% TOS or TTL values will fail on: 
<a name="23168"/>23168: 				       %%    FreeBSD and NetBSD
<a name="23169"/>23169: 				       %%    Linux when
<a name="23170"/>23170: 				       %%      version =&lt; 3.12.60 (at least)
<a name="23171"/>23171: 				       %% so don't!
<a name="23172"/>23172:                                        %% See recvtos above for more info.
<a name="23173"/>23173:                                        [{ip, recvttl, ttl,
<a name="23174"/>23174:                                          case os:type() of
<a name="23175"/>23175:                                              {unix, BSD} 
<a name="23176"/>23176:                                                when (BSD =:= freebsd) orelse
<a name="23177"/>23177:                                                     (BSD =:= netbsd) -&gt;
<a name="23178"/>23178:                                                  default;
<a name="23179"/>23179:                                              {unix, netbsd} -&gt;
<a name="23180"/>23180:                                                  default;
<a name="23181"/>23181: 					     {unix, linux} -&gt;
<a name="23182"/>23182: 						 case os:version() of
<a name="23183"/>23183: 						     Vsn when Vsn &gt; {3,12,60} -&gt;
<a name="23184"/>23184: 							 42;
<a name="23185"/>23185: 						     _ -&gt;
<a name="23186"/>23186: 							 default
<a name="23187"/>23187: 						 end;
<a name="23188"/>23188:                                              _ -&gt; 
<a name="23189"/>23189:                                                  42
<a name="23190"/>23190:                                          end}];
<a name="23191"/>23191:                                    false -&gt;
<a name="23192"/>23192:                                        []
<a name="23193"/>23193:                                end
<a name="23194"/>23194: 		       end,
<a name="23195"/>23195: 
<a name="23196"/>23196:                    Enable = fun(Sock, Level, Opt) -&gt;
<a name="23197"/>23197: 				    ?SEV_IPRINT(&quot;try enable [~w] ~p&quot;,
<a name="23198"/>23198:                                                 [Level, Opt]),
<a name="23199"/>23199: 				    socket:setopt(Sock, Level, Opt, true)
<a name="23200"/>23200:                             end,
<a name="23201"/>23201:                    Send = fun(Sock, Data, Dest, []) -&gt;
<a name="23202"/>23202:                                   Msg = #{addr =&gt; Dest,
<a name="23203"/>23203:                                           iov  =&gt; [Data]},
<a name="23204"/>23204:                                   socket:sendmsg(Sock, Msg);
<a name="23205"/>23205: 			     (Sock, Data, Dest, Hdrs) when is_list(Hdrs) -&gt;
<a name="23206"/>23206: 				  CMsgs = [#{level =&gt; Level,
<a name="23207"/>23207:                                              type  =&gt; Type,
<a name="23208"/>23208:                                              value =&gt; Val} ||
<a name="23209"/>23209:                                               {Level, Type, Val} &lt;- Hdrs],
<a name="23210"/>23210:                                   Msg   = #{addr =&gt; Dest,
<a name="23211"/>23211:                                             ctrl =&gt; CMsgs,
<a name="23212"/>23212:                                             iov  =&gt; [Data]},
<a name="23213"/>23213:                                   socket:sendmsg(Sock, Msg)
<a name="23214"/>23214:                           end,
<a name="23215"/>23215:                    Recv = fun(Sock) -&gt;
<a name="23216"/>23216:                                   case socket:recvmsg(Sock) of
<a name="23217"/>23217:                                       {ok, #{addr := Source,
<a name="23218"/>23218:                                              ctrl := CMsgs,
<a name="23219"/>23219:                                              iov  := [Data]}} -&gt;
<a name="23220"/>23220:                                           {ok, {Source, CMsgs, Data}};
<a name="23221"/>23221:                                       {error, _} = ERROR -&gt;
<a name="23222"/>23222:                                           ERROR
<a name="23223"/>23223:                                   end
<a name="23224"/>23224:                           end,
<a name="23225"/>23225:                    InitState = #{domain =&gt; inet,
<a name="23226"/>23226:                                  proto  =&gt; udp,
<a name="23227"/>23227: 				 opts   =&gt; Opts,
<a name="23228"/>23228:                                  send   =&gt; Send,
<a name="23229"/>23229:                                  recv   =&gt; Recv,
<a name="23230"/>23230:                                  enable =&gt; Enable},
<a name="23231"/>23231:                    ok = api_opt_ip_mopts_udp(InitState)
<a name="23232"/>23232:            end).
<a name="23233"/>23233: 
<a name="23234"/>23234: 
<a name="23235"/>23235: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="23236"/>23236: 
<a name="api_opt_ip_mopts_udp-1"/><a name="23237"/>23237: <b>api_opt_ip_mopts_udp</b>(InitState) -&gt;
<a name="23238"/>23238:     Seq = 
<a name="23239"/>23239:         [
<a name="23240"/>23240:          #{desc =&gt; &quot;local address&quot;,
<a name="23241"/>23241:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="23242"/>23242:                            LSA = which_local_socket_addr(Domain),
<a name="23243"/>23243:                            {ok, State#{lsa_src =&gt; LSA,
<a name="23244"/>23244:                                        lsa_dst =&gt; LSA}}
<a name="23245"/>23245:                    end},
<a name="23246"/>23246: 
<a name="23247"/>23247:          #{desc =&gt; &quot;open src socket&quot;,
<a name="23248"/>23248:            cmd  =&gt; fun(#{domain := Domain,
<a name="23249"/>23249:                          proto  := Proto} = State) -&gt;
<a name="23250"/>23250:                            Sock = sock_open(Domain, dgram, Proto),
<a name="23251"/>23251:                            {ok, State#{sock_src =&gt; Sock}}
<a name="23252"/>23252:                    end},
<a name="23253"/>23253:          #{desc =&gt; &quot;bind src&quot;,
<a name="23254"/>23254:            cmd  =&gt; fun(#{sock_src := Sock, lsa_src := LSA}) -&gt;
<a name="23255"/>23255:                            case sock_bind(Sock, LSA) of
<a name="23256"/>23256:                                ok -&gt;
<a name="23257"/>23257:                                    ?SEV_IPRINT(&quot;src bound&quot;),
<a name="23258"/>23258:                                    ok;
<a name="23259"/>23259:                                {error, Reason} = ERROR -&gt;
<a name="23260"/>23260:                                    ?SEV_EPRINT(&quot;src bind failed: ~p&quot;, [Reason]),
<a name="23261"/>23261:                                    ERROR
<a name="23262"/>23262:                            end
<a name="23263"/>23263:                    end},
<a name="23264"/>23264:          #{desc =&gt; &quot;sockname src socket&quot;,
<a name="23265"/>23265:            cmd  =&gt; fun(#{sock_src := Sock} = State) -&gt;
<a name="23266"/>23266:                            SASrc = sock_sockname(Sock),
<a name="23267"/>23267:                            ?SEV_IPRINT(&quot;src sockaddr: &quot;
<a name="23268"/>23268:                                        &quot;~n   ~p&quot;, [SASrc]),
<a name="23269"/>23269:                            {ok, State#{sa_src =&gt; SASrc}}
<a name="23270"/>23270:                    end},
<a name="23271"/>23271: 
<a name="23272"/>23272:          #{desc =&gt; &quot;open dst socket&quot;,
<a name="23273"/>23273:            cmd  =&gt; fun(#{domain := Domain,
<a name="23274"/>23274:                          proto  := Proto} = State) -&gt;
<a name="23275"/>23275:                            Sock = sock_open(Domain, dgram, Proto),
<a name="23276"/>23276:                            {ok, State#{sock_dst =&gt; Sock}}
<a name="23277"/>23277:                    end},
<a name="23278"/>23278:          #{desc =&gt; &quot;bind dst&quot;,
<a name="23279"/>23279:            cmd  =&gt; fun(#{sock_dst := Sock, lsa_dst := LSA}) -&gt;
<a name="23280"/>23280:                            case sock_bind(Sock, LSA) of
<a name="23281"/>23281:                                ok -&gt;
<a name="23282"/>23282:                                    ?SEV_IPRINT(&quot;src bound&quot;),
<a name="23283"/>23283:                                    ok;
<a name="23284"/>23284:                                {error, Reason} = ERROR -&gt;
<a name="23285"/>23285:                                    ?SEV_EPRINT(&quot;src bind failed: ~p&quot;, [Reason]),
<a name="23286"/>23286:                                    ERROR
<a name="23287"/>23287:                            end
<a name="23288"/>23288:                    end},
<a name="23289"/>23289:          #{desc =&gt; &quot;sockname dst socket&quot;,
<a name="23290"/>23290:            cmd  =&gt; fun(#{sock_dst := Sock} = State) -&gt;
<a name="23291"/>23291:                            SADst = sock_sockname(Sock),
<a name="23292"/>23292:                            ?SEV_IPRINT(&quot;dst sockaddr: &quot;
<a name="23293"/>23293:                                        &quot;~n   ~p&quot;, [SADst]),
<a name="23294"/>23294:                            {ok, State#{sa_dst =&gt; SADst}}
<a name="23295"/>23295:                    end},
<a name="23296"/>23296: 
<a name="23297"/>23297:          #{desc =&gt; &quot;enable options on dst socket&quot;,
<a name="23298"/>23298:            cmd  =&gt; fun(#{sock_dst := DSock,
<a name="23299"/>23299: 			 sock_src := SSock,
<a name="23300"/>23300: 			 opts     := Opts,
<a name="23301"/>23301: 			 enable   := Enable} = _State) -&gt;
<a name="23302"/>23302: 			   %% If we fail to enable *any* of the options,
<a name="23303"/>23303: 			   %% we give up.
<a name="23304"/>23304: 			   E = fun({Level, Opt, _, _}) -&gt; 
<a name="23305"/>23305:                                        case Enable(DSock, Level, Opt) of
<a name="23306"/>23306:                                            ok -&gt;
<a name="23307"/>23307:                                                ?SEV_IPRINT(&quot;dst [~w] ~w enabled&quot;,
<a name="23308"/>23308:                                                            [Level, Opt]),
<a name="23309"/>23309:                                                ok;
<a name="23310"/>23310:                                            {error, enoprotoopt = Reason} -&gt;
<a name="23311"/>23311:                                                ?SEV_EPRINT(&quot;Expected &quot;
<a name="23312"/>23312:                                                            &quot;Failure: &quot;
<a name="23313"/>23313:                                                            &quot;~p =&gt; SKIP&quot;,
<a name="23314"/>23314:                                                            [Reason]),
<a name="23315"/>23315:                                                (catch socket:close(DSock)),
<a name="23316"/>23316:                                                (catch socket:close(SSock)),
<a name="23317"/>23317:                                                {skip, Reason};
<a name="23318"/>23318:                                            {error, Reason} = ERROR -&gt;
<a name="23319"/>23319:                                                ?SEV_EPRINT(&quot;Failed &quot;
<a name="23320"/>23320:                                                            &quot;setting ~w:&quot;
<a name="23321"/>23321:                                                            &quot;   ~p&quot;,
<a name="23322"/>23322:                                                            [Opt, Reason]),
<a name="23323"/>23323:                                                throw(ERROR)
<a name="23324"/>23324:                                        end
<a name="23325"/>23325: 			       end,
<a name="23326"/>23326: 			   lists:foreach(E, Opts),
<a name="23327"/>23327: 			   ok
<a name="23328"/>23328:                    end},
<a name="23329"/>23329: 
<a name="23330"/>23330:          #{desc =&gt; &quot;send req (to dst)&quot;,
<a name="23331"/>23331:            cmd  =&gt; fun(#{sock_src := Sock,
<a name="23332"/>23332: 			 sa_dst   := Dst,
<a name="23333"/>23333: 			 opts     := Opts,
<a name="23334"/>23334: 			 send     := Send}) -&gt;
<a name="23335"/>23335: 			   Hdrs = [{Level, Type, Data} ||
<a name="23336"/>23336: 				      {Level, _, Type, Data} &lt;- 
<a name="23337"/>23337: 					  Opts, (Data =/= default)],
<a name="23338"/>23338:                            Send(Sock, ?BASIC_REQ, Dst, Hdrs)
<a name="23339"/>23339:                    end},
<a name="23340"/>23340:          #{desc =&gt; &quot;recv req (from src)&quot;,
<a name="23341"/>23341:            cmd  =&gt; fun(#{sock_dst := Sock,
<a name="23342"/>23342: 			 sa_src   := Src,
<a name="23343"/>23343: 			 recv     := Recv,
<a name="23344"/>23344: 			 opts     := Opts}) -&gt;
<a name="23345"/>23345:                            case Recv(Sock) of
<a name="23346"/>23346:                                {ok, {Src, CMsgs, ?BASIC_REQ}}
<a name="23347"/>23347:                                  when length(CMsgs) =:= length(Opts)  -&gt;
<a name="23348"/>23348:                                    ?SEV_IPRINT(&quot;Got (expected) cmsg headers: &quot;
<a name="23349"/>23349: 					       &quot;~n   ~p&quot;, [CMsgs]),
<a name="23350"/>23350: 				   %% We should really verify the headers:
<a name="23351"/>23351: 				   %% values, types and so on...
<a name="23352"/>23352:                                    ok;
<a name="23353"/>23353:                                {ok, {BadSrc, BadCHdrs, BadReq} = UnexpData} -&gt;
<a name="23354"/>23354:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="23355"/>23355:                                                &quot;~n   Expect Source: ~p&quot;
<a name="23356"/>23356:                                                &quot;~n   Recv Source:   ~p&quot;
<a name="23357"/>23357:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="23358"/>23358:                                                &quot;~n   Recv CHdrs:    ~p&quot;
<a name="23359"/>23359:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="23360"/>23360:                                                &quot;~n   Recv Msg:      ~p&quot;,
<a name="23361"/>23361:                                                [Src, BadSrc,
<a name="23362"/>23362:                                                 [{Level, Type} ||
<a name="23363"/>23363:                                                     {Level, _, Type, _} &lt;- Opts],
<a name="23364"/>23364: 						BadCHdrs,
<a name="23365"/>23365: 						?BASIC_REQ, BadReq]),
<a name="23366"/>23366:                                    {error, {unexpected_data, UnexpData}};
<a name="23367"/>23367:                                {ok, UnexpData} -&gt;
<a name="23368"/>23368:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="23369"/>23369:                                                &quot;~n   Expect Source: ~p&quot;
<a name="23370"/>23370:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="23371"/>23371:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="23372"/>23372:                                                &quot;~n   Unexp Data:    ~p&quot;,
<a name="23373"/>23373:                                                [Src,
<a name="23374"/>23374:                                                 [{Level, Type} ||
<a name="23375"/>23375:                                                     {Level, _, Type, _} &lt;- Opts],
<a name="23376"/>23376: 						?BASIC_REQ,
<a name="23377"/>23377:                                                 UnexpData]),
<a name="23378"/>23378:                                    {error, {unexpected_data, UnexpData}};
<a name="23379"/>23379:                                {error, _} = ERROR -&gt;
<a name="23380"/>23380:                                    %% At the moment there is no way to get
<a name="23381"/>23381:                                    %% status or state for the socket...
<a name="23382"/>23382:                                    ERROR
<a name="23383"/>23383:                            end
<a name="23384"/>23384:                    end},
<a name="23385"/>23385: 
<a name="23386"/>23386:          #{desc =&gt; &quot;close src socket&quot;,
<a name="23387"/>23387:            cmd  =&gt; fun(#{sock_src := Sock} = State) -&gt;
<a name="23388"/>23388:                            ok = socket:close(Sock),
<a name="23389"/>23389:                            {ok, maps:remove(sock_src, State)}
<a name="23390"/>23390:                    end},
<a name="23391"/>23391:          #{desc =&gt; &quot;close dst socket&quot;,
<a name="23392"/>23392:            cmd  =&gt; fun(#{sock_dst := Sock} = State) -&gt;
<a name="23393"/>23393:                            ok = socket:close(Sock),
<a name="23394"/>23394:                            {ok, maps:remove(sock_dst, State)}
<a name="23395"/>23395:                    end},
<a name="23396"/>23396: 
<a name="23397"/>23397:          %% *** We are done ***
<a name="23398"/>23398:          ?SEV_FINISH_NORMAL
<a name="23399"/>23399:         ],
<a name="23400"/>23400:     Evaluator = ?SEV_START(&quot;tester&quot;, Seq, InitState),
<a name="api_opt_ip_mopts_udp-last_expr"/><a name="23401"/>23401: <b>    ok = ?SEV_AWAIT_FINISH</b>([Evaluator]).
<a name="23402"/>23402: 
<a name="23403"/>23403: 
<a name="23404"/>23404: 
<a name="23405"/>23405: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="23406"/>23406: 
<a name="23407"/>23407: <i>%% Tests that the IPv6 pktinfo control message header is received on</i>
<a name="23408"/>23408: <i>%% incoming datagrams (UDP and RAW) when setting the socket 'ipv6'</i>
<a name="23409"/>23409: <i>%% option recvpktinfo is set to true when using.</i>
<a name="23410"/>23410: <i>%% So, this is done on the receiving side: </i>
<a name="23411"/>23411: <i>%%</i>
<a name="23412"/>23412: <i>%%               socket:setopt(Sock, ipv6, recvpktinfo, boolean()).</i>
<a name="23413"/>23413: <i>%%</i>
<a name="23414"/>23414: <i>%% For all subsequent *received* messages, the pktinfo control message</i>
<a name="23415"/>23415: <i>%% header will be with the message.</i>
<a name="23416"/>23416: <i>%%</i>
<a name="23417"/>23417: <i>%% Only allowed for dgram and raw,</i>
<a name="23418"/>23418: <i>%% although we only test this with dgram.</i>
<a name="23419"/>23419: <i>%%</i>
<a name="23420"/>23420: 
<a name="api_opt_ipv6_recvpktinfo_udp6-1"/><a name="23421"/>23421: <b>api_opt_ipv6_recvpktinfo_udp6</b>(_Config) when is_list(_Config) -&gt;
<a name="23422"/>23422:     ?TT(?SECS(5)),
<a name="api_opt_ipv6_recvpktinfo_udp6-last_expr"/><a name="23423"/>23423: <b>    tc_try</b>(api_opt_ipv6_recvpktinfo_udp6,
<a name="23424"/>23424:            fun() -&gt;
<a name="23425"/>23425:                    has_support_ipv6(),
<a name="23426"/>23426:                    has_support_ipv6_recvpktinfo()
<a name="23427"/>23427:            end,
<a name="23428"/>23428:            fun() -&gt;
<a name="23429"/>23429:                    Set  = fun(Sock, Value) -&gt;
<a name="23430"/>23430:                                   socket:setopt(Sock, ipv6, recvpktinfo, Value)
<a name="23431"/>23431:                           end,
<a name="23432"/>23432:                    Get  = fun(Sock) -&gt;
<a name="23433"/>23433:                                   socket:getopt(Sock, ipv6, recvpktinfo)
<a name="23434"/>23434:                           end,
<a name="23435"/>23435:                    Send = fun(Sock, Data, Dest, default) -&gt;
<a name="23436"/>23436:                                   Msg = #{addr =&gt; Dest,
<a name="23437"/>23437:                                              iov  =&gt; [Data]},
<a name="23438"/>23438:                                   socket:sendmsg(Sock, Msg);
<a name="23439"/>23439:                              (Sock, Data, Dest, Info) -&gt;
<a name="23440"/>23440:                                   %% We do not support this at the moment!!!
<a name="23441"/>23441:                                   CMsg = #{level =&gt; ipv6,
<a name="23442"/>23442:                                               type  =&gt; pktinfo,
<a name="23443"/>23443:                                               data  =&gt; Info},
<a name="23444"/>23444:                                   Msg  = #{addr =&gt; Dest,
<a name="23445"/>23445:                                               ctrl =&gt; [CMsg],
<a name="23446"/>23446:                                               iov  =&gt; [Data]},
<a name="23447"/>23447:                                   socket:sendmsg(Sock, Msg)
<a name="23448"/>23448:                           end,
<a name="23449"/>23449:                    Recv = fun(Sock) -&gt;
<a name="23450"/>23450:                                   case socket:recvmsg(Sock) of
<a name="23451"/>23451:                                       {ok, #{addr := Source,
<a name="23452"/>23452:                                              ctrl := CMsgs,
<a name="23453"/>23453:                                              iov  := [Data]}} -&gt;
<a name="23454"/>23454:                                           {ok, {Source, CMsgs, Data}};
<a name="23455"/>23455:                                       {error, _} = ERROR -&gt;
<a name="23456"/>23456:                                           ERROR
<a name="23457"/>23457:                                   end
<a name="23458"/>23458:                           end,
<a name="23459"/>23459:                    InitState = #{domain =&gt; inet6,
<a name="23460"/>23460:                                  proto  =&gt; udp,
<a name="23461"/>23461:                                  send   =&gt; Send,
<a name="23462"/>23462:                                  recv   =&gt; Recv,
<a name="23463"/>23463:                                  set    =&gt; Set,
<a name="23464"/>23464:                                  get    =&gt; Get},
<a name="23465"/>23465:                    ok = api_opt_ipv6_recvpktinfo_udp(InitState)
<a name="23466"/>23466:            end).
<a name="23467"/>23467: 
<a name="23468"/>23468: 
<a name="23469"/>23469: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="23470"/>23470: 
<a name="api_opt_ipv6_recvpktinfo_udp-1"/><a name="23471"/>23471: <b>api_opt_ipv6_recvpktinfo_udp</b>(InitState) -&gt;
<a name="23472"/>23472:     Seq = 
<a name="23473"/>23473:         [
<a name="23474"/>23474:          #{desc =&gt; &quot;local address&quot;,
<a name="23475"/>23475:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="23476"/>23476:                            LSA = which_local_socket_addr(Domain),
<a name="23477"/>23477:                            {ok, State#{lsa_src =&gt; LSA,
<a name="23478"/>23478:                                        lsa_dst =&gt; LSA}}
<a name="23479"/>23479:                    end},
<a name="23480"/>23480: 
<a name="23481"/>23481:          #{desc =&gt; &quot;open src socket&quot;,
<a name="23482"/>23482:            cmd  =&gt; fun(#{domain := Domain,
<a name="23483"/>23483:                          proto  := Proto} = State) -&gt;
<a name="23484"/>23484:                            Sock = sock_open(Domain, dgram, Proto),
<a name="23485"/>23485:                            {ok, State#{sock_src =&gt; Sock}}
<a name="23486"/>23486:                    end},
<a name="23487"/>23487:          #{desc =&gt; &quot;bind src&quot;,
<a name="23488"/>23488:            cmd  =&gt; fun(#{sock_src := Sock, lsa_src := LSA}) -&gt;
<a name="23489"/>23489:                            case sock_bind(Sock, LSA) of
<a name="23490"/>23490:                                ok -&gt;
<a name="23491"/>23491:                                    ?SEV_IPRINT(&quot;src bound&quot;),
<a name="23492"/>23492:                                    ok;
<a name="23493"/>23493:                                {error, Reason} = ERROR -&gt;
<a name="23494"/>23494:                                    ?SEV_EPRINT(&quot;src bind failed: ~p&quot;, [Reason]),
<a name="23495"/>23495:                                    ERROR
<a name="23496"/>23496:                            end
<a name="23497"/>23497:                    end},
<a name="23498"/>23498:          #{desc =&gt; &quot;sockname src socket&quot;,
<a name="23499"/>23499:            cmd  =&gt; fun(#{sock_src := Sock} = State) -&gt;
<a name="23500"/>23500:                            SASrc = sock_sockname(Sock),
<a name="23501"/>23501:                            ?SEV_IPRINT(&quot;src sockaddr: &quot;
<a name="23502"/>23502:                                        &quot;~n   ~p&quot;, [SASrc]),
<a name="23503"/>23503:                            {ok, State#{sa_src =&gt; SASrc}}
<a name="23504"/>23504:                    end},
<a name="23505"/>23505: 
<a name="23506"/>23506:          #{desc =&gt; &quot;open dst socket&quot;,
<a name="23507"/>23507:            cmd  =&gt; fun(#{domain := Domain,
<a name="23508"/>23508:                          proto  := Proto} = State) -&gt;
<a name="23509"/>23509:                            Sock = sock_open(Domain, dgram, Proto),
<a name="23510"/>23510:                            {ok, State#{sock_dst =&gt; Sock}}
<a name="23511"/>23511:                    end},
<a name="23512"/>23512:          #{desc =&gt; &quot;bind dst&quot;,
<a name="23513"/>23513:            cmd  =&gt; fun(#{sock_dst := Sock, lsa_dst := LSA}) -&gt;
<a name="23514"/>23514:                            case sock_bind(Sock, LSA) of
<a name="23515"/>23515:                                ok -&gt;
<a name="23516"/>23516:                                    ?SEV_IPRINT(&quot;src bound&quot;),
<a name="23517"/>23517:                                    ok;
<a name="23518"/>23518:                                {error, Reason} = ERROR -&gt;
<a name="23519"/>23519:                                    ?SEV_EPRINT(&quot;src bind failed: ~p&quot;, [Reason]),
<a name="23520"/>23520:                                    ERROR
<a name="23521"/>23521:                            end
<a name="23522"/>23522:                    end},
<a name="23523"/>23523:          #{desc =&gt; &quot;sockname dst socket&quot;,
<a name="23524"/>23524:            cmd  =&gt; fun(#{sock_dst := Sock} = State) -&gt;
<a name="23525"/>23525:                            SADst = sock_sockname(Sock),
<a name="23526"/>23526:                            ?SEV_IPRINT(&quot;dst sockaddr: &quot;
<a name="23527"/>23527:                                        &quot;~n   ~p&quot;, [SADst]),
<a name="23528"/>23528:                            {ok, State#{sa_dst =&gt; SADst}}
<a name="23529"/>23529:                    end},
<a name="23530"/>23530:          #{desc =&gt; &quot;default pktinfo for dst socket&quot;,
<a name="23531"/>23531:            cmd  =&gt; fun(#{sock_dst := Sock, get := Get} = _State) -&gt;
<a name="23532"/>23532:                            case Get(Sock) of
<a name="23533"/>23533:                                {ok, false = Value} -&gt;
<a name="23534"/>23534:                                    ?SEV_IPRINT(&quot;dst recvttl: ~p&quot;, [Value]),
<a name="23535"/>23535:                                    ok;
<a name="23536"/>23536:                                {ok, Unexpected} -&gt;
<a name="23537"/>23537:                                    ?SEV_EPRINT(&quot;Unexpected src recvtos: ~p&quot;,
<a name="23538"/>23538:                                                [Unexpected]),
<a name="23539"/>23539:                                    {error, {unexpected, Unexpected}};
<a name="23540"/>23540:                                {error, Reason} = ERROR -&gt;
<a name="23541"/>23541:                                    ?SEV_EPRINT(&quot;Failed getting (default) recvtos:&quot;
<a name="23542"/>23542:                                                &quot;   ~p&quot;, [Reason]),
<a name="23543"/>23543:                                    ERROR
<a name="23544"/>23544:                            end
<a name="23545"/>23545:                    end},
<a name="23546"/>23546: 
<a name="23547"/>23547:          #{desc =&gt; &quot;send req (to dst) (wo (explicit) pktinfo)&quot;,
<a name="23548"/>23548:            cmd  =&gt; fun(#{sock_src := Sock, sa_dst := Dst, send := Send}) -&gt;
<a name="23549"/>23549:                            Send(Sock, ?BASIC_REQ, Dst, default)
<a name="23550"/>23550:                    end},
<a name="23551"/>23551:          #{desc =&gt; &quot;recv req (from src)&quot;,
<a name="23552"/>23552:            cmd  =&gt; fun(#{sock_dst := Sock, sa_src := Src, recv := Recv}) -&gt;
<a name="23553"/>23553:                            case Recv(Sock) of
<a name="23554"/>23554:                                {ok, {Src, [], ?BASIC_REQ}} -&gt;
<a name="23555"/>23555:                                    ok;
<a name="23556"/>23556:                                {ok, {BadSrc, BadCHdrs, BadReq} = UnexpData} -&gt;
<a name="23557"/>23557:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="23558"/>23558:                                                &quot;~n   Expect Source: ~p&quot;
<a name="23559"/>23559:                                                &quot;~n   Recv Source:   ~p&quot;
<a name="23560"/>23560:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="23561"/>23561:                                                &quot;~n   Recv CHdrs:    ~p&quot;
<a name="23562"/>23562:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="23563"/>23563:                                                &quot;~n   Recv Msg:      ~p&quot;,
<a name="23564"/>23564:                                                [Src, BadSrc,
<a name="23565"/>23565:                                                 [], BadCHdrs,
<a name="23566"/>23566:                                                 ?BASIC_REQ, BadReq]),
<a name="23567"/>23567:                                    {error, {unexpected_data, UnexpData}};
<a name="23568"/>23568:                                {ok, UnexpData} -&gt;
<a name="23569"/>23569:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="23570"/>23570:                                                &quot;~n   Expect Source: ~p&quot;
<a name="23571"/>23571:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="23572"/>23572:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="23573"/>23573:                                                &quot;~n   Unexp Data:    ~p&quot;,
<a name="23574"/>23574:                                                [Src, [], ?BASIC_REQ, UnexpData]),
<a name="23575"/>23575:                                    {error, {unexpected_data, UnexpData}};
<a name="23576"/>23576:                                {error, _} = ERROR -&gt;
<a name="23577"/>23577:                                    %% At the moment there is no way to get
<a name="23578"/>23578:                                    %% status or state for the socket...
<a name="23579"/>23579:                                    ERROR
<a name="23580"/>23580:                            end
<a name="23581"/>23581:                    end},
<a name="23582"/>23582: 
<a name="23583"/>23583:          #{desc =&gt; &quot;enable pktinfo on dst socket&quot;,
<a name="23584"/>23584:            cmd  =&gt; fun(#{sock_dst := Sock, set := Set} = _State) -&gt;
<a name="23585"/>23585:                            case Set(Sock, true) of
<a name="23586"/>23586:                                ok -&gt;
<a name="23587"/>23587:                                    ?SEV_IPRINT(&quot;dst pktinfo enabled&quot;),
<a name="23588"/>23588:                                    ok;
<a name="23589"/>23589:                                {error, Reason} = ERROR -&gt;
<a name="23590"/>23590:                                    ?SEV_EPRINT(&quot;Failed setting pktinfo:&quot;
<a name="23591"/>23591:                                                &quot;   ~p&quot;, [Reason]),
<a name="23592"/>23592:                                    ERROR
<a name="23593"/>23593:                            end
<a name="23594"/>23594:                    end},
<a name="23595"/>23595: 
<a name="23596"/>23596:          #{desc =&gt; &quot;send req (to dst) (wo explicit pktinfo)&quot;,
<a name="23597"/>23597:            cmd  =&gt; fun(#{sock_src := Sock, sa_dst := Dst, send := Send}) -&gt;
<a name="23598"/>23598:                            Send(Sock, ?BASIC_REQ, Dst, default)
<a name="23599"/>23599:                    end},
<a name="23600"/>23600:          #{desc =&gt; &quot;recv req (from src) - w default pktinfo&quot;,
<a name="23601"/>23601:            cmd  =&gt; fun(#{sock_dst := Sock, sa_src := Src, recv := Recv}) -&gt;
<a name="23602"/>23602:                            case Recv(Sock) of
<a name="23603"/>23603:                                {ok, {Src, [#{level := ipv6,
<a name="23604"/>23604:                                              type  := pktinfo,
<a name="23605"/>23605:                                              value := #{addr    := Addr,
<a name="23606"/>23606:                                                         ifindex := IfIdx}}],
<a name="23607"/>23607:                                      ?BASIC_REQ}} -&gt;
<a name="23608"/>23608:                                    ?SEV_IPRINT(&quot;Got (default) Pkt Info: &quot;
<a name="23609"/>23609:                                                &quot;~n   Addr:      ~p&quot;
<a name="23610"/>23610:                                                &quot;~n   If Index:  ~p&quot;,
<a name="23611"/>23611:                                                [Addr, IfIdx]),
<a name="23612"/>23612:                                    ok;
<a name="23613"/>23613:                                {ok, {BadSrc, BadCHdrs, BadReq} = UnexpData} -&gt;
<a name="23614"/>23614:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="23615"/>23615:                                                &quot;~n   Expect Source: ~p&quot;
<a name="23616"/>23616:                                                &quot;~n   Recv Source:   ~p&quot;
<a name="23617"/>23617:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="23618"/>23618:                                                &quot;~n   Recv CHdrs:    ~p&quot;
<a name="23619"/>23619:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="23620"/>23620:                                                &quot;~n   Recv Msg:      ~p&quot;,
<a name="23621"/>23621:                                                [Src, BadSrc,
<a name="23622"/>23622:                                                 #{level =&gt; ipv6,
<a name="23623"/>23623:                                                   type  =&gt; pktinfo,
<a name="23624"/>23624:                                                   value =&gt; &quot;something&quot;} , BadCHdrs,
<a name="23625"/>23625:                                                 ?BASIC_REQ, BadReq]),
<a name="23626"/>23626:                                    {error, {unexpected_data, UnexpData}};
<a name="23627"/>23627:                                {ok, UnexpData} -&gt;
<a name="23628"/>23628:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="23629"/>23629:                                                &quot;~n   Expect Source: ~p&quot;
<a name="23630"/>23630:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="23631"/>23631:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="23632"/>23632:                                                &quot;~n   Unexp Data:    ~p&quot;,
<a name="23633"/>23633:                                                [Src, [], ?BASIC_REQ, UnexpData]),
<a name="23634"/>23634:                                    {error, {unexpected_data, UnexpData}};
<a name="23635"/>23635:                                {error, _} = ERROR -&gt;
<a name="23636"/>23636:                                    %% At the moment there is no way to get
<a name="23637"/>23637:                                    %% status or state for the socket...
<a name="23638"/>23638:                                    ERROR
<a name="23639"/>23639:                            end
<a name="23640"/>23640:                    end},
<a name="23641"/>23641: 
<a name="23642"/>23642: 
<a name="23643"/>23643:          #{desc =&gt; &quot;close src socket&quot;,
<a name="23644"/>23644:            cmd  =&gt; fun(#{sock_src := Sock} = State) -&gt;
<a name="23645"/>23645:                            ok = socket:close(Sock),
<a name="23646"/>23646:                            {ok, maps:remove(sock_src, State)}
<a name="23647"/>23647:                    end},
<a name="23648"/>23648:          #{desc =&gt; &quot;close dst socket&quot;,
<a name="23649"/>23649:            cmd  =&gt; fun(#{sock_dst := Sock} = State) -&gt;
<a name="23650"/>23650:                            ok = socket:close(Sock),
<a name="23651"/>23651:                            {ok, maps:remove(sock_dst, State)}
<a name="23652"/>23652:                    end},
<a name="23653"/>23653: 
<a name="23654"/>23654:          %% *** We are done ***
<a name="23655"/>23655:          ?SEV_FINISH_NORMAL
<a name="23656"/>23656:         ],
<a name="23657"/>23657:     Evaluator = ?SEV_START(&quot;tester&quot;, Seq, InitState),
<a name="api_opt_ipv6_recvpktinfo_udp-last_expr"/><a name="23658"/>23658: <b>    ok = ?SEV_AWAIT_FINISH</b>([Evaluator]).
<a name="23659"/>23659: 
<a name="23660"/>23660: 
<a name="23661"/>23661: 
<a name="23662"/>23662: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="23663"/>23663: 
<a name="23664"/>23664: <i>%% Tests that the 'flow info' control message header is received when</i>
<a name="23665"/>23665: <i>%% setting the socket 'ipv6' option flowinfo  is set to true when using</i>
<a name="23666"/>23666: <i>%% sendmsg/recvmsg on an IPv6 UDP (dgram) socket.</i>
<a name="23667"/>23667: <i>%% So, this is done on the receiving side: </i>
<a name="23668"/>23668: <i>%%</i>
<a name="23669"/>23669: <i>%%               socket:setopt(Sock, ipv6, flowinfo, boolean()).</i>
<a name="23670"/>23670: <i>%%</i>
<a name="23671"/>23671: <i>%% For all subsequent *received* messages, the 'flow info' control message</i>
<a name="23672"/>23672: <i>%% header will be with the message.</i>
<a name="23673"/>23673: <i>%%</i>
<a name="23674"/>23674: <i>%% Only allowed for dgram and raw,</i>
<a name="23675"/>23675: <i>%% although we only test this with dgram.</i>
<a name="23676"/>23676: <i>%%</i>
<a name="23677"/>23677: <i>%% There seem to be some weirdness with the definition of this</i>
<a name="23678"/>23678: <i>%% option, so its defined in an include file we don't include</i>
<a name="23679"/>23679: <i>%% (directly or indirectly). And since some of the defines</i>
<a name="23680"/>23680: <i>%% occur in a file we *do* include (via netinet/in.h), we</i>
<a name="23681"/>23681: <i>%% leave it as is for now...</i>
<a name="23682"/>23682: <i>%%</i>
<a name="23683"/>23683: 
<a name="api_opt_ipv6_flowinfo_udp6-1"/><a name="23684"/>23684: <b>api_opt_ipv6_flowinfo_udp6</b>(_Config) when is_list(_Config) -&gt;
<a name="23685"/>23685:     ?TT(?SECS(5)),
<a name="api_opt_ipv6_flowinfo_udp6-last_expr"/><a name="23686"/>23686: <b>    tc_try</b>(api_opt_ipv6_flowinfo_udp6,
<a name="23687"/>23687:            fun() -&gt;
<a name="23688"/>23688:                    has_support_ipv6(),
<a name="23689"/>23689:                    has_support_ipv6_flowinfo()
<a name="23690"/>23690:            end,
<a name="23691"/>23691:            fun() -&gt;
<a name="23692"/>23692:                    Set  = fun(Sock, Value) -&gt;
<a name="23693"/>23693:                                   socket:setopt(Sock, ipv6, flowinfo, Value)
<a name="23694"/>23694:                           end,
<a name="23695"/>23695:                    Get  = fun(Sock) -&gt;
<a name="23696"/>23696:                                   socket:getopt(Sock, ipv6, flowinfo)
<a name="23697"/>23697:                           end,
<a name="23698"/>23698:                    Send = fun(Sock, Data, Dest) -&gt;
<a name="23699"/>23699:                                   Msg = #{addr =&gt; Dest,
<a name="23700"/>23700:                                              iov  =&gt; [Data]},
<a name="23701"/>23701:                                   socket:sendmsg(Sock, Msg)
<a name="23702"/>23702:                           end,
<a name="23703"/>23703:                    Recv = fun(Sock) -&gt;
<a name="23704"/>23704:                                   case socket:recvmsg(Sock) of
<a name="23705"/>23705:                                       {ok, #{addr := Source,
<a name="23706"/>23706:                                              ctrl := CMsgs,
<a name="23707"/>23707:                                              iov  := [Data]}} -&gt;
<a name="23708"/>23708:                                           {ok, {Source, CMsgs, Data}};
<a name="23709"/>23709:                                       {error, _} = ERROR -&gt;
<a name="23710"/>23710:                                           ERROR
<a name="23711"/>23711:                                   end
<a name="23712"/>23712:                           end,
<a name="23713"/>23713:                    InitState = #{domain =&gt; inet6,
<a name="23714"/>23714:                                  proto  =&gt; udp,
<a name="23715"/>23715:                                  send   =&gt; Send,
<a name="23716"/>23716:                                  recv   =&gt; Recv,
<a name="23717"/>23717:                                  set    =&gt; Set,
<a name="23718"/>23718:                                  get    =&gt; Get},
<a name="23719"/>23719:                    ok = api_opt_ipv6_flowinfo_udp(InitState)
<a name="23720"/>23720:            end).
<a name="23721"/>23721: 
<a name="23722"/>23722: 
<a name="23723"/>23723: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="23724"/>23724: 
<a name="api_opt_ipv6_flowinfo_udp-1"/><a name="23725"/>23725: <b>api_opt_ipv6_flowinfo_udp</b>(InitState) -&gt;
<a name="23726"/>23726:     Seq = 
<a name="23727"/>23727:         [
<a name="23728"/>23728:          #{desc =&gt; &quot;local address&quot;,
<a name="23729"/>23729:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="23730"/>23730:                            LSA = which_local_socket_addr(Domain),
<a name="23731"/>23731:                            {ok, State#{lsa_src =&gt; LSA,
<a name="23732"/>23732:                                        lsa_dst =&gt; LSA}}
<a name="23733"/>23733:                    end},
<a name="23734"/>23734: 
<a name="23735"/>23735:          #{desc =&gt; &quot;open src socket&quot;,
<a name="23736"/>23736:            cmd  =&gt; fun(#{domain := Domain,
<a name="23737"/>23737:                          proto  := Proto} = State) -&gt;
<a name="23738"/>23738:                            Sock = sock_open(Domain, dgram, Proto),
<a name="23739"/>23739:                            {ok, State#{sock_src =&gt; Sock}}
<a name="23740"/>23740:                    end},
<a name="23741"/>23741:          #{desc =&gt; &quot;bind src&quot;,
<a name="23742"/>23742:            cmd  =&gt; fun(#{sock_src := Sock, lsa_src := LSA}) -&gt;
<a name="23743"/>23743:                            case sock_bind(Sock, LSA) of
<a name="23744"/>23744:                                ok -&gt;
<a name="23745"/>23745:                                    ?SEV_IPRINT(&quot;src bound&quot;),
<a name="23746"/>23746:                                    ok;
<a name="23747"/>23747:                                {error, Reason} = ERROR -&gt;
<a name="23748"/>23748:                                    ?SEV_EPRINT(&quot;src bind failed: ~p&quot;, [Reason]),
<a name="23749"/>23749:                                    ERROR
<a name="23750"/>23750:                            end
<a name="23751"/>23751:                    end},
<a name="23752"/>23752:          #{desc =&gt; &quot;sockname src socket&quot;,
<a name="23753"/>23753:            cmd  =&gt; fun(#{sock_src := Sock} = State) -&gt;
<a name="23754"/>23754:                            SASrc = sock_sockname(Sock),
<a name="23755"/>23755:                            ?SEV_IPRINT(&quot;src sockaddr: &quot;
<a name="23756"/>23756:                                        &quot;~n   ~p&quot;, [SASrc]),
<a name="23757"/>23757:                            {ok, State#{sa_src =&gt; SASrc}}
<a name="23758"/>23758:                    end},
<a name="23759"/>23759: 
<a name="23760"/>23760:          #{desc =&gt; &quot;open dst socket&quot;,
<a name="23761"/>23761:            cmd  =&gt; fun(#{domain := Domain,
<a name="23762"/>23762:                          proto  := Proto} = State) -&gt;
<a name="23763"/>23763:                            Sock = sock_open(Domain, dgram, Proto),
<a name="23764"/>23764:                            {ok, State#{sock_dst =&gt; Sock}}
<a name="23765"/>23765:                    end},
<a name="23766"/>23766:          #{desc =&gt; &quot;bind dst&quot;,
<a name="23767"/>23767:            cmd  =&gt; fun(#{sock_dst := Sock, lsa_dst := LSA}) -&gt;
<a name="23768"/>23768:                            case sock_bind(Sock, LSA) of
<a name="23769"/>23769:                                ok -&gt;
<a name="23770"/>23770:                                    ?SEV_IPRINT(&quot;src bound&quot;),
<a name="23771"/>23771:                                    ok;
<a name="23772"/>23772:                                {error, Reason} = ERROR -&gt;
<a name="23773"/>23773:                                    ?SEV_EPRINT(&quot;src bind failed: ~p&quot;, [Reason]),
<a name="23774"/>23774:                                    ERROR
<a name="23775"/>23775:                            end
<a name="23776"/>23776:                    end},
<a name="23777"/>23777:          #{desc =&gt; &quot;sockname dst socket&quot;,
<a name="23778"/>23778:            cmd  =&gt; fun(#{sock_dst := Sock} = State) -&gt;
<a name="23779"/>23779:                            SADst = sock_sockname(Sock),
<a name="23780"/>23780:                            ?SEV_IPRINT(&quot;dst sockaddr: &quot;
<a name="23781"/>23781:                                        &quot;~n   ~p&quot;, [SADst]),
<a name="23782"/>23782:                            {ok, State#{sa_dst =&gt; SADst}}
<a name="23783"/>23783:                    end},
<a name="23784"/>23784:          #{desc =&gt; &quot;default flowinfo for dst socket&quot;,
<a name="23785"/>23785:            cmd  =&gt; fun(#{sock_dst := Sock, get := Get} = _State) -&gt;
<a name="23786"/>23786:                            case Get(Sock) of
<a name="23787"/>23787:                                {ok, false = Value} -&gt;
<a name="23788"/>23788:                                    ?SEV_IPRINT(&quot;dst flowinfo: ~p&quot;, [Value]),
<a name="23789"/>23789:                                    ok;
<a name="23790"/>23790:                                {ok, Unexpected} -&gt;
<a name="23791"/>23791:                                    ?SEV_EPRINT(&quot;Unexpected src flowinfo: ~p&quot;,
<a name="23792"/>23792:                                                [Unexpected]),
<a name="23793"/>23793:                                    {error, {unexpected, Unexpected}};
<a name="23794"/>23794:                                {error, Reason} = ERROR -&gt;
<a name="23795"/>23795:                                    ?SEV_EPRINT(&quot;Failed getting (default) flowinfo:&quot;
<a name="23796"/>23796:                                                &quot;   ~p&quot;, [Reason]),
<a name="23797"/>23797:                                    ERROR
<a name="23798"/>23798:                            end
<a name="23799"/>23799:                    end},
<a name="23800"/>23800: 
<a name="23801"/>23801:          #{desc =&gt; &quot;send req (to dst)&quot;,
<a name="23802"/>23802:            cmd  =&gt; fun(#{sock_src := Sock, sa_dst := Dst, send := Send}) -&gt;
<a name="23803"/>23803:                            Send(Sock, ?BASIC_REQ, Dst)
<a name="23804"/>23804:                    end},
<a name="23805"/>23805:          #{desc =&gt; &quot;recv req (from src)&quot;,
<a name="23806"/>23806:            cmd  =&gt; fun(#{sock_dst := Sock, sa_src := Src, recv := Recv}) -&gt;
<a name="23807"/>23807:                            case Recv(Sock) of
<a name="23808"/>23808:                                {ok, {Src, [], ?BASIC_REQ}} -&gt;
<a name="23809"/>23809:                                    ok;
<a name="23810"/>23810:                                {ok, {BadSrc, BadCHdrs, BadReq} = UnexpData} -&gt;
<a name="23811"/>23811:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="23812"/>23812:                                                &quot;~n   Expect Source: ~p&quot;
<a name="23813"/>23813:                                                &quot;~n   Recv Source:   ~p&quot;
<a name="23814"/>23814:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="23815"/>23815:                                                &quot;~n   Recv CHdrs:    ~p&quot;
<a name="23816"/>23816:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="23817"/>23817:                                                &quot;~n   Recv Msg:      ~p&quot;,
<a name="23818"/>23818:                                                [Src, BadSrc,
<a name="23819"/>23819:                                                 [], BadCHdrs,
<a name="23820"/>23820:                                                 ?BASIC_REQ, BadReq]),
<a name="23821"/>23821:                                    {error, {unexpected_data, UnexpData}};
<a name="23822"/>23822:                                {ok, UnexpData} -&gt;
<a name="23823"/>23823:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="23824"/>23824:                                                &quot;~n   Expect Source: ~p&quot;
<a name="23825"/>23825:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="23826"/>23826:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="23827"/>23827:                                                &quot;~n   Unexp Data:    ~p&quot;,
<a name="23828"/>23828:                                                [Src, [], ?BASIC_REQ, UnexpData]),
<a name="23829"/>23829:                                    {error, {unexpected_data, UnexpData}};
<a name="23830"/>23830:                                {error, _} = ERROR -&gt;
<a name="23831"/>23831:                                    %% At the moment there is no way to get
<a name="23832"/>23832:                                    %% status or state for the socket...
<a name="23833"/>23833:                                    ERROR
<a name="23834"/>23834:                            end
<a name="23835"/>23835:                    end},
<a name="23836"/>23836: 
<a name="23837"/>23837:          #{desc =&gt; &quot;enable flowinfo on dst socket&quot;,
<a name="23838"/>23838:            cmd  =&gt; fun(#{sock_dst := Sock, set := Set} = _State) -&gt;
<a name="23839"/>23839:                            case Set(Sock, true) of
<a name="23840"/>23840:                                ok -&gt;
<a name="23841"/>23841:                                    ?SEV_IPRINT(&quot;dst flowinfo enabled&quot;),
<a name="23842"/>23842:                                    ok;
<a name="23843"/>23843:                                {error, Reason} = ERROR -&gt;
<a name="23844"/>23844:                                    ?SEV_EPRINT(&quot;Failed setting flowinfo:&quot;
<a name="23845"/>23845:                                                &quot;   ~p&quot;, [Reason]),
<a name="23846"/>23846:                                    ERROR
<a name="23847"/>23847:                            end
<a name="23848"/>23848:                    end},
<a name="23849"/>23849: 
<a name="23850"/>23850:          #{desc =&gt; &quot;send req (to dst)&quot;,
<a name="23851"/>23851:            cmd  =&gt; fun(#{sock_src := Sock, sa_dst := Dst, send := Send}) -&gt;
<a name="23852"/>23852:                            Send(Sock, ?BASIC_REQ, Dst)
<a name="23853"/>23853:                    end},
<a name="23854"/>23854:          #{desc =&gt; &quot;recv req (from src)&quot;,
<a name="23855"/>23855:            cmd  =&gt; fun(#{sock_dst := Sock, sa_src := Src, recv := Recv}) -&gt;
<a name="23856"/>23856:                            case Recv(Sock) of
<a name="23857"/>23857:                                {ok, {Src, [#{level := ipv6,
<a name="23858"/>23858:                                              type  := flowinfo,
<a name="23859"/>23859:                                              value := FlowID}], ?BASIC_REQ}} -&gt;
<a name="23860"/>23860:                                    ?SEV_IPRINT(&quot;Got flow info: &quot;
<a name="23861"/>23861: 					       &quot;~n   Flow ID: ~p&quot;, [FlowID]),
<a name="23862"/>23862:                                    ok;
<a name="23863"/>23863:                                {ok, {BadSrc, BadCHdrs, BadReq} = UnexpData} -&gt;
<a name="23864"/>23864:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="23865"/>23865:                                                &quot;~n   Expect Source: ~p&quot;
<a name="23866"/>23866:                                                &quot;~n   Recv Source:   ~p&quot;
<a name="23867"/>23867:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="23868"/>23868:                                                &quot;~n   Recv CHdrs:    ~p&quot;
<a name="23869"/>23869:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="23870"/>23870:                                                &quot;~n   Recv Msg:      ~p&quot;,
<a name="23871"/>23871:                                                [Src, BadSrc,
<a name="23872"/>23872:                                                 #{level =&gt; ipv6,
<a name="23873"/>23873: 						  type  =&gt; flowinfo,
<a name="23874"/>23874: 						  value =&gt; &quot;something&quot;},
<a name="23875"/>23875: 						BadCHdrs,
<a name="23876"/>23876: 						?BASIC_REQ, BadReq]),
<a name="23877"/>23877:                                    {error, {unexpected_data, UnexpData}};
<a name="23878"/>23878:                                {ok, UnexpData} -&gt;
<a name="23879"/>23879:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="23880"/>23880:                                                &quot;~n   Expect Source: ~p&quot;
<a name="23881"/>23881:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="23882"/>23882:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="23883"/>23883:                                                &quot;~n   Unexp Data:    ~p&quot;,
<a name="23884"/>23884:                                                [Src, [], ?BASIC_REQ, UnexpData]),
<a name="23885"/>23885:                                    {error, {unexpected_data, UnexpData}};
<a name="23886"/>23886:                                {error, _} = ERROR -&gt;
<a name="23887"/>23887:                                    %% At the moment there is no way to get
<a name="23888"/>23888:                                    %% status or state for the socket...
<a name="23889"/>23889:                                    ERROR
<a name="23890"/>23890:                            end
<a name="23891"/>23891:                    end},
<a name="23892"/>23892: 
<a name="23893"/>23893:          #{desc =&gt; &quot;close src socket&quot;,
<a name="23894"/>23894:            cmd  =&gt; fun(#{sock_src := Sock} = State) -&gt;
<a name="23895"/>23895:                            ok = socket:close(Sock),
<a name="23896"/>23896:                            {ok, maps:remove(sock_src, State)}
<a name="23897"/>23897:                    end},
<a name="23898"/>23898:          #{desc =&gt; &quot;close dst socket&quot;,
<a name="23899"/>23899:            cmd  =&gt; fun(#{sock_dst := Sock} = State) -&gt;
<a name="23900"/>23900:                            ok = socket:close(Sock),
<a name="23901"/>23901:                            {ok, maps:remove(sock_dst, State)}
<a name="23902"/>23902:                    end},
<a name="23903"/>23903: 
<a name="23904"/>23904:          %% *** We are done ***
<a name="23905"/>23905:          ?SEV_FINISH_NORMAL
<a name="23906"/>23906:         ],
<a name="23907"/>23907:     Evaluator = ?SEV_START(&quot;tester&quot;, Seq, InitState),
<a name="api_opt_ipv6_flowinfo_udp-last_expr"/><a name="23908"/>23908: <b>    ok = ?SEV_AWAIT_FINISH</b>([Evaluator]).
<a name="23909"/>23909: 
<a name="23910"/>23910: 
<a name="23911"/>23911: 
<a name="23912"/>23912: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="23913"/>23913: 
<a name="23914"/>23914: <i>%% Tests that the 'hop limit' control message header is received when</i>
<a name="23915"/>23915: <i>%% setting the socket 'ipv6' hoplimit or recvhoplimit option is set to </i>
<a name="23916"/>23916: <i>%% true when using sendmsg/recvmsg on an IPv6 UDP (dgram) socket.</i>
<a name="23917"/>23917: <i>%% So, this is done on the receiving side: </i>
<a name="23918"/>23918: <i>%%</i>
<a name="23919"/>23919: <i>%%      socket:setopt(Sock, ipv6, recvhoplimit | hoplimit, boolean()).</i>
<a name="23920"/>23920: <i>%%</i>
<a name="23921"/>23921: <i>%% For all subsequent *received* messages, the 'hop limit' control message</i>
<a name="23922"/>23922: <i>%% header will be with the message.</i>
<a name="23923"/>23923: <i>%% We make the assumption, that if 'recvhoplimit' is supported, then</i>
<a name="23924"/>23924: <i>%% that option is used to order the hoplimit control message, otherwise</i>
<a name="23925"/>23925: <i>%% hoplimit is used.</i>
<a name="23926"/>23926: <i>%%</i>
<a name="23927"/>23927: <i>%% Only allowed for dgram and raw,</i>
<a name="23928"/>23928: <i>%% although we only test this with dgram.</i>
<a name="23929"/>23929: <i>%%</i>
<a name="23930"/>23930: <i>%% &lt;Note&gt;</i>
<a name="23931"/>23931: <i>%%</i>
<a name="23932"/>23932: <i>%% There is also an IPV6_RECVHOPLIMIT option defined in the header</i>
<a name="23933"/>23933: <i>%% file (bits/in.h) with a different value. This is not mentioned</i>
<a name="23934"/>23934: <i>%% in the man page. Deprecated? More testing needed...</i>
<a name="23935"/>23935: <i>%%</i>
<a name="23936"/>23936: <i>%% &lt;/Note&gt;</i>
<a name="23937"/>23937: <i>%%</i>
<a name="23938"/>23938: 
<a name="api_opt_ipv6_hoplimit_udp6-1"/><a name="23939"/>23939: <b>api_opt_ipv6_hoplimit_udp6</b>(_Config) when is_list(_Config) -&gt;
<a name="23940"/>23940:     ?TT(?SECS(5)),
<a name="api_opt_ipv6_hoplimit_udp6-last_expr"/><a name="23941"/>23941: <b>    tc_try</b>(api_opt_ipv6_hoplimit_udp6,
<a name="23942"/>23942:            fun() -&gt;
<a name="23943"/>23943:                    has_support_ipv6(),
<a name="23944"/>23944:                    has_support_ipv6_hoplimit_or_recvhoplimit(),
<a name="23945"/>23945: 		   is_good_enough_darwin({9,8,0}),
<a name="23946"/>23946:                    is_good_enough_montavista(&quot;4.0.1&quot;)
<a name="23947"/>23947:            end,
<a name="23948"/>23948:            fun() -&gt;
<a name="23949"/>23949: 		   %% Begin by choosing which of the options we shall use
<a name="23950"/>23950: 		   Opt = case socket:is_supported(options, ipv6, recvhoplimit) of
<a name="23951"/>23951: 			     true  -&gt; recvhoplimit;
<a name="23952"/>23952: 			     false -&gt; hoplimit
<a name="23953"/>23953: 			 end,
<a name="23954"/>23954:                    Set  = fun(Sock, Value) -&gt;
<a name="23955"/>23955: 				  ?SEV_IPRINT(&quot;try set ~p: ~p&quot;, [Opt, Value]),
<a name="23956"/>23956:                                   socket:setopt(Sock, ipv6, Opt, Value)
<a name="23957"/>23957:                           end,
<a name="23958"/>23958:                    Get  = fun(Sock) -&gt;
<a name="23959"/>23959: 				  ?SEV_IPRINT(&quot;try get ~p&quot;, [Opt]),
<a name="23960"/>23960:                                   socket:getopt(Sock, ipv6, Opt)
<a name="23961"/>23961:                           end,
<a name="23962"/>23962:                    Send = fun(Sock, Data, Dest) -&gt;
<a name="23963"/>23963:                                   Msg = #{addr =&gt; Dest,
<a name="23964"/>23964:                                              iov  =&gt; [Data]},
<a name="23965"/>23965:                                   socket:sendmsg(Sock, Msg)
<a name="23966"/>23966:                           end,
<a name="23967"/>23967:                    Recv = fun(Sock) -&gt;
<a name="23968"/>23968:                                   case socket:recvmsg(Sock) of
<a name="23969"/>23969:                                       {ok, #{addr := Source,
<a name="23970"/>23970:                                              ctrl := CMsgs,
<a name="23971"/>23971:                                              iov  := [Data]}} -&gt;
<a name="23972"/>23972:                                           {ok, {Source, CMsgs, Data}};
<a name="23973"/>23973:                                       {error, _} = ERROR -&gt;
<a name="23974"/>23974:                                           ERROR
<a name="23975"/>23975:                                   end
<a name="23976"/>23976:                           end,
<a name="23977"/>23977:                    InitState = #{domain =&gt; inet6,
<a name="23978"/>23978:                                  proto  =&gt; udp,
<a name="23979"/>23979:                                  send   =&gt; Send,
<a name="23980"/>23980:                                  recv   =&gt; Recv,
<a name="23981"/>23981:                                  set    =&gt; Set,
<a name="23982"/>23982:                                  get    =&gt; Get},
<a name="23983"/>23983:                    ok = api_opt_ipv6_hoplimit_udp(InitState)
<a name="23984"/>23984:            end).
<a name="23985"/>23985: 
<a name="23986"/>23986: 
<a name="23987"/>23987: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="23988"/>23988: 
<a name="api_opt_ipv6_hoplimit_udp-1"/><a name="23989"/>23989: <b>api_opt_ipv6_hoplimit_udp</b>(InitState) -&gt;
<a name="23990"/>23990:     Seq = 
<a name="23991"/>23991:         [
<a name="23992"/>23992:          #{desc =&gt; &quot;local address&quot;,
<a name="23993"/>23993:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="23994"/>23994:                            LSA = which_local_socket_addr(Domain),
<a name="23995"/>23995:                            {ok, State#{lsa_src =&gt; LSA,
<a name="23996"/>23996:                                        lsa_dst =&gt; LSA}}
<a name="23997"/>23997:                    end},
<a name="23998"/>23998: 
<a name="23999"/>23999:          #{desc =&gt; &quot;open src socket&quot;,
<a name="24000"/>24000:            cmd  =&gt; fun(#{domain := Domain,
<a name="24001"/>24001:                          proto  := Proto} = State) -&gt;
<a name="24002"/>24002:                            Sock = sock_open(Domain, dgram, Proto),
<a name="24003"/>24003:                            {ok, State#{sock_src =&gt; Sock}}
<a name="24004"/>24004:                    end},
<a name="24005"/>24005:          #{desc =&gt; &quot;bind src&quot;,
<a name="24006"/>24006:            cmd  =&gt; fun(#{sock_src := Sock, lsa_src := LSA}) -&gt;
<a name="24007"/>24007:                            case sock_bind(Sock, LSA) of
<a name="24008"/>24008:                                ok -&gt;
<a name="24009"/>24009:                                    ?SEV_IPRINT(&quot;src bound&quot;),
<a name="24010"/>24010:                                    ok;
<a name="24011"/>24011:                                {error, Reason} = ERROR -&gt;
<a name="24012"/>24012:                                    ?SEV_EPRINT(&quot;src bind failed: ~p&quot;, [Reason]),
<a name="24013"/>24013:                                    ERROR
<a name="24014"/>24014:                            end
<a name="24015"/>24015:                    end},
<a name="24016"/>24016:          #{desc =&gt; &quot;sockname src socket&quot;,
<a name="24017"/>24017:            cmd  =&gt; fun(#{sock_src := Sock} = State) -&gt;
<a name="24018"/>24018:                            SASrc = sock_sockname(Sock),
<a name="24019"/>24019:                            ?SEV_IPRINT(&quot;src sockaddr: &quot;
<a name="24020"/>24020:                                        &quot;~n   ~p&quot;, [SASrc]),
<a name="24021"/>24021:                            {ok, State#{sa_src =&gt; SASrc}}
<a name="24022"/>24022:                    end},
<a name="24023"/>24023: 
<a name="24024"/>24024:          #{desc =&gt; &quot;open dst socket&quot;,
<a name="24025"/>24025:            cmd  =&gt; fun(#{domain := Domain,
<a name="24026"/>24026:                          proto  := Proto} = State) -&gt;
<a name="24027"/>24027:                            Sock = sock_open(Domain, dgram, Proto),
<a name="24028"/>24028:                            {ok, State#{sock_dst =&gt; Sock}}
<a name="24029"/>24029:                    end},
<a name="24030"/>24030:          #{desc =&gt; &quot;bind dst&quot;,
<a name="24031"/>24031:            cmd  =&gt; fun(#{sock_dst := Sock, lsa_dst := LSA}) -&gt;
<a name="24032"/>24032:                            case sock_bind(Sock, LSA) of
<a name="24033"/>24033:                                ok -&gt;
<a name="24034"/>24034:                                    ?SEV_IPRINT(&quot;src bound&quot;),
<a name="24035"/>24035:                                    ok;
<a name="24036"/>24036:                                {error, Reason} = ERROR -&gt;
<a name="24037"/>24037:                                    ?SEV_EPRINT(&quot;src bind failed: ~p&quot;, [Reason]),
<a name="24038"/>24038:                                    ERROR
<a name="24039"/>24039:                            end
<a name="24040"/>24040:                    end},
<a name="24041"/>24041:          #{desc =&gt; &quot;sockname dst socket&quot;,
<a name="24042"/>24042:            cmd  =&gt; fun(#{sock_dst := Sock} = State) -&gt;
<a name="24043"/>24043:                            SADst = sock_sockname(Sock),
<a name="24044"/>24044:                            ?SEV_IPRINT(&quot;dst sockaddr: &quot;
<a name="24045"/>24045:                                        &quot;~n   ~p&quot;, [SADst]),
<a name="24046"/>24046:                            {ok, State#{sa_dst =&gt; SADst}}
<a name="24047"/>24047:                    end},
<a name="24048"/>24048:          #{desc =&gt; &quot;default [recv]hoplimit for dst socket&quot;,
<a name="24049"/>24049:            cmd  =&gt; fun(#{sock_dst := Sock, get := Get} = State) -&gt;
<a name="24050"/>24050:                            case Get(Sock) of
<a name="24051"/>24051:                                {ok, false = Value} -&gt;
<a name="24052"/>24052:                                    ?SEV_IPRINT(&quot;dst [recv]hoplimit: ~p&quot;,
<a name="24053"/>24053: 					       [Value]),
<a name="24054"/>24054:                                    ok;
<a name="24055"/>24055:                                {ok, Unexpected} -&gt;
<a name="24056"/>24056:                                    ?SEV_EPRINT(&quot;Unexpected src [recv]hoplimit: ~p&quot;,
<a name="24057"/>24057:                                                [Unexpected]),
<a name="24058"/>24058:                                    {error, {unexpected, Unexpected}};
<a name="24059"/>24059:                                {error, enoprotoopt = Reason} -&gt;
<a name="24060"/>24060:                                    %% On some platforms this is not accepted
<a name="24061"/>24061:                                    %% for UDP, so skip this part (UDP).
<a name="24062"/>24062:                                    ?SEV_EPRINT(&quot;Expected Failure: &quot;
<a name="24063"/>24063:                                                &quot;~p =&gt; SKIP&quot;, [Reason]),
<a name="24064"/>24064:                                    (catch socket:close(Sock)),
<a name="24065"/>24065:                                    (catch socket:close(maps:get_value(sock_src,
<a name="24066"/>24066: 								      State))),
<a name="24067"/>24067:                                    {skip, Reason};
<a name="24068"/>24068:                                {error, Reason} = ERROR -&gt;
<a name="24069"/>24069:                                    ?SEV_EPRINT(&quot;Failed getting (default) hoplimit:&quot;
<a name="24070"/>24070:                                                &quot;   ~p&quot;, [Reason]),
<a name="24071"/>24071:                                    ERROR
<a name="24072"/>24072:                            end
<a name="24073"/>24073:                    end},
<a name="24074"/>24074: 
<a name="24075"/>24075:          #{desc =&gt; &quot;send req (to dst)&quot;,
<a name="24076"/>24076:            cmd  =&gt; fun(#{sock_src := Sock, sa_dst := Dst, send := Send}) -&gt;
<a name="24077"/>24077:                            Send(Sock, ?BASIC_REQ, Dst)
<a name="24078"/>24078:                    end},
<a name="24079"/>24079:          #{desc =&gt; &quot;recv req (from src)&quot;,
<a name="24080"/>24080:            cmd  =&gt; fun(#{sock_dst := Sock, sa_src := Src, recv := Recv}) -&gt;
<a name="24081"/>24081:                            case Recv(Sock) of
<a name="24082"/>24082:                                {ok, {Src, [], ?BASIC_REQ}} -&gt;
<a name="24083"/>24083:                                    ok;
<a name="24084"/>24084:                                {ok, {BadSrc, BadCHdrs, BadReq} = UnexpData} -&gt;
<a name="24085"/>24085:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="24086"/>24086:                                                &quot;~n   Expect Source: ~p&quot;
<a name="24087"/>24087:                                                &quot;~n   Recv Source:   ~p&quot;
<a name="24088"/>24088:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="24089"/>24089:                                                &quot;~n   Recv CHdrs:    ~p&quot;
<a name="24090"/>24090:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="24091"/>24091:                                                &quot;~n   Recv Msg:      ~p&quot;,
<a name="24092"/>24092:                                                [Src, BadSrc,
<a name="24093"/>24093:                                                 [], BadCHdrs,
<a name="24094"/>24094:                                                 ?BASIC_REQ, BadReq]),
<a name="24095"/>24095:                                    {error, {unexpected_data, UnexpData}};
<a name="24096"/>24096:                                {ok, UnexpData} -&gt;
<a name="24097"/>24097:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="24098"/>24098:                                                &quot;~n   Expect Source: ~p&quot;
<a name="24099"/>24099:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="24100"/>24100:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="24101"/>24101:                                                &quot;~n   Unexp Data:    ~p&quot;,
<a name="24102"/>24102:                                                [Src, [], ?BASIC_REQ, UnexpData]),
<a name="24103"/>24103:                                    {error, {unexpected_data, UnexpData}};
<a name="24104"/>24104:                                {error, _} = ERROR -&gt;
<a name="24105"/>24105:                                    %% At the moment there is no way to get
<a name="24106"/>24106:                                    %% status or state for the socket...
<a name="24107"/>24107:                                    ERROR
<a name="24108"/>24108:                            end
<a name="24109"/>24109:                    end},
<a name="24110"/>24110: 
<a name="24111"/>24111:          #{desc =&gt; &quot;enable [recv]hoplimit on dst socket&quot;,
<a name="24112"/>24112:            cmd  =&gt; fun(#{sock_dst := Sock, set := Set} = State) -&gt;
<a name="24113"/>24113:                            case Set(Sock, true) of
<a name="24114"/>24114:                                ok -&gt;
<a name="24115"/>24115:                                    ?SEV_IPRINT(&quot;dst [recv]hoplimit enabled&quot;),
<a name="24116"/>24116:                                    ok;
<a name="24117"/>24117:                                {error, enoprotoopt = Reason} -&gt;
<a name="24118"/>24118:                                    %% On some platforms this is not accepted
<a name="24119"/>24119:                                    %% for UDP, so skip this part (UDP).
<a name="24120"/>24120:                                    ?SEV_EPRINT(&quot;Expected Failure: &quot;
<a name="24121"/>24121:                                                &quot;~p =&gt; SKIP&quot;, [Reason]),
<a name="24122"/>24122:                                    (catch socket:close(Sock)),
<a name="24123"/>24123:                                    (catch socket:close(maps:get_value(sock_src,
<a name="24124"/>24124: 								      State))),
<a name="24125"/>24125:                                    {skip, Reason};
<a name="24126"/>24126:                                {error, Reason} = ERROR -&gt;
<a name="24127"/>24127:                                    ?SEV_EPRINT(&quot;Failed setting hoplimit:&quot;
<a name="24128"/>24128:                                                &quot;   ~p&quot;, [Reason]),
<a name="24129"/>24129:                                    ERROR
<a name="24130"/>24130:                            end
<a name="24131"/>24131:                    end},
<a name="24132"/>24132: 
<a name="24133"/>24133:          #{desc =&gt; &quot;send req (to dst) (wo explicit ttl)&quot;,
<a name="24134"/>24134:            cmd  =&gt; fun(#{sock_src := Sock, sa_dst := Dst, send := Send}) -&gt;
<a name="24135"/>24135:                            Send(Sock, ?BASIC_REQ, Dst)
<a name="24136"/>24136:                    end},
<a name="24137"/>24137:          #{desc =&gt; &quot;recv req (from src)&quot;,
<a name="24138"/>24138:            cmd  =&gt; fun(#{sock_dst := Sock, sa_src := Src, recv := Recv}) -&gt;
<a name="24139"/>24139:                            case Recv(Sock) of
<a name="24140"/>24140:                                {ok, {Src, [#{level := ipv6,
<a name="24141"/>24141:                                              type  := hoplimit,
<a name="24142"/>24142:                                              value := HL}], ?BASIC_REQ}}
<a name="24143"/>24143:                                  when is_integer(HL) -&gt;
<a name="24144"/>24144:                                    ?SEV_IPRINT(&quot;Got hop limit: &quot;
<a name="24145"/>24145: 					       &quot;~n   Hop Limit: ~p&quot;, [HL]),
<a name="24146"/>24146:                                    ok;
<a name="24147"/>24147:                                {ok, {BadSrc, BadCHdrs, BadReq} = UnexpData} -&gt;
<a name="24148"/>24148:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="24149"/>24149:                                                &quot;~n   Expect Source: ~p&quot;
<a name="24150"/>24150:                                                &quot;~n   Recv Source:   ~p&quot;
<a name="24151"/>24151:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="24152"/>24152:                                                &quot;~n   Recv CHdrs:    ~p&quot;
<a name="24153"/>24153:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="24154"/>24154:                                                &quot;~n   Recv Msg:      ~p&quot;,
<a name="24155"/>24155:                                                [Src, BadSrc,
<a name="24156"/>24156:                                                 #{level =&gt; ipv6,
<a name="24157"/>24157: 						  type  =&gt; hoplimit,
<a name="24158"/>24158: 						  value =&gt; &quot;something&quot;},
<a name="24159"/>24159: 						BadCHdrs,
<a name="24160"/>24160: 						?BASIC_REQ, BadReq]),
<a name="24161"/>24161:                                    {error, {unexpected_data, UnexpData}};
<a name="24162"/>24162:                                {ok, UnexpData} -&gt;
<a name="24163"/>24163:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="24164"/>24164:                                                &quot;~n   Expect Source: ~p&quot;
<a name="24165"/>24165:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="24166"/>24166:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="24167"/>24167:                                                &quot;~n   Unexp Data:    ~p&quot;,
<a name="24168"/>24168:                                                [Src, #{level =&gt; ipv6,
<a name="24169"/>24169: 						       type  =&gt; hoplimit,
<a name="24170"/>24170: 						       value =&gt; &quot;something&quot;},
<a name="24171"/>24171: 						?BASIC_REQ, UnexpData]),
<a name="24172"/>24172:                                    {error, {unexpected_data, UnexpData}};
<a name="24173"/>24173:                                {error, _} = ERROR -&gt;
<a name="24174"/>24174:                                    %% At the moment there is no way to get
<a name="24175"/>24175:                                    %% status or state for the socket...
<a name="24176"/>24176:                                    ERROR
<a name="24177"/>24177:                            end
<a name="24178"/>24178:                    end},
<a name="24179"/>24179: 
<a name="24180"/>24180:          #{desc =&gt; &quot;close src socket&quot;,
<a name="24181"/>24181:            cmd  =&gt; fun(#{sock_src := Sock} = State) -&gt;
<a name="24182"/>24182:                            ok = socket:close(Sock),
<a name="24183"/>24183:                            {ok, maps:remove(sock_src, State)}
<a name="24184"/>24184:                    end},
<a name="24185"/>24185:          #{desc =&gt; &quot;close dst socket&quot;,
<a name="24186"/>24186:            cmd  =&gt; fun(#{sock_dst := Sock} = State) -&gt;
<a name="24187"/>24187:                            ok = socket:close(Sock),
<a name="24188"/>24188:                            {ok, maps:remove(sock_dst, State)}
<a name="24189"/>24189:                    end},
<a name="24190"/>24190: 
<a name="24191"/>24191:          %% *** We are done ***
<a name="24192"/>24192:          ?SEV_FINISH_NORMAL
<a name="24193"/>24193:         ],
<a name="24194"/>24194:     Evaluator = ?SEV_START(&quot;tester&quot;, Seq, InitState),
<a name="api_opt_ipv6_hoplimit_udp-last_expr"/><a name="24195"/>24195: <b>    ok = ?SEV_AWAIT_FINISH</b>([Evaluator]).
<a name="24196"/>24196: 
<a name="24197"/>24197: 
<a name="24198"/>24198: 
<a name="24199"/>24199: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="24200"/>24200: 
<a name="24201"/>24201: <i>%% Tests that the 'tclass' control message header is received when</i>
<a name="24202"/>24202: <i>%% setting the socket 'ipv6' tclass or recvtclass option is set to </i>
<a name="24203"/>24203: <i>%% true when using sendmsg/recvmsg on an IPv6 UDP (dgram) socket.</i>
<a name="24204"/>24204: <i>%% So, this is done on the receiving side: </i>
<a name="24205"/>24205: <i>%%</i>
<a name="24206"/>24206: <i>%%      socket:setopt(Sock, ipv6, recvtclass | tclass, boolean()).</i>
<a name="24207"/>24207: <i>%%</i>
<a name="24208"/>24208: <i>%% For all subsequent *received* messages, the 'tclass' control message</i>
<a name="24209"/>24209: <i>%% header will be with the message.</i>
<a name="24210"/>24210: <i>%% We make the assumption, that if 'recvtclass' is supported, then</i>
<a name="24211"/>24211: <i>%% that option is used to order the tclass control message, otherwise</i>
<a name="24212"/>24212: <i>%% tclass is used.</i>
<a name="24213"/>24213: <i>%%</i>
<a name="24214"/>24214: <i>%% Only allowed for dgram and raw,</i>
<a name="24215"/>24215: <i>%% although we only test this with dgram.</i>
<a name="24216"/>24216: <i>%%</i>
<a name="24217"/>24217: <i>%% &lt;Note&gt;</i>
<a name="24218"/>24218: <i>%%</i>
<a name="24219"/>24219: <i>%% There is also an IPV6_RECVTCLASS option defined in the header</i>
<a name="24220"/>24220: <i>%% file (bits/in.h) with a different value. This is not mentioned</i>
<a name="24221"/>24221: <i>%% in the man page. Deprecated? More testing needed...</i>
<a name="24222"/>24222: <i>%%</i>
<a name="24223"/>24223: <i>%% &lt;/Note&gt;</i>
<a name="24224"/>24224: <i>%%</i>
<a name="24225"/>24225: 
<a name="api_opt_ipv6_tclass_udp6-1"/><a name="24226"/>24226: <b>api_opt_ipv6_tclass_udp6</b>(_Config) when is_list(_Config) -&gt;
<a name="24227"/>24227:     ?TT(?SECS(5)),
<a name="api_opt_ipv6_tclass_udp6-last_expr"/><a name="24228"/>24228: <b>    tc_try</b>(api_opt_ipv6_tclass_udp6,
<a name="24229"/>24229:            fun() -&gt;
<a name="24230"/>24230:                    has_support_ipv6(),
<a name="24231"/>24231:                    has_support_ipv6_tclass_or_recvtclass()
<a name="24232"/>24232:            end,
<a name="24233"/>24233:            fun() -&gt;
<a name="24234"/>24234: 		   %% Begin by choosing which of the options we shall use
<a name="24235"/>24235: 		   Opt = case socket:is_supported(options, ipv6, recvtclass) of
<a name="24236"/>24236: 			     true  -&gt; recvtclass;
<a name="24237"/>24237: 			     false -&gt; tclass
<a name="24238"/>24238: 			 end,
<a name="24239"/>24239:                    Set  = fun(Sock, Value) -&gt;
<a name="24240"/>24240: 				  ?SEV_IPRINT(&quot;try set ~p: ~p&quot;, [Opt, Value]),
<a name="24241"/>24241:                                   socket:setopt(Sock, ipv6, Opt, Value)
<a name="24242"/>24242:                           end,
<a name="24243"/>24243:                    Get  = fun(Sock) -&gt;
<a name="24244"/>24244: 				  ?SEV_IPRINT(&quot;try get ~p&quot;, [Opt]),
<a name="24245"/>24245:                                   socket:getopt(Sock, ipv6, Opt)
<a name="24246"/>24246:                           end,
<a name="24247"/>24247:                    Send = fun(Sock, Data, Dest, default) -&gt;
<a name="24248"/>24248:                                   Msg = #{addr =&gt; Dest,
<a name="24249"/>24249:                                              iov  =&gt; [Data]},
<a name="24250"/>24250:                                   socket:sendmsg(Sock, Msg);
<a name="24251"/>24251: 			     (Sock, Data, Dest, TC) -&gt;
<a name="24252"/>24252:                                   TCHdr    = #{level =&gt; ipv6,
<a name="24253"/>24253: 					       type  =&gt; tclass,
<a name="24254"/>24254: 					       data  =&gt; TC},
<a name="24255"/>24255: 				  CMsgs = [TCHdr],
<a name="24256"/>24256:                                   Msg   = #{addr =&gt; Dest,
<a name="24257"/>24257: 					       ctrl =&gt; CMsgs,
<a name="24258"/>24258: 					       iov  =&gt; [Data]},
<a name="24259"/>24259:                                   socket:sendmsg(Sock, Msg)
<a name="24260"/>24260:                           end,
<a name="24261"/>24261:                    Recv = fun(Sock) -&gt;
<a name="24262"/>24262:                                   case socket:recvmsg(Sock) of
<a name="24263"/>24263:                                       {ok, #{addr := Source,
<a name="24264"/>24264:                                              ctrl := CMsgs,
<a name="24265"/>24265:                                              iov  := [Data]}} -&gt;
<a name="24266"/>24266:                                           {ok, {Source, CMsgs, Data}};
<a name="24267"/>24267:                                       {error, _} = ERROR -&gt;
<a name="24268"/>24268:                                           ERROR
<a name="24269"/>24269:                                   end
<a name="24270"/>24270:                           end,
<a name="24271"/>24271:                    InitState = #{domain =&gt; inet6,
<a name="24272"/>24272:                                  proto  =&gt; udp,
<a name="24273"/>24273:                                  send   =&gt; Send,
<a name="24274"/>24274:                                  recv   =&gt; Recv,
<a name="24275"/>24275:                                  set    =&gt; Set,
<a name="24276"/>24276:                                  get    =&gt; Get},
<a name="24277"/>24277:                    ok = api_opt_ipv6_tclass_udp(InitState)
<a name="24278"/>24278:            end).
<a name="24279"/>24279: 
<a name="24280"/>24280: 
<a name="24281"/>24281: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="24282"/>24282: 
<a name="api_opt_ipv6_tclass_udp-1"/><a name="24283"/>24283: <b>api_opt_ipv6_tclass_udp</b>(InitState) -&gt;
<a name="24284"/>24284:     Seq = 
<a name="24285"/>24285:         [
<a name="24286"/>24286:          #{desc =&gt; &quot;local address&quot;,
<a name="24287"/>24287:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="24288"/>24288:                            LSA = which_local_socket_addr(Domain),
<a name="24289"/>24289:                            {ok, State#{lsa_src =&gt; LSA,
<a name="24290"/>24290:                                        lsa_dst =&gt; LSA}}
<a name="24291"/>24291:                    end},
<a name="24292"/>24292: 
<a name="24293"/>24293:          #{desc =&gt; &quot;open src socket&quot;,
<a name="24294"/>24294:            cmd  =&gt; fun(#{domain := Domain,
<a name="24295"/>24295:                          proto  := Proto} = State) -&gt;
<a name="24296"/>24296:                            Sock = sock_open(Domain, dgram, Proto),
<a name="24297"/>24297:                            {ok, State#{sock_src =&gt; Sock}}
<a name="24298"/>24298:                    end},
<a name="24299"/>24299:          #{desc =&gt; &quot;bind src&quot;,
<a name="24300"/>24300:            cmd  =&gt; fun(#{sock_src := Sock, lsa_src := LSA}) -&gt;
<a name="24301"/>24301:                            case sock_bind(Sock, LSA) of
<a name="24302"/>24302:                                ok -&gt;
<a name="24303"/>24303:                                    ?SEV_IPRINT(&quot;src bound&quot;),
<a name="24304"/>24304:                                    ok;
<a name="24305"/>24305:                                {error, Reason} = ERROR -&gt;
<a name="24306"/>24306:                                    ?SEV_EPRINT(&quot;src bind failed: ~p&quot;, [Reason]),
<a name="24307"/>24307:                                    ERROR
<a name="24308"/>24308:                            end
<a name="24309"/>24309:                    end},
<a name="24310"/>24310:          #{desc =&gt; &quot;sockname src socket&quot;,
<a name="24311"/>24311:            cmd  =&gt; fun(#{sock_src := Sock} = State) -&gt;
<a name="24312"/>24312:                            SASrc = sock_sockname(Sock),
<a name="24313"/>24313:                            ?SEV_IPRINT(&quot;src sockaddr: &quot;
<a name="24314"/>24314:                                        &quot;~n   ~p&quot;, [SASrc]),
<a name="24315"/>24315:                            {ok, State#{sa_src =&gt; SASrc}}
<a name="24316"/>24316:                    end},
<a name="24317"/>24317: 
<a name="24318"/>24318:          #{desc =&gt; &quot;open dst socket&quot;,
<a name="24319"/>24319:            cmd  =&gt; fun(#{domain := Domain,
<a name="24320"/>24320:                          proto  := Proto} = State) -&gt;
<a name="24321"/>24321:                            Sock = sock_open(Domain, dgram, Proto),
<a name="24322"/>24322:                            {ok, State#{sock_dst =&gt; Sock}}
<a name="24323"/>24323:                    end},
<a name="24324"/>24324:          #{desc =&gt; &quot;bind dst&quot;,
<a name="24325"/>24325:            cmd  =&gt; fun(#{sock_dst := Sock, lsa_dst := LSA}) -&gt;
<a name="24326"/>24326:                            case sock_bind(Sock, LSA) of
<a name="24327"/>24327:                                ok -&gt;
<a name="24328"/>24328:                                    ?SEV_IPRINT(&quot;src bound&quot;),
<a name="24329"/>24329:                                    ok;
<a name="24330"/>24330:                                {error, Reason} = ERROR -&gt;
<a name="24331"/>24331:                                    ?SEV_EPRINT(&quot;src bind failed: ~p&quot;, [Reason]),
<a name="24332"/>24332:                                    ERROR
<a name="24333"/>24333:                            end
<a name="24334"/>24334:                    end},
<a name="24335"/>24335:          #{desc =&gt; &quot;sockname dst socket&quot;,
<a name="24336"/>24336:            cmd  =&gt; fun(#{sock_dst := Sock} = State) -&gt;
<a name="24337"/>24337:                            SADst = sock_sockname(Sock),
<a name="24338"/>24338:                            ?SEV_IPRINT(&quot;dst sockaddr: &quot;
<a name="24339"/>24339:                                        &quot;~n   ~p&quot;, [SADst]),
<a name="24340"/>24340:                            {ok, State#{sa_dst =&gt; SADst}}
<a name="24341"/>24341:                    end},
<a name="24342"/>24342:          #{desc =&gt; &quot;default [recv]tclass for dst socket&quot;,
<a name="24343"/>24343:            cmd  =&gt; fun(#{sock_dst := Sock, get := Get} = State) -&gt;
<a name="24344"/>24344:                            case Get(Sock) of
<a name="24345"/>24345:                                {ok, false = Value} -&gt;
<a name="24346"/>24346:                                    ?SEV_IPRINT(&quot;dst [recv]tclass: ~p&quot;,
<a name="24347"/>24347: 					       [Value]),
<a name="24348"/>24348:                                    ok;
<a name="24349"/>24349:                                {ok, Unexpected} -&gt;
<a name="24350"/>24350:                                    ?SEV_EPRINT(&quot;Unexpected src [recv]tclass: ~p&quot;,
<a name="24351"/>24351:                                                [Unexpected]),
<a name="24352"/>24352:                                    {error, {unexpected, Unexpected}};
<a name="24353"/>24353:                                {error, enoprotoopt = Reason} -&gt;
<a name="24354"/>24354:                                    %% On some platforms this is not accepted
<a name="24355"/>24355:                                    %% for UDP, so skip this part (UDP).
<a name="24356"/>24356:                                    ?SEV_EPRINT(&quot;Expected Failure: &quot;
<a name="24357"/>24357:                                                &quot;~p =&gt; SKIP&quot;, [Reason]),
<a name="24358"/>24358:                                    (catch socket:close(Sock)),
<a name="24359"/>24359:                                    (catch socket:close(maps:get_value(sock_src,
<a name="24360"/>24360: 								      State))),
<a name="24361"/>24361:                                    {skip, Reason};
<a name="24362"/>24362:                                {error, Reason} = ERROR -&gt;
<a name="24363"/>24363:                                    ?SEV_EPRINT(&quot;Failed getting (default) tclass:&quot;
<a name="24364"/>24364:                                                &quot;   ~p&quot;, [Reason]),
<a name="24365"/>24365:                                    ERROR
<a name="24366"/>24366:                            end
<a name="24367"/>24367:                    end},
<a name="24368"/>24368: 
<a name="24369"/>24369:          #{desc =&gt; &quot;send req (to dst)&quot;,
<a name="24370"/>24370:            cmd  =&gt; fun(#{sock_src := Sock, sa_dst := Dst, send := Send}) -&gt;
<a name="24371"/>24371:                            Send(Sock, ?BASIC_REQ, Dst, default)
<a name="24372"/>24372:                    end},
<a name="24373"/>24373:          #{desc =&gt; &quot;recv req (from src)&quot;,
<a name="24374"/>24374:            cmd  =&gt; fun(#{sock_dst := Sock, sa_src := Src, recv := Recv}) -&gt;
<a name="24375"/>24375:                            case Recv(Sock) of
<a name="24376"/>24376:                                {ok, {Src, [], ?BASIC_REQ}} -&gt;
<a name="24377"/>24377:                                    ok;
<a name="24378"/>24378:                                {ok, {BadSrc, BadCHdrs, BadReq} = UnexpData} -&gt;
<a name="24379"/>24379:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="24380"/>24380:                                                &quot;~n   Expect Source: ~p&quot;
<a name="24381"/>24381:                                                &quot;~n   Recv Source:   ~p&quot;
<a name="24382"/>24382:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="24383"/>24383:                                                &quot;~n   Recv CHdrs:    ~p&quot;
<a name="24384"/>24384:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="24385"/>24385:                                                &quot;~n   Recv Msg:      ~p&quot;,
<a name="24386"/>24386:                                                [Src, BadSrc,
<a name="24387"/>24387:                                                 [], BadCHdrs,
<a name="24388"/>24388:                                                 ?BASIC_REQ, BadReq]),
<a name="24389"/>24389:                                    {error, {unexpected_data, UnexpData}};
<a name="24390"/>24390:                                {ok, UnexpData} -&gt;
<a name="24391"/>24391:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="24392"/>24392:                                                &quot;~n   Expect Source: ~p&quot;
<a name="24393"/>24393:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="24394"/>24394:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="24395"/>24395:                                                &quot;~n   Unexp Data:    ~p&quot;,
<a name="24396"/>24396:                                                [Src, [], ?BASIC_REQ, UnexpData]),
<a name="24397"/>24397:                                    {error, {unexpected_data, UnexpData}};
<a name="24398"/>24398:                                {error, _} = ERROR -&gt;
<a name="24399"/>24399:                                    %% At the moment there is no way to get
<a name="24400"/>24400:                                    %% status or state for the socket...
<a name="24401"/>24401:                                    ERROR
<a name="24402"/>24402:                            end
<a name="24403"/>24403:                    end},
<a name="24404"/>24404: 
<a name="24405"/>24405:          #{desc =&gt; &quot;enable [recv]tclass on dst socket&quot;,
<a name="24406"/>24406:            cmd  =&gt; fun(#{sock_dst := Sock, set := Set} = State) -&gt;
<a name="24407"/>24407:                            case Set(Sock, true) of
<a name="24408"/>24408:                                ok -&gt;
<a name="24409"/>24409:                                    ?SEV_IPRINT(&quot;dst [recv]tclass enabled&quot;),
<a name="24410"/>24410:                                    ok;
<a name="24411"/>24411:                                {error, enoprotoopt = Reason} -&gt;
<a name="24412"/>24412:                                    %% On some platforms this is not accepted
<a name="24413"/>24413:                                    %% for UDP, so skip this part (UDP).
<a name="24414"/>24414:                                    ?SEV_EPRINT(&quot;Expected Failure: &quot;
<a name="24415"/>24415:                                                &quot;~p =&gt; SKIP&quot;, [Reason]),
<a name="24416"/>24416:                                    (catch socket:close(Sock)),
<a name="24417"/>24417:                                    (catch socket:close(maps:get_value(sock_src,
<a name="24418"/>24418: 								      State))),
<a name="24419"/>24419:                                    {skip, Reason};
<a name="24420"/>24420:                                {error, Reason} = ERROR -&gt;
<a name="24421"/>24421:                                    ?SEV_EPRINT(&quot;Failed setting tclass:&quot;
<a name="24422"/>24422:                                                &quot;   ~p&quot;, [Reason]),
<a name="24423"/>24423:                                    ERROR
<a name="24424"/>24424:                            end
<a name="24425"/>24425:                    end},
<a name="24426"/>24426: 
<a name="24427"/>24427:          #{desc =&gt; &quot;send req (to dst) (wo explicit tc)&quot;,
<a name="24428"/>24428:            cmd  =&gt; fun(#{sock_src := Sock, sa_dst := Dst, send := Send}) -&gt;
<a name="24429"/>24429:                            Send(Sock, ?BASIC_REQ, Dst, default)
<a name="24430"/>24430:                    end},
<a name="24431"/>24431:          #{desc =&gt; &quot;recv req (from src)&quot;,
<a name="24432"/>24432:            cmd  =&gt; fun(#{sock_dst := Sock, sa_src := Src, recv := Recv}) -&gt;
<a name="24433"/>24433:                            case Recv(Sock) of
<a name="24434"/>24434:                                {ok, {Src, [#{level := ipv6,
<a name="24435"/>24435:                                              type  := tclass,
<a name="24436"/>24436:                                              value := TClass}], ?BASIC_REQ}}
<a name="24437"/>24437: 			       when is_integer(TClass) -&gt;
<a name="24438"/>24438:                                    ?SEV_IPRINT(&quot;Got tclass: &quot;
<a name="24439"/>24439: 					       &quot;~n   TClass: ~p&quot;, [TClass]),
<a name="24440"/>24440:                                    ok;
<a name="24441"/>24441:                                {ok, {BadSrc, BadCHdrs, BadReq} = UnexpData} -&gt;
<a name="24442"/>24442:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="24443"/>24443:                                                &quot;~n   Expect Source: ~p&quot;
<a name="24444"/>24444:                                                &quot;~n   Recv Source:   ~p&quot;
<a name="24445"/>24445:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="24446"/>24446:                                                &quot;~n   Recv CHdrs:    ~p&quot;
<a name="24447"/>24447:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="24448"/>24448:                                                &quot;~n   Recv Msg:      ~p&quot;,
<a name="24449"/>24449:                                                [Src, BadSrc,
<a name="24450"/>24450:                                                 #{level =&gt; ipv6,
<a name="24451"/>24451: 						  type  =&gt; tclass,
<a name="24452"/>24452: 						  value =&gt; &quot;something&quot;},
<a name="24453"/>24453: 						BadCHdrs,
<a name="24454"/>24454: 						?BASIC_REQ, BadReq]),
<a name="24455"/>24455:                                    {error, {unexpected_data, UnexpData}};
<a name="24456"/>24456:                                {ok, UnexpData} -&gt;
<a name="24457"/>24457:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="24458"/>24458:                                                &quot;~n   Expect Source: ~p&quot;
<a name="24459"/>24459:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="24460"/>24460:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="24461"/>24461:                                                &quot;~n   Unexp Data:    ~p&quot;,
<a name="24462"/>24462:                                                [Src, #{level =&gt; ipv6,
<a name="24463"/>24463: 						       type  =&gt; tclass,
<a name="24464"/>24464: 						       value =&gt; &quot;something&quot;},
<a name="24465"/>24465: 						?BASIC_REQ, UnexpData]),
<a name="24466"/>24466:                                    {error, {unexpected_data, UnexpData}};
<a name="24467"/>24467:                                {error, _} = ERROR -&gt;
<a name="24468"/>24468:                                    %% At the moment there is no way to get
<a name="24469"/>24469:                                    %% status or state for the socket...
<a name="24470"/>24470:                                    ERROR
<a name="24471"/>24471:                            end
<a name="24472"/>24472:                    end},
<a name="24473"/>24473: 
<a name="24474"/>24474:          #{desc =&gt; &quot;send req (to dst) (w explicit tc = 1)&quot;,
<a name="24475"/>24475:            cmd  =&gt; fun(#{sock_src := Sock, sa_dst := Dst, send := Send}) -&gt;
<a name="24476"/>24476:                            case Send(Sock, ?BASIC_REQ, Dst, 1) of
<a name="24477"/>24477:                                {error,
<a name="24478"/>24478:                                 {get_overlapped_result,
<a name="24479"/>24479:                                  #{file     := File,
<a name="24480"/>24480:                                    function := Function,
<a name="24481"/>24481:                                    line     := Line,
<a name="24482"/>24482:                                    raw_info := RawInfo,
<a name="24483"/>24483:                                    info     := invalid_parameter = Info}}} -&gt;
<a name="24484"/>24484:                                    %% IF we can't send it the test will not work
<a name="24485"/>24485:                                    ?SEV_EPRINT(&quot;Cannot send TClass: &quot;
<a name="24486"/>24486:                                                &quot;~p =&gt; SKIP: &quot;
<a name="24487"/>24487:                                                &quot;~n   File:     ~s&quot;
<a name="24488"/>24488:                                                &quot;~n   Function: ~s&quot;
<a name="24489"/>24489:                                                &quot;~n   Line:     ~p&quot;
<a name="24490"/>24490:                                                &quot;~n   Raw Info: ~p&quot;,
<a name="24491"/>24491:                                                [Info,
<a name="24492"/>24492:                                                 File, Function, Line,
<a name="24493"/>24493:                                                 RawInfo]),
<a name="24494"/>24494:                                    (catch socket:close(Sock)),
<a name="24495"/>24495:                                    {skip,
<a name="24496"/>24496:                                     ?F(&quot;Cannot send with TClass: ~p&quot;, [Info])};
<a name="24497"/>24497:                                {error, {get_overlapped_result,
<a name="24498"/>24498:                                         invalid_parameter = Info}} -&gt;
<a name="24499"/>24499:                                    %% IF we can't send it the test will not work
<a name="24500"/>24500:                                    ?SEV_EPRINT(&quot;Cannot send TClass: &quot;
<a name="24501"/>24501:                                                &quot;~p =&gt; SKIP&quot;, [Info]),
<a name="24502"/>24502:                                    (catch socket:close(Sock)),
<a name="24503"/>24503:                                    {skip,
<a name="24504"/>24504:                                     ?F(&quot;Cannot send with TClass: ~p&quot;, [Info])};
<a name="24505"/>24505: 
<a name="24506"/>24506:                                {error,
<a name="24507"/>24507:                                 {completion_status,
<a name="24508"/>24508:                                  #{file     := File,
<a name="24509"/>24509:                                    function := Function,
<a name="24510"/>24510:                                    line     := Line,
<a name="24511"/>24511:                                    raw_info := RawInfo,
<a name="24512"/>24512:                                    info     := invalid_parameter = Info}}} -&gt;
<a name="24513"/>24513:                                    %% IF we can't send it the test will not work
<a name="24514"/>24514:                                    ?SEV_EPRINT(&quot;Cannot send TClass: &quot;
<a name="24515"/>24515:                                                &quot;~p =&gt; SKIP: &quot;
<a name="24516"/>24516:                                                &quot;~n   File:     ~s&quot;
<a name="24517"/>24517:                                                &quot;~n   Function: ~s&quot;
<a name="24518"/>24518:                                                &quot;~n   Line:     ~p&quot;
<a name="24519"/>24519:                                                &quot;~n   Raw Info: ~p&quot;,
<a name="24520"/>24520:                                                [Info,
<a name="24521"/>24521:                                                 File, Function, Line,
<a name="24522"/>24522:                                                 RawInfo]),
<a name="24523"/>24523:                                    (catch socket:close(Sock)),
<a name="24524"/>24524:                                    {skip,
<a name="24525"/>24525:                                     ?F(&quot;Cannot send with TClass: ~p&quot;, [Info])};
<a name="24526"/>24526:                                {error, {completion_status,
<a name="24527"/>24527:                                         invalid_parameter = Info}} -&gt;
<a name="24528"/>24528:                                    %% IF we can't send it the test will not work
<a name="24529"/>24529:                                    ?SEV_EPRINT(&quot;Cannot send TClass: &quot;
<a name="24530"/>24530:                                                &quot;~p =&gt; SKIP&quot;, [Info]),
<a name="24531"/>24531:                                    (catch socket:close(Sock)),
<a name="24532"/>24532:                                    {skip,
<a name="24533"/>24533:                                     ?F(&quot;Cannot send with TClass: ~p&quot;, [Info])};
<a name="24534"/>24534: 
<a name="24535"/>24535:                                Other -&gt;
<a name="24536"/>24536:                                    Other
<a name="24537"/>24537:                            end
<a name="24538"/>24538:                    end},
<a name="24539"/>24539:          #{desc =&gt; &quot;recv req (from src)&quot;,
<a name="24540"/>24540:            cmd  =&gt; fun(#{sock_dst := Sock, sa_src := Src, recv := Recv}) -&gt;
<a name="24541"/>24541:                            case Recv(Sock) of
<a name="24542"/>24542:                                {ok, {Src, [#{level := ipv6,
<a name="24543"/>24543:                                              type  := tclass,
<a name="24544"/>24544:                                              value := 1 = TClass}], ?BASIC_REQ}}
<a name="24545"/>24545: 			       when is_integer(TClass) -&gt;
<a name="24546"/>24546:                                    ?SEV_IPRINT(&quot;Got (expected) tclass: &quot;
<a name="24547"/>24547: 					       &quot;~n   TClass: ~p&quot;, [TClass]),
<a name="24548"/>24548:                                    ok;
<a name="24549"/>24549:                                {ok, {_Src, [#{level := ipv6,
<a name="24550"/>24550: 					      type  := tclass,
<a name="24551"/>24551: 					      value := TClass}], ?BASIC_REQ}}
<a name="24552"/>24552: 			       when is_integer(TClass) -&gt;
<a name="24553"/>24553:                                    ?SEV_EPRINT(&quot;Unexpected tclass: &quot;
<a name="24554"/>24554:                                                &quot;~n   Expect TClass: ~p&quot;
<a name="24555"/>24555:                                                &quot;~n   Recv TClass:   ~p&quot;,
<a name="24556"/>24556:                                                [1, TClass]),
<a name="24557"/>24557:                                    {error, {unexpected_tclass, TClass}};
<a name="24558"/>24558:                                {ok, {BadSrc, BadCHdrs, BadReq} = UnexpData} -&gt;
<a name="24559"/>24559:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="24560"/>24560:                                                &quot;~n   Expect Source: ~p&quot;
<a name="24561"/>24561:                                                &quot;~n   Recv Source:   ~p&quot;
<a name="24562"/>24562:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="24563"/>24563:                                                &quot;~n   Recv CHdrs:    ~p&quot;
<a name="24564"/>24564:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="24565"/>24565:                                                &quot;~n   Recv Msg:      ~p&quot;,
<a name="24566"/>24566:                                                [Src, BadSrc,
<a name="24567"/>24567:                                                 #{level =&gt; ipv6,
<a name="24568"/>24568: 						  type  =&gt; tclass,
<a name="24569"/>24569: 						  value =&gt; &quot;something&quot;},
<a name="24570"/>24570: 						BadCHdrs,
<a name="24571"/>24571: 						?BASIC_REQ, BadReq]),
<a name="24572"/>24572:                                    {error, {unexpected_data, UnexpData}};
<a name="24573"/>24573:                                {ok, UnexpData} -&gt;
<a name="24574"/>24574:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="24575"/>24575:                                                &quot;~n   Expect Source: ~p&quot;
<a name="24576"/>24576:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="24577"/>24577:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="24578"/>24578:                                                &quot;~n   Unexp Data:    ~p&quot;,
<a name="24579"/>24579:                                                [Src, #{level =&gt; ipv6,
<a name="24580"/>24580: 						       type  =&gt; tclass,
<a name="24581"/>24581: 						       value =&gt; &quot;something&quot;},
<a name="24582"/>24582: 						?BASIC_REQ, UnexpData]),
<a name="24583"/>24583:                                    {error, {unexpected_data, UnexpData}};
<a name="24584"/>24584: 
<a name="24585"/>24585:                                 {error, _} = ERROR -&gt;
<a name="24586"/>24586:                                    %% At the moment there is no way to get
<a name="24587"/>24587:                                    %% status or state for the socket...
<a name="24588"/>24588:                                    ERROR
<a name="24589"/>24589:                            end
<a name="24590"/>24590:                    end},
<a name="24591"/>24591: 
<a name="24592"/>24592:          #{desc =&gt; &quot;close src socket&quot;,
<a name="24593"/>24593:            cmd  =&gt; fun(#{sock_src := Sock} = State) -&gt;
<a name="24594"/>24594:                            ok = socket:close(Sock),
<a name="24595"/>24595:                            {ok, maps:remove(sock_src, State)}
<a name="24596"/>24596:                    end},
<a name="24597"/>24597:          #{desc =&gt; &quot;close dst socket&quot;,
<a name="24598"/>24598:            cmd  =&gt; fun(#{sock_dst := Sock} = State) -&gt;
<a name="24599"/>24599:                            ok = socket:close(Sock),
<a name="24600"/>24600:                            {ok, maps:remove(sock_dst, State)}
<a name="24601"/>24601:                    end},
<a name="24602"/>24602: 
<a name="24603"/>24603:          %% *** We are done ***
<a name="24604"/>24604:          ?SEV_FINISH_NORMAL
<a name="24605"/>24605:         ],
<a name="24606"/>24606:     Evaluator = ?SEV_START(&quot;tester&quot;, Seq, InitState),
<a name="api_opt_ipv6_tclass_udp-last_expr"/><a name="24607"/>24607: <b>    ok = ?SEV_AWAIT_FINISH</b>([Evaluator]).
<a name="24608"/>24608: 
<a name="24609"/>24609: 
<a name="24610"/>24610: 
<a name="24611"/>24611: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="24612"/>24612: 
<a name="24613"/>24613: <i>%% This intended to test &quot;all&quot; of the (currently) supported IPv6</i>
<a name="24614"/>24614: <i>%% options that results in control message header(s).</i>
<a name="24615"/>24615: <i>%% So, this is done on the receiving side: </i>
<a name="24616"/>24616: <i>%%</i>
<a name="24617"/>24617: <i>%%      socket:setopt(Sock, ipv6, Flag, boolean()).</i>
<a name="24618"/>24618: <i>%%</i>
<a name="24619"/>24619: <i>%% For all subsequent *received* messages, a control message header</i>
<a name="24620"/>24620: <i>%% for each of the enabled options will be received with the message.</i>
<a name="24621"/>24621: <i>%%</i>
<a name="24622"/>24622: <i>%% Only allowed for dgram and raw,</i>
<a name="24623"/>24623: <i>%% although we only test this with dgram.</i>
<a name="24624"/>24624: <i>%%</i>
<a name="24625"/>24625: <i>%% Currently we *try* to use the following opts:</i>
<a name="24626"/>24626: <i>%%</i>
<a name="24627"/>24627: <i>%%      recvpktinfo | pktinfo   =&gt; pktinfo</i>
<a name="24628"/>24628: <i>%%      flowinfo                =&gt; flowinfo</i>
<a name="24629"/>24629: <i>%%      recvhoplimit | hoplimit =&gt; hoplimit</i>
<a name="24630"/>24630: <i>%%      recvtclass | tclass     =&gt; tclass</i>
<a name="24631"/>24631: <i>%%</i>
<a name="24632"/>24632: <i>%%</i>
<a name="24633"/>24633: <i>%% Every time we add a test case for a new option (that results in</i>
<a name="24634"/>24634: <i>%% a control message hedare), we should also add it here.</i>
<a name="24635"/>24635: <i>%%</i>
<a name="24636"/>24636: <i>%% Even though this is a IPv6 test case, we add the 'socket' timestamp</i>
<a name="24637"/>24637: <i>%% option (just to fill up), but in the test to see if we should run</i>
<a name="24638"/>24638: <i>%% the test (since its a IPv6 test case).</i>
<a name="24639"/>24639: <i>%%</i>
<a name="24640"/>24640: 
<a name="api_opt_ipv6_mopts_udp6-1"/><a name="24641"/>24641: <b>api_opt_ipv6_mopts_udp6</b>(_Config) when is_list(_Config) -&gt;
<a name="24642"/>24642:     ?TT(?SECS(5)),
<a name="api_opt_ipv6_mopts_udp6-last_expr"/><a name="24643"/>24643: <b>    tc_try</b>(api_opt_ipv6_mopts_udp6,
<a name="24644"/>24644:            fun() -&gt;
<a name="24645"/>24645:                    has_support_ipv6(),
<a name="24646"/>24646:                    Opts =
<a name="24647"/>24647:                        [{ipv6, recvpktinfo},
<a name="24648"/>24648:                         {ipv6, flowinfo},
<a name="24649"/>24649:                         {ipv6, recvhoplimit},
<a name="24650"/>24650:                         {ipv6, hoplimit}] ++
<a name="24651"/>24651:                        case os:type() of
<a name="24652"/>24652:                            {win32, nt} -&gt;
<a name="24653"/>24653:                                [];
<a name="24654"/>24654:                            _ -&gt;
<a name="24655"/>24655:                                [{ipv6, recvtclass},
<a name="24656"/>24656:                                 {ipv6, tclass}]
<a name="24657"/>24657:                        end,
<a name="24658"/>24658: 		   case is_any_options_supported(Opts) of
<a name="24659"/>24659: 		       true -&gt;
<a name="24660"/>24660: 			   ok;
<a name="24661"/>24661: 		       false -&gt;
<a name="24662"/>24662: 			   skip(&quot;None of the needed options are supported&quot;)
<a name="24663"/>24663: 		   end,
<a name="24664"/>24664: 		   %% The problem here is hoplimit on darwin 9.8.0,
<a name="24665"/>24665: 		   %% but I can't be bothered to adjust the test case,
<a name="24666"/>24666: 		   %% just skip on that machine (there is only one)...
<a name="24667"/>24667: 		   is_good_enough_darwin({9,8,0}),
<a name="24668"/>24668:                    is_good_enough_montavista(&quot;4.0.1&quot;)
<a name="24669"/>24669:            end,
<a name="24670"/>24670:            fun() -&gt;
<a name="24671"/>24671: 		   %% If we get this far, we *know* that at least one of the
<a name="24672"/>24672: 		   %% options are available.
<a name="24673"/>24673: 
<a name="24674"/>24674: 		   %% This is list of all the options and there resulting
<a name="24675"/>24675: 		   %% control message header type(s):
<a name="24676"/>24676: 		   %%   [{'ipv6 socket option', 'control message header type'}]
<a name="24677"/>24677: 		   Opts =
<a name="24678"/>24678: 		       case socket:is_supported(options, socket, timestamp) of
<a name="24679"/>24679: 			   true -&gt;
<a name="24680"/>24680: 			       [{socket, timestamp, timestamp, default}];
<a name="24681"/>24681: 			   false -&gt;
<a name="24682"/>24682: 			       []
<a name="24683"/>24683: 		       end ++
<a name="24684"/>24684: 		       case socket:is_supported(options, ipv6, recvpktinfo) of
<a name="24685"/>24685: 			   true -&gt;
<a name="24686"/>24686: 			       [{ipv6, recvpktinfo, pktinfo, default}];
<a name="24687"/>24687: 			   false -&gt;
<a name="24688"/>24688: 			       []
<a name="24689"/>24689: 		       end ++
<a name="24690"/>24690: 		       case socket:is_supported(options, ipv6, flowinfo) of
<a name="24691"/>24691: 			   true -&gt;
<a name="24692"/>24692: 			       [{ipv6, flowinfo, flowinfo, default}];
<a name="24693"/>24693: 			   false -&gt;
<a name="24694"/>24694: 			       []
<a name="24695"/>24695: 		       end ++
<a name="24696"/>24696: 		       case socket:is_supported(options, ipv6, recvhoplimit) of
<a name="24697"/>24697: 			   true -&gt;
<a name="24698"/>24698: 			       [{ipv6, recvhoplimit, hoplimit, default}];
<a name="24699"/>24699: 			   false -&gt;
<a name="24700"/>24700: 			       case socket:is_supported(options, ipv6, hoplimit) of
<a name="24701"/>24701: 				   true -&gt;
<a name="24702"/>24702: 				       [{ipv6, hoplimit, hoplimit, default}];
<a name="24703"/>24703: 				   false -&gt;
<a name="24704"/>24704: 				       []
<a name="24705"/>24705: 			       end
<a name="24706"/>24706: 		       end ++
<a name="24707"/>24707:                        case os:type() of
<a name="24708"/>24708:                            {win32, nt} -&gt;
<a name="24709"/>24709:                                [];
<a name="24710"/>24710:                            _ -&gt;
<a name="24711"/>24711:                                case socket:is_supported(options,
<a name="24712"/>24712:                                                         ipv6, recvtclass) of
<a name="24713"/>24713:                                    true -&gt;
<a name="24714"/>24714:                                        [{ipv6, recvtclass, tclass, 42}];
<a name="24715"/>24715:                                    false -&gt;
<a name="24716"/>24716:                                        case socket:is_supported(options,
<a name="24717"/>24717:                                                                 ipv6, tclass) of
<a name="24718"/>24718:                                            true -&gt;
<a name="24719"/>24719:                                                [{ipv6, tclass, tclass, 42}];
<a name="24720"/>24720:                                            false -&gt;
<a name="24721"/>24721:                                                []
<a name="24722"/>24722:                                        end
<a name="24723"/>24723:                                end
<a name="24724"/>24724: 		       end,
<a name="24725"/>24725: 
<a name="24726"/>24726:                    Enable = fun(Sock, Level, Opt) -&gt;
<a name="24727"/>24727: 				    ?SEV_IPRINT(&quot;try enable [~w] ~p&quot;,
<a name="24728"/>24728:                                                 [Level, Opt]),
<a name="24729"/>24729: 				    socket:setopt(Sock, Level, Opt, true)
<a name="24730"/>24730:                             end,
<a name="24731"/>24731:                    Send = fun(Sock, Data, Dest, []) -&gt;
<a name="24732"/>24732:                                   Msg = #{addr =&gt; Dest,
<a name="24733"/>24733:                                              iov  =&gt; [Data]},
<a name="24734"/>24734:                                   socket:sendmsg(Sock, Msg);
<a name="24735"/>24735: 			     (Sock, Data, Dest, Hdrs) when is_list(Hdrs) -&gt;
<a name="24736"/>24736: 				  CMsgs = [#{level =&gt; Level,
<a name="24737"/>24737:                                              type  =&gt; Type,
<a name="24738"/>24738:                                              data  =&gt; Val} ||
<a name="24739"/>24739:                                               {Level, Type, Val} &lt;- Hdrs],
<a name="24740"/>24740:                                   Msg   = #{addr =&gt; Dest,
<a name="24741"/>24741:                                             ctrl =&gt; CMsgs,
<a name="24742"/>24742:                                             iov  =&gt; [Data]},
<a name="24743"/>24743:                                   socket:sendmsg(Sock, Msg)
<a name="24744"/>24744:                           end,
<a name="24745"/>24745:                    Recv = fun(Sock) -&gt;
<a name="24746"/>24746:                                   case socket:recvmsg(Sock) of
<a name="24747"/>24747:                                       {ok, #{addr := Source,
<a name="24748"/>24748:                                              ctrl := CMsgs,
<a name="24749"/>24749:                                              iov  := [Data]}} -&gt;
<a name="24750"/>24750:                                           {ok, {Source, CMsgs, Data}};
<a name="24751"/>24751:                                       {error, _} = ERROR -&gt;
<a name="24752"/>24752:                                           ERROR
<a name="24753"/>24753:                                   end
<a name="24754"/>24754:                           end,
<a name="24755"/>24755:                    InitState = #{domain =&gt; inet6,
<a name="24756"/>24756:                                  proto  =&gt; udp,
<a name="24757"/>24757: 				 opts   =&gt; Opts,
<a name="24758"/>24758:                                  send   =&gt; Send,
<a name="24759"/>24759:                                  recv   =&gt; Recv,
<a name="24760"/>24760:                                  enable =&gt; Enable},
<a name="24761"/>24761:                    ok = api_opt_ipv6_mopts_udp(InitState)
<a name="24762"/>24762:            end).
<a name="24763"/>24763: 
<a name="24764"/>24764: 
<a name="24765"/>24765: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="24766"/>24766: 
<a name="api_opt_ipv6_mopts_udp-1"/><a name="24767"/>24767: <b>api_opt_ipv6_mopts_udp</b>(InitState) -&gt;
<a name="24768"/>24768:     Seq = 
<a name="24769"/>24769:         [
<a name="24770"/>24770:          #{desc =&gt; &quot;local address&quot;,
<a name="24771"/>24771:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="24772"/>24772:                            LSA = which_local_socket_addr(Domain),
<a name="24773"/>24773:                            {ok, State#{lsa_src =&gt; LSA,
<a name="24774"/>24774:                                        lsa_dst =&gt; LSA}}
<a name="24775"/>24775:                    end},
<a name="24776"/>24776: 
<a name="24777"/>24777:          #{desc =&gt; &quot;open src socket&quot;,
<a name="24778"/>24778:            cmd  =&gt; fun(#{domain := Domain,
<a name="24779"/>24779:                          proto  := Proto} = State) -&gt;
<a name="24780"/>24780:                            Sock = sock_open(Domain, dgram, Proto),
<a name="24781"/>24781:                            {ok, State#{sock_src =&gt; Sock}}
<a name="24782"/>24782:                    end},
<a name="24783"/>24783:          #{desc =&gt; &quot;bind src&quot;,
<a name="24784"/>24784:            cmd  =&gt; fun(#{sock_src := Sock, lsa_src := LSA}) -&gt;
<a name="24785"/>24785:                            case sock_bind(Sock, LSA) of
<a name="24786"/>24786:                                ok -&gt;
<a name="24787"/>24787:                                    ?SEV_IPRINT(&quot;src bound&quot;),
<a name="24788"/>24788:                                    ok;
<a name="24789"/>24789:                                {error, Reason} = ERROR -&gt;
<a name="24790"/>24790:                                    ?SEV_EPRINT(&quot;src bind failed: ~p&quot;, [Reason]),
<a name="24791"/>24791:                                    ERROR
<a name="24792"/>24792:                            end
<a name="24793"/>24793:                    end},
<a name="24794"/>24794:          #{desc =&gt; &quot;sockname src socket&quot;,
<a name="24795"/>24795:            cmd  =&gt; fun(#{sock_src := Sock} = State) -&gt;
<a name="24796"/>24796:                            SASrc = sock_sockname(Sock),
<a name="24797"/>24797:                            ?SEV_IPRINT(&quot;src sockaddr: &quot;
<a name="24798"/>24798:                                        &quot;~n   ~p&quot;, [SASrc]),
<a name="24799"/>24799:                            {ok, State#{sa_src =&gt; SASrc}}
<a name="24800"/>24800:                    end},
<a name="24801"/>24801: 
<a name="24802"/>24802:          #{desc =&gt; &quot;open dst socket&quot;,
<a name="24803"/>24803:            cmd  =&gt; fun(#{domain := Domain,
<a name="24804"/>24804:                          proto  := Proto} = State) -&gt;
<a name="24805"/>24805:                            Sock = sock_open(Domain, dgram, Proto),
<a name="24806"/>24806:                            {ok, State#{sock_dst =&gt; Sock}}
<a name="24807"/>24807:                    end},
<a name="24808"/>24808:          #{desc =&gt; &quot;bind dst&quot;,
<a name="24809"/>24809:            cmd  =&gt; fun(#{sock_dst := Sock, lsa_dst := LSA}) -&gt;
<a name="24810"/>24810:                            case sock_bind(Sock, LSA) of
<a name="24811"/>24811:                                ok -&gt;
<a name="24812"/>24812:                                    ?SEV_IPRINT(&quot;src bound&quot;),
<a name="24813"/>24813:                                    ok;
<a name="24814"/>24814:                                {error, Reason} = ERROR -&gt;
<a name="24815"/>24815:                                    ?SEV_EPRINT(&quot;src bind failed: ~p&quot;, [Reason]),
<a name="24816"/>24816:                                    ERROR
<a name="24817"/>24817:                            end
<a name="24818"/>24818:                    end},
<a name="24819"/>24819:          #{desc =&gt; &quot;sockname dst socket&quot;,
<a name="24820"/>24820:            cmd  =&gt; fun(#{sock_dst := Sock} = State) -&gt;
<a name="24821"/>24821:                            SADst = sock_sockname(Sock),
<a name="24822"/>24822:                            ?SEV_IPRINT(&quot;dst sockaddr: &quot;
<a name="24823"/>24823:                                        &quot;~n   ~p&quot;, [SADst]),
<a name="24824"/>24824:                            {ok, State#{sa_dst =&gt; SADst}}
<a name="24825"/>24825:                    end},
<a name="24826"/>24826: 
<a name="24827"/>24827:          #{desc =&gt; &quot;enable options on dst socket&quot;,
<a name="24828"/>24828:            cmd  =&gt; fun(#{sock_dst := DSock,
<a name="24829"/>24829: 			 sock_src := SSock,
<a name="24830"/>24830: 			 opts     := Opts,
<a name="24831"/>24831: 			 enable   := Enable} = _State) -&gt;
<a name="24832"/>24832: 			   %% If we fail to enable *any* of the options,
<a name="24833"/>24833: 			   %% we give up.
<a name="24834"/>24834: 			   E = fun({Level, Opt, _, _}) -&gt; 
<a name="24835"/>24835:                                        case Enable(DSock, Level, Opt) of
<a name="24836"/>24836:                                            ok -&gt;
<a name="24837"/>24837:                                                ?SEV_IPRINT(&quot;dst [~w] ~w enabled&quot;,
<a name="24838"/>24838:                                                            [Level, Opt]),
<a name="24839"/>24839:                                                ok;
<a name="24840"/>24840:                                            {error, enoprotoopt = Reason} -&gt;
<a name="24841"/>24841:                                                ?SEV_EPRINT(&quot;Expected &quot;
<a name="24842"/>24842:                                                            &quot;Failure: &quot;
<a name="24843"/>24843:                                                            &quot;~p =&gt; SKIP&quot;,
<a name="24844"/>24844:                                                            [Reason]),
<a name="24845"/>24845:                                                (catch socket:close(DSock)),
<a name="24846"/>24846:                                                (catch socket:close(SSock)),
<a name="24847"/>24847:                                                {skip, Reason};
<a name="24848"/>24848:                                            {error, Reason} = ERROR -&gt;
<a name="24849"/>24849:                                                ?SEV_EPRINT(&quot;Failed &quot;
<a name="24850"/>24850:                                                            &quot;setting ~w:&quot;
<a name="24851"/>24851:                                                            &quot;   ~p&quot;,
<a name="24852"/>24852:                                                            [Opt, Reason]),
<a name="24853"/>24853:                                                throw(ERROR)
<a name="24854"/>24854:                                        end
<a name="24855"/>24855: 			       end,
<a name="24856"/>24856: 			   lists:foreach(E, Opts),
<a name="24857"/>24857: 			   ok
<a name="24858"/>24858:                    end},
<a name="24859"/>24859: 
<a name="24860"/>24860:          #{desc =&gt; &quot;send req (to dst)&quot;,
<a name="24861"/>24861:            cmd  =&gt; fun(#{sock_src := Sock,
<a name="24862"/>24862: 			 sa_dst   := Dst,
<a name="24863"/>24863: 			 opts     := Opts,
<a name="24864"/>24864: 			 send     := Send}) -&gt;
<a name="24865"/>24865: 			   Hdrs = [{Level, Type, Data} ||
<a name="24866"/>24866: 				      {Level, _, Type, Data} &lt;- 
<a name="24867"/>24867: 					  Opts, (Data =/= default)],
<a name="24868"/>24868:                            Send(Sock, ?BASIC_REQ, Dst, Hdrs)
<a name="24869"/>24869:                    end},
<a name="24870"/>24870:          #{desc =&gt; &quot;recv req (from src)&quot;,
<a name="24871"/>24871:            cmd  =&gt; fun(#{sock_dst := Sock,
<a name="24872"/>24872: 			 sa_src   := Src,
<a name="24873"/>24873: 			 recv     := Recv,
<a name="24874"/>24874: 			 opts     := Opts}) -&gt;
<a name="24875"/>24875:                            case Recv(Sock) of
<a name="24876"/>24876:                                {ok, {Src, CMsgs, ?BASIC_REQ}}
<a name="24877"/>24877:                                  when length(CMsgs) =:= length(Opts)  -&gt;
<a name="24878"/>24878:                                    ?SEV_IPRINT(&quot;Got (expected) cmsg headers: &quot;
<a name="24879"/>24879: 					       &quot;~n   ~p&quot;, [CMsgs]),
<a name="24880"/>24880: 				   %% We should really verify the headers:
<a name="24881"/>24881: 				   %% values, types and so on...
<a name="24882"/>24882:                                    ok;
<a name="24883"/>24883:                                {ok, {BadSrc, BadCHdrs, BadReq} = UnexpData} -&gt;
<a name="24884"/>24884:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="24885"/>24885:                                                &quot;~n   Expect Source: ~p&quot;
<a name="24886"/>24886:                                                &quot;~n   Recv Source:   ~p&quot;
<a name="24887"/>24887:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="24888"/>24888:                                                &quot;~n   Recv CHdrs:    ~p&quot;
<a name="24889"/>24889:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="24890"/>24890:                                                &quot;~n   Recv Msg:      ~p&quot;,
<a name="24891"/>24891:                                                [Src, BadSrc,
<a name="24892"/>24892:                                                 [{Level, Type} ||
<a name="24893"/>24893:                                                     {Level, _, Type, _} &lt;- Opts],
<a name="24894"/>24894: 						BadCHdrs,
<a name="24895"/>24895: 						?BASIC_REQ, BadReq]),
<a name="24896"/>24896:                                    {error, {unexpected_data, UnexpData}};
<a name="24897"/>24897:                                {ok, UnexpData} -&gt;
<a name="24898"/>24898:                                    ?SEV_EPRINT(&quot;Unexpected msg: &quot;
<a name="24899"/>24899:                                                &quot;~n   Expect Source: ~p&quot;
<a name="24900"/>24900:                                                &quot;~n   Expect CHdrs:  ~p&quot;
<a name="24901"/>24901:                                                &quot;~n   Expect Msg:    ~p&quot;
<a name="24902"/>24902:                                                &quot;~n   Unexp Data:    ~p&quot;,
<a name="24903"/>24903:                                                [Src,
<a name="24904"/>24904:                                                 [{Level, Type} ||
<a name="24905"/>24905:                                                     {Level, _, Type, _} &lt;- Opts],
<a name="24906"/>24906: 						?BASIC_REQ,
<a name="24907"/>24907:                                                 UnexpData]),
<a name="24908"/>24908:                                    {error, {unexpected_data, UnexpData}};
<a name="24909"/>24909:                                {error, _} = ERROR -&gt;
<a name="24910"/>24910:                                    %% At the moment there is no way to get
<a name="24911"/>24911:                                    %% status or state for the socket...
<a name="24912"/>24912:                                    ERROR
<a name="24913"/>24913:                            end
<a name="24914"/>24914:                    end},
<a name="24915"/>24915: 
<a name="24916"/>24916:          #{desc =&gt; &quot;close src socket&quot;,
<a name="24917"/>24917:            cmd  =&gt; fun(#{sock_src := Sock} = State) -&gt;
<a name="24918"/>24918:                            ok = socket:close(Sock),
<a name="24919"/>24919:                            {ok, maps:remove(sock_src, State)}
<a name="24920"/>24920:                    end},
<a name="24921"/>24921:          #{desc =&gt; &quot;close dst socket&quot;,
<a name="24922"/>24922:            cmd  =&gt; fun(#{sock_dst := Sock} = State) -&gt;
<a name="24923"/>24923:                            ok = socket:close(Sock),
<a name="24924"/>24924:                            {ok, maps:remove(sock_dst, State)}
<a name="24925"/>24925:                    end},
<a name="24926"/>24926: 
<a name="24927"/>24927:          %% *** We are done ***
<a name="24928"/>24928:          ?SEV_FINISH_NORMAL
<a name="24929"/>24929:         ],
<a name="24930"/>24930:     Evaluator = ?SEV_START(&quot;tester&quot;, Seq, InitState),
<a name="api_opt_ipv6_mopts_udp-last_expr"/><a name="24931"/>24931: <b>    ok = ?SEV_AWAIT_FINISH</b>([Evaluator]).
<a name="24932"/>24932: 
<a name="24933"/>24933: 
<a name="24934"/>24934: 
<a name="24935"/>24935: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="24936"/>24936: 
<a name="24937"/>24937: <i>%% Tests that the congestion tcp socket option.</i>
<a name="24938"/>24938: <i>%%</i>
<a name="24939"/>24939: <i>%% According to the man page (on linux) for this option it *should* be</i>
<a name="24940"/>24940: <i>%% possible to both get and set *allowed* algorithms. But when we attempt</i>
<a name="24941"/>24941: <i>%% to set, we get 'enoent'.</i>
<a name="24942"/>24942: <i>%% According to /proc/sys/net/ipv4/tcp_allowed_congestion_control that</i>
<a name="24943"/>24943: <i>%% allgorithm was allowed, so...</i>
<a name="24944"/>24944: <i>%% For now, we only test that we can get (it could be a bug in our code)</i>
<a name="24945"/>24945: 
<a name="api_opt_tcp_congestion_tcp4-1"/><a name="24946"/>24946: <b>api_opt_tcp_congestion_tcp4</b>(_Config) when is_list(_Config) -&gt;
<a name="24947"/>24947:     ?TT(?SECS(5)),
<a name="api_opt_tcp_congestion_tcp4-last_expr"/><a name="24948"/>24948: <b>    tc_try</b>(api_opt_tcp_congestion_tcp4,
<a name="24949"/>24949:            fun() -&gt; has_support_ipv4(), has_support_tcp_congestion() end,
<a name="24950"/>24950:            fun() -&gt;
<a name="24951"/>24951:                    Set  = fun(Sock, Value) when is_list(Value) -&gt;
<a name="24952"/>24952:                                   socket:setopt(Sock, tcp, congestion, Value)
<a name="24953"/>24953:                           end,
<a name="24954"/>24954:                    Get  = fun(Sock) -&gt;
<a name="24955"/>24955:                                   socket:getopt(Sock, tcp, congestion)
<a name="24956"/>24956:                           end,
<a name="24957"/>24957:                    InitState = #{domain =&gt; inet,
<a name="24958"/>24958:                                  proto  =&gt; tcp,
<a name="24959"/>24959:                                  set    =&gt; Set,
<a name="24960"/>24960:                                  get    =&gt; Get},
<a name="24961"/>24961:                    ok = api_opt_tcp_congestion_tcp(InitState)
<a name="24962"/>24962:            end).
<a name="24963"/>24963: 
<a name="24964"/>24964: 
<a name="24965"/>24965: 
<a name="24966"/>24966: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="24967"/>24967: 
<a name="api_opt_tcp_congestion_tcp-1"/><a name="24968"/>24968: <b>api_opt_tcp_congestion_tcp</b>(InitState) -&gt;
<a name="24969"/>24969:     process_flag(trap_exit, true),
<a name="24970"/>24970:     ServerSeq =
<a name="24971"/>24971:         [
<a name="24972"/>24972:          %% *** Wait for start order ***
<a name="24973"/>24973:          #{desc =&gt; &quot;await start (from tester)&quot;,
<a name="24974"/>24974:            cmd  =&gt; fun(State) -&gt;
<a name="24975"/>24975:                            Tester = ?SEV_AWAIT_START(),
<a name="24976"/>24976:                            {ok, State#{tester =&gt; Tester}}
<a name="24977"/>24977:                    end},
<a name="24978"/>24978:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="24979"/>24979:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="24980"/>24980:                            _MRef = erlang:monitor(process, Tester),
<a name="24981"/>24981:                            ok
<a name="24982"/>24982:                    end},
<a name="24983"/>24983: 
<a name="24984"/>24984:          %% *** Init part ***
<a name="24985"/>24985:          #{desc =&gt; &quot;which local address&quot;,
<a name="24986"/>24986:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="24987"/>24987:                            LSA = which_local_socket_addr(Domain),
<a name="24988"/>24988:                            {ok, State#{lsa =&gt; LSA}}
<a name="24989"/>24989:                    end},
<a name="24990"/>24990:          #{desc =&gt; &quot;create socket&quot;,
<a name="24991"/>24991:            cmd  =&gt; fun(#{domain := Domain,
<a name="24992"/>24992:                          proto  := Proto} = State) -&gt;
<a name="24993"/>24993:                            case socket:open(Domain, stream, Proto) of
<a name="24994"/>24994:                                {ok, Sock} -&gt;
<a name="24995"/>24995:                                    {ok, State#{sock =&gt; Sock}};
<a name="24996"/>24996:                                {error, _} = ERROR -&gt;
<a name="24997"/>24997:                                    ERROR
<a name="24998"/>24998:                            end
<a name="24999"/>24999:                    end},
<a name="25000"/>25000:          #{desc =&gt; &quot;bind to local address&quot;,
<a name="25001"/>25001:            cmd  =&gt; fun(#{sock := LSock, lsa := LSA} = _State) -&gt;
<a name="25002"/>25002:                            case sock_bind(LSock, LSA) of
<a name="25003"/>25003:                                ok -&gt;
<a name="25004"/>25004:                                    Port = sock_port(LSock),
<a name="25005"/>25005:                                    ?SEV_IPRINT(&quot;bound to port: ~w&quot;, [Port]),
<a name="25006"/>25006:                                    ok;
<a name="25007"/>25007:                                {error, _} = ERROR -&gt;
<a name="25008"/>25008:                                    ERROR
<a name="25009"/>25009:                            end
<a name="25010"/>25010:                    end},
<a name="25011"/>25011:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="25012"/>25012:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="25013"/>25013:                            ?SEV_ANNOUNCE_READY(Tester, init),
<a name="25014"/>25014:                            ok
<a name="25015"/>25015:                    end},
<a name="25016"/>25016: 
<a name="25017"/>25017: 
<a name="25018"/>25018:          %% The actual test
<a name="25019"/>25019:          #{desc =&gt; &quot;await continue (get congestion)&quot;,
<a name="25020"/>25020:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="25021"/>25021:                            ?SEV_AWAIT_CONTINUE(Tester, tester, get_congestion)
<a name="25022"/>25022:                    end},
<a name="25023"/>25023:          #{desc =&gt; &quot;get congestion&quot;,
<a name="25024"/>25024:            cmd  =&gt; fun(#{sock := Sock, get := Get} = State) -&gt;
<a name="25025"/>25025:                            case Get(Sock) of
<a name="25026"/>25026:                                {ok, Algorithm} -&gt;
<a name="25027"/>25027:                                    ?SEV_IPRINT(&quot;algorithm: ~s&quot;, [Algorithm]),
<a name="25028"/>25028:                                    {ok, State#{alg =&gt; Algorithm}};
<a name="25029"/>25029:                                {error, _} = ERROR -&gt;
<a name="25030"/>25030:                                    ERROR
<a name="25031"/>25031:                            end
<a name="25032"/>25032:                    end},
<a name="25033"/>25033:          #{desc =&gt; &quot;announce ready (get congestion)&quot;,
<a name="25034"/>25034:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="25035"/>25035:                            ?SEV_ANNOUNCE_READY(Tester, get_congestion),
<a name="25036"/>25036:                            ok
<a name="25037"/>25037:                    end},
<a name="25038"/>25038: 
<a name="25039"/>25039: 
<a name="25040"/>25040:          %% *** Termination ***
<a name="25041"/>25041:          #{desc =&gt; &quot;await terminate&quot;,
<a name="25042"/>25042:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="25043"/>25043:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="25044"/>25044:                                ok -&gt;
<a name="25045"/>25045:                                    {ok, maps:remove(tester, State)};
<a name="25046"/>25046:                                {error, _} = ERROR -&gt;
<a name="25047"/>25047:                                    ERROR
<a name="25048"/>25048:                            end
<a name="25049"/>25049:                    end},
<a name="25050"/>25050:          #{desc =&gt; &quot;close connection socket&quot;,
<a name="25051"/>25051:            cmd  =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="25052"/>25052:                            ok = socket:close(Sock),
<a name="25053"/>25053:                            {ok, maps:remove(sock, State)}
<a name="25054"/>25054:                    end},
<a name="25055"/>25055: 
<a name="25056"/>25056:          %% *** We are done ***
<a name="25057"/>25057:          ?SEV_FINISH_NORMAL
<a name="25058"/>25058:         ],
<a name="25059"/>25059: 
<a name="25060"/>25060: 
<a name="25061"/>25061:     TesterSeq =
<a name="25062"/>25062:         [
<a name="25063"/>25063:          %% *** Init part ***
<a name="25064"/>25064:          #{desc =&gt; &quot;monitor server&quot;,
<a name="25065"/>25065:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="25066"/>25066:                            _MRef = erlang:monitor(process, Pid),
<a name="25067"/>25067:                            ok
<a name="25068"/>25068:                    end},
<a name="25069"/>25069: 
<a name="25070"/>25070:          %% Start the server
<a name="25071"/>25071:          #{desc =&gt; &quot;order server start&quot;,
<a name="25072"/>25072:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="25073"/>25073:                            ?SEV_ANNOUNCE_START(Pid),
<a name="25074"/>25074:                            ok
<a name="25075"/>25075:                    end},
<a name="25076"/>25076:          #{desc =&gt; &quot;await server ready (init)&quot;,
<a name="25077"/>25077:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="25078"/>25078:                            ok = ?SEV_AWAIT_READY(Pid, server, init),
<a name="25079"/>25079:                            ok
<a name="25080"/>25080:                    end},
<a name="25081"/>25081: 
<a name="25082"/>25082:          %% *** The actual test ***
<a name="25083"/>25083:          #{desc =&gt; &quot;order server to continue (with get-congestion)&quot;,
<a name="25084"/>25084:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="25085"/>25085:                            ?SEV_ANNOUNCE_CONTINUE(Server, get_congestion),
<a name="25086"/>25086:                            ok
<a name="25087"/>25087:                    end},
<a name="25088"/>25088:          #{desc =&gt; &quot;await server ready (get-congestion)&quot;,
<a name="25089"/>25089:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="25090"/>25090:                            ?SEV_AWAIT_READY(Server, server, get_congestion)
<a name="25091"/>25091:                    end},
<a name="25092"/>25092: 
<a name="25093"/>25093: 
<a name="25094"/>25094:          %% *** Termination ***
<a name="25095"/>25095:          #{desc =&gt; &quot;order server to terminate&quot;,
<a name="25096"/>25096:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="25097"/>25097:                            ?SEV_ANNOUNCE_TERMINATE(Server),
<a name="25098"/>25098:                            ok
<a name="25099"/>25099:                    end},
<a name="25100"/>25100:          #{desc =&gt; &quot;await server termination&quot;,
<a name="25101"/>25101:            cmd  =&gt; fun(#{server := Server} = State) -&gt;
<a name="25102"/>25102:                            ?SEV_AWAIT_TERMINATION(Server),
<a name="25103"/>25103:                            State1 = maps:remove(server, State),
<a name="25104"/>25104:                            {ok, State1}
<a name="25105"/>25105:                    end},
<a name="25106"/>25106: 
<a name="25107"/>25107:          %% *** We are done ***
<a name="25108"/>25108:          ?SEV_FINISH_NORMAL
<a name="25109"/>25109:         ],
<a name="25110"/>25110: 
<a name="25111"/>25111: 
<a name="25112"/>25112:     i(&quot;start server evaluator&quot;),
<a name="25113"/>25113:     Server = ?SEV_START(&quot;server&quot;, ServerSeq, InitState),
<a name="25114"/>25114: 
<a name="25115"/>25115:     i(&quot;start tester evaluator&quot;),
<a name="25116"/>25116:     TesterInitState = #{server =&gt; Server#ev.pid},
<a name="25117"/>25117:     Tester = ?SEV_START(&quot;tester&quot;, TesterSeq, TesterInitState),
<a name="25118"/>25118: 
<a name="api_opt_tcp_congestion_tcp-last_expr"/><a name="25119"/>25119: <b>    ok = ?SEV_AWAIT_FINISH</b>([Server, Tester]).
<a name="25120"/>25120: 
<a name="25121"/>25121: 
<a name="25122"/>25122: 
<a name="25123"/>25123: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="25124"/>25124: 
<a name="25125"/>25125: <i>%% Tests that the cork tcp socket option.</i>
<a name="25126"/>25126: <i>%%</i>
<a name="25127"/>25127: <i>%% This is a very simple test. We simple set and get the value.</i>
<a name="25128"/>25128: <i>%% To test that it has an effect is just &quot;to much work&quot;...</i>
<a name="25129"/>25129: <i>%%</i>
<a name="25130"/>25130: <i>%% Reading the man page it seems like (on linux) that the</i>
<a name="25131"/>25131: <i>%% value resets itself after some (short) time...</i>
<a name="25132"/>25132: 
<a name="api_opt_tcp_cork_tcp4-1"/><a name="25133"/>25133: <b>api_opt_tcp_cork_tcp4</b>(_Config) when is_list(_Config) -&gt;
<a name="25134"/>25134:     ?TT(?SECS(5)),
<a name="api_opt_tcp_cork_tcp4-last_expr"/><a name="25135"/>25135: <b>    tc_try</b>(api_opt_tcp_cork_tcp4,
<a name="25136"/>25136:            fun() -&gt; has_support_ipv4(), has_support_tcp_cork() end,
<a name="25137"/>25137:            fun() -&gt;
<a name="25138"/>25138:                    Set  = fun(Sock, Value) when is_boolean(Value) -&gt;
<a name="25139"/>25139:                                   socket:setopt(Sock, tcp, cork, Value)
<a name="25140"/>25140:                           end,
<a name="25141"/>25141:                    Get  = fun(Sock) -&gt;
<a name="25142"/>25142:                                   socket:getopt(Sock, tcp, cork)
<a name="25143"/>25143:                           end,
<a name="25144"/>25144:                    InitState = #{domain =&gt; inet,
<a name="25145"/>25145:                                  proto  =&gt; tcp,
<a name="25146"/>25146:                                  set    =&gt; Set,
<a name="25147"/>25147:                                  get    =&gt; Get},
<a name="25148"/>25148:                    ok = api_opt_tcp_cork_tcp(InitState)
<a name="25149"/>25149:            end).
<a name="25150"/>25150: 
<a name="25151"/>25151: 
<a name="25152"/>25152: 
<a name="25153"/>25153: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="25154"/>25154: 
<a name="api_opt_tcp_cork_tcp-1"/><a name="25155"/>25155: <b>api_opt_tcp_cork_tcp</b>(InitState) -&gt;
<a name="25156"/>25156:     process_flag(trap_exit, true),
<a name="25157"/>25157:     TesterSeq =
<a name="25158"/>25158:         [
<a name="25159"/>25159:          %% *** Init part ***
<a name="25160"/>25160:          #{desc =&gt; &quot;which local address&quot;,
<a name="25161"/>25161:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="25162"/>25162:                            LSA = which_local_socket_addr(Domain),
<a name="25163"/>25163:                            {ok, State#{lsa =&gt; LSA}}
<a name="25164"/>25164:                    end},
<a name="25165"/>25165:          #{desc =&gt; &quot;create socket&quot;,
<a name="25166"/>25166:            cmd  =&gt; fun(#{domain := Domain,
<a name="25167"/>25167:                          proto  := Proto} = State) -&gt;
<a name="25168"/>25168:                            case socket:open(Domain, stream, Proto) of
<a name="25169"/>25169:                                {ok, Sock} -&gt;
<a name="25170"/>25170:                                    {ok, State#{sock =&gt; Sock}};
<a name="25171"/>25171:                                {error, _} = ERROR -&gt;
<a name="25172"/>25172:                                    ERROR
<a name="25173"/>25173:                            end
<a name="25174"/>25174:                    end},
<a name="25175"/>25175:          #{desc =&gt; &quot;bind to local address&quot;,
<a name="25176"/>25176:            cmd  =&gt; fun(#{sock := LSock, lsa := LSA} = _State) -&gt;
<a name="25177"/>25177:                            case sock_bind(LSock, LSA) of
<a name="25178"/>25178:                                ok -&gt;
<a name="25179"/>25179:                                    Port = sock_port(LSock),
<a name="25180"/>25180:                                    ?SEV_IPRINT(&quot;bound to port: ~w&quot;, [Port]),
<a name="25181"/>25181:                                    ok;
<a name="25182"/>25182:                                {error, _} = ERROR -&gt;
<a name="25183"/>25183:                                    ERROR
<a name="25184"/>25184:                            end
<a name="25185"/>25185:                    end},
<a name="25186"/>25186: 
<a name="25187"/>25187: 
<a name="25188"/>25188:          %% The actual test
<a name="25189"/>25189:          #{desc =&gt; &quot;get (default) cork (= false)&quot;,
<a name="25190"/>25190:            cmd  =&gt; fun(#{sock := Sock, get := Get} = _State) -&gt;
<a name="25191"/>25191:                            case Get(Sock) of
<a name="25192"/>25192:                                {ok, false = Value} -&gt;
<a name="25193"/>25193:                                    ?SEV_IPRINT(&quot;cork default: ~p&quot;, [Value]),
<a name="25194"/>25194:                                    ok;
<a name="25195"/>25195:                                {error, _} = ERROR -&gt;
<a name="25196"/>25196:                                    ERROR
<a name="25197"/>25197:                            end
<a name="25198"/>25198:                    end},
<a name="25199"/>25199:          #{desc =&gt; &quot;enable cork (=&gt; true)&quot;,
<a name="25200"/>25200:            cmd  =&gt; fun(#{sock := Sock, set := Set} = _State) -&gt;
<a name="25201"/>25201:                            case Set(Sock, true) of
<a name="25202"/>25202:                                ok -&gt;
<a name="25203"/>25203:                                    ?SEV_IPRINT(&quot;cork enabled&quot;),
<a name="25204"/>25204:                                    ok;
<a name="25205"/>25205:                                {error, _} = ERROR -&gt;
<a name="25206"/>25206:                                    ERROR
<a name="25207"/>25207:                            end
<a name="25208"/>25208:                    end},
<a name="25209"/>25209:          #{desc =&gt; &quot;get cork (= true)&quot;,
<a name="25210"/>25210:            cmd  =&gt; fun(#{sock := Sock, get := Get} = _State) -&gt;
<a name="25211"/>25211:                            case Get(Sock) of
<a name="25212"/>25212:                                {ok, true = Value} -&gt;
<a name="25213"/>25213:                                    ?SEV_IPRINT(&quot;cork: ~p&quot;, [Value]),
<a name="25214"/>25214:                                    ok;
<a name="25215"/>25215:                                {error, _} = ERROR -&gt;
<a name="25216"/>25216:                                    ERROR
<a name="25217"/>25217:                            end
<a name="25218"/>25218:                    end},
<a name="25219"/>25219: 
<a name="25220"/>25220: 
<a name="25221"/>25221:          %% *** Termination ***
<a name="25222"/>25222:          #{desc =&gt; &quot;close connection socket&quot;,
<a name="25223"/>25223:            cmd  =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="25224"/>25224:                            ok = socket:close(Sock),
<a name="25225"/>25225:                            {ok, maps:remove(sock, State)}
<a name="25226"/>25226:                    end},
<a name="25227"/>25227: 
<a name="25228"/>25228:          %% *** We are done ***
<a name="25229"/>25229:          ?SEV_FINISH_NORMAL
<a name="25230"/>25230:         ],
<a name="25231"/>25231: 
<a name="25232"/>25232:     i(&quot;start tester evaluator&quot;),
<a name="25233"/>25233:     Tester = ?SEV_START(&quot;tester&quot;, TesterSeq, InitState),
<a name="25234"/>25234: 
<a name="api_opt_tcp_cork_tcp-last_expr"/><a name="25235"/>25235: <b>    ok = ?SEV_AWAIT_FINISH</b>([Tester]).
<a name="25236"/>25236: 
<a name="25237"/>25237: 
<a name="25238"/>25238: 
<a name="25239"/>25239: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="25240"/>25240: 
<a name="25241"/>25241: <i>%% Tests that the maxseg tcp socket option.</i>
<a name="25242"/>25242: <i>%%</i>
<a name="25243"/>25243: <i>%% This is a very simple test. We simple set and get the value.</i>
<a name="25244"/>25244: <i>%% To test that it has an effect is just &quot;to much work&quot;...</i>
<a name="25245"/>25245: <i>%%</i>
<a name="25246"/>25246: <i>%% Note that there is no point in reading this value back,</i>
<a name="25247"/>25247: <i>%% since the kernel imposes its own rules with regard</i>
<a name="25248"/>25248: <i>%% to what is an acceptable value.</i>
<a name="25249"/>25249: <i>%%</i>
<a name="25250"/>25250: 
<a name="api_opt_tcp_maxseg_tcp4-1"/><a name="25251"/>25251: <b>api_opt_tcp_maxseg_tcp4</b>(_Config) when is_list(_Config) -&gt;
<a name="25252"/>25252:     ?TT(?SECS(5)),
<a name="api_opt_tcp_maxseg_tcp4-last_expr"/><a name="25253"/>25253: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="25254"/>25254:            fun() -&gt;
<a name="25255"/>25255:                    has_support_ipv4(),
<a name="25256"/>25256:                    has_support_tcp_maxseg()
<a name="25257"/>25257:            end,
<a name="25258"/>25258:            fun() -&gt;
<a name="25259"/>25259:                    Set  = fun(Sock, Value) when is_integer(Value) -&gt;
<a name="25260"/>25260:                                   socket:setopt(Sock, tcp, maxseg, Value)
<a name="25261"/>25261:                           end,
<a name="25262"/>25262:                    Get  = fun(Sock) -&gt;
<a name="25263"/>25263:                                   socket:getopt(Sock, tcp, maxseg)
<a name="25264"/>25264:                           end,
<a name="25265"/>25265:                    InitState = #{domain =&gt; inet,
<a name="25266"/>25266:                                  proto  =&gt; tcp,
<a name="25267"/>25267:                                  set    =&gt; Set,
<a name="25268"/>25268:                                  get    =&gt; Get},
<a name="25269"/>25269:                    ok = api_opt_tcp_maxseg_tcp(InitState)
<a name="25270"/>25270:            end).
<a name="25271"/>25271: 
<a name="25272"/>25272: 
<a name="25273"/>25273: 
<a name="25274"/>25274: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="25275"/>25275: 
<a name="api_opt_tcp_maxseg_tcp-1"/><a name="25276"/>25276: <b>api_opt_tcp_maxseg_tcp</b>(InitState) -&gt;
<a name="25277"/>25277:     process_flag(trap_exit, true),
<a name="25278"/>25278:     TesterSeq =
<a name="25279"/>25279:         [
<a name="25280"/>25280:          %% *** Init part ***
<a name="25281"/>25281:          #{desc =&gt; &quot;which local address&quot;,
<a name="25282"/>25282:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="25283"/>25283:                            LSA = which_local_socket_addr(Domain),
<a name="25284"/>25284:                            {ok, State#{lsa =&gt; LSA}}
<a name="25285"/>25285:                    end},
<a name="25286"/>25286:          #{desc =&gt; &quot;create socket&quot;,
<a name="25287"/>25287:            cmd  =&gt; fun(#{domain := Domain,
<a name="25288"/>25288:                          proto  := Proto} = State) -&gt;
<a name="25289"/>25289:                            case socket:open(Domain, stream, Proto) of
<a name="25290"/>25290:                                {ok, Sock} -&gt;
<a name="25291"/>25291:                                    {ok, State#{sock =&gt; Sock}};
<a name="25292"/>25292:                                {error, _} = ERROR -&gt;
<a name="25293"/>25293:                                    ERROR
<a name="25294"/>25294:                            end
<a name="25295"/>25295:                    end},
<a name="25296"/>25296:          #{desc =&gt; &quot;bind to local address&quot;,
<a name="25297"/>25297:            cmd  =&gt; fun(#{sock := LSock, lsa := LSA} = _State) -&gt;
<a name="25298"/>25298:                            case sock_bind(LSock, LSA) of
<a name="25299"/>25299:                                ok -&gt;
<a name="25300"/>25300:                                    Port = sock_port(LSock),
<a name="25301"/>25301:                                    ?SEV_IPRINT(&quot;bound to port: ~w&quot;, [Port]),
<a name="25302"/>25302:                                    ok;
<a name="25303"/>25303:                                {error, _} = ERROR -&gt;
<a name="25304"/>25304:                                    ERROR
<a name="25305"/>25305:                            end
<a name="25306"/>25306:                    end},
<a name="25307"/>25307: 
<a name="25308"/>25308: 
<a name="25309"/>25309:          %% The actual test
<a name="25310"/>25310:          #{desc =&gt; &quot;get (default) maxseg&quot;,
<a name="25311"/>25311:            cmd  =&gt; fun(#{sock := Sock, get := Get} = State) -&gt;
<a name="25312"/>25312:                            case Get(Sock) of
<a name="25313"/>25313:                                {ok, DefMaxSeg} -&gt;
<a name="25314"/>25314:                                    ?SEV_IPRINT(&quot;maxseg default: ~p&quot;, [DefMaxSeg]),
<a name="25315"/>25315:                                    {ok, State#{def_maxseg =&gt; DefMaxSeg}};
<a name="25316"/>25316:                                {error, enoprotoopt = Reason} -&gt;
<a name="25317"/>25317:                                    {skip, Reason};
<a name="25318"/>25318:                                {error, _} = ERROR -&gt;
<a name="25319"/>25319:                                    ERROR
<a name="25320"/>25320:                            end
<a name="25321"/>25321:                    end},
<a name="25322"/>25322:          
<a name="25323"/>25323:          %% Note that there is no point in reading this value back,
<a name="25324"/>25324:          %% since the kernel imposes its own rules with regard
<a name="25325"/>25325:          %% to what is an acceptable value.
<a name="25326"/>25326:          %% So, even if the set operation is a success, the value
<a name="25327"/>25327:          %% still might not have changed.
<a name="25328"/>25328:          %%
<a name="25329"/>25329:          %% Note that not all platforms allow this to be set!
<a name="25330"/>25330:          %% Since this is the *last* operation in the test sequence
<a name="25331"/>25331:          %% (before termination) we also accept error reason = einval
<a name="25332"/>25332:          %% as success (rather then skip).
<a name="25333"/>25333:          %% The same goes for the error reason = enoprotoopt (Solaris).
<a name="25334"/>25334:          #{desc =&gt; &quot;(maybe) change maxseg (default + 16)&quot;,
<a name="25335"/>25335:            cmd  =&gt; fun(#{sock       := Sock,
<a name="25336"/>25336:                          set        := Set,
<a name="25337"/>25337:                          def_maxseg := DefMaxSeg} = _State) -&gt;
<a name="25338"/>25338:                            NewMaxSeg = DefMaxSeg + 16,
<a name="25339"/>25339:                            case Set(Sock, NewMaxSeg) of
<a name="25340"/>25340:                                ok -&gt;
<a name="25341"/>25341:                                    ?SEV_IPRINT(&quot;maxseg (maybe) changed (to ~w)&quot;,
<a name="25342"/>25342:                                                [NewMaxSeg]),
<a name="25343"/>25343:                                    ok;
<a name="25344"/>25344:                                {error, Reason} when (Reason =:= einval) orelse
<a name="25345"/>25345:                                                     (Reason =:= enoprotoopt) -&gt;
<a name="25346"/>25346:                                    ?SEV_IPRINT(&quot;change not allowed (~w)&quot;,
<a name="25347"/>25347:                                                [Reason]),
<a name="25348"/>25348:                                    ok;
<a name="25349"/>25349:                                {error, _} = ERROR -&gt;
<a name="25350"/>25350:                                    ERROR
<a name="25351"/>25351:                            end
<a name="25352"/>25352:                    end},
<a name="25353"/>25353: 
<a name="25354"/>25354:          %% *** Termination ***
<a name="25355"/>25355:          #{desc =&gt; &quot;close connection socket&quot;,
<a name="25356"/>25356:            cmd  =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="25357"/>25357:                            ok = socket:close(Sock),
<a name="25358"/>25358:                            {ok, maps:remove(sock, State)}
<a name="25359"/>25359:                    end},
<a name="25360"/>25360: 
<a name="25361"/>25361:          %% *** We are done ***
<a name="25362"/>25362:          ?SEV_FINISH_NORMAL
<a name="25363"/>25363:         ],
<a name="25364"/>25364: 
<a name="25365"/>25365:     i(&quot;start tester evaluator&quot;),
<a name="25366"/>25366:     Tester = ?SEV_START(&quot;tester&quot;, TesterSeq, InitState),
<a name="25367"/>25367: 
<a name="api_opt_tcp_maxseg_tcp-last_expr"/><a name="25368"/>25368: <b>    ok = ?SEV_AWAIT_FINISH</b>([Tester]).
<a name="25369"/>25369: 
<a name="25370"/>25370: 
<a name="25371"/>25371: 
<a name="25372"/>25372: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="25373"/>25373: 
<a name="25374"/>25374: <i>%% Tests that the nodelay tcp socket option.</i>
<a name="25375"/>25375: <i>%%</i>
<a name="25376"/>25376: <i>%% This is a very simple test. We simple set and get the value.</i>
<a name="25377"/>25377: <i>%% To test that it has an effect is just &quot;to much work&quot;...</i>
<a name="25378"/>25378: 
<a name="api_opt_tcp_nodelay_tcp4-1"/><a name="25379"/>25379: <b>api_opt_tcp_nodelay_tcp4</b>(_Config) when is_list(_Config) -&gt;
<a name="25380"/>25380:     ?TT(?SECS(5)),
<a name="api_opt_tcp_nodelay_tcp4-last_expr"/><a name="25381"/>25381: <b>    tc_try</b>(api_opt_tcp_nodelay_tcp4,
<a name="25382"/>25382:            fun() -&gt; has_support_ipv4(), has_support_tcp_nodelay() end,
<a name="25383"/>25383:            fun() -&gt;
<a name="25384"/>25384:                    Set  = fun(Sock, Value) when is_boolean(Value) -&gt;
<a name="25385"/>25385:                                   socket:setopt(Sock, tcp, nodelay, Value)
<a name="25386"/>25386:                           end,
<a name="25387"/>25387:                    Get  = fun(Sock) -&gt;
<a name="25388"/>25388:                                   socket:getopt(Sock, tcp, nodelay)
<a name="25389"/>25389:                           end,
<a name="25390"/>25390:                    InitState = #{domain =&gt; inet,
<a name="25391"/>25391:                                  proto  =&gt; tcp,
<a name="25392"/>25392:                                  set    =&gt; Set,
<a name="25393"/>25393:                                  get    =&gt; Get},
<a name="25394"/>25394:                    ok = api_opt_tcp_nodelay_tcp(InitState)
<a name="25395"/>25395:            end).
<a name="25396"/>25396: 
<a name="25397"/>25397: 
<a name="25398"/>25398: 
<a name="25399"/>25399: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="25400"/>25400: 
<a name="api_opt_tcp_nodelay_tcp-1"/><a name="25401"/>25401: <b>api_opt_tcp_nodelay_tcp</b>(InitState) -&gt;
<a name="25402"/>25402:     process_flag(trap_exit, true),
<a name="25403"/>25403:     TesterSeq =
<a name="25404"/>25404:         [
<a name="25405"/>25405:          %% *** Init part ***
<a name="25406"/>25406:          #{desc =&gt; &quot;which local address&quot;,
<a name="25407"/>25407:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="25408"/>25408:                            LSA = which_local_socket_addr(Domain),
<a name="25409"/>25409:                            {ok, State#{lsa =&gt; LSA}}
<a name="25410"/>25410:                    end},
<a name="25411"/>25411:          #{desc =&gt; &quot;create socket&quot;,
<a name="25412"/>25412:            cmd  =&gt; fun(#{domain := Domain,
<a name="25413"/>25413:                          proto  := Proto} = State) -&gt;
<a name="25414"/>25414:                            case socket:open(Domain, stream, Proto) of
<a name="25415"/>25415:                                {ok, Sock} -&gt;
<a name="25416"/>25416:                                    {ok, State#{sock =&gt; Sock}};
<a name="25417"/>25417:                                {error, _} = ERROR -&gt;
<a name="25418"/>25418:                                    ERROR
<a name="25419"/>25419:                            end
<a name="25420"/>25420:                    end},
<a name="25421"/>25421:          #{desc =&gt; &quot;bind to local address&quot;,
<a name="25422"/>25422:            cmd  =&gt; fun(#{sock := Sock, lsa := LSA} = _State) -&gt;
<a name="25423"/>25423:                            case sock_bind(Sock, LSA) of
<a name="25424"/>25424:                                ok -&gt;
<a name="25425"/>25425:                                    Port = sock_port(Sock),
<a name="25426"/>25426:                                    ?SEV_IPRINT(&quot;bound to port: ~w&quot;, [Port]),
<a name="25427"/>25427:                                    ok;
<a name="25428"/>25428:                                {error, _} = ERROR -&gt;
<a name="25429"/>25429:                                    ERROR
<a name="25430"/>25430:                            end
<a name="25431"/>25431:                    end},
<a name="25432"/>25432: 
<a name="25433"/>25433: 
<a name="25434"/>25434:          %% The actual test
<a name="25435"/>25435:          #{desc =&gt; &quot;get (default) nodelay (= false)&quot;,
<a name="25436"/>25436:            cmd  =&gt; fun(#{sock := Sock, get := Get} = _State) -&gt;
<a name="25437"/>25437:                            case Get(Sock) of
<a name="25438"/>25438:                                {ok, false = Value} -&gt;
<a name="25439"/>25439:                                    ?SEV_IPRINT(&quot;nodelay default: ~p&quot;, [Value]),
<a name="25440"/>25440:                                    ok;
<a name="25441"/>25441:                                {error, _} = ERROR -&gt;
<a name="25442"/>25442:                                    ERROR
<a name="25443"/>25443:                            end
<a name="25444"/>25444:                    end},
<a name="25445"/>25445:          #{desc =&gt; &quot;enable nodelay (=&gt; true)&quot;,
<a name="25446"/>25446:            cmd  =&gt; fun(#{sock := Sock, set := Set} = _State) -&gt;
<a name="25447"/>25447:                            case Set(Sock, true) of
<a name="25448"/>25448:                                ok -&gt;
<a name="25449"/>25449:                                    ?SEV_IPRINT(&quot;nodelay enabled&quot;),
<a name="25450"/>25450:                                    ok;
<a name="25451"/>25451:                                {error, _} = ERROR -&gt;
<a name="25452"/>25452:                                    ERROR
<a name="25453"/>25453:                            end
<a name="25454"/>25454:                    end},
<a name="25455"/>25455:          #{desc =&gt; &quot;get nodelay (= true)&quot;,
<a name="25456"/>25456:            cmd  =&gt; fun(#{sock := Sock, get := Get} = _State) -&gt;
<a name="25457"/>25457:                            case Get(Sock) of
<a name="25458"/>25458:                                {ok, true = Value} -&gt;
<a name="25459"/>25459:                                    ?SEV_IPRINT(&quot;nodelay: ~p&quot;, [Value]),
<a name="25460"/>25460:                                    ok;
<a name="25461"/>25461:                                {error, _} = ERROR -&gt;
<a name="25462"/>25462:                                    ERROR
<a name="25463"/>25463:                            end
<a name="25464"/>25464:                    end},
<a name="25465"/>25465: 
<a name="25466"/>25466: 
<a name="25467"/>25467:          %% *** Termination ***
<a name="25468"/>25468:          #{desc =&gt; &quot;close socket&quot;,
<a name="25469"/>25469:            cmd  =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="25470"/>25470:                            ok = socket:close(Sock),
<a name="25471"/>25471:                            {ok, maps:remove(sock, State)}
<a name="25472"/>25472:                    end},
<a name="25473"/>25473: 
<a name="25474"/>25474:          %% *** We are done ***
<a name="25475"/>25475:          ?SEV_FINISH_NORMAL
<a name="25476"/>25476:         ],
<a name="25477"/>25477: 
<a name="25478"/>25478:     i(&quot;start tester evaluator&quot;),
<a name="25479"/>25479:     Tester = ?SEV_START(&quot;tester&quot;, TesterSeq, InitState),
<a name="25480"/>25480: 
<a name="api_opt_tcp_nodelay_tcp-last_expr"/><a name="25481"/>25481: <b>    ok = ?SEV_AWAIT_FINISH</b>([Tester]).
<a name="25482"/>25482: 
<a name="25483"/>25483: 
<a name="25484"/>25484: 
<a name="25485"/>25485: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="25486"/>25486: 
<a name="25487"/>25487: <i>%% Tests that the keepcnt tcp socket option.</i>
<a name="25488"/>25488: <i>%%</i>
<a name="25489"/>25489: <i>%% &quot;The maximum number of keepalive probes TCP should send before</i>
<a name="25490"/>25490: <i>%%  dropping the connection&quot;</i>
<a name="25491"/>25491: <i>%%</i>
<a name="25492"/>25492: 
<a name="api_opt_tcp_keepcnt_tcp4-1"/><a name="25493"/>25493: <b>api_opt_tcp_keepcnt_tcp4</b>(_Config) when is_list(_Config) -&gt;
<a name="25494"/>25494:     ?TT(?SECS(5)),
<a name="api_opt_tcp_keepcnt_tcp4-last_expr"/><a name="25495"/>25495: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="25496"/>25496:            fun() -&gt; has_support_ipv4(), has_support_tcp_keepcnt() end,
<a name="25497"/>25497:            fun() -&gt;
<a name="25498"/>25498:                    Set  = fun(Sock, Value) when is_integer(Value) -&gt;
<a name="25499"/>25499:                                   socket:setopt(Sock, tcp, keepcnt, Value)
<a name="25500"/>25500:                           end,
<a name="25501"/>25501:                    Get  = fun(Sock) -&gt;
<a name="25502"/>25502:                                   socket:getopt(Sock, tcp, keepcnt)
<a name="25503"/>25503:                           end,
<a name="25504"/>25504:                    InitState = #{domain =&gt; inet,
<a name="25505"/>25505:                                  proto  =&gt; tcp,
<a name="25506"/>25506:                                  set    =&gt; Set,
<a name="25507"/>25507:                                  get    =&gt; Get},
<a name="25508"/>25508:                    ok = api_opt_tcp_keepcnt_tcp(InitState)
<a name="25509"/>25509:            end).
<a name="25510"/>25510: 
<a name="25511"/>25511: 
<a name="25512"/>25512: 
<a name="25513"/>25513: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="25514"/>25514: 
<a name="api_opt_tcp_keepcnt_tcp-1"/><a name="25515"/>25515: <b>api_opt_tcp_keepcnt_tcp</b>(InitState) -&gt;
<a name="25516"/>25516:     process_flag(trap_exit, true),
<a name="25517"/>25517:     ServerSeq =
<a name="25518"/>25518:         [
<a name="25519"/>25519:          %% *** Wait for start order ***
<a name="25520"/>25520:          #{desc =&gt; &quot;await start (from tester)&quot;,
<a name="25521"/>25521:            cmd  =&gt; fun(State) -&gt;
<a name="25522"/>25522:                            Tester = ?SEV_AWAIT_START(),
<a name="25523"/>25523:                            {ok, State#{tester =&gt; Tester}}
<a name="25524"/>25524:                    end},
<a name="25525"/>25525:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="25526"/>25526:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="25527"/>25527:                            _MRef = erlang:monitor(process, Tester),
<a name="25528"/>25528:                            ok
<a name="25529"/>25529:                    end},
<a name="25530"/>25530: 
<a name="25531"/>25531:          %% *** Init part ***
<a name="25532"/>25532:          #{desc =&gt; &quot;which local address&quot;,
<a name="25533"/>25533:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="25534"/>25534:                            LSA = which_local_socket_addr(Domain),
<a name="25535"/>25535:                            {ok, State#{lsa =&gt; LSA}}
<a name="25536"/>25536:                    end},
<a name="25537"/>25537:          #{desc =&gt; &quot;create socket&quot;,
<a name="25538"/>25538:            cmd  =&gt; fun(#{domain := Domain,
<a name="25539"/>25539:                          proto  := Proto} = State) -&gt;
<a name="25540"/>25540:                            case socket:open(Domain, stream, Proto) of
<a name="25541"/>25541:                                {ok, Sock} -&gt;
<a name="25542"/>25542:                                    {ok, State#{sock =&gt; Sock}};
<a name="25543"/>25543:                                {error, _} = ERROR -&gt;
<a name="25544"/>25544:                                    ERROR
<a name="25545"/>25545:                            end
<a name="25546"/>25546:                    end},
<a name="25547"/>25547:          #{desc =&gt; &quot;bind to local address&quot;,
<a name="25548"/>25548:            cmd  =&gt; fun(#{sock := LSock, lsa := LSA} = _State) -&gt;
<a name="25549"/>25549:                            case sock_bind(LSock, LSA) of
<a name="25550"/>25550:                                ok -&gt;
<a name="25551"/>25551:                                    Port = sock_port(LSock),
<a name="25552"/>25552:                                    ?SEV_IPRINT(&quot;bound to port: ~w&quot;, [Port]),
<a name="25553"/>25553:                                    ok;
<a name="25554"/>25554:                                {error, _} = ERROR -&gt;
<a name="25555"/>25555:                                    ERROR
<a name="25556"/>25556:                            end
<a name="25557"/>25557:                    end},
<a name="25558"/>25558:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="25559"/>25559:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="25560"/>25560:                            ?SEV_ANNOUNCE_READY(Tester, init),
<a name="25561"/>25561:                            ok
<a name="25562"/>25562:                    end},
<a name="25563"/>25563: 
<a name="25564"/>25564: 
<a name="25565"/>25565:          %% The actual test
<a name="25566"/>25566:          #{desc =&gt; &quot;await continue (get keepcnt(1))&quot;,
<a name="25567"/>25567:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="25568"/>25568:                            ?SEV_AWAIT_CONTINUE(Tester, tester, get_keepcnt)
<a name="25569"/>25569:                    end},
<a name="25570"/>25570:          #{desc =&gt; &quot;get keepcnt&quot;,
<a name="25571"/>25571:            cmd  =&gt; fun(#{sock := Sock, get := Get} = State) -&gt;
<a name="25572"/>25572:                            case Get(Sock) of
<a name="25573"/>25573:                                {ok, KeepCnt} -&gt;
<a name="25574"/>25574:                                    ?SEV_IPRINT(&quot;keepcnt: ~p&quot;, [KeepCnt]),
<a name="25575"/>25575:                                    {ok, State#{keepcnt =&gt; KeepCnt}};
<a name="25576"/>25576:                                {error, _} = ERROR -&gt;
<a name="25577"/>25577:                                    ERROR
<a name="25578"/>25578:                            end
<a name="25579"/>25579:                    end},
<a name="25580"/>25580:          #{desc =&gt; &quot;announce ready (get keepcnt(1))&quot;,
<a name="25581"/>25581:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="25582"/>25582:                            ?SEV_ANNOUNCE_READY(Tester, get_keepcnt),
<a name="25583"/>25583:                            ok
<a name="25584"/>25584:                    end},
<a name="25585"/>25585: 
<a name="25586"/>25586: 
<a name="25587"/>25587:          #{desc =&gt; &quot;await continue (set keepcnt)&quot;,
<a name="25588"/>25588:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="25589"/>25589:                            ?SEV_AWAIT_CONTINUE(Tester, tester, set_keepcnt)
<a name="25590"/>25590:                    end},
<a name="25591"/>25591:          #{desc =&gt; &quot;set keepcnt&quot;,
<a name="25592"/>25592:            cmd  =&gt; fun(#{sock    := Sock,
<a name="25593"/>25593:                          set     := Set,
<a name="25594"/>25594:                          keepcnt := KeepCnt} = State) -&gt;
<a name="25595"/>25595:                            NewKeepCnt =
<a name="25596"/>25596:                                if
<a name="25597"/>25597:                                    (KeepCnt &gt;= 255) -&gt;
<a name="25598"/>25598:                                        KeepCnt - 1;
<a name="25599"/>25599:                                    true -&gt;
<a name="25600"/>25600:                                        KeepCnt + 1
<a name="25601"/>25601:                                end,
<a name="25602"/>25602:                            case Set(Sock, NewKeepCnt) of
<a name="25603"/>25603:                                ok -&gt;
<a name="25604"/>25604:                                    ?SEV_IPRINT(&quot;keepcnt updated (to ~p)&quot;,
<a name="25605"/>25605:                                                [NewKeepCnt]),
<a name="25606"/>25606:                                    {ok, State#{keepcnt =&gt; NewKeepCnt}};
<a name="25607"/>25607:                                {error, _} = ERROR -&gt;
<a name="25608"/>25608:                                    ERROR
<a name="25609"/>25609:                            end
<a name="25610"/>25610:                    end},
<a name="25611"/>25611:          #{desc =&gt; &quot;announce ready (set keepcnt)&quot;,
<a name="25612"/>25612:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="25613"/>25613:                            ?SEV_ANNOUNCE_READY(Tester, set_keepcnt),
<a name="25614"/>25614:                            ok
<a name="25615"/>25615:                    end},
<a name="25616"/>25616: 
<a name="25617"/>25617: 
<a name="25618"/>25618:          #{desc =&gt; &quot;await continue (get keepcnt(2))&quot;,
<a name="25619"/>25619:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="25620"/>25620:                            ?SEV_AWAIT_CONTINUE(Tester, tester, get_keepcnt)
<a name="25621"/>25621:                    end},
<a name="25622"/>25622:          #{desc =&gt; &quot;get keepcnt(2)&quot;,
<a name="25623"/>25623:            cmd  =&gt; fun(#{sock    := Sock,
<a name="25624"/>25624:                          get     := Get,
<a name="25625"/>25625:                          keepcnt := ExpKeepCnt} = _State) -&gt;
<a name="25626"/>25626:                            case Get(Sock) of
<a name="25627"/>25627:                                {ok, KeepCnt} when (ExpKeepCnt =:= KeepCnt) -&gt;
<a name="25628"/>25628:                                    ?SEV_IPRINT(&quot;expected keepcnt (~p)&quot;,
<a name="25629"/>25629:                                                [ExpKeepCnt]),
<a name="25630"/>25630:                                    ok;
<a name="25631"/>25631:                                {ok, KeepCnt} -&gt;
<a name="25632"/>25632:                                    ?SEV_EPRINT(&quot;unexpected keepcnt:&quot;
<a name="25633"/>25633:                                                &quot;~n   Expected KeepCnt: ~p&quot;
<a name="25634"/>25634:                                                &quot;~n   Actual KeepCnt:   ~p&quot;,
<a name="25635"/>25635:                                                [ExpKeepCnt, KeepCnt]),
<a name="25636"/>25636:                                    {error,
<a name="25637"/>25637:                                     {unexpected_keepcnt, ExpKeepCnt, KeepCnt}};
<a name="25638"/>25638:                                {error, Reason} = ERROR -&gt;
<a name="25639"/>25639:                                    ?SEV_EPRINT(&quot;failed get keepcnt: &quot;
<a name="25640"/>25640:                                                &quot;~n   ~p&quot;, [Reason]),
<a name="25641"/>25641:                                    ERROR
<a name="25642"/>25642:                            end
<a name="25643"/>25643:                    end},
<a name="25644"/>25644:          #{desc =&gt; &quot;announce ready (get keepcnt)&quot;,
<a name="25645"/>25645:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="25646"/>25646:                            ?SEV_ANNOUNCE_READY(Tester, get_keepcnt),
<a name="25647"/>25647:                            ok
<a name="25648"/>25648:                    end},
<a name="25649"/>25649: 
<a name="25650"/>25650: 
<a name="25651"/>25651:          %% *** Termination ***
<a name="25652"/>25652:          #{desc =&gt; &quot;await terminate&quot;,
<a name="25653"/>25653:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="25654"/>25654:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="25655"/>25655:                                ok -&gt;
<a name="25656"/>25656:                                    {ok, maps:remove(tester, State)};
<a name="25657"/>25657:                                {error, _} = ERROR -&gt;
<a name="25658"/>25658:                                    ERROR
<a name="25659"/>25659:                            end
<a name="25660"/>25660:                    end},
<a name="25661"/>25661:          #{desc =&gt; &quot;close connection socket&quot;,
<a name="25662"/>25662:            cmd  =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="25663"/>25663:                            ok = socket:close(Sock),
<a name="25664"/>25664:                            {ok, maps:remove(sock, State)}
<a name="25665"/>25665:                    end},
<a name="25666"/>25666: 
<a name="25667"/>25667:          %% *** We are done ***
<a name="25668"/>25668:          ?SEV_FINISH_NORMAL
<a name="25669"/>25669:         ],
<a name="25670"/>25670: 
<a name="25671"/>25671: 
<a name="25672"/>25672:     TesterSeq =
<a name="25673"/>25673:         [
<a name="25674"/>25674:          %% *** Init part ***
<a name="25675"/>25675:          #{desc =&gt; &quot;monitor server&quot;,
<a name="25676"/>25676:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="25677"/>25677:                            _MRef = erlang:monitor(process, Pid),
<a name="25678"/>25678:                            ok
<a name="25679"/>25679:                    end},
<a name="25680"/>25680: 
<a name="25681"/>25681:          %% Start the server
<a name="25682"/>25682:          #{desc =&gt; &quot;order server start&quot;,
<a name="25683"/>25683:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="25684"/>25684:                            ?SEV_ANNOUNCE_START(Pid),
<a name="25685"/>25685:                            ok
<a name="25686"/>25686:                    end},
<a name="25687"/>25687:          #{desc =&gt; &quot;await server ready (init)&quot;,
<a name="25688"/>25688:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="25689"/>25689:                            ok = ?SEV_AWAIT_READY(Pid, server, init),
<a name="25690"/>25690:                            ok
<a name="25691"/>25691:                    end},
<a name="25692"/>25692: 
<a name="25693"/>25693:          %% *** The actual test ***
<a name="25694"/>25694:          #{desc =&gt; &quot;order server to continue (with get-keepcnt(1))&quot;,
<a name="25695"/>25695:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="25696"/>25696:                            ?SEV_ANNOUNCE_CONTINUE(Server, get_keepcnt),
<a name="25697"/>25697:                            ok
<a name="25698"/>25698:                    end},
<a name="25699"/>25699:          #{desc =&gt; &quot;await server ready (get-keepcnt(1))&quot;,
<a name="25700"/>25700:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="25701"/>25701:                            ?SEV_AWAIT_READY(Server, server, get_keepcnt)
<a name="25702"/>25702:                    end},
<a name="25703"/>25703: 
<a name="25704"/>25704:          #{desc =&gt; &quot;order server to continue (with set-keepcnt)&quot;,
<a name="25705"/>25705:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="25706"/>25706:                            ?SEV_ANNOUNCE_CONTINUE(Server, set_keepcnt),
<a name="25707"/>25707:                            ok
<a name="25708"/>25708:                    end},
<a name="25709"/>25709:          #{desc =&gt; &quot;await server ready (set-keepcnt)&quot;,
<a name="25710"/>25710:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="25711"/>25711:                            ?SEV_AWAIT_READY(Server, server, set_keepcnt)
<a name="25712"/>25712:                    end},
<a name="25713"/>25713: 
<a name="25714"/>25714:          #{desc =&gt; &quot;order server to continue (with get-keepcnt(2))&quot;,
<a name="25715"/>25715:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="25716"/>25716:                            ?SEV_ANNOUNCE_CONTINUE(Server, get_keepcnt),
<a name="25717"/>25717:                            ok
<a name="25718"/>25718:                    end},
<a name="25719"/>25719:          #{desc =&gt; &quot;await server ready (get-keepcnt(2))&quot;,
<a name="25720"/>25720:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="25721"/>25721:                            ?SEV_AWAIT_READY(Server, server, get_keepcnt)
<a name="25722"/>25722:                    end},
<a name="25723"/>25723: 
<a name="25724"/>25724: 
<a name="25725"/>25725:          %% *** Termination ***
<a name="25726"/>25726:          #{desc =&gt; &quot;order server to terminate&quot;,
<a name="25727"/>25727:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="25728"/>25728:                            ?SEV_ANNOUNCE_TERMINATE(Server),
<a name="25729"/>25729:                            ok
<a name="25730"/>25730:                    end},
<a name="25731"/>25731:          #{desc =&gt; &quot;await server termination&quot;,
<a name="25732"/>25732:            cmd  =&gt; fun(#{server := Server} = State) -&gt;
<a name="25733"/>25733:                            ?SEV_AWAIT_TERMINATION(Server),
<a name="25734"/>25734:                            State1 = maps:remove(server, State),
<a name="25735"/>25735:                            {ok, State1}
<a name="25736"/>25736:                    end},
<a name="25737"/>25737: 
<a name="25738"/>25738:          %% *** We are done ***
<a name="25739"/>25739:          ?SEV_FINISH_NORMAL
<a name="25740"/>25740:         ],
<a name="25741"/>25741: 
<a name="25742"/>25742: 
<a name="25743"/>25743:     i(&quot;start server evaluator&quot;),
<a name="25744"/>25744:     Server = ?SEV_START(&quot;server&quot;, ServerSeq, InitState),
<a name="25745"/>25745: 
<a name="25746"/>25746:     i(&quot;start tester evaluator&quot;),
<a name="25747"/>25747:     TesterInitState = #{server =&gt; Server#ev.pid},
<a name="25748"/>25748:     Tester = ?SEV_START(&quot;tester&quot;, TesterSeq, TesterInitState),
<a name="25749"/>25749: 
<a name="api_opt_tcp_keepcnt_tcp-last_expr"/><a name="25750"/>25750: <b>    ok = ?SEV_AWAIT_FINISH</b>([Server, Tester]).
<a name="25751"/>25751: 
<a name="25752"/>25752: 
<a name="25753"/>25753: 
<a name="25754"/>25754: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="25755"/>25755: 
<a name="25756"/>25756: <i>%% Tests that the keepidle tcp socket option.</i>
<a name="25757"/>25757: <i>%%</i>
<a name="25758"/>25758: <i>%% &quot;Gets or sets the number of seconds a TCP connection will remain</i>
<a name="25759"/>25759: <i>%%  idle before keepalive probes are sent to the remote.&quot;</i>
<a name="25760"/>25760: <i>%%</i>
<a name="25761"/>25761: 
<a name="api_opt_tcp_keepidle_tcp4-1"/><a name="25762"/>25762: <b>api_opt_tcp_keepidle_tcp4</b>(_Config) when is_list(_Config) -&gt;
<a name="25763"/>25763:     ?TT(?SECS(5)),
<a name="api_opt_tcp_keepidle_tcp4-last_expr"/><a name="25764"/>25764: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="25765"/>25765:            fun() -&gt; has_support_ipv4(), has_support_tcp_keepidle() end,
<a name="25766"/>25766:            fun() -&gt;
<a name="25767"/>25767:                    Set  = fun(Sock, Value) when is_integer(Value) -&gt;
<a name="25768"/>25768:                                   socket:setopt(Sock, tcp, keepidle, Value)
<a name="25769"/>25769:                           end,
<a name="25770"/>25770:                    Get  = fun(Sock) -&gt;
<a name="25771"/>25771:                                   socket:getopt(Sock, tcp, keepidle)
<a name="25772"/>25772:                           end,
<a name="25773"/>25773:                    InitState = #{domain =&gt; inet,
<a name="25774"/>25774:                                  proto  =&gt; tcp,
<a name="25775"/>25775:                                  set    =&gt; Set,
<a name="25776"/>25776:                                  get    =&gt; Get},
<a name="25777"/>25777:                    ok = api_opt_tcp_keepidle_tcp(InitState)
<a name="25778"/>25778:            end).
<a name="25779"/>25779: 
<a name="25780"/>25780: 
<a name="25781"/>25781: 
<a name="25782"/>25782: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="25783"/>25783: 
<a name="api_opt_tcp_keepidle_tcp-1"/><a name="25784"/>25784: <b>api_opt_tcp_keepidle_tcp</b>(InitState) -&gt;
<a name="25785"/>25785:     process_flag(trap_exit, true),
<a name="25786"/>25786:     ServerSeq =
<a name="25787"/>25787:         [
<a name="25788"/>25788:          %% *** Wait for start order ***
<a name="25789"/>25789:          #{desc =&gt; &quot;await start (from tester)&quot;,
<a name="25790"/>25790:            cmd  =&gt; fun(State) -&gt;
<a name="25791"/>25791:                            Tester = ?SEV_AWAIT_START(),
<a name="25792"/>25792:                            {ok, State#{tester =&gt; Tester}}
<a name="25793"/>25793:                    end},
<a name="25794"/>25794:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="25795"/>25795:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="25796"/>25796:                            _MRef = erlang:monitor(process, Tester),
<a name="25797"/>25797:                            ok
<a name="25798"/>25798:                    end},
<a name="25799"/>25799: 
<a name="25800"/>25800:          %% *** Init part ***
<a name="25801"/>25801:          #{desc =&gt; &quot;which local address&quot;,
<a name="25802"/>25802:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="25803"/>25803:                            LSA = which_local_socket_addr(Domain),
<a name="25804"/>25804:                            {ok, State#{lsa =&gt; LSA}}
<a name="25805"/>25805:                    end},
<a name="25806"/>25806:          #{desc =&gt; &quot;create socket&quot;,
<a name="25807"/>25807:            cmd  =&gt; fun(#{domain := Domain,
<a name="25808"/>25808:                          proto  := Proto} = State) -&gt;
<a name="25809"/>25809:                            case socket:open(Domain, stream, Proto) of
<a name="25810"/>25810:                                {ok, Sock} -&gt;
<a name="25811"/>25811:                                    {ok, State#{sock =&gt; Sock}};
<a name="25812"/>25812:                                {error, _} = ERROR -&gt;
<a name="25813"/>25813:                                    ERROR
<a name="25814"/>25814:                            end
<a name="25815"/>25815:                    end},
<a name="25816"/>25816:          #{desc =&gt; &quot;bind to local address&quot;,
<a name="25817"/>25817:            cmd  =&gt; fun(#{sock := LSock, lsa := LSA} = _State) -&gt;
<a name="25818"/>25818:                            case sock_bind(LSock, LSA) of
<a name="25819"/>25819:                                ok -&gt;
<a name="25820"/>25820:                                    Port = sock_port(LSock),
<a name="25821"/>25821:                                    ?SEV_IPRINT(&quot;bound to port: ~w&quot;, [Port]),
<a name="25822"/>25822:                                    ok;
<a name="25823"/>25823:                                {error, _} = ERROR -&gt;
<a name="25824"/>25824:                                    ERROR
<a name="25825"/>25825:                            end
<a name="25826"/>25826:                    end},
<a name="25827"/>25827:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="25828"/>25828:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="25829"/>25829:                            ?SEV_ANNOUNCE_READY(Tester, init),
<a name="25830"/>25830:                            ok
<a name="25831"/>25831:                    end},
<a name="25832"/>25832: 
<a name="25833"/>25833: 
<a name="25834"/>25834:          %% The actual test
<a name="25835"/>25835:          #{desc =&gt; &quot;await continue (get keepidle(1))&quot;,
<a name="25836"/>25836:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="25837"/>25837:                            ?SEV_AWAIT_CONTINUE(Tester, tester, get_keepidle)
<a name="25838"/>25838:                    end},
<a name="25839"/>25839:          #{desc =&gt; &quot;get keepidle&quot;,
<a name="25840"/>25840:            cmd  =&gt; fun(#{sock := Sock, get := Get} = State) -&gt;
<a name="25841"/>25841:                            case Get(Sock) of
<a name="25842"/>25842:                                {ok, KeepIdle} -&gt;
<a name="25843"/>25843:                                    ?SEV_IPRINT(&quot;keepidle: ~p&quot;, [KeepIdle]),
<a name="25844"/>25844:                                    {ok, State#{keepidle =&gt; KeepIdle}};
<a name="25845"/>25845:                                {error, _} = ERROR -&gt;
<a name="25846"/>25846:                                    ERROR
<a name="25847"/>25847:                            end
<a name="25848"/>25848:                    end},
<a name="25849"/>25849:          #{desc =&gt; &quot;announce ready (get keepidle(1))&quot;,
<a name="25850"/>25850:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="25851"/>25851:                            ?SEV_ANNOUNCE_READY(Tester, get_keepidle),
<a name="25852"/>25852:                            ok
<a name="25853"/>25853:                    end},
<a name="25854"/>25854: 
<a name="25855"/>25855: 
<a name="25856"/>25856:          #{desc =&gt; &quot;await continue (set keepidle)&quot;,
<a name="25857"/>25857:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="25858"/>25858:                            ?SEV_AWAIT_CONTINUE(Tester, tester, set_keepidle)
<a name="25859"/>25859:                    end},
<a name="25860"/>25860:          #{desc =&gt; &quot;set keepidle&quot;,
<a name="25861"/>25861:            cmd  =&gt; fun(#{sock     := Sock,
<a name="25862"/>25862:                          set      := Set,
<a name="25863"/>25863:                          keepidle := KeepIdle} = State) -&gt;
<a name="25864"/>25864:                            NewKeepIdle = KeepIdle + 1,
<a name="25865"/>25865:                            case Set(Sock, NewKeepIdle) of
<a name="25866"/>25866:                                ok -&gt;
<a name="25867"/>25867:                                    ?SEV_IPRINT(&quot;keepidle updated (to ~p)&quot;,
<a name="25868"/>25868:                                                [NewKeepIdle]),
<a name="25869"/>25869:                                    {ok, State#{keepidle =&gt; NewKeepIdle}};
<a name="25870"/>25870:                                {error, _} = ERROR -&gt;
<a name="25871"/>25871:                                    ERROR
<a name="25872"/>25872:                            end
<a name="25873"/>25873:                    end},
<a name="25874"/>25874:          #{desc =&gt; &quot;announce ready (set keepidle)&quot;,
<a name="25875"/>25875:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="25876"/>25876:                            ?SEV_ANNOUNCE_READY(Tester, set_keepidle),
<a name="25877"/>25877:                            ok
<a name="25878"/>25878:                    end},
<a name="25879"/>25879: 
<a name="25880"/>25880: 
<a name="25881"/>25881:          #{desc =&gt; &quot;await continue (get keepidle(2))&quot;,
<a name="25882"/>25882:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="25883"/>25883:                            ?SEV_AWAIT_CONTINUE(Tester, tester, get_keepidle)
<a name="25884"/>25884:                    end},
<a name="25885"/>25885:          #{desc =&gt; &quot;get keepidle(2)&quot;,
<a name="25886"/>25886:            cmd  =&gt; fun(#{sock     := Sock,
<a name="25887"/>25887:                          get      := Get,
<a name="25888"/>25888:                          keepidle := ExpKeepIdle} = _State) -&gt;
<a name="25889"/>25889:                            case Get(Sock) of
<a name="25890"/>25890:                                {ok, KeepIdle} when (ExpKeepIdle =:= KeepIdle) -&gt;
<a name="25891"/>25891:                                    ?SEV_IPRINT(&quot;expected keepidle (~p)&quot;,
<a name="25892"/>25892:                                                [ExpKeepIdle]),
<a name="25893"/>25893:                                    ok;
<a name="25894"/>25894:                                {ok, KeepIdle} -&gt;
<a name="25895"/>25895:                                    ?SEV_EPRINT(&quot;unexpected keepidle:&quot;
<a name="25896"/>25896:                                                &quot;~n   Expected KeepIdle: ~p&quot;
<a name="25897"/>25897:                                                &quot;~n   Actual KeepIdle:   ~p&quot;,
<a name="25898"/>25898:                                                [ExpKeepIdle, KeepIdle]),
<a name="25899"/>25899:                                    {error,
<a name="25900"/>25900:                                     {unexpected_keepidle,
<a name="25901"/>25901:                                      ExpKeepIdle, KeepIdle}};
<a name="25902"/>25902:                                {error, Reason} = ERROR -&gt;
<a name="25903"/>25903:                                    ?SEV_EPRINT(&quot;failed get keepidle: &quot;
<a name="25904"/>25904:                                                &quot;~n   ~p&quot;, [Reason]),
<a name="25905"/>25905:                                    ERROR
<a name="25906"/>25906:                            end
<a name="25907"/>25907:                    end},
<a name="25908"/>25908:          #{desc =&gt; &quot;announce ready (get keepidle(2))&quot;,
<a name="25909"/>25909:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="25910"/>25910:                            ?SEV_ANNOUNCE_READY(Tester, get_keepidle),
<a name="25911"/>25911:                            ok
<a name="25912"/>25912:                    end},
<a name="25913"/>25913: 
<a name="25914"/>25914: 
<a name="25915"/>25915:          %% *** Termination ***
<a name="25916"/>25916:          #{desc =&gt; &quot;await terminate&quot;,
<a name="25917"/>25917:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="25918"/>25918:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="25919"/>25919:                                ok -&gt;
<a name="25920"/>25920:                                    {ok, maps:remove(tester, State)};
<a name="25921"/>25921:                                {error, _} = ERROR -&gt;
<a name="25922"/>25922:                                    ERROR
<a name="25923"/>25923:                            end
<a name="25924"/>25924:                    end},
<a name="25925"/>25925:          #{desc =&gt; &quot;close connection socket&quot;,
<a name="25926"/>25926:            cmd  =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="25927"/>25927:                            ok = socket:close(Sock),
<a name="25928"/>25928:                            {ok, maps:remove(sock, State)}
<a name="25929"/>25929:                    end},
<a name="25930"/>25930: 
<a name="25931"/>25931:          %% *** We are done ***
<a name="25932"/>25932:          ?SEV_FINISH_NORMAL
<a name="25933"/>25933:         ],
<a name="25934"/>25934: 
<a name="25935"/>25935: 
<a name="25936"/>25936:     TesterSeq =
<a name="25937"/>25937:         [
<a name="25938"/>25938:          %% *** Init part ***
<a name="25939"/>25939:          #{desc =&gt; &quot;monitor server&quot;,
<a name="25940"/>25940:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="25941"/>25941:                            _MRef = erlang:monitor(process, Pid),
<a name="25942"/>25942:                            ok
<a name="25943"/>25943:                    end},
<a name="25944"/>25944: 
<a name="25945"/>25945:          %% Start the server
<a name="25946"/>25946:          #{desc =&gt; &quot;order server start&quot;,
<a name="25947"/>25947:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="25948"/>25948:                            ?SEV_ANNOUNCE_START(Pid),
<a name="25949"/>25949:                            ok
<a name="25950"/>25950:                    end},
<a name="25951"/>25951:          #{desc =&gt; &quot;await server ready (init)&quot;,
<a name="25952"/>25952:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="25953"/>25953:                            ok = ?SEV_AWAIT_READY(Pid, server, init),
<a name="25954"/>25954:                            ok
<a name="25955"/>25955:                    end},
<a name="25956"/>25956: 
<a name="25957"/>25957:          %% *** The actual test ***
<a name="25958"/>25958:          #{desc =&gt; &quot;order server to continue (with get-keepidle(1))&quot;,
<a name="25959"/>25959:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="25960"/>25960:                            ?SEV_ANNOUNCE_CONTINUE(Server, get_keepidle),
<a name="25961"/>25961:                            ok
<a name="25962"/>25962:                    end},
<a name="25963"/>25963:          #{desc =&gt; &quot;await server ready (get-keepidle(1))&quot;,
<a name="25964"/>25964:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="25965"/>25965:                            ?SEV_AWAIT_READY(Server, server, get_keepidle)
<a name="25966"/>25966:                    end},
<a name="25967"/>25967: 
<a name="25968"/>25968:          #{desc =&gt; &quot;order server to continue (with set-keepidle)&quot;,
<a name="25969"/>25969:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="25970"/>25970:                            ?SEV_ANNOUNCE_CONTINUE(Server, set_keepidle),
<a name="25971"/>25971:                            ok
<a name="25972"/>25972:                    end},
<a name="25973"/>25973:          #{desc =&gt; &quot;await server ready (set-keepidle)&quot;,
<a name="25974"/>25974:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="25975"/>25975:                            ?SEV_AWAIT_READY(Server, server, set_keepidle)
<a name="25976"/>25976:                    end},
<a name="25977"/>25977: 
<a name="25978"/>25978:          #{desc =&gt; &quot;order server to continue (with get-keepidle(2))&quot;,
<a name="25979"/>25979:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="25980"/>25980:                            ?SEV_ANNOUNCE_CONTINUE(Server, get_keepidle),
<a name="25981"/>25981:                            ok
<a name="25982"/>25982:                    end},
<a name="25983"/>25983:          #{desc =&gt; &quot;await server ready (get-keepidle(2))&quot;,
<a name="25984"/>25984:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="25985"/>25985:                            ?SEV_AWAIT_READY(Server, server, get_keepidle)
<a name="25986"/>25986:                    end},
<a name="25987"/>25987: 
<a name="25988"/>25988: 
<a name="25989"/>25989:          %% *** Termination ***
<a name="25990"/>25990:          #{desc =&gt; &quot;order server to terminate&quot;,
<a name="25991"/>25991:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="25992"/>25992:                            ?SEV_ANNOUNCE_TERMINATE(Server),
<a name="25993"/>25993:                            ok
<a name="25994"/>25994:                    end},
<a name="25995"/>25995:          #{desc =&gt; &quot;await server termination&quot;,
<a name="25996"/>25996:            cmd  =&gt; fun(#{server := Server} = State) -&gt;
<a name="25997"/>25997:                            ?SEV_AWAIT_TERMINATION(Server),
<a name="25998"/>25998:                            State1 = maps:remove(server, State),
<a name="25999"/>25999:                            {ok, State1}
<a name="26000"/>26000:                    end},
<a name="26001"/>26001: 
<a name="26002"/>26002:          %% *** We are done ***
<a name="26003"/>26003:          ?SEV_FINISH_NORMAL
<a name="26004"/>26004:         ],
<a name="26005"/>26005: 
<a name="26006"/>26006: 
<a name="26007"/>26007:     i(&quot;start server evaluator&quot;),
<a name="26008"/>26008:     Server = ?SEV_START(&quot;server&quot;, ServerSeq, InitState),
<a name="26009"/>26009: 
<a name="26010"/>26010:     i(&quot;start tester evaluator&quot;),
<a name="26011"/>26011:     TesterInitState = #{server =&gt; Server#ev.pid},
<a name="26012"/>26012:     Tester = ?SEV_START(&quot;tester&quot;, TesterSeq, TesterInitState),
<a name="26013"/>26013: 
<a name="api_opt_tcp_keepidle_tcp-last_expr"/><a name="26014"/>26014: <b>    ok = ?SEV_AWAIT_FINISH</b>([Server, Tester]).
<a name="26015"/>26015: 
<a name="26016"/>26016: 
<a name="26017"/>26017: 
<a name="26018"/>26018: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="26019"/>26019: 
<a name="26020"/>26020: <i>%% Tests that the keepintvl tcp socket option.</i>
<a name="26021"/>26021: <i>%%</i>
<a name="26022"/>26022: <i>%% &quot;Gets or sets the number of seconds a TCP connection will wait for</i>
<a name="26023"/>26023: <i>%%  a keepalive response before sending another keepalive probe.&quot;</i>
<a name="26024"/>26024: <i>%%</i>
<a name="26025"/>26025: 
<a name="api_opt_tcp_keepintvl_tcp4-1"/><a name="26026"/>26026: <b>api_opt_tcp_keepintvl_tcp4</b>(_Config) when is_list(_Config) -&gt;
<a name="26027"/>26027:     ?TT(?SECS(5)),
<a name="api_opt_tcp_keepintvl_tcp4-last_expr"/><a name="26028"/>26028: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="26029"/>26029:            fun() -&gt; has_support_ipv4(), has_support_tcp_keepintvl() end,
<a name="26030"/>26030:            fun() -&gt;
<a name="26031"/>26031:                    Set  = fun(Sock, Value) when is_integer(Value) -&gt;
<a name="26032"/>26032:                                   socket:setopt(Sock, tcp, keepintvl, Value)
<a name="26033"/>26033:                           end,
<a name="26034"/>26034:                    Get  = fun(Sock) -&gt;
<a name="26035"/>26035:                                   socket:getopt(Sock, tcp, keepintvl)
<a name="26036"/>26036:                           end,
<a name="26037"/>26037:                    InitState = #{domain =&gt; inet,
<a name="26038"/>26038:                                  proto  =&gt; tcp,
<a name="26039"/>26039:                                  set    =&gt; Set,
<a name="26040"/>26040:                                  get    =&gt; Get},
<a name="26041"/>26041:                    ok = api_opt_tcp_keepintvl_tcp(InitState)
<a name="26042"/>26042:            end).
<a name="26043"/>26043: 
<a name="26044"/>26044: 
<a name="26045"/>26045: 
<a name="26046"/>26046: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="26047"/>26047: 
<a name="api_opt_tcp_keepintvl_tcp-1"/><a name="26048"/>26048: <b>api_opt_tcp_keepintvl_tcp</b>(InitState) -&gt;
<a name="26049"/>26049:     process_flag(trap_exit, true),
<a name="26050"/>26050:     ServerSeq =
<a name="26051"/>26051:         [
<a name="26052"/>26052:          %% *** Wait for start order ***
<a name="26053"/>26053:          #{desc =&gt; &quot;await start (from tester)&quot;,
<a name="26054"/>26054:            cmd  =&gt; fun(State) -&gt;
<a name="26055"/>26055:                            Tester = ?SEV_AWAIT_START(),
<a name="26056"/>26056:                            {ok, State#{tester =&gt; Tester}}
<a name="26057"/>26057:                    end},
<a name="26058"/>26058:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="26059"/>26059:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="26060"/>26060:                            _MRef = erlang:monitor(process, Tester),
<a name="26061"/>26061:                            ok
<a name="26062"/>26062:                    end},
<a name="26063"/>26063: 
<a name="26064"/>26064:          %% *** Init part ***
<a name="26065"/>26065:          #{desc =&gt; &quot;which local address&quot;,
<a name="26066"/>26066:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="26067"/>26067:                            LSA = which_local_socket_addr(Domain),
<a name="26068"/>26068:                            {ok, State#{lsa =&gt; LSA}}
<a name="26069"/>26069:                    end},
<a name="26070"/>26070:          #{desc =&gt; &quot;create socket&quot;,
<a name="26071"/>26071:            cmd  =&gt; fun(#{domain := Domain,
<a name="26072"/>26072:                          proto  := Proto} = State) -&gt;
<a name="26073"/>26073:                            case socket:open(Domain, stream, Proto) of
<a name="26074"/>26074:                                {ok, Sock} -&gt;
<a name="26075"/>26075:                                    {ok, State#{sock =&gt; Sock}};
<a name="26076"/>26076:                                {error, _} = ERROR -&gt;
<a name="26077"/>26077:                                    ERROR
<a name="26078"/>26078:                            end
<a name="26079"/>26079:                    end},
<a name="26080"/>26080:          #{desc =&gt; &quot;bind to local address&quot;,
<a name="26081"/>26081:            cmd  =&gt; fun(#{sock := LSock, lsa := LSA} = _State) -&gt;
<a name="26082"/>26082:                            case sock_bind(LSock, LSA) of
<a name="26083"/>26083:                                ok -&gt;
<a name="26084"/>26084:                                    Port = sock_port(LSock),
<a name="26085"/>26085:                                    ?SEV_IPRINT(&quot;bound to port: ~w&quot;, [Port]),
<a name="26086"/>26086:                                    ok;
<a name="26087"/>26087:                                {error, _} = ERROR -&gt;
<a name="26088"/>26088:                                    ERROR
<a name="26089"/>26089:                            end
<a name="26090"/>26090:                    end},
<a name="26091"/>26091:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="26092"/>26092:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="26093"/>26093:                            ?SEV_ANNOUNCE_READY(Tester, init),
<a name="26094"/>26094:                            ok
<a name="26095"/>26095:                    end},
<a name="26096"/>26096: 
<a name="26097"/>26097: 
<a name="26098"/>26098:          %% The actual test
<a name="26099"/>26099:          #{desc =&gt; &quot;await continue (get keepintvl(1))&quot;,
<a name="26100"/>26100:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="26101"/>26101:                            ?SEV_AWAIT_CONTINUE(Tester, tester, get_keepintvl)
<a name="26102"/>26102:                    end},
<a name="26103"/>26103:          #{desc =&gt; &quot;get keepintvl&quot;,
<a name="26104"/>26104:            cmd  =&gt; fun(#{sock := Sock, get := Get} = State) -&gt;
<a name="26105"/>26105:                            case Get(Sock) of
<a name="26106"/>26106:                                {ok, KeepIntVl} -&gt;
<a name="26107"/>26107:                                    ?SEV_IPRINT(&quot;keepintvl: ~p&quot;, [KeepIntVl]),
<a name="26108"/>26108:                                    {ok, State#{keepintvl =&gt; KeepIntVl}};
<a name="26109"/>26109:                                {error, _} = ERROR -&gt;
<a name="26110"/>26110:                                    ERROR
<a name="26111"/>26111:                            end
<a name="26112"/>26112:                    end},
<a name="26113"/>26113:          #{desc =&gt; &quot;announce ready (get keepintvl(1))&quot;,
<a name="26114"/>26114:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="26115"/>26115:                            ?SEV_ANNOUNCE_READY(Tester, get_keepintvl),
<a name="26116"/>26116:                            ok
<a name="26117"/>26117:                    end},
<a name="26118"/>26118: 
<a name="26119"/>26119: 
<a name="26120"/>26120:          #{desc =&gt; &quot;await continue (set keepintvl)&quot;,
<a name="26121"/>26121:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="26122"/>26122:                            ?SEV_AWAIT_CONTINUE(Tester, tester, set_keepintvl)
<a name="26123"/>26123:                    end},
<a name="26124"/>26124:          #{desc =&gt; &quot;set keepintvl&quot;,
<a name="26125"/>26125:            cmd  =&gt; fun(#{sock     := Sock,
<a name="26126"/>26126:                          set      := Set,
<a name="26127"/>26127:                          keepintvl := KeepIntVl} = State) -&gt;
<a name="26128"/>26128:                            NewKeepIntVl = KeepIntVl + 1,
<a name="26129"/>26129:                            case Set(Sock, NewKeepIntVl) of
<a name="26130"/>26130:                                ok -&gt;
<a name="26131"/>26131:                                    ?SEV_IPRINT(&quot;keepIntVl updated (to ~p)&quot;,
<a name="26132"/>26132:                                                [NewKeepIntVl]),
<a name="26133"/>26133:                                    {ok, State#{keepintvl =&gt; NewKeepIntVl}};
<a name="26134"/>26134:                                {error, _} = ERROR -&gt;
<a name="26135"/>26135:                                    ERROR
<a name="26136"/>26136:                            end
<a name="26137"/>26137:                    end},
<a name="26138"/>26138:          #{desc =&gt; &quot;announce ready (set keepintvl)&quot;,
<a name="26139"/>26139:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="26140"/>26140:                            ?SEV_ANNOUNCE_READY(Tester, set_keepintvl),
<a name="26141"/>26141:                            ok
<a name="26142"/>26142:                    end},
<a name="26143"/>26143: 
<a name="26144"/>26144: 
<a name="26145"/>26145:          #{desc =&gt; &quot;await continue (get keepintvl(2))&quot;,
<a name="26146"/>26146:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="26147"/>26147:                            ?SEV_AWAIT_CONTINUE(Tester, tester, get_keepintvl)
<a name="26148"/>26148:                    end},
<a name="26149"/>26149:          #{desc =&gt; &quot;get keepintvl(2)&quot;,
<a name="26150"/>26150:            cmd  =&gt; fun(#{sock      := Sock,
<a name="26151"/>26151:                          get       := Get,
<a name="26152"/>26152:                          keepintvl := ExpKeepIntVl} = _State) -&gt;
<a name="26153"/>26153:                            case Get(Sock) of
<a name="26154"/>26154:                                {ok, KeepIntVl}
<a name="26155"/>26155:                                  when (ExpKeepIntVl =:= KeepIntVl) -&gt;
<a name="26156"/>26156:                                    ?SEV_IPRINT(&quot;expected keepintvl (~p)&quot;,
<a name="26157"/>26157:                                                [ExpKeepIntVl]),
<a name="26158"/>26158:                                    ok;
<a name="26159"/>26159:                                {ok, KeepIntVl} -&gt;
<a name="26160"/>26160:                                    ?SEV_EPRINT(&quot;unexpected keepintvl:&quot;
<a name="26161"/>26161:                                                &quot;~n   Expected KeepIntVl: ~p&quot;
<a name="26162"/>26162:                                                &quot;~n   Actual KeepIntVl:   ~p&quot;,
<a name="26163"/>26163:                                                [ExpKeepIntVl, KeepIntVl]),
<a name="26164"/>26164:                                    {error,
<a name="26165"/>26165:                                     {unexpected_keepintvl,
<a name="26166"/>26166:                                      ExpKeepIntVl, KeepIntVl}};
<a name="26167"/>26167:                                {error, Reason} = ERROR -&gt;
<a name="26168"/>26168:                                    ?SEV_EPRINT(&quot;failed get keepintvl: &quot;
<a name="26169"/>26169:                                                &quot;~n   ~p&quot;, [Reason]),
<a name="26170"/>26170:                                    ERROR
<a name="26171"/>26171:                            end
<a name="26172"/>26172:                    end},
<a name="26173"/>26173:          #{desc =&gt; &quot;announce ready (get keepintvl(2))&quot;,
<a name="26174"/>26174:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="26175"/>26175:                            ?SEV_ANNOUNCE_READY(Tester, get_keepintvl),
<a name="26176"/>26176:                            ok
<a name="26177"/>26177:                    end},
<a name="26178"/>26178: 
<a name="26179"/>26179: 
<a name="26180"/>26180:          %% *** Termination ***
<a name="26181"/>26181:          #{desc =&gt; &quot;await terminate&quot;,
<a name="26182"/>26182:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="26183"/>26183:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="26184"/>26184:                                ok -&gt;
<a name="26185"/>26185:                                    {ok, maps:remove(tester, State)};
<a name="26186"/>26186:                                {error, _} = ERROR -&gt;
<a name="26187"/>26187:                                    ERROR
<a name="26188"/>26188:                            end
<a name="26189"/>26189:                    end},
<a name="26190"/>26190:          #{desc =&gt; &quot;close connection socket&quot;,
<a name="26191"/>26191:            cmd  =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="26192"/>26192:                            ok = socket:close(Sock),
<a name="26193"/>26193:                            {ok, maps:remove(sock, State)}
<a name="26194"/>26194:                    end},
<a name="26195"/>26195: 
<a name="26196"/>26196:          %% *** We are done ***
<a name="26197"/>26197:          ?SEV_FINISH_NORMAL
<a name="26198"/>26198:         ],
<a name="26199"/>26199: 
<a name="26200"/>26200: 
<a name="26201"/>26201:     TesterSeq =
<a name="26202"/>26202:         [
<a name="26203"/>26203:          %% *** Init part ***
<a name="26204"/>26204:          #{desc =&gt; &quot;monitor server&quot;,
<a name="26205"/>26205:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="26206"/>26206:                            _MRef = erlang:monitor(process, Pid),
<a name="26207"/>26207:                            ok
<a name="26208"/>26208:                    end},
<a name="26209"/>26209: 
<a name="26210"/>26210:          %% Start the server
<a name="26211"/>26211:          #{desc =&gt; &quot;order server start&quot;,
<a name="26212"/>26212:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="26213"/>26213:                            ?SEV_ANNOUNCE_START(Pid),
<a name="26214"/>26214:                            ok
<a name="26215"/>26215:                    end},
<a name="26216"/>26216:          #{desc =&gt; &quot;await server ready (init)&quot;,
<a name="26217"/>26217:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="26218"/>26218:                            ok = ?SEV_AWAIT_READY(Pid, server, init),
<a name="26219"/>26219:                            ok
<a name="26220"/>26220:                    end},
<a name="26221"/>26221: 
<a name="26222"/>26222:          %% *** The actual test ***
<a name="26223"/>26223:          #{desc =&gt; &quot;order server to continue (with get-keepintvl(1))&quot;,
<a name="26224"/>26224:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="26225"/>26225:                            ?SEV_ANNOUNCE_CONTINUE(Server, get_keepintvl),
<a name="26226"/>26226:                            ok
<a name="26227"/>26227:                    end},
<a name="26228"/>26228:          #{desc =&gt; &quot;await server ready (get-keepintvl(1))&quot;,
<a name="26229"/>26229:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="26230"/>26230:                            ?SEV_AWAIT_READY(Server, server, get_keepintvl)
<a name="26231"/>26231:                    end},
<a name="26232"/>26232: 
<a name="26233"/>26233:          #{desc =&gt; &quot;order server to continue (with set-keepintvl)&quot;,
<a name="26234"/>26234:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="26235"/>26235:                            ?SEV_ANNOUNCE_CONTINUE(Server, set_keepintvl),
<a name="26236"/>26236:                            ok
<a name="26237"/>26237:                    end},
<a name="26238"/>26238:          #{desc =&gt; &quot;await server ready (set-keepintvl)&quot;,
<a name="26239"/>26239:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="26240"/>26240:                            ?SEV_AWAIT_READY(Server, server, set_keepintvl)
<a name="26241"/>26241:                    end},
<a name="26242"/>26242: 
<a name="26243"/>26243:          #{desc =&gt; &quot;order server to continue (with get-keepintvl(2))&quot;,
<a name="26244"/>26244:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="26245"/>26245:                            ?SEV_ANNOUNCE_CONTINUE(Server, get_keepintvl),
<a name="26246"/>26246:                            ok
<a name="26247"/>26247:                    end},
<a name="26248"/>26248:          #{desc =&gt; &quot;await server ready (get-keepintvl(2))&quot;,
<a name="26249"/>26249:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="26250"/>26250:                            ?SEV_AWAIT_READY(Server, server, get_keepintvl)
<a name="26251"/>26251:                    end},
<a name="26252"/>26252: 
<a name="26253"/>26253: 
<a name="26254"/>26254:          %% *** Termination ***
<a name="26255"/>26255:          #{desc =&gt; &quot;order server to terminate&quot;,
<a name="26256"/>26256:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="26257"/>26257:                            ?SEV_ANNOUNCE_TERMINATE(Server),
<a name="26258"/>26258:                            ok
<a name="26259"/>26259:                    end},
<a name="26260"/>26260:          #{desc =&gt; &quot;await server termination&quot;,
<a name="26261"/>26261:            cmd  =&gt; fun(#{server := Server} = State) -&gt;
<a name="26262"/>26262:                            ?SEV_AWAIT_TERMINATION(Server),
<a name="26263"/>26263:                            State1 = maps:remove(server, State),
<a name="26264"/>26264:                            {ok, State1}
<a name="26265"/>26265:                    end},
<a name="26266"/>26266: 
<a name="26267"/>26267:          %% *** We are done ***
<a name="26268"/>26268:          ?SEV_FINISH_NORMAL
<a name="26269"/>26269:         ],
<a name="26270"/>26270: 
<a name="26271"/>26271: 
<a name="26272"/>26272:     i(&quot;start server evaluator&quot;),
<a name="26273"/>26273:     Server = ?SEV_START(&quot;server&quot;, ServerSeq, InitState),
<a name="26274"/>26274: 
<a name="26275"/>26275:     i(&quot;start tester evaluator&quot;),
<a name="26276"/>26276:     TesterInitState = #{server =&gt; Server#ev.pid},
<a name="26277"/>26277:     Tester = ?SEV_START(&quot;tester&quot;, TesterSeq, TesterInitState),
<a name="26278"/>26278: 
<a name="api_opt_tcp_keepintvl_tcp-last_expr"/><a name="26279"/>26279: <b>    ok = ?SEV_AWAIT_FINISH</b>([Server, Tester]).
<a name="26280"/>26280: 
<a name="26281"/>26281: 
<a name="26282"/>26282: 
<a name="26283"/>26283: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="26284"/>26284: 
<a name="26285"/>26285: <i>%% Tests that the cork udp socket option.</i>
<a name="26286"/>26286: <i>%%</i>
<a name="26287"/>26287: <i>%% This is a very simple test. We simple set and get the value.</i>
<a name="26288"/>26288: <i>%% To test that it has an effect is just &quot;to much work&quot;...</i>
<a name="26289"/>26289: <i>%%</i>
<a name="26290"/>26290: 
<a name="api_opt_udp_cork_udp4-1"/><a name="26291"/>26291: <b>api_opt_udp_cork_udp4</b>(_Config) when is_list(_Config) -&gt;
<a name="26292"/>26292:     ?TT(?SECS(5)),
<a name="api_opt_udp_cork_udp4-last_expr"/><a name="26293"/>26293: <b>    tc_try</b>(api_opt_udp_cork_udp4,
<a name="26294"/>26294:            fun() -&gt; has_support_ipv4(), has_support_udp_cork() end,
<a name="26295"/>26295:            fun() -&gt;
<a name="26296"/>26296:                    Set  = fun(Sock, Value) when is_boolean(Value) -&gt;
<a name="26297"/>26297:                                   socket:setopt(Sock, udp, cork, Value)
<a name="26298"/>26298:                           end,
<a name="26299"/>26299:                    Get  = fun(Sock) -&gt;
<a name="26300"/>26300:                                   socket:getopt(Sock, udp, cork)
<a name="26301"/>26301:                           end,
<a name="26302"/>26302:                    InitState = #{domain =&gt; inet,
<a name="26303"/>26303:                                  proto  =&gt; udp,
<a name="26304"/>26304:                                  set    =&gt; Set,
<a name="26305"/>26305:                                  get    =&gt; Get},
<a name="26306"/>26306:                    ok = api_opt_udp_cork_udp(InitState)
<a name="26307"/>26307:            end).
<a name="26308"/>26308: 
<a name="26309"/>26309: 
<a name="26310"/>26310: 
<a name="26311"/>26311: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="26312"/>26312: 
<a name="api_opt_udp_cork_udp-1"/><a name="26313"/>26313: <b>api_opt_udp_cork_udp</b>(InitState) -&gt;
<a name="26314"/>26314:     process_flag(trap_exit, true),
<a name="26315"/>26315:     TesterSeq =
<a name="26316"/>26316:         [
<a name="26317"/>26317:          %% *** Init part ***
<a name="26318"/>26318:          #{desc =&gt; &quot;which local address&quot;,
<a name="26319"/>26319:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="26320"/>26320:                            LSA = which_local_socket_addr(Domain),
<a name="26321"/>26321:                            {ok, State#{lsa =&gt; LSA}}
<a name="26322"/>26322:                    end},
<a name="26323"/>26323:          #{desc =&gt; &quot;create socket&quot;,
<a name="26324"/>26324:            cmd  =&gt; fun(#{domain := Domain,
<a name="26325"/>26325:                          proto  := Proto} = State) -&gt;
<a name="26326"/>26326:                            case socket:open(Domain, dgram, Proto) of
<a name="26327"/>26327:                                {ok, Sock} -&gt;
<a name="26328"/>26328:                                    {ok, State#{sock =&gt; Sock}};
<a name="26329"/>26329:                                {error, _} = ERROR -&gt;
<a name="26330"/>26330:                                    ERROR
<a name="26331"/>26331:                            end
<a name="26332"/>26332:                    end},
<a name="26333"/>26333:          #{desc =&gt; &quot;bind to local address&quot;,
<a name="26334"/>26334:            cmd  =&gt; fun(#{sock := Sock, lsa := LSA} = _State) -&gt;
<a name="26335"/>26335:                            case sock_bind(Sock, LSA) of
<a name="26336"/>26336:                                ok -&gt;
<a name="26337"/>26337:                                    Port = sock_port(Sock),
<a name="26338"/>26338:                                    ?SEV_IPRINT(&quot;bound to port: ~w&quot;, [Port]),
<a name="26339"/>26339:                                    ok;
<a name="26340"/>26340:                                {error, _} = ERROR -&gt;
<a name="26341"/>26341:                                    ERROR
<a name="26342"/>26342:                            end
<a name="26343"/>26343:                    end},
<a name="26344"/>26344: 
<a name="26345"/>26345: 
<a name="26346"/>26346:          %% The actual test
<a name="26347"/>26347:          #{desc =&gt; &quot;get (default) cork (= false)&quot;,
<a name="26348"/>26348:            cmd  =&gt; fun(#{sock := Sock, get := Get} = _State) -&gt;
<a name="26349"/>26349:                            case Get(Sock) of
<a name="26350"/>26350:                                {ok, false = Value} -&gt;
<a name="26351"/>26351:                                    ?SEV_IPRINT(&quot;cork default: ~p&quot;, [Value]),
<a name="26352"/>26352:                                    ok;
<a name="26353"/>26353:                                {error, _} = ERROR -&gt;
<a name="26354"/>26354:                                    ERROR
<a name="26355"/>26355:                            end
<a name="26356"/>26356:                    end},
<a name="26357"/>26357:          #{desc =&gt; &quot;enable cork (=&gt; true)&quot;,
<a name="26358"/>26358:            cmd  =&gt; fun(#{sock := Sock, set := Set} = _State) -&gt;
<a name="26359"/>26359:                            case Set(Sock, true) of
<a name="26360"/>26360:                                ok -&gt;
<a name="26361"/>26361:                                    ?SEV_IPRINT(&quot;cork enabled&quot;),
<a name="26362"/>26362:                                    ok;
<a name="26363"/>26363:                                {error, _} = ERROR -&gt;
<a name="26364"/>26364:                                    ERROR
<a name="26365"/>26365:                            end
<a name="26366"/>26366:                    end},
<a name="26367"/>26367:          #{desc =&gt; &quot;get cork (= true)&quot;,
<a name="26368"/>26368:            cmd  =&gt; fun(#{sock := Sock, get := Get} = _State) -&gt;
<a name="26369"/>26369:                            case Get(Sock) of
<a name="26370"/>26370:                                {ok, true = Value} -&gt;
<a name="26371"/>26371:                                    ?SEV_IPRINT(&quot;cork: ~p&quot;, [Value]),
<a name="26372"/>26372:                                    ok;
<a name="26373"/>26373:                                {error, _} = ERROR -&gt;
<a name="26374"/>26374:                                    ERROR
<a name="26375"/>26375:                            end
<a name="26376"/>26376:                    end},
<a name="26377"/>26377: 
<a name="26378"/>26378: 
<a name="26379"/>26379:          %% *** Termination ***
<a name="26380"/>26380:          #{desc =&gt; &quot;close socket&quot;,
<a name="26381"/>26381:            cmd  =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="26382"/>26382:                            ok = socket:close(Sock),
<a name="26383"/>26383:                            {ok, maps:remove(sock, State)}
<a name="26384"/>26384:                    end},
<a name="26385"/>26385: 
<a name="26386"/>26386:          %% *** We are done ***
<a name="26387"/>26387:          ?SEV_FINISH_NORMAL
<a name="26388"/>26388:         ],
<a name="26389"/>26389: 
<a name="26390"/>26390:     i(&quot;start tester evaluator&quot;),
<a name="26391"/>26391:     Tester = ?SEV_START(&quot;tester&quot;, TesterSeq, InitState),
<a name="26392"/>26392: 
<a name="api_opt_udp_cork_udp-last_expr"/><a name="26393"/>26393: <b>    ok = ?SEV_AWAIT_FINISH</b>([Tester]).
<a name="26394"/>26394: 
<a name="26395"/>26395: 
<a name="26396"/>26396: 
<a name="26397"/>26397: 
<a name="26398"/>26398: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="26399"/>26399: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="26400"/>26400: <i>%%                                                                     %%</i>
<a name="26401"/>26401: <i>%%                  API OPERATIONS WITH TIMEOUT                        %%</i>
<a name="26402"/>26402: <i>%%                                                                     %%</i>
<a name="26403"/>26403: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="26404"/>26404: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="26405"/>26405: 
<a name="26406"/>26406: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="26407"/>26407: 
<a name="26408"/>26408: <i>%% This test case is intended to test the connect timeout option</i>
<a name="26409"/>26409: <i>%% on an IPv4 TCP (stream) socket.</i>
<a name="api_to_connect_tcp4-1"/><a name="26410"/>26410: <b>api_to_connect_tcp4</b>(_Config) when is_list(_Config) -&gt;
<a name="26411"/>26411:     ?TT(?SECS(10)),
<a name="26412"/>26412:     Cond = fun() -&gt; has_support_ipv4(), api_to_connect_cond() end,
<a name="api_to_connect_tcp4-last_expr"/><a name="26413"/>26413: <b>    tc_try</b>(api_to_connect_tcp4,
<a name="26414"/>26414:            Cond,
<a name="26415"/>26415:            fun() -&gt;
<a name="26416"/>26416:                    InitState = #{domain        =&gt; inet,
<a name="26417"/>26417:                                  backlog       =&gt; 1,
<a name="26418"/>26418:                                  timeout       =&gt; 5000,
<a name="26419"/>26419:                                  connect_limit =&gt; 3},
<a name="26420"/>26420:                    ok = api_to_connect_tcp(InitState)
<a name="26421"/>26421:            end).
<a name="26422"/>26422: 
<a name="api_to_connect_cond-0"/><a name="26423"/>26423: <b>api_to_connect_cond</b>() -&gt;
<a name="api_to_connect_cond-last_expr"/><a name="26424"/>26424: <b>    api_to_connect_cond</b>(os:type(), os:version()).
<a name="26425"/>26425: 
<a name="26426"/>26426: <i>%% I don't know exactly at which version this starts to work.</i>
<a name="26427"/>26427: <i>%% I know it does not work for 4.4.*, but is does for 4.15.</i>
<a name="26428"/>26428: <i>%% So, just to simplify, we require at least 4.15</i>
<a name="api_to_connect_cond-2"/><a name="26429"/>26429: <b>api_to_connect_cond</b>({unix, linux}, {Maj, Min, _Rev}) -&gt;
<a name="26430"/>26430:     if
<a name="26431"/>26431:         (Maj &gt; 4) -&gt;
<a name="26432"/>26432:             ok;
<a name="26433"/>26433:         ((Maj =:= 4) andalso (Min &gt;= 15)) -&gt;
<a name="26434"/>26434:             ok;
<a name="26435"/>26435:         true -&gt;
<a name="26436"/>26436:             skip(&quot;TC does not work&quot;)
<a name="26437"/>26437:     end;
<a name="26438"/>26438: <i>%% Only test on one machine, which has version 6.3, and there it does</i>
<a name="26439"/>26439: <i>%% not work, so disable for all.</i>
<a name="26440"/>26440: <b>api_to_connect_cond</b>({unix, openbsd}, _) -&gt;
<a name="26441"/>26441:     skip(&quot;TC does not work&quot;);
<a name="26442"/>26442: <b>api_to_connect_cond</b>({unix, freebsd}, {Maj, Min, _Rev}) -&gt;
<a name="26443"/>26443:     if
<a name="26444"/>26444:         ((Maj &gt;= 10) andalso (Min &gt;= 4)) -&gt;
<a name="26445"/>26445:             ok;
<a name="26446"/>26446:         true -&gt;
<a name="26447"/>26447:             skip(&quot;TC may not work&quot;)
<a name="26448"/>26448:     end;
<a name="26449"/>26449: <b>api_to_connect_cond</b>({unix, sunos}, {Maj, Min, _Rev}) -&gt;
<a name="26450"/>26450:     if
<a name="26451"/>26451:         ((Maj &gt;= 5) andalso (Min &gt;= 10)) -&gt;
<a name="26452"/>26452:             ok;
<a name="26453"/>26453:         true -&gt;
<a name="26454"/>26454:             skip(&quot;TC may not work&quot;)
<a name="26455"/>26455:     end;
<a name="26456"/>26456: <b>api_to_connect_cond</b>(_, _) -&gt;
<a name="api_to_connect_cond-last_expr"/><a name="26457"/>26457: <b>    skip</b>(&quot;TC may not work&quot;).
<a name="26458"/>26458: 
<a name="26459"/>26459: 
<a name="26460"/>26460: 
<a name="26461"/>26461: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="26462"/>26462: 
<a name="26463"/>26463: <i>%% This test case is intended to test the connect timeout option</i>
<a name="26464"/>26464: <i>%% on an IPv6 TCP (stream) socket.</i>
<a name="api_to_connect_tcp6-1"/><a name="26465"/>26465: <b>api_to_connect_tcp6</b>(_Config) when is_list(_Config) -&gt;
<a name="26466"/>26466:     ?TT(?SECS(10)),
<a name="api_to_connect_tcp6-last_expr"/><a name="26467"/>26467: <b>    tc_try</b>(api_to_connect_tcp6,
<a name="26468"/>26468:            fun() -&gt; has_support_ipv6(), api_to_connect_cond() end,
<a name="26469"/>26469:            fun() -&gt;
<a name="26470"/>26470:                    InitState = #{domain        =&gt; inet6,
<a name="26471"/>26471:                                  backlog       =&gt; 1,
<a name="26472"/>26472:                                  timeout       =&gt; 5000,
<a name="26473"/>26473:                                  connect_limit =&gt; 3},
<a name="26474"/>26474:                    ok = api_to_connect_tcp(InitState)
<a name="26475"/>26475:            end).
<a name="26476"/>26476: 
<a name="26477"/>26477: 
<a name="26478"/>26478: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="26479"/>26479: <i>%% We use the backlog (listen) argument to test this.</i>
<a name="26480"/>26480: <i>%% Note that the behaviour of the TCP &quot;server side&quot; can vary when </i>
<a name="26481"/>26481: <i>%% a client connect to a &quot;busy&quot; server (full backlog).</i>
<a name="26482"/>26482: <i>%% For instance, on FreeBSD (11.2) the response when the backlog is full</i>
<a name="26483"/>26483: <i>%% is a econreset.</i>
<a name="26484"/>26484: 
<a name="api_to_connect_tcp-1"/><a name="26485"/>26485: <b>api_to_connect_tcp</b>(InitState) -&gt;
<a name="26486"/>26486:     process_flag(trap_exit, true),
<a name="26487"/>26487: 
<a name="26488"/>26488:     ServerSeq = 
<a name="26489"/>26489:         [
<a name="26490"/>26490:          %% *** Wait for start order part ***
<a name="26491"/>26491:          #{desc =&gt; &quot;await start (from tester)&quot;,
<a name="26492"/>26492:            cmd  =&gt; fun(State) -&gt;
<a name="26493"/>26493:                            {Tester, Backlog} = ?SEV_AWAIT_START(),
<a name="26494"/>26494:                            {ok, State#{tester  =&gt; Tester,
<a name="26495"/>26495:                                        backlog =&gt; Backlog}}
<a name="26496"/>26496:                    end},
<a name="26497"/>26497:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="26498"/>26498:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="26499"/>26499:                            _MRef = erlang:monitor(process, Tester),
<a name="26500"/>26500:                            ok
<a name="26501"/>26501:                    end},
<a name="26502"/>26502: 
<a name="26503"/>26503:          %% *** Init part ***
<a name="26504"/>26504:          #{desc =&gt; &quot;which local address&quot;,
<a name="26505"/>26505:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="26506"/>26506:                            LSA = which_local_socket_addr(Domain),
<a name="26507"/>26507:                            {ok, State#{local_sa =&gt; LSA}}
<a name="26508"/>26508:                    end},
<a name="26509"/>26509:          #{desc =&gt; &quot;create listen socket&quot;,
<a name="26510"/>26510:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="26511"/>26511:                            case socket:open(Domain, stream, tcp) of
<a name="26512"/>26512:                                {ok, Sock} -&gt;
<a name="26513"/>26513:                                    {ok, State#{lsock =&gt; Sock}};
<a name="26514"/>26514:                                {error, _} = ERROR -&gt;
<a name="26515"/>26515:                                    ERROR
<a name="26516"/>26516:                            end
<a name="26517"/>26517:                    end},
<a name="26518"/>26518:          #{desc =&gt; &quot;bind to local address&quot;,
<a name="26519"/>26519:            cmd  =&gt; fun(#{lsock := LSock, local_sa := LSA} = State) -&gt;
<a name="26520"/>26520:                            case sock_bind(LSock, LSA) of
<a name="26521"/>26521:                                ok -&gt;
<a name="26522"/>26522:                                    Port = sock_port(LSock),
<a name="26523"/>26523:                                    {ok, State#{lport =&gt; Port}};
<a name="26524"/>26524:                                {error, _} = ERROR -&gt;
<a name="26525"/>26525:                                    ERROR
<a name="26526"/>26526:                            end
<a name="26527"/>26527:                    end},
<a name="26528"/>26528:          #{desc =&gt; &quot;make listen socket (with backlog = 1)&quot;,
<a name="26529"/>26529:            cmd  =&gt; fun(#{lsock := LSock, backlog := Backlog}) -&gt;
<a name="26530"/>26530:                            socket:listen(LSock, Backlog)
<a name="26531"/>26531:                    end},
<a name="26532"/>26532:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="26533"/>26533:            cmd  =&gt; fun(#{tester := Tester, lport := Port}) -&gt;
<a name="26534"/>26534:                            ?SEV_ANNOUNCE_READY(Tester, init, Port),
<a name="26535"/>26535:                            ok
<a name="26536"/>26536:                    end},
<a name="26537"/>26537: 
<a name="26538"/>26538:          %% Termination
<a name="26539"/>26539:          #{desc =&gt; &quot;await terminate&quot;,
<a name="26540"/>26540:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="26541"/>26541:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="26542"/>26542:                                ok -&gt;
<a name="26543"/>26543:                                    {ok, maps:remove(tester, State)};
<a name="26544"/>26544:                                {error, _} = ERROR -&gt;
<a name="26545"/>26545:                                    ERROR
<a name="26546"/>26546:                            end
<a name="26547"/>26547:                    end},
<a name="26548"/>26548:          #{desc =&gt; &quot;close socket&quot;,
<a name="26549"/>26549:            cmd  =&gt; fun(#{lsock := Sock} = State) -&gt;
<a name="26550"/>26550:                            sock_close(Sock),
<a name="26551"/>26551:                            State1 = maps:remove(lport, State),
<a name="26552"/>26552:                            State2 = maps:remove(sock,  State1),
<a name="26553"/>26553:                            {ok, State2}
<a name="26554"/>26554:                    end},
<a name="26555"/>26555: 
<a name="26556"/>26556:          %% *** We are done ***
<a name="26557"/>26557:          ?SEV_FINISH_NORMAL
<a name="26558"/>26558:         ],
<a name="26559"/>26559: 
<a name="26560"/>26560:     ClientSeq =
<a name="26561"/>26561:         [
<a name="26562"/>26562:          %% *** Wait for start order part ***
<a name="26563"/>26563:          #{desc =&gt; &quot;await start&quot;,
<a name="26564"/>26564:            cmd  =&gt; fun(State) -&gt;
<a name="26565"/>26565:                            {Tester, ServerSA} = ?SEV_AWAIT_START(),
<a name="26566"/>26566:                            {ok, State#{tester    =&gt; Tester,
<a name="26567"/>26567:                                        server_sa =&gt; ServerSA}}
<a name="26568"/>26568:                    end},
<a name="26569"/>26569:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="26570"/>26570:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="26571"/>26571:                            _MRef = erlang:monitor(process, Tester),
<a name="26572"/>26572:                            ok
<a name="26573"/>26573:                    end},
<a name="26574"/>26574: 
<a name="26575"/>26575:          %% *** Init part ***
<a name="26576"/>26576:          #{desc =&gt; &quot;which local address&quot;,
<a name="26577"/>26577:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="26578"/>26578:                            LSA = which_local_socket_addr(Domain),
<a name="26579"/>26579:                            {ok, State#{local_sa =&gt; LSA}}
<a name="26580"/>26580:                    end},
<a name="26581"/>26581:          #{desc =&gt; &quot;create node&quot;,
<a name="26582"/>26582:            cmd  =&gt; fun(#{host := _Host} = State) -&gt;
<a name="26583"/>26583:                            {Peer, Node} = ?START_NODE(&quot;client&quot;),
<a name="26584"/>26584:                            {ok, State#{node =&gt; Node, peer =&gt; Peer}}
<a name="26585"/>26585:                    end},
<a name="26586"/>26586:          #{desc =&gt; &quot;monitor client node&quot;,
<a name="26587"/>26587:            cmd  =&gt; fun(#{node := Node} = _State) -&gt;
<a name="26588"/>26588:                            true = erlang:monitor_node(Node, true),
<a name="26589"/>26589:                            ok
<a name="26590"/>26590:                    end},
<a name="26591"/>26591:          #{desc =&gt; &quot;start remote client on client node&quot;,
<a name="26592"/>26592:            cmd  =&gt; fun(#{node := Node} = State) -&gt;
<a name="26593"/>26593:                            Pid = api_toc_tcp_client_start(Node),
<a name="26594"/>26594:                            ?SEV_IPRINT(&quot;remote client ~p started&quot;, [Pid]),
<a name="26595"/>26595:                            {ok, State#{rclient =&gt; Pid}}
<a name="26596"/>26596:                    end},
<a name="26597"/>26597:          #{desc =&gt; &quot;monitor remote client&quot;,
<a name="26598"/>26598:            cmd  =&gt; fun(#{rclient := Pid}) -&gt;
<a name="26599"/>26599:                            _MRef = erlang:monitor(process, Pid),
<a name="26600"/>26600:                            ok
<a name="26601"/>26601:                    end},
<a name="26602"/>26602:          #{desc =&gt; &quot;order remote client to start&quot;,
<a name="26603"/>26603:            cmd  =&gt; fun(#{rclient   := Client,
<a name="26604"/>26604:                          server_sa := ServerSA}) -&gt;
<a name="26605"/>26605:                            ?SEV_ANNOUNCE_START(Client, ServerSA),
<a name="26606"/>26606:                            ok
<a name="26607"/>26607:                    end},
<a name="26608"/>26608:          #{desc =&gt; &quot;await remote client ready&quot;,
<a name="26609"/>26609:            cmd  =&gt; fun(#{tester  := Tester,
<a name="26610"/>26610:                          rclient := Client} = _State) -&gt;
<a name="26611"/>26611:                            ?SEV_AWAIT_READY(Client, rclient, init,
<a name="26612"/>26612:                                             [{tester, Tester}])
<a name="26613"/>26613:                    end},
<a name="26614"/>26614:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="26615"/>26615:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="26616"/>26616:                            ?SEV_ANNOUNCE_READY(Tester, init),
<a name="26617"/>26617:                            ok
<a name="26618"/>26618:                    end},
<a name="26619"/>26619: 
<a name="26620"/>26620:          %% The actual test
<a name="26621"/>26621:          #{desc =&gt; &quot;await continue (connect)&quot;,
<a name="26622"/>26622:            cmd  =&gt; fun(#{tester  := Tester,
<a name="26623"/>26623:                          rclient := Client} = State) -&gt;
<a name="26624"/>26624:                            case ?SEV_AWAIT_CONTINUE(Tester, tester, connect,
<a name="26625"/>26625:                                                     [{rclient, Client}]) of
<a name="26626"/>26626:                                {ok, {ConTimeout, ConLimit}} -&gt;
<a name="26627"/>26627:                                    {ok, State#{connect_timeout =&gt; ConTimeout,
<a name="26628"/>26628:                                                connect_limit   =&gt; ConLimit}};
<a name="26629"/>26629:                                {error, _} = ERROR -&gt;
<a name="26630"/>26630:                                    ERROR
<a name="26631"/>26631:                            end
<a name="26632"/>26632:                    end},
<a name="26633"/>26633:          #{desc =&gt; &quot;order remote client to continue (connect)&quot;,
<a name="26634"/>26634:            cmd  =&gt; fun(#{rclient         := RClient,
<a name="26635"/>26635:                          connect_timeout := ConTimeout,
<a name="26636"/>26636:                          connect_limit   := ConLimit}) -&gt;
<a name="26637"/>26637:                            ?SEV_ANNOUNCE_CONTINUE(RClient, connect,
<a name="26638"/>26638:                                                   {ConTimeout, ConLimit}),
<a name="26639"/>26639:                            ok
<a name="26640"/>26640:                    end},
<a name="26641"/>26641:          #{desc =&gt; &quot;await remote client ready (connect)&quot;,
<a name="26642"/>26642:            cmd  =&gt; fun(#{tester  := Tester,
<a name="26643"/>26643:                          rclient := RClient} = State) -&gt;
<a name="26644"/>26644:                            case ?SEV_AWAIT_READY(RClient, rclient, connect,
<a name="26645"/>26645:                                                  [{tester, Tester}]) of
<a name="26646"/>26646:                                {ok, ok = _Result} -&gt;
<a name="26647"/>26647:                                    {ok, maps:remove(connect_limit, State)};
<a name="26648"/>26648:                                {ok, {error, {connect_limit_reached,R,L}}} -&gt;
<a name="26649"/>26649:                                    {skip,
<a name="26650"/>26650:                                     ?LIB:f(&quot;Connect limit reached ~w: ~w&quot;,
<a name="26651"/>26651:                                            [L, R])};
<a name="26652"/>26652:                                {ok, Result} -&gt;
<a name="26653"/>26653:                                    Result;
<a name="26654"/>26654:                                {error, _} = ERROR -&gt;
<a name="26655"/>26655:                                    ERROR
<a name="26656"/>26656:                            end
<a name="26657"/>26657:                    end},
<a name="26658"/>26658: 
<a name="26659"/>26659:          #{desc =&gt; &quot;announce ready (connect)&quot;,
<a name="26660"/>26660:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="26661"/>26661:                            ?SEV_ANNOUNCE_READY(Tester, connect),
<a name="26662"/>26662:                            ok
<a name="26663"/>26663:                    end},
<a name="26664"/>26664: 
<a name="26665"/>26665:          %% Termination
<a name="26666"/>26666:          #{desc =&gt; &quot;await terminate (from tester)&quot;,
<a name="26667"/>26667:            cmd  =&gt; fun(#{tester  := Tester,
<a name="26668"/>26668:                          rclient := RClient} = State) -&gt;
<a name="26669"/>26669:                            case ?SEV_AWAIT_TERMINATE(Tester, tester,
<a name="26670"/>26670:                                                      [{rclient, RClient}]) of
<a name="26671"/>26671:                                ok -&gt;
<a name="26672"/>26672:                                    {ok, maps:remove(tester, State)};
<a name="26673"/>26673:                                {error, _} = ERROR -&gt;
<a name="26674"/>26674:                                    ERROR
<a name="26675"/>26675:                            end
<a name="26676"/>26676:                    end},
<a name="26677"/>26677:          #{desc =&gt; &quot;kill remote client&quot;,
<a name="26678"/>26678:            cmd  =&gt; fun(#{rclient := Client}) -&gt;
<a name="26679"/>26679:                            ?SEV_ANNOUNCE_TERMINATE(Client),
<a name="26680"/>26680:                            ok
<a name="26681"/>26681:                    end},
<a name="26682"/>26682:          #{desc =&gt; &quot;await remote client termination&quot;,
<a name="26683"/>26683:            cmd  =&gt; fun(#{rclient := Client} = State) -&gt;
<a name="26684"/>26684:                            ?SEV_AWAIT_TERMINATION(Client),
<a name="26685"/>26685:                            State1 = maps:remove(rclient, State),
<a name="26686"/>26686:                            {ok, State1}
<a name="26687"/>26687:                    end},
<a name="26688"/>26688:          #{desc =&gt; &quot;stop client node&quot;,
<a name="26689"/>26689:            cmd  =&gt; fun(#{peer := Peer} = State) -&gt;
<a name="26690"/>26690:                            {ok,
<a name="26691"/>26691:                             try peer:stop(Peer) of
<a name="26692"/>26692:                                 ok -&gt;
<a name="26693"/>26693:                                     State#{node_stop =&gt; ok};
<a name="26694"/>26694:                                 {error, Reason} -&gt;
<a name="26695"/>26695:                                     ?SEV_EPRINT(&quot;Unexpected node stop result: &quot;
<a name="26696"/>26696:                                                 &quot;~n   ~p&quot;, [Reason]),
<a name="26697"/>26697:                                     State#{node_stop =&gt; error}
<a name="26698"/>26698:                             catch
<a name="26699"/>26699:                                 C:E:S -&gt;
<a name="26700"/>26700:                                     ?SEV_EPRINT(&quot;Unexpected node stop result: &quot;
<a name="26701"/>26701:                                                 &quot;~n   Class: ~p&quot;
<a name="26702"/>26702:                                                 &quot;~n   Error: ~p&quot;
<a name="26703"/>26703:                                                 &quot;~n   Stack: ~p&quot;,[C, E, S]),
<a name="26704"/>26704:                                     State#{node_stop =&gt; error}
<a name="26705"/>26705:                             end}
<a name="26706"/>26706:                    end},
<a name="26707"/>26707:          #{desc =&gt; &quot;await client node termination&quot;,
<a name="26708"/>26708:            cmd  =&gt; fun(#{node := Node, node_stop := ok} = State) -&gt;
<a name="26709"/>26709:                            ?SEV_IPRINT(&quot;Success node stop - await nodedown&quot;),
<a name="26710"/>26710:                            receive
<a name="26711"/>26711:                                {nodedown, Node} -&gt;
<a name="26712"/>26712:                                    ?SEV_IPRINT(&quot;nodedown received - cleanup&quot;),
<a name="26713"/>26713:                                    State1 = maps:remove(peer, State),
<a name="26714"/>26714:                                    State2 = maps:remove(node, State1),
<a name="26715"/>26715:                                    {ok, State2}
<a name="26716"/>26716:                            end;
<a name="26717"/>26717:                       (#{node_stop := error} = State) -&gt;
<a name="26718"/>26718:                            ?SEV_IPRINT(&quot;Failed node stop - cleanup&quot;),
<a name="26719"/>26719:                            State1 = maps:remove(peer, State),
<a name="26720"/>26720:                            State2 = maps:remove(node, State1),
<a name="26721"/>26721:                            {ok, State2}
<a name="26722"/>26722:                    end},
<a name="26723"/>26723: 
<a name="26724"/>26724:          %% *** We are done ***
<a name="26725"/>26725:          ?SEV_FINISH_NORMAL
<a name="26726"/>26726:         ],
<a name="26727"/>26727: 
<a name="26728"/>26728:     TesterSeq =
<a name="26729"/>26729:         [
<a name="26730"/>26730:          %% *** Init part ***
<a name="26731"/>26731:          #{desc =&gt; &quot;monitor server&quot;,
<a name="26732"/>26732:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="26733"/>26733:                            _MRef = erlang:monitor(process, Server),
<a name="26734"/>26734:                            ok
<a name="26735"/>26735:                    end},
<a name="26736"/>26736:          #{desc =&gt; &quot;monitor client&quot;,
<a name="26737"/>26737:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="26738"/>26738:                            _MRef = erlang:monitor(process, Client),
<a name="26739"/>26739:                            ok
<a name="26740"/>26740:                    end},
<a name="26741"/>26741:          #{desc =&gt; &quot;which local address&quot;,
<a name="26742"/>26742:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="26743"/>26743:                            LSA = which_local_socket_addr(Domain),
<a name="26744"/>26744:                            {ok, State#{local_sa =&gt; LSA}}
<a name="26745"/>26745:                    end},
<a name="26746"/>26746:          #{desc =&gt; &quot;order server start&quot;,
<a name="26747"/>26747:            cmd  =&gt; fun(#{server  := Server,
<a name="26748"/>26748:                          backlog := Backlog}) -&gt;
<a name="26749"/>26749:                            ?SEV_ANNOUNCE_START(Server, Backlog),
<a name="26750"/>26750:                            ok
<a name="26751"/>26751:                    end},
<a name="26752"/>26752:          #{desc =&gt; &quot;await server ready (init)&quot;,
<a name="26753"/>26753:            cmd  =&gt; fun(#{server := Server, local_sa := LSA} = State) -&gt;
<a name="26754"/>26754:                            {ok, Port} = ?SEV_AWAIT_READY(Server, server, init),
<a name="26755"/>26755:                            ServerSA = LSA#{port =&gt; Port},
<a name="26756"/>26756:                            {ok, State#{server_sa =&gt; ServerSA}}
<a name="26757"/>26757:                    end},
<a name="26758"/>26758:          #{desc =&gt; &quot;order client start&quot;,
<a name="26759"/>26759:            cmd  =&gt; fun(#{client    := Client,
<a name="26760"/>26760:                          server_sa := ServerSA}) -&gt;
<a name="26761"/>26761:                            ?SEV_ANNOUNCE_START(Client, ServerSA),
<a name="26762"/>26762:                            ok
<a name="26763"/>26763:                    end},
<a name="26764"/>26764:          #{desc =&gt; &quot;await client ready (init)&quot;,
<a name="26765"/>26765:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="26766"/>26766:                            ?SEV_AWAIT_READY(Client, client, init),
<a name="26767"/>26767:                            ok
<a name="26768"/>26768:                    end},
<a name="26769"/>26769: 
<a name="26770"/>26770:          %% The actual test
<a name="26771"/>26771:          %% The server does nothing (this is the point), no accept,
<a name="26772"/>26772:          %% the client tries to connect.
<a name="26773"/>26773:          #{desc =&gt; &quot;order client continue (connect)&quot;,
<a name="26774"/>26774:            cmd  =&gt; fun(#{client        := Client,
<a name="26775"/>26775:                          timeout       := Timeout,
<a name="26776"/>26776:                          connect_limit := ConLimit} = _State) -&gt;
<a name="26777"/>26777:                            ?SEV_ANNOUNCE_CONTINUE(Client, connect,
<a name="26778"/>26778:                                                   {Timeout, ConLimit}),
<a name="26779"/>26779:                            ok
<a name="26780"/>26780:                    end},
<a name="26781"/>26781:          #{desc =&gt; &quot;await client ready (connect)&quot;,
<a name="26782"/>26782:            cmd  =&gt; fun(#{server := Server,
<a name="26783"/>26783:                          client := Client} = _State) -&gt;
<a name="26784"/>26784:                            case ?SEV_AWAIT_READY(Client, client, connect,
<a name="26785"/>26785:                                                  [{server, Server}]) of
<a name="26786"/>26786:                                ok -&gt;
<a name="26787"/>26787:                                    ok;
<a name="26788"/>26788:                                {error, _} = ERROR -&gt;
<a name="26789"/>26789:                                    ERROR
<a name="26790"/>26790:                            end
<a name="26791"/>26791:                    end},
<a name="26792"/>26792: 
<a name="26793"/>26793: 
<a name="26794"/>26794:          %% *** Terminate server ***
<a name="26795"/>26795:          #{desc =&gt; &quot;order client terminate&quot;,
<a name="26796"/>26796:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="26797"/>26797:                            ?SEV_ANNOUNCE_TERMINATE(Client),
<a name="26798"/>26798:                            ok
<a name="26799"/>26799:                    end},
<a name="26800"/>26800:          #{desc =&gt; &quot;await client down&quot;,
<a name="26801"/>26801:            cmd  =&gt; fun(#{client := Client} = State) -&gt;
<a name="26802"/>26802:                            ?SEV_AWAIT_TERMINATION(Client),
<a name="26803"/>26803:                            State1 = maps:remove(client,    State),
<a name="26804"/>26804:                            {ok, State1}
<a name="26805"/>26805:                    end},
<a name="26806"/>26806:          #{desc =&gt; &quot;order server terminate&quot;,
<a name="26807"/>26807:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="26808"/>26808:                            ?SEV_ANNOUNCE_TERMINATE(Server),
<a name="26809"/>26809:                            ok
<a name="26810"/>26810:                    end},
<a name="26811"/>26811:          #{desc =&gt; &quot;await server down&quot;,
<a name="26812"/>26812:            cmd  =&gt; fun(#{server := Server} = State) -&gt;
<a name="26813"/>26813:                            ?SEV_AWAIT_TERMINATION(Server),
<a name="26814"/>26814:                            State1 = maps:remove(server,    State),
<a name="26815"/>26815:                            State2 = maps:remove(server_sa, State1),
<a name="26816"/>26816:                            {ok, State2}
<a name="26817"/>26817:                    end},
<a name="26818"/>26818: 
<a name="26819"/>26819:          %% *** We are done ***
<a name="26820"/>26820:          ?SEV_FINISH_NORMAL
<a name="26821"/>26821:         ],
<a name="26822"/>26822: 
<a name="26823"/>26823:     i(&quot;create server evaluator&quot;),
<a name="26824"/>26824:     ServerInitState = #{domain =&gt; maps:get(domain, InitState)},
<a name="26825"/>26825:     Server          = ?SEV_START(&quot;server&quot;, ServerSeq, ServerInitState),
<a name="26826"/>26826: 
<a name="26827"/>26827:     i(&quot;create client evaluator&quot;),
<a name="26828"/>26828:     ClientInitState = #{host   =&gt; local_host(),
<a name="26829"/>26829:                         domain =&gt; maps:get(domain, InitState)},
<a name="26830"/>26830:     Client          = ?SEV_START(&quot;client&quot;, ClientSeq, ClientInitState),
<a name="26831"/>26831: 
<a name="26832"/>26832:     i(&quot;create tester evaluator&quot;),
<a name="26833"/>26833:     TesterInitState = InitState#{server =&gt; Server#ev.pid,
<a name="26834"/>26834:                                  client =&gt; Client#ev.pid},
<a name="26835"/>26835:     Tester          = ?SEV_START(&quot;tester&quot;, TesterSeq, TesterInitState),
<a name="26836"/>26836: 
<a name="26837"/>26837:     i(&quot;await evaluator(s)&quot;),
<a name="api_to_connect_tcp-last_expr"/><a name="26838"/>26838: <b>    ok = ?SEV_AWAIT_FINISH</b>([Server, Client, Tester]).
<a name="26839"/>26839: 
<a name="26840"/>26840: 
<a name="api_toc_tcp_client_start-1"/><a name="26841"/>26841: <b>api_toc_tcp_client_start</b>(Node) -&gt;
<a name="26842"/>26842:     Self = self(),
<a name="26843"/>26843:     Fun  = fun() -&gt; api_toc_tcp_client(Self) end,
<a name="api_toc_tcp_client_start-last_expr"/><a name="26844"/>26844: <b>    erlang:spawn</b>(Node, Fun).
<a name="26845"/>26845: 
<a name="api_toc_tcp_client-1"/><a name="26846"/>26846: <b>api_toc_tcp_client</b>(Parent) -&gt;
<a name="26847"/>26847:     api_toc_tcp_client_init(Parent),
<a name="26848"/>26848:     ServerSA = api_toc_tcp_client_await_start(Parent),
<a name="26849"/>26849:     Domain   = maps:get(family, ServerSA),
<a name="26850"/>26850:     api_toc_tcp_client_announce_ready(Parent, init),
<a name="26851"/>26851:     {To, ConLimit} = api_toc_tcp_client_await_continue(Parent, connect),
<a name="26852"/>26852:     Result = api_to_connect_tcp_await_timeout(To, ServerSA, Domain, ConLimit),
<a name="26853"/>26853:     ?SEV_IPRINT(&quot;result: ~p&quot;, [Result]),
<a name="26854"/>26854:     api_toc_tcp_client_announce_ready(Parent, connect, Result),
<a name="26855"/>26855:     Reason = api_toc_tcp_client_await_terminate(Parent),
<a name="api_toc_tcp_client-last_expr"/><a name="26856"/>26856: <b>    exit</b>(Reason).
<a name="26857"/>26857: 
<a name="api_toc_tcp_client_init-1"/><a name="26858"/>26858: <b>api_toc_tcp_client_init</b>(Parent) -&gt;
<a name="26859"/>26859:     put(sname, &quot;rclient&quot;),
<a name="26860"/>26860:     %% i(&quot;api_toc_tcp_client_init -&gt; entry&quot;),
<a name="26861"/>26861:     _MRef = erlang:monitor(process, Parent),
<a name="api_toc_tcp_client_init-last_expr"/><a name="26862"/>26862:     ok.
<a name="26863"/>26863: 
<a name="api_toc_tcp_client_await_start-1"/><a name="26864"/>26864: <b>api_toc_tcp_client_await_start</b>(Parent) -&gt;
<a name="26865"/>26865:     %% i(&quot;api_toc_tcp_client_await_start -&gt; entry&quot;),
<a name="api_toc_tcp_client_await_start-last_expr"/><a name="26866"/>26866: <b>    ?SEV_AWAIT_START</b>(Parent).
<a name="26867"/>26867: 
<a name="api_toc_tcp_client_announce_ready-2"/><a name="26868"/>26868: <b>api_toc_tcp_client_announce_ready</b>(Parent, Slogan) -&gt;
<a name="api_toc_tcp_client_announce_ready-last_expr"/><a name="26869"/>26869: <b>    ?SEV_ANNOUNCE_READY</b>(Parent, Slogan).
<a name="api_toc_tcp_client_announce_ready-3"/><a name="26870"/>26870: <b>api_toc_tcp_client_announce_ready</b>(Parent, Slogan, Result) -&gt;
<a name="api_toc_tcp_client_announce_ready-last_expr"/><a name="26871"/>26871: <b>    ?SEV_ANNOUNCE_READY</b>(Parent, Slogan, Result).
<a name="26872"/>26872: 
<a name="api_toc_tcp_client_await_continue-2"/><a name="26873"/>26873: <b>api_toc_tcp_client_await_continue</b>(Parent, Slogan) -&gt;
<a name="26874"/>26874:     %% i(&quot;api_toc_tcp_client_await_continue -&gt; entry&quot;),
<a name="api_toc_tcp_client_await_continue-last_expr"/><a name="26875"/>26875: <b>    case ?SEV_AWAIT_CONTINUE</b>(Parent, parent, Slogan) of
<a name="26876"/>26876:         ok -&gt;
<a name="26877"/>26877:             ok;
<a name="26878"/>26878:         {ok, Extra} -&gt;
<a name="26879"/>26879:             Extra;
<a name="26880"/>26880:         {error, Reason} -&gt;
<a name="26881"/>26881:             exit({await_continue, Slogan, Reason})
<a name="26882"/>26882:     end.
<a name="26883"/>26883: 
<a name="api_toc_tcp_client_await_terminate-1"/><a name="26884"/>26884: <b>api_toc_tcp_client_await_terminate</b>(Parent) -&gt;
<a name="26885"/>26885:     %% i(&quot;api_toc_tcp_client_await_terminate -&gt; entry&quot;),
<a name="api_toc_tcp_client_await_terminate-last_expr"/><a name="26886"/>26886: <b>    case ?SEV_AWAIT_TERMINATE</b>(Parent, parent) of
<a name="26887"/>26887:         ok -&gt;
<a name="26888"/>26888:             ok;
<a name="26889"/>26889:         {error, Reason} -&gt;
<a name="26890"/>26890:             Reason
<a name="26891"/>26891:     end.
<a name="26892"/>26892: 
<a name="api_to_connect_tcp_await_timeout-4"/><a name="26893"/>26893: <b>api_to_connect_tcp_await_timeout</b>(To, ServerSA, Domain, ConLimit) -&gt;
<a name="26894"/>26894:     LSA = which_local_socket_addr(Domain),
<a name="26895"/>26895:     NewSock = fun() -&gt;
<a name="26896"/>26896:                       S = case socket:open(Domain, stream, tcp) of
<a name="26897"/>26897:                               {ok, Sock} -&gt;
<a name="26898"/>26898:                                   Sock;
<a name="26899"/>26899:                               {error, OReason} -&gt;
<a name="26900"/>26900:                                   ?FAIL({open, OReason})
<a name="26901"/>26901:                           end,
<a name="26902"/>26902:                       case socket:bind(S, LSA) of
<a name="26903"/>26903:                           ok -&gt;
<a name="26904"/>26904:                               S;
<a name="26905"/>26905:                           {error, BReason} -&gt;
<a name="26906"/>26906:                               ?FAIL({bind, BReason})
<a name="26907"/>26907:                       end
<a name="26908"/>26908:               end,
<a name="api_to_connect_tcp_await_timeout-last_expr"/><a name="26909"/>26909: <b>    api_to_connect_tcp_await_timeout</b>(1, ConLimit, To, ServerSA, NewSock, []).
<a name="26910"/>26910: 
<a name="api_to_connect_tcp_await_timeout-6"/><a name="26911"/>26911: <b>api_to_connect_tcp_await_timeout</b>(ID, ConLimit, _To, _ServerSA, _NewSock, Acc)
<a name="26912"/>26912:   when (ID &gt; ConLimit) -&gt;
<a name="26913"/>26913:     api_to_connect_tcp_await_timeout3(Acc),
<a name="26914"/>26914:     {error, {connect_limit_reached, ID, ConLimit}};
<a name="26915"/>26915: <b>api_to_connect_tcp_await_timeout</b>(ID, ConLimit, To, ServerSA, NewSock, Acc) -&gt;
<a name="api_to_connect_tcp_await_timeout-last_expr"/><a name="26916"/>26916: <b>    case api_to_connect_tcp_await_timeout2</b>(ID, To, ServerSA, NewSock) of
<a name="26917"/>26917:         ok -&gt;
<a name="26918"/>26918:             %% ?SEV_IPRINT(&quot;success when number of socks: ~w&quot;, [length(Acc)]),
<a name="26919"/>26919:             api_to_connect_tcp_await_timeout3(Acc),
<a name="26920"/>26920:             ok;
<a name="26921"/>26921:         {ok, Sock} -&gt;
<a name="26922"/>26922:             %% ?SEV_IPRINT(&quot;~w: unexpected success (connect)&quot;, [ID]),
<a name="26923"/>26923:             api_to_connect_tcp_await_timeout(ID+1, ConLimit,
<a name="26924"/>26924:                                              To, ServerSA, NewSock,
<a name="26925"/>26925:                                              [Sock|Acc]);
<a name="26926"/>26926:         {error, _} = ERROR -&gt;
<a name="26927"/>26927:             ERROR
<a name="26928"/>26928:     end.
<a name="26929"/>26929: 
<a name="api_to_connect_tcp_await_timeout2-4"/><a name="26930"/>26930: <b>api_to_connect_tcp_await_timeout2</b>(_ID, To, ServerSA, NewSock) -&gt;
<a name="26931"/>26931:     Sock = NewSock(),
<a name="26932"/>26932:     %% ?SEV_IPRINT(&quot;~w: try connect&quot;, [ID]),
<a name="26933"/>26933:     Start = t(),
<a name="api_to_connect_tcp_await_timeout2-last_expr"/><a name="26934"/>26934: <b>    case socket:connect</b>(Sock, ServerSA, To) of
<a name="26935"/>26935:         {error, timeout} -&gt;
<a name="26936"/>26936:             Stop  = t(),
<a name="26937"/>26937:             TDiff = Stop - Start,
<a name="26938"/>26938:             if
<a name="26939"/>26939:                 (TDiff &gt;= To) -&gt;
<a name="26940"/>26940:                     (catch socket:close(Sock)),
<a name="26941"/>26941:                     ok;
<a name="26942"/>26942:                 true -&gt;
<a name="26943"/>26943:                     (catch socket:close(Sock)),
<a name="26944"/>26944:                     ?FAIL({unexpected_timeout, TDiff, To})
<a name="26945"/>26945:             end;
<a name="26946"/>26946:         {error, econnreset = _Reason} -&gt;
<a name="26947"/>26947:             (catch socket:close(Sock)),
<a name="26948"/>26948:             ok;
<a name="26949"/>26949:         {error, Reason} -&gt;
<a name="26950"/>26950:             (catch socket:close(Sock)),
<a name="26951"/>26951:             ?FAIL({connect, Reason});
<a name="26952"/>26952:         ok -&gt;
<a name="26953"/>26953:             {ok, Sock}
<a name="26954"/>26954:     end.
<a name="26955"/>26955: 
<a name="api_to_connect_tcp_await_timeout3-1"/><a name="26956"/>26956: <b>api_to_connect_tcp_await_timeout3</b>([]) -&gt;
<a name="26957"/>26957:     ok;
<a name="26958"/>26958: <b>api_to_connect_tcp_await_timeout3</b>([Sock|Socka]) -&gt;
<a name="26959"/>26959:     (catch socket:close(Sock)),
<a name="api_to_connect_tcp_await_timeout3-last_expr"/><a name="26960"/>26960: <b>    api_to_connect_tcp_await_timeout3</b>(Socka).
<a name="26961"/>26961: 
<a name="26962"/>26962: 
<a name="26963"/>26963: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="26964"/>26964: 
<a name="26965"/>26965: <i>%% This test case is intended to test the accept timeout option</i>
<a name="26966"/>26966: <i>%% on an IPv4 TCP (stream) socket.</i>
<a name="api_to_accept_tcp4-1"/><a name="26967"/>26967: <b>api_to_accept_tcp4</b>(_Config) when is_list(_Config) -&gt;
<a name="26968"/>26968:     ?TT(?SECS(10)),
<a name="api_to_accept_tcp4-last_expr"/><a name="26969"/>26969: <b>    tc_try</b>(api_to_accept_tcp4,
<a name="26970"/>26970:            fun() -&gt; has_support_ipv4() end,
<a name="26971"/>26971:            fun() -&gt;
<a name="26972"/>26972:                    InitState = #{domain =&gt; inet, timeout =&gt; 5000},
<a name="26973"/>26973:                    ok = api_to_accept_tcp(InitState)
<a name="26974"/>26974:            end).
<a name="26975"/>26975: 
<a name="26976"/>26976: 
<a name="26977"/>26977: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="26978"/>26978: 
<a name="26979"/>26979: <i>%% This test case is intended to test the accept timeout option</i>
<a name="26980"/>26980: <i>%% on an IPv6 TCP (stream) socket.</i>
<a name="api_to_accept_tcp6-1"/><a name="26981"/>26981: <b>api_to_accept_tcp6</b>(_Config) when is_list(_Config) -&gt;
<a name="26982"/>26982:     ?TT(?SECS(10)),
<a name="api_to_accept_tcp6-last_expr"/><a name="26983"/>26983: <b>    tc_try</b>(api_to_accept_tcp6,
<a name="26984"/>26984:            fun() -&gt; has_support_ipv6() end,
<a name="26985"/>26985:            fun() -&gt;
<a name="26986"/>26986:                    InitState = #{domain =&gt; inet6, timeout =&gt; 5000},
<a name="26987"/>26987:                    ok = api_to_accept_tcp(InitState)
<a name="26988"/>26988:            end).
<a name="26989"/>26989: 
<a name="26990"/>26990: 
<a name="26991"/>26991: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="26992"/>26992: 
<a name="api_to_accept_tcp-1"/><a name="26993"/>26993: <b>api_to_accept_tcp</b>(InitState) -&gt;
<a name="26994"/>26994:     TesterSeq =
<a name="26995"/>26995:         [
<a name="26996"/>26996:          %% *** Init part ***
<a name="26997"/>26997:          #{desc =&gt; &quot;which local address&quot;,
<a name="26998"/>26998:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="26999"/>26999:                            LSA = which_local_socket_addr(Domain),
<a name="27000"/>27000:                            {ok, State#{lsa =&gt; LSA}}
<a name="27001"/>27001:                    end},
<a name="27002"/>27002:          #{desc =&gt; &quot;create (listen) socket&quot;,
<a name="27003"/>27003:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="27004"/>27004:                            case socket:open(Domain, stream, tcp) of
<a name="27005"/>27005:                                {ok, Sock} -&gt;
<a name="27006"/>27006:                                    {ok, State#{lsock =&gt; Sock}};
<a name="27007"/>27007:                                {error, _} = ERROR -&gt;
<a name="27008"/>27008:                                    ERROR
<a name="27009"/>27009:                            end
<a name="27010"/>27010:                    end},
<a name="27011"/>27011:          #{desc =&gt; &quot;bind to local address&quot;,
<a name="27012"/>27012:            cmd  =&gt; fun(#{lsock := LSock, lsa := LSA} = _State) -&gt;
<a name="27013"/>27013:                            case sock_bind(LSock, LSA) of
<a name="27014"/>27014:                                ok -&gt;
<a name="27015"/>27015:                                    ok;
<a name="27016"/>27016:                                {error, _} = ERROR -&gt;
<a name="27017"/>27017:                                    ERROR
<a name="27018"/>27018:                            end
<a name="27019"/>27019:                    end},
<a name="27020"/>27020:          #{desc =&gt; &quot;make listen socket&quot;,
<a name="27021"/>27021:            cmd  =&gt; fun(#{lsock := LSock}) -&gt;
<a name="27022"/>27022:                            socket:listen(LSock)
<a name="27023"/>27023:                    end},
<a name="27024"/>27024: 
<a name="27025"/>27025:          %% *** The actual test part ***
<a name="27026"/>27026:          #{desc =&gt; &quot;attempt to accept (without success)&quot;,
<a name="27027"/>27027:            cmd  =&gt; fun(#{lsock := LSock, timeout := To} = State) -&gt;
<a name="27028"/>27028:                            Start = t(),
<a name="27029"/>27029:                            case socket:accept(LSock, To) of
<a name="27030"/>27030:                                {error, timeout} -&gt;
<a name="27031"/>27031:                                    {ok, State#{start =&gt; Start, stop =&gt; t()}};
<a name="27032"/>27032:                                {ok, Sock} -&gt;
<a name="27033"/>27033:                                    (catch socket:close(Sock)),
<a name="27034"/>27034:                                    {error, unexpected_success};
<a name="27035"/>27035:                                {error, _} = ERROR -&gt;
<a name="27036"/>27036:                                    ERROR
<a name="27037"/>27037:                            end
<a name="27038"/>27038:                    end},
<a name="27039"/>27039:          #{desc =&gt; &quot;validate timeout time&quot;,
<a name="27040"/>27040:            cmd  =&gt; fun(#{start := Start, stop := Stop, timeout := To} = _State) -&gt;
<a name="27041"/>27041:                            TDiff  = Stop - Start,
<a name="27042"/>27042:                            if
<a name="27043"/>27043:                                (TDiff &gt;= To) -&gt;
<a name="27044"/>27044:                                    ok;
<a name="27045"/>27045:                                true -&gt;
<a name="27046"/>27046:                                    {error, {unexpected_timeout, TDiff, To}}
<a name="27047"/>27047:                            end
<a name="27048"/>27048:                    end},
<a name="27049"/>27049: 
<a name="27050"/>27050:          %% *** Close (listen) socket ***
<a name="27051"/>27051:          #{desc =&gt; &quot;close (listen) socket&quot;,
<a name="27052"/>27052:            cmd  =&gt; fun(#{lsock := LSock} = State) -&gt;
<a name="27053"/>27053:                            sock_close(LSock),
<a name="27054"/>27054:                            {ok, maps:remove(sock3, State)}
<a name="27055"/>27055:                    end},
<a name="27056"/>27056: 
<a name="27057"/>27057:          %% *** We are done ***
<a name="27058"/>27058:          ?SEV_FINISH_NORMAL
<a name="27059"/>27059:         ],
<a name="27060"/>27060: 
<a name="27061"/>27061:     i(&quot;create tester evaluator&quot;),
<a name="27062"/>27062:     Tester = ?SEV_START(&quot;tester&quot;, TesterSeq, InitState),
<a name="27063"/>27063: 
<a name="27064"/>27064:     i(&quot;await evaluator&quot;),
<a name="api_to_accept_tcp-last_expr"/><a name="27065"/>27065: <b>    ok = ?SEV_AWAIT_FINISH</b>([Tester]).
<a name="27066"/>27066: 
<a name="27067"/>27067: 
<a name="27068"/>27068: 
<a name="27069"/>27069: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="27070"/>27070: 
<a name="27071"/>27071: <i>%% This test case is intended to test the multi accept timeout option</i>
<a name="27072"/>27072: <i>%% on an IPv4 TCP (stream) socket with multiple acceptor processes </i>
<a name="27073"/>27073: <i>%% (three in this case).</i>
<a name="api_to_maccept_tcp4-1"/><a name="27074"/>27074: <b>api_to_maccept_tcp4</b>(_Config) when is_list(_Config) -&gt;
<a name="27075"/>27075:     ?TT(?SECS(20)),
<a name="api_to_maccept_tcp4-last_expr"/><a name="27076"/>27076: <b>    tc_try</b>(api_to_maccept_tcp4,
<a name="27077"/>27077:            fun() -&gt; has_support_ipv4() end,
<a name="27078"/>27078:            fun() -&gt;
<a name="27079"/>27079:                    InitState = #{domain =&gt; inet, timeout =&gt; 5000},
<a name="27080"/>27080:                    ok = api_to_maccept_tcp(InitState)
<a name="27081"/>27081:            end).
<a name="27082"/>27082: 
<a name="27083"/>27083: 
<a name="27084"/>27084: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="27085"/>27085: 
<a name="27086"/>27086: <i>%% This test case is intended to test the accept timeout option</i>
<a name="27087"/>27087: <i>%% on an IPv6 TCP (stream) socket.</i>
<a name="api_to_maccept_tcp6-1"/><a name="27088"/>27088: <b>api_to_maccept_tcp6</b>(_Config) when is_list(_Config) -&gt;
<a name="27089"/>27089:     ?TT(?SECS(20)),
<a name="api_to_maccept_tcp6-last_expr"/><a name="27090"/>27090: <b>    tc_try</b>(api_to_maccept_tcp6,
<a name="27091"/>27091:            fun() -&gt; has_support_ipv6() end,
<a name="27092"/>27092:            fun() -&gt;
<a name="27093"/>27093:                    InitState = #{domain =&gt; inet6, timeout =&gt; 5000},
<a name="27094"/>27094:                    ok = api_to_maccept_tcp(InitState)
<a name="27095"/>27095:            end).
<a name="27096"/>27096: 
<a name="27097"/>27097: 
<a name="27098"/>27098: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="27099"/>27099: 
<a name="api_to_maccept_tcp-1"/><a name="27100"/>27100: <b>api_to_maccept_tcp</b>(InitState) -&gt;
<a name="27101"/>27101:     PrimAcceptorSeq =
<a name="27102"/>27102:         [
<a name="27103"/>27103:          %% *** Init part ***
<a name="27104"/>27104:          #{desc =&gt; &quot;await start&quot;,
<a name="27105"/>27105:            cmd  =&gt; fun(State) -&gt;
<a name="27106"/>27106:                            Tester = ?SEV_AWAIT_START(),
<a name="27107"/>27107:                            {ok, State#{tester =&gt; Tester}}
<a name="27108"/>27108:                    end},
<a name="27109"/>27109:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="27110"/>27110:            cmd  =&gt; fun(#{tester := Pid} = _State) -&gt;
<a name="27111"/>27111:                            _MRef = erlang:monitor(process, Pid),
<a name="27112"/>27112:                            ok
<a name="27113"/>27113:                    end},
<a name="27114"/>27114:          #{desc =&gt; &quot;which local address&quot;,
<a name="27115"/>27115:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="27116"/>27116:                            LSA = which_local_socket_addr(Domain),
<a name="27117"/>27117:                            {ok, State#{lsa =&gt; LSA}}
<a name="27118"/>27118:                    end},
<a name="27119"/>27119:          #{desc =&gt; &quot;create (listen) socket&quot;,
<a name="27120"/>27120:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="27121"/>27121:                            case socket:open(Domain, stream, tcp) of
<a name="27122"/>27122:                                {ok, Sock} -&gt;
<a name="27123"/>27123:                                    {ok, State#{lsock =&gt; Sock}};
<a name="27124"/>27124:                                {error, _} = ERROR -&gt;
<a name="27125"/>27125:                                    ERROR
<a name="27126"/>27126:                            end
<a name="27127"/>27127:                    end},
<a name="27128"/>27128:          #{desc =&gt; &quot;bind to local address&quot;,
<a name="27129"/>27129:            cmd  =&gt; fun(#{lsock := LSock, lsa := LSA} = _State) -&gt;
<a name="27130"/>27130:                            case sock_bind(LSock, LSA) of
<a name="27131"/>27131:                                ok -&gt;
<a name="27132"/>27132:                                    ok;
<a name="27133"/>27133:                                {error, _} = ERROR -&gt;
<a name="27134"/>27134:                                    ERROR
<a name="27135"/>27135:                            end
<a name="27136"/>27136:                    end},
<a name="27137"/>27137:          #{desc =&gt; &quot;make listen socket&quot;,
<a name="27138"/>27138:            cmd  =&gt; fun(#{lsock := LSock}) -&gt;
<a name="27139"/>27139:                            socket:listen(LSock)
<a name="27140"/>27140:                    end},
<a name="27141"/>27141:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="27142"/>27142:            cmd  =&gt; fun(#{lsock := LSock, tester := Tester}) -&gt;
<a name="27143"/>27143:                            ?SEV_ANNOUNCE_READY(Tester, init, LSock),
<a name="27144"/>27144:                            ok
<a name="27145"/>27145:                    end},
<a name="27146"/>27146: 
<a name="27147"/>27147:          %% *** The actual test ***
<a name="27148"/>27148:          #{desc =&gt; &quot;await continue (accept)&quot;,
<a name="27149"/>27149:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="27150"/>27150:                            ?SEV_AWAIT_CONTINUE(Tester, tester, accept)
<a name="27151"/>27151:                    end},
<a name="27152"/>27152:          #{desc =&gt; &quot;attempt to accept (without success)&quot;,
<a name="27153"/>27153:            cmd  =&gt; fun(#{lsock := LSock, timeout := To} = State) -&gt;
<a name="27154"/>27154:                            Start = t(),
<a name="27155"/>27155:                            case socket:accept(LSock, To) of
<a name="27156"/>27156:                                {error, timeout} -&gt;
<a name="27157"/>27157:                                    {ok, State#{start =&gt; Start, stop =&gt; t()}};
<a name="27158"/>27158:                                {ok, Sock} -&gt;
<a name="27159"/>27159:                                    ?SEV_EPRINT(&quot;Unexpected accept success: &quot;
<a name="27160"/>27160:                                                &quot;~n   ~p&quot;, [Sock]),
<a name="27161"/>27161:                                    (catch socket:close(Sock)),
<a name="27162"/>27162:                                    {error, unexpected_success};
<a name="27163"/>27163:                                {error, _} = ERROR -&gt;
<a name="27164"/>27164:                                    ERROR
<a name="27165"/>27165:                            end
<a name="27166"/>27166:                    end},
<a name="27167"/>27167:          #{desc =&gt; &quot;validate timeout time&quot;,
<a name="27168"/>27168:            cmd  =&gt; fun(#{start := Start, stop := Stop, timeout := To} = _State) -&gt;
<a name="27169"/>27169:                            TDiff  = Stop - Start,
<a name="27170"/>27170:                            if
<a name="27171"/>27171:                                (TDiff &gt;= To) -&gt;
<a name="27172"/>27172:                                    ok;
<a name="27173"/>27173:                                true -&gt;
<a name="27174"/>27174:                                    {error, {unexpected_timeout, TDiff, To}}
<a name="27175"/>27175:                            end
<a name="27176"/>27176:                    end},
<a name="27177"/>27177:          #{desc =&gt; &quot;announce ready (accept)&quot;,
<a name="27178"/>27178:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="27179"/>27179:                            ?SEV_ANNOUNCE_READY(Tester, accept),
<a name="27180"/>27180:                            ok
<a name="27181"/>27181:                    end},
<a name="27182"/>27182: 
<a name="27183"/>27183:          %% *** Terminate ***
<a name="27184"/>27184:          #{desc =&gt; &quot;await terminate&quot;,
<a name="27185"/>27185:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="27186"/>27186:                            ?SEV_AWAIT_TERMINATE(Tester, tester),
<a name="27187"/>27187:                            ok
<a name="27188"/>27188:                    end},
<a name="27189"/>27189:          %% *** Close (listen) socket ***
<a name="27190"/>27190:          #{desc =&gt; &quot;close (listen) socket&quot;,
<a name="27191"/>27191:            cmd  =&gt; fun(#{lsock := LSock} = State) -&gt;
<a name="27192"/>27192:                            sock_close(LSock),
<a name="27193"/>27193:                            {ok, maps:remove(lsock, State)}
<a name="27194"/>27194:                    end},
<a name="27195"/>27195: 
<a name="27196"/>27196:          %% *** We are done ***
<a name="27197"/>27197:          ?SEV_FINISH_NORMAL
<a name="27198"/>27198:         ],
<a name="27199"/>27199: 
<a name="27200"/>27200: 
<a name="27201"/>27201:     SecAcceptorSeq =
<a name="27202"/>27202:         [
<a name="27203"/>27203:          %% *** Init part ***
<a name="27204"/>27204:          #{desc =&gt; &quot;await start&quot;,
<a name="27205"/>27205:            cmd  =&gt; fun(State) -&gt;
<a name="27206"/>27206:                            {Tester, LSock} = ?SEV_AWAIT_START(),
<a name="27207"/>27207:                            {ok, State#{tester =&gt; Tester,
<a name="27208"/>27208:                                        lsock  =&gt; LSock}}
<a name="27209"/>27209:                            
<a name="27210"/>27210:                    end},
<a name="27211"/>27211:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="27212"/>27212:            cmd  =&gt; fun(#{tester := Pid} = _State) -&gt;
<a name="27213"/>27213:                            _MRef = erlang:monitor(process, Pid),
<a name="27214"/>27214:                            ok
<a name="27215"/>27215:                    end},
<a name="27216"/>27216:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="27217"/>27217:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="27218"/>27218:                            ?SEV_ANNOUNCE_READY(Tester, init),
<a name="27219"/>27219:                            ok
<a name="27220"/>27220:                    end},
<a name="27221"/>27221: 
<a name="27222"/>27222:          %% *** The actual test part ***
<a name="27223"/>27223:          #{desc =&gt; &quot;await continue (accept)&quot;,
<a name="27224"/>27224:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="27225"/>27225:                            ?SEV_AWAIT_CONTINUE(Tester, tester, accept)
<a name="27226"/>27226:                    end},
<a name="27227"/>27227:          #{desc =&gt; &quot;attempt to accept (without success)&quot;,
<a name="27228"/>27228:            cmd  =&gt; fun(#{lsock := LSock, timeout := To} = State) -&gt;
<a name="27229"/>27229:                            Start = t(),
<a name="27230"/>27230:                            case socket:accept(LSock, To) of
<a name="27231"/>27231:                                {error, timeout} -&gt;
<a name="27232"/>27232:                                    {ok, State#{start =&gt; Start, stop =&gt; t()}};
<a name="27233"/>27233:                                {ok, Sock} -&gt;
<a name="27234"/>27234:                                    (catch socket:close(Sock)),
<a name="27235"/>27235:                                    {error, unexpected_success};
<a name="27236"/>27236:                                {error, _} = ERROR -&gt;
<a name="27237"/>27237:                                    ERROR
<a name="27238"/>27238:                            end
<a name="27239"/>27239:                    end},
<a name="27240"/>27240:          #{desc =&gt; &quot;validate timeout time&quot;,
<a name="27241"/>27241:            cmd  =&gt; fun(#{start := Start, stop := Stop, timeout := To} = State) -&gt;
<a name="27242"/>27242:                            TDiff  = Stop - Start,
<a name="27243"/>27243:                            if
<a name="27244"/>27244:                                (TDiff &gt;= To) -&gt;
<a name="27245"/>27245:                                    State1 = maps:remove(start, State),
<a name="27246"/>27246:                                    State2 = maps:remove(stop,  State1),
<a name="27247"/>27247:                                    {ok, State2};
<a name="27248"/>27248:                                true -&gt;
<a name="27249"/>27249:                                    {error, {unexpected_timeout, TDiff, To}}
<a name="27250"/>27250:                            end
<a name="27251"/>27251:                    end},
<a name="27252"/>27252:          #{desc =&gt; &quot;announce ready (accept)&quot;,
<a name="27253"/>27253:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="27254"/>27254:                            ?SEV_ANNOUNCE_READY(Tester, accept),
<a name="27255"/>27255:                            ok
<a name="27256"/>27256:                    end},
<a name="27257"/>27257: 
<a name="27258"/>27258:          %% *** Terminate ***
<a name="27259"/>27259:          #{desc =&gt; &quot;await terminate&quot;,
<a name="27260"/>27260:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="27261"/>27261:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="27262"/>27262:                                ok -&gt;
<a name="27263"/>27263:                                    {ok, maps:remove(tester, State)};
<a name="27264"/>27264:                                {error, _} = ERROR -&gt;
<a name="27265"/>27265:                                    ERROR
<a name="27266"/>27266:                            end
<a name="27267"/>27267:                    end},
<a name="27268"/>27268: 
<a name="27269"/>27269:          %% *** We are done ***
<a name="27270"/>27270:          ?SEV_FINISH_NORMAL
<a name="27271"/>27271:         ],
<a name="27272"/>27272: 
<a name="27273"/>27273: 
<a name="27274"/>27274:     TesterSeq =
<a name="27275"/>27275:         [
<a name="27276"/>27276:          %% Init part
<a name="27277"/>27277:          #{desc =&gt; &quot;monitor prim-acceptor&quot;,
<a name="27278"/>27278:            cmd  =&gt; fun(#{prim_acceptor := Pid} = _State) -&gt;
<a name="27279"/>27279:                            _MRef = erlang:monitor(process, Pid),
<a name="27280"/>27280:                            ok
<a name="27281"/>27281:                    end},
<a name="27282"/>27282:          #{desc =&gt; &quot;monitor sec-acceptor 1&quot;,
<a name="27283"/>27283:            cmd  =&gt; fun(#{sec_acceptor1 := Pid} = _State) -&gt;
<a name="27284"/>27284:                            _MRef = erlang:monitor(process, Pid),
<a name="27285"/>27285:                            ok
<a name="27286"/>27286:                    end},
<a name="27287"/>27287:          #{desc =&gt; &quot;monitor sec-acceptor 2&quot;,
<a name="27288"/>27288:            cmd  =&gt; fun(#{sec_acceptor2 := Pid} = _State) -&gt;
<a name="27289"/>27289:                            _MRef = erlang:monitor(process, Pid),
<a name="27290"/>27290:                            ok
<a name="27291"/>27291:                    end},
<a name="27292"/>27292: 
<a name="27293"/>27293: 
<a name="27294"/>27294:          %% Start the prim-acceptor
<a name="27295"/>27295:          #{desc =&gt; &quot;start prim-acceptor&quot;,
<a name="27296"/>27296:            cmd  =&gt; fun(#{prim_acceptor := Pid} = _State) -&gt;
<a name="27297"/>27297:                            ?SEV_ANNOUNCE_START(Pid),
<a name="27298"/>27298:                            ok
<a name="27299"/>27299:                    end},
<a name="27300"/>27300:          #{desc =&gt; &quot;await prim-acceptor ready (init)&quot;,
<a name="27301"/>27301:            cmd  =&gt; fun(#{prim_acceptor := Pid} = State) -&gt;
<a name="27302"/>27302:                            {ok, Sock} = ?SEV_AWAIT_READY(Pid, prim_acceptor, init),
<a name="27303"/>27303:                            {ok, State#{lsock =&gt; Sock}}
<a name="27304"/>27304:                    end},
<a name="27305"/>27305: 
<a name="27306"/>27306:          %% Start sec-acceptor-1
<a name="27307"/>27307:          #{desc =&gt; &quot;start sec-acceptor 1&quot;,
<a name="27308"/>27308:            cmd  =&gt; fun(#{sec_acceptor1 := Pid, lsock := LSock} = _State) -&gt;
<a name="27309"/>27309:                            ?SEV_ANNOUNCE_START(Pid, LSock),
<a name="27310"/>27310:                            ok
<a name="27311"/>27311:                    end},
<a name="27312"/>27312:          #{desc =&gt; &quot;await sec-acceptor 1 ready (init)&quot;,
<a name="27313"/>27313:            cmd  =&gt; fun(#{sec_acceptor1 := Pid} = _State) -&gt;
<a name="27314"/>27314:                            ?SEV_AWAIT_READY(Pid, sec_acceptor1, init)
<a name="27315"/>27315:                    end},
<a name="27316"/>27316: 
<a name="27317"/>27317:          %% Start sec-acceptor-2
<a name="27318"/>27318:          #{desc =&gt; &quot;start sec-acceptor 2&quot;,
<a name="27319"/>27319:            cmd  =&gt; fun(#{sec_acceptor2 := Pid, lsock := LSock} = _State) -&gt;
<a name="27320"/>27320:                            ?SEV_ANNOUNCE_START(Pid, LSock),
<a name="27321"/>27321:                            ok
<a name="27322"/>27322:                    end},
<a name="27323"/>27323:          #{desc =&gt; &quot;await sec-acceptor 2 ready (init)&quot;,
<a name="27324"/>27324:            cmd  =&gt; fun(#{sec_acceptor2 := Pid} = _State) -&gt;
<a name="27325"/>27325:                            ?SEV_AWAIT_READY(Pid, sec_acceptor2, init)
<a name="27326"/>27326:                    end},
<a name="27327"/>27327: 
<a name="27328"/>27328:          %% Activate the acceptor(s)
<a name="27329"/>27329:          #{desc =&gt; &quot;active prim-acceptor&quot;,
<a name="27330"/>27330:            cmd  =&gt; fun(#{prim_acceptor := Pid} = _State) -&gt;
<a name="27331"/>27331:                            ?SEV_ANNOUNCE_CONTINUE(Pid, accept),
<a name="27332"/>27332:                            ok
<a name="27333"/>27333:                    end},
<a name="27334"/>27334:          #{desc =&gt; &quot;active sec-acceptor 1&quot;,
<a name="27335"/>27335:            cmd  =&gt; fun(#{sec_acceptor1 := Pid} = _State) -&gt;
<a name="27336"/>27336:                            ?SEV_ANNOUNCE_CONTINUE(Pid, accept),
<a name="27337"/>27337:                            ok
<a name="27338"/>27338:                    end},
<a name="27339"/>27339:          #{desc =&gt; &quot;active sec-acceptor 2&quot;,
<a name="27340"/>27340:            cmd  =&gt; fun(#{sec_acceptor2 := Pid} = _State) -&gt;
<a name="27341"/>27341:                            ?SEV_ANNOUNCE_CONTINUE(Pid, accept),
<a name="27342"/>27342:                            ok
<a name="27343"/>27343:                    end},
<a name="27344"/>27344: 
<a name="27345"/>27345:          %% Await acceptor(s) completions
<a name="27346"/>27346:          #{desc =&gt; &quot;await prim-acceptor ready (accept)&quot;,
<a name="27347"/>27347:            cmd  =&gt; fun(#{prim_acceptor := Pid} = _State) -&gt;
<a name="27348"/>27348:                            ?SEV_AWAIT_READY(Pid, prim_acceptor, accept)
<a name="27349"/>27349:                    end},
<a name="27350"/>27350:          #{desc =&gt; &quot;await sec-acceptor 1 ready (accept)&quot;,
<a name="27351"/>27351:            cmd  =&gt; fun(#{sec_acceptor1 := Pid} = _State) -&gt;
<a name="27352"/>27352:                            ?SEV_AWAIT_READY(Pid, sec_acceptor1, accept)
<a name="27353"/>27353:                    end},
<a name="27354"/>27354:          #{desc =&gt; &quot;await sec-acceptor 2 ready (accept)&quot;,
<a name="27355"/>27355:            cmd  =&gt; fun(#{sec_acceptor2 := Pid} = _State) -&gt;
<a name="27356"/>27356:                            ?SEV_AWAIT_READY(Pid, sec_acceptor2, accept)
<a name="27357"/>27357:                    end},
<a name="27358"/>27358: 
<a name="27359"/>27359:          %% Terminate
<a name="27360"/>27360:          #{desc =&gt; &quot;order prim-acceptor to terminate&quot;,
<a name="27361"/>27361:            cmd  =&gt; fun(#{prim_acceptor := Pid} = _State) -&gt;
<a name="27362"/>27362:                            ?SEV_ANNOUNCE_TERMINATE(Pid),
<a name="27363"/>27363:                            ok
<a name="27364"/>27364:                    end},
<a name="27365"/>27365:          #{desc =&gt; &quot;await prim-acceptor termination&quot;,
<a name="27366"/>27366:            cmd  =&gt; fun(#{prim_acceptor := Pid} = State) -&gt;
<a name="27367"/>27367:                            case ?SEV_AWAIT_TERMINATION(Pid) of
<a name="27368"/>27368:                                ok -&gt;
<a name="27369"/>27369:                                    State1 = maps:remove(prim_acceptor, State),
<a name="27370"/>27370:                                    {ok, State1};
<a name="27371"/>27371:                                {error, _} = ERROR -&gt;
<a name="27372"/>27372:                                    ERROR
<a name="27373"/>27373:                            end
<a name="27374"/>27374:                    end},
<a name="27375"/>27375:          #{desc =&gt; &quot;order sec-acceptor 1 to terminate&quot;,
<a name="27376"/>27376:            cmd  =&gt; fun(#{sec_acceptor1 := Pid} = _State) -&gt;
<a name="27377"/>27377:                            ?SEV_ANNOUNCE_TERMINATE(Pid),
<a name="27378"/>27378:                            ok
<a name="27379"/>27379:                    end},
<a name="27380"/>27380:          #{desc =&gt; &quot;await sec-acceptor 1 termination&quot;,
<a name="27381"/>27381:            cmd  =&gt; fun(#{sec_acceptor1 := Pid} = State) -&gt;
<a name="27382"/>27382:                            case ?SEV_AWAIT_TERMINATION(Pid) of
<a name="27383"/>27383:                                ok -&gt;
<a name="27384"/>27384:                                    State1 = maps:remove(sec_acceptor1, State),
<a name="27385"/>27385:                                    {ok, State1};
<a name="27386"/>27386:                                {error, _} = ERROR -&gt;
<a name="27387"/>27387:                                    ERROR
<a name="27388"/>27388:                            end
<a name="27389"/>27389:                    end},
<a name="27390"/>27390:          #{desc =&gt; &quot;order sec-acceptor 2 to terminate&quot;,
<a name="27391"/>27391:            cmd  =&gt; fun(#{sec_acceptor2 := Pid} = _State) -&gt;
<a name="27392"/>27392:                            ?SEV_ANNOUNCE_TERMINATE(Pid),
<a name="27393"/>27393:                            ok
<a name="27394"/>27394:                    end},
<a name="27395"/>27395:          #{desc =&gt; &quot;await sec-acceptor 2 termination&quot;,
<a name="27396"/>27396:            cmd  =&gt; fun(#{sec_acceptor2 := Pid} = State) -&gt;
<a name="27397"/>27397:                            case ?SEV_AWAIT_TERMINATION(Pid) of
<a name="27398"/>27398:                                ok -&gt;
<a name="27399"/>27399:                                    State1 = maps:remove(sec_acceptor2, State),
<a name="27400"/>27400:                                    {ok, State1};
<a name="27401"/>27401:                                {error, _} = ERROR -&gt;
<a name="27402"/>27402:                                    ERROR
<a name="27403"/>27403:                            end
<a name="27404"/>27404:                    end},
<a name="27405"/>27405:          
<a name="27406"/>27406:          %% *** We are done ***
<a name="27407"/>27407:          ?SEV_FINISH_NORMAL
<a name="27408"/>27408:         ],
<a name="27409"/>27409: 
<a name="27410"/>27410:     i(&quot;create prim-acceptor evaluator&quot;),
<a name="27411"/>27411:     PrimAInitState = InitState,
<a name="27412"/>27412:     PrimAcceptor = ?SEV_START(&quot;prim-acceptor&quot;, PrimAcceptorSeq, PrimAInitState),
<a name="27413"/>27413: 
<a name="27414"/>27414:     i(&quot;create sec-acceptor 1 evaluator&quot;),
<a name="27415"/>27415:     SecAInitState1 = maps:remove(domain, InitState),
<a name="27416"/>27416:     SecAcceptor1 = ?SEV_START(&quot;sec-acceptor-1&quot;, SecAcceptorSeq, SecAInitState1),
<a name="27417"/>27417:     
<a name="27418"/>27418:     i(&quot;create sec-acceptor 2 evaluator&quot;),
<a name="27419"/>27419:     SecAInitState2 = SecAInitState1,
<a name="27420"/>27420:     SecAcceptor2 = ?SEV_START(&quot;sec-acceptor-2&quot;, SecAcceptorSeq, SecAInitState2),
<a name="27421"/>27421: 
<a name="27422"/>27422:     i(&quot;create tester evaluator&quot;),
<a name="27423"/>27423:     TesterInitState = #{prim_acceptor =&gt; PrimAcceptor#ev.pid,
<a name="27424"/>27424:                         sec_acceptor1 =&gt; SecAcceptor1#ev.pid,
<a name="27425"/>27425:                         sec_acceptor2 =&gt; SecAcceptor2#ev.pid},
<a name="27426"/>27426:     Tester = ?SEV_START(&quot;tester&quot;, TesterSeq, TesterInitState),
<a name="27427"/>27427: 
<a name="27428"/>27428:     i(&quot;await evaluator(s)&quot;),
<a name="api_to_maccept_tcp-last_expr"/><a name="27429"/>27429: <b>    ok = ?SEV_AWAIT_FINISH</b>([PrimAcceptor, SecAcceptor1, SecAcceptor2, Tester]).
<a name="27430"/>27430: 
<a name="27431"/>27431: 
<a name="27432"/>27432: 
<a name="27433"/>27433: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="27434"/>27434: 
<a name="27435"/>27435: <i>%% This test case is intended to test the send timeout option</i>
<a name="27436"/>27436: <i>%% on an IPv4 TCP (stream) socket.</i>
<a name="api_to_send_tcp4-1"/><a name="27437"/>27437: <b>api_to_send_tcp4</b>(_Config) when is_list(_Config) -&gt;
<a name="api_to_send_tcp4-last_expr"/><a name="27438"/>27438: <b>    tc_try</b>(api_to_send_tcp4,
<a name="27439"/>27439:            fun() -&gt; has_support_ipv4() end,
<a name="27440"/>27440:            fun() -&gt;
<a name="27441"/>27441:                    not_yet_implemented()%% ,
<a name="27442"/>27442:                    %% ok = api_to_send_tcp(inet)
<a name="27443"/>27443:            end).
<a name="27444"/>27444: 
<a name="27445"/>27445: 
<a name="27446"/>27446: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="27447"/>27447: 
<a name="27448"/>27448: <i>%% This test case is intended to test the send timeout option</i>
<a name="27449"/>27449: <i>%% on an IPv6 TCP (stream) socket.</i>
<a name="api_to_send_tcp6-1"/><a name="27450"/>27450: <b>api_to_send_tcp6</b>(_Config) when is_list(_Config) -&gt;
<a name="api_to_send_tcp6-last_expr"/><a name="27451"/>27451: <b>    tc_try</b>(api_to_send_tcp6,
<a name="27452"/>27452:            fun() -&gt; has_support_ipv6() end,
<a name="27453"/>27453:            fun() -&gt;
<a name="27454"/>27454:                    not_yet_implemented()%% ,
<a name="27455"/>27455:                    %% ok = api_to_send_tcp(inet6)
<a name="27456"/>27456:            end).
<a name="27457"/>27457: 
<a name="27458"/>27458: 
<a name="27459"/>27459: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="27460"/>27460: 
<a name="27461"/>27461: <i>%% This test case is intended to test the sendto timeout option</i>
<a name="27462"/>27462: <i>%% on an IPv4 UDP (dgram) socket.</i>
<a name="api_to_sendto_udp4-1"/><a name="27463"/>27463: <b>api_to_sendto_udp4</b>(_Config) when is_list(_Config) -&gt;
<a name="api_to_sendto_udp4-last_expr"/><a name="27464"/>27464: <b>    tc_try</b>(api_to_sendto_udp4,
<a name="27465"/>27465:            fun () -&gt; has_support_ipv4() end,
<a name="27466"/>27466:            fun() -&gt;
<a name="27467"/>27467:                    not_yet_implemented()%% ,
<a name="27468"/>27468:                    %% ok = api_to_sendto_to_udp(inet)
<a name="27469"/>27469:            end).
<a name="27470"/>27470: 
<a name="27471"/>27471: 
<a name="27472"/>27472: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="27473"/>27473: 
<a name="27474"/>27474: <i>%% This test case is intended to test the sendto timeout option</i>
<a name="27475"/>27475: <i>%% on an IPv6 UDP (dgram) socket.</i>
<a name="api_to_sendto_udp6-1"/><a name="27476"/>27476: <b>api_to_sendto_udp6</b>(_Config) when is_list(_Config) -&gt;
<a name="api_to_sendto_udp6-last_expr"/><a name="27477"/>27477: <b>    tc_try</b>(api_to_sendto_udp6,
<a name="27478"/>27478:            fun() -&gt; has_support_ipv6() end,
<a name="27479"/>27479:            fun() -&gt;
<a name="27480"/>27480:                    not_yet_implemented()%% ,
<a name="27481"/>27481:                    %% ok = api_to_sendto_to_udp(inet6)
<a name="27482"/>27482:            end).
<a name="27483"/>27483: 
<a name="27484"/>27484: 
<a name="27485"/>27485: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="27486"/>27486: 
<a name="27487"/>27487: <i>%% This test case is intended to test the sendmsg timeout option</i>
<a name="27488"/>27488: <i>%% on an IPv4 TCP (stream) socket.</i>
<a name="api_to_sendmsg_tcp4-1"/><a name="27489"/>27489: <b>api_to_sendmsg_tcp4</b>(_Config) when is_list(_Config) -&gt;
<a name="api_to_sendmsg_tcp4-last_expr"/><a name="27490"/>27490: <b>    tc_try</b>(api_to_sendmsg_tcp4,
<a name="27491"/>27491:            fun() -&gt; has_support_ipv4() end,
<a name="27492"/>27492:            fun() -&gt;
<a name="27493"/>27493:                    not_yet_implemented()%% ,
<a name="27494"/>27494:                    %% ok = api_to_sendmsg_tcp(inet)
<a name="27495"/>27495:            end).
<a name="27496"/>27496: 
<a name="27497"/>27497: 
<a name="27498"/>27498: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="27499"/>27499: 
<a name="27500"/>27500: <i>%% This test case is intended to test the sendmsg timeout option</i>
<a name="27501"/>27501: <i>%% on an IPv6 TCP (stream) socket.</i>
<a name="api_to_sendmsg_tcp6-1"/><a name="27502"/>27502: <b>api_to_sendmsg_tcp6</b>(_Config) when is_list(_Config) -&gt;
<a name="api_to_sendmsg_tcp6-last_expr"/><a name="27503"/>27503: <b>    tc_try</b>(api_to_sendmsg_tcp6,
<a name="27504"/>27504:            fun() -&gt; has_support_ipv6() end,
<a name="27505"/>27505:            fun() -&gt;
<a name="27506"/>27506:                    not_yet_implemented()%% ,
<a name="27507"/>27507:                    %% ok = api_to_sendmsg_tcp(inet6)
<a name="27508"/>27508:            end).
<a name="27509"/>27509: 
<a name="27510"/>27510: 
<a name="27511"/>27511: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="27512"/>27512: 
<a name="27513"/>27513: <i>%% This test case is intended to test the recv timeout option</i>
<a name="27514"/>27514: <i>%% on an IPv4 UDP (dgram) socket. To test this we must connect</i>
<a name="27515"/>27515: <i>%% the socket.</i>
<a name="api_to_recv_udp4-1"/><a name="27516"/>27516: <b>api_to_recv_udp4</b>(_Config) when is_list(_Config) -&gt;
<a name="api_to_recv_udp4-last_expr"/><a name="27517"/>27517: <b>    tc_try</b>(api_to_recv_udp4,
<a name="27518"/>27518:            fun() -&gt; has_support_ipv4() end,
<a name="27519"/>27519:            fun() -&gt;
<a name="27520"/>27520:                    not_yet_implemented()%%,
<a name="27521"/>27521:                    %%ok = api_to_recv_udp(inet)
<a name="27522"/>27522:            end).
<a name="27523"/>27523: 
<a name="27524"/>27524: 
<a name="27525"/>27525: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="27526"/>27526: 
<a name="27527"/>27527: <i>%% This test case is intended to test the recv timeout option</i>
<a name="27528"/>27528: <i>%% on an IPv6 UDP (dgram) socket. To test this we must connect</i>
<a name="27529"/>27529: <i>%% the socket.</i>
<a name="api_to_recv_udp6-1"/><a name="27530"/>27530: <b>api_to_recv_udp6</b>(_Config) when is_list(_Config) -&gt;
<a name="api_to_recv_udp6-last_expr"/><a name="27531"/>27531: <b>    tc_try</b>(api_to_recv_udp6,
<a name="27532"/>27532:            fun() -&gt; has_support_ipv6() end,
<a name="27533"/>27533:            fun() -&gt;
<a name="27534"/>27534:                    not_yet_implemented()%% ,
<a name="27535"/>27535:                    %% ok = api_to_recv_udp(inet6)
<a name="27536"/>27536:            end).
<a name="27537"/>27537: 
<a name="27538"/>27538: 
<a name="27539"/>27539: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="27540"/>27540: 
<a name="27541"/>27541: <i>%% This test case is intended to test the recv timeout option</i>
<a name="27542"/>27542: <i>%% on an IPv4 TCP (stream) socket.</i>
<a name="api_to_recv_tcp4-1"/><a name="27543"/>27543: <b>api_to_recv_tcp4</b>(_Config) when is_list(_Config) -&gt;
<a name="27544"/>27544:     ?TT(?SECS(10)),
<a name="api_to_recv_tcp4-last_expr"/><a name="27545"/>27545: <b>    tc_try</b>(api_to_recv_tcp4,
<a name="27546"/>27546:            fun() -&gt; has_support_ipv4() end,
<a name="27547"/>27547:            fun() -&gt;
<a name="27548"/>27548:                    Recv = fun(Sock, To) -&gt; socket:recv(Sock, 0, To) end,
<a name="27549"/>27549:                    InitState = #{domain  =&gt; inet,
<a name="27550"/>27550:                                  recv    =&gt; Recv,
<a name="27551"/>27551:                                  timeout =&gt; 2000},
<a name="27552"/>27552:                    ok = api_to_receive_tcp(InitState)
<a name="27553"/>27553:            end).
<a name="27554"/>27554: 
<a name="27555"/>27555: 
<a name="27556"/>27556: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="27557"/>27557: 
<a name="27558"/>27558: <i>%% This test case is intended to test the recv timeout option</i>
<a name="27559"/>27559: <i>%% on an IPv6 TCP (stream) socket.</i>
<a name="api_to_recv_tcp6-1"/><a name="27560"/>27560: <b>api_to_recv_tcp6</b>(_Config) when is_list(_Config) -&gt;
<a name="27561"/>27561:     ?TT(?SECS(10)),
<a name="api_to_recv_tcp6-last_expr"/><a name="27562"/>27562: <b>    tc_try</b>(api_to_recv_tcp6,
<a name="27563"/>27563:            fun() -&gt; has_support_ipv6() end,
<a name="27564"/>27564:            fun() -&gt;
<a name="27565"/>27565:                    case socket:is_supported(ipv6) of
<a name="27566"/>27566:                        true -&gt;
<a name="27567"/>27567:                            Recv = fun(Sock, To) -&gt; 
<a name="27568"/>27568:                                           socket:recv(Sock, 0, To)
<a name="27569"/>27569:                                   end,
<a name="27570"/>27570:                            InitState = #{domain  =&gt; inet6,
<a name="27571"/>27571:                                          recv    =&gt; Recv,
<a name="27572"/>27572:                                          timeout =&gt; 2000},
<a name="27573"/>27573:                            ok = api_to_receive_tcp(InitState);
<a name="27574"/>27574:                        false -&gt;
<a name="27575"/>27575:                            skip(&quot;ipv6 not supported&quot;)
<a name="27576"/>27576:                    end
<a name="27577"/>27577:            end).
<a name="27578"/>27578: 
<a name="27579"/>27579: 
<a name="27580"/>27580: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="27581"/>27581: 
<a name="api_to_receive_tcp-1"/><a name="27582"/>27582: <b>api_to_receive_tcp</b>(InitState) -&gt;
<a name="27583"/>27583:     process_flag(trap_exit, true),
<a name="27584"/>27584: 
<a name="27585"/>27585:     ServerSeq = 
<a name="27586"/>27586:         [
<a name="27587"/>27587:          %% *** Wait for start order ***
<a name="27588"/>27588:          #{desc =&gt; &quot;await start (from tester)&quot;,
<a name="27589"/>27589:            cmd  =&gt; fun(State) -&gt;
<a name="27590"/>27590:                            Tester = ?SEV_AWAIT_START(),
<a name="27591"/>27591:                            {ok, State#{tester =&gt; Tester}}
<a name="27592"/>27592:                    end},
<a name="27593"/>27593:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="27594"/>27594:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="27595"/>27595:                            _MRef = erlang:monitor(process, Tester),
<a name="27596"/>27596:                            ok
<a name="27597"/>27597:                    end},
<a name="27598"/>27598: 
<a name="27599"/>27599:          %% *** Init part ***
<a name="27600"/>27600:          #{desc =&gt; &quot;which local address&quot;,
<a name="27601"/>27601:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="27602"/>27602:                            LSA = which_local_socket_addr(Domain),
<a name="27603"/>27603:                            {ok, State#{local_sa =&gt; LSA}}
<a name="27604"/>27604:                    end},
<a name="27605"/>27605:          #{desc =&gt; &quot;create listen socket&quot;,
<a name="27606"/>27606:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="27607"/>27607:                            case socket:open(Domain, stream, tcp) of
<a name="27608"/>27608:                                {ok, Sock} -&gt;
<a name="27609"/>27609:                                    {ok, State#{lsock =&gt; Sock}};
<a name="27610"/>27610:                                {error, _} = ERROR -&gt;
<a name="27611"/>27611:                                    ERROR
<a name="27612"/>27612:                            end
<a name="27613"/>27613:                    end},
<a name="27614"/>27614:          #{desc =&gt; &quot;bind to local address&quot;,
<a name="27615"/>27615:            cmd  =&gt; fun(#{lsock := LSock, local_sa := LSA} = State) -&gt;
<a name="27616"/>27616:                            case sock_bind(LSock, LSA) of
<a name="27617"/>27617:                                ok -&gt;
<a name="27618"/>27618:                                    Port = sock_port(LSock),
<a name="27619"/>27619:                                    {ok, State#{lport =&gt; Port}};
<a name="27620"/>27620:                                {error, _} = ERROR -&gt;
<a name="27621"/>27621:                                    ERROR
<a name="27622"/>27622:                            end
<a name="27623"/>27623:                    end},
<a name="27624"/>27624:          #{desc =&gt; &quot;make listen socket (with backlog = 1)&quot;,
<a name="27625"/>27625:            cmd  =&gt; fun(#{lsock := LSock}) -&gt;
<a name="27626"/>27626:                            socket:listen(LSock, 1)
<a name="27627"/>27627:                    end},
<a name="27628"/>27628:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="27629"/>27629:            cmd  =&gt; fun(#{tester := Tester, lport := Port}) -&gt;
<a name="27630"/>27630:                            ?SEV_ANNOUNCE_READY(Tester, init, Port),
<a name="27631"/>27631:                            ok
<a name="27632"/>27632:                    end},
<a name="27633"/>27633: 
<a name="27634"/>27634:          %% *** The actual test ***
<a name="27635"/>27635:          #{desc =&gt; &quot;await continue (accept and recv)&quot;,
<a name="27636"/>27636:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="27637"/>27637:                            ?SEV_AWAIT_CONTINUE(Tester, tester, accept_recv)
<a name="27638"/>27638:                    end},
<a name="27639"/>27639:          #{desc =&gt; &quot;attempt accept&quot;,
<a name="27640"/>27640:            cmd  =&gt; fun(#{lsock := LSock} = State) -&gt;
<a name="27641"/>27641:                            case socket:accept(LSock) of
<a name="27642"/>27642:                                {ok, Sock} -&gt;
<a name="27643"/>27643:                                    {ok, State#{sock =&gt; Sock}};
<a name="27644"/>27644:                                {error, _} = ERROR -&gt;
<a name="27645"/>27645:                                    ERROR
<a name="27646"/>27646:                            end
<a name="27647"/>27647:                    end},
<a name="27648"/>27648:          #{desc =&gt; &quot;attempt to recv (without success)&quot;,
<a name="27649"/>27649:            cmd  =&gt; fun(#{sock := Sock, recv := Recv, timeout := To} = State) -&gt;
<a name="27650"/>27650:                            Start = t(),
<a name="27651"/>27651:                            case Recv(Sock, To) of
<a name="27652"/>27652:                                {error, timeout} -&gt;
<a name="27653"/>27653:                                    {ok, State#{start =&gt; Start, stop =&gt; t()}};
<a name="27654"/>27654:                                {ok, _Data} -&gt;
<a name="27655"/>27655:                                    {error, unexpected_success};
<a name="27656"/>27656:                                {error, _} = ERROR -&gt;
<a name="27657"/>27657:                                    ERROR
<a name="27658"/>27658:                            end
<a name="27659"/>27659:                    end},
<a name="27660"/>27660:          #{desc =&gt; &quot;validate timeout time&quot;,
<a name="27661"/>27661:            cmd  =&gt; fun(#{start := Start, stop := Stop, timeout := To} = State) -&gt;
<a name="27662"/>27662:                            TDiff  = Stop - Start,
<a name="27663"/>27663:                            if
<a name="27664"/>27664:                                (TDiff &gt;= To) -&gt;
<a name="27665"/>27665:                                    State1 = maps:remove(start, State),
<a name="27666"/>27666:                                    State2 = maps:remove(stop,  State1),
<a name="27667"/>27667:                                    {ok, State2};
<a name="27668"/>27668:                                true -&gt;
<a name="27669"/>27669:                                    {error, {unexpected_timeout, TDiff, To}}
<a name="27670"/>27670:                            end
<a name="27671"/>27671:                    end},
<a name="27672"/>27672:          #{desc =&gt; &quot;announce ready (recv timeout success)&quot;,
<a name="27673"/>27673:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="27674"/>27674:                            ?SEV_ANNOUNCE_READY(Tester, accept_recv),
<a name="27675"/>27675:                            ok
<a name="27676"/>27676:                    end},
<a name="27677"/>27677: 
<a name="27678"/>27678:          %% *** Termination ***
<a name="27679"/>27679:          #{desc =&gt; &quot;await terminate&quot;,
<a name="27680"/>27680:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="27681"/>27681:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="27682"/>27682:                                ok -&gt;
<a name="27683"/>27683:                                    {ok, maps:remove(tester, State)};
<a name="27684"/>27684:                                {error, _} = ERROR -&gt;
<a name="27685"/>27685:                                    ERROR
<a name="27686"/>27686:                            end
<a name="27687"/>27687:                    end},
<a name="27688"/>27688:          #{desc =&gt; &quot;close (traffic) socket&quot;,
<a name="27689"/>27689:            cmd  =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="27690"/>27690:                            sock_close(Sock),
<a name="27691"/>27691:                            {ok, maps:remove(sock, State)}
<a name="27692"/>27692:                    end},
<a name="27693"/>27693:          #{desc =&gt; &quot;close (listen) socket&quot;,
<a name="27694"/>27694:            cmd  =&gt; fun(#{lsock := LSock} = State) -&gt;
<a name="27695"/>27695:                            sock_close(LSock),
<a name="27696"/>27696:                            {ok, maps:remove(lsock, State)}
<a name="27697"/>27697:                    end},
<a name="27698"/>27698: 
<a name="27699"/>27699:          %% *** We are done ***
<a name="27700"/>27700:          ?SEV_FINISH_NORMAL
<a name="27701"/>27701:         ],
<a name="27702"/>27702: 
<a name="27703"/>27703:     ClientSeq =
<a name="27704"/>27704:         [
<a name="27705"/>27705:          %% *** Wait for start order part ***
<a name="27706"/>27706:          #{desc =&gt; &quot;await start (from tester)&quot;,
<a name="27707"/>27707:            cmd  =&gt; fun(State) -&gt;
<a name="27708"/>27708:                            {Tester, Port} = ?SEV_AWAIT_START(),
<a name="27709"/>27709:                            {ok, State#{tester      =&gt; Tester,
<a name="27710"/>27710:                                        server_port =&gt; Port}}
<a name="27711"/>27711:                    end},
<a name="27712"/>27712:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="27713"/>27713:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="27714"/>27714:                            _MRef = erlang:monitor(process, Tester),
<a name="27715"/>27715:                            ok
<a name="27716"/>27716:                    end},
<a name="27717"/>27717: 
<a name="27718"/>27718:          %% *** Init part ***
<a name="27719"/>27719:          #{desc =&gt; &quot;which local address&quot;,
<a name="27720"/>27720:            cmd  =&gt; fun(#{domain := Domain, server_port := Port} = State) -&gt;
<a name="27721"/>27721:                            LSA = which_local_socket_addr(Domain),
<a name="27722"/>27722:                            SSA = LSA#{port =&gt; Port},
<a name="27723"/>27723:                            {ok, State#{local_sa =&gt; LSA, server_sa =&gt; SSA}}
<a name="27724"/>27724:                    end},
<a name="27725"/>27725:          #{desc =&gt; &quot;create socket&quot;,
<a name="27726"/>27726:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="27727"/>27727:                            case socket:open(Domain, stream, tcp) of
<a name="27728"/>27728:                                {ok, Sock} -&gt;
<a name="27729"/>27729:                                    {ok, State#{sock =&gt; Sock}};
<a name="27730"/>27730:                                {error, _} = ERROR -&gt;
<a name="27731"/>27731:                                    ERROR
<a name="27732"/>27732:                            end
<a name="27733"/>27733:                    end},
<a name="27734"/>27734:          #{desc =&gt; &quot;bind to local address&quot;,
<a name="27735"/>27735:            cmd  =&gt; fun(#{sock := Sock, local_sa := LSA} = _State) -&gt;
<a name="27736"/>27736:                            case sock_bind(Sock, LSA) of
<a name="27737"/>27737:                                ok -&gt;
<a name="27738"/>27738:                                    ok;
<a name="27739"/>27739:                                {error, _} = ERROR -&gt;
<a name="27740"/>27740:                                    ERROR
<a name="27741"/>27741:                            end
<a name="27742"/>27742:                    end},
<a name="27743"/>27743:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="27744"/>27744:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="27745"/>27745:                            ?SEV_ANNOUNCE_READY(Tester, init),
<a name="27746"/>27746:                            ok
<a name="27747"/>27747:                    end},
<a name="27748"/>27748: 
<a name="27749"/>27749:          %% *** The actual test ***
<a name="27750"/>27750:          #{desc =&gt; &quot;await continue (with connect)&quot;,
<a name="27751"/>27751:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="27752"/>27752:                            ?SEV_AWAIT_CONTINUE(Tester, tester, connect)
<a name="27753"/>27753:                    end},
<a name="27754"/>27754:          #{desc =&gt; &quot;connect&quot;,
<a name="27755"/>27755:            cmd  =&gt; fun(#{sock := Sock, server_sa := SSA}) -&gt;
<a name="27756"/>27756:                            sock_connect(Sock, SSA),
<a name="27757"/>27757:                            ok
<a name="27758"/>27758:                    end},
<a name="27759"/>27759: 
<a name="27760"/>27760:          %% *** Termination ***
<a name="27761"/>27761:          #{desc =&gt; &quot;await terminate&quot;,
<a name="27762"/>27762:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="27763"/>27763:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="27764"/>27764:                                ok -&gt;
<a name="27765"/>27765:                                    {ok, maps:remove(tester, State)};
<a name="27766"/>27766:                                {error, _} = ERROR -&gt;
<a name="27767"/>27767:                                    ERROR
<a name="27768"/>27768:                            end
<a name="27769"/>27769:                    end},
<a name="27770"/>27770:          #{desc =&gt; &quot;close socket&quot;,
<a name="27771"/>27771:            cmd  =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="27772"/>27772:                            sock_close(Sock),
<a name="27773"/>27773:                            {ok, maps:remove(sock, State)}
<a name="27774"/>27774:                    end},
<a name="27775"/>27775: 
<a name="27776"/>27776:          %% *** We are done ***
<a name="27777"/>27777:          ?SEV_FINISH_NORMAL
<a name="27778"/>27778:         ],
<a name="27779"/>27779: 
<a name="27780"/>27780:     TesterSeq =
<a name="27781"/>27781:         [
<a name="27782"/>27782:          %% *** Init part ***
<a name="27783"/>27783:          #{desc =&gt; &quot;monitor server&quot;,
<a name="27784"/>27784:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="27785"/>27785:                            _MRef = erlang:monitor(process, Server),
<a name="27786"/>27786:                            ok
<a name="27787"/>27787:                    end},
<a name="27788"/>27788:          #{desc =&gt; &quot;monitor client&quot;,
<a name="27789"/>27789:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="27790"/>27790:                            _MRef = erlang:monitor(process, Client),
<a name="27791"/>27791:                            ok
<a name="27792"/>27792:                    end},
<a name="27793"/>27793: 
<a name="27794"/>27794:          %% *** Activate server ***
<a name="27795"/>27795:          #{desc =&gt; &quot;start server&quot;,
<a name="27796"/>27796:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="27797"/>27797:                            ?SEV_ANNOUNCE_START(Server),
<a name="27798"/>27798:                            ok
<a name="27799"/>27799:                    end},
<a name="27800"/>27800:          #{desc =&gt; &quot;await server ready (init)&quot;,
<a name="27801"/>27801:            cmd  =&gt; fun(#{server := Server} = State) -&gt;
<a name="27802"/>27802:                            {ok, Port} = ?SEV_AWAIT_READY(Server, server, init),
<a name="27803"/>27803:                            {ok, State#{server_port =&gt; Port}}
<a name="27804"/>27804:                    end},
<a name="27805"/>27805:          #{desc =&gt; &quot;order server to continue (with accept)&quot;,
<a name="27806"/>27806:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="27807"/>27807:                            ?SEV_ANNOUNCE_CONTINUE(Server, accept_recv),
<a name="27808"/>27808:                            ok
<a name="27809"/>27809:                    end},
<a name="27810"/>27810: 
<a name="27811"/>27811:          %% *** Activate client ***
<a name="27812"/>27812:          #{desc =&gt; &quot;start client&quot;,
<a name="27813"/>27813:            cmd  =&gt; fun(#{client := Client, server_port := Port} = _State) -&gt;
<a name="27814"/>27814:                            ?SEV_ANNOUNCE_START(Client, Port),
<a name="27815"/>27815:                            ok
<a name="27816"/>27816:                    end},
<a name="27817"/>27817:          #{desc =&gt; &quot;await client ready (init)&quot;,
<a name="27818"/>27818:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="27819"/>27819:                            ?SEV_AWAIT_READY(Client, client, init)
<a name="27820"/>27820:                    end},
<a name="27821"/>27821: 
<a name="27822"/>27822:          %% *** The actual test ***
<a name="27823"/>27823:          #{desc =&gt; &quot;order client to continue (with connect)&quot;,
<a name="27824"/>27824:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="27825"/>27825:                            ?SEV_ANNOUNCE_CONTINUE(Client, connect),
<a name="27826"/>27826:                            ok
<a name="27827"/>27827:                    end},
<a name="27828"/>27828:          #{desc =&gt; &quot;await server ready (accept/recv)&quot;,
<a name="27829"/>27829:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="27830"/>27830:                            ?SEV_AWAIT_READY(Server, server, accept_recv)
<a name="27831"/>27831:                    end},
<a name="27832"/>27832: 
<a name="27833"/>27833:          %% *** Termination ***
<a name="27834"/>27834:          #{desc =&gt; &quot;order client to terminate&quot;,
<a name="27835"/>27835:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="27836"/>27836:                            ?SEV_ANNOUNCE_TERMINATE(Client),
<a name="27837"/>27837:                            ok
<a name="27838"/>27838:                    end},
<a name="27839"/>27839:          #{desc =&gt; &quot;await client termination&quot;,
<a name="27840"/>27840:            cmd  =&gt; fun(#{client := Client} = State) -&gt;
<a name="27841"/>27841:                            case ?SEV_AWAIT_TERMINATION(Client) of
<a name="27842"/>27842:                                ok -&gt;
<a name="27843"/>27843:                                    State1 = maps:remove(client, State),
<a name="27844"/>27844:                                    {ok, State1};
<a name="27845"/>27845:                                {error, _} = ERROR -&gt;
<a name="27846"/>27846:                                    ERROR
<a name="27847"/>27847:                            end
<a name="27848"/>27848:                    end},
<a name="27849"/>27849:          #{desc =&gt; &quot;order server to terminate&quot;,
<a name="27850"/>27850:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="27851"/>27851:                            ?SEV_ANNOUNCE_TERMINATE(Server),
<a name="27852"/>27852:                            ok
<a name="27853"/>27853:                    end},
<a name="27854"/>27854:          #{desc =&gt; &quot;await server termination&quot;,
<a name="27855"/>27855:            cmd  =&gt; fun(#{server := Server} = State) -&gt;
<a name="27856"/>27856:                            case ?SEV_AWAIT_TERMINATION(Server) of
<a name="27857"/>27857:                                ok -&gt;
<a name="27858"/>27858:                                    State1 = maps:remove(server, State),
<a name="27859"/>27859:                                    State2 = maps:remove(server_port, State1),
<a name="27860"/>27860:                                    {ok, State2};
<a name="27861"/>27861:                                {error, _} = ERROR -&gt;
<a name="27862"/>27862:                                    ERROR
<a name="27863"/>27863:                            end
<a name="27864"/>27864:                    end},
<a name="27865"/>27865: 
<a name="27866"/>27866:          %% *** We are done ***
<a name="27867"/>27867:          ?SEV_FINISH_NORMAL
<a name="27868"/>27868:         ],
<a name="27869"/>27869: 
<a name="27870"/>27870:     
<a name="27871"/>27871:     i(&quot;start server evaluator&quot;),
<a name="27872"/>27872:     ServerInitState = InitState,
<a name="27873"/>27873:     Server = ?SEV_START(&quot;server&quot;, ServerSeq, ServerInitState),
<a name="27874"/>27874: 
<a name="27875"/>27875:     i(&quot;start client evaluator&quot;),
<a name="27876"/>27876:     ClientInitState = InitState,
<a name="27877"/>27877:     Client = ?SEV_START(&quot;client&quot;, ClientSeq, ClientInitState),
<a name="27878"/>27878: 
<a name="27879"/>27879:     i(&quot;start tester evaluator&quot;),
<a name="27880"/>27880:     TesterInitState = #{server =&gt; Server#ev.pid, 
<a name="27881"/>27881:                         client =&gt; Client#ev.pid},
<a name="27882"/>27882:     Tester = ?SEV_START(&quot;tester&quot;, TesterSeq, TesterInitState),
<a name="27883"/>27883: 
<a name="27884"/>27884:     i(&quot;await evaluator(s)&quot;),
<a name="api_to_receive_tcp-last_expr"/><a name="27885"/>27885: <b>    ok = ?SEV_AWAIT_FINISH</b>([Server, Client, Tester]).
<a name="27886"/>27886: 
<a name="27887"/>27887: 
<a name="27888"/>27888: 
<a name="27889"/>27889: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="27890"/>27890: 
<a name="27891"/>27891: <i>%% This test case is intended to test the recvfrom timeout option</i>
<a name="27892"/>27892: <i>%% on an IPv4 UDP (dgram) socket.</i>
<a name="api_to_recvfrom_udp4-1"/><a name="27893"/>27893: <b>api_to_recvfrom_udp4</b>(_Config) when is_list(_Config) -&gt;
<a name="27894"/>27894:     ?TT(?SECS(10)),
<a name="api_to_recvfrom_udp4-last_expr"/><a name="27895"/>27895: <b>    tc_try</b>(api_to_recvfrom_udp4,
<a name="27896"/>27896:            fun() -&gt; has_support_ipv4() end,
<a name="27897"/>27897:            fun() -&gt;
<a name="27898"/>27898:                    Recv = fun(Sock, To) -&gt; socket:recvfrom(Sock, 0, To) end,
<a name="27899"/>27899:                    InitState = #{domain  =&gt; inet,
<a name="27900"/>27900:                                  recv    =&gt; Recv,
<a name="27901"/>27901:                                  timeout =&gt; 2000},
<a name="27902"/>27902:                    ok = api_to_receive_udp(InitState)
<a name="27903"/>27903:            end).
<a name="27904"/>27904: 
<a name="27905"/>27905: 
<a name="27906"/>27906: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="27907"/>27907: 
<a name="27908"/>27908: <i>%% This test case is intended to test the recvfrom timeout option</i>
<a name="27909"/>27909: <i>%% on an IPv6 UDP (dgram) socket.</i>
<a name="api_to_recvfrom_udp6-1"/><a name="27910"/>27910: <b>api_to_recvfrom_udp6</b>(_Config) when is_list(_Config) -&gt;
<a name="27911"/>27911:     ?TT(?SECS(10)),
<a name="api_to_recvfrom_udp6-last_expr"/><a name="27912"/>27912: <b>    tc_try</b>(api_to_recvfrom_udp6,
<a name="27913"/>27913:            fun() -&gt; has_support_ipv6() end,
<a name="27914"/>27914:            fun() -&gt;
<a name="27915"/>27915:                    Recv = fun(Sock, To) -&gt; socket:recvfrom(Sock, 0, To) end,
<a name="27916"/>27916:                    InitState = #{domain  =&gt; inet6,
<a name="27917"/>27917:                                  recv    =&gt; Recv,
<a name="27918"/>27918:                                  timeout =&gt; 2000},
<a name="27919"/>27919:                    ok = api_to_receive_udp(InitState)
<a name="27920"/>27920:            end).
<a name="27921"/>27921: 
<a name="27922"/>27922: 
<a name="27923"/>27923: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="27924"/>27924: 
<a name="api_to_receive_udp-1"/><a name="27925"/>27925: <b>api_to_receive_udp</b>(InitState) -&gt;
<a name="27926"/>27926:     TesterSeq =
<a name="27927"/>27927:         [
<a name="27928"/>27928:          %% *** Init part ***
<a name="27929"/>27929:          #{desc =&gt; &quot;which local address&quot;,
<a name="27930"/>27930:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="27931"/>27931:                            LSA = which_local_socket_addr(Domain),
<a name="27932"/>27932:                            {ok, State#{lsa =&gt; LSA}}
<a name="27933"/>27933:                    end},
<a name="27934"/>27934:          #{desc =&gt; &quot;create socket&quot;,
<a name="27935"/>27935:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="27936"/>27936:                            case socket:open(Domain, dgram, udp) of
<a name="27937"/>27937:                                {ok, Sock} -&gt;
<a name="27938"/>27938:                                    {ok, State#{sock =&gt; Sock}};
<a name="27939"/>27939:                                {error, _} = ERROR -&gt;
<a name="27940"/>27940:                                    ERROR
<a name="27941"/>27941:                            end
<a name="27942"/>27942:                    end},
<a name="27943"/>27943:          #{desc =&gt; &quot;bind to local address&quot;,
<a name="27944"/>27944:            cmd  =&gt; fun(#{sock := Sock, lsa := LSA} = _State) -&gt;
<a name="27945"/>27945:                            case sock_bind(Sock, LSA) of
<a name="27946"/>27946:                                ok -&gt;
<a name="27947"/>27947:                                    ok;
<a name="27948"/>27948:                                {error, _} = ERROR -&gt;
<a name="27949"/>27949:                                    ERROR
<a name="27950"/>27950:                            end
<a name="27951"/>27951:                    end},
<a name="27952"/>27952: 
<a name="27953"/>27953:          %% *** The actual test ***
<a name="27954"/>27954:          #{desc =&gt; &quot;attempt to read (without success)&quot;,
<a name="27955"/>27955:            cmd  =&gt; fun(#{sock := Sock, recv := Recv, timeout := To} = State) -&gt;
<a name="27956"/>27956:                            Start = t(),
<a name="27957"/>27957:                            case Recv(Sock, To) of
<a name="27958"/>27958:                                {error, timeout} -&gt;
<a name="27959"/>27959:                                    {ok, State#{start =&gt; Start,
<a name="27960"/>27960:                                                stop =&gt; t()}};
<a name="27961"/>27961:                                {ok, _} -&gt;
<a name="27962"/>27962:                                    {error, unexpected_sucsess};
<a name="27963"/>27963:                                {error, _} = ERROR -&gt;
<a name="27964"/>27964:                                    ERROR
<a name="27965"/>27965:                            end
<a name="27966"/>27966:                    end},
<a name="27967"/>27967:          #{desc =&gt; &quot;validate timeout time&quot;,
<a name="27968"/>27968:            cmd  =&gt; fun(#{start := Start, stop := Stop, timeout := To} = _State) -&gt;
<a name="27969"/>27969:                            TDiff  = Stop - Start,
<a name="27970"/>27970:                            if
<a name="27971"/>27971:                                (TDiff &gt;= To) -&gt;
<a name="27972"/>27972:                                    ok;
<a name="27973"/>27973:                                true -&gt;
<a name="27974"/>27974:                                    {error, {unexpected_timeout, TDiff, To}}
<a name="27975"/>27975:                            end
<a name="27976"/>27976:                    end},
<a name="27977"/>27977:          
<a name="27978"/>27978:          %% *** Termination ***
<a name="27979"/>27979:          #{desc =&gt; &quot;close socket&quot;,
<a name="27980"/>27980:            cmd  =&gt; fun(#{sock := Sock} = _State) -&gt;
<a name="27981"/>27981:                            %% socket:setopt(Sock, otp, debug, true),
<a name="27982"/>27982:                            sock_close(Sock),
<a name="27983"/>27983:                            ok
<a name="27984"/>27984:                    end},
<a name="27985"/>27985: 
<a name="27986"/>27986:          %% *** We are done ***
<a name="27987"/>27987:          ?SEV_FINISH_NORMAL
<a name="27988"/>27988:         ],
<a name="27989"/>27989: 
<a name="27990"/>27990:     i(&quot;start tester evaluator&quot;),
<a name="27991"/>27991:     Tester = ?SEV_START(&quot;tester&quot;, TesterSeq, InitState),
<a name="27992"/>27992:     
<a name="27993"/>27993:     i(&quot;await evaluator&quot;),
<a name="api_to_receive_udp-last_expr"/><a name="27994"/>27994: <b>    ok = ?SEV_AWAIT_FINISH</b>([Tester]).
<a name="27995"/>27995: 
<a name="27996"/>27996: 
<a name="27997"/>27997: 
<a name="27998"/>27998: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="27999"/>27999: 
<a name="28000"/>28000: <i>%% This test case is intended to test the recvmsg timeout option</i>
<a name="28001"/>28001: <i>%% on an IPv4 UDP (dgram) socket.</i>
<a name="api_to_recvmsg_udp4-1"/><a name="28002"/>28002: <b>api_to_recvmsg_udp4</b>(_Config) when is_list(_Config) -&gt;
<a name="28003"/>28003:     ?TT(?SECS(10)),
<a name="api_to_recvmsg_udp4-last_expr"/><a name="28004"/>28004: <b>    tc_try</b>(api_to_recvmsg_udp4,
<a name="28005"/>28005:            fun() -&gt; has_support_ipv4() end,
<a name="28006"/>28006:            fun() -&gt;
<a name="28007"/>28007:                    Recv = fun(Sock, To) -&gt; socket:recvmsg(Sock, To) end,
<a name="28008"/>28008:                    InitState = #{domain  =&gt; inet,
<a name="28009"/>28009:                                  recv    =&gt; Recv,
<a name="28010"/>28010:                                  timeout =&gt; 2000},
<a name="28011"/>28011:                    ok = api_to_receive_udp(InitState)
<a name="28012"/>28012:            end).
<a name="28013"/>28013: 
<a name="28014"/>28014: 
<a name="28015"/>28015: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="28016"/>28016: 
<a name="28017"/>28017: <i>%% This test case is intended to test the recvmsg timeout option</i>
<a name="28018"/>28018: <i>%% on an IPv6 UDP (dgram) socket.</i>
<a name="api_to_recvmsg_udp6-1"/><a name="28019"/>28019: <b>api_to_recvmsg_udp6</b>(_Config) when is_list(_Config) -&gt;
<a name="28020"/>28020:     ?TT(?SECS(10)),
<a name="api_to_recvmsg_udp6-last_expr"/><a name="28021"/>28021: <b>    tc_try</b>(api_to_recvmsg_udp6,
<a name="28022"/>28022:            fun() -&gt; has_support_ipv6() end,
<a name="28023"/>28023:            fun() -&gt;
<a name="28024"/>28024:                    Recv = fun(Sock, To) -&gt; socket:recvmsg(Sock, To) end,
<a name="28025"/>28025:                    InitState = #{domain  =&gt; inet6,
<a name="28026"/>28026:                                  recv    =&gt; Recv,
<a name="28027"/>28027:                                  timeout =&gt; 2000},
<a name="28028"/>28028:                    ok = api_to_receive_udp(InitState)
<a name="28029"/>28029:            end).
<a name="28030"/>28030: 
<a name="28031"/>28031: 
<a name="28032"/>28032: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="28033"/>28033: 
<a name="28034"/>28034: <i>%% This test case is intended to test the recvmsg timeout option</i>
<a name="28035"/>28035: <i>%% on an IPv4 TCP (stream) socket.</i>
<a name="api_to_recvmsg_tcp4-1"/><a name="28036"/>28036: <b>api_to_recvmsg_tcp4</b>(_Config) when is_list(_Config) -&gt;
<a name="28037"/>28037:     ?TT(?SECS(10)),
<a name="api_to_recvmsg_tcp4-last_expr"/><a name="28038"/>28038: <b>    tc_try</b>(api_to_recvmsg_tcp4,
<a name="28039"/>28039:            fun() -&gt; has_support_ipv4() end,
<a name="28040"/>28040:            fun() -&gt;
<a name="28041"/>28041:                    Recv = fun(Sock, To) -&gt; socket:recvmsg(Sock, To) end,
<a name="28042"/>28042:                    InitState = #{domain  =&gt; inet,
<a name="28043"/>28043:                                  recv    =&gt; Recv,
<a name="28044"/>28044:                                  timeout =&gt; 2000},
<a name="28045"/>28045:                    ok = api_to_receive_tcp(InitState)
<a name="28046"/>28046:            end).
<a name="28047"/>28047: 
<a name="28048"/>28048: 
<a name="28049"/>28049: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="28050"/>28050: 
<a name="28051"/>28051: <i>%% This test case is intended to test the recvmsg timeout option</i>
<a name="28052"/>28052: <i>%% on an IPv6 TCP (stream) socket.</i>
<a name="api_to_recvmsg_tcp6-1"/><a name="28053"/>28053: <b>api_to_recvmsg_tcp6</b>(_Config) when is_list(_Config) -&gt;
<a name="28054"/>28054:     ?TT(?SECS(10)),
<a name="api_to_recvmsg_tcp6-last_expr"/><a name="28055"/>28055: <b>    tc_try</b>(api_to_recvmsg_tcp6,
<a name="28056"/>28056:            fun() -&gt; has_support_ipv6() end,
<a name="28057"/>28057:            fun() -&gt;
<a name="28058"/>28058:                    Recv = fun(Sock, To) -&gt; socket:recvmsg(Sock, To) end,
<a name="28059"/>28059:                    InitState = #{domain  =&gt; inet6,
<a name="28060"/>28060:                                  recv    =&gt; Recv,
<a name="28061"/>28061:                                  timeout =&gt; 2000},
<a name="28062"/>28062:                    ok = api_to_receive_tcp(InitState)
<a name="28063"/>28063:            end).
<a name="28064"/>28064: 
<a name="28065"/>28065: 
<a name="28066"/>28066: 
<a name="28067"/>28067: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="28068"/>28068: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="28069"/>28069: <i>%%                                                                     %%</i>
<a name="28070"/>28070: <i>%%                             REGISTRY                                %%</i>
<a name="28071"/>28071: <i>%%                                                                     %%</i>
<a name="28072"/>28072: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="28073"/>28073: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="28074"/>28074: 
<a name="28075"/>28075: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="28076"/>28076: <i>%% We create a bunch of different sockets and ensure that the registry</i>
<a name="28077"/>28077: <i>%% has the correct info.</i>
<a name="28078"/>28078: 
<a name="reg_s_single_open_and_close_and_count-1"/><a name="28079"/>28079: <b>reg_s_single_open_and_close_and_count</b>(_Config) when is_list(_Config) -&gt;
<a name="28080"/>28080:     ?TT(?SECS(10)),
<a name="reg_s_single_open_and_close_and_count-last_expr"/><a name="28081"/>28081: <b>    tc_try</b>(reg_s_single_open_and_close_and_count,
<a name="28082"/>28082:            fun() -&gt;
<a name="28083"/>28083:                    ok = reg_s_single_open_and_close_and_count()
<a name="28084"/>28084:            end).
<a name="28085"/>28085: 
<a name="28086"/>28086: 
<a name="reg_s_single_open_and_close_and_count-0"/><a name="28087"/>28087: <b>reg_s_single_open_and_close_and_count</b>() -&gt;
<a name="28088"/>28088:     socket:use_registry(true),
<a name="28089"/>28089: 
<a name="28090"/>28090:     {OS, _} = os:type(),
<a name="28091"/>28091: 
<a name="28092"/>28092:     %% We may have some sockets already existing.
<a name="28093"/>28093:     %% Make sure we dont count them when we test.
<a name="28094"/>28094:     Existing = socket:which_sockets(),
<a name="28095"/>28095:     N = length(Existing),
<a name="28096"/>28096:     SupportsIPV6 =
<a name="28097"/>28097:         case (catch has_support_ipv6()) of
<a name="28098"/>28098:             ok -&gt;
<a name="28099"/>28099:                 true;
<a name="28100"/>28100:             _ -&gt;
<a name="28101"/>28101:                 false
<a name="28102"/>28102:         end,
<a name="28103"/>28103:     SupportsLOCAL =
<a name="28104"/>28104:         case (catch has_support_unix_domain_socket()) of
<a name="28105"/>28105:             ok -&gt;
<a name="28106"/>28106:                 true;
<a name="28107"/>28107:             _ -&gt;
<a name="28108"/>28108:                 false
<a name="28109"/>28109:         end,
<a name="28110"/>28110:     SupportsSCTP =
<a name="28111"/>28111:         case (catch has_support_sctp()) of
<a name="28112"/>28112:             ok -&gt;
<a name="28113"/>28113:                 true;
<a name="28114"/>28114:             _ -&gt;
<a name="28115"/>28115:                 false
<a name="28116"/>28116:         end,
<a name="28117"/>28117:     InitSockInfos =
<a name="28118"/>28118:         [
<a name="28119"/>28119:          {inet, stream, tcp},
<a name="28120"/>28120:          {inet, dgram,  udp}
<a name="28121"/>28121:         ] ++
<a name="28122"/>28122:         case SupportsIPV6 of
<a name="28123"/>28123:             true -&gt;
<a name="28124"/>28124:                 [
<a name="28125"/>28125:                  {inet6, stream, tcp},
<a name="28126"/>28126:                  {inet6, dgram,  udp}
<a name="28127"/>28127:                 ];
<a name="28128"/>28128:             false -&gt;
<a name="28129"/>28129:                 []
<a name="28130"/>28130:         end ++
<a name="28131"/>28131:         case SupportsLOCAL of
<a name="28132"/>28132:             true when (OS =/= win32) -&gt;
<a name="28133"/>28133:                 [
<a name="28134"/>28134:                  {local, stream, default},
<a name="28135"/>28135:                  {local, dgram,  default}
<a name="28136"/>28136:                 ];
<a name="28137"/>28137:             true -&gt;
<a name="28138"/>28138:                 [
<a name="28139"/>28139:                  {local, stream, default}
<a name="28140"/>28140:                 ];
<a name="28141"/>28141:             false -&gt;
<a name="28142"/>28142:                 []
<a name="28143"/>28143:         end ++
<a name="28144"/>28144:         [
<a name="28145"/>28145:          {inet, stream, tcp},
<a name="28146"/>28146:          {inet, dgram,  udp}
<a name="28147"/>28147:         ] ++
<a name="28148"/>28148:         case SupportsSCTP of
<a name="28149"/>28149:             true -&gt;
<a name="28150"/>28150:                 %% On some platforms this is not enough,
<a name="28151"/>28151:                 %% we need to actually check this &quot;by doing it&quot;...
<a name="28152"/>28152:                 ?P(&quot;test open sctp socket&quot;),
<a name="28153"/>28153:                 case socket:open(inet,
<a name="28154"/>28154:                                  seqpacket,
<a name="28155"/>28155:                                  sctp,
<a name="28156"/>28156:                                  #{use_registry =&gt; false}) of
<a name="28157"/>28157:                     {ok, S} -&gt;
<a name="28158"/>28158:                         ?P(&quot;test open sctp socket: success&quot;),
<a name="28159"/>28159:                         (catch socket:close(S)),
<a name="28160"/>28160:                         [
<a name="28161"/>28161:                          {inet, seqpacket, sctp},
<a name="28162"/>28162:                          {inet, seqpacket, sctp}
<a name="28163"/>28163:                         ];
<a name="28164"/>28164:                     {error, _} -&gt;
<a name="28165"/>28165:                         ?P(&quot;test open sctp socket: failed&quot;),
<a name="28166"/>28166:                         []
<a name="28167"/>28167:                 end;
<a name="28168"/>28168:             false -&gt;
<a name="28169"/>28169:                 []
<a name="28170"/>28170:         end ++
<a name="28171"/>28171:         [
<a name="28172"/>28172:          {inet, stream, tcp},
<a name="28173"/>28173:          {inet, dgram,  udp}
<a name="28174"/>28174:         ] ++
<a name="28175"/>28175:         case SupportsSCTP andalso SupportsIPV6 of
<a name="28176"/>28176:             true -&gt;
<a name="28177"/>28177:                 %% On some platforms this is not enough,
<a name="28178"/>28178:                 %% we need to actually check this &quot;by doing it&quot;...
<a name="28179"/>28179:                 ?P(&quot;test open sctp socket&quot;),
<a name="28180"/>28180:                 case socket:open(inet6,
<a name="28181"/>28181:                                  seqpacket,
<a name="28182"/>28182:                                  sctp,
<a name="28183"/>28183:                                  #{use_registry =&gt; false}) of
<a name="28184"/>28184:                     {ok, S6} -&gt;
<a name="28185"/>28185:                         ?P(&quot;test open sctp socket: success&quot;),
<a name="28186"/>28186:                         (catch socket:close(S6)),
<a name="28187"/>28187:                         [
<a name="28188"/>28188:                          {inet6, seqpacket, sctp},
<a name="28189"/>28189:                          {inet6, seqpacket, sctp}
<a name="28190"/>28190:                         ];
<a name="28191"/>28191:                     {error, _} -&gt;
<a name="28192"/>28192:                         ?P(&quot;test open sctp socket: failed&quot;),
<a name="28193"/>28193:                         []
<a name="28194"/>28194:                 end;
<a name="28195"/>28195:             false -&gt;
<a name="28196"/>28196:                 []
<a name="28197"/>28197:         end,
<a name="28198"/>28198: 
<a name="28199"/>28199:     i(&quot;open sockets&quot;),
<a name="28200"/>28200:     Socks =
<a name="28201"/>28201:         [fun({Domain, Type, Proto}) -&gt;
<a name="28202"/>28202:                  i(&quot;open socket: ~w, ~w, ~w&quot;, [Domain, Type, Proto]),
<a name="28203"/>28203:                  {ok, Sock} = socket:open(Domain, Type, Proto),
<a name="28204"/>28204:                  Sock
<a name="28205"/>28205:          end(InitSockInfo) || InitSockInfo &lt;- InitSockInfos],
<a name="28206"/>28206: 
<a name="28207"/>28207:     ?SLEEP(1000),
<a name="28208"/>28208: 
<a name="28209"/>28209: 
<a name="28210"/>28210:     %% **** Total Number Of Sockets ****
<a name="28211"/>28211: 
<a name="28212"/>28212:     NumSocks1 = N + length(Socks),
<a name="28213"/>28213:     NumberOf1 = socket:number_of(),
<a name="28214"/>28214: 
<a name="28215"/>28215:     i(&quot;verify (total) number of sockets(1): ~w, ~w&quot;,
<a name="28216"/>28216:       [NumSocks1, NumberOf1]),
<a name="28217"/>28217:     case (NumSocks1 =:= NumberOf1) of
<a name="28218"/>28218:         true -&gt;
<a name="28219"/>28219:             ok;
<a name="28220"/>28220:         false -&gt;
<a name="28221"/>28221:             reg_si_fail(wrong_number_of_sockets1, {NumSocks1, NumberOf1})
<a name="28222"/>28222:     end,
<a name="28223"/>28223: 
<a name="28224"/>28224: 
<a name="28225"/>28225:     %% **** Number Of IPv4 TCP Sockets ****
<a name="28226"/>28226: 
<a name="28227"/>28227:     %% inet, stream, tcp
<a name="28228"/>28228:     SiNumTCP = reg_si_num(InitSockInfos, inet, stream, tcp),
<a name="28229"/>28229:     SrNumTCP = reg_sr_num(Existing, inet, stream, tcp),
<a name="28230"/>28230: 
<a name="28231"/>28231:     i(&quot;verify number of IPv4 TCP sockets: ~w, ~w&quot;, [SiNumTCP, SrNumTCP]),
<a name="28232"/>28232:     case (SiNumTCP =:= SrNumTCP) of
<a name="28233"/>28233:         true -&gt;
<a name="28234"/>28234:             ok;
<a name="28235"/>28235:         false -&gt;
<a name="28236"/>28236:             reg_si_fail(wrong_number_of_ipv4_tcp_sockets, {SiNumTCP, SrNumTCP})
<a name="28237"/>28237:     end,
<a name="28238"/>28238: 
<a name="28239"/>28239: 
<a name="28240"/>28240:     %% **** Number Of IPv4 UDP Sockets ****
<a name="28241"/>28241: 
<a name="28242"/>28242:     %% inet, dgram, udp
<a name="28243"/>28243:     SiNumUDP = reg_si_num(InitSockInfos, inet, dgram, udp),
<a name="28244"/>28244:     SrNumUDP = reg_sr_num(Existing, inet, dgram, udp),
<a name="28245"/>28245: 
<a name="28246"/>28246:     i(&quot;verify number of IPv4 UDP sockets: ~w, ~w&quot;, [SiNumUDP, SrNumUDP]),
<a name="28247"/>28247:     case (SiNumUDP =:= SrNumUDP) of
<a name="28248"/>28248:         true -&gt;
<a name="28249"/>28249:             ok;
<a name="28250"/>28250:         false -&gt;
<a name="28251"/>28251:             exit({wrong_number_of_ipv4_udp_sockets, SiNumUDP, SrNumUDP})
<a name="28252"/>28252:     end,
<a name="28253"/>28253: 
<a name="28254"/>28254: 
<a name="28255"/>28255:     %% **** Number Of IPv4 SCTP Sockets ****
<a name="28256"/>28256: 
<a name="28257"/>28257:     %% inet, seqpacket, sctp
<a name="28258"/>28258:     SiNumSCTP = reg_si_num(InitSockInfos, inet, seqpacket, sctp),
<a name="28259"/>28259:     SrNumSCTP = reg_sr_num(Existing, inet, seqpacket, sctp),
<a name="28260"/>28260: 
<a name="28261"/>28261:     i(&quot;verify number of IPv4 SCTP sockets: ~w, ~w&quot;, [SiNumSCTP, SrNumSCTP]),
<a name="28262"/>28262:     case (SiNumSCTP =:= SrNumSCTP) of
<a name="28263"/>28263:         true -&gt;
<a name="28264"/>28264:             ok;
<a name="28265"/>28265:         false -&gt;
<a name="28266"/>28266:             reg_si_fail(wrong_number_of_sctp_sockets, {SiNumSCTP, SrNumSCTP})
<a name="28267"/>28267:     end,
<a name="28268"/>28268: 
<a name="28269"/>28269: 
<a name="28270"/>28270:     %% **** Number Of IPv4 Sockets ****
<a name="28271"/>28271: 
<a name="28272"/>28272:     %% inet
<a name="28273"/>28273:     SiNumINET = reg_si_num(InitSockInfos, inet),
<a name="28274"/>28274:     SrNumINET = reg_sr_num(Existing, inet),
<a name="28275"/>28275: 
<a name="28276"/>28276:     i(&quot;verify number of IPv4 sockets: ~w, ~w&quot;, [SiNumINET, SrNumINET]),
<a name="28277"/>28277:     case (SiNumINET =:= SrNumINET) of
<a name="28278"/>28278:         true -&gt;
<a name="28279"/>28279:             ok;
<a name="28280"/>28280:         false -&gt;
<a name="28281"/>28281:             reg_si_fail(wrong_number_of_ipv4_sockets, {SiNumINET, SrNumINET})
<a name="28282"/>28282:     end,
<a name="28283"/>28283: 
<a name="28284"/>28284: 
<a name="28285"/>28285:     %% **** Number Of IPv6 Sockets ****
<a name="28286"/>28286: 
<a name="28287"/>28287:     %% inet6
<a name="28288"/>28288:     SiNumINET6 = reg_si_num(InitSockInfos, inet6),
<a name="28289"/>28289:     SrNumINET6 = reg_sr_num(Existing, inet6),
<a name="28290"/>28290: 
<a name="28291"/>28291:     i(&quot;verify number of IPv6 sockets: ~w, ~w&quot;, [SiNumINET6, SrNumINET6]),
<a name="28292"/>28292:     case (SiNumINET6 =:= SrNumINET6) of
<a name="28293"/>28293:         true -&gt;
<a name="28294"/>28294:             ok;
<a name="28295"/>28295:         false -&gt;
<a name="28296"/>28296:             reg_si_fail(wrong_number_of_ipv6_sockets, {SiNumINET6, SrNumINET6})
<a name="28297"/>28297:     end,
<a name="28298"/>28298: 
<a name="28299"/>28299: 
<a name="28300"/>28300:     %% **** Number Of Unix Domain Sockets Sockets ****
<a name="28301"/>28301: 
<a name="28302"/>28302:     %% local
<a name="28303"/>28303:     SiNumLOCAL = reg_si_num(InitSockInfos, local),
<a name="28304"/>28304:     SrNumLOCAL = reg_sr_num(Existing, local),
<a name="28305"/>28305: 
<a name="28306"/>28306:     i(&quot;verify number of Unix Domain Sockets sockets: ~w, ~w&quot;,
<a name="28307"/>28307:       [SiNumLOCAL, SrNumLOCAL]),
<a name="28308"/>28308:     case (SiNumLOCAL =:= SrNumLOCAL) of
<a name="28309"/>28309:         true -&gt;
<a name="28310"/>28310:             ok;
<a name="28311"/>28311:         false -&gt;
<a name="28312"/>28312:             reg_si_fail(wrong_number_of_local_sockets, {SiNumLOCAL, SrNumLOCAL})
<a name="28313"/>28313:     end,
<a name="28314"/>28314: 
<a name="28315"/>28315: 
<a name="28316"/>28316:     %% **** Close *all* Sockets then verify Number Of Sockets ****
<a name="28317"/>28317: 
<a name="28318"/>28318:     i(&quot;close sockets&quot;),
<a name="28319"/>28319:     lists:foreach(fun(S) -&gt;
<a name="28320"/>28320:                           i(&quot;close socket&quot;),                          
<a name="28321"/>28321:                           ok = socket:close(S)
<a name="28322"/>28322:                   end, Socks),
<a name="28323"/>28323: 
<a name="28324"/>28324:     ?SLEEP(1000),
<a name="28325"/>28325: 
<a name="28326"/>28326:     NumberOf2 = socket:number_of(),
<a name="28327"/>28327: 
<a name="28328"/>28328:     i(&quot;verify number of sockets(2): ~w, ~w&quot;, [N, NumberOf2]),
<a name="28329"/>28329:     case (N =:= NumberOf2) of
<a name="28330"/>28330:         true -&gt;
<a name="28331"/>28331:             ok;
<a name="28332"/>28332:         false -&gt;
<a name="28333"/>28333:             reg_si_fail(wrong_number_of_sockets2, {N, NumberOf2})
<a name="28334"/>28334:     end,
<a name="28335"/>28335: 
<a name="28336"/>28336: 
<a name="28337"/>28337:     i(&quot;verify owner sockets (none)&quot;, []),
<a name="28338"/>28338:     Expected1 = [],
<a name="28339"/>28339:     case socket:which_sockets(self()) of
<a name="28340"/>28340:         Expected1 -&gt;
<a name="28341"/>28341:             ok;
<a name="28342"/>28342:         Unexpected1 -&gt;
<a name="28343"/>28343:             reg_si_fail(wrong_sockets_own1, {Expected1, Unexpected1})
<a name="28344"/>28344:     end,
<a name="28345"/>28345: 
<a name="28346"/>28346:     i(&quot;create some sockets&quot;, []),
<a name="28347"/>28347:     OwnSockets = lists:sort(
<a name="28348"/>28348:                    [fun({D, T})-&gt;
<a name="28349"/>28349:                             i(&quot;create ~w:~w socket&quot;, [D, T]),
<a name="28350"/>28350:                             {ok, OSocks} = socket:open(D, T, default),
<a name="28351"/>28351:                             OSocks
<a name="28352"/>28352:                     end(SockInfo) || SockInfo &lt;-
<a name="28353"/>28353:                                          [{inet, dgram},
<a name="28354"/>28354:                                           {inet, dgram},
<a name="28355"/>28355:                                           {inet, stream},
<a name="28356"/>28356:                                           {inet, stream}]]),
<a name="28357"/>28357: 
<a name="28358"/>28358:     i(&quot;verify owner sockets (~w)&quot;, [length(OwnSockets)]),
<a name="28359"/>28359:     case lists:sort(socket:which_sockets(self())) of
<a name="28360"/>28360:         OwnSockets -&gt;
<a name="28361"/>28361:             ok;
<a name="28362"/>28362:         Unexpected2 -&gt;
<a name="28363"/>28363:             reg_si_fail(wrong_sockets_own2, {OwnSockets, Unexpected2})
<a name="28364"/>28364:     end,
<a name="28365"/>28365: 
<a name="28366"/>28366:     i(&quot;close (own) sockets&quot;),
<a name="28367"/>28367:     lists:foreach(fun(S) -&gt;
<a name="28368"/>28368:                           i(&quot;close socket&quot;),                          
<a name="28369"/>28369:                           ok = socket:close(S)
<a name="28370"/>28370:                   end, OwnSockets),
<a name="28371"/>28371:     ?SLEEP(1000),
<a name="28372"/>28372: 
<a name="28373"/>28373:     i(&quot;verify number of sockets(2) (again)&quot;),
<a name="28374"/>28374:     NumberOf2 = socket:number_of(),
<a name="28375"/>28375: 
<a name="28376"/>28376:     i(&quot;verify pre-existing sockets(2)&quot;, []),
<a name="28377"/>28377:     case socket:which_sockets() of
<a name="28378"/>28378:         Existing -&gt;
<a name="28379"/>28379:             ok;
<a name="28380"/>28380:         OtherSockets -&gt;
<a name="28381"/>28381:             reg_si_fail(wrong_sockets2, {Existing, OtherSockets})
<a name="28382"/>28382:     end,
<a name="28383"/>28383: 
<a name="28384"/>28384:     socket:use_registry(false),
<a name="reg_s_single_open_and_close_and_count-last_expr"/><a name="28385"/>28385:     ok.
<a name="28386"/>28386: 
<a name="28387"/>28387: 
<a name="reg_si_fail-2"/><a name="28388"/>28388: <b>reg_si_fail</b>(Reason, Extra) -&gt;
<a name="28389"/>28389:     socket:use_registry(false),
<a name="reg_si_fail-last_expr"/><a name="28390"/>28390: <b>    exit</b>({Reason, Extra}).
<a name="28391"/>28391: 
<a name="reg_si_num-2"/><a name="28392"/>28392: <b>reg_si_num</b>(SocksInfo, Domain)
<a name="28393"/>28393:   when ((Domain =:= inet) orelse (Domain =:= inet6) orelse (Domain =:= local)) -&gt;
<a name="28394"/>28394:     reg_si_num(SocksInfo, Domain, undefined, undefined);
<a name="28395"/>28395: <b>reg_si_num</b>(SocksInfo, Type)
<a name="28396"/>28396:   when ((Type =:= stream) orelse (Type =:= dgram) orelse (Type =:= seqpacket)) -&gt;
<a name="28397"/>28397:     reg_si_num(SocksInfo, undefined, Type, undefined);
<a name="28398"/>28398: <b>reg_si_num</b>(SocksInfo, Proto)
<a name="28399"/>28399:   when ((Proto =:= sctp) orelse (Proto =:= tcp) orelse (Proto =:= udp)) -&gt;
<a name="reg_si_num-last_expr"/><a name="28400"/>28400: <b>    reg_si_num</b>(SocksInfo, undefined, undefined, Proto).
<a name="28401"/>28401: 
<a name="reg_si_num-4"/><a name="28402"/>28402: <b>reg_si_num</b>(SocksInfo, Domain, undefined, undefined) -&gt;
<a name="28403"/>28403:     F = fun({D, _T, _P}) when (D =:= Domain) -&gt; true;
<a name="28404"/>28404:            (_) -&gt; false
<a name="28405"/>28405:         end,
<a name="28406"/>28406:     reg_si_num2(F, SocksInfo);
<a name="28407"/>28407: <b>reg_si_num</b>(SocksInfo, undefined, Type, undefined) -&gt;
<a name="28408"/>28408:     F = fun({_D, T, _P}) when (T =:= Type) -&gt; true;
<a name="28409"/>28409:            (_) -&gt; false
<a name="28410"/>28410:         end,
<a name="28411"/>28411:     reg_si_num2(F, SocksInfo);
<a name="28412"/>28412: <b>reg_si_num</b>(SocksInfo, undefined, undefined, Proto) -&gt;
<a name="28413"/>28413:     F = fun({_D, _T, P}) when (P =:= Proto) -&gt; true;
<a name="28414"/>28414:            (_) -&gt; false
<a name="28415"/>28415:         end,
<a name="28416"/>28416:     reg_si_num2(F, SocksInfo);
<a name="28417"/>28417: <b>reg_si_num</b>(SocksInfo, Domain, Type, Proto) -&gt;
<a name="28418"/>28418:     F = fun({D, T, P}) when (D =:= Domain) andalso
<a name="28419"/>28419:                             (T =:= Type) andalso
<a name="28420"/>28420:                             (P =:= Proto) -&gt;
<a name="28421"/>28421:                 true;
<a name="28422"/>28422:            (_) -&gt;
<a name="28423"/>28423:                 false
<a name="28424"/>28424:         end,
<a name="reg_si_num-last_expr"/><a name="28425"/>28425: <b>    reg_si_num2</b>(F, SocksInfo).
<a name="28426"/>28426: 
<a name="reg_si_num2-2"/><a name="28427"/>28427: <b>reg_si_num2</b>(F, SocksInfo) -&gt;
<a name="reg_si_num2-last_expr"/><a name="28428"/>28428: <b>    length</b>(lists:filter(F, SocksInfo)).
<a name="28429"/>28429: 
<a name="28430"/>28430: 
<a name="reg_sr_num-2"/><a name="28431"/>28431: <b>reg_sr_num</b>(Existing, Domain)
<a name="28432"/>28432:   when ((Domain =:= inet) orelse (Domain =:= inet6)) -&gt;
<a name="28433"/>28433:     length(socket:which_sockets(Domain) -- Existing);
<a name="28434"/>28434: <b>reg_sr_num</b>(Existing, Domain)
<a name="28435"/>28435:   when (Domain =:= local) -&gt;
<a name="28436"/>28436:     reg_sr_num(Existing, Domain, undefined, undefined);
<a name="28437"/>28437: <b>reg_sr_num</b>(Existing, Type)
<a name="28438"/>28438:   when ((Type =:= stream) orelse (Type =:= dgram) orelse (Type =:= seqpacket)) -&gt;
<a name="28439"/>28439:     length(socket:which_sockets(Type) -- Existing);
<a name="28440"/>28440: <b>reg_sr_num</b>(Existing, Proto)
<a name="28441"/>28441:   when ((Proto =:= sctp) orelse (Proto =:= tcp) orelse (Proto =:= udp)) -&gt;
<a name="reg_sr_num-last_expr"/><a name="28442"/>28442: <b>    length</b>(socket:which_sockets(Proto) -- Existing).
<a name="28443"/>28443: 
<a name="reg_sr_num-4"/><a name="28444"/>28444: <b>reg_sr_num</b>(Existing, Domain, undefined, undefined) -&gt;
<a name="28445"/>28445:     F = fun(#{domain := D}) when (D =:= Domain) -&gt;
<a name="28446"/>28446:                 true;
<a name="28447"/>28447:            (_X) -&gt;
<a name="28448"/>28448:                 false
<a name="28449"/>28449:         end,
<a name="28450"/>28450:     reg_sr_num2(Existing, F);
<a name="28451"/>28451: <b>reg_sr_num</b>(Existing, Domain, Type, Proto) -&gt;
<a name="28452"/>28452:     F = fun(#{domain   := D,
<a name="28453"/>28453:               type     := T,
<a name="28454"/>28454:               protocol := P}) when (D =:= Domain) andalso
<a name="28455"/>28455:                                    (T =:= Type) andalso
<a name="28456"/>28456:                                    (P =:= Proto) -&gt;
<a name="28457"/>28457:                 true;
<a name="28458"/>28458:            (_X) -&gt;
<a name="28459"/>28459:                 %% i(&quot;reg_sr_num -&gt; not counting: &quot;
<a name="28460"/>28460:                 %%   &quot;~n   ~p&quot;, [_X]),
<a name="28461"/>28461:                 false
<a name="28462"/>28462:         end,
<a name="reg_sr_num-last_expr"/><a name="28463"/>28463: <b>    reg_sr_num2</b>(Existing, F).
<a name="28464"/>28464: 
<a name="reg_sr_num2-2"/><a name="28465"/>28465: <b>reg_sr_num2</b>(Existing, F) -&gt;
<a name="reg_sr_num2-last_expr"/><a name="28466"/>28466: <b>    length</b>(socket:which_sockets(F) -- Existing).
<a name="28467"/>28467: 
<a name="28468"/>28468: 
<a name="28469"/>28469: 
<a name="28470"/>28470: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="28471"/>28471: <i>%% We create a bunch of different sockets and ensure that the registry</i>
<a name="28472"/>28472: <i>%% has the correct info.</i>
<a name="28473"/>28473: 
<a name="reg_s_optional_open_and_close_and_count-1"/><a name="28474"/>28474: <b>reg_s_optional_open_and_close_and_count</b>(_Config) when is_list(_Config) -&gt;
<a name="28475"/>28475:     ?TT(?SECS(10)),
<a name="reg_s_optional_open_and_close_and_count-last_expr"/><a name="28476"/>28476: <b>    tc_try</b>(reg_s_optional_open_and_close_and_count,
<a name="28477"/>28477:            fun() -&gt;
<a name="28478"/>28478:                    ok = reg_s_optional_open_and_close_and_count()
<a name="28479"/>28479:            end).
<a name="28480"/>28480: 
<a name="28481"/>28481: 
<a name="reg_s_optional_open_and_close_and_count-0"/><a name="28482"/>28482: <b>reg_s_optional_open_and_close_and_count</b>() -&gt;
<a name="28483"/>28483:     i(&quot;Make sure use of socket registry is enabled (regardless of default)&quot;),
<a name="28484"/>28484:     socket:use_registry(true),
<a name="28485"/>28485:     #{use_registry := true} = socket:info(),
<a name="28486"/>28486: 
<a name="28487"/>28487:     i(&quot;get current socket base count&quot;),
<a name="28488"/>28488:     Base = socket:number_of(),
<a name="28489"/>28489: 
<a name="28490"/>28490:     i(&quot;create a socket and ensure its counted&quot;),
<a name="28491"/>28491:     {ok, S1} = socket:open(inet, dgram, udp),
<a name="28492"/>28492:     Base1 = Base + 1,
<a name="28493"/>28493:     case socket:number_of() of
<a name="28494"/>28494:         Base1 -&gt;
<a name="28495"/>28495:             ok;
<a name="28496"/>28496:         Invalid1 -&gt; 
<a name="28497"/>28497:             exit({wrong_number_of_sockets1, Invalid1, Base + 1})
<a name="28498"/>28498:     end,
<a name="28499"/>28499:     i(&quot;close the socket and ensure its counted (back to base)&quot;),
<a name="28500"/>28500:     ok = socket:close(S1),
<a name="28501"/>28501:     case socket:number_of() of
<a name="28502"/>28502:         Base -&gt;
<a name="28503"/>28503:             ok;
<a name="28504"/>28504:         Invalid2 -&gt; 
<a name="28505"/>28505:             exit({wrong_number_of_sockets2, Invalid2, Base})
<a name="28506"/>28506:     end,
<a name="28507"/>28507: 
<a name="28508"/>28508:     i(&quot;create a socket with use_registry explicitly off &quot;
<a name="28509"/>28509:       &quot;and ensure its not counted&quot;),
<a name="28510"/>28510:     {ok, S2} = socket:open(inet, dgram, udp, #{use_registry =&gt; false}),
<a name="28511"/>28511:     case socket:number_of() of
<a name="28512"/>28512:         Base -&gt;
<a name="28513"/>28513:             ok;
<a name="28514"/>28514:         Invalid3 -&gt; 
<a name="28515"/>28515:             exit({wrong_number_of_sockets3, Invalid3, Base})
<a name="28516"/>28516:     end,
<a name="28517"/>28517:     i(&quot;close the socket and ensure its not counted&quot;),
<a name="28518"/>28518:     ok = socket:close(S2),
<a name="28519"/>28519:     case socket:number_of() of
<a name="28520"/>28520:         Base -&gt;
<a name="28521"/>28521:             ok;
<a name="28522"/>28522:         Invalid4 -&gt; 
<a name="28523"/>28523:             exit({wrong_number_of_sockets4, Invalid4, Base})
<a name="28524"/>28524:     end,
<a name="28525"/>28525: 
<a name="28526"/>28526:     i(&quot;Globally disable use of registry&quot;),
<a name="28527"/>28527:     socket:use_registry(false),
<a name="28528"/>28528:     #{use_registry := false} = socket:info(),
<a name="28529"/>28529:     i(&quot;create a socket and ensure its not counted&quot;),
<a name="28530"/>28530:     {ok, S3} = socket:open(inet, dgram, udp),
<a name="28531"/>28531:     case socket:number_of() of
<a name="28532"/>28532:         Base -&gt;
<a name="28533"/>28533:             ok;
<a name="28534"/>28534:         Invalid5 -&gt; 
<a name="28535"/>28535:             exit({wrong_number_of_sockets5, Invalid5, Base})
<a name="28536"/>28536:     end,
<a name="28537"/>28537:     i(&quot;close the socket and ensure its not counted&quot;),
<a name="28538"/>28538:     ok = socket:close(S3),
<a name="28539"/>28539:     case socket:number_of() of
<a name="28540"/>28540:         Base -&gt;
<a name="28541"/>28541:             ok;
<a name="28542"/>28542:         Invalid6 -&gt; 
<a name="28543"/>28543:             exit({wrong_number_of_sockets6, Invalid6, Base})
<a name="28544"/>28544:     end,
<a name="28545"/>28545: 
<a name="28546"/>28546:     i(&quot;create a socket with use_registry explicitly on &quot;
<a name="28547"/>28547:       &quot;and ensure its counted&quot;),
<a name="28548"/>28548:     {ok, S4} = socket:open(inet, dgram, udp, #{use_registry =&gt; true}),
<a name="28549"/>28549:     case socket:number_of() of
<a name="28550"/>28550:         Base1 -&gt;
<a name="28551"/>28551:             ok;
<a name="28552"/>28552:         Invalid7 -&gt; 
<a name="28553"/>28553:             exit({wrong_number_of_sockets7, Invalid7, Base + 1})
<a name="28554"/>28554:     end,
<a name="28555"/>28555:     i(&quot;close the socket and ensure counted (back to base)&quot;),
<a name="28556"/>28556:     ok = socket:close(S4),
<a name="28557"/>28557:     case socket:number_of() of
<a name="28558"/>28558:         Base -&gt;
<a name="28559"/>28559:             ok;
<a name="28560"/>28560:         Invalid8 -&gt; 
<a name="28561"/>28561:             exit({wrong_number_of_sockets8, Invalid8, Base})
<a name="28562"/>28562:     end,
<a name="28563"/>28563: 
<a name="28564"/>28564:     socket:use_registry(false),
<a name="28565"/>28565:     i(&quot;done&quot;),
<a name="reg_s_optional_open_and_close_and_count-last_expr"/><a name="28566"/>28566:     ok.
<a name="28567"/>28567: 
<a name="28568"/>28568: 
<a name="28569"/>28569: 
<a name="28570"/>28570: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="28571"/>28571: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="28572"/>28572: <i>%%                                                                     %%</i>
<a name="28573"/>28573: <i>%%                       SOCKET MONITOR                                %%</i>
<a name="28574"/>28574: <i>%%                                                                     %%</i>
<a name="28575"/>28575: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="28576"/>28576: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="28577"/>28577: 
<a name="28578"/>28578: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="28579"/>28579: <i>%% Create one socket, monitor from a different process then close socket.</i>
<a name="28580"/>28580: <i>%% The process that did the monitor shall receive a socket DOWN.</i>
<a name="28581"/>28581: 
<a name="monitor_simple_open_and_close-1"/><a name="28582"/>28582: <b>monitor_simple_open_and_close</b>(_Config) when is_list(_Config) -&gt;
<a name="28583"/>28583:     ?TT(?SECS(10)),
<a name="monitor_simple_open_and_close-last_expr"/><a name="28584"/>28584: <b>    tc_try</b>(monitor_simple_open_and_close,
<a name="28585"/>28585:            fun() -&gt;
<a name="28586"/>28586: 		   InitState = #{domain   =&gt; inet,
<a name="28587"/>28587:                                  type     =&gt; stream,
<a name="28588"/>28588:                                  protocol =&gt; tcp},
<a name="28589"/>28589:                    ok = mon_simple_open_and_close(InitState)
<a name="28590"/>28590:            end).
<a name="28591"/>28591: 
<a name="28592"/>28592: 
<a name="mon_simple_open_and_close-1"/><a name="28593"/>28593: <b>mon_simple_open_and_close</b>(InitState) -&gt;
<a name="28594"/>28594:     OwnerSeq =
<a name="28595"/>28595:         [
<a name="28596"/>28596:          %% *** Wait for start order part ***
<a name="28597"/>28597:          #{desc =&gt; &quot;await start (from tester)&quot;,
<a name="28598"/>28598:            cmd  =&gt; fun(State) -&gt;
<a name="28599"/>28599:                            Tester = ?SEV_AWAIT_START(),
<a name="28600"/>28600:                            {ok, State#{tester =&gt; Tester}}
<a name="28601"/>28601:                    end},
<a name="28602"/>28602:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="28603"/>28603:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="28604"/>28604:                            _MRef = erlang:monitor(process, Tester),
<a name="28605"/>28605:                            ok
<a name="28606"/>28606:                    end},
<a name="28607"/>28607: 
<a name="28608"/>28608:          %% *** Init part ***
<a name="28609"/>28609:          #{desc =&gt; &quot;create socket&quot;,
<a name="28610"/>28610:            cmd  =&gt; fun(#{domain   := Domain, 
<a name="28611"/>28611:                          type     := Type, 
<a name="28612"/>28612:                          protocol := Proto} = State) -&gt;
<a name="28613"/>28613:                            case socket:open(Domain, Type, Proto) of
<a name="28614"/>28614:                                {ok, Sock} -&gt;
<a name="28615"/>28615:                                    {ok, State#{sock =&gt; Sock}};
<a name="28616"/>28616:                                {error, _} = ERROR -&gt;
<a name="28617"/>28617:                                    ERROR
<a name="28618"/>28618:                            end
<a name="28619"/>28619:                    end},
<a name="28620"/>28620:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="28621"/>28621:            cmd  =&gt; fun(#{tester := Tester, sock := Sock} = _State) -&gt;
<a name="28622"/>28622:                            ?SEV_ANNOUNCE_READY(Tester, init, Sock),
<a name="28623"/>28623:                            ok
<a name="28624"/>28624:                    end},
<a name="28625"/>28625: 
<a name="28626"/>28626:          %% The actual test
<a name="28627"/>28627:          #{desc =&gt; &quot;await continue (close)&quot;,
<a name="28628"/>28628:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="28629"/>28629:                            ?SEV_AWAIT_CONTINUE(Tester, tester, close)
<a name="28630"/>28630:                    end},
<a name="28631"/>28631: 
<a name="28632"/>28632:          #{desc =&gt; &quot;close socket&quot;,
<a name="28633"/>28633:            cmd  =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="28634"/>28634:                            ok = socket:close(Sock),
<a name="28635"/>28635: 			   {ok, maps:remove(sock, State)}
<a name="28636"/>28636:                    end},
<a name="28637"/>28637: 
<a name="28638"/>28638:          #{desc =&gt; &quot;await terminate (from tester)&quot;,
<a name="28639"/>28639:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="28640"/>28640:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="28641"/>28641:                                ok -&gt;
<a name="28642"/>28642:                                    {ok, maps:remove(tester, State)};
<a name="28643"/>28643:                                {error, _} = ERROR -&gt;
<a name="28644"/>28644:                                    ERROR
<a name="28645"/>28645:                            end
<a name="28646"/>28646:                    end},
<a name="28647"/>28647: 
<a name="28648"/>28648:          %% *** We are done ***
<a name="28649"/>28649:          ?SEV_FINISH_NORMAL
<a name="28650"/>28650:         ],
<a name="28651"/>28651: 
<a name="28652"/>28652:     TesterSeq =
<a name="28653"/>28653:         [
<a name="28654"/>28654:          %% *** Init part ***
<a name="28655"/>28655:          #{desc =&gt; &quot;monitor owner&quot;,
<a name="28656"/>28656:            cmd  =&gt; fun(#{owner := Owner} = _State) -&gt;
<a name="28657"/>28657:                            _MRef = erlang:monitor(process, Owner),
<a name="28658"/>28658:                            ok
<a name="28659"/>28659:                    end},
<a name="28660"/>28660:          #{desc =&gt; &quot;order (owner) start&quot;,
<a name="28661"/>28661:            cmd  =&gt; fun(#{owner := Pid} = _State) -&gt;
<a name="28662"/>28662:                            ?SEV_ANNOUNCE_START(Pid),
<a name="28663"/>28663:                            ok
<a name="28664"/>28664:                    end},
<a name="28665"/>28665:          #{desc =&gt; &quot;await (owner) ready&quot;,
<a name="28666"/>28666:            cmd  =&gt; fun(#{owner := Pid} = State) -&gt;
<a name="28667"/>28667:                            {ok, Sock} = ?SEV_AWAIT_READY(Pid, owner, init),
<a name="28668"/>28668:                            {ok, State#{sock =&gt; Sock}}
<a name="28669"/>28669:                    end},
<a name="28670"/>28670:          #{desc =&gt; &quot;verify total number of monitors (=0)&quot;,
<a name="28671"/>28671:            cmd  =&gt; fun(_State) -&gt;
<a name="28672"/>28672: 			   0 = socket:number_of_monitors(),
<a name="28673"/>28673: 			   ok
<a name="28674"/>28674:                    end},
<a name="28675"/>28675:          #{desc =&gt; &quot;verify own number of monitors (=0)&quot;,
<a name="28676"/>28676:            cmd  =&gt; fun(_State) -&gt;
<a name="28677"/>28677: 			   0 = socket:number_of_monitors(self()),
<a name="28678"/>28678: 			   ok
<a name="28679"/>28679:                    end},
<a name="28680"/>28680:          #{desc =&gt; &quot;monitor socket - create two&quot;,
<a name="28681"/>28681:            cmd  =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="28682"/>28682:                            MRef1 = socket:monitor(Sock),
<a name="28683"/>28683:                            MRef2 = socket:monitor(Sock),
<a name="28684"/>28684: 			   ?SEV_IPRINT(&quot;Monitor(s): &quot;
<a name="28685"/>28685: 				       &quot;~n   1: ~p&quot;
<a name="28686"/>28686: 				       &quot;~n   2: ~p&quot;, [MRef1, MRef2]),
<a name="28687"/>28687: 			   {ok, State#{mon1 =&gt; MRef1, mon2 =&gt; MRef2}}
<a name="28688"/>28688:                    end},
<a name="28689"/>28689:          #{desc =&gt; &quot;verify total number of monitors (=2)&quot;,
<a name="28690"/>28690:            cmd  =&gt; fun(_State) -&gt;
<a name="28691"/>28691: 			   2 = socket:number_of_monitors(),
<a name="28692"/>28692: 			   ok
<a name="28693"/>28693:                    end},
<a name="28694"/>28694:          #{desc =&gt; &quot;verify own number of monitors (=2)&quot;,
<a name="28695"/>28695:            cmd  =&gt; fun(_State) -&gt;
<a name="28696"/>28696: 			   2 = socket:number_of_monitors(self()),
<a name="28697"/>28697: 			   ok
<a name="28698"/>28698:                    end},
<a name="28699"/>28699:          #{desc =&gt; &quot;verify which monitors - (self) two&quot;,
<a name="28700"/>28700:            cmd  =&gt; fun(#{mon1 := MRef1,
<a name="28701"/>28701: 			 mon2 := MRef2} = _State) -&gt;
<a name="28702"/>28702: 			   Mons = lists:sort([MRef1, MRef2]),
<a name="28703"/>28703: 			   case lists:sort(socket:which_monitors(self())) of
<a name="28704"/>28704: 			       Mons -&gt;
<a name="28705"/>28705: 				   ok;
<a name="28706"/>28706: 			       SMons -&gt;
<a name="28707"/>28707: 				   ?SEV_EPRINT(&quot;Unexpected (self) monitors: &quot;
<a name="28708"/>28708: 					       &quot;~n   Expected: ~p&quot;
<a name="28709"/>28709: 					       &quot;~n   Actual:   ~p&quot;,
<a name="28710"/>28710: 					       [Mons, SMons]),
<a name="28711"/>28711: 				   {error, unexpected_monitors}
<a name="28712"/>28712: 			   end
<a name="28713"/>28713:                    end},
<a name="28714"/>28714:          #{desc =&gt; &quot;verify which monitors - (sock) two&quot;,
<a name="28715"/>28715:            cmd  =&gt; fun(#{sock := Sock,
<a name="28716"/>28716: 			 mon1 := MRef1,
<a name="28717"/>28717: 			 mon2 := MRef2} = _State) -&gt;
<a name="28718"/>28718: 			   Mons = lists:sort([MRef1, MRef2]),
<a name="28719"/>28719: 			   case lists:sort(socket:which_monitors(Sock)) of
<a name="28720"/>28720: 			       Mons -&gt;
<a name="28721"/>28721: 				   ok;
<a name="28722"/>28722: 			       SMons -&gt;
<a name="28723"/>28723: 				   ?SEV_EPRINT(&quot;Unexpected (sock) monitors: &quot;
<a name="28724"/>28724: 					       &quot;~n   Expected: ~p&quot;
<a name="28725"/>28725: 					       &quot;~n   Actual:   ~p&quot;,
<a name="28726"/>28726: 					       [Mons, SMons]),
<a name="28727"/>28727: 				   {error, unexpected_monitors}
<a name="28728"/>28728: 			   end
<a name="28729"/>28729:                    end},
<a name="28730"/>28730:          #{desc =&gt; &quot;verify monitored by - only us&quot;,
<a name="28731"/>28731:            cmd  =&gt; fun(#{sock := Sock} = _State) -&gt;
<a name="28732"/>28732: 			   Self   = self(),
<a name="28733"/>28733: 			   [Self] = socket:monitored_by(Sock),
<a name="28734"/>28734: 			   ok
<a name="28735"/>28735:                    end},
<a name="28736"/>28736: 
<a name="28737"/>28737:          %% The actual test
<a name="28738"/>28738:          #{desc =&gt; &quot;order owner to close&quot;,
<a name="28739"/>28739:            cmd  =&gt; fun(#{owner := Pid} = _State) -&gt;
<a name="28740"/>28740:                            ?SEV_ANNOUNCE_CONTINUE(Pid, close),
<a name="28741"/>28741:                            ok
<a name="28742"/>28742:                    end},
<a name="28743"/>28743:          #{desc =&gt; &quot;await socket down 1&quot;,
<a name="28744"/>28744:            cmd  =&gt; fun(#{sock := Sock,
<a name="28745"/>28745: 			 mon1 := MRef} = State) -&gt;
<a name="28746"/>28746: 			   receive
<a name="28747"/>28747: 			       {'DOWN', MRef, socket, Sock, Info} -&gt;
<a name="28748"/>28748: 				   ?SEV_IPRINT(&quot;received expected down: &quot;
<a name="28749"/>28749: 					       &quot;~n      MRef:   ~p&quot;
<a name="28750"/>28750: 					       &quot;~n      Socket: ~s&quot;
<a name="28751"/>28751: 					       &quot;~n      Info:   ~p&quot;,
<a name="28752"/>28752: 					       [MRef,
<a name="28753"/>28753: 						socket:to_list(Sock),
<a name="28754"/>28754: 						Info]),
<a name="28755"/>28755: 				   {ok, maps:remove(mon1, State)}
<a name="28756"/>28756: 			   after 5000 -&gt;
<a name="28757"/>28757: 				   ?SEV_EPRINT(&quot;socket down timeout&quot;),
<a name="28758"/>28758: 				   {error, timeout}
<a name="28759"/>28759: 			   end
<a name="28760"/>28760:                    end},
<a name="28761"/>28761:          #{desc =&gt; &quot;await socket down 2&quot;,
<a name="28762"/>28762:            cmd  =&gt; fun(#{sock := Sock,
<a name="28763"/>28763: 			 mon2  := MRef} = State) -&gt;
<a name="28764"/>28764: 			   receive
<a name="28765"/>28765: 			       {'DOWN', MRef, socket, Sock, Info} -&gt;
<a name="28766"/>28766: 				   ?SEV_IPRINT(&quot;received expected down: &quot;
<a name="28767"/>28767: 					       &quot;~n      MRef:   ~p&quot;
<a name="28768"/>28768: 					       &quot;~n      Socket: ~s&quot;
<a name="28769"/>28769: 					       &quot;~n      Info:   ~p&quot;,
<a name="28770"/>28770: 					       [MRef,
<a name="28771"/>28771: 						socket:to_list(Sock),
<a name="28772"/>28772: 						Info]),
<a name="28773"/>28773: 				   {ok, maps:remove(mon2, State)}
<a name="28774"/>28774: 			   after 5000 -&gt;
<a name="28775"/>28775: 				   ?SEV_EPRINT(&quot;socket down timeout&quot;),
<a name="28776"/>28776: 				   {error, timeout}
<a name="28777"/>28777: 			   end
<a name="28778"/>28778:                    end},
<a name="28779"/>28779:          #{desc =&gt; &quot;verify total number of monitors (=0)&quot;,
<a name="28780"/>28780:            cmd  =&gt; fun(_State) -&gt;
<a name="28781"/>28781: 			   0 = socket:number_of_monitors(),
<a name="28782"/>28782: 			   ok
<a name="28783"/>28783:                    end},
<a name="28784"/>28784:          #{desc =&gt; &quot;verify own number of monitors (=0)&quot;,
<a name="28785"/>28785:            cmd  =&gt; fun(_State) -&gt;
<a name="28786"/>28786: 			   0 = socket:number_of_monitors(self()),
<a name="28787"/>28787: 			   ok
<a name="28788"/>28788:                    end},
<a name="28789"/>28789:          #{desc =&gt; &quot;verify which monitors - only one&quot;,
<a name="28790"/>28790:            cmd  =&gt; fun(#{sock := Sock} = _State) -&gt;
<a name="28791"/>28791: 			   [] = socket:which_monitors(self()),
<a name="28792"/>28792: 			   [] = socket:which_monitors(Sock),
<a name="28793"/>28793: 			   ok
<a name="28794"/>28794:                    end},
<a name="28795"/>28795:          #{desc =&gt; &quot;verify monitored by - none&quot;,
<a name="28796"/>28796:            cmd  =&gt; fun(#{sock := Sock} = _State) -&gt;
<a name="28797"/>28797: 			   [] = socket:monitored_by(Sock),
<a name="28798"/>28798: 			   ok
<a name="28799"/>28799:                    end},
<a name="28800"/>28800: 
<a name="28801"/>28801:          %% Cleanup
<a name="28802"/>28802:          #{desc =&gt; &quot;order (owner) terminate&quot;,
<a name="28803"/>28803:            cmd  =&gt; fun(#{owner := Pid} = _State) -&gt;
<a name="28804"/>28804:                            ?SEV_ANNOUNCE_TERMINATE(Pid),
<a name="28805"/>28805:                            ok
<a name="28806"/>28806:                    end},
<a name="28807"/>28807: 
<a name="28808"/>28808:          #{desc =&gt; &quot;await (owner) termination&quot;,
<a name="28809"/>28809:            cmd  =&gt; fun(#{owner := Pid} = _State) -&gt;
<a name="28810"/>28810:                            case ?SEV_AWAIT_TERMINATION(Pid) of
<a name="28811"/>28811:                                ok -&gt;
<a name="28812"/>28812:                                    ok;
<a name="28813"/>28813:                                {error, _} = ERROR -&gt;
<a name="28814"/>28814:                                    ERROR
<a name="28815"/>28815:                            end
<a name="28816"/>28816:                    end},
<a name="28817"/>28817: 
<a name="28818"/>28818:          %% *** We are done ***
<a name="28819"/>28819:          ?SEV_FINISH_NORMAL
<a name="28820"/>28820:         ],
<a name="28821"/>28821: 
<a name="28822"/>28822:     i(&quot;start (socket) owner evaluator&quot;),
<a name="28823"/>28823:     Owner = ?SEV_START(&quot;owner&quot;, OwnerSeq, InitState),
<a name="28824"/>28824: 
<a name="28825"/>28825:     i(&quot;start tester evaluator&quot;),
<a name="28826"/>28826:     TesterInitState = #{owner =&gt; Owner#ev.pid},
<a name="28827"/>28827:     Tester = ?SEV_START(&quot;tester&quot;, TesterSeq, TesterInitState),
<a name="28828"/>28828: 
<a name="28829"/>28829:     i(&quot;await evaluator&quot;),
<a name="mon_simple_open_and_close-last_expr"/><a name="28830"/>28830: <b>    ok = ?SEV_AWAIT_FINISH</b>([Owner, Tester]).
<a name="28831"/>28831: 
<a name="28832"/>28832: 
<a name="28833"/>28833: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="28834"/>28834: <i>%% Create one socket, monitor from a different process then stop the</i>
<a name="28835"/>28835: <i>%% owner process.</i>
<a name="28836"/>28836: <i>%% The process that did the monitor shall receive a socket DOWN.</i>
<a name="28837"/>28837: 
<a name="monitor_simple_open_and_exit-1"/><a name="28838"/>28838: <b>monitor_simple_open_and_exit</b>(_Config) when is_list(_Config) -&gt;
<a name="28839"/>28839:     ?TT(?SECS(10)),
<a name="monitor_simple_open_and_exit-last_expr"/><a name="28840"/>28840: <b>    tc_try</b>(monitor_simple_open_and_exit,
<a name="28841"/>28841:            fun() -&gt;
<a name="28842"/>28842: 		   InitState = #{domain   =&gt; inet,
<a name="28843"/>28843:                                  type     =&gt; stream,
<a name="28844"/>28844:                                  protocol =&gt; tcp},
<a name="28845"/>28845:                    ok = mon_simple_open_and_exit(InitState)
<a name="28846"/>28846:            end).
<a name="28847"/>28847: 
<a name="28848"/>28848: 
<a name="mon_simple_open_and_exit-1"/><a name="28849"/>28849: <b>mon_simple_open_and_exit</b>(InitState) -&gt;
<a name="28850"/>28850:     OwnerSeq =
<a name="28851"/>28851:         [
<a name="28852"/>28852:          %% *** Wait for start order part ***
<a name="28853"/>28853:          #{desc =&gt; &quot;await start (from tester)&quot;,
<a name="28854"/>28854:            cmd  =&gt; fun(State) -&gt;
<a name="28855"/>28855:                            Tester = ?SEV_AWAIT_START(),
<a name="28856"/>28856:                            {ok, State#{tester =&gt; Tester}}
<a name="28857"/>28857:                    end},
<a name="28858"/>28858:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="28859"/>28859:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="28860"/>28860:                            _MRef = erlang:monitor(process, Tester),
<a name="28861"/>28861:                            ok
<a name="28862"/>28862:                    end},
<a name="28863"/>28863: 
<a name="28864"/>28864:          %% *** Init part ***
<a name="28865"/>28865:          #{desc =&gt; &quot;create socket&quot;,
<a name="28866"/>28866:            cmd  =&gt; fun(#{domain   := Domain, 
<a name="28867"/>28867:                          type     := Type, 
<a name="28868"/>28868:                          protocol := Proto} = State) -&gt;
<a name="28869"/>28869:                            case socket:open(Domain, Type, Proto) of
<a name="28870"/>28870:                                {ok, Sock} -&gt;
<a name="28871"/>28871:                                    {ok, State#{sock =&gt; Sock}};
<a name="28872"/>28872:                                {error, _} = ERROR -&gt;
<a name="28873"/>28873:                                    ERROR
<a name="28874"/>28874:                            end
<a name="28875"/>28875:                    end},
<a name="28876"/>28876:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="28877"/>28877:            cmd  =&gt; fun(#{tester := Tester, sock := Sock} = _State) -&gt;
<a name="28878"/>28878:                            ?SEV_ANNOUNCE_READY(Tester, init, Sock),
<a name="28879"/>28879:                            ok
<a name="28880"/>28880:                    end},
<a name="28881"/>28881: 
<a name="28882"/>28882:          %% The actual test
<a name="28883"/>28883:          #{desc =&gt; &quot;await terminate (from tester)&quot;,
<a name="28884"/>28884:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="28885"/>28885:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="28886"/>28886:                                ok -&gt;
<a name="28887"/>28887:                                    {ok, maps:remove(tester, State)};
<a name="28888"/>28888:                                {error, _} = ERROR -&gt;
<a name="28889"/>28889:                                    ERROR
<a name="28890"/>28890:                            end
<a name="28891"/>28891:                    end},
<a name="28892"/>28892: 
<a name="28893"/>28893:          %% *** We are done ***
<a name="28894"/>28894:          ?SEV_FINISH_NORMAL
<a name="28895"/>28895:         ],
<a name="28896"/>28896: 
<a name="28897"/>28897:     TesterSeq =
<a name="28898"/>28898:         [
<a name="28899"/>28899:          %% *** Init part ***
<a name="28900"/>28900:          #{desc =&gt; &quot;monitor owner&quot;,
<a name="28901"/>28901:            cmd  =&gt; fun(#{owner := Owner} = _State) -&gt;
<a name="28902"/>28902:                            _MRef = erlang:monitor(process, Owner),
<a name="28903"/>28903:                            ok
<a name="28904"/>28904:                    end},
<a name="28905"/>28905:          #{desc =&gt; &quot;order (owner) start&quot;,
<a name="28906"/>28906:            cmd  =&gt; fun(#{owner := Pid} = _State) -&gt;
<a name="28907"/>28907:                            ?SEV_ANNOUNCE_START(Pid),
<a name="28908"/>28908:                            ok
<a name="28909"/>28909:                    end},
<a name="28910"/>28910:          #{desc =&gt; &quot;await (owner) ready&quot;,
<a name="28911"/>28911:            cmd  =&gt; fun(#{owner := Pid} = State) -&gt;
<a name="28912"/>28912:                            {ok, Sock} = ?SEV_AWAIT_READY(Pid, owner, init),
<a name="28913"/>28913:                            {ok, State#{sock =&gt; Sock}}
<a name="28914"/>28914:                    end},
<a name="28915"/>28915:          #{desc =&gt; &quot;verify total number of monitors (=0)&quot;,
<a name="28916"/>28916:            cmd  =&gt; fun(_State) -&gt;
<a name="28917"/>28917: 			   0 = socket:number_of_monitors(),
<a name="28918"/>28918: 			   ok
<a name="28919"/>28919:                    end},
<a name="28920"/>28920:          #{desc =&gt; &quot;verify own number of monitors (=0)&quot;,
<a name="28921"/>28921:            cmd  =&gt; fun(_State) -&gt;
<a name="28922"/>28922: 			   0 = socket:number_of_monitors(self()),
<a name="28923"/>28923: 			   ok
<a name="28924"/>28924:                    end},
<a name="28925"/>28925:          #{desc =&gt; &quot;monitor socket&quot;,
<a name="28926"/>28926:            cmd  =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="28927"/>28927:                            MRef = socket:monitor(Sock),
<a name="28928"/>28928: 			   ?SEV_IPRINT(&quot;Monitor: ~p&quot;, [MRef]),
<a name="28929"/>28929: 			   {ok, State#{mon =&gt; MRef}}
<a name="28930"/>28930:                    end},
<a name="28931"/>28931:          #{desc =&gt; &quot;verify total number of monitors (=1)&quot;,
<a name="28932"/>28932:            cmd  =&gt; fun(_State) -&gt;
<a name="28933"/>28933: 			   1 = socket:number_of_monitors(),
<a name="28934"/>28934: 			   ok
<a name="28935"/>28935:                    end},
<a name="28936"/>28936:          #{desc =&gt; &quot;verify own number of monitors (=1)&quot;,
<a name="28937"/>28937:            cmd  =&gt; fun(_State) -&gt;
<a name="28938"/>28938: 			   1 = socket:number_of_monitors(self()),
<a name="28939"/>28939: 			   ok
<a name="28940"/>28940:                    end},
<a name="28941"/>28941:          #{desc =&gt; &quot;verify which monitors - only one&quot;,
<a name="28942"/>28942:            cmd  =&gt; fun(#{sock := Sock,
<a name="28943"/>28943: 			 mon  := MRef} = _State) -&gt;
<a name="28944"/>28944: 			   [MRef] = socket:which_monitors(self()),
<a name="28945"/>28945: 			   [MRef] = socket:which_monitors(Sock),
<a name="28946"/>28946: 			   ok
<a name="28947"/>28947:                    end},
<a name="28948"/>28948:          #{desc =&gt; &quot;verify monitored by - only us&quot;,
<a name="28949"/>28949:            cmd  =&gt; fun(#{sock := Sock} = _State) -&gt;
<a name="28950"/>28950: 			   Self   = self(),
<a name="28951"/>28951: 			   [Self] = socket:monitored_by(Sock),
<a name="28952"/>28952: 			   ok
<a name="28953"/>28953:                    end},
<a name="28954"/>28954: 
<a name="28955"/>28955:          %% The actual test
<a name="28956"/>28956:          #{desc =&gt; &quot;order (owner) terminate&quot;,
<a name="28957"/>28957:            cmd  =&gt; fun(#{owner := Pid} = _State) -&gt;
<a name="28958"/>28958:                            ?SEV_ANNOUNCE_TERMINATE(Pid),
<a name="28959"/>28959:                            ok
<a name="28960"/>28960:                    end},
<a name="28961"/>28961:          #{desc =&gt; &quot;await (owner) termination&quot;,
<a name="28962"/>28962:            cmd  =&gt; fun(#{owner := Pid} = _State) -&gt;
<a name="28963"/>28963:                            case ?SEV_AWAIT_TERMINATION(Pid) of
<a name="28964"/>28964:                                ok -&gt;
<a name="28965"/>28965:                                    ok;
<a name="28966"/>28966:                                {error, _} = ERROR -&gt;
<a name="28967"/>28967:                                    ERROR
<a name="28968"/>28968:                            end
<a name="28969"/>28969:                    end},
<a name="28970"/>28970: 
<a name="28971"/>28971:          #{desc =&gt; &quot;await socket down&quot;,
<a name="28972"/>28972:            cmd  =&gt; fun(#{sock := Sock,
<a name="28973"/>28973: 			 mon  := MRef} = _State) -&gt;
<a name="28974"/>28974: 			   receive
<a name="28975"/>28975: 			       {'DOWN', MRef, socket, Sock, Info} -&gt;
<a name="28976"/>28976: 				   ?SEV_IPRINT(&quot;received expected down: &quot;
<a name="28977"/>28977: 					       &quot;~n      MRef:   ~p&quot;
<a name="28978"/>28978: 					       &quot;~n      Socket: ~p&quot;
<a name="28979"/>28979: 					       &quot;~n      Info:   ~p&quot;,
<a name="28980"/>28980: 					       [MRef, Sock, Info]),
<a name="28981"/>28981: 				   ok
<a name="28982"/>28982: 			   after 5000 -&gt;
<a name="28983"/>28983: 				   ?SEV_EPRINT(&quot;socket down timeout&quot;),
<a name="28984"/>28984: 				   {error, timeout}
<a name="28985"/>28985: 			   end
<a name="28986"/>28986:                    end},
<a name="28987"/>28987:          #{desc =&gt; &quot;verify total number of monitors (=0)&quot;,
<a name="28988"/>28988:            cmd  =&gt; fun(_State) -&gt;
<a name="28989"/>28989: 			   0 = socket:number_of_monitors(),
<a name="28990"/>28990: 			   ok
<a name="28991"/>28991:                    end},
<a name="28992"/>28992:          #{desc =&gt; &quot;verify own number of monitors (=0)&quot;,
<a name="28993"/>28993:            cmd  =&gt; fun(_State) -&gt;
<a name="28994"/>28994: 			   0 = socket:number_of_monitors(self()),
<a name="28995"/>28995: 			   ok
<a name="28996"/>28996:                    end},
<a name="28997"/>28997:          #{desc =&gt; &quot;verify which monitors - only one&quot;,
<a name="28998"/>28998:            cmd  =&gt; fun(#{sock := Sock} = _State) -&gt;
<a name="28999"/>28999: 			   [] = socket:which_monitors(self()),
<a name="29000"/>29000: 			   [] = socket:which_monitors(Sock),
<a name="29001"/>29001: 			   ok
<a name="29002"/>29002:                    end},
<a name="29003"/>29003:          #{desc =&gt; &quot;verify monitored by - none&quot;,
<a name="29004"/>29004:            cmd  =&gt; fun(#{sock := Sock} = _State) -&gt;
<a name="29005"/>29005: 			   [] = socket:monitored_by(Sock),
<a name="29006"/>29006: 			   ok
<a name="29007"/>29007:                    end},
<a name="29008"/>29008: 
<a name="29009"/>29009:          %% *** We are done ***
<a name="29010"/>29010:          ?SEV_FINISH_NORMAL
<a name="29011"/>29011:         ],
<a name="29012"/>29012: 
<a name="29013"/>29013:     i(&quot;start (socket) owner evaluator&quot;),
<a name="29014"/>29014:     Owner = ?SEV_START(&quot;owner&quot;, OwnerSeq, InitState),
<a name="29015"/>29015: 
<a name="29016"/>29016:     i(&quot;start tester evaluator&quot;),
<a name="29017"/>29017:     TesterInitState = #{owner =&gt; Owner#ev.pid},
<a name="29018"/>29018:     Tester = ?SEV_START(&quot;tester&quot;, TesterSeq, TesterInitState),
<a name="29019"/>29019: 
<a name="29020"/>29020:     i(&quot;await evaluator&quot;),
<a name="mon_simple_open_and_exit-last_expr"/><a name="29021"/>29021: <b>    ok = ?SEV_AWAIT_FINISH</b>([Owner, Tester]).
<a name="29022"/>29022: 
<a name="29023"/>29023: 
<a name="29024"/>29024: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="29025"/>29025: <i>%% Create one socket, monitor from a different process, cancel_montor</i>
<a name="29026"/>29026: <i>%% (demonitor) and then close socket.</i>
<a name="29027"/>29027: <i>%% The process that did the monitor shall *not* receive a socket DOWN.</i>
<a name="29028"/>29028: 
<a name="monitor_simple_open_and_demon_and_close-1"/><a name="29029"/>29029: <b>monitor_simple_open_and_demon_and_close</b>(_Config) when is_list(_Config) -&gt;
<a name="29030"/>29030:     ?TT(?SECS(10)),
<a name="monitor_simple_open_and_demon_and_close-last_expr"/><a name="29031"/>29031: <b>    tc_try</b>(monitor_simple_open_and_demon_and_close,
<a name="29032"/>29032:            fun() -&gt;
<a name="29033"/>29033: 		   InitState = #{domain   =&gt; inet,
<a name="29034"/>29034:                                  type     =&gt; stream,
<a name="29035"/>29035:                                  protocol =&gt; tcp},
<a name="29036"/>29036:                    ok = mon_simple_open_and_demon_and_close(InitState)
<a name="29037"/>29037:            end).
<a name="29038"/>29038: 
<a name="29039"/>29039: 
<a name="mon_simple_open_and_demon_and_close-1"/><a name="29040"/>29040: <b>mon_simple_open_and_demon_and_close</b>(InitState) -&gt;
<a name="29041"/>29041:     OwnerSeq =
<a name="29042"/>29042:         [
<a name="29043"/>29043:          %% *** Wait for start order part ***
<a name="29044"/>29044:          #{desc =&gt; &quot;await start (from tester)&quot;,
<a name="29045"/>29045:            cmd  =&gt; fun(State) -&gt;
<a name="29046"/>29046:                            Tester = ?SEV_AWAIT_START(),
<a name="29047"/>29047:                            {ok, State#{tester =&gt; Tester}}
<a name="29048"/>29048:                    end},
<a name="29049"/>29049:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="29050"/>29050:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="29051"/>29051:                            _MRef = erlang:monitor(process, Tester),
<a name="29052"/>29052:                            ok
<a name="29053"/>29053:                    end},
<a name="29054"/>29054: 
<a name="29055"/>29055:          %% *** Init part ***
<a name="29056"/>29056:          #{desc =&gt; &quot;create socket&quot;,
<a name="29057"/>29057:            cmd  =&gt; fun(#{domain   := Domain, 
<a name="29058"/>29058:                          type     := Type, 
<a name="29059"/>29059:                          protocol := Proto} = State) -&gt;
<a name="29060"/>29060:                            case socket:open(Domain, Type, Proto) of
<a name="29061"/>29061:                                {ok, Sock} -&gt;
<a name="29062"/>29062:                                    {ok, State#{sock =&gt; Sock}};
<a name="29063"/>29063:                                {error, _} = ERROR -&gt;
<a name="29064"/>29064:                                    ERROR
<a name="29065"/>29065:                            end
<a name="29066"/>29066:                    end},
<a name="29067"/>29067:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="29068"/>29068:            cmd  =&gt; fun(#{tester := Tester, sock := Sock} = _State) -&gt;
<a name="29069"/>29069:                            ?SEV_ANNOUNCE_READY(Tester, init, Sock),
<a name="29070"/>29070:                            ok
<a name="29071"/>29071:                    end},
<a name="29072"/>29072: 
<a name="29073"/>29073:          %% The actual test
<a name="29074"/>29074:          #{desc =&gt; &quot;await continue (close)&quot;,
<a name="29075"/>29075:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="29076"/>29076:                            ?SEV_AWAIT_CONTINUE(Tester, tester, close)
<a name="29077"/>29077:                    end},
<a name="29078"/>29078: 
<a name="29079"/>29079:          #{desc =&gt; &quot;close socket&quot;,
<a name="29080"/>29080:            cmd  =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="29081"/>29081:                            ok = socket:close(Sock),
<a name="29082"/>29082: 			   {ok, maps:remove(sock, State)}
<a name="29083"/>29083:                    end},
<a name="29084"/>29084: 
<a name="29085"/>29085:          #{desc =&gt; &quot;await terminate (from tester)&quot;,
<a name="29086"/>29086:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="29087"/>29087:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="29088"/>29088:                                ok -&gt;
<a name="29089"/>29089:                                    {ok, maps:remove(tester, State)};
<a name="29090"/>29090:                                {error, _} = ERROR -&gt;
<a name="29091"/>29091:                                    ERROR
<a name="29092"/>29092:                            end
<a name="29093"/>29093:                    end},
<a name="29094"/>29094: 
<a name="29095"/>29095:          %% *** We are done ***
<a name="29096"/>29096:          ?SEV_FINISH_NORMAL
<a name="29097"/>29097:         ],
<a name="29098"/>29098: 
<a name="29099"/>29099:     TesterSeq =
<a name="29100"/>29100:         [
<a name="29101"/>29101:          %% *** Init part ***
<a name="29102"/>29102:          #{desc =&gt; &quot;monitor owner&quot;,
<a name="29103"/>29103:            cmd  =&gt; fun(#{owner := Owner} = _State) -&gt;
<a name="29104"/>29104:                            _MRef = erlang:monitor(process, Owner),
<a name="29105"/>29105:                            ok
<a name="29106"/>29106:                    end},
<a name="29107"/>29107:          #{desc =&gt; &quot;order (owner) start&quot;,
<a name="29108"/>29108:            cmd  =&gt; fun(#{owner := Pid} = _State) -&gt;
<a name="29109"/>29109:                            ?SEV_ANNOUNCE_START(Pid),
<a name="29110"/>29110:                            ok
<a name="29111"/>29111:                    end},
<a name="29112"/>29112:          #{desc =&gt; &quot;await (owner) ready&quot;,
<a name="29113"/>29113:            cmd  =&gt; fun(#{owner := Pid} = State) -&gt;
<a name="29114"/>29114:                            {ok, Sock} = ?SEV_AWAIT_READY(Pid, owner, init),
<a name="29115"/>29115:                            {ok, State#{sock =&gt; Sock}}
<a name="29116"/>29116:                    end},
<a name="29117"/>29117:          #{desc =&gt; &quot;verify total number of monitors (=0)&quot;,
<a name="29118"/>29118:            cmd  =&gt; fun(_State) -&gt;
<a name="29119"/>29119: 			   0 = socket:number_of_monitors(),
<a name="29120"/>29120: 			   ok
<a name="29121"/>29121:                    end},
<a name="29122"/>29122:          #{desc =&gt; &quot;verify own number of monitors (=0)&quot;,
<a name="29123"/>29123:            cmd  =&gt; fun(_State) -&gt;
<a name="29124"/>29124: 			   0 = socket:number_of_monitors(self()),
<a name="29125"/>29125: 			   ok
<a name="29126"/>29126:                    end},
<a name="29127"/>29127:          #{desc =&gt; &quot;monitor socket&quot;,
<a name="29128"/>29128:            cmd  =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="29129"/>29129:                            MRef = socket:monitor(Sock),
<a name="29130"/>29130: 			   ?SEV_IPRINT(&quot;Monitor: ~p&quot;, [MRef]),
<a name="29131"/>29131: 			   {ok, State#{mon =&gt; MRef}}
<a name="29132"/>29132:                    end},
<a name="29133"/>29133:          #{desc =&gt; &quot;verify total number of monitors (=1)&quot;,
<a name="29134"/>29134:            cmd  =&gt; fun(_State) -&gt;
<a name="29135"/>29135: 			   1 = socket:number_of_monitors(),
<a name="29136"/>29136: 			   ok
<a name="29137"/>29137:                    end},
<a name="29138"/>29138:          #{desc =&gt; &quot;verify own number of monitors (=1)&quot;,
<a name="29139"/>29139:            cmd  =&gt; fun(_State) -&gt;
<a name="29140"/>29140: 			   1 = socket:number_of_monitors(self()),
<a name="29141"/>29141: 			   ok
<a name="29142"/>29142:                    end},
<a name="29143"/>29143: 
<a name="29144"/>29144:          %% The actual test
<a name="29145"/>29145:          #{desc =&gt; &quot;demonitor socket&quot;,
<a name="29146"/>29146:            cmd  =&gt; fun(#{mon := MRef} = State) -&gt;
<a name="29147"/>29147:                            true = socket:cancel_monitor(MRef),
<a name="29148"/>29148: 			   {ok, maps:remove(mon, State)}
<a name="29149"/>29149:                    end},
<a name="29150"/>29150: 
<a name="29151"/>29151: 	 #{desc =&gt; &quot;verify total number of monitors (=0)&quot;,
<a name="29152"/>29152: 	   cmd  =&gt; fun(_State) -&gt;
<a name="29153"/>29153: 			   0 = socket:number_of_monitors(),
<a name="29154"/>29154: 			   ok
<a name="29155"/>29155: 		   end},
<a name="29156"/>29156: 	 #{desc =&gt; &quot;verify own number of monitors (=0)&quot;,
<a name="29157"/>29157: 	   cmd  =&gt; fun(_State) -&gt;
<a name="29158"/>29158: 			   0 = socket:number_of_monitors(self()),
<a name="29159"/>29159: 			   ok
<a name="29160"/>29160: 		   end},
<a name="29161"/>29161: 
<a name="29162"/>29162:          #{desc =&gt; &quot;order owner to close&quot;,
<a name="29163"/>29163:            cmd  =&gt; fun(#{owner := Pid} = _State) -&gt;
<a name="29164"/>29164:                            ?SEV_ANNOUNCE_CONTINUE(Pid, close),
<a name="29165"/>29165:                            ok
<a name="29166"/>29166:                    end},
<a name="29167"/>29167: 
<a name="29168"/>29168:          #{desc =&gt; &quot;await socket down&quot;,
<a name="29169"/>29169:            cmd  =&gt; fun(#{sock := Sock} = _State) -&gt;
<a name="29170"/>29170: 			   receive
<a name="29171"/>29171: 			       {'DOWN', MRef, socket, Sock, Info} -&gt;
<a name="29172"/>29172: 				   ?SEV_EPRINT(&quot;received UNEXPECTED down: &quot;
<a name="29173"/>29173: 					       &quot;~n      MRef:   ~p&quot;
<a name="29174"/>29174: 					       &quot;~n      Socket: ~p&quot;
<a name="29175"/>29175: 					       &quot;~n      Info:   ~p&quot;,
<a name="29176"/>29176: 					       [MRef, Sock, Info]),
<a name="29177"/>29177: 				   {error, unexpected_down}
<a name="29178"/>29178: 			   after 5000 -&gt;
<a name="29179"/>29179: 				   ?SEV_IPRINT(&quot;expected socket down timeout&quot;),
<a name="29180"/>29180: 				   ok
<a name="29181"/>29181: 			   end
<a name="29182"/>29182:                    end},
<a name="29183"/>29183: 
<a name="29184"/>29184:          %% Cleanup
<a name="29185"/>29185:          #{desc =&gt; &quot;order (owner) terminate&quot;,
<a name="29186"/>29186:            cmd  =&gt; fun(#{owner := Pid} = _State) -&gt;
<a name="29187"/>29187:                            ?SEV_ANNOUNCE_TERMINATE(Pid),
<a name="29188"/>29188:                            ok
<a name="29189"/>29189:                    end},
<a name="29190"/>29190: 
<a name="29191"/>29191:          #{desc =&gt; &quot;await (owner) termination&quot;,
<a name="29192"/>29192:            cmd  =&gt; fun(#{owner := Pid} = _State) -&gt;
<a name="29193"/>29193:                            case ?SEV_AWAIT_TERMINATION(Pid) of
<a name="29194"/>29194:                                ok -&gt;
<a name="29195"/>29195:                                    ok;
<a name="29196"/>29196:                                {error, _} = ERROR -&gt;
<a name="29197"/>29197:                                    ERROR
<a name="29198"/>29198:                            end
<a name="29199"/>29199:                    end},
<a name="29200"/>29200: 
<a name="29201"/>29201:          %% *** We are done ***
<a name="29202"/>29202:          ?SEV_FINISH_NORMAL
<a name="29203"/>29203:         ],
<a name="29204"/>29204: 
<a name="29205"/>29205:     i(&quot;start (socket) owner evaluator&quot;),
<a name="29206"/>29206:     Owner = ?SEV_START(&quot;owner&quot;, OwnerSeq, InitState),
<a name="29207"/>29207: 
<a name="29208"/>29208:     i(&quot;start tester evaluator&quot;),
<a name="29209"/>29209:     TesterInitState = #{owner =&gt; Owner#ev.pid},
<a name="29210"/>29210:     Tester = ?SEV_START(&quot;tester&quot;, TesterSeq, TesterInitState),
<a name="29211"/>29211: 
<a name="29212"/>29212:     i(&quot;await evaluator&quot;),
<a name="mon_simple_open_and_demon_and_close-last_expr"/><a name="29213"/>29213: <b>    ok = ?SEV_AWAIT_FINISH</b>([Owner, Tester]).
<a name="29214"/>29214: 
<a name="29215"/>29215: 
<a name="29216"/>29216: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="29217"/>29217: <i>%% Create several sockets, monitor from a different process then close</i>
<a name="29218"/>29218: <i>%% socket. The process that did the monitor shall receive a socket DOWN.</i>
<a name="29219"/>29219: 
<a name="monitor_open_and_close_multi_socks-1"/><a name="29220"/>29220: <b>monitor_open_and_close_multi_socks</b>(_Config) when is_list(_Config) -&gt;
<a name="29221"/>29221:     ?TT(?SECS(10)),
<a name="monitor_open_and_close_multi_socks-last_expr"/><a name="29222"/>29222: <b>    tc_try</b>(monitor_open_and_close_multi_socks,
<a name="29223"/>29223:            fun() -&gt;
<a name="29224"/>29224: 		   InitState = #{domain   =&gt; inet,
<a name="29225"/>29225:                                  type     =&gt; stream,
<a name="29226"/>29226:                                  protocol =&gt; tcp},
<a name="29227"/>29227:                    ok = mon_open_and_close_multi_socks(InitState)
<a name="29228"/>29228:            end).
<a name="29229"/>29229: 
<a name="29230"/>29230: 
<a name="mon_open_and_close_multi_socks-1"/><a name="29231"/>29231: <b>mon_open_and_close_multi_socks</b>(InitState) -&gt;
<a name="29232"/>29232:     OwnerSeq =
<a name="29233"/>29233:         [
<a name="29234"/>29234:          %% *** Wait for start order part ***
<a name="29235"/>29235:          #{desc =&gt; &quot;await start (from tester)&quot;,
<a name="29236"/>29236:            cmd  =&gt; fun(State) -&gt;
<a name="29237"/>29237:                            Tester = ?SEV_AWAIT_START(),
<a name="29238"/>29238:                            {ok, State#{tester =&gt; Tester}}
<a name="29239"/>29239:                    end},
<a name="29240"/>29240:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="29241"/>29241:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="29242"/>29242:                            _MRef = erlang:monitor(process, Tester),
<a name="29243"/>29243:                            ok
<a name="29244"/>29244:                    end},
<a name="29245"/>29245: 
<a name="29246"/>29246:          %% *** Init part ***
<a name="29247"/>29247:          #{desc =&gt; &quot;create socket 1&quot;,
<a name="29248"/>29248:            cmd  =&gt; fun(#{domain   := Domain, 
<a name="29249"/>29249:                          type     := Type, 
<a name="29250"/>29250:                          protocol := Proto} = State) -&gt;
<a name="29251"/>29251:                            case socket:open(Domain, Type, Proto) of
<a name="29252"/>29252:                                {ok, Sock} -&gt;
<a name="29253"/>29253:                                    {ok, State#{sock1 =&gt; Sock}};
<a name="29254"/>29254:                                {error, _} = ERROR -&gt;
<a name="29255"/>29255:                                    ERROR
<a name="29256"/>29256:                            end
<a name="29257"/>29257:                    end},
<a name="29258"/>29258:          #{desc =&gt; &quot;create socket 2&quot;,
<a name="29259"/>29259:            cmd  =&gt; fun(#{domain   := Domain, 
<a name="29260"/>29260:                          type     := Type, 
<a name="29261"/>29261:                          protocol := Proto} = State) -&gt;
<a name="29262"/>29262:                            case socket:open(Domain, Type, Proto) of
<a name="29263"/>29263:                                {ok, Sock} -&gt;
<a name="29264"/>29264:                                    {ok, State#{sock2 =&gt; Sock}};
<a name="29265"/>29265:                                {error, _} = ERROR -&gt;
<a name="29266"/>29266:                                    ERROR
<a name="29267"/>29267:                            end
<a name="29268"/>29268:                    end},
<a name="29269"/>29269:          #{desc =&gt; &quot;create socket 3&quot;,
<a name="29270"/>29270:            cmd  =&gt; fun(#{domain   := Domain, 
<a name="29271"/>29271:                          type     := Type, 
<a name="29272"/>29272:                          protocol := Proto} = State) -&gt;
<a name="29273"/>29273:                            case socket:open(Domain, Type, Proto) of
<a name="29274"/>29274:                                {ok, Sock} -&gt;
<a name="29275"/>29275:                                    {ok, State#{sock3 =&gt; Sock}};
<a name="29276"/>29276:                                {error, _} = ERROR -&gt;
<a name="29277"/>29277:                                    ERROR
<a name="29278"/>29278:                            end
<a name="29279"/>29279:                    end},
<a name="29280"/>29280:          #{desc =&gt; &quot;create socket 4&quot;,
<a name="29281"/>29281:            cmd  =&gt; fun(#{domain   := Domain, 
<a name="29282"/>29282:                          type     := Type, 
<a name="29283"/>29283:                          protocol := Proto} = State) -&gt;
<a name="29284"/>29284:                            case socket:open(Domain, Type, Proto) of
<a name="29285"/>29285:                                {ok, Sock} -&gt;
<a name="29286"/>29286:                                    {ok, State#{sock4 =&gt; Sock}};
<a name="29287"/>29287:                                {error, _} = ERROR -&gt;
<a name="29288"/>29288:                                    ERROR
<a name="29289"/>29289:                            end
<a name="29290"/>29290:                    end},
<a name="29291"/>29291:          #{desc =&gt; &quot;create socket 5&quot;,
<a name="29292"/>29292:            cmd  =&gt; fun(#{domain   := Domain, 
<a name="29293"/>29293:                          type     := Type, 
<a name="29294"/>29294:                          protocol := Proto} = State) -&gt;
<a name="29295"/>29295:                            case socket:open(Domain, Type, Proto) of
<a name="29296"/>29296:                                {ok, Sock} -&gt;
<a name="29297"/>29297:                                    {ok, State#{sock5 =&gt; Sock}};
<a name="29298"/>29298:                                {error, _} = ERROR -&gt;
<a name="29299"/>29299:                                    ERROR
<a name="29300"/>29300:                            end
<a name="29301"/>29301:                    end},
<a name="29302"/>29302:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="29303"/>29303:            cmd  =&gt; fun(#{tester := Tester,
<a name="29304"/>29304: 			 sock1  := Sock1,
<a name="29305"/>29305: 			 sock2  := Sock2,
<a name="29306"/>29306: 			 sock3  := Sock3,
<a name="29307"/>29307: 			 sock4  := Sock4,
<a name="29308"/>29308: 			 sock5  := Sock5} = _State) -&gt;
<a name="29309"/>29309: 			   Socks = [Sock1, Sock2, Sock3, Sock4, Sock5],
<a name="29310"/>29310:                            ?SEV_ANNOUNCE_READY(Tester, init, Socks),
<a name="29311"/>29311:                            ok
<a name="29312"/>29312:                    end},
<a name="29313"/>29313: 
<a name="29314"/>29314:          %% The actual test
<a name="29315"/>29315:          #{desc =&gt; &quot;await continue (close1)&quot;,
<a name="29316"/>29316:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="29317"/>29317:                            ?SEV_AWAIT_CONTINUE(Tester, tester, close1)
<a name="29318"/>29318:                    end},
<a name="29319"/>29319:          #{desc =&gt; &quot;close socket 1&quot;,
<a name="29320"/>29320:            cmd  =&gt; fun(#{sock1 := Sock} = State) -&gt;
<a name="29321"/>29321:                            ok = socket:close(Sock),
<a name="29322"/>29322: 			   {ok, maps:remove(sock1, State)}
<a name="29323"/>29323:                    end},
<a name="29324"/>29324: 
<a name="29325"/>29325:          #{desc =&gt; &quot;await continue (close2)&quot;,
<a name="29326"/>29326:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="29327"/>29327:                            ?SEV_AWAIT_CONTINUE(Tester, tester, close2)
<a name="29328"/>29328:                    end},
<a name="29329"/>29329:          #{desc =&gt; &quot;close socket 2&quot;,
<a name="29330"/>29330:            cmd  =&gt; fun(#{sock2 := Sock} = State) -&gt;
<a name="29331"/>29331:                            ok = socket:close(Sock),
<a name="29332"/>29332: 			   {ok, maps:remove(sock2, State)}
<a name="29333"/>29333:                    end},
<a name="29334"/>29334: 
<a name="29335"/>29335:          #{desc =&gt; &quot;await continue (close3)&quot;,
<a name="29336"/>29336:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="29337"/>29337:                            ?SEV_AWAIT_CONTINUE(Tester, tester, close3)
<a name="29338"/>29338:                    end},
<a name="29339"/>29339:          #{desc =&gt; &quot;close socket 3&quot;,
<a name="29340"/>29340:            cmd  =&gt; fun(#{sock3 := Sock} = State) -&gt;
<a name="29341"/>29341:                            ok = socket:close(Sock),
<a name="29342"/>29342: 			   {ok, maps:remove(sock3, State)}
<a name="29343"/>29343:                    end},
<a name="29344"/>29344: 
<a name="29345"/>29345:          #{desc =&gt; &quot;await continue (close4)&quot;,
<a name="29346"/>29346:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="29347"/>29347:                            ?SEV_AWAIT_CONTINUE(Tester, tester, close4)
<a name="29348"/>29348:                    end},
<a name="29349"/>29349:          #{desc =&gt; &quot;close socket 4&quot;,
<a name="29350"/>29350:            cmd  =&gt; fun(#{sock4 := Sock} = State) -&gt;
<a name="29351"/>29351:                            ok = socket:close(Sock),
<a name="29352"/>29352: 			   {ok, maps:remove(sock4, State)}
<a name="29353"/>29353:                    end},
<a name="29354"/>29354: 
<a name="29355"/>29355:          #{desc =&gt; &quot;await continue (close5)&quot;,
<a name="29356"/>29356:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="29357"/>29357:                            ?SEV_AWAIT_CONTINUE(Tester, tester, close5)
<a name="29358"/>29358:                    end},
<a name="29359"/>29359:          #{desc =&gt; &quot;close socket 5&quot;,
<a name="29360"/>29360:            cmd  =&gt; fun(#{sock5 := Sock} = State) -&gt;
<a name="29361"/>29361:                            ok = socket:close(Sock),
<a name="29362"/>29362: 			   {ok, maps:remove(sock5, State)}
<a name="29363"/>29363:                    end},
<a name="29364"/>29364: 
<a name="29365"/>29365:          #{desc =&gt; &quot;await terminate (from tester)&quot;,
<a name="29366"/>29366:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="29367"/>29367:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="29368"/>29368:                                ok -&gt;
<a name="29369"/>29369:                                    {ok, maps:remove(tester, State)};
<a name="29370"/>29370:                                {error, _} = ERROR -&gt;
<a name="29371"/>29371:                                    ERROR
<a name="29372"/>29372:                            end
<a name="29373"/>29373:                    end},
<a name="29374"/>29374: 
<a name="29375"/>29375:          %% *** We are done ***
<a name="29376"/>29376:          ?SEV_FINISH_NORMAL
<a name="29377"/>29377:         ],
<a name="29378"/>29378: 
<a name="29379"/>29379:     TesterSeq =
<a name="29380"/>29380:         [
<a name="29381"/>29381:          %% *** Init part ***
<a name="29382"/>29382:          #{desc =&gt; &quot;monitor owner&quot;,
<a name="29383"/>29383:            cmd  =&gt; fun(#{owner := Owner} = _State) -&gt;
<a name="29384"/>29384:                            _MRef = erlang:monitor(process, Owner),
<a name="29385"/>29385:                            ok
<a name="29386"/>29386:                    end},
<a name="29387"/>29387:          #{desc =&gt; &quot;order (owner) start&quot;,
<a name="29388"/>29388:            cmd  =&gt; fun(#{owner := Pid} = _State) -&gt;
<a name="29389"/>29389:                            ?SEV_ANNOUNCE_START(Pid),
<a name="29390"/>29390:                            ok
<a name="29391"/>29391:                    end},
<a name="29392"/>29392:          #{desc =&gt; &quot;await (owner) ready&quot;,
<a name="29393"/>29393:            cmd  =&gt; fun(#{owner := Pid} = State) -&gt;
<a name="29394"/>29394:                            {ok, [Sock1, Sock2, Sock3, Sock4, Sock5]} =
<a name="29395"/>29395: 			       ?SEV_AWAIT_READY(Pid, owner, init),
<a name="29396"/>29396:                            {ok, State#{sock1 =&gt; Sock1,
<a name="29397"/>29397: 				       sock2 =&gt; Sock2,
<a name="29398"/>29398: 				       sock3 =&gt; Sock3,
<a name="29399"/>29399: 				       sock4 =&gt; Sock4,
<a name="29400"/>29400: 				       sock5 =&gt; Sock5}}
<a name="29401"/>29401:                    end},
<a name="29402"/>29402:          #{desc =&gt; &quot;verify total number of monitors (=0)&quot;,
<a name="29403"/>29403:            cmd  =&gt; fun(_State) -&gt;
<a name="29404"/>29404: 			   0 = socket:number_of_monitors(),
<a name="29405"/>29405: 			   ok
<a name="29406"/>29406:                    end},
<a name="29407"/>29407:          #{desc =&gt; &quot;verify own number of monitors (=0)&quot;,
<a name="29408"/>29408:            cmd  =&gt; fun(_State) -&gt;
<a name="29409"/>29409: 			   0 = socket:number_of_monitors(self()),
<a name="29410"/>29410: 			   ok
<a name="29411"/>29411:                    end},
<a name="29412"/>29412:          #{desc =&gt; &quot;monitor socket&quot;,
<a name="29413"/>29413:            cmd  =&gt; fun(#{sock1 := Sock1,
<a name="29414"/>29414: 			 sock2 := Sock2,
<a name="29415"/>29415: 			 sock3 := Sock3,
<a name="29416"/>29416: 			 sock4 := Sock4,
<a name="29417"/>29417: 			 sock5 := Sock5} = State) -&gt;
<a name="29418"/>29418:                            MRef1 = socket:monitor(Sock1),
<a name="29419"/>29419:                            MRef2 = socket:monitor(Sock2),
<a name="29420"/>29420:                            MRef3 = socket:monitor(Sock3),
<a name="29421"/>29421:                            MRef4 = socket:monitor(Sock4),
<a name="29422"/>29422:                            MRef5 = socket:monitor(Sock5),
<a name="29423"/>29423: 			   ?SEV_IPRINT(&quot;Monitors:&quot;
<a name="29424"/>29424: 				       &quot;~n   1: ~p&quot;
<a name="29425"/>29425: 				       &quot;~n   2: ~p&quot;
<a name="29426"/>29426: 				       &quot;~n   3: ~p&quot;
<a name="29427"/>29427: 				       &quot;~n   4: ~p&quot;
<a name="29428"/>29428: 				       &quot;~n   5: ~p&quot;,
<a name="29429"/>29429: 				       [MRef1, MRef2, MRef3, MRef4, MRef5]),
<a name="29430"/>29430: 			   {ok, State#{mon1 =&gt; MRef1,
<a name="29431"/>29431: 				       mon2 =&gt; MRef2,
<a name="29432"/>29432: 				       mon3 =&gt; MRef3,
<a name="29433"/>29433: 				       mon4 =&gt; MRef4,
<a name="29434"/>29434: 				       mon5 =&gt; MRef5}}
<a name="29435"/>29435:                    end},
<a name="29436"/>29436:          #{desc =&gt; &quot;verify total number of monitors (=5)&quot;,
<a name="29437"/>29437:            cmd  =&gt; fun(_State) -&gt;
<a name="29438"/>29438: 			   5 = socket:number_of_monitors(),
<a name="29439"/>29439: 			   ok
<a name="29440"/>29440:                    end},
<a name="29441"/>29441:          #{desc =&gt; &quot;verify own number of monitors (=5)&quot;,
<a name="29442"/>29442:            cmd  =&gt; fun(_State) -&gt;
<a name="29443"/>29443: 			   5 = socket:number_of_monitors(self()),
<a name="29444"/>29444: 			   ok
<a name="29445"/>29445:                    end},
<a name="29446"/>29446: 
<a name="29447"/>29447:          %% The actual test
<a name="29448"/>29448:          #{desc =&gt; &quot;order owner to close socket 1&quot;,
<a name="29449"/>29449:            cmd  =&gt; fun(#{owner := Pid} = _State) -&gt;
<a name="29450"/>29450:                            ?SEV_ANNOUNCE_CONTINUE(Pid, close1),
<a name="29451"/>29451:                            ok
<a name="29452"/>29452:                    end},
<a name="29453"/>29453:          #{desc =&gt; &quot;await socket 1 down&quot;,
<a name="29454"/>29454:            cmd  =&gt; fun(#{sock1 := Sock,
<a name="29455"/>29455: 			 mon1  := MRef} = State) -&gt;
<a name="29456"/>29456: 			   receive
<a name="29457"/>29457: 			       {'DOWN', MRef, socket, Sock, Info} -&gt;
<a name="29458"/>29458: 				   ?SEV_IPRINT(&quot;received expected down: &quot;
<a name="29459"/>29459: 					       &quot;~n      MRef:   ~p&quot;
<a name="29460"/>29460: 					       &quot;~n      Socket: ~s&quot;
<a name="29461"/>29461: 					       &quot;~n      Info:   ~p&quot;,
<a name="29462"/>29462: 					       [MRef,
<a name="29463"/>29463: 						socket:to_list(Sock),
<a name="29464"/>29464: 						Info]),
<a name="29465"/>29465: 				   State2 = maps:remove(sock1, State),
<a name="29466"/>29466: 				   State3 = maps:remove(mon1,  State2),
<a name="29467"/>29467: 				   {ok, State3}
<a name="29468"/>29468: 			   after 5000 -&gt;
<a name="29469"/>29469: 				   ?SEV_EPRINT(&quot;socket down timeout&quot;),
<a name="29470"/>29470: 				   {error, timeout}
<a name="29471"/>29471: 			   end
<a name="29472"/>29472:                    end},
<a name="29473"/>29473:          #{desc =&gt; &quot;verify total number of monitors (=4)&quot;,
<a name="29474"/>29474:            cmd  =&gt; fun(_State) -&gt;
<a name="29475"/>29475: 			   4 = socket:number_of_monitors(),
<a name="29476"/>29476: 			   ok
<a name="29477"/>29477:                    end},
<a name="29478"/>29478:          #{desc =&gt; &quot;verify own number of monitors (=4)&quot;,
<a name="29479"/>29479:            cmd  =&gt; fun(_State) -&gt;
<a name="29480"/>29480: 			   4 = socket:number_of_monitors(self()),
<a name="29481"/>29481: 			   ok
<a name="29482"/>29482:                    end},
<a name="29483"/>29483: 
<a name="29484"/>29484:          #{desc =&gt; &quot;order owner to close socket 2&quot;,
<a name="29485"/>29485:            cmd  =&gt; fun(#{owner := Pid} = _State) -&gt;
<a name="29486"/>29486:                            ?SEV_ANNOUNCE_CONTINUE(Pid, close2),
<a name="29487"/>29487:                            ok
<a name="29488"/>29488:                    end},
<a name="29489"/>29489:          #{desc =&gt; &quot;await socket 2 down&quot;,
<a name="29490"/>29490:            cmd  =&gt; fun(#{sock2 := Sock,
<a name="29491"/>29491: 			 mon2  := MRef} = State) -&gt;
<a name="29492"/>29492: 			   receive
<a name="29493"/>29493: 			       {'DOWN', MRef, socket, Sock, Info} -&gt;
<a name="29494"/>29494: 				   ?SEV_IPRINT(&quot;received expected down: &quot;
<a name="29495"/>29495: 					       &quot;~n      MRef:   ~p&quot;
<a name="29496"/>29496: 					       &quot;~n      Socket: ~s&quot;
<a name="29497"/>29497: 					       &quot;~n      Info:   ~p&quot;,
<a name="29498"/>29498: 					       [MRef,
<a name="29499"/>29499: 						socket:to_list(Sock),
<a name="29500"/>29500: 						Info]),
<a name="29501"/>29501: 				   State2 = maps:remove(sock2, State),
<a name="29502"/>29502: 				   State3 = maps:remove(mon2,  State2),
<a name="29503"/>29503: 				   {ok, State3}
<a name="29504"/>29504: 			   after 5000 -&gt;
<a name="29505"/>29505: 				   ?SEV_EPRINT(&quot;socket down timeout&quot;),
<a name="29506"/>29506: 				   {error, timeout}
<a name="29507"/>29507: 			   end
<a name="29508"/>29508:                    end},
<a name="29509"/>29509:          #{desc =&gt; &quot;verify total number of monitors (=3)&quot;,
<a name="29510"/>29510:            cmd  =&gt; fun(_State) -&gt;
<a name="29511"/>29511: 			   3 = socket:number_of_monitors(),
<a name="29512"/>29512: 			   ok
<a name="29513"/>29513:                    end},
<a name="29514"/>29514:          #{desc =&gt; &quot;verify own number of monitors (=3)&quot;,
<a name="29515"/>29515:            cmd  =&gt; fun(_State) -&gt;
<a name="29516"/>29516: 			   3 = socket:number_of_monitors(self()),
<a name="29517"/>29517: 			   ok
<a name="29518"/>29518:                    end},
<a name="29519"/>29519: 
<a name="29520"/>29520:          #{desc =&gt; &quot;order owner to close socket 3&quot;,
<a name="29521"/>29521:            cmd  =&gt; fun(#{owner := Pid} = _State) -&gt;
<a name="29522"/>29522:                            ?SEV_ANNOUNCE_CONTINUE(Pid, close3),
<a name="29523"/>29523:                            ok
<a name="29524"/>29524:                    end},
<a name="29525"/>29525:          #{desc =&gt; &quot;await socket 3 down&quot;,
<a name="29526"/>29526:            cmd  =&gt; fun(#{sock3 := Sock,
<a name="29527"/>29527: 			 mon3  := MRef} = State) -&gt;
<a name="29528"/>29528: 			   receive
<a name="29529"/>29529: 			       {'DOWN', MRef, socket, Sock, Info} -&gt;
<a name="29530"/>29530: 				   ?SEV_IPRINT(&quot;received expected down: &quot;
<a name="29531"/>29531: 					       &quot;~n      MRef:   ~p&quot;
<a name="29532"/>29532: 					       &quot;~n      Socket: ~s&quot;
<a name="29533"/>29533: 					       &quot;~n      Info:   ~p&quot;,
<a name="29534"/>29534: 					       [MRef,
<a name="29535"/>29535: 						socket:to_list(Sock),
<a name="29536"/>29536: 						Info]),
<a name="29537"/>29537: 				   State2 = maps:remove(sock3, State),
<a name="29538"/>29538: 				   State3 = maps:remove(mon3,  State2),
<a name="29539"/>29539: 				   {ok, State3}
<a name="29540"/>29540: 			   after 5000 -&gt;
<a name="29541"/>29541: 				   ?SEV_EPRINT(&quot;socket down timeout&quot;),
<a name="29542"/>29542: 				   {error, timeout}
<a name="29543"/>29543: 			   end
<a name="29544"/>29544:                    end},
<a name="29545"/>29545:          #{desc =&gt; &quot;verify total number of monitors (=2)&quot;,
<a name="29546"/>29546:            cmd  =&gt; fun(_State) -&gt;
<a name="29547"/>29547: 			   2 = socket:number_of_monitors(),
<a name="29548"/>29548: 			   ok
<a name="29549"/>29549:                    end},
<a name="29550"/>29550:          #{desc =&gt; &quot;verify own number of monitors (=2)&quot;,
<a name="29551"/>29551:            cmd  =&gt; fun(_State) -&gt;
<a name="29552"/>29552: 			   2 = socket:number_of_monitors(self()),
<a name="29553"/>29553: 			   ok
<a name="29554"/>29554:                    end},
<a name="29555"/>29555: 
<a name="29556"/>29556:          #{desc =&gt; &quot;order owner to close socket 4&quot;,
<a name="29557"/>29557:            cmd  =&gt; fun(#{owner := Pid} = _State) -&gt;
<a name="29558"/>29558:                            ?SEV_ANNOUNCE_CONTINUE(Pid, close4),
<a name="29559"/>29559:                            ok
<a name="29560"/>29560:                    end},
<a name="29561"/>29561:          #{desc =&gt; &quot;await socket 4 down&quot;,
<a name="29562"/>29562:            cmd  =&gt; fun(#{sock4 := Sock,
<a name="29563"/>29563: 			 mon4  := MRef} = State) -&gt;
<a name="29564"/>29564: 			   receive
<a name="29565"/>29565: 			       {'DOWN', MRef, socket, Sock, Info} -&gt;
<a name="29566"/>29566: 				   ?SEV_IPRINT(&quot;received expected down: &quot;
<a name="29567"/>29567: 					       &quot;~n      MRef:   ~p&quot;
<a name="29568"/>29568: 					       &quot;~n      Socket: ~p&quot;
<a name="29569"/>29569: 					       &quot;~n      Info:   ~p&quot;,
<a name="29570"/>29570: 					       [MRef, Sock, Info]),
<a name="29571"/>29571: 				   State2 = maps:remove(sock4, State),
<a name="29572"/>29572: 				   State3 = maps:remove(mon4,  State2),
<a name="29573"/>29573: 				   {ok, State3}
<a name="29574"/>29574: 			   after 5000 -&gt;
<a name="29575"/>29575: 				   ?SEV_EPRINT(&quot;socket down timeout&quot;),
<a name="29576"/>29576: 				   {error, timeout}
<a name="29577"/>29577: 			   end
<a name="29578"/>29578:                    end},
<a name="29579"/>29579:          #{desc =&gt; &quot;verify total number of monitors (=1)&quot;,
<a name="29580"/>29580:            cmd  =&gt; fun(_State) -&gt;
<a name="29581"/>29581: 			   1 = socket:number_of_monitors(),
<a name="29582"/>29582: 			   ok
<a name="29583"/>29583:                    end},
<a name="29584"/>29584:          #{desc =&gt; &quot;verify own number of monitors (=1)&quot;,
<a name="29585"/>29585:            cmd  =&gt; fun(_State) -&gt;
<a name="29586"/>29586: 			   1 = socket:number_of_monitors(self()),
<a name="29587"/>29587: 			   ok
<a name="29588"/>29588:                    end},
<a name="29589"/>29589: 
<a name="29590"/>29590:          #{desc =&gt; &quot;order owner to close socket 5&quot;,
<a name="29591"/>29591:            cmd  =&gt; fun(#{owner := Pid} = _State) -&gt;
<a name="29592"/>29592:                            ?SEV_ANNOUNCE_CONTINUE(Pid, close5),
<a name="29593"/>29593:                            ok
<a name="29594"/>29594:                    end},
<a name="29595"/>29595:          #{desc =&gt; &quot;await socket 5 down&quot;,
<a name="29596"/>29596:            cmd  =&gt; fun(#{sock5 := Sock,
<a name="29597"/>29597: 			 mon5  := MRef} = State) -&gt;
<a name="29598"/>29598: 			   receive
<a name="29599"/>29599: 			       {'DOWN', MRef, socket, Sock, Info} -&gt;
<a name="29600"/>29600: 				   ?SEV_IPRINT(&quot;received expected down: &quot;
<a name="29601"/>29601: 					       &quot;~n      MRef:   ~p&quot;
<a name="29602"/>29602: 					       &quot;~n      Socket: ~p&quot;
<a name="29603"/>29603: 					       &quot;~n      Info:   ~p&quot;,
<a name="29604"/>29604: 					       [MRef, Sock, Info]),
<a name="29605"/>29605: 				   State2 = maps:remove(sock5, State),
<a name="29606"/>29606: 				   State3 = maps:remove(mon5,  State2),
<a name="29607"/>29607: 				   {ok, State3}
<a name="29608"/>29608: 			   after 5000 -&gt;
<a name="29609"/>29609: 				   ?SEV_EPRINT(&quot;socket down timeout&quot;),
<a name="29610"/>29610: 				   {error, timeout}
<a name="29611"/>29611: 			   end
<a name="29612"/>29612:                    end},
<a name="29613"/>29613:          #{desc =&gt; &quot;verify total number of monitors (=0)&quot;,
<a name="29614"/>29614:            cmd  =&gt; fun(_State) -&gt;
<a name="29615"/>29615: 			   0 = socket:number_of_monitors(),
<a name="29616"/>29616: 			   ok
<a name="29617"/>29617:                    end},
<a name="29618"/>29618:          #{desc =&gt; &quot;verify own number of monitors (=0)&quot;,
<a name="29619"/>29619:            cmd  =&gt; fun(_State) -&gt;
<a name="29620"/>29620: 			   0 = socket:number_of_monitors(self()),
<a name="29621"/>29621: 			   ok
<a name="29622"/>29622:                    end},
<a name="29623"/>29623: 
<a name="29624"/>29624:          %% Cleanup
<a name="29625"/>29625:          #{desc =&gt; &quot;order (owner) terminate&quot;,
<a name="29626"/>29626:            cmd  =&gt; fun(#{owner := Pid} = _State) -&gt;
<a name="29627"/>29627:                            ?SEV_ANNOUNCE_TERMINATE(Pid),
<a name="29628"/>29628:                            ok
<a name="29629"/>29629:                    end},
<a name="29630"/>29630: 
<a name="29631"/>29631:          #{desc =&gt; &quot;await (owner) termination&quot;,
<a name="29632"/>29632:            cmd  =&gt; fun(#{owner := Pid} = _State) -&gt;
<a name="29633"/>29633:                            case ?SEV_AWAIT_TERMINATION(Pid) of
<a name="29634"/>29634:                                ok -&gt;
<a name="29635"/>29635:                                    ok;
<a name="29636"/>29636:                                {error, _} = ERROR -&gt;
<a name="29637"/>29637:                                    ERROR
<a name="29638"/>29638:                            end
<a name="29639"/>29639:                    end},
<a name="29640"/>29640: 
<a name="29641"/>29641:          %% *** We are done ***
<a name="29642"/>29642:          ?SEV_FINISH_NORMAL
<a name="29643"/>29643:         ],
<a name="29644"/>29644: 
<a name="29645"/>29645:     i(&quot;start (socket) owner evaluator&quot;),
<a name="29646"/>29646:     Owner = ?SEV_START(&quot;owner&quot;, OwnerSeq, InitState),
<a name="29647"/>29647: 
<a name="29648"/>29648:     i(&quot;start tester evaluator&quot;),
<a name="29649"/>29649:     TesterInitState = #{owner =&gt; Owner#ev.pid},
<a name="29650"/>29650:     Tester = ?SEV_START(&quot;tester&quot;, TesterSeq, TesterInitState),
<a name="29651"/>29651: 
<a name="29652"/>29652:     i(&quot;await evaluator&quot;),
<a name="mon_open_and_close_multi_socks-last_expr"/><a name="29653"/>29653: <b>    ok = ?SEV_AWAIT_FINISH</b>([Owner, Tester]).
<a name="29654"/>29654: 
<a name="29655"/>29655: 
<a name="29656"/>29656: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="29657"/>29657: <i>%% Create several sockets, monitor from a different process then exit</i>
<a name="29658"/>29658: <i>%% the owner process.</i>
<a name="29659"/>29659: <i>%% The process that did the monitor shall receive a socket DOWN.</i>
<a name="29660"/>29660: 
<a name="monitor_open_and_exit_multi_socks-1"/><a name="29661"/>29661: <b>monitor_open_and_exit_multi_socks</b>(_Config) when is_list(_Config) -&gt;
<a name="29662"/>29662:     ?TT(?SECS(10)),
<a name="monitor_open_and_exit_multi_socks-last_expr"/><a name="29663"/>29663: <b>    tc_try</b>(monitor_open_and_exit_multi_socks,
<a name="29664"/>29664:            fun() -&gt;
<a name="29665"/>29665: 		   InitState = #{domain   =&gt; inet,
<a name="29666"/>29666:                                  type     =&gt; stream,
<a name="29667"/>29667:                                  protocol =&gt; tcp},
<a name="29668"/>29668:                    ok = mon_open_and_exit_multi_socks(InitState)
<a name="29669"/>29669:            end).
<a name="29670"/>29670: 
<a name="29671"/>29671: 
<a name="mon_open_and_exit_multi_socks-1"/><a name="29672"/>29672: <b>mon_open_and_exit_multi_socks</b>(InitState) -&gt;
<a name="29673"/>29673:     OwnerSeq =
<a name="29674"/>29674:         [
<a name="29675"/>29675:          %% *** Wait for start order part ***
<a name="29676"/>29676:          #{desc =&gt; &quot;await start (from tester)&quot;,
<a name="29677"/>29677:            cmd  =&gt; fun(State) -&gt;
<a name="29678"/>29678:                            Tester = ?SEV_AWAIT_START(),
<a name="29679"/>29679:                            {ok, State#{tester =&gt; Tester}}
<a name="29680"/>29680:                    end},
<a name="29681"/>29681:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="29682"/>29682:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="29683"/>29683:                            _MRef = erlang:monitor(process, Tester),
<a name="29684"/>29684:                            ok
<a name="29685"/>29685:                    end},
<a name="29686"/>29686: 
<a name="29687"/>29687:          %% *** Init part ***
<a name="29688"/>29688:          #{desc =&gt; &quot;create socket 1&quot;,
<a name="29689"/>29689:            cmd  =&gt; fun(#{domain   := Domain, 
<a name="29690"/>29690:                          type     := Type, 
<a name="29691"/>29691:                          protocol := Proto} = State) -&gt;
<a name="29692"/>29692:                            case socket:open(Domain, Type, Proto) of
<a name="29693"/>29693:                                {ok, Sock} -&gt;
<a name="29694"/>29694:                                    {ok, State#{sock1 =&gt; Sock}};
<a name="29695"/>29695:                                {error, _} = ERROR -&gt;
<a name="29696"/>29696:                                    ERROR
<a name="29697"/>29697:                            end
<a name="29698"/>29698:                    end},
<a name="29699"/>29699:          #{desc =&gt; &quot;create socket 2&quot;,
<a name="29700"/>29700:            cmd  =&gt; fun(#{domain   := Domain, 
<a name="29701"/>29701:                          type     := Type, 
<a name="29702"/>29702:                          protocol := Proto} = State) -&gt;
<a name="29703"/>29703:                            case socket:open(Domain, Type, Proto) of
<a name="29704"/>29704:                                {ok, Sock} -&gt;
<a name="29705"/>29705:                                    {ok, State#{sock2 =&gt; Sock}};
<a name="29706"/>29706:                                {error, _} = ERROR -&gt;
<a name="29707"/>29707:                                    ERROR
<a name="29708"/>29708:                            end
<a name="29709"/>29709:                    end},
<a name="29710"/>29710:          #{desc =&gt; &quot;create socket 3&quot;,
<a name="29711"/>29711:            cmd  =&gt; fun(#{domain   := Domain, 
<a name="29712"/>29712:                          type     := Type, 
<a name="29713"/>29713:                          protocol := Proto} = State) -&gt;
<a name="29714"/>29714:                            case socket:open(Domain, Type, Proto) of
<a name="29715"/>29715:                                {ok, Sock} -&gt;
<a name="29716"/>29716:                                    {ok, State#{sock3 =&gt; Sock}};
<a name="29717"/>29717:                                {error, _} = ERROR -&gt;
<a name="29718"/>29718:                                    ERROR
<a name="29719"/>29719:                            end
<a name="29720"/>29720:                    end},
<a name="29721"/>29721:          #{desc =&gt; &quot;create socket 4&quot;,
<a name="29722"/>29722:            cmd  =&gt; fun(#{domain   := Domain, 
<a name="29723"/>29723:                          type     := Type, 
<a name="29724"/>29724:                          protocol := Proto} = State) -&gt;
<a name="29725"/>29725:                            case socket:open(Domain, Type, Proto) of
<a name="29726"/>29726:                                {ok, Sock} -&gt;
<a name="29727"/>29727:                                    {ok, State#{sock4 =&gt; Sock}};
<a name="29728"/>29728:                                {error, _} = ERROR -&gt;
<a name="29729"/>29729:                                    ERROR
<a name="29730"/>29730:                            end
<a name="29731"/>29731:                    end},
<a name="29732"/>29732:          #{desc =&gt; &quot;create socket 5&quot;,
<a name="29733"/>29733:            cmd  =&gt; fun(#{domain   := Domain, 
<a name="29734"/>29734:                          type     := Type, 
<a name="29735"/>29735:                          protocol := Proto} = State) -&gt;
<a name="29736"/>29736:                            case socket:open(Domain, Type, Proto) of
<a name="29737"/>29737:                                {ok, Sock} -&gt;
<a name="29738"/>29738:                                    {ok, State#{sock5 =&gt; Sock}};
<a name="29739"/>29739:                                {error, _} = ERROR -&gt;
<a name="29740"/>29740:                                    ERROR
<a name="29741"/>29741:                            end
<a name="29742"/>29742:                    end},
<a name="29743"/>29743:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="29744"/>29744:            cmd  =&gt; fun(#{tester := Tester,
<a name="29745"/>29745: 			 sock1  := Sock1,
<a name="29746"/>29746: 			 sock2  := Sock2,
<a name="29747"/>29747: 			 sock3  := Sock3,
<a name="29748"/>29748: 			 sock4  := Sock4,
<a name="29749"/>29749: 			 sock5  := Sock5} = _State) -&gt;
<a name="29750"/>29750: 			   Socks = [Sock1, Sock2, Sock3, Sock4, Sock5],
<a name="29751"/>29751:                            ?SEV_ANNOUNCE_READY(Tester, init, Socks),
<a name="29752"/>29752:                            ok
<a name="29753"/>29753:                    end},
<a name="29754"/>29754: 
<a name="29755"/>29755: 
<a name="29756"/>29756:          %% The actual test
<a name="29757"/>29757:          #{desc =&gt; &quot;await terminate (from tester)&quot;,
<a name="29758"/>29758:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="29759"/>29759:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="29760"/>29760:                                ok -&gt;
<a name="29761"/>29761:                                    {ok, maps:remove(tester, State)};
<a name="29762"/>29762:                                {error, _} = ERROR -&gt;
<a name="29763"/>29763:                                    ERROR
<a name="29764"/>29764:                            end
<a name="29765"/>29765:                    end},
<a name="29766"/>29766: 
<a name="29767"/>29767:          %% *** We are done ***
<a name="29768"/>29768:          ?SEV_FINISH_NORMAL
<a name="29769"/>29769:         ],
<a name="29770"/>29770: 
<a name="29771"/>29771:     TesterSeq =
<a name="29772"/>29772:         [
<a name="29773"/>29773:          %% *** Init part ***
<a name="29774"/>29774:          #{desc =&gt; &quot;monitor owner&quot;,
<a name="29775"/>29775:            cmd  =&gt; fun(#{owner := Owner} = _State) -&gt;
<a name="29776"/>29776:                            _MRef = erlang:monitor(process, Owner),
<a name="29777"/>29777:                            ok
<a name="29778"/>29778:                    end},
<a name="29779"/>29779:          #{desc =&gt; &quot;order (owner) start&quot;,
<a name="29780"/>29780:            cmd  =&gt; fun(#{owner := Pid} = _State) -&gt;
<a name="29781"/>29781:                            ?SEV_ANNOUNCE_START(Pid),
<a name="29782"/>29782:                            ok
<a name="29783"/>29783:                    end},
<a name="29784"/>29784:          #{desc =&gt; &quot;await (owner) ready&quot;,
<a name="29785"/>29785:            cmd  =&gt; fun(#{owner := Pid} = State) -&gt;
<a name="29786"/>29786:                            {ok, [Sock1, Sock2, Sock3, Sock4, Sock5]} =
<a name="29787"/>29787: 			       ?SEV_AWAIT_READY(Pid, owner, init),
<a name="29788"/>29788:                            {ok, State#{sock1 =&gt; Sock1,
<a name="29789"/>29789: 				       sock2 =&gt; Sock2,
<a name="29790"/>29790: 				       sock3 =&gt; Sock3,
<a name="29791"/>29791: 				       sock4 =&gt; Sock4,
<a name="29792"/>29792: 				       sock5 =&gt; Sock5}}
<a name="29793"/>29793:                    end},
<a name="29794"/>29794:          #{desc =&gt; &quot;verify total number of monitors (=0)&quot;,
<a name="29795"/>29795:            cmd  =&gt; fun(_State) -&gt;
<a name="29796"/>29796: 			   0 = socket:number_of_monitors(),
<a name="29797"/>29797: 			   ok
<a name="29798"/>29798:                    end},
<a name="29799"/>29799:          #{desc =&gt; &quot;verify own number of monitors (=0)&quot;,
<a name="29800"/>29800:            cmd  =&gt; fun(_State) -&gt;
<a name="29801"/>29801: 			   0 = socket:number_of_monitors(self()),
<a name="29802"/>29802: 			   ok
<a name="29803"/>29803:                    end},
<a name="29804"/>29804:          #{desc =&gt; &quot;monitor socket&quot;,
<a name="29805"/>29805:            cmd  =&gt; fun(#{sock1 := Sock1,
<a name="29806"/>29806: 			 sock2 := Sock2,
<a name="29807"/>29807: 			 sock3 := Sock3,
<a name="29808"/>29808: 			 sock4 := Sock4,
<a name="29809"/>29809: 			 sock5 := Sock5} = State) -&gt;
<a name="29810"/>29810:                            MRef1 = socket:monitor(Sock1),
<a name="29811"/>29811:                            MRef2 = socket:monitor(Sock2),
<a name="29812"/>29812:                            MRef3 = socket:monitor(Sock3),
<a name="29813"/>29813:                            MRef4 = socket:monitor(Sock4),
<a name="29814"/>29814:                            MRef5 = socket:monitor(Sock5),
<a name="29815"/>29815: 			   ?SEV_IPRINT(&quot;Monitors:&quot;
<a name="29816"/>29816: 				       &quot;~n   1: ~p&quot;
<a name="29817"/>29817: 				       &quot;~n   2: ~p&quot;
<a name="29818"/>29818: 				       &quot;~n   3: ~p&quot;
<a name="29819"/>29819: 				       &quot;~n   4: ~p&quot;
<a name="29820"/>29820: 				       &quot;~n   5: ~p&quot;,
<a name="29821"/>29821: 				       [MRef1, MRef2, MRef3, MRef4, MRef5]),
<a name="29822"/>29822: 			   {ok, State#{mon1 =&gt; MRef1,
<a name="29823"/>29823: 				       mon2 =&gt; MRef2,
<a name="29824"/>29824: 				       mon3 =&gt; MRef3,
<a name="29825"/>29825: 				       mon4 =&gt; MRef4,
<a name="29826"/>29826: 				       mon5 =&gt; MRef5}}
<a name="29827"/>29827:                    end},
<a name="29828"/>29828:          #{desc =&gt; &quot;verify total number of monitors (=5)&quot;,
<a name="29829"/>29829:            cmd  =&gt; fun(_State) -&gt;
<a name="29830"/>29830: 			   5 = socket:number_of_monitors(),
<a name="29831"/>29831: 			   ok
<a name="29832"/>29832:                    end},
<a name="29833"/>29833:          #{desc =&gt; &quot;verify own number of monitors (=5)&quot;,
<a name="29834"/>29834:            cmd  =&gt; fun(_State) -&gt;
<a name="29835"/>29835: 			   5 = socket:number_of_monitors(self()),
<a name="29836"/>29836: 			   ok
<a name="29837"/>29837:                    end},
<a name="29838"/>29838: 
<a name="29839"/>29839:          %% The actual test
<a name="29840"/>29840:          #{desc =&gt; &quot;order (owner) terminate&quot;,
<a name="29841"/>29841:            cmd  =&gt; fun(#{owner := Pid} = _State) -&gt;
<a name="29842"/>29842:                            ?SEV_ANNOUNCE_TERMINATE(Pid),
<a name="29843"/>29843:                            ok
<a name="29844"/>29844:                    end},
<a name="29845"/>29845: 
<a name="29846"/>29846:          #{desc =&gt; &quot;await (owner) termination&quot;,
<a name="29847"/>29847:            cmd  =&gt; fun(#{owner := Pid} = _State) -&gt;
<a name="29848"/>29848:                            case ?SEV_AWAIT_TERMINATION(Pid) of
<a name="29849"/>29849:                                ok -&gt;
<a name="29850"/>29850:                                    ok;
<a name="29851"/>29851:                                {error, _} = ERROR -&gt;
<a name="29852"/>29852:                                    ERROR
<a name="29853"/>29853:                            end
<a name="29854"/>29854:                    end},
<a name="29855"/>29855: 
<a name="29856"/>29856:          #{desc =&gt; &quot;await socket 1 down&quot;,
<a name="29857"/>29857:            cmd  =&gt; fun(#{sock1 := Sock,
<a name="29858"/>29858: 			 mon1  := MRef} = State) -&gt;
<a name="29859"/>29859: 			   receive
<a name="29860"/>29860: 			       {'DOWN', MRef, socket, Sock, Info} -&gt;
<a name="29861"/>29861: 				   ?SEV_IPRINT(&quot;received expected down: &quot;
<a name="29862"/>29862: 					       &quot;~n      MRef:   ~p&quot;
<a name="29863"/>29863: 					       &quot;~n      Socket: ~p&quot;
<a name="29864"/>29864: 					       &quot;~n      Info:   ~p&quot;,
<a name="29865"/>29865: 					       [MRef, Sock, Info]),
<a name="29866"/>29866: 				   State2 = maps:remove(sock1, State),
<a name="29867"/>29867: 				   State3 = maps:remove(mon1,  State2),
<a name="29868"/>29868: 				   {ok, State3}
<a name="29869"/>29869: 			   after 5000 -&gt;
<a name="29870"/>29870: 				   ?SEV_EPRINT(&quot;socket down timeout&quot;),
<a name="29871"/>29871: 				   {error, timeout}
<a name="29872"/>29872: 			   end
<a name="29873"/>29873:                    end},
<a name="29874"/>29874:          #{desc =&gt; &quot;await socket 2 down&quot;,
<a name="29875"/>29875:            cmd  =&gt; fun(#{sock2 := Sock,
<a name="29876"/>29876: 			 mon2  := MRef} = State) -&gt;
<a name="29877"/>29877: 			   receive
<a name="29878"/>29878: 			       {'DOWN', MRef, socket, Sock, Info} -&gt;
<a name="29879"/>29879: 				   ?SEV_IPRINT(&quot;received expected down: &quot;
<a name="29880"/>29880: 					       &quot;~n      MRef:   ~p&quot;
<a name="29881"/>29881: 					       &quot;~n      Socket: ~p&quot;
<a name="29882"/>29882: 					       &quot;~n      Info:   ~p&quot;,
<a name="29883"/>29883: 					       [MRef, Sock, Info]),
<a name="29884"/>29884: 				   State2 = maps:remove(sock2, State),
<a name="29885"/>29885: 				   State3 = maps:remove(mon2,  State2),
<a name="29886"/>29886: 				   {ok, State3}
<a name="29887"/>29887: 			   after 5000 -&gt;
<a name="29888"/>29888: 				   ?SEV_EPRINT(&quot;socket down timeout&quot;),
<a name="29889"/>29889: 				   {error, timeout}
<a name="29890"/>29890: 			   end
<a name="29891"/>29891:                    end},
<a name="29892"/>29892:          #{desc =&gt; &quot;await socket 3 down&quot;,
<a name="29893"/>29893:            cmd  =&gt; fun(#{sock3 := Sock,
<a name="29894"/>29894: 			 mon3  := MRef} = State) -&gt;
<a name="29895"/>29895: 			   receive
<a name="29896"/>29896: 			       {'DOWN', MRef, socket, Sock, Info} -&gt;
<a name="29897"/>29897: 				   ?SEV_IPRINT(&quot;received expected down: &quot;
<a name="29898"/>29898: 					       &quot;~n      MRef:   ~p&quot;
<a name="29899"/>29899: 					       &quot;~n      Socket: ~p&quot;
<a name="29900"/>29900: 					       &quot;~n      Info:   ~p&quot;,
<a name="29901"/>29901: 					       [MRef, Sock, Info]),
<a name="29902"/>29902: 				   State2 = maps:remove(sock3, State),
<a name="29903"/>29903: 				   State3 = maps:remove(mon3,  State2),
<a name="29904"/>29904: 				   {ok, State3}
<a name="29905"/>29905: 			   after 5000 -&gt;
<a name="29906"/>29906: 				   ?SEV_EPRINT(&quot;socket down timeout&quot;),
<a name="29907"/>29907: 				   {error, timeout}
<a name="29908"/>29908: 			   end
<a name="29909"/>29909:                    end},
<a name="29910"/>29910:          #{desc =&gt; &quot;await socket 4 down&quot;,
<a name="29911"/>29911:            cmd  =&gt; fun(#{sock4 := Sock,
<a name="29912"/>29912: 			 mon4  := MRef} = State) -&gt;
<a name="29913"/>29913: 			   receive
<a name="29914"/>29914: 			       {'DOWN', MRef, socket, Sock, Info} -&gt;
<a name="29915"/>29915: 				   ?SEV_IPRINT(&quot;received expected down: &quot;
<a name="29916"/>29916: 					       &quot;~n      MRef:   ~p&quot;
<a name="29917"/>29917: 					       &quot;~n      Socket: ~p&quot;
<a name="29918"/>29918: 					       &quot;~n      Info:   ~p&quot;,
<a name="29919"/>29919: 					       [MRef, Sock, Info]),
<a name="29920"/>29920: 				   State2 = maps:remove(sock4, State),
<a name="29921"/>29921: 				   State3 = maps:remove(mon4,  State2),
<a name="29922"/>29922: 				   {ok, State3}
<a name="29923"/>29923: 			   after 5000 -&gt;
<a name="29924"/>29924: 				   ?SEV_EPRINT(&quot;socket down timeout&quot;),
<a name="29925"/>29925: 				   {error, timeout}
<a name="29926"/>29926: 			   end
<a name="29927"/>29927:                    end},
<a name="29928"/>29928:          #{desc =&gt; &quot;await socket 5 down&quot;,
<a name="29929"/>29929:            cmd  =&gt; fun(#{sock5 := Sock,
<a name="29930"/>29930: 			 mon5  := MRef} = State) -&gt;
<a name="29931"/>29931: 			   receive
<a name="29932"/>29932: 			       {'DOWN', MRef, socket, Sock, Info} -&gt;
<a name="29933"/>29933: 				   ?SEV_IPRINT(&quot;received expected down: &quot;
<a name="29934"/>29934: 					       &quot;~n      MRef:   ~p&quot;
<a name="29935"/>29935: 					       &quot;~n      Socket: ~p&quot;
<a name="29936"/>29936: 					       &quot;~n      Info:   ~p&quot;,
<a name="29937"/>29937: 					       [MRef, Sock, Info]),
<a name="29938"/>29938: 				   State2 = maps:remove(sock5, State),
<a name="29939"/>29939: 				   State3 = maps:remove(mon5,  State2),
<a name="29940"/>29940: 				   {ok, State3}
<a name="29941"/>29941: 			   after 5000 -&gt;
<a name="29942"/>29942: 				   ?SEV_EPRINT(&quot;socket down timeout&quot;),
<a name="29943"/>29943: 				   {error, timeout}
<a name="29944"/>29944: 			   end
<a name="29945"/>29945:                    end},
<a name="29946"/>29946:          #{desc =&gt; &quot;verify total number of monitors (=0)&quot;,
<a name="29947"/>29947:            cmd  =&gt; fun(_State) -&gt;
<a name="29948"/>29948: 			   0 = socket:number_of_monitors(),
<a name="29949"/>29949: 			   ok
<a name="29950"/>29950:                    end},
<a name="29951"/>29951:          #{desc =&gt; &quot;verify own number of monitors (=0)&quot;,
<a name="29952"/>29952:            cmd  =&gt; fun(_State) -&gt;
<a name="29953"/>29953: 			   0 = socket:number_of_monitors(self()),
<a name="29954"/>29954: 			   ok
<a name="29955"/>29955:                    end},
<a name="29956"/>29956: 
<a name="29957"/>29957:          %% *** We are done ***
<a name="29958"/>29958:          ?SEV_FINISH_NORMAL
<a name="29959"/>29959:         ],
<a name="29960"/>29960: 
<a name="29961"/>29961:     i(&quot;start (socket) owner evaluator&quot;),
<a name="29962"/>29962:     Owner = ?SEV_START(&quot;owner&quot;, OwnerSeq, InitState),
<a name="29963"/>29963: 
<a name="29964"/>29964:     i(&quot;start tester evaluator&quot;),
<a name="29965"/>29965:     TesterInitState = #{owner =&gt; Owner#ev.pid},
<a name="29966"/>29966:     Tester = ?SEV_START(&quot;tester&quot;, TesterSeq, TesterInitState),
<a name="29967"/>29967: 
<a name="29968"/>29968:     i(&quot;await evaluator&quot;),
<a name="mon_open_and_exit_multi_socks-last_expr"/><a name="29969"/>29969: <b>    ok = ?SEV_AWAIT_FINISH</b>([Owner, Tester]).
<a name="29970"/>29970: 
<a name="29971"/>29971: 
<a name="29972"/>29972: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="29973"/>29973: <i>%% Create several sockets, monitor from a different process, demonitor</i>
<a name="29974"/>29974: <i>%% two of them then close socket.</i>
<a name="29975"/>29975: <i>%% The process that did the monitor shall receive a socket DOWN for</i>
<a name="29976"/>29976: <i>%% the sockets that are still monitored.</i>
<a name="29977"/>29977: 
<a name="monitor_open_and_demon_and_close_multi_socks-1"/><a name="29978"/>29978: <b>monitor_open_and_demon_and_close_multi_socks</b>(_Config) when is_list(_Config) -&gt;
<a name="29979"/>29979:     ?TT(?SECS(10)),
<a name="monitor_open_and_demon_and_close_multi_socks-last_expr"/><a name="29980"/>29980: <b>    tc_try</b>(monitor_open_and_demon_and_close_multi_socks,
<a name="29981"/>29981:            fun() -&gt;
<a name="29982"/>29982: 		   InitState = #{domain   =&gt; inet,
<a name="29983"/>29983:                                  type     =&gt; stream,
<a name="29984"/>29984:                                  protocol =&gt; tcp},
<a name="29985"/>29985:                    ok = mon_open_and_demon_and_close_multi_socks(InitState)
<a name="29986"/>29986:            end).
<a name="29987"/>29987: 
<a name="29988"/>29988: 
<a name="mon_open_and_demon_and_close_multi_socks-1"/><a name="29989"/>29989: <b>mon_open_and_demon_and_close_multi_socks</b>(InitState) -&gt;
<a name="29990"/>29990:     OwnerSeq =
<a name="29991"/>29991:         [
<a name="29992"/>29992:          %% *** Wait for start order part ***
<a name="29993"/>29993:          #{desc =&gt; &quot;await start (from tester)&quot;,
<a name="29994"/>29994:            cmd  =&gt; fun(State) -&gt;
<a name="29995"/>29995:                            Tester = ?SEV_AWAIT_START(),
<a name="29996"/>29996:                            {ok, State#{tester =&gt; Tester}}
<a name="29997"/>29997:                    end},
<a name="29998"/>29998:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="29999"/>29999:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="30000"/>30000:                            _MRef = erlang:monitor(process, Tester),
<a name="30001"/>30001:                            ok
<a name="30002"/>30002:                    end},
<a name="30003"/>30003: 
<a name="30004"/>30004:          %% *** Init part ***
<a name="30005"/>30005:          #{desc =&gt; &quot;create socket 1&quot;,
<a name="30006"/>30006:            cmd  =&gt; fun(#{domain   := Domain, 
<a name="30007"/>30007:                          type     := Type, 
<a name="30008"/>30008:                          protocol := Proto} = State) -&gt;
<a name="30009"/>30009:                            case socket:open(Domain, Type, Proto) of
<a name="30010"/>30010:                                {ok, Sock} -&gt;
<a name="30011"/>30011:                                    {ok, State#{sock1 =&gt; Sock}};
<a name="30012"/>30012:                                {error, _} = ERROR -&gt;
<a name="30013"/>30013:                                    ERROR
<a name="30014"/>30014:                            end
<a name="30015"/>30015:                    end},
<a name="30016"/>30016:          #{desc =&gt; &quot;create socket 2&quot;,
<a name="30017"/>30017:            cmd  =&gt; fun(#{domain   := Domain, 
<a name="30018"/>30018:                          type     := Type, 
<a name="30019"/>30019:                          protocol := Proto} = State) -&gt;
<a name="30020"/>30020:                            case socket:open(Domain, Type, Proto) of
<a name="30021"/>30021:                                {ok, Sock} -&gt;
<a name="30022"/>30022:                                    {ok, State#{sock2 =&gt; Sock}};
<a name="30023"/>30023:                                {error, _} = ERROR -&gt;
<a name="30024"/>30024:                                    ERROR
<a name="30025"/>30025:                            end
<a name="30026"/>30026:                    end},
<a name="30027"/>30027:          #{desc =&gt; &quot;create socket 3&quot;,
<a name="30028"/>30028:            cmd  =&gt; fun(#{domain   := Domain, 
<a name="30029"/>30029:                          type     := Type, 
<a name="30030"/>30030:                          protocol := Proto} = State) -&gt;
<a name="30031"/>30031:                            case socket:open(Domain, Type, Proto) of
<a name="30032"/>30032:                                {ok, Sock} -&gt;
<a name="30033"/>30033:                                    {ok, State#{sock3 =&gt; Sock}};
<a name="30034"/>30034:                                {error, _} = ERROR -&gt;
<a name="30035"/>30035:                                    ERROR
<a name="30036"/>30036:                            end
<a name="30037"/>30037:                    end},
<a name="30038"/>30038:          #{desc =&gt; &quot;create socket 4&quot;,
<a name="30039"/>30039:            cmd  =&gt; fun(#{domain   := Domain, 
<a name="30040"/>30040:                          type     := Type, 
<a name="30041"/>30041:                          protocol := Proto} = State) -&gt;
<a name="30042"/>30042:                            case socket:open(Domain, Type, Proto) of
<a name="30043"/>30043:                                {ok, Sock} -&gt;
<a name="30044"/>30044:                                    {ok, State#{sock4 =&gt; Sock}};
<a name="30045"/>30045:                                {error, _} = ERROR -&gt;
<a name="30046"/>30046:                                    ERROR
<a name="30047"/>30047:                            end
<a name="30048"/>30048:                    end},
<a name="30049"/>30049:          #{desc =&gt; &quot;create socket 5&quot;,
<a name="30050"/>30050:            cmd  =&gt; fun(#{domain   := Domain, 
<a name="30051"/>30051:                          type     := Type, 
<a name="30052"/>30052:                          protocol := Proto} = State) -&gt;
<a name="30053"/>30053:                            case socket:open(Domain, Type, Proto) of
<a name="30054"/>30054:                                {ok, Sock} -&gt;
<a name="30055"/>30055:                                    {ok, State#{sock5 =&gt; Sock}};
<a name="30056"/>30056:                                {error, _} = ERROR -&gt;
<a name="30057"/>30057:                                    ERROR
<a name="30058"/>30058:                            end
<a name="30059"/>30059:                    end},
<a name="30060"/>30060:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="30061"/>30061:            cmd  =&gt; fun(#{tester := Tester,
<a name="30062"/>30062: 			 sock1  := Sock1,
<a name="30063"/>30063: 			 sock2  := Sock2,
<a name="30064"/>30064: 			 sock3  := Sock3,
<a name="30065"/>30065: 			 sock4  := Sock4,
<a name="30066"/>30066: 			 sock5  := Sock5} = _State) -&gt;
<a name="30067"/>30067: 			   Socks = [Sock1, Sock2, Sock3, Sock4, Sock5],
<a name="30068"/>30068:                            ?SEV_ANNOUNCE_READY(Tester, init, Socks),
<a name="30069"/>30069:                            ok
<a name="30070"/>30070:                    end},
<a name="30071"/>30071: 
<a name="30072"/>30072:          %% The actual test
<a name="30073"/>30073:          #{desc =&gt; &quot;await continue (close1)&quot;,
<a name="30074"/>30074:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="30075"/>30075:                            ?SEV_AWAIT_CONTINUE(Tester, tester, close1)
<a name="30076"/>30076:                    end},
<a name="30077"/>30077:          #{desc =&gt; &quot;close socket 1&quot;,
<a name="30078"/>30078:            cmd  =&gt; fun(#{sock1 := Sock} = State) -&gt;
<a name="30079"/>30079:                            ok = socket:close(Sock),
<a name="30080"/>30080: 			   {ok, maps:remove(sock1, State)}
<a name="30081"/>30081:                    end},
<a name="30082"/>30082: 
<a name="30083"/>30083:          #{desc =&gt; &quot;await continue (close3)&quot;,
<a name="30084"/>30084:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="30085"/>30085:                            ?SEV_AWAIT_CONTINUE(Tester, tester, close3)
<a name="30086"/>30086:                    end},
<a name="30087"/>30087:          #{desc =&gt; &quot;close socket 3&quot;,
<a name="30088"/>30088:            cmd  =&gt; fun(#{sock3 := Sock} = State) -&gt;
<a name="30089"/>30089:                            ok = socket:close(Sock),
<a name="30090"/>30090: 			   {ok, maps:remove(sock3, State)}
<a name="30091"/>30091:                    end},
<a name="30092"/>30092: 
<a name="30093"/>30093:          #{desc =&gt; &quot;await continue (close5)&quot;,
<a name="30094"/>30094:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="30095"/>30095:                            ?SEV_AWAIT_CONTINUE(Tester, tester, close5)
<a name="30096"/>30096:                    end},
<a name="30097"/>30097:          #{desc =&gt; &quot;close socket 5&quot;,
<a name="30098"/>30098:            cmd  =&gt; fun(#{sock5 := Sock} = State) -&gt;
<a name="30099"/>30099:                            ok = socket:close(Sock),
<a name="30100"/>30100: 			   {ok, maps:remove(sock5, State)}
<a name="30101"/>30101:                    end},
<a name="30102"/>30102: 
<a name="30103"/>30103:          #{desc =&gt; &quot;await terminate (from tester)&quot;,
<a name="30104"/>30104:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="30105"/>30105:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="30106"/>30106:                                ok -&gt;
<a name="30107"/>30107:                                    {ok, maps:remove(tester, State)};
<a name="30108"/>30108:                                {error, _} = ERROR -&gt;
<a name="30109"/>30109:                                    ERROR
<a name="30110"/>30110:                            end
<a name="30111"/>30111:                    end},
<a name="30112"/>30112: 
<a name="30113"/>30113:          %% *** We are done ***
<a name="30114"/>30114:          ?SEV_FINISH_NORMAL
<a name="30115"/>30115:         ],
<a name="30116"/>30116: 
<a name="30117"/>30117:     TesterSeq =
<a name="30118"/>30118:         [
<a name="30119"/>30119:          %% *** Init part ***
<a name="30120"/>30120:          #{desc =&gt; &quot;monitor owner&quot;,
<a name="30121"/>30121:            cmd  =&gt; fun(#{owner := Owner} = _State) -&gt;
<a name="30122"/>30122:                            _MRef = erlang:monitor(process, Owner),
<a name="30123"/>30123:                            ok
<a name="30124"/>30124:                    end},
<a name="30125"/>30125:          #{desc =&gt; &quot;order (owner) start&quot;,
<a name="30126"/>30126:            cmd  =&gt; fun(#{owner := Pid} = _State) -&gt;
<a name="30127"/>30127:                            ?SEV_ANNOUNCE_START(Pid),
<a name="30128"/>30128:                            ok
<a name="30129"/>30129:                    end},
<a name="30130"/>30130:          #{desc =&gt; &quot;await (owner) ready&quot;,
<a name="30131"/>30131:            cmd  =&gt; fun(#{owner := Pid} = State) -&gt;
<a name="30132"/>30132:                            {ok, [Sock1, Sock2, Sock3, Sock4, Sock5]} =
<a name="30133"/>30133: 			       ?SEV_AWAIT_READY(Pid, owner, init),
<a name="30134"/>30134:                            {ok, State#{sock1 =&gt; Sock1,
<a name="30135"/>30135: 				       sock2 =&gt; Sock2,
<a name="30136"/>30136: 				       sock3 =&gt; Sock3,
<a name="30137"/>30137: 				       sock4 =&gt; Sock4,
<a name="30138"/>30138: 				       sock5 =&gt; Sock5}}
<a name="30139"/>30139:                    end},
<a name="30140"/>30140:          #{desc =&gt; &quot;verify total number of monitors (=0)&quot;,
<a name="30141"/>30141:            cmd  =&gt; fun(_State) -&gt;
<a name="30142"/>30142: 			   0 = socket:number_of_monitors(),
<a name="30143"/>30143: 			   ok
<a name="30144"/>30144:                    end},
<a name="30145"/>30145:          #{desc =&gt; &quot;verify own number of monitors (=0)&quot;,
<a name="30146"/>30146:            cmd  =&gt; fun(_State) -&gt;
<a name="30147"/>30147: 			   0 = socket:number_of_monitors(self()),
<a name="30148"/>30148: 			   ok
<a name="30149"/>30149:                    end},
<a name="30150"/>30150:          #{desc =&gt; &quot;monitor socket&quot;,
<a name="30151"/>30151:            cmd  =&gt; fun(#{sock1 := Sock1,
<a name="30152"/>30152: 			 sock2 := Sock2,
<a name="30153"/>30153: 			 sock3 := Sock3,
<a name="30154"/>30154: 			 sock4 := Sock4,
<a name="30155"/>30155: 			 sock5 := Sock5} = State) -&gt;
<a name="30156"/>30156:                            MRef1 = socket:monitor(Sock1),
<a name="30157"/>30157:                            MRef2 = socket:monitor(Sock2),
<a name="30158"/>30158:                            MRef3 = socket:monitor(Sock3),
<a name="30159"/>30159:                            MRef4 = socket:monitor(Sock4),
<a name="30160"/>30160:                            MRef5 = socket:monitor(Sock5),
<a name="30161"/>30161: 			   ?SEV_IPRINT(&quot;Monitors:&quot;
<a name="30162"/>30162: 				       &quot;~n   1: ~p&quot;
<a name="30163"/>30163: 				       &quot;~n   2: ~p&quot;
<a name="30164"/>30164: 				       &quot;~n   3: ~p&quot;
<a name="30165"/>30165: 				       &quot;~n   4: ~p&quot;
<a name="30166"/>30166: 				       &quot;~n   5: ~p&quot;,
<a name="30167"/>30167: 				       [MRef1, MRef2, MRef3, MRef4, MRef5]),
<a name="30168"/>30168: 			   {ok, State#{mon1 =&gt; MRef1,
<a name="30169"/>30169: 				       mon2 =&gt; MRef2,
<a name="30170"/>30170: 				       mon3 =&gt; MRef3,
<a name="30171"/>30171: 				       mon4 =&gt; MRef4,
<a name="30172"/>30172: 				       mon5 =&gt; MRef5}}
<a name="30173"/>30173:                    end},
<a name="30174"/>30174:          #{desc =&gt; &quot;verify total number of monitors (=5)&quot;,
<a name="30175"/>30175:            cmd  =&gt; fun(_State) -&gt;
<a name="30176"/>30176: 			   5 = socket:number_of_monitors(),
<a name="30177"/>30177: 			   ok
<a name="30178"/>30178:                    end},
<a name="30179"/>30179:          #{desc =&gt; &quot;verify own number of monitors (=5)&quot;,
<a name="30180"/>30180:            cmd  =&gt; fun(_State) -&gt;
<a name="30181"/>30181: 			   5 = socket:number_of_monitors(self()),
<a name="30182"/>30182: 			   ok
<a name="30183"/>30183:                    end},
<a name="30184"/>30184: 
<a name="30185"/>30185:          %% The actual test
<a name="30186"/>30186:          #{desc =&gt; &quot;demonitor socket(s)&quot;,
<a name="30187"/>30187:            cmd  =&gt; fun(#{mon2 := MRef2,
<a name="30188"/>30188: 			 mon4 := MRef4} = State) -&gt;
<a name="30189"/>30189:                            true = socket:cancel_monitor(MRef2),
<a name="30190"/>30190:                            true = socket:cancel_monitor(MRef4),
<a name="30191"/>30191: 			   ?SEV_IPRINT(&quot;cancel socket monitor 2 and 4&quot;),
<a name="30192"/>30192: 			   State2 = maps:remove(mon2,  State),
<a name="30193"/>30193: 			   State3 = maps:remove(sock2, State2),
<a name="30194"/>30194: 			   State4 = maps:remove(mon4,  State3),
<a name="30195"/>30195: 			   State5 = maps:remove(sock4, State4),
<a name="30196"/>30196: 			   {ok, State5}
<a name="30197"/>30197:                    end},
<a name="30198"/>30198:          #{desc =&gt; &quot;verify total number of monitors (=3)&quot;,
<a name="30199"/>30199:            cmd  =&gt; fun(_State) -&gt;
<a name="30200"/>30200: 			   3 = socket:number_of_monitors(),
<a name="30201"/>30201: 			   ok
<a name="30202"/>30202:                    end},
<a name="30203"/>30203:          #{desc =&gt; &quot;verify own number of monitors (=3)&quot;,
<a name="30204"/>30204:            cmd  =&gt; fun(_State) -&gt;
<a name="30205"/>30205: 			   3 = socket:number_of_monitors(self()),
<a name="30206"/>30206: 			   ok
<a name="30207"/>30207:                    end},
<a name="30208"/>30208:          #{desc =&gt; &quot;order owner to close socket 1&quot;,
<a name="30209"/>30209:            cmd  =&gt; fun(#{owner := Pid} = _State) -&gt;
<a name="30210"/>30210:                            ?SEV_ANNOUNCE_CONTINUE(Pid, close1),
<a name="30211"/>30211:                            ok
<a name="30212"/>30212:                    end},
<a name="30213"/>30213:          #{desc =&gt; &quot;await socket 1 down&quot;,
<a name="30214"/>30214:            cmd  =&gt; fun(#{sock1 := Sock,
<a name="30215"/>30215: 			 mon1  := MRef} = State) -&gt;
<a name="30216"/>30216: 			   receive
<a name="30217"/>30217: 			       {'DOWN', MRef, socket, Sock, Info} -&gt;
<a name="30218"/>30218: 				   ?SEV_IPRINT(&quot;received expected down: &quot;
<a name="30219"/>30219: 					       &quot;~n      MRef:   ~p&quot;
<a name="30220"/>30220: 					       &quot;~n      Socket: ~p&quot;
<a name="30221"/>30221: 					       &quot;~n      Info:   ~p&quot;,
<a name="30222"/>30222: 					       [MRef, Sock, Info]),
<a name="30223"/>30223: 				   State2 = maps:remove(sock1, State),
<a name="30224"/>30224: 				   State3 = maps:remove(mon1,  State2),
<a name="30225"/>30225: 				   {ok, State3}
<a name="30226"/>30226: 			   after 5000 -&gt;
<a name="30227"/>30227: 				   ?SEV_EPRINT(&quot;socket down timeout&quot;),
<a name="30228"/>30228: 				   {error, timeout}
<a name="30229"/>30229: 			   end
<a name="30230"/>30230:                    end},
<a name="30231"/>30231:          #{desc =&gt; &quot;verify total number of monitors (=2)&quot;,
<a name="30232"/>30232:            cmd  =&gt; fun(_State) -&gt;
<a name="30233"/>30233: 			   2 = socket:number_of_monitors(),
<a name="30234"/>30234: 			   ok
<a name="30235"/>30235:                    end},
<a name="30236"/>30236:          #{desc =&gt; &quot;verify own number of monitors (=2)&quot;,
<a name="30237"/>30237:            cmd  =&gt; fun(_State) -&gt;
<a name="30238"/>30238: 			   2 = socket:number_of_monitors(self()),
<a name="30239"/>30239: 			   ok
<a name="30240"/>30240:                    end},
<a name="30241"/>30241: 
<a name="30242"/>30242:          #{desc =&gt; &quot;order owner to close socket 3&quot;,
<a name="30243"/>30243:            cmd  =&gt; fun(#{owner := Pid} = _State) -&gt;
<a name="30244"/>30244:                            ?SEV_ANNOUNCE_CONTINUE(Pid, close3),
<a name="30245"/>30245:                            ok
<a name="30246"/>30246:                    end},
<a name="30247"/>30247:          #{desc =&gt; &quot;await socket 3 down&quot;,
<a name="30248"/>30248:            cmd  =&gt; fun(#{sock3 := Sock,
<a name="30249"/>30249: 			 mon3  := MRef} = State) -&gt;
<a name="30250"/>30250: 			   receive
<a name="30251"/>30251: 			       {'DOWN', MRef, socket, Sock, Info} -&gt;
<a name="30252"/>30252: 				   ?SEV_IPRINT(&quot;received expected down: &quot;
<a name="30253"/>30253: 					       &quot;~n      MRef:   ~p&quot;
<a name="30254"/>30254: 					       &quot;~n      Socket: ~p&quot;
<a name="30255"/>30255: 					       &quot;~n      Info:   ~p&quot;,
<a name="30256"/>30256: 					       [MRef, Sock, Info]),
<a name="30257"/>30257: 				   State2 = maps:remove(sock3, State),
<a name="30258"/>30258: 				   State3 = maps:remove(mon3,  State2),
<a name="30259"/>30259: 				   {ok, State3}
<a name="30260"/>30260: 			   after 5000 -&gt;
<a name="30261"/>30261: 				   ?SEV_EPRINT(&quot;socket down timeout&quot;),
<a name="30262"/>30262: 				   {error, timeout}
<a name="30263"/>30263: 			   end
<a name="30264"/>30264:                    end},
<a name="30265"/>30265:          #{desc =&gt; &quot;verify total number of monitors (=1)&quot;,
<a name="30266"/>30266:            cmd  =&gt; fun(_State) -&gt;
<a name="30267"/>30267: 			   1 = socket:number_of_monitors(),
<a name="30268"/>30268: 			   ok
<a name="30269"/>30269:                    end},
<a name="30270"/>30270:          #{desc =&gt; &quot;verify own number of monitors (=1)&quot;,
<a name="30271"/>30271:            cmd  =&gt; fun(_State) -&gt;
<a name="30272"/>30272: 			   1 = socket:number_of_monitors(self()),
<a name="30273"/>30273: 			   ok
<a name="30274"/>30274:                    end},
<a name="30275"/>30275: 
<a name="30276"/>30276:          #{desc =&gt; &quot;order owner to close socket 5&quot;,
<a name="30277"/>30277:            cmd  =&gt; fun(#{owner := Pid} = _State) -&gt;
<a name="30278"/>30278:                            ?SEV_ANNOUNCE_CONTINUE(Pid, close5),
<a name="30279"/>30279:                            ok
<a name="30280"/>30280:                    end},
<a name="30281"/>30281:          #{desc =&gt; &quot;await socket 5 down&quot;,
<a name="30282"/>30282:            cmd  =&gt; fun(#{sock5 := Sock,
<a name="30283"/>30283: 			 mon5  := MRef} = State) -&gt;
<a name="30284"/>30284: 			   receive
<a name="30285"/>30285: 			       {'DOWN', MRef, socket, Sock, Info} -&gt;
<a name="30286"/>30286: 				   ?SEV_IPRINT(&quot;received expected down: &quot;
<a name="30287"/>30287: 					       &quot;~n      MRef:   ~p&quot;
<a name="30288"/>30288: 					       &quot;~n      Socket: ~p&quot;
<a name="30289"/>30289: 					       &quot;~n      Info:   ~p&quot;,
<a name="30290"/>30290: 					       [MRef, Sock, Info]),
<a name="30291"/>30291: 				   State2 = maps:remove(sock5, State),
<a name="30292"/>30292: 				   State3 = maps:remove(mon5,  State2),
<a name="30293"/>30293: 				   {ok, State3}
<a name="30294"/>30294: 			   after 5000 -&gt;
<a name="30295"/>30295: 				   ?SEV_EPRINT(&quot;socket down timeout&quot;),
<a name="30296"/>30296: 				   {error, timeout}
<a name="30297"/>30297: 			   end
<a name="30298"/>30298:                    end},
<a name="30299"/>30299:          #{desc =&gt; &quot;verify total number of monitors (=0)&quot;,
<a name="30300"/>30300:            cmd  =&gt; fun(_State) -&gt;
<a name="30301"/>30301: 			   0 = socket:number_of_monitors(),
<a name="30302"/>30302: 			   ok
<a name="30303"/>30303:                    end},
<a name="30304"/>30304:          #{desc =&gt; &quot;verify own number of monitors (=0)&quot;,
<a name="30305"/>30305:            cmd  =&gt; fun(_State) -&gt;
<a name="30306"/>30306: 			   0 = socket:number_of_monitors(self()),
<a name="30307"/>30307: 			   ok
<a name="30308"/>30308:                    end},
<a name="30309"/>30309: 
<a name="30310"/>30310:          %% Cleanup
<a name="30311"/>30311:          #{desc =&gt; &quot;order (owner) terminate&quot;,
<a name="30312"/>30312:            cmd  =&gt; fun(#{owner := Pid} = _State) -&gt;
<a name="30313"/>30313:                            ?SEV_ANNOUNCE_TERMINATE(Pid),
<a name="30314"/>30314:                            ok
<a name="30315"/>30315:                    end},
<a name="30316"/>30316: 
<a name="30317"/>30317:          #{desc =&gt; &quot;await (owner) termination&quot;,
<a name="30318"/>30318:            cmd  =&gt; fun(#{owner := Pid} = _State) -&gt;
<a name="30319"/>30319:                            case ?SEV_AWAIT_TERMINATION(Pid) of
<a name="30320"/>30320:                                ok -&gt;
<a name="30321"/>30321:                                    ok;
<a name="30322"/>30322:                                {error, _} = ERROR -&gt;
<a name="30323"/>30323:                                    ERROR
<a name="30324"/>30324:                            end
<a name="30325"/>30325:                    end},
<a name="30326"/>30326: 
<a name="30327"/>30327:          %% *** We are done ***
<a name="30328"/>30328:          ?SEV_FINISH_NORMAL
<a name="30329"/>30329:         ],
<a name="30330"/>30330: 
<a name="30331"/>30331:     i(&quot;start (socket) owner evaluator&quot;),
<a name="30332"/>30332:     Owner = ?SEV_START(&quot;owner&quot;, OwnerSeq, InitState),
<a name="30333"/>30333: 
<a name="30334"/>30334:     i(&quot;start tester evaluator&quot;),
<a name="30335"/>30335:     TesterInitState = #{owner =&gt; Owner#ev.pid},
<a name="30336"/>30336:     Tester = ?SEV_START(&quot;tester&quot;, TesterSeq, TesterInitState),
<a name="30337"/>30337: 
<a name="30338"/>30338:     i(&quot;await evaluator&quot;),
<a name="mon_open_and_demon_and_close_multi_socks-last_expr"/><a name="30339"/>30339: <b>    ok = ?SEV_AWAIT_FINISH</b>([Owner, Tester]).
<a name="30340"/>30340: 
<a name="30341"/>30341: 
<a name="30342"/>30342: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="30343"/>30343: <i>%% Create one socket (by 'owner' process), monitor from several different</i>
<a name="30344"/>30344: <i>%% processes, then close socket (from 'owner').</i>
<a name="30345"/>30345: <i>%% The processes that did the monitor shall receive a socket DOWN.</i>
<a name="30346"/>30346: 
<a name="monitor_open_and_close_multi_mon-1"/><a name="30347"/>30347: <b>monitor_open_and_close_multi_mon</b>(_Config) when is_list(_Config) -&gt;
<a name="30348"/>30348:     ?TT(?SECS(10)),
<a name="monitor_open_and_close_multi_mon-last_expr"/><a name="30349"/>30349: <b>    tc_try</b>(monitor_open_and_close_multi_mon,
<a name="30350"/>30350:            fun() -&gt;
<a name="30351"/>30351: 		   InitState = #{domain   =&gt; inet,
<a name="30352"/>30352:                                  type     =&gt; stream,
<a name="30353"/>30353:                                  protocol =&gt; tcp},
<a name="30354"/>30354:                    ok = mon_open_and_close_multi_mon(InitState)
<a name="30355"/>30355:            end).
<a name="30356"/>30356: 
<a name="30357"/>30357: 
<a name="mon_open_and_close_multi_mon-1"/><a name="30358"/>30358: <b>mon_open_and_close_multi_mon</b>(InitState) -&gt;
<a name="30359"/>30359:     OwnerSeq =
<a name="30360"/>30360:         [
<a name="30361"/>30361:          %% *** Wait for start order part ***
<a name="30362"/>30362:          #{desc =&gt; &quot;await start (from tester)&quot;,
<a name="30363"/>30363:            cmd  =&gt; fun(State) -&gt;
<a name="30364"/>30364:                            Tester = ?SEV_AWAIT_START(),
<a name="30365"/>30365:                            {ok, State#{tester =&gt; Tester}}
<a name="30366"/>30366:                    end},
<a name="30367"/>30367:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="30368"/>30368:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="30369"/>30369:                            _MRef = erlang:monitor(process, Tester),
<a name="30370"/>30370:                            ok
<a name="30371"/>30371:                    end},
<a name="30372"/>30372: 
<a name="30373"/>30373:          %% *** Init part ***
<a name="30374"/>30374:          #{desc =&gt; &quot;create socket&quot;,
<a name="30375"/>30375:            cmd  =&gt; fun(#{domain   := Domain, 
<a name="30376"/>30376:                          type     := Type, 
<a name="30377"/>30377:                          protocol := Proto} = State) -&gt;
<a name="30378"/>30378:                            case socket:open(Domain, Type, Proto) of
<a name="30379"/>30379:                                {ok, Sock} -&gt;
<a name="30380"/>30380:                                    {ok, State#{sock =&gt; Sock}};
<a name="30381"/>30381:                                {error, _} = ERROR -&gt;
<a name="30382"/>30382:                                    ERROR
<a name="30383"/>30383:                            end
<a name="30384"/>30384:                    end},
<a name="30385"/>30385:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="30386"/>30386:            cmd  =&gt; fun(#{tester := Tester, sock := Sock} = _State) -&gt;
<a name="30387"/>30387:                            ?SEV_ANNOUNCE_READY(Tester, init, Sock),
<a name="30388"/>30388:                            ok
<a name="30389"/>30389:                    end},
<a name="30390"/>30390: 
<a name="30391"/>30391:          %% The actual test
<a name="30392"/>30392:          #{desc =&gt; &quot;await continue (close)&quot;,
<a name="30393"/>30393:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="30394"/>30394:                            ?SEV_AWAIT_CONTINUE(Tester, tester, close)
<a name="30395"/>30395:                    end},
<a name="30396"/>30396: 
<a name="30397"/>30397:          #{desc =&gt; &quot;close socket&quot;,
<a name="30398"/>30398:            cmd  =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="30399"/>30399:                            ok = socket:close(Sock),
<a name="30400"/>30400: 			   {ok, maps:remove(sock, State)}
<a name="30401"/>30401:                    end},
<a name="30402"/>30402: 
<a name="30403"/>30403: 
<a name="30404"/>30404:          #{desc =&gt; &quot;await terminate (from tester)&quot;,
<a name="30405"/>30405:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="30406"/>30406:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="30407"/>30407:                                ok -&gt;
<a name="30408"/>30408:                                    {ok, maps:remove(tester, State)};
<a name="30409"/>30409:                                {error, _} = ERROR -&gt;
<a name="30410"/>30410:                                    ERROR
<a name="30411"/>30411:                            end
<a name="30412"/>30412:                    end},
<a name="30413"/>30413: 
<a name="30414"/>30414:          %% *** We are done ***
<a name="30415"/>30415:          ?SEV_FINISH_NORMAL
<a name="30416"/>30416:         ],
<a name="30417"/>30417: 
<a name="30418"/>30418: 
<a name="30419"/>30419:     ClientSeq =
<a name="30420"/>30420:         [
<a name="30421"/>30421:          %% *** Wait for start order part ***
<a name="30422"/>30422:          #{desc =&gt; &quot;await start (from tester)&quot;,
<a name="30423"/>30423:            cmd  =&gt; fun(State) -&gt;
<a name="30424"/>30424:                            Tester = ?SEV_AWAIT_START(),
<a name="30425"/>30425:                            {ok, State#{tester =&gt; Tester}}
<a name="30426"/>30426:                    end},
<a name="30427"/>30427:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="30428"/>30428:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="30429"/>30429:                            _MRef = erlang:monitor(process, Tester),
<a name="30430"/>30430:                            ok
<a name="30431"/>30431:                    end},
<a name="30432"/>30432: 
<a name="30433"/>30433:          %% *** Init part ***
<a name="30434"/>30434:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="30435"/>30435:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="30436"/>30436:                            ?SEV_ANNOUNCE_READY(Tester, init),
<a name="30437"/>30437:                            ok
<a name="30438"/>30438:                    end},
<a name="30439"/>30439:          #{desc =&gt; &quot;await continue (socket)&quot;,
<a name="30440"/>30440:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="30441"/>30441:                            {ok, Sock} =
<a name="30442"/>30442: 			       ?SEV_AWAIT_CONTINUE(Tester, tester, socket),
<a name="30443"/>30443: 			   ?SEV_IPRINT(&quot;Socket: ~p&quot;, [Sock]),
<a name="30444"/>30444: 			   {ok, State#{sock =&gt; Sock}}
<a name="30445"/>30445:                    end},
<a name="30446"/>30446: 
<a name="30447"/>30447: 
<a name="30448"/>30448:          %% The actual test
<a name="30449"/>30449:          #{desc =&gt; &quot;await continue (monitor)&quot;,
<a name="30450"/>30450:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="30451"/>30451:                            ?SEV_AWAIT_CONTINUE(Tester, tester, monitor)
<a name="30452"/>30452:                    end},
<a name="30453"/>30453:          #{desc =&gt; &quot;verify own number of monitors (=0)&quot;,
<a name="30454"/>30454:            cmd  =&gt; fun(_State) -&gt;
<a name="30455"/>30455: 			   0 = socket:number_of_monitors(self()),
<a name="30456"/>30456: 			   ok
<a name="30457"/>30457:                    end},
<a name="30458"/>30458:          #{desc =&gt; &quot;monitor socket&quot;,
<a name="30459"/>30459:            cmd  =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="30460"/>30460:                            MRef = socket:monitor(Sock),
<a name="30461"/>30461: 			   ?SEV_IPRINT(&quot;Monitor: ~p&quot;, [MRef]),
<a name="30462"/>30462: 			   {ok, State#{mon =&gt; MRef}}
<a name="30463"/>30463:                    end},
<a name="30464"/>30464:          #{desc =&gt; &quot;verify own number of monitors (=1)&quot;,
<a name="30465"/>30465:            cmd  =&gt; fun(_State) -&gt;
<a name="30466"/>30466: 			   1 = socket:number_of_monitors(self()),
<a name="30467"/>30467: 			   ok
<a name="30468"/>30468:                    end},
<a name="30469"/>30469: 
<a name="30470"/>30470:          #{desc =&gt; &quot;announce ready (monitor)&quot;,
<a name="30471"/>30471:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="30472"/>30472:                            ?SEV_ANNOUNCE_READY(Tester, monitor),
<a name="30473"/>30473:                            ok
<a name="30474"/>30474:                    end},
<a name="30475"/>30475: 
<a name="30476"/>30476:          #{desc =&gt; &quot;await continue (down)&quot;,
<a name="30477"/>30477:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="30478"/>30478:                            ?SEV_AWAIT_CONTINUE(Tester, tester, down)
<a name="30479"/>30479:                    end},
<a name="30480"/>30480: 
<a name="30481"/>30481:          #{desc =&gt; &quot;await socket down&quot;,
<a name="30482"/>30482:            cmd  =&gt; fun(#{sock := Sock,
<a name="30483"/>30483: 			 mon  := MRef} = State) -&gt;
<a name="30484"/>30484: 			   receive
<a name="30485"/>30485: 			       {'DOWN', MRef, socket, Sock, Info} -&gt;
<a name="30486"/>30486: 				   ?SEV_IPRINT(&quot;received expected down: &quot;
<a name="30487"/>30487: 					       &quot;~n      MRef:   ~p&quot;
<a name="30488"/>30488: 					       &quot;~n      Socket: ~p&quot;
<a name="30489"/>30489: 					       &quot;~n      Info:   ~p&quot;,
<a name="30490"/>30490: 					       [MRef, Sock, Info]),
<a name="30491"/>30491: 				   State2 = maps:remove(mon, State),
<a name="30492"/>30492: 				   State3 = maps:remove(sock, State2),
<a name="30493"/>30493: 				   {ok, State3}
<a name="30494"/>30494: 			   after 5000 -&gt;
<a name="30495"/>30495: 				   ?SEV_EPRINT(&quot;socket down timeout&quot;),
<a name="30496"/>30496: 				   {error, timeout}
<a name="30497"/>30497: 			   end
<a name="30498"/>30498:                    end},
<a name="30499"/>30499:          #{desc =&gt; &quot;verify own number of monitors (=0)&quot;,
<a name="30500"/>30500:            cmd  =&gt; fun(_State) -&gt;
<a name="30501"/>30501: 			   0 = socket:number_of_monitors(self()),
<a name="30502"/>30502: 			   ok
<a name="30503"/>30503:                    end},
<a name="30504"/>30504: 
<a name="30505"/>30505:          #{desc =&gt; &quot;announce ready (down)&quot;,
<a name="30506"/>30506:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="30507"/>30507:                            ?SEV_ANNOUNCE_READY(Tester, down),
<a name="30508"/>30508:                            ok
<a name="30509"/>30509:                    end},
<a name="30510"/>30510: 
<a name="30511"/>30511: 
<a name="30512"/>30512:          #{desc =&gt; &quot;await terminate (from tester)&quot;,
<a name="30513"/>30513:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="30514"/>30514:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="30515"/>30515:                                ok -&gt;
<a name="30516"/>30516:                                    {ok, maps:remove(tester, State)};
<a name="30517"/>30517:                                {error, _} = ERROR -&gt;
<a name="30518"/>30518:                                    ERROR
<a name="30519"/>30519:                            end
<a name="30520"/>30520:                    end},
<a name="30521"/>30521: 
<a name="30522"/>30522:          %% *** We are done ***
<a name="30523"/>30523:          ?SEV_FINISH_NORMAL
<a name="30524"/>30524:         ],
<a name="30525"/>30525: 
<a name="30526"/>30526:     TesterSeq =
<a name="30527"/>30527:         [
<a name="30528"/>30528:          %% *** Init part ***
<a name="30529"/>30529:          #{desc =&gt; &quot;monitor 'owner'&quot;,
<a name="30530"/>30530:            cmd  =&gt; fun(#{owner := Owner} = _State) -&gt;
<a name="30531"/>30531:                            _MRef = erlang:monitor(process, Owner),
<a name="30532"/>30532:                            ok
<a name="30533"/>30533:                    end},
<a name="30534"/>30534:          #{desc =&gt; &quot;order (owner) start&quot;,
<a name="30535"/>30535:            cmd  =&gt; fun(#{owner := Pid} = _State) -&gt;
<a name="30536"/>30536:                            ?SEV_ANNOUNCE_START(Pid),
<a name="30537"/>30537:                            ok
<a name="30538"/>30538:                    end},
<a name="30539"/>30539:          #{desc =&gt; &quot;await (owner) ready&quot;,
<a name="30540"/>30540:            cmd  =&gt; fun(#{owner := Pid} = State) -&gt;
<a name="30541"/>30541:                            {ok, Sock} = ?SEV_AWAIT_READY(Pid, owner, init),
<a name="30542"/>30542:                            {ok, State#{sock =&gt; Sock}}
<a name="30543"/>30543:                    end},
<a name="30544"/>30544: 
<a name="30545"/>30545:          #{desc =&gt; &quot;monitor 'client 1'&quot;,
<a name="30546"/>30546:            cmd  =&gt; fun(#{client1 := Pid} = _State) -&gt;
<a name="30547"/>30547:                            _MRef = erlang:monitor(process, Pid),
<a name="30548"/>30548:                            ok
<a name="30549"/>30549:                    end},
<a name="30550"/>30550:          #{desc =&gt; &quot;order (client 1) start&quot;,
<a name="30551"/>30551:            cmd  =&gt; fun(#{client1 := Pid} = _State) -&gt;
<a name="30552"/>30552:                            ?SEV_ANNOUNCE_START(Pid),
<a name="30553"/>30553:                            ok
<a name="30554"/>30554:                    end},
<a name="30555"/>30555:          #{desc =&gt; &quot;await (client 1) ready&quot;,
<a name="30556"/>30556:            cmd  =&gt; fun(#{client1 := Pid} = _State) -&gt;
<a name="30557"/>30557:                            ok = ?SEV_AWAIT_READY(Pid, client1, init)
<a name="30558"/>30558:                    end},
<a name="30559"/>30559:          #{desc =&gt; &quot;send socket to client 1&quot;,
<a name="30560"/>30560:            cmd  =&gt; fun(#{client1 := Pid, sock := Sock} = _State) -&gt;
<a name="30561"/>30561:                            ?SEV_ANNOUNCE_CONTINUE(Pid, socket, Sock),
<a name="30562"/>30562:                            ok
<a name="30563"/>30563:                    end},
<a name="30564"/>30564: 
<a name="30565"/>30565:          #{desc =&gt; &quot;monitor 'client 2'&quot;,
<a name="30566"/>30566:            cmd  =&gt; fun(#{client2 := Pid} = _State) -&gt;
<a name="30567"/>30567:                            _MRef = erlang:monitor(process, Pid),
<a name="30568"/>30568:                            ok
<a name="30569"/>30569:                    end},
<a name="30570"/>30570:          #{desc =&gt; &quot;order (client 2) start&quot;,
<a name="30571"/>30571:            cmd  =&gt; fun(#{client2 := Pid} = _State) -&gt;
<a name="30572"/>30572:                            ?SEV_ANNOUNCE_START(Pid),
<a name="30573"/>30573:                            ok
<a name="30574"/>30574:                    end},
<a name="30575"/>30575:          #{desc =&gt; &quot;await (client 2) ready&quot;,
<a name="30576"/>30576:            cmd  =&gt; fun(#{client2 := Pid} = _State) -&gt;
<a name="30577"/>30577:                            ok = ?SEV_AWAIT_READY(Pid, client2, init)
<a name="30578"/>30578:                    end},
<a name="30579"/>30579:          #{desc =&gt; &quot;send socket to client 2&quot;,
<a name="30580"/>30580:            cmd  =&gt; fun(#{client2 := Pid, sock := Sock} = _State) -&gt;
<a name="30581"/>30581:                            ?SEV_ANNOUNCE_CONTINUE(Pid, socket, Sock),
<a name="30582"/>30582:                            ok
<a name="30583"/>30583:                    end},
<a name="30584"/>30584: 
<a name="30585"/>30585:          #{desc =&gt; &quot;monitor 'client 3'&quot;,
<a name="30586"/>30586:            cmd  =&gt; fun(#{client3 := Pid} = _State) -&gt;
<a name="30587"/>30587:                            _MRef = erlang:monitor(process, Pid),
<a name="30588"/>30588:                            ok
<a name="30589"/>30589:                    end},
<a name="30590"/>30590:          #{desc =&gt; &quot;order (client 3) start&quot;,
<a name="30591"/>30591:            cmd  =&gt; fun(#{client3 := Pid} = _State) -&gt;
<a name="30592"/>30592:                            ?SEV_ANNOUNCE_START(Pid),
<a name="30593"/>30593:                            ok
<a name="30594"/>30594:                    end},
<a name="30595"/>30595:          #{desc =&gt; &quot;await (client 3) ready&quot;,
<a name="30596"/>30596:            cmd  =&gt; fun(#{client3 := Pid} = _State) -&gt;
<a name="30597"/>30597:                            ok = ?SEV_AWAIT_READY(Pid, client3, init)
<a name="30598"/>30598:                    end},
<a name="30599"/>30599:          #{desc =&gt; &quot;send socket to client 3&quot;,
<a name="30600"/>30600:            cmd  =&gt; fun(#{client3 := Pid, sock := Sock} = _State) -&gt;
<a name="30601"/>30601:                            ?SEV_ANNOUNCE_CONTINUE(Pid, socket, Sock),
<a name="30602"/>30602:                            ok
<a name="30603"/>30603:                    end},
<a name="30604"/>30604: 
<a name="30605"/>30605:          #{desc =&gt; &quot;monitor 'client 4'&quot;,
<a name="30606"/>30606:            cmd  =&gt; fun(#{client4 := Pid} = _State) -&gt;
<a name="30607"/>30607:                            _MRef = erlang:monitor(process, Pid),
<a name="30608"/>30608:                            ok
<a name="30609"/>30609:                    end},
<a name="30610"/>30610:          #{desc =&gt; &quot;order (client 4) start&quot;,
<a name="30611"/>30611:            cmd  =&gt; fun(#{client4 := Pid} = _State) -&gt;
<a name="30612"/>30612:                            ?SEV_ANNOUNCE_START(Pid),
<a name="30613"/>30613:                            ok
<a name="30614"/>30614:                    end},
<a name="30615"/>30615:          #{desc =&gt; &quot;await (client 4) ready&quot;,
<a name="30616"/>30616:            cmd  =&gt; fun(#{client4 := Pid} = _State) -&gt;
<a name="30617"/>30617:                            ok = ?SEV_AWAIT_READY(Pid, client4, init)
<a name="30618"/>30618:                    end},
<a name="30619"/>30619:          #{desc =&gt; &quot;send socket to client 4&quot;,
<a name="30620"/>30620:            cmd  =&gt; fun(#{client4 := Pid, sock := Sock} = _State) -&gt;
<a name="30621"/>30621:                            ?SEV_ANNOUNCE_CONTINUE(Pid, socket, Sock),
<a name="30622"/>30622:                            ok
<a name="30623"/>30623:                    end},
<a name="30624"/>30624: 
<a name="30625"/>30625:          #{desc =&gt; &quot;monitor 'client 5'&quot;,
<a name="30626"/>30626:            cmd  =&gt; fun(#{client5 := Pid} = _State) -&gt;
<a name="30627"/>30627:                            _MRef = erlang:monitor(process, Pid),
<a name="30628"/>30628:                            ok
<a name="30629"/>30629:                    end},
<a name="30630"/>30630:          #{desc =&gt; &quot;order (client 5) start&quot;,
<a name="30631"/>30631:            cmd  =&gt; fun(#{client5 := Pid} = _State) -&gt;
<a name="30632"/>30632:                            ?SEV_ANNOUNCE_START(Pid),
<a name="30633"/>30633:                            ok
<a name="30634"/>30634:                    end},
<a name="30635"/>30635:          #{desc =&gt; &quot;await (client 5) ready&quot;,
<a name="30636"/>30636:            cmd  =&gt; fun(#{client5 := Pid} = _State) -&gt;
<a name="30637"/>30637:                            ok = ?SEV_AWAIT_READY(Pid, client5, init)
<a name="30638"/>30638:                    end},
<a name="30639"/>30639:          #{desc =&gt; &quot;send socket to client 5&quot;,
<a name="30640"/>30640:            cmd  =&gt; fun(#{client5 := Pid, sock := Sock} = _State) -&gt;
<a name="30641"/>30641:                            ?SEV_ANNOUNCE_CONTINUE(Pid, socket, Sock),
<a name="30642"/>30642:                            ok
<a name="30643"/>30643:                    end},
<a name="30644"/>30644: 
<a name="30645"/>30645: 
<a name="30646"/>30646:          %% The actual test
<a name="30647"/>30647:          #{desc =&gt; &quot;verify total number of monitors (=0)&quot;,
<a name="30648"/>30648:            cmd  =&gt; fun(_State) -&gt;
<a name="30649"/>30649: 			   0 = socket:number_of_monitors(),
<a name="30650"/>30650: 			   ok
<a name="30651"/>30651:                    end},
<a name="30652"/>30652: 
<a name="30653"/>30653:          #{desc =&gt; &quot;order client 1 to monitor&quot;,
<a name="30654"/>30654:            cmd  =&gt; fun(#{client1 := Pid} = _State) -&gt;
<a name="30655"/>30655:                            ?SEV_ANNOUNCE_CONTINUE(Pid, monitor),
<a name="30656"/>30656:                            ok
<a name="30657"/>30657:                    end},
<a name="30658"/>30658:          #{desc =&gt; &quot;await (client 1) ready&quot;,
<a name="30659"/>30659:            cmd  =&gt; fun(#{client1 := Pid} = _State) -&gt;
<a name="30660"/>30660:                            ok = ?SEV_AWAIT_READY(Pid, client1, monitor)
<a name="30661"/>30661:                    end},
<a name="30662"/>30662:          #{desc =&gt; &quot;verify total number of monitors (=1)&quot;,
<a name="30663"/>30663:            cmd  =&gt; fun(_State) -&gt;
<a name="30664"/>30664: 			   1 = socket:number_of_monitors(),
<a name="30665"/>30665: 			   ok
<a name="30666"/>30666:                    end},
<a name="30667"/>30667: 
<a name="30668"/>30668:          #{desc =&gt; &quot;order client 2 to monitor&quot;,
<a name="30669"/>30669:            cmd  =&gt; fun(#{client2 := Pid} = _State) -&gt;
<a name="30670"/>30670:                            ?SEV_ANNOUNCE_CONTINUE(Pid, monitor),
<a name="30671"/>30671:                            ok
<a name="30672"/>30672:                    end},
<a name="30673"/>30673:          #{desc =&gt; &quot;await (client 2) ready&quot;,
<a name="30674"/>30674:            cmd  =&gt; fun(#{client2 := Pid} = _State) -&gt;
<a name="30675"/>30675:                            ok = ?SEV_AWAIT_READY(Pid, client2, monitor)
<a name="30676"/>30676:                    end},
<a name="30677"/>30677:          #{desc =&gt; &quot;verify total number of monitors (=2)&quot;,
<a name="30678"/>30678:            cmd  =&gt; fun(_State) -&gt;
<a name="30679"/>30679: 			   2 = socket:number_of_monitors(),
<a name="30680"/>30680: 			   ok
<a name="30681"/>30681:                    end},
<a name="30682"/>30682: 
<a name="30683"/>30683:          #{desc =&gt; &quot;order client 3 to monitor&quot;,
<a name="30684"/>30684:            cmd  =&gt; fun(#{client3 := Pid} = _State) -&gt;
<a name="30685"/>30685:                            ?SEV_ANNOUNCE_CONTINUE(Pid, monitor),
<a name="30686"/>30686:                            ok
<a name="30687"/>30687:                    end},
<a name="30688"/>30688:          #{desc =&gt; &quot;await (client 3) ready&quot;,
<a name="30689"/>30689:            cmd  =&gt; fun(#{client3 := Pid} = _State) -&gt;
<a name="30690"/>30690:                            ok = ?SEV_AWAIT_READY(Pid, client3, monitor)
<a name="30691"/>30691:                    end},
<a name="30692"/>30692:          #{desc =&gt; &quot;verify total number of monitors (=3)&quot;,
<a name="30693"/>30693:            cmd  =&gt; fun(_State) -&gt;
<a name="30694"/>30694: 			   3 = socket:number_of_monitors(),
<a name="30695"/>30695: 			   ok
<a name="30696"/>30696:                    end},
<a name="30697"/>30697: 
<a name="30698"/>30698:          #{desc =&gt; &quot;order client 4 to monitor&quot;,
<a name="30699"/>30699:            cmd  =&gt; fun(#{client4 := Pid} = _State) -&gt;
<a name="30700"/>30700:                            ?SEV_ANNOUNCE_CONTINUE(Pid, monitor),
<a name="30701"/>30701:                            ok
<a name="30702"/>30702:                    end},
<a name="30703"/>30703:          #{desc =&gt; &quot;await (client 4) ready&quot;,
<a name="30704"/>30704:            cmd  =&gt; fun(#{client4 := Pid} = _State) -&gt;
<a name="30705"/>30705:                            ok = ?SEV_AWAIT_READY(Pid, client4, monitor)
<a name="30706"/>30706:                    end},
<a name="30707"/>30707:          #{desc =&gt; &quot;verify total number of monitors (=4)&quot;,
<a name="30708"/>30708:            cmd  =&gt; fun(_State) -&gt;
<a name="30709"/>30709: 			   4 = socket:number_of_monitors(),
<a name="30710"/>30710: 			   ok
<a name="30711"/>30711:                    end},
<a name="30712"/>30712: 
<a name="30713"/>30713:          #{desc =&gt; &quot;order client 5 to monitor&quot;,
<a name="30714"/>30714:            cmd  =&gt; fun(#{client5 := Pid} = _State) -&gt;
<a name="30715"/>30715:                            ?SEV_ANNOUNCE_CONTINUE(Pid, monitor),
<a name="30716"/>30716:                            ok
<a name="30717"/>30717:                    end},
<a name="30718"/>30718:          #{desc =&gt; &quot;await (client 5) ready&quot;,
<a name="30719"/>30719:            cmd  =&gt; fun(#{client5 := Pid} = _State) -&gt;
<a name="30720"/>30720:                            ok = ?SEV_AWAIT_READY(Pid, client5, monitor)
<a name="30721"/>30721:                    end},
<a name="30722"/>30722:          #{desc =&gt; &quot;verify total number of monitors (=5)&quot;,
<a name="30723"/>30723:            cmd  =&gt; fun(_State) -&gt;
<a name="30724"/>30724: 			   5 = socket:number_of_monitors(),
<a name="30725"/>30725: 			   ok
<a name="30726"/>30726:                    end},
<a name="30727"/>30727:          #{desc =&gt; &quot;verify monitored by - none&quot;,
<a name="30728"/>30728:            cmd  =&gt; fun(#{sock    := Sock,
<a name="30729"/>30729: 			 client1 := Pid1,
<a name="30730"/>30730: 			 client2 := Pid2,
<a name="30731"/>30731: 			 client3 := Pid3,
<a name="30732"/>30732: 			 client4 := Pid4,
<a name="30733"/>30733: 			 client5 := Pid5} = _State) -&gt;
<a name="30734"/>30734: 			   Clients = lists:sort([Pid1, Pid2, Pid3, Pid4, Pid5]),
<a name="30735"/>30735: 			   case lists:sort(socket:monitored_by(Sock)) of
<a name="30736"/>30736: 			       Clients -&gt;
<a name="30737"/>30737: 				   ok;
<a name="30738"/>30738: 			       SClients -&gt;
<a name="30739"/>30739: 				   ?SEV_EPRINT(&quot;Unexpected clients: &quot;
<a name="30740"/>30740: 					       &quot;~n   Expected: ~p&quot;
<a name="30741"/>30741: 					       &quot;~n   Actual:   ~p&quot;,
<a name="30742"/>30742: 					       [Clients, SClients]),
<a name="30743"/>30743: 				   {error, unexpected_clients}
<a name="30744"/>30744: 			   end
<a name="30745"/>30745:                    end},
<a name="30746"/>30746: 
<a name="30747"/>30747:          #{desc =&gt; &quot;order client 1 to await down&quot;,
<a name="30748"/>30748:            cmd  =&gt; fun(#{client1 := Pid} = _State) -&gt;
<a name="30749"/>30749:                            ?SEV_ANNOUNCE_CONTINUE(Pid, down),
<a name="30750"/>30750:                            ok
<a name="30751"/>30751:                    end},
<a name="30752"/>30752:          #{desc =&gt; &quot;order client 2 to await down&quot;,
<a name="30753"/>30753:            cmd  =&gt; fun(#{client2 := Pid} = _State) -&gt;
<a name="30754"/>30754:                            ?SEV_ANNOUNCE_CONTINUE(Pid, down),
<a name="30755"/>30755:                            ok
<a name="30756"/>30756:                    end},
<a name="30757"/>30757:          #{desc =&gt; &quot;order client 3 to await down&quot;,
<a name="30758"/>30758:            cmd  =&gt; fun(#{client3 := Pid} = _State) -&gt;
<a name="30759"/>30759:                            ?SEV_ANNOUNCE_CONTINUE(Pid, down),
<a name="30760"/>30760:                            ok
<a name="30761"/>30761:                    end},
<a name="30762"/>30762:          #{desc =&gt; &quot;order client 4 to await down&quot;,
<a name="30763"/>30763:            cmd  =&gt; fun(#{client4 := Pid} = _State) -&gt;
<a name="30764"/>30764:                            ?SEV_ANNOUNCE_CONTINUE(Pid, down),
<a name="30765"/>30765:                            ok
<a name="30766"/>30766:                    end},
<a name="30767"/>30767:          #{desc =&gt; &quot;order client 5 to await down&quot;,
<a name="30768"/>30768:            cmd  =&gt; fun(#{client5 := Pid} = _State) -&gt;
<a name="30769"/>30769:                            ?SEV_ANNOUNCE_CONTINUE(Pid, down),
<a name="30770"/>30770:                            ok
<a name="30771"/>30771:                    end},
<a name="30772"/>30772: 
<a name="30773"/>30773:          #{desc =&gt; &quot;order owner to close&quot;,
<a name="30774"/>30774:            cmd  =&gt; fun(#{owner := Pid} = _State) -&gt;
<a name="30775"/>30775:                            ?SEV_ANNOUNCE_CONTINUE(Pid, close),
<a name="30776"/>30776:                            ok
<a name="30777"/>30777:                    end},
<a name="30778"/>30778: 
<a name="30779"/>30779:          #{desc =&gt; &quot;await (client 1) down received&quot;,
<a name="30780"/>30780:            cmd  =&gt; fun(#{client1 := Pid} = _State) -&gt;
<a name="30781"/>30781:                            ok = ?SEV_AWAIT_READY(Pid, client1, down)
<a name="30782"/>30782:                    end},
<a name="30783"/>30783:          #{desc =&gt; &quot;await (client 2) down received&quot;,
<a name="30784"/>30784:            cmd  =&gt; fun(#{client2 := Pid} = _State) -&gt;
<a name="30785"/>30785:                            ok = ?SEV_AWAIT_READY(Pid, client2, down)
<a name="30786"/>30786:                    end},
<a name="30787"/>30787:          #{desc =&gt; &quot;await (client 3) down received&quot;,
<a name="30788"/>30788:            cmd  =&gt; fun(#{client3 := Pid} = _State) -&gt;
<a name="30789"/>30789:                            ok = ?SEV_AWAIT_READY(Pid, client3, down)
<a name="30790"/>30790:                    end},
<a name="30791"/>30791:          #{desc =&gt; &quot;await (client 4) down received&quot;,
<a name="30792"/>30792:            cmd  =&gt; fun(#{client4 := Pid} = _State) -&gt;
<a name="30793"/>30793:                            ok = ?SEV_AWAIT_READY(Pid, client4, down)
<a name="30794"/>30794:                    end},
<a name="30795"/>30795:          #{desc =&gt; &quot;await (client 5) down received&quot;,
<a name="30796"/>30796:            cmd  =&gt; fun(#{client5 := Pid} = _State) -&gt;
<a name="30797"/>30797:                            ok = ?SEV_AWAIT_READY(Pid, client5, down)
<a name="30798"/>30798:                    end},
<a name="30799"/>30799:          #{desc =&gt; &quot;verify total number of monitors (=0)&quot;,
<a name="30800"/>30800:            cmd  =&gt; fun(_State) -&gt;
<a name="30801"/>30801: 			   0 = socket:number_of_monitors(),
<a name="30802"/>30802: 			   ok
<a name="30803"/>30803:                    end},
<a name="30804"/>30804: 
<a name="30805"/>30805:          %% Cleanup
<a name="30806"/>30806:          #{desc =&gt; &quot;order (owner) terminate&quot;,
<a name="30807"/>30807:            cmd  =&gt; fun(#{owner := Pid} = _State) -&gt;
<a name="30808"/>30808:                            ?SEV_ANNOUNCE_TERMINATE(Pid),
<a name="30809"/>30809:                            ok
<a name="30810"/>30810:                    end},
<a name="30811"/>30811:          #{desc =&gt; &quot;await (owner) termination&quot;,
<a name="30812"/>30812:            cmd  =&gt; fun(#{owner := Pid} = State) -&gt;
<a name="30813"/>30813:                            case ?SEV_AWAIT_TERMINATION(Pid) of
<a name="30814"/>30814:                                ok -&gt;
<a name="30815"/>30815:                                    {ok, maps:remove(owner, State)};
<a name="30816"/>30816:                                {error, _} = ERROR -&gt;
<a name="30817"/>30817:                                    ERROR
<a name="30818"/>30818:                            end
<a name="30819"/>30819:                    end},
<a name="30820"/>30820: 
<a name="30821"/>30821:          #{desc =&gt; &quot;order (client 1) terminate&quot;,
<a name="30822"/>30822:            cmd  =&gt; fun(#{client1 := Pid} = _State) -&gt;
<a name="30823"/>30823:                            ?SEV_ANNOUNCE_TERMINATE(Pid),
<a name="30824"/>30824:                            ok
<a name="30825"/>30825:                    end},
<a name="30826"/>30826:          #{desc =&gt; &quot;await (client 1) termination&quot;,
<a name="30827"/>30827:            cmd  =&gt; fun(#{client1 := Pid} = State) -&gt;
<a name="30828"/>30828:                            case ?SEV_AWAIT_TERMINATION(Pid) of
<a name="30829"/>30829:                                ok -&gt;
<a name="30830"/>30830:                                    {ok, maps:remove(client1, State)};
<a name="30831"/>30831:                                {error, _} = ERROR -&gt;
<a name="30832"/>30832:                                    ERROR
<a name="30833"/>30833:                            end
<a name="30834"/>30834:                    end},
<a name="30835"/>30835: 
<a name="30836"/>30836:          #{desc =&gt; &quot;order (client 2) terminate&quot;,
<a name="30837"/>30837:            cmd  =&gt; fun(#{client2 := Pid} = _State) -&gt;
<a name="30838"/>30838:                            ?SEV_ANNOUNCE_TERMINATE(Pid),
<a name="30839"/>30839:                            ok
<a name="30840"/>30840:                    end},
<a name="30841"/>30841:          #{desc =&gt; &quot;await (client 2) termination&quot;,
<a name="30842"/>30842:            cmd  =&gt; fun(#{client2 := Pid} = State) -&gt;
<a name="30843"/>30843:                            case ?SEV_AWAIT_TERMINATION(Pid) of
<a name="30844"/>30844:                                ok -&gt;
<a name="30845"/>30845:                                    {ok, maps:remove(client2, State)};
<a name="30846"/>30846:                                {error, _} = ERROR -&gt;
<a name="30847"/>30847:                                    ERROR
<a name="30848"/>30848:                            end
<a name="30849"/>30849:                    end},
<a name="30850"/>30850: 
<a name="30851"/>30851:          #{desc =&gt; &quot;order (client 3) terminate&quot;,
<a name="30852"/>30852:            cmd  =&gt; fun(#{client3 := Pid} = _State) -&gt;
<a name="30853"/>30853:                            ?SEV_ANNOUNCE_TERMINATE(Pid),
<a name="30854"/>30854:                            ok
<a name="30855"/>30855:                    end},
<a name="30856"/>30856:          #{desc =&gt; &quot;await (client 3) termination&quot;,
<a name="30857"/>30857:            cmd  =&gt; fun(#{client3 := Pid} = State) -&gt;
<a name="30858"/>30858:                            case ?SEV_AWAIT_TERMINATION(Pid) of
<a name="30859"/>30859:                                ok -&gt;
<a name="30860"/>30860:                                    {ok, maps:remove(client3, State)};
<a name="30861"/>30861:                                {error, _} = ERROR -&gt;
<a name="30862"/>30862:                                    ERROR
<a name="30863"/>30863:                            end
<a name="30864"/>30864:                    end},
<a name="30865"/>30865: 
<a name="30866"/>30866:          #{desc =&gt; &quot;order (client 4) terminate&quot;,
<a name="30867"/>30867:            cmd  =&gt; fun(#{client4 := Pid} = _State) -&gt;
<a name="30868"/>30868:                            ?SEV_ANNOUNCE_TERMINATE(Pid),
<a name="30869"/>30869:                            ok
<a name="30870"/>30870:                    end},
<a name="30871"/>30871:          #{desc =&gt; &quot;await (client 4) termination&quot;,
<a name="30872"/>30872:            cmd  =&gt; fun(#{client4 := Pid} = State) -&gt;
<a name="30873"/>30873:                            case ?SEV_AWAIT_TERMINATION(Pid) of
<a name="30874"/>30874:                                ok -&gt;
<a name="30875"/>30875:                                    {ok, maps:remove(client4, State)};
<a name="30876"/>30876:                                {error, _} = ERROR -&gt;
<a name="30877"/>30877:                                    ERROR
<a name="30878"/>30878:                            end
<a name="30879"/>30879:                    end},
<a name="30880"/>30880: 
<a name="30881"/>30881:          #{desc =&gt; &quot;order (client 5) terminate&quot;,
<a name="30882"/>30882:            cmd  =&gt; fun(#{client5 := Pid} = _State) -&gt;
<a name="30883"/>30883:                            ?SEV_ANNOUNCE_TERMINATE(Pid),
<a name="30884"/>30884:                            ok
<a name="30885"/>30885:                    end},
<a name="30886"/>30886:          #{desc =&gt; &quot;await (client 5) termination&quot;,
<a name="30887"/>30887:            cmd  =&gt; fun(#{client5 := Pid} = State) -&gt;
<a name="30888"/>30888:                            case ?SEV_AWAIT_TERMINATION(Pid) of
<a name="30889"/>30889:                                ok -&gt;
<a name="30890"/>30890:                                    {ok, maps:remove(client5, State)};
<a name="30891"/>30891:                                {error, _} = ERROR -&gt;
<a name="30892"/>30892:                                    ERROR
<a name="30893"/>30893:                            end
<a name="30894"/>30894:                    end},
<a name="30895"/>30895: 
<a name="30896"/>30896:          %% *** We are done ***
<a name="30897"/>30897:          ?SEV_FINISH_NORMAL
<a name="30898"/>30898:         ],
<a name="30899"/>30899: 
<a name="30900"/>30900:     i(&quot;start (socket) owner evaluator&quot;),
<a name="30901"/>30901:     Owner = ?SEV_START(&quot;owner&quot;, OwnerSeq, InitState),
<a name="30902"/>30902: 
<a name="30903"/>30903:     i(&quot;start client 1 evaluator&quot;),
<a name="30904"/>30904:     Client1 = ?SEV_START(&quot;client-1&quot;, ClientSeq, InitState),
<a name="30905"/>30905: 
<a name="30906"/>30906:     i(&quot;start client 2 evaluator&quot;),
<a name="30907"/>30907:     Client2 = ?SEV_START(&quot;client-2&quot;, ClientSeq, InitState),
<a name="30908"/>30908: 
<a name="30909"/>30909:     i(&quot;start client 3 evaluator&quot;),
<a name="30910"/>30910:     Client3 = ?SEV_START(&quot;client-3&quot;, ClientSeq, InitState),
<a name="30911"/>30911: 
<a name="30912"/>30912:     i(&quot;start client 4 evaluator&quot;),
<a name="30913"/>30913:     Client4 = ?SEV_START(&quot;client-4&quot;, ClientSeq, InitState),
<a name="30914"/>30914: 
<a name="30915"/>30915:     i(&quot;start client 5 evaluator&quot;),
<a name="30916"/>30916:     Client5 = ?SEV_START(&quot;client-5&quot;, ClientSeq, InitState),
<a name="30917"/>30917: 
<a name="30918"/>30918:     i(&quot;start tester evaluator&quot;),
<a name="30919"/>30919:     TesterInitState = #{owner   =&gt; Owner#ev.pid,
<a name="30920"/>30920: 			client1 =&gt; Client1#ev.pid,
<a name="30921"/>30921: 			client2 =&gt; Client2#ev.pid,
<a name="30922"/>30922: 			client3 =&gt; Client3#ev.pid,
<a name="30923"/>30923: 			client4 =&gt; Client4#ev.pid,
<a name="30924"/>30924: 			client5 =&gt; Client5#ev.pid},
<a name="30925"/>30925:     Tester = ?SEV_START(&quot;tester&quot;, TesterSeq, TesterInitState),
<a name="30926"/>30926: 
<a name="30927"/>30927:     i(&quot;await evaluator&quot;),
<a name="mon_open_and_close_multi_mon-last_expr"/><a name="30928"/>30928: <b>    ok = ?SEV_AWAIT_FINISH</b>([Owner, Tester]).
<a name="30929"/>30929: 
<a name="30930"/>30930: 
<a name="30931"/>30931: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="30932"/>30932: <i>%% Create one socket (by 'owner' process), monitor from several different</i>
<a name="30933"/>30933: <i>%% processes, then close socket (from 'owner').</i>
<a name="30934"/>30934: <i>%% The processes that did the monitor shall receive a socket DOWN.</i>
<a name="30935"/>30935: 
<a name="monitor_open_and_exit_multi_mon-1"/><a name="30936"/>30936: <b>monitor_open_and_exit_multi_mon</b>(_Config) when is_list(_Config) -&gt;
<a name="30937"/>30937:     ?TT(?SECS(10)),
<a name="monitor_open_and_exit_multi_mon-last_expr"/><a name="30938"/>30938: <b>    tc_try</b>(monitor_open_and_exit_multi_mon,
<a name="30939"/>30939:            fun() -&gt;
<a name="30940"/>30940: 		   InitState = #{domain   =&gt; inet,
<a name="30941"/>30941:                                  type     =&gt; stream,
<a name="30942"/>30942:                                  protocol =&gt; tcp},
<a name="30943"/>30943:                    ok = mon_open_and_exit_multi_mon(InitState)
<a name="30944"/>30944:            end).
<a name="30945"/>30945: 
<a name="30946"/>30946: 
<a name="mon_open_and_exit_multi_mon-1"/><a name="30947"/>30947: <b>mon_open_and_exit_multi_mon</b>(InitState) -&gt;
<a name="30948"/>30948:     OwnerSeq =
<a name="30949"/>30949:         [
<a name="30950"/>30950:          %% *** Wait for start order part ***
<a name="30951"/>30951:          #{desc =&gt; &quot;await start (from tester)&quot;,
<a name="30952"/>30952:            cmd  =&gt; fun(State) -&gt;
<a name="30953"/>30953:                            Tester = ?SEV_AWAIT_START(),
<a name="30954"/>30954:                            {ok, State#{tester =&gt; Tester}}
<a name="30955"/>30955:                    end},
<a name="30956"/>30956:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="30957"/>30957:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="30958"/>30958:                            _MRef = erlang:monitor(process, Tester),
<a name="30959"/>30959:                            ok
<a name="30960"/>30960:                    end},
<a name="30961"/>30961: 
<a name="30962"/>30962:          %% *** Init part ***
<a name="30963"/>30963:          #{desc =&gt; &quot;create socket&quot;,
<a name="30964"/>30964:            cmd  =&gt; fun(#{domain   := Domain, 
<a name="30965"/>30965:                          type     := Type, 
<a name="30966"/>30966:                          protocol := Proto} = State) -&gt;
<a name="30967"/>30967:                            case socket:open(Domain, Type, Proto) of
<a name="30968"/>30968:                                {ok, Sock} -&gt;
<a name="30969"/>30969:                                    {ok, State#{sock =&gt; Sock}};
<a name="30970"/>30970:                                {error, _} = ERROR -&gt;
<a name="30971"/>30971:                                    ERROR
<a name="30972"/>30972:                            end
<a name="30973"/>30973:                    end},
<a name="30974"/>30974:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="30975"/>30975:            cmd  =&gt; fun(#{tester := Tester, sock := Sock} = _State) -&gt;
<a name="30976"/>30976:                            ?SEV_ANNOUNCE_READY(Tester, init, Sock),
<a name="30977"/>30977:                            ok
<a name="30978"/>30978:                    end},
<a name="30979"/>30979: 
<a name="30980"/>30980:          %% The actual test
<a name="30981"/>30981:          #{desc =&gt; &quot;await terminate (from tester)&quot;,
<a name="30982"/>30982:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="30983"/>30983:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="30984"/>30984:                                ok -&gt;
<a name="30985"/>30985:                                    {ok, maps:remove(tester, State)};
<a name="30986"/>30986:                                {error, _} = ERROR -&gt;
<a name="30987"/>30987:                                    ERROR
<a name="30988"/>30988:                            end
<a name="30989"/>30989:                    end},
<a name="30990"/>30990: 
<a name="30991"/>30991:          %% *** We are done ***
<a name="30992"/>30992:          ?SEV_FINISH_NORMAL
<a name="30993"/>30993:         ],
<a name="30994"/>30994: 
<a name="30995"/>30995: 
<a name="30996"/>30996:     ClientSeq =
<a name="30997"/>30997:         [
<a name="30998"/>30998:          %% *** Wait for start order part ***
<a name="30999"/>30999:          #{desc =&gt; &quot;await start (from tester)&quot;,
<a name="31000"/>31000:            cmd  =&gt; fun(State) -&gt;
<a name="31001"/>31001:                            Tester = ?SEV_AWAIT_START(),
<a name="31002"/>31002:                            {ok, State#{tester =&gt; Tester}}
<a name="31003"/>31003:                    end},
<a name="31004"/>31004:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="31005"/>31005:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="31006"/>31006:                            _MRef = erlang:monitor(process, Tester),
<a name="31007"/>31007:                            ok
<a name="31008"/>31008:                    end},
<a name="31009"/>31009: 
<a name="31010"/>31010:          %% *** Init part ***
<a name="31011"/>31011:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="31012"/>31012:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="31013"/>31013:                            ?SEV_ANNOUNCE_READY(Tester, init),
<a name="31014"/>31014:                            ok
<a name="31015"/>31015:                    end},
<a name="31016"/>31016:          #{desc =&gt; &quot;await continue (socket)&quot;,
<a name="31017"/>31017:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="31018"/>31018:                            {ok, Sock} =
<a name="31019"/>31019: 			       ?SEV_AWAIT_CONTINUE(Tester, tester, socket),
<a name="31020"/>31020: 			   ?SEV_IPRINT(&quot;Socket: ~p&quot;, [Sock]),
<a name="31021"/>31021: 			   {ok, State#{sock =&gt; Sock}}
<a name="31022"/>31022:                    end},
<a name="31023"/>31023: 
<a name="31024"/>31024: 
<a name="31025"/>31025:          %% The actual test
<a name="31026"/>31026:          #{desc =&gt; &quot;await continue (monitor)&quot;,
<a name="31027"/>31027:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="31028"/>31028:                            ?SEV_AWAIT_CONTINUE(Tester, tester, monitor)
<a name="31029"/>31029:                    end},
<a name="31030"/>31030:          #{desc =&gt; &quot;verify own number of monitors (=0)&quot;,
<a name="31031"/>31031:            cmd  =&gt; fun(_State) -&gt;
<a name="31032"/>31032: 			   0 = socket:number_of_monitors(self()),
<a name="31033"/>31033: 			   ok
<a name="31034"/>31034:                    end},
<a name="31035"/>31035:          #{desc =&gt; &quot;monitor socket&quot;,
<a name="31036"/>31036:            cmd  =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="31037"/>31037:                            MRef = socket:monitor(Sock),
<a name="31038"/>31038: 			   ?SEV_IPRINT(&quot;Monitor: ~p&quot;, [MRef]),
<a name="31039"/>31039: 			   {ok, State#{mon =&gt; MRef}}
<a name="31040"/>31040:                    end},
<a name="31041"/>31041:          #{desc =&gt; &quot;verify own number of monitors (=1)&quot;,
<a name="31042"/>31042:            cmd  =&gt; fun(_State) -&gt;
<a name="31043"/>31043: 			   1 = socket:number_of_monitors(self()),
<a name="31044"/>31044: 			   ok
<a name="31045"/>31045:                    end},
<a name="31046"/>31046: 
<a name="31047"/>31047:          #{desc =&gt; &quot;announce ready (monitor)&quot;,
<a name="31048"/>31048:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="31049"/>31049:                            ?SEV_ANNOUNCE_READY(Tester, monitor),
<a name="31050"/>31050:                            ok
<a name="31051"/>31051:                    end},
<a name="31052"/>31052: 
<a name="31053"/>31053:          #{desc =&gt; &quot;await continue (down)&quot;,
<a name="31054"/>31054:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="31055"/>31055:                            ?SEV_AWAIT_CONTINUE(Tester, tester, down)
<a name="31056"/>31056:                    end},
<a name="31057"/>31057: 
<a name="31058"/>31058:          #{desc =&gt; &quot;await socket down&quot;,
<a name="31059"/>31059:            cmd  =&gt; fun(#{sock := Sock,
<a name="31060"/>31060: 			 mon  := MRef} = State) -&gt;
<a name="31061"/>31061: 			   receive
<a name="31062"/>31062: 			       {'DOWN', MRef, socket, Sock, Info} -&gt;
<a name="31063"/>31063: 				   ?SEV_IPRINT(&quot;received expected down: &quot;
<a name="31064"/>31064: 					       &quot;~n      MRef:   ~p&quot;
<a name="31065"/>31065: 					       &quot;~n      Socket: ~p&quot;
<a name="31066"/>31066: 					       &quot;~n      Info:   ~p&quot;,
<a name="31067"/>31067: 					       [MRef, Sock, Info]),
<a name="31068"/>31068: 				   State2 = maps:remove(mon, State),
<a name="31069"/>31069: 				   State3 = maps:remove(sock, State2),
<a name="31070"/>31070: 				   {ok, State3}
<a name="31071"/>31071: 			   after 5000 -&gt;
<a name="31072"/>31072: 				   ?SEV_EPRINT(&quot;socket down timeout&quot;),
<a name="31073"/>31073: 				   {error, timeout}
<a name="31074"/>31074: 			   end
<a name="31075"/>31075:                    end},
<a name="31076"/>31076:          #{desc =&gt; &quot;verify own number of monitors (=0)&quot;,
<a name="31077"/>31077:            cmd  =&gt; fun(_State) -&gt;
<a name="31078"/>31078: 			   0 = socket:number_of_monitors(self()),
<a name="31079"/>31079: 			   ok
<a name="31080"/>31080:                    end},
<a name="31081"/>31081: 
<a name="31082"/>31082:          #{desc =&gt; &quot;announce ready (down)&quot;,
<a name="31083"/>31083:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="31084"/>31084:                            ?SEV_ANNOUNCE_READY(Tester, down),
<a name="31085"/>31085:                            ok
<a name="31086"/>31086:                    end},
<a name="31087"/>31087: 
<a name="31088"/>31088: 
<a name="31089"/>31089:          #{desc =&gt; &quot;await terminate (from tester)&quot;,
<a name="31090"/>31090:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="31091"/>31091:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="31092"/>31092:                                ok -&gt;
<a name="31093"/>31093:                                    {ok, maps:remove(tester, State)};
<a name="31094"/>31094:                                {error, _} = ERROR -&gt;
<a name="31095"/>31095:                                    ERROR
<a name="31096"/>31096:                            end
<a name="31097"/>31097:                    end},
<a name="31098"/>31098: 
<a name="31099"/>31099:          %% *** We are done ***
<a name="31100"/>31100:          ?SEV_FINISH_NORMAL
<a name="31101"/>31101:         ],
<a name="31102"/>31102: 
<a name="31103"/>31103:     TesterSeq =
<a name="31104"/>31104:         [
<a name="31105"/>31105:          %% *** Init part ***
<a name="31106"/>31106:          #{desc =&gt; &quot;monitor 'owner'&quot;,
<a name="31107"/>31107:            cmd  =&gt; fun(#{owner := Owner} = _State) -&gt;
<a name="31108"/>31108:                            _MRef = erlang:monitor(process, Owner),
<a name="31109"/>31109:                            ok
<a name="31110"/>31110:                    end},
<a name="31111"/>31111:          #{desc =&gt; &quot;order (owner) start&quot;,
<a name="31112"/>31112:            cmd  =&gt; fun(#{owner := Pid} = _State) -&gt;
<a name="31113"/>31113:                            ?SEV_ANNOUNCE_START(Pid),
<a name="31114"/>31114:                            ok
<a name="31115"/>31115:                    end},
<a name="31116"/>31116:          #{desc =&gt; &quot;await (owner) ready&quot;,
<a name="31117"/>31117:            cmd  =&gt; fun(#{owner := Pid} = State) -&gt;
<a name="31118"/>31118:                            {ok, Sock} = ?SEV_AWAIT_READY(Pid, owner, init),
<a name="31119"/>31119:                            {ok, State#{sock =&gt; Sock}}
<a name="31120"/>31120:                    end},
<a name="31121"/>31121: 
<a name="31122"/>31122:          #{desc =&gt; &quot;monitor 'client 1'&quot;,
<a name="31123"/>31123:            cmd  =&gt; fun(#{client1 := Pid} = _State) -&gt;
<a name="31124"/>31124:                            _MRef = erlang:monitor(process, Pid),
<a name="31125"/>31125:                            ok
<a name="31126"/>31126:                    end},
<a name="31127"/>31127:          #{desc =&gt; &quot;order (client 1) start&quot;,
<a name="31128"/>31128:            cmd  =&gt; fun(#{client1 := Pid} = _State) -&gt;
<a name="31129"/>31129:                            ?SEV_ANNOUNCE_START(Pid),
<a name="31130"/>31130:                            ok
<a name="31131"/>31131:                    end},
<a name="31132"/>31132:          #{desc =&gt; &quot;await (client 1) ready&quot;,
<a name="31133"/>31133:            cmd  =&gt; fun(#{client1 := Pid} = _State) -&gt;
<a name="31134"/>31134:                            ok = ?SEV_AWAIT_READY(Pid, client1, init)
<a name="31135"/>31135:                    end},
<a name="31136"/>31136:          #{desc =&gt; &quot;send socket to client 1&quot;,
<a name="31137"/>31137:            cmd  =&gt; fun(#{client1 := Pid, sock := Sock} = _State) -&gt;
<a name="31138"/>31138:                            ?SEV_ANNOUNCE_CONTINUE(Pid, socket, Sock),
<a name="31139"/>31139:                            ok
<a name="31140"/>31140:                    end},
<a name="31141"/>31141: 
<a name="31142"/>31142:          #{desc =&gt; &quot;monitor 'client 2'&quot;,
<a name="31143"/>31143:            cmd  =&gt; fun(#{client2 := Pid} = _State) -&gt;
<a name="31144"/>31144:                            _MRef = erlang:monitor(process, Pid),
<a name="31145"/>31145:                            ok
<a name="31146"/>31146:                    end},
<a name="31147"/>31147:          #{desc =&gt; &quot;order (client 2) start&quot;,
<a name="31148"/>31148:            cmd  =&gt; fun(#{client2 := Pid} = _State) -&gt;
<a name="31149"/>31149:                            ?SEV_ANNOUNCE_START(Pid),
<a name="31150"/>31150:                            ok
<a name="31151"/>31151:                    end},
<a name="31152"/>31152:          #{desc =&gt; &quot;await (client 2) ready&quot;,
<a name="31153"/>31153:            cmd  =&gt; fun(#{client2 := Pid} = _State) -&gt;
<a name="31154"/>31154:                            ok = ?SEV_AWAIT_READY(Pid, client2, init)
<a name="31155"/>31155:                    end},
<a name="31156"/>31156:          #{desc =&gt; &quot;send socket to client 2&quot;,
<a name="31157"/>31157:            cmd  =&gt; fun(#{client2 := Pid, sock := Sock} = _State) -&gt;
<a name="31158"/>31158:                            ?SEV_ANNOUNCE_CONTINUE(Pid, socket, Sock),
<a name="31159"/>31159:                            ok
<a name="31160"/>31160:                    end},
<a name="31161"/>31161: 
<a name="31162"/>31162:          #{desc =&gt; &quot;monitor 'client 3'&quot;,
<a name="31163"/>31163:            cmd  =&gt; fun(#{client3 := Pid} = _State) -&gt;
<a name="31164"/>31164:                            _MRef = erlang:monitor(process, Pid),
<a name="31165"/>31165:                            ok
<a name="31166"/>31166:                    end},
<a name="31167"/>31167:          #{desc =&gt; &quot;order (client 3) start&quot;,
<a name="31168"/>31168:            cmd  =&gt; fun(#{client3 := Pid} = _State) -&gt;
<a name="31169"/>31169:                            ?SEV_ANNOUNCE_START(Pid),
<a name="31170"/>31170:                            ok
<a name="31171"/>31171:                    end},
<a name="31172"/>31172:          #{desc =&gt; &quot;await (client 3) ready&quot;,
<a name="31173"/>31173:            cmd  =&gt; fun(#{client3 := Pid} = _State) -&gt;
<a name="31174"/>31174:                            ok = ?SEV_AWAIT_READY(Pid, client3, init)
<a name="31175"/>31175:                    end},
<a name="31176"/>31176:          #{desc =&gt; &quot;send socket to client 3&quot;,
<a name="31177"/>31177:            cmd  =&gt; fun(#{client3 := Pid, sock := Sock} = _State) -&gt;
<a name="31178"/>31178:                            ?SEV_ANNOUNCE_CONTINUE(Pid, socket, Sock),
<a name="31179"/>31179:                            ok
<a name="31180"/>31180:                    end},
<a name="31181"/>31181: 
<a name="31182"/>31182:          #{desc =&gt; &quot;monitor 'client 4'&quot;,
<a name="31183"/>31183:            cmd  =&gt; fun(#{client4 := Pid} = _State) -&gt;
<a name="31184"/>31184:                            _MRef = erlang:monitor(process, Pid),
<a name="31185"/>31185:                            ok
<a name="31186"/>31186:                    end},
<a name="31187"/>31187:          #{desc =&gt; &quot;order (client 4) start&quot;,
<a name="31188"/>31188:            cmd  =&gt; fun(#{client4 := Pid} = _State) -&gt;
<a name="31189"/>31189:                            ?SEV_ANNOUNCE_START(Pid),
<a name="31190"/>31190:                            ok
<a name="31191"/>31191:                    end},
<a name="31192"/>31192:          #{desc =&gt; &quot;await (client 4) ready&quot;,
<a name="31193"/>31193:            cmd  =&gt; fun(#{client4 := Pid} = _State) -&gt;
<a name="31194"/>31194:                            ok = ?SEV_AWAIT_READY(Pid, client4, init)
<a name="31195"/>31195:                    end},
<a name="31196"/>31196:          #{desc =&gt; &quot;send socket to client 4&quot;,
<a name="31197"/>31197:            cmd  =&gt; fun(#{client4 := Pid, sock := Sock} = _State) -&gt;
<a name="31198"/>31198:                            ?SEV_ANNOUNCE_CONTINUE(Pid, socket, Sock),
<a name="31199"/>31199:                            ok
<a name="31200"/>31200:                    end},
<a name="31201"/>31201: 
<a name="31202"/>31202:          #{desc =&gt; &quot;monitor 'client 5'&quot;,
<a name="31203"/>31203:            cmd  =&gt; fun(#{client5 := Pid} = _State) -&gt;
<a name="31204"/>31204:                            _MRef = erlang:monitor(process, Pid),
<a name="31205"/>31205:                            ok
<a name="31206"/>31206:                    end},
<a name="31207"/>31207:          #{desc =&gt; &quot;order (client 5) start&quot;,
<a name="31208"/>31208:            cmd  =&gt; fun(#{client5 := Pid} = _State) -&gt;
<a name="31209"/>31209:                            ?SEV_ANNOUNCE_START(Pid),
<a name="31210"/>31210:                            ok
<a name="31211"/>31211:                    end},
<a name="31212"/>31212:          #{desc =&gt; &quot;await (client 5) ready&quot;,
<a name="31213"/>31213:            cmd  =&gt; fun(#{client5 := Pid} = _State) -&gt;
<a name="31214"/>31214:                            ok = ?SEV_AWAIT_READY(Pid, client5, init)
<a name="31215"/>31215:                    end},
<a name="31216"/>31216:          #{desc =&gt; &quot;send socket to client 5&quot;,
<a name="31217"/>31217:            cmd  =&gt; fun(#{client5 := Pid, sock := Sock} = _State) -&gt;
<a name="31218"/>31218:                            ?SEV_ANNOUNCE_CONTINUE(Pid, socket, Sock),
<a name="31219"/>31219:                            ok
<a name="31220"/>31220:                    end},
<a name="31221"/>31221: 
<a name="31222"/>31222: 
<a name="31223"/>31223:          %% The actual test
<a name="31224"/>31224:          #{desc =&gt; &quot;verify total number of monitors (=0)&quot;,
<a name="31225"/>31225:            cmd  =&gt; fun(_State) -&gt;
<a name="31226"/>31226: 			   0 = socket:number_of_monitors(),
<a name="31227"/>31227: 			   ok
<a name="31228"/>31228:                    end},
<a name="31229"/>31229: 
<a name="31230"/>31230:          #{desc =&gt; &quot;order client 1 to monitor&quot;,
<a name="31231"/>31231:            cmd  =&gt; fun(#{client1 := Pid} = _State) -&gt;
<a name="31232"/>31232:                            ?SEV_ANNOUNCE_CONTINUE(Pid, monitor),
<a name="31233"/>31233:                            ok
<a name="31234"/>31234:                    end},
<a name="31235"/>31235:          #{desc =&gt; &quot;await (client 1) ready&quot;,
<a name="31236"/>31236:            cmd  =&gt; fun(#{client1 := Pid} = _State) -&gt;
<a name="31237"/>31237:                            ok = ?SEV_AWAIT_READY(Pid, client1, monitor)
<a name="31238"/>31238:                    end},
<a name="31239"/>31239:          #{desc =&gt; &quot;verify total number of monitors (=1)&quot;,
<a name="31240"/>31240:            cmd  =&gt; fun(_State) -&gt;
<a name="31241"/>31241: 			   1 = socket:number_of_monitors(),
<a name="31242"/>31242: 			   ok
<a name="31243"/>31243:                    end},
<a name="31244"/>31244: 
<a name="31245"/>31245:          #{desc =&gt; &quot;order client 2 to monitor&quot;,
<a name="31246"/>31246:            cmd  =&gt; fun(#{client2 := Pid} = _State) -&gt;
<a name="31247"/>31247:                            ?SEV_ANNOUNCE_CONTINUE(Pid, monitor),
<a name="31248"/>31248:                            ok
<a name="31249"/>31249:                    end},
<a name="31250"/>31250:          #{desc =&gt; &quot;await (client 2) ready&quot;,
<a name="31251"/>31251:            cmd  =&gt; fun(#{client2 := Pid} = _State) -&gt;
<a name="31252"/>31252:                            ok = ?SEV_AWAIT_READY(Pid, client2, monitor)
<a name="31253"/>31253:                    end},
<a name="31254"/>31254:          #{desc =&gt; &quot;verify total number of monitors (=2)&quot;,
<a name="31255"/>31255:            cmd  =&gt; fun(_State) -&gt;
<a name="31256"/>31256: 			   2 = socket:number_of_monitors(),
<a name="31257"/>31257: 			   ok
<a name="31258"/>31258:                    end},
<a name="31259"/>31259: 
<a name="31260"/>31260:          #{desc =&gt; &quot;order client 3 to monitor&quot;,
<a name="31261"/>31261:            cmd  =&gt; fun(#{client3 := Pid} = _State) -&gt;
<a name="31262"/>31262:                            ?SEV_ANNOUNCE_CONTINUE(Pid, monitor),
<a name="31263"/>31263:                            ok
<a name="31264"/>31264:                    end},
<a name="31265"/>31265:          #{desc =&gt; &quot;await (client 3) ready&quot;,
<a name="31266"/>31266:            cmd  =&gt; fun(#{client3 := Pid} = _State) -&gt;
<a name="31267"/>31267:                            ok = ?SEV_AWAIT_READY(Pid, client3, monitor)
<a name="31268"/>31268:                    end},
<a name="31269"/>31269:          #{desc =&gt; &quot;verify total number of monitors (=3)&quot;,
<a name="31270"/>31270:            cmd  =&gt; fun(_State) -&gt;
<a name="31271"/>31271: 			   3 = socket:number_of_monitors(),
<a name="31272"/>31272: 			   ok
<a name="31273"/>31273:                    end},
<a name="31274"/>31274: 
<a name="31275"/>31275:          #{desc =&gt; &quot;order client 4 to monitor&quot;,
<a name="31276"/>31276:            cmd  =&gt; fun(#{client4 := Pid} = _State) -&gt;
<a name="31277"/>31277:                            ?SEV_ANNOUNCE_CONTINUE(Pid, monitor),
<a name="31278"/>31278:                            ok
<a name="31279"/>31279:                    end},
<a name="31280"/>31280:          #{desc =&gt; &quot;await (client 4) ready&quot;,
<a name="31281"/>31281:            cmd  =&gt; fun(#{client4 := Pid} = _State) -&gt;
<a name="31282"/>31282:                            ok = ?SEV_AWAIT_READY(Pid, client4, monitor)
<a name="31283"/>31283:                    end},
<a name="31284"/>31284:          #{desc =&gt; &quot;verify total number of monitors (=4)&quot;,
<a name="31285"/>31285:            cmd  =&gt; fun(_State) -&gt;
<a name="31286"/>31286: 			   4 = socket:number_of_monitors(),
<a name="31287"/>31287: 			   ok
<a name="31288"/>31288:                    end},
<a name="31289"/>31289: 
<a name="31290"/>31290:          #{desc =&gt; &quot;order client 5 to monitor&quot;,
<a name="31291"/>31291:            cmd  =&gt; fun(#{client5 := Pid} = _State) -&gt;
<a name="31292"/>31292:                            ?SEV_ANNOUNCE_CONTINUE(Pid, monitor),
<a name="31293"/>31293:                            ok
<a name="31294"/>31294:                    end},
<a name="31295"/>31295:          #{desc =&gt; &quot;await (client 5) ready&quot;,
<a name="31296"/>31296:            cmd  =&gt; fun(#{client5 := Pid} = _State) -&gt;
<a name="31297"/>31297:                            ok = ?SEV_AWAIT_READY(Pid, client5, monitor)
<a name="31298"/>31298:                    end},
<a name="31299"/>31299:          #{desc =&gt; &quot;verify total number of monitors (=5)&quot;,
<a name="31300"/>31300:            cmd  =&gt; fun(_State) -&gt;
<a name="31301"/>31301: 			   5 = socket:number_of_monitors(),
<a name="31302"/>31302: 			   ok
<a name="31303"/>31303:                    end},
<a name="31304"/>31304: 
<a name="31305"/>31305:          #{desc =&gt; &quot;order client 1 to await down&quot;,
<a name="31306"/>31306:            cmd  =&gt; fun(#{client1 := Pid} = _State) -&gt;
<a name="31307"/>31307:                            ?SEV_ANNOUNCE_CONTINUE(Pid, down),
<a name="31308"/>31308:                            ok
<a name="31309"/>31309:                    end},
<a name="31310"/>31310:          #{desc =&gt; &quot;order client 2 to await down&quot;,
<a name="31311"/>31311:            cmd  =&gt; fun(#{client2 := Pid} = _State) -&gt;
<a name="31312"/>31312:                            ?SEV_ANNOUNCE_CONTINUE(Pid, down),
<a name="31313"/>31313:                            ok
<a name="31314"/>31314:                    end},
<a name="31315"/>31315:          #{desc =&gt; &quot;order client 3 to await down&quot;,
<a name="31316"/>31316:            cmd  =&gt; fun(#{client3 := Pid} = _State) -&gt;
<a name="31317"/>31317:                            ?SEV_ANNOUNCE_CONTINUE(Pid, down),
<a name="31318"/>31318:                            ok
<a name="31319"/>31319:                    end},
<a name="31320"/>31320:          #{desc =&gt; &quot;order client 4 to await down&quot;,
<a name="31321"/>31321:            cmd  =&gt; fun(#{client4 := Pid} = _State) -&gt;
<a name="31322"/>31322:                            ?SEV_ANNOUNCE_CONTINUE(Pid, down),
<a name="31323"/>31323:                            ok
<a name="31324"/>31324:                    end},
<a name="31325"/>31325:          #{desc =&gt; &quot;order client 5 to await down&quot;,
<a name="31326"/>31326:            cmd  =&gt; fun(#{client5 := Pid} = _State) -&gt;
<a name="31327"/>31327:                            ?SEV_ANNOUNCE_CONTINUE(Pid, down),
<a name="31328"/>31328:                            ok
<a name="31329"/>31329:                    end},
<a name="31330"/>31330: 
<a name="31331"/>31331: 
<a name="31332"/>31332:          #{desc =&gt; &quot;order (owner) terminate&quot;,
<a name="31333"/>31333:            cmd  =&gt; fun(#{owner := Pid} = _State) -&gt;
<a name="31334"/>31334:                            ?SEV_ANNOUNCE_TERMINATE(Pid),
<a name="31335"/>31335:                            ok
<a name="31336"/>31336:                    end},
<a name="31337"/>31337:          #{desc =&gt; &quot;await (owner) termination&quot;,
<a name="31338"/>31338:            cmd  =&gt; fun(#{owner := Pid} = State) -&gt;
<a name="31339"/>31339:                            case ?SEV_AWAIT_TERMINATION(Pid) of
<a name="31340"/>31340:                                ok -&gt;
<a name="31341"/>31341:                                    {ok, maps:remove(owner, State)};
<a name="31342"/>31342:                                {error, _} = ERROR -&gt;
<a name="31343"/>31343:                                    ERROR
<a name="31344"/>31344:                            end
<a name="31345"/>31345:                    end},
<a name="31346"/>31346: 
<a name="31347"/>31347:          #{desc =&gt; &quot;await (client 1) down received&quot;,
<a name="31348"/>31348:            cmd  =&gt; fun(#{client1 := Pid} = _State) -&gt;
<a name="31349"/>31349:                            ok = ?SEV_AWAIT_READY(Pid, client1, down)
<a name="31350"/>31350:                    end},
<a name="31351"/>31351:          #{desc =&gt; &quot;await (client 2) down received&quot;,
<a name="31352"/>31352:            cmd  =&gt; fun(#{client2 := Pid} = _State) -&gt;
<a name="31353"/>31353:                            ok = ?SEV_AWAIT_READY(Pid, client2, down)
<a name="31354"/>31354:                    end},
<a name="31355"/>31355:          #{desc =&gt; &quot;await (client 3) down received&quot;,
<a name="31356"/>31356:            cmd  =&gt; fun(#{client3 := Pid} = _State) -&gt;
<a name="31357"/>31357:                            ok = ?SEV_AWAIT_READY(Pid, client3, down)
<a name="31358"/>31358:                    end},
<a name="31359"/>31359:          #{desc =&gt; &quot;await (client 4) down received&quot;,
<a name="31360"/>31360:            cmd  =&gt; fun(#{client4 := Pid} = _State) -&gt;
<a name="31361"/>31361:                            ok = ?SEV_AWAIT_READY(Pid, client4, down)
<a name="31362"/>31362:                    end},
<a name="31363"/>31363:          #{desc =&gt; &quot;await (client 5) down received&quot;,
<a name="31364"/>31364:            cmd  =&gt; fun(#{client5 := Pid} = _State) -&gt;
<a name="31365"/>31365:                            ok = ?SEV_AWAIT_READY(Pid, client5, down)
<a name="31366"/>31366:                    end},
<a name="31367"/>31367:          #{desc =&gt; &quot;verify own number of monitors (=0)&quot;,
<a name="31368"/>31368:            cmd  =&gt; fun(_State) -&gt;
<a name="31369"/>31369: 			   0 = socket:number_of_monitors(self()),
<a name="31370"/>31370: 			   ok
<a name="31371"/>31371:                    end},
<a name="31372"/>31372: 
<a name="31373"/>31373:          %% Cleanup
<a name="31374"/>31374:          #{desc =&gt; &quot;order (client 1) terminate&quot;,
<a name="31375"/>31375:            cmd  =&gt; fun(#{client1 := Pid} = _State) -&gt;
<a name="31376"/>31376:                            ?SEV_ANNOUNCE_TERMINATE(Pid),
<a name="31377"/>31377:                            ok
<a name="31378"/>31378:                    end},
<a name="31379"/>31379:          #{desc =&gt; &quot;await (client 1) termination&quot;,
<a name="31380"/>31380:            cmd  =&gt; fun(#{client1 := Pid} = State) -&gt;
<a name="31381"/>31381:                            case ?SEV_AWAIT_TERMINATION(Pid) of
<a name="31382"/>31382:                                ok -&gt;
<a name="31383"/>31383:                                    {ok, maps:remove(client1, State)};
<a name="31384"/>31384:                                {error, _} = ERROR -&gt;
<a name="31385"/>31385:                                    ERROR
<a name="31386"/>31386:                            end
<a name="31387"/>31387:                    end},
<a name="31388"/>31388: 
<a name="31389"/>31389:          #{desc =&gt; &quot;order (client 2) terminate&quot;,
<a name="31390"/>31390:            cmd  =&gt; fun(#{client2 := Pid} = _State) -&gt;
<a name="31391"/>31391:                            ?SEV_ANNOUNCE_TERMINATE(Pid),
<a name="31392"/>31392:                            ok
<a name="31393"/>31393:                    end},
<a name="31394"/>31394:          #{desc =&gt; &quot;await (client 2) termination&quot;,
<a name="31395"/>31395:            cmd  =&gt; fun(#{client2 := Pid} = State) -&gt;
<a name="31396"/>31396:                            case ?SEV_AWAIT_TERMINATION(Pid) of
<a name="31397"/>31397:                                ok -&gt;
<a name="31398"/>31398:                                    {ok, maps:remove(client2, State)};
<a name="31399"/>31399:                                {error, _} = ERROR -&gt;
<a name="31400"/>31400:                                    ERROR
<a name="31401"/>31401:                            end
<a name="31402"/>31402:                    end},
<a name="31403"/>31403: 
<a name="31404"/>31404:          #{desc =&gt; &quot;order (client 3) terminate&quot;,
<a name="31405"/>31405:            cmd  =&gt; fun(#{client3 := Pid} = _State) -&gt;
<a name="31406"/>31406:                            ?SEV_ANNOUNCE_TERMINATE(Pid),
<a name="31407"/>31407:                            ok
<a name="31408"/>31408:                    end},
<a name="31409"/>31409:          #{desc =&gt; &quot;await (client 3) termination&quot;,
<a name="31410"/>31410:            cmd  =&gt; fun(#{client3 := Pid} = State) -&gt;
<a name="31411"/>31411:                            case ?SEV_AWAIT_TERMINATION(Pid) of
<a name="31412"/>31412:                                ok -&gt;
<a name="31413"/>31413:                                    {ok, maps:remove(client3, State)};
<a name="31414"/>31414:                                {error, _} = ERROR -&gt;
<a name="31415"/>31415:                                    ERROR
<a name="31416"/>31416:                            end
<a name="31417"/>31417:                    end},
<a name="31418"/>31418: 
<a name="31419"/>31419:          #{desc =&gt; &quot;order (client 4) terminate&quot;,
<a name="31420"/>31420:            cmd  =&gt; fun(#{client4 := Pid} = _State) -&gt;
<a name="31421"/>31421:                            ?SEV_ANNOUNCE_TERMINATE(Pid),
<a name="31422"/>31422:                            ok
<a name="31423"/>31423:                    end},
<a name="31424"/>31424:          #{desc =&gt; &quot;await (client 4) termination&quot;,
<a name="31425"/>31425:            cmd  =&gt; fun(#{client4 := Pid} = State) -&gt;
<a name="31426"/>31426:                            case ?SEV_AWAIT_TERMINATION(Pid) of
<a name="31427"/>31427:                                ok -&gt;
<a name="31428"/>31428:                                    {ok, maps:remove(client4, State)};
<a name="31429"/>31429:                                {error, _} = ERROR -&gt;
<a name="31430"/>31430:                                    ERROR
<a name="31431"/>31431:                            end
<a name="31432"/>31432:                    end},
<a name="31433"/>31433: 
<a name="31434"/>31434:          #{desc =&gt; &quot;order (client 5) terminate&quot;,
<a name="31435"/>31435:            cmd  =&gt; fun(#{client5 := Pid} = _State) -&gt;
<a name="31436"/>31436:                            ?SEV_ANNOUNCE_TERMINATE(Pid),
<a name="31437"/>31437:                            ok
<a name="31438"/>31438:                    end},
<a name="31439"/>31439:          #{desc =&gt; &quot;await (client 5) termination&quot;,
<a name="31440"/>31440:            cmd  =&gt; fun(#{client5 := Pid} = State) -&gt;
<a name="31441"/>31441:                            case ?SEV_AWAIT_TERMINATION(Pid) of
<a name="31442"/>31442:                                ok -&gt;
<a name="31443"/>31443:                                    {ok, maps:remove(client5, State)};
<a name="31444"/>31444:                                {error, _} = ERROR -&gt;
<a name="31445"/>31445:                                    ERROR
<a name="31446"/>31446:                            end
<a name="31447"/>31447:                    end},
<a name="31448"/>31448: 
<a name="31449"/>31449:          %% *** We are done ***
<a name="31450"/>31450:          ?SEV_FINISH_NORMAL
<a name="31451"/>31451:         ],
<a name="31452"/>31452: 
<a name="31453"/>31453:     i(&quot;start (socket) owner evaluator&quot;),
<a name="31454"/>31454:     Owner = ?SEV_START(&quot;owner&quot;, OwnerSeq, InitState),
<a name="31455"/>31455: 
<a name="31456"/>31456:     i(&quot;start client 1 evaluator&quot;),
<a name="31457"/>31457:     Client1 = ?SEV_START(&quot;client-1&quot;, ClientSeq, InitState),
<a name="31458"/>31458: 
<a name="31459"/>31459:     i(&quot;start client 2 evaluator&quot;),
<a name="31460"/>31460:     Client2 = ?SEV_START(&quot;client-2&quot;, ClientSeq, InitState),
<a name="31461"/>31461: 
<a name="31462"/>31462:     i(&quot;start client 3 evaluator&quot;),
<a name="31463"/>31463:     Client3 = ?SEV_START(&quot;client-3&quot;, ClientSeq, InitState),
<a name="31464"/>31464: 
<a name="31465"/>31465:     i(&quot;start client 4 evaluator&quot;),
<a name="31466"/>31466:     Client4 = ?SEV_START(&quot;client-4&quot;, ClientSeq, InitState),
<a name="31467"/>31467: 
<a name="31468"/>31468:     i(&quot;start client 5 evaluator&quot;),
<a name="31469"/>31469:     Client5 = ?SEV_START(&quot;client-5&quot;, ClientSeq, InitState),
<a name="31470"/>31470: 
<a name="31471"/>31471:     i(&quot;start tester evaluator&quot;),
<a name="31472"/>31472:     TesterInitState = #{owner   =&gt; Owner#ev.pid,
<a name="31473"/>31473: 			client1 =&gt; Client1#ev.pid,
<a name="31474"/>31474: 			client2 =&gt; Client2#ev.pid,
<a name="31475"/>31475: 			client3 =&gt; Client3#ev.pid,
<a name="31476"/>31476: 			client4 =&gt; Client4#ev.pid,
<a name="31477"/>31477: 			client5 =&gt; Client5#ev.pid},
<a name="31478"/>31478:     Tester = ?SEV_START(&quot;tester&quot;, TesterSeq, TesterInitState),
<a name="31479"/>31479: 
<a name="31480"/>31480:     i(&quot;await evaluator&quot;),
<a name="mon_open_and_exit_multi_mon-last_expr"/><a name="31481"/>31481: <b>    ok = ?SEV_AWAIT_FINISH</b>([Owner, Tester]).
<a name="31482"/>31482: 
<a name="31483"/>31483: 
<a name="31484"/>31484: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="31485"/>31485: <i>%% Create several sockets (by 'owner' process), monitor each from several</i>
<a name="31486"/>31486: <i>%% different processes, then close each socket (from 'owner').</i>
<a name="31487"/>31487: <i>%% The processes that did the monitor shall receive one socket DOWN for</i>
<a name="31488"/>31488: <i>%% each socket.</i>
<a name="31489"/>31489: 
<a name="monitor_open_and_close_multi_socks_and_mon-1"/><a name="31490"/>31490: <b>monitor_open_and_close_multi_socks_and_mon</b>(_Config) when is_list(_Config) -&gt;
<a name="31491"/>31491:     ?TT(?SECS(30)),
<a name="monitor_open_and_close_multi_socks_and_mon-last_expr"/><a name="31492"/>31492: <b>    tc_try</b>(monitor_open_and_close_multi_socks_and_mon,
<a name="31493"/>31493:            fun() -&gt;
<a name="31494"/>31494: 		   InitState = #{domain   =&gt; inet,
<a name="31495"/>31495:                                  type     =&gt; stream,
<a name="31496"/>31496:                                  protocol =&gt; tcp},
<a name="31497"/>31497:                    ok = mon_open_and_close_multi_socks_and_mon(InitState)
<a name="31498"/>31498:            end).
<a name="31499"/>31499: 
<a name="31500"/>31500: 
<a name="mon_open_and_close_multi_socks_and_mon-1"/><a name="31501"/>31501: <b>mon_open_and_close_multi_socks_and_mon</b>(InitState) -&gt;
<a name="31502"/>31502:     OwnerSeq =
<a name="31503"/>31503:         [
<a name="31504"/>31504:          %% *** Wait for start order part ***
<a name="31505"/>31505:          #{desc =&gt; &quot;await start (from tester)&quot;,
<a name="31506"/>31506:            cmd  =&gt; fun(State) -&gt;
<a name="31507"/>31507:                            Tester = ?SEV_AWAIT_START(),
<a name="31508"/>31508:                            {ok, State#{tester =&gt; Tester}}
<a name="31509"/>31509:                    end},
<a name="31510"/>31510:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="31511"/>31511:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="31512"/>31512:                            _MRef = erlang:monitor(process, Tester),
<a name="31513"/>31513:                            ok
<a name="31514"/>31514:                    end},
<a name="31515"/>31515: 
<a name="31516"/>31516:          %% *** Init part ***
<a name="31517"/>31517:          #{desc =&gt; &quot;create socket 1&quot;,
<a name="31518"/>31518:            cmd  =&gt; fun(#{domain   := Domain, 
<a name="31519"/>31519:                          type     := Type, 
<a name="31520"/>31520:                          protocol := Proto} = State) -&gt;
<a name="31521"/>31521:                            case socket:open(Domain, Type, Proto) of
<a name="31522"/>31522:                                {ok, Sock} -&gt;
<a name="31523"/>31523:                                    {ok, State#{sock1 =&gt; Sock}};
<a name="31524"/>31524:                                {error, _} = ERROR -&gt;
<a name="31525"/>31525:                                    ERROR
<a name="31526"/>31526:                            end
<a name="31527"/>31527:                    end},
<a name="31528"/>31528:          #{desc =&gt; &quot;create socket 2&quot;,
<a name="31529"/>31529:            cmd  =&gt; fun(#{domain   := Domain, 
<a name="31530"/>31530:                          type     := Type, 
<a name="31531"/>31531:                          protocol := Proto} = State) -&gt;
<a name="31532"/>31532:                            case socket:open(Domain, Type, Proto) of
<a name="31533"/>31533:                                {ok, Sock} -&gt;
<a name="31534"/>31534:                                    {ok, State#{sock2 =&gt; Sock}};
<a name="31535"/>31535:                                {error, _} = ERROR -&gt;
<a name="31536"/>31536:                                    ERROR
<a name="31537"/>31537:                            end
<a name="31538"/>31538:                    end},
<a name="31539"/>31539:          #{desc =&gt; &quot;create socket 3&quot;,
<a name="31540"/>31540:            cmd  =&gt; fun(#{domain   := Domain, 
<a name="31541"/>31541:                          type     := Type, 
<a name="31542"/>31542:                          protocol := Proto} = State) -&gt;
<a name="31543"/>31543:                            case socket:open(Domain, Type, Proto) of
<a name="31544"/>31544:                                {ok, Sock} -&gt;
<a name="31545"/>31545:                                    {ok, State#{sock3 =&gt; Sock}};
<a name="31546"/>31546:                                {error, _} = ERROR -&gt;
<a name="31547"/>31547:                                    ERROR
<a name="31548"/>31548:                            end
<a name="31549"/>31549:                    end},
<a name="31550"/>31550:          #{desc =&gt; &quot;create socket 4&quot;,
<a name="31551"/>31551:            cmd  =&gt; fun(#{domain   := Domain, 
<a name="31552"/>31552:                          type     := Type, 
<a name="31553"/>31553:                          protocol := Proto} = State) -&gt;
<a name="31554"/>31554:                            case socket:open(Domain, Type, Proto) of
<a name="31555"/>31555:                                {ok, Sock} -&gt;
<a name="31556"/>31556:                                    {ok, State#{sock4 =&gt; Sock}};
<a name="31557"/>31557:                                {error, _} = ERROR -&gt;
<a name="31558"/>31558:                                    ERROR
<a name="31559"/>31559:                            end
<a name="31560"/>31560:                    end},
<a name="31561"/>31561:          #{desc =&gt; &quot;create socket 5&quot;,
<a name="31562"/>31562:            cmd  =&gt; fun(#{domain   := Domain, 
<a name="31563"/>31563:                          type     := Type, 
<a name="31564"/>31564:                          protocol := Proto} = State) -&gt;
<a name="31565"/>31565:                            case socket:open(Domain, Type, Proto) of
<a name="31566"/>31566:                                {ok, Sock} -&gt;
<a name="31567"/>31567:                                    {ok, State#{sock5 =&gt; Sock}};
<a name="31568"/>31568:                                {error, _} = ERROR -&gt;
<a name="31569"/>31569:                                    ERROR
<a name="31570"/>31570:                            end
<a name="31571"/>31571:                    end},
<a name="31572"/>31572:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="31573"/>31573:            cmd  =&gt; fun(#{tester := Tester,
<a name="31574"/>31574: 			 sock1  := Sock1,
<a name="31575"/>31575: 			 sock2  := Sock2,
<a name="31576"/>31576: 			 sock3  := Sock3,
<a name="31577"/>31577: 			 sock4  := Sock4,
<a name="31578"/>31578: 			 sock5  := Sock5} = _State) -&gt;
<a name="31579"/>31579: 			   Socks = [Sock1, Sock2, Sock3, Sock4, Sock5],
<a name="31580"/>31580:                            ?SEV_ANNOUNCE_READY(Tester, init, Socks),
<a name="31581"/>31581:                            ok
<a name="31582"/>31582:                    end},
<a name="31583"/>31583: 
<a name="31584"/>31584:          %% The actual test
<a name="31585"/>31585:          #{desc =&gt; &quot;await continue (close1)&quot;,
<a name="31586"/>31586:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="31587"/>31587:                            ?SEV_AWAIT_CONTINUE(Tester, tester, close1)
<a name="31588"/>31588:                    end},
<a name="31589"/>31589:          #{desc =&gt; &quot;close socket 1&quot;,
<a name="31590"/>31590:            cmd  =&gt; fun(#{sock1 := Sock} = State) -&gt;
<a name="31591"/>31591:                            ok = socket:close(Sock),
<a name="31592"/>31592: 			   {ok, maps:remove(sock1, State)}
<a name="31593"/>31593:                    end},
<a name="31594"/>31594: 
<a name="31595"/>31595:          #{desc =&gt; &quot;await continue (close2)&quot;,
<a name="31596"/>31596:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="31597"/>31597:                            ?SEV_AWAIT_CONTINUE(Tester, tester, close2)
<a name="31598"/>31598:                    end},
<a name="31599"/>31599:          #{desc =&gt; &quot;close socket 2&quot;,
<a name="31600"/>31600:            cmd  =&gt; fun(#{sock2 := Sock} = State) -&gt;
<a name="31601"/>31601:                            ok = socket:close(Sock),
<a name="31602"/>31602: 			   {ok, maps:remove(sock2, State)}
<a name="31603"/>31603:                    end},
<a name="31604"/>31604: 
<a name="31605"/>31605:          #{desc =&gt; &quot;await continue (close3)&quot;,
<a name="31606"/>31606:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="31607"/>31607:                            ?SEV_AWAIT_CONTINUE(Tester, tester, close3)
<a name="31608"/>31608:                    end},
<a name="31609"/>31609:          #{desc =&gt; &quot;close socket 3&quot;,
<a name="31610"/>31610:            cmd  =&gt; fun(#{sock3 := Sock} = State) -&gt;
<a name="31611"/>31611:                            ok = socket:close(Sock),
<a name="31612"/>31612: 			   {ok, maps:remove(sock3, State)}
<a name="31613"/>31613:                    end},
<a name="31614"/>31614: 
<a name="31615"/>31615:          #{desc =&gt; &quot;await continue (close4)&quot;,
<a name="31616"/>31616:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="31617"/>31617:                            ?SEV_AWAIT_CONTINUE(Tester, tester, close4)
<a name="31618"/>31618:                    end},
<a name="31619"/>31619:          #{desc =&gt; &quot;close socket 4&quot;,
<a name="31620"/>31620:            cmd  =&gt; fun(#{sock4 := Sock} = State) -&gt;
<a name="31621"/>31621:                            ok = socket:close(Sock),
<a name="31622"/>31622: 			   {ok, maps:remove(sock4, State)}
<a name="31623"/>31623:                    end},
<a name="31624"/>31624: 
<a name="31625"/>31625:          #{desc =&gt; &quot;await continue (close5)&quot;,
<a name="31626"/>31626:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="31627"/>31627:                            ?SEV_AWAIT_CONTINUE(Tester, tester, close5)
<a name="31628"/>31628:                    end},
<a name="31629"/>31629:          #{desc =&gt; &quot;close socket 5&quot;,
<a name="31630"/>31630:            cmd  =&gt; fun(#{sock5 := Sock} = State) -&gt;
<a name="31631"/>31631:                            ok = socket:close(Sock),
<a name="31632"/>31632: 			   {ok, maps:remove(sock5, State)}
<a name="31633"/>31633:                    end},
<a name="31634"/>31634: 
<a name="31635"/>31635: 
<a name="31636"/>31636:          #{desc =&gt; &quot;await terminate (from tester)&quot;,
<a name="31637"/>31637:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="31638"/>31638:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="31639"/>31639:                                ok -&gt;
<a name="31640"/>31640:                                    {ok, maps:remove(tester, State)};
<a name="31641"/>31641:                                {error, _} = ERROR -&gt;
<a name="31642"/>31642:                                    ERROR
<a name="31643"/>31643:                            end
<a name="31644"/>31644:                    end},
<a name="31645"/>31645: 
<a name="31646"/>31646:          %% *** We are done ***
<a name="31647"/>31647:          ?SEV_FINISH_NORMAL
<a name="31648"/>31648:         ],
<a name="31649"/>31649: 
<a name="31650"/>31650: 
<a name="31651"/>31651:     ClientSeq =
<a name="31652"/>31652:         [
<a name="31653"/>31653:          %% *** Wait for start order part ***
<a name="31654"/>31654:          #{desc =&gt; &quot;await start (from tester)&quot;,
<a name="31655"/>31655:            cmd  =&gt; fun(State) -&gt;
<a name="31656"/>31656:                            Tester = ?SEV_AWAIT_START(),
<a name="31657"/>31657:                            {ok, State#{tester =&gt; Tester}}
<a name="31658"/>31658:                    end},
<a name="31659"/>31659:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="31660"/>31660:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="31661"/>31661:                            _MRef = erlang:monitor(process, Tester),
<a name="31662"/>31662:                            ok
<a name="31663"/>31663:                    end},
<a name="31664"/>31664: 
<a name="31665"/>31665:          %% *** Init part ***
<a name="31666"/>31666:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="31667"/>31667:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="31668"/>31668:                            ?SEV_ANNOUNCE_READY(Tester, init),
<a name="31669"/>31669:                            ok
<a name="31670"/>31670:                    end},
<a name="31671"/>31671:          #{desc =&gt; &quot;await continue (socket)&quot;,
<a name="31672"/>31672:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="31673"/>31673:                            {ok, [Sock1, Sock2, Sock3, Sock4, Sock5]} =
<a name="31674"/>31674: 			       ?SEV_AWAIT_CONTINUE(Tester, tester, socket),
<a name="31675"/>31675: 			   ?SEV_IPRINT(&quot;Sockets: &quot;
<a name="31676"/>31676: 				       &quot;~n   1: ~p&quot;
<a name="31677"/>31677: 				       &quot;~n   2: ~p&quot;
<a name="31678"/>31678: 				       &quot;~n   3: ~p&quot;
<a name="31679"/>31679: 				       &quot;~n   4: ~p&quot;
<a name="31680"/>31680: 				       &quot;~n   5: ~p&quot;,
<a name="31681"/>31681: 				       [Sock1, Sock2, Sock3, Sock4, Sock5]),
<a name="31682"/>31682: 			   {ok, State#{sock1 =&gt; Sock1,
<a name="31683"/>31683: 				       sock2 =&gt; Sock2,
<a name="31684"/>31684: 				       sock3 =&gt; Sock3,
<a name="31685"/>31685: 				       sock4 =&gt; Sock4,
<a name="31686"/>31686: 				       sock5 =&gt; Sock5}}
<a name="31687"/>31687:                    end},
<a name="31688"/>31688: 
<a name="31689"/>31689: 
<a name="31690"/>31690:          %% The actual test
<a name="31691"/>31691:          #{desc =&gt; &quot;await continue (monitor)&quot;,
<a name="31692"/>31692:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="31693"/>31693:                            ?SEV_AWAIT_CONTINUE(Tester, tester, monitor)
<a name="31694"/>31694:                    end},
<a name="31695"/>31695: 
<a name="31696"/>31696:          #{desc =&gt; &quot;verify own number of monitors (=0)&quot;,
<a name="31697"/>31697:            cmd  =&gt; fun(_State) -&gt;
<a name="31698"/>31698: 			   0 = socket:number_of_monitors(self()),
<a name="31699"/>31699: 			   ok
<a name="31700"/>31700:                    end},
<a name="31701"/>31701:          #{desc =&gt; &quot;monitor socket&quot;,
<a name="31702"/>31702:            cmd  =&gt; fun(#{sock1 := Sock1,
<a name="31703"/>31703: 			 sock2 := Sock2,
<a name="31704"/>31704: 			 sock3 := Sock3,
<a name="31705"/>31705: 			 sock4 := Sock4,
<a name="31706"/>31706: 			 sock5 := Sock5} = State) -&gt;
<a name="31707"/>31707:                            MRef1 = socket:monitor(Sock1),
<a name="31708"/>31708:                            MRef2 = socket:monitor(Sock2),
<a name="31709"/>31709:                            MRef3 = socket:monitor(Sock3),
<a name="31710"/>31710:                            MRef4 = socket:monitor(Sock4),
<a name="31711"/>31711:                            MRef5 = socket:monitor(Sock5),
<a name="31712"/>31712: 			   ?SEV_IPRINT(&quot;Monitors: &quot;
<a name="31713"/>31713: 				       &quot;~n   1: ~p&quot;
<a name="31714"/>31714: 				       &quot;~n   2: ~p&quot;
<a name="31715"/>31715: 				       &quot;~n   3: ~p&quot;
<a name="31716"/>31716: 				       &quot;~n   4: ~p&quot;
<a name="31717"/>31717: 				       &quot;~n   5: ~p&quot;,
<a name="31718"/>31718: 				       [MRef1, MRef2, MRef3, MRef4, MRef5]),
<a name="31719"/>31719: 			   {ok, State#{mon1 =&gt; MRef1,
<a name="31720"/>31720: 				       mon2 =&gt; MRef2,
<a name="31721"/>31721: 				       mon3 =&gt; MRef3,
<a name="31722"/>31722: 				       mon4 =&gt; MRef4,
<a name="31723"/>31723: 				       mon5 =&gt; MRef5}}
<a name="31724"/>31724:                    end},
<a name="31725"/>31725:          #{desc =&gt; &quot;verify own number of monitors (=5)&quot;,
<a name="31726"/>31726:            cmd  =&gt; fun(_State) -&gt;
<a name="31727"/>31727: 			   5 = socket:number_of_monitors(self()),
<a name="31728"/>31728: 			   ok
<a name="31729"/>31729:                    end},
<a name="31730"/>31730: 
<a name="31731"/>31731:          #{desc =&gt; &quot;announce ready (monitor)&quot;,
<a name="31732"/>31732:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="31733"/>31733:                            ?SEV_ANNOUNCE_READY(Tester, monitor),
<a name="31734"/>31734:                            ok
<a name="31735"/>31735:                    end},
<a name="31736"/>31736: 
<a name="31737"/>31737:          #{desc =&gt; &quot;await continue (down)&quot;,
<a name="31738"/>31738:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="31739"/>31739:                            ?SEV_AWAIT_CONTINUE(Tester, tester, down)
<a name="31740"/>31740:                    end},
<a name="31741"/>31741: 
<a name="31742"/>31742:          #{desc =&gt; &quot;await socket 1 down&quot;,
<a name="31743"/>31743:            cmd  =&gt; fun(#{sock1 := Sock,
<a name="31744"/>31744: 			 mon1  := MRef} = State) -&gt;
<a name="31745"/>31745: 			   receive
<a name="31746"/>31746: 			       {'DOWN', MRef, socket, Sock, Info} -&gt;
<a name="31747"/>31747: 				   ?SEV_IPRINT(&quot;received expected down: &quot;
<a name="31748"/>31748: 					       &quot;~n      MRef:   ~p&quot;
<a name="31749"/>31749: 					       &quot;~n      Socket: ~p&quot;
<a name="31750"/>31750: 					       &quot;~n      Info:   ~p&quot;,
<a name="31751"/>31751: 					       [MRef, Sock, Info]),
<a name="31752"/>31752: 				   State2 = maps:remove(mon1, State),
<a name="31753"/>31753: 				   State3 = maps:remove(sock1, State2),
<a name="31754"/>31754: 				   {ok, State3}
<a name="31755"/>31755: 			   after 5000 -&gt;
<a name="31756"/>31756: 				   ?SEV_EPRINT(&quot;socket down timeout&quot;),
<a name="31757"/>31757: 				   {error, timeout}
<a name="31758"/>31758: 			   end
<a name="31759"/>31759:                    end},
<a name="31760"/>31760:          #{desc =&gt; &quot;announce ready (down)&quot;,
<a name="31761"/>31761:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="31762"/>31762:                            ?SEV_ANNOUNCE_READY(Tester, down),
<a name="31763"/>31763:                            ok
<a name="31764"/>31764:                    end},
<a name="31765"/>31765: 
<a name="31766"/>31766:          #{desc =&gt; &quot;await socket 2 down&quot;,
<a name="31767"/>31767:            cmd  =&gt; fun(#{sock2 := Sock,
<a name="31768"/>31768: 			 mon2  := MRef} = State) -&gt;
<a name="31769"/>31769: 			   receive
<a name="31770"/>31770: 			       {'DOWN', MRef, socket, Sock, Info} -&gt;
<a name="31771"/>31771: 				   ?SEV_IPRINT(&quot;received expected down: &quot;
<a name="31772"/>31772: 					       &quot;~n      MRef:   ~p&quot;
<a name="31773"/>31773: 					       &quot;~n      Socket: ~p&quot;
<a name="31774"/>31774: 					       &quot;~n      Info:   ~p&quot;,
<a name="31775"/>31775: 					       [MRef, Sock, Info]),
<a name="31776"/>31776: 				   State2 = maps:remove(mon2, State),
<a name="31777"/>31777: 				   State3 = maps:remove(sock2, State2),
<a name="31778"/>31778: 				   {ok, State3}
<a name="31779"/>31779: 			   after 5000 -&gt;
<a name="31780"/>31780: 				   ?SEV_EPRINT(&quot;socket down timeout&quot;),
<a name="31781"/>31781: 				   {error, timeout}
<a name="31782"/>31782: 			   end
<a name="31783"/>31783:                    end},
<a name="31784"/>31784:          #{desc =&gt; &quot;announce ready (down)&quot;,
<a name="31785"/>31785:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="31786"/>31786:                            ?SEV_ANNOUNCE_READY(Tester, down),
<a name="31787"/>31787:                            ok
<a name="31788"/>31788:                    end},
<a name="31789"/>31789: 
<a name="31790"/>31790:          #{desc =&gt; &quot;await socket 3 down&quot;,
<a name="31791"/>31791:            cmd  =&gt; fun(#{sock3 := Sock,
<a name="31792"/>31792: 			 mon3  := MRef} = State) -&gt;
<a name="31793"/>31793: 			   receive
<a name="31794"/>31794: 			       {'DOWN', MRef, socket, Sock, Info} -&gt;
<a name="31795"/>31795: 				   ?SEV_IPRINT(&quot;received expected down: &quot;
<a name="31796"/>31796: 					       &quot;~n      MRef:   ~p&quot;
<a name="31797"/>31797: 					       &quot;~n      Socket: ~p&quot;
<a name="31798"/>31798: 					       &quot;~n      Info:   ~p&quot;,
<a name="31799"/>31799: 					       [MRef, Sock, Info]),
<a name="31800"/>31800: 				   State2 = maps:remove(mon3, State),
<a name="31801"/>31801: 				   State3 = maps:remove(sock3, State2),
<a name="31802"/>31802: 				   {ok, State3}
<a name="31803"/>31803: 			   after 5000 -&gt;
<a name="31804"/>31804: 				   ?SEV_EPRINT(&quot;socket down timeout&quot;),
<a name="31805"/>31805: 				   {error, timeout}
<a name="31806"/>31806: 			   end
<a name="31807"/>31807:                    end},
<a name="31808"/>31808:          #{desc =&gt; &quot;announce ready (down)&quot;,
<a name="31809"/>31809:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="31810"/>31810:                            ?SEV_ANNOUNCE_READY(Tester, down),
<a name="31811"/>31811:                            ok
<a name="31812"/>31812:                    end},
<a name="31813"/>31813: 
<a name="31814"/>31814:          #{desc =&gt; &quot;await socket 4 down&quot;,
<a name="31815"/>31815:            cmd  =&gt; fun(#{sock4 := Sock,
<a name="31816"/>31816: 			 mon4  := MRef} = State) -&gt;
<a name="31817"/>31817: 			   receive
<a name="31818"/>31818: 			       {'DOWN', MRef, socket, Sock, Info} -&gt;
<a name="31819"/>31819: 				   ?SEV_IPRINT(&quot;received expected down: &quot;
<a name="31820"/>31820: 					       &quot;~n      MRef:   ~p&quot;
<a name="31821"/>31821: 					       &quot;~n      Socket: ~p&quot;
<a name="31822"/>31822: 					       &quot;~n      Info:   ~p&quot;,
<a name="31823"/>31823: 					       [MRef, Sock, Info]),
<a name="31824"/>31824: 				   State2 = maps:remove(mon4, State),
<a name="31825"/>31825: 				   State3 = maps:remove(sock4, State2),
<a name="31826"/>31826: 				   {ok, State3}
<a name="31827"/>31827: 			   after 5000 -&gt;
<a name="31828"/>31828: 				   ?SEV_EPRINT(&quot;socket down timeout&quot;),
<a name="31829"/>31829: 				   {error, timeout}
<a name="31830"/>31830: 			   end
<a name="31831"/>31831:                    end},
<a name="31832"/>31832:          #{desc =&gt; &quot;announce ready (down)&quot;,
<a name="31833"/>31833:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="31834"/>31834:                            ?SEV_ANNOUNCE_READY(Tester, down),
<a name="31835"/>31835:                            ok
<a name="31836"/>31836:                    end},
<a name="31837"/>31837: 
<a name="31838"/>31838:          #{desc =&gt; &quot;await socket 5 down&quot;,
<a name="31839"/>31839:            cmd  =&gt; fun(#{sock5 := Sock,
<a name="31840"/>31840: 			 mon5  := MRef} = State) -&gt;
<a name="31841"/>31841: 			   receive
<a name="31842"/>31842: 			       {'DOWN', MRef, socket, Sock, Info} -&gt;
<a name="31843"/>31843: 				   ?SEV_IPRINT(&quot;received expected down: &quot;
<a name="31844"/>31844: 					       &quot;~n      MRef:   ~p&quot;
<a name="31845"/>31845: 					       &quot;~n      Socket: ~p&quot;
<a name="31846"/>31846: 					       &quot;~n      Info:   ~p&quot;,
<a name="31847"/>31847: 					       [MRef, Sock, Info]),
<a name="31848"/>31848: 				   State2 = maps:remove(mon5, State),
<a name="31849"/>31849: 				   State3 = maps:remove(sock5, State2),
<a name="31850"/>31850: 				   {ok, State3}
<a name="31851"/>31851: 			   after 5000 -&gt;
<a name="31852"/>31852: 				   ?SEV_EPRINT(&quot;socket down timeout&quot;),
<a name="31853"/>31853: 				   {error, timeout}
<a name="31854"/>31854: 			   end
<a name="31855"/>31855:                    end},
<a name="31856"/>31856:          #{desc =&gt; &quot;announce ready (down)&quot;,
<a name="31857"/>31857:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="31858"/>31858:                            ?SEV_ANNOUNCE_READY(Tester, down),
<a name="31859"/>31859:                            ok
<a name="31860"/>31860:                    end},
<a name="31861"/>31861:          #{desc =&gt; &quot;verify own number of monitors (=0)&quot;,
<a name="31862"/>31862:            cmd  =&gt; fun(_State) -&gt;
<a name="31863"/>31863: 			   0 = socket:number_of_monitors(self()),
<a name="31864"/>31864: 			   ok
<a name="31865"/>31865:                    end},
<a name="31866"/>31866: 
<a name="31867"/>31867: 
<a name="31868"/>31868:          #{desc =&gt; &quot;await terminate (from tester)&quot;,
<a name="31869"/>31869:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="31870"/>31870:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="31871"/>31871:                                ok -&gt;
<a name="31872"/>31872:                                    {ok, maps:remove(tester, State)};
<a name="31873"/>31873:                                {error, _} = ERROR -&gt;
<a name="31874"/>31874:                                    ERROR
<a name="31875"/>31875:                            end
<a name="31876"/>31876:                    end},
<a name="31877"/>31877: 
<a name="31878"/>31878:          %% *** We are done ***
<a name="31879"/>31879:          ?SEV_FINISH_NORMAL
<a name="31880"/>31880:         ],
<a name="31881"/>31881: 
<a name="31882"/>31882:     TesterSeq =
<a name="31883"/>31883:         [
<a name="31884"/>31884:          %% *** Init part ***
<a name="31885"/>31885:          #{desc =&gt; &quot;monitor 'owner'&quot;,
<a name="31886"/>31886:            cmd  =&gt; fun(#{owner := Owner} = _State) -&gt;
<a name="31887"/>31887:                            _MRef = erlang:monitor(process, Owner),
<a name="31888"/>31888:                            ok
<a name="31889"/>31889:                    end},
<a name="31890"/>31890:          #{desc =&gt; &quot;order (owner) start&quot;,
<a name="31891"/>31891:            cmd  =&gt; fun(#{owner := Pid} = _State) -&gt;
<a name="31892"/>31892:                            ?SEV_ANNOUNCE_START(Pid),
<a name="31893"/>31893:                            ok
<a name="31894"/>31894:                    end},
<a name="31895"/>31895:          #{desc =&gt; &quot;await (owner) ready&quot;,
<a name="31896"/>31896:            cmd  =&gt; fun(#{owner := Pid} = State) -&gt;
<a name="31897"/>31897:                            {ok, [Sock1, Sock2, Sock3, Sock4, Sock5]} =
<a name="31898"/>31898: 			       ?SEV_AWAIT_READY(Pid, owner, init),
<a name="31899"/>31899:                            {ok, State#{sock1 =&gt; Sock1,
<a name="31900"/>31900: 				       sock2 =&gt; Sock2,
<a name="31901"/>31901: 				       sock3 =&gt; Sock3,
<a name="31902"/>31902: 				       sock4 =&gt; Sock4,
<a name="31903"/>31903: 				       sock5 =&gt; Sock5}}
<a name="31904"/>31904:                    end},
<a name="31905"/>31905: 
<a name="31906"/>31906:          #{desc =&gt; &quot;monitor 'client 1'&quot;,
<a name="31907"/>31907:            cmd  =&gt; fun(#{client1 := Pid} = _State) -&gt;
<a name="31908"/>31908:                            _MRef = erlang:monitor(process, Pid),
<a name="31909"/>31909:                            ok
<a name="31910"/>31910:                    end},
<a name="31911"/>31911:          #{desc =&gt; &quot;order (client 1) start&quot;,
<a name="31912"/>31912:            cmd  =&gt; fun(#{client1 := Pid} = _State) -&gt;
<a name="31913"/>31913:                            ?SEV_ANNOUNCE_START(Pid),
<a name="31914"/>31914:                            ok
<a name="31915"/>31915:                    end},
<a name="31916"/>31916:          #{desc =&gt; &quot;await (client 1) ready&quot;,
<a name="31917"/>31917:            cmd  =&gt; fun(#{client1 := Pid} = _State) -&gt;
<a name="31918"/>31918:                            ok = ?SEV_AWAIT_READY(Pid, client1, init)
<a name="31919"/>31919:                    end},
<a name="31920"/>31920:          #{desc =&gt; &quot;send socket to client 1&quot;,
<a name="31921"/>31921:            cmd  =&gt; fun(#{client1 := Pid,
<a name="31922"/>31922: 			 sock1   := Sock1,
<a name="31923"/>31923: 			 sock2   := Sock2,
<a name="31924"/>31924: 			 sock3   := Sock3,
<a name="31925"/>31925: 			 sock4   := Sock4,
<a name="31926"/>31926: 			 sock5   := Sock5} = _State) -&gt;
<a name="31927"/>31927: 			   Socks = [Sock1, Sock2, Sock3, Sock4, Sock5],
<a name="31928"/>31928:                            ?SEV_ANNOUNCE_CONTINUE(Pid, socket, Socks),
<a name="31929"/>31929:                            ok
<a name="31930"/>31930:                    end},
<a name="31931"/>31931: 
<a name="31932"/>31932:          #{desc =&gt; &quot;monitor 'client 2'&quot;,
<a name="31933"/>31933:            cmd  =&gt; fun(#{client2 := Pid} = _State) -&gt;
<a name="31934"/>31934:                            _MRef = erlang:monitor(process, Pid),
<a name="31935"/>31935:                            ok
<a name="31936"/>31936:                    end},
<a name="31937"/>31937:          #{desc =&gt; &quot;order (client 2) start&quot;,
<a name="31938"/>31938:            cmd  =&gt; fun(#{client2 := Pid} = _State) -&gt;
<a name="31939"/>31939:                            ?SEV_ANNOUNCE_START(Pid),
<a name="31940"/>31940:                            ok
<a name="31941"/>31941:                    end},
<a name="31942"/>31942:          #{desc =&gt; &quot;await (client 2) ready&quot;,
<a name="31943"/>31943:            cmd  =&gt; fun(#{client2 := Pid} = _State) -&gt;
<a name="31944"/>31944:                            ok = ?SEV_AWAIT_READY(Pid, client2, init)
<a name="31945"/>31945:                    end},
<a name="31946"/>31946:          #{desc =&gt; &quot;send socket to client 2&quot;,
<a name="31947"/>31947:            cmd  =&gt; fun(#{client2 := Pid,
<a name="31948"/>31948: 			 sock1   := Sock1,
<a name="31949"/>31949: 			 sock2   := Sock2,
<a name="31950"/>31950: 			 sock3   := Sock3,
<a name="31951"/>31951: 			 sock4   := Sock4,
<a name="31952"/>31952: 			 sock5   := Sock5} = _State) -&gt;
<a name="31953"/>31953: 			   Socks = [Sock1, Sock2, Sock3, Sock4, Sock5],
<a name="31954"/>31954:                            ?SEV_ANNOUNCE_CONTINUE(Pid, socket, Socks),
<a name="31955"/>31955:                            ok
<a name="31956"/>31956:                    end},
<a name="31957"/>31957: 
<a name="31958"/>31958:          #{desc =&gt; &quot;monitor 'client 3'&quot;,
<a name="31959"/>31959:            cmd  =&gt; fun(#{client3 := Pid} = _State) -&gt;
<a name="31960"/>31960:                            _MRef = erlang:monitor(process, Pid),
<a name="31961"/>31961:                            ok
<a name="31962"/>31962:                    end},
<a name="31963"/>31963:          #{desc =&gt; &quot;order (client 3) start&quot;,
<a name="31964"/>31964:            cmd  =&gt; fun(#{client3 := Pid} = _State) -&gt;
<a name="31965"/>31965:                            ?SEV_ANNOUNCE_START(Pid),
<a name="31966"/>31966:                            ok
<a name="31967"/>31967:                    end},
<a name="31968"/>31968:          #{desc =&gt; &quot;await (client 3) ready&quot;,
<a name="31969"/>31969:            cmd  =&gt; fun(#{client3 := Pid} = _State) -&gt;
<a name="31970"/>31970:                            ok = ?SEV_AWAIT_READY(Pid, client3, init)
<a name="31971"/>31971:                    end},
<a name="31972"/>31972:          #{desc =&gt; &quot;send socket to client 3&quot;,
<a name="31973"/>31973:            cmd  =&gt; fun(#{client3 := Pid,
<a name="31974"/>31974: 			 sock1   := Sock1,
<a name="31975"/>31975: 			 sock2   := Sock2,
<a name="31976"/>31976: 			 sock3   := Sock3,
<a name="31977"/>31977: 			 sock4   := Sock4,
<a name="31978"/>31978: 			 sock5   := Sock5} = _State) -&gt;
<a name="31979"/>31979: 			   Socks = [Sock1, Sock2, Sock3, Sock4, Sock5],
<a name="31980"/>31980:                            ?SEV_ANNOUNCE_CONTINUE(Pid, socket, Socks),
<a name="31981"/>31981:                            ok
<a name="31982"/>31982:                    end},
<a name="31983"/>31983: 
<a name="31984"/>31984:          #{desc =&gt; &quot;monitor 'client 4'&quot;,
<a name="31985"/>31985:            cmd  =&gt; fun(#{client4 := Pid} = _State) -&gt;
<a name="31986"/>31986:                            _MRef = erlang:monitor(process, Pid),
<a name="31987"/>31987:                            ok
<a name="31988"/>31988:                    end},
<a name="31989"/>31989:          #{desc =&gt; &quot;order (client 4) start&quot;,
<a name="31990"/>31990:            cmd  =&gt; fun(#{client4 := Pid} = _State) -&gt;
<a name="31991"/>31991:                            ?SEV_ANNOUNCE_START(Pid),
<a name="31992"/>31992:                            ok
<a name="31993"/>31993:                    end},
<a name="31994"/>31994:          #{desc =&gt; &quot;await (client 4) ready&quot;,
<a name="31995"/>31995:            cmd  =&gt; fun(#{client4 := Pid} = _State) -&gt;
<a name="31996"/>31996:                            ok = ?SEV_AWAIT_READY(Pid, client4, init)
<a name="31997"/>31997:                    end},
<a name="31998"/>31998:          #{desc =&gt; &quot;send socket to client 4&quot;,
<a name="31999"/>31999:            cmd  =&gt; fun(#{client4 := Pid,
<a name="32000"/>32000: 			 sock1   := Sock1,
<a name="32001"/>32001: 			 sock2   := Sock2,
<a name="32002"/>32002: 			 sock3   := Sock3,
<a name="32003"/>32003: 			 sock4   := Sock4,
<a name="32004"/>32004: 			 sock5   := Sock5} = _State) -&gt;
<a name="32005"/>32005: 			   Socks = [Sock1, Sock2, Sock3, Sock4, Sock5],
<a name="32006"/>32006:                            ?SEV_ANNOUNCE_CONTINUE(Pid, socket, Socks),
<a name="32007"/>32007:                            ok
<a name="32008"/>32008:                    end},
<a name="32009"/>32009: 
<a name="32010"/>32010:          #{desc =&gt; &quot;monitor 'client 5'&quot;,
<a name="32011"/>32011:            cmd  =&gt; fun(#{client5 := Pid} = _State) -&gt;
<a name="32012"/>32012:                            _MRef = erlang:monitor(process, Pid),
<a name="32013"/>32013:                            ok
<a name="32014"/>32014:                    end},
<a name="32015"/>32015:          #{desc =&gt; &quot;order (client 5) start&quot;,
<a name="32016"/>32016:            cmd  =&gt; fun(#{client5 := Pid} = _State) -&gt;
<a name="32017"/>32017:                            ?SEV_ANNOUNCE_START(Pid),
<a name="32018"/>32018:                            ok
<a name="32019"/>32019:                    end},
<a name="32020"/>32020:          #{desc =&gt; &quot;await (client 5) ready&quot;,
<a name="32021"/>32021:            cmd  =&gt; fun(#{client5 := Pid} = _State) -&gt;
<a name="32022"/>32022:                            ok = ?SEV_AWAIT_READY(Pid, client5, init)
<a name="32023"/>32023:                    end},
<a name="32024"/>32024:          #{desc =&gt; &quot;send socket to client 5&quot;,
<a name="32025"/>32025:            cmd  =&gt; fun(#{client5 := Pid,
<a name="32026"/>32026: 			 sock1   := Sock1,
<a name="32027"/>32027: 			 sock2   := Sock2,
<a name="32028"/>32028: 			 sock3   := Sock3,
<a name="32029"/>32029: 			 sock4   := Sock4,
<a name="32030"/>32030: 			 sock5   := Sock5} = _State) -&gt;
<a name="32031"/>32031: 			   Socks = [Sock1, Sock2, Sock3, Sock4, Sock5],
<a name="32032"/>32032:                            ?SEV_ANNOUNCE_CONTINUE(Pid, socket, Socks),
<a name="32033"/>32033:                            ok
<a name="32034"/>32034:                    end},
<a name="32035"/>32035: 
<a name="32036"/>32036: 
<a name="32037"/>32037:          %% The actual test
<a name="32038"/>32038:          #{desc =&gt; &quot;verify total number of monitors (=0)&quot;,
<a name="32039"/>32039:            cmd  =&gt; fun(_State) -&gt;
<a name="32040"/>32040: 			   0 = socket:number_of_monitors(),
<a name="32041"/>32041: 			   ok
<a name="32042"/>32042:                    end},
<a name="32043"/>32043: 
<a name="32044"/>32044:          #{desc =&gt; &quot;order client 1 to monitor&quot;,
<a name="32045"/>32045:            cmd  =&gt; fun(#{client1 := Pid} = _State) -&gt;
<a name="32046"/>32046:                            ?SEV_ANNOUNCE_CONTINUE(Pid, monitor),
<a name="32047"/>32047:                            ok
<a name="32048"/>32048:                    end},
<a name="32049"/>32049:          #{desc =&gt; &quot;await (client 1) ready&quot;,
<a name="32050"/>32050:            cmd  =&gt; fun(#{client1 := Pid} = _State) -&gt;
<a name="32051"/>32051:                            ok = ?SEV_AWAIT_READY(Pid, client1, monitor)
<a name="32052"/>32052:                    end},
<a name="32053"/>32053:          #{desc =&gt; &quot;verify total number of monitors (=1*5)&quot;,
<a name="32054"/>32054:            cmd  =&gt; fun(_State) -&gt;
<a name="32055"/>32055: 			   1*5 = socket:number_of_monitors(),
<a name="32056"/>32056: 			   ok
<a name="32057"/>32057:                    end},
<a name="32058"/>32058: 
<a name="32059"/>32059:          #{desc =&gt; &quot;order client 2 to monitor&quot;,
<a name="32060"/>32060:            cmd  =&gt; fun(#{client2 := Pid} = _State) -&gt;
<a name="32061"/>32061:                            ?SEV_ANNOUNCE_CONTINUE(Pid, monitor),
<a name="32062"/>32062:                            ok
<a name="32063"/>32063:                    end},
<a name="32064"/>32064:          #{desc =&gt; &quot;await (client 2) ready&quot;,
<a name="32065"/>32065:            cmd  =&gt; fun(#{client2 := Pid} = _State) -&gt;
<a name="32066"/>32066:                            ok = ?SEV_AWAIT_READY(Pid, client2, monitor)
<a name="32067"/>32067:                    end},
<a name="32068"/>32068:          #{desc =&gt; &quot;verify total number of monitors (=2*5)&quot;,
<a name="32069"/>32069:            cmd  =&gt; fun(_State) -&gt;
<a name="32070"/>32070: 			   2*5 = socket:number_of_monitors(),
<a name="32071"/>32071: 			   ok
<a name="32072"/>32072:                    end},
<a name="32073"/>32073: 
<a name="32074"/>32074:          #{desc =&gt; &quot;order client 3 to monitor&quot;,
<a name="32075"/>32075:            cmd  =&gt; fun(#{client3 := Pid} = _State) -&gt;
<a name="32076"/>32076:                            ?SEV_ANNOUNCE_CONTINUE(Pid, monitor),
<a name="32077"/>32077:                            ok
<a name="32078"/>32078:                    end},
<a name="32079"/>32079:          #{desc =&gt; &quot;await (client 3) ready&quot;,
<a name="32080"/>32080:            cmd  =&gt; fun(#{client3 := Pid} = _State) -&gt;
<a name="32081"/>32081:                            ok = ?SEV_AWAIT_READY(Pid, client3, monitor)
<a name="32082"/>32082:                    end},
<a name="32083"/>32083:          #{desc =&gt; &quot;verify total number of monitors (=3*5)&quot;,
<a name="32084"/>32084:            cmd  =&gt; fun(_State) -&gt;
<a name="32085"/>32085: 			   3*5 = socket:number_of_monitors(),
<a name="32086"/>32086: 			   ok
<a name="32087"/>32087:                    end},
<a name="32088"/>32088: 
<a name="32089"/>32089:          #{desc =&gt; &quot;order client 4 to monitor&quot;,
<a name="32090"/>32090:            cmd  =&gt; fun(#{client4 := Pid} = _State) -&gt;
<a name="32091"/>32091:                            ?SEV_ANNOUNCE_CONTINUE(Pid, monitor),
<a name="32092"/>32092:                            ok
<a name="32093"/>32093:                    end},
<a name="32094"/>32094:          #{desc =&gt; &quot;await (client 4) ready&quot;,
<a name="32095"/>32095:            cmd  =&gt; fun(#{client4 := Pid} = _State) -&gt;
<a name="32096"/>32096:                            ok = ?SEV_AWAIT_READY(Pid, client4, monitor)
<a name="32097"/>32097:                    end},
<a name="32098"/>32098:          #{desc =&gt; &quot;verify total number of monitors (=4*5)&quot;,
<a name="32099"/>32099:            cmd  =&gt; fun(_State) -&gt;
<a name="32100"/>32100: 			   4*5 = socket:number_of_monitors(),
<a name="32101"/>32101: 			   ok
<a name="32102"/>32102:                    end},
<a name="32103"/>32103: 
<a name="32104"/>32104:          #{desc =&gt; &quot;order client 5 to monitor&quot;,
<a name="32105"/>32105:            cmd  =&gt; fun(#{client5 := Pid} = _State) -&gt;
<a name="32106"/>32106:                            ?SEV_ANNOUNCE_CONTINUE(Pid, monitor),
<a name="32107"/>32107:                            ok
<a name="32108"/>32108:                    end},
<a name="32109"/>32109:          #{desc =&gt; &quot;await (client 5) ready&quot;,
<a name="32110"/>32110:            cmd  =&gt; fun(#{client5 := Pid} = _State) -&gt;
<a name="32111"/>32111:                            ok = ?SEV_AWAIT_READY(Pid, client5, monitor)
<a name="32112"/>32112:                    end},
<a name="32113"/>32113:          #{desc =&gt; &quot;verify total number of monitors (=5*5)&quot;,
<a name="32114"/>32114:            cmd  =&gt; fun(_State) -&gt;
<a name="32115"/>32115: 			   5*5 = socket:number_of_monitors(),
<a name="32116"/>32116: 			   ok
<a name="32117"/>32117:                    end},
<a name="32118"/>32118: 
<a name="32119"/>32119:          #{desc =&gt; &quot;order client 1 to await down&quot;,
<a name="32120"/>32120:            cmd  =&gt; fun(#{client1 := Pid} = _State) -&gt;
<a name="32121"/>32121:                            ?SEV_ANNOUNCE_CONTINUE(Pid, down),
<a name="32122"/>32122:                            ok
<a name="32123"/>32123:                    end},
<a name="32124"/>32124:          #{desc =&gt; &quot;order client 2 to await down&quot;,
<a name="32125"/>32125:            cmd  =&gt; fun(#{client2 := Pid} = _State) -&gt;
<a name="32126"/>32126:                            ?SEV_ANNOUNCE_CONTINUE(Pid, down),
<a name="32127"/>32127:                            ok
<a name="32128"/>32128:                    end},
<a name="32129"/>32129:          #{desc =&gt; &quot;order client 3 to await down&quot;,
<a name="32130"/>32130:            cmd  =&gt; fun(#{client3 := Pid} = _State) -&gt;
<a name="32131"/>32131:                            ?SEV_ANNOUNCE_CONTINUE(Pid, down),
<a name="32132"/>32132:                            ok
<a name="32133"/>32133:                    end},
<a name="32134"/>32134:          #{desc =&gt; &quot;order client 4 to await down&quot;,
<a name="32135"/>32135:            cmd  =&gt; fun(#{client4 := Pid} = _State) -&gt;
<a name="32136"/>32136:                            ?SEV_ANNOUNCE_CONTINUE(Pid, down),
<a name="32137"/>32137:                            ok
<a name="32138"/>32138:                    end},
<a name="32139"/>32139:          #{desc =&gt; &quot;order client 5 to await down&quot;,
<a name="32140"/>32140:            cmd  =&gt; fun(#{client5 := Pid} = _State) -&gt;
<a name="32141"/>32141:                            ?SEV_ANNOUNCE_CONTINUE(Pid, down),
<a name="32142"/>32142:                            ok
<a name="32143"/>32143:                    end},
<a name="32144"/>32144: 
<a name="32145"/>32145: 	 ?SEV_SLEEP(?SECS(1)),
<a name="32146"/>32146: 
<a name="32147"/>32147:          #{desc =&gt; &quot;order owner to close socket 1&quot;,
<a name="32148"/>32148:            cmd  =&gt; fun(#{owner := Pid} = _State) -&gt;
<a name="32149"/>32149:                            ?SEV_ANNOUNCE_CONTINUE(Pid, close1),
<a name="32150"/>32150:                            ok
<a name="32151"/>32151:                    end},
<a name="32152"/>32152:          #{desc =&gt; &quot;await (client 1) down received&quot;,
<a name="32153"/>32153:            cmd  =&gt; fun(#{client1 := Pid} = _State) -&gt;
<a name="32154"/>32154:                            ok = ?SEV_AWAIT_READY(Pid, client1, down)
<a name="32155"/>32155:                    end},
<a name="32156"/>32156:          #{desc =&gt; &quot;await (client 2) down received&quot;,
<a name="32157"/>32157:            cmd  =&gt; fun(#{client2 := Pid} = _State) -&gt;
<a name="32158"/>32158:                            ok = ?SEV_AWAIT_READY(Pid, client2, down)
<a name="32159"/>32159:                    end},
<a name="32160"/>32160:          #{desc =&gt; &quot;await (client 3) down received&quot;,
<a name="32161"/>32161:            cmd  =&gt; fun(#{client3 := Pid} = _State) -&gt;
<a name="32162"/>32162:                            ok = ?SEV_AWAIT_READY(Pid, client3, down)
<a name="32163"/>32163:                    end},
<a name="32164"/>32164:          #{desc =&gt; &quot;await (client 4) down received&quot;,
<a name="32165"/>32165:            cmd  =&gt; fun(#{client4 := Pid} = _State) -&gt;
<a name="32166"/>32166:                            ok = ?SEV_AWAIT_READY(Pid, client4, down)
<a name="32167"/>32167:                    end},
<a name="32168"/>32168:          #{desc =&gt; &quot;await (client 5) down received&quot;,
<a name="32169"/>32169:            cmd  =&gt; fun(#{client5 := Pid} = _State) -&gt;
<a name="32170"/>32170:                            ok = ?SEV_AWAIT_READY(Pid, client5, down)
<a name="32171"/>32171:                    end},
<a name="32172"/>32172:          #{desc =&gt; &quot;verify total number of monitors (=5*4)&quot;,
<a name="32173"/>32173:            cmd  =&gt; fun(_State) -&gt;
<a name="32174"/>32174: 			   5*4 = socket:number_of_monitors(),
<a name="32175"/>32175: 			   ok
<a name="32176"/>32176:                    end},
<a name="32177"/>32177: 
<a name="32178"/>32178: 	 ?SEV_SLEEP(?SECS(1)),
<a name="32179"/>32179: 
<a name="32180"/>32180:          #{desc =&gt; &quot;order owner to close socket 2&quot;,
<a name="32181"/>32181:            cmd  =&gt; fun(#{owner := Pid} = _State) -&gt;
<a name="32182"/>32182:                            ?SEV_ANNOUNCE_CONTINUE(Pid, close2),
<a name="32183"/>32183:                            ok
<a name="32184"/>32184:                    end},
<a name="32185"/>32185:          #{desc =&gt; &quot;await (client 1) down received&quot;,
<a name="32186"/>32186:            cmd  =&gt; fun(#{client1 := Pid} = _State) -&gt;
<a name="32187"/>32187:                            ok = ?SEV_AWAIT_READY(Pid, client1, down)
<a name="32188"/>32188:                    end},
<a name="32189"/>32189:          #{desc =&gt; &quot;await (client 2) down received&quot;,
<a name="32190"/>32190:            cmd  =&gt; fun(#{client2 := Pid} = _State) -&gt;
<a name="32191"/>32191:                            ok = ?SEV_AWAIT_READY(Pid, client2, down)
<a name="32192"/>32192:                    end},
<a name="32193"/>32193:          #{desc =&gt; &quot;await (client 3) down received&quot;,
<a name="32194"/>32194:            cmd  =&gt; fun(#{client3 := Pid} = _State) -&gt;
<a name="32195"/>32195:                            ok = ?SEV_AWAIT_READY(Pid, client3, down)
<a name="32196"/>32196:                    end},
<a name="32197"/>32197:          #{desc =&gt; &quot;await (client 4) down received&quot;,
<a name="32198"/>32198:            cmd  =&gt; fun(#{client4 := Pid} = _State) -&gt;
<a name="32199"/>32199:                            ok = ?SEV_AWAIT_READY(Pid, client4, down)
<a name="32200"/>32200:                    end},
<a name="32201"/>32201:          #{desc =&gt; &quot;await (client 5) down received&quot;,
<a name="32202"/>32202:            cmd  =&gt; fun(#{client5 := Pid} = _State) -&gt;
<a name="32203"/>32203:                            ok = ?SEV_AWAIT_READY(Pid, client5, down)
<a name="32204"/>32204:                    end},
<a name="32205"/>32205:          #{desc =&gt; &quot;verify total number of monitors (=5*3)&quot;,
<a name="32206"/>32206:            cmd  =&gt; fun(_State) -&gt;
<a name="32207"/>32207: 			   5*3 = socket:number_of_monitors(),
<a name="32208"/>32208: 			   ok
<a name="32209"/>32209:                    end},
<a name="32210"/>32210: 
<a name="32211"/>32211: 	 ?SEV_SLEEP(?SECS(1)),
<a name="32212"/>32212: 
<a name="32213"/>32213:          #{desc =&gt; &quot;order owner to close socket 3&quot;,
<a name="32214"/>32214:            cmd  =&gt; fun(#{owner := Pid} = _State) -&gt;
<a name="32215"/>32215:                            ?SEV_ANNOUNCE_CONTINUE(Pid, close3),
<a name="32216"/>32216:                            ok
<a name="32217"/>32217:                    end},
<a name="32218"/>32218:          #{desc =&gt; &quot;await (client 1) down received&quot;,
<a name="32219"/>32219:            cmd  =&gt; fun(#{client1 := Pid} = _State) -&gt;
<a name="32220"/>32220:                            ok = ?SEV_AWAIT_READY(Pid, client1, down)
<a name="32221"/>32221:                    end},
<a name="32222"/>32222:          #{desc =&gt; &quot;await (client 2) down received&quot;,
<a name="32223"/>32223:            cmd  =&gt; fun(#{client2 := Pid} = _State) -&gt;
<a name="32224"/>32224:                            ok = ?SEV_AWAIT_READY(Pid, client2, down)
<a name="32225"/>32225:                    end},
<a name="32226"/>32226:          #{desc =&gt; &quot;await (client 3) down received&quot;,
<a name="32227"/>32227:            cmd  =&gt; fun(#{client3 := Pid} = _State) -&gt;
<a name="32228"/>32228:                            ok = ?SEV_AWAIT_READY(Pid, client3, down)
<a name="32229"/>32229:                    end},
<a name="32230"/>32230:          #{desc =&gt; &quot;await (client 4) down received&quot;,
<a name="32231"/>32231:            cmd  =&gt; fun(#{client4 := Pid} = _State) -&gt;
<a name="32232"/>32232:                            ok = ?SEV_AWAIT_READY(Pid, client4, down)
<a name="32233"/>32233:                    end},
<a name="32234"/>32234:          #{desc =&gt; &quot;await (client 5) down received&quot;,
<a name="32235"/>32235:            cmd  =&gt; fun(#{client5 := Pid} = _State) -&gt;
<a name="32236"/>32236:                            ok = ?SEV_AWAIT_READY(Pid, client5, down)
<a name="32237"/>32237:                    end},
<a name="32238"/>32238:          #{desc =&gt; &quot;verify total number of monitors (=5*2)&quot;,
<a name="32239"/>32239:            cmd  =&gt; fun(_State) -&gt;
<a name="32240"/>32240: 			   5*2 = socket:number_of_monitors(),
<a name="32241"/>32241: 			   ok
<a name="32242"/>32242:                    end},
<a name="32243"/>32243: 
<a name="32244"/>32244: 	 ?SEV_SLEEP(?SECS(1)),
<a name="32245"/>32245: 
<a name="32246"/>32246:          #{desc =&gt; &quot;order owner to close socket 4&quot;,
<a name="32247"/>32247:            cmd  =&gt; fun(#{owner := Pid} = _State) -&gt;
<a name="32248"/>32248:                            ?SEV_ANNOUNCE_CONTINUE(Pid, close4),
<a name="32249"/>32249:                            ok
<a name="32250"/>32250:                    end},
<a name="32251"/>32251:          #{desc =&gt; &quot;await (client 1) down received&quot;,
<a name="32252"/>32252:            cmd  =&gt; fun(#{client1 := Pid} = _State) -&gt;
<a name="32253"/>32253:                            ok = ?SEV_AWAIT_READY(Pid, client1, down)
<a name="32254"/>32254:                    end},
<a name="32255"/>32255:          #{desc =&gt; &quot;await (client 2) down received&quot;,
<a name="32256"/>32256:            cmd  =&gt; fun(#{client2 := Pid} = _State) -&gt;
<a name="32257"/>32257:                            ok = ?SEV_AWAIT_READY(Pid, client2, down)
<a name="32258"/>32258:                    end},
<a name="32259"/>32259:          #{desc =&gt; &quot;await (client 3) down received&quot;,
<a name="32260"/>32260:            cmd  =&gt; fun(#{client3 := Pid} = _State) -&gt;
<a name="32261"/>32261:                            ok = ?SEV_AWAIT_READY(Pid, client3, down)
<a name="32262"/>32262:                    end},
<a name="32263"/>32263:          #{desc =&gt; &quot;await (client 4) down received&quot;,
<a name="32264"/>32264:            cmd  =&gt; fun(#{client4 := Pid} = _State) -&gt;
<a name="32265"/>32265:                            ok = ?SEV_AWAIT_READY(Pid, client4, down)
<a name="32266"/>32266:                    end},
<a name="32267"/>32267:          #{desc =&gt; &quot;await (client 5) down received&quot;,
<a name="32268"/>32268:            cmd  =&gt; fun(#{client5 := Pid} = _State) -&gt;
<a name="32269"/>32269:                            ok = ?SEV_AWAIT_READY(Pid, client5, down)
<a name="32270"/>32270:                    end},
<a name="32271"/>32271:          #{desc =&gt; &quot;verify total number of monitors (=5*1)&quot;,
<a name="32272"/>32272:            cmd  =&gt; fun(_State) -&gt;
<a name="32273"/>32273: 			   5*1 = socket:number_of_monitors(),
<a name="32274"/>32274: 			   ok
<a name="32275"/>32275:                    end},
<a name="32276"/>32276: 
<a name="32277"/>32277: 	 ?SEV_SLEEP(?SECS(1)),
<a name="32278"/>32278: 
<a name="32279"/>32279:          #{desc =&gt; &quot;order owner to close socket 5&quot;,
<a name="32280"/>32280:            cmd  =&gt; fun(#{owner := Pid} = _State) -&gt;
<a name="32281"/>32281:                            ?SEV_ANNOUNCE_CONTINUE(Pid, close5),
<a name="32282"/>32282:                            ok
<a name="32283"/>32283:                    end},
<a name="32284"/>32284:          #{desc =&gt; &quot;await (client 1) down received&quot;,
<a name="32285"/>32285:            cmd  =&gt; fun(#{client1 := Pid} = _State) -&gt;
<a name="32286"/>32286:                            ok = ?SEV_AWAIT_READY(Pid, client1, down)
<a name="32287"/>32287:                    end},
<a name="32288"/>32288:          #{desc =&gt; &quot;await (client 2) down received&quot;,
<a name="32289"/>32289:            cmd  =&gt; fun(#{client2 := Pid} = _State) -&gt;
<a name="32290"/>32290:                            ok = ?SEV_AWAIT_READY(Pid, client2, down)
<a name="32291"/>32291:                    end},
<a name="32292"/>32292:          #{desc =&gt; &quot;await (client 3) down received&quot;,
<a name="32293"/>32293:            cmd  =&gt; fun(#{client3 := Pid} = _State) -&gt;
<a name="32294"/>32294:                            ok = ?SEV_AWAIT_READY(Pid, client3, down)
<a name="32295"/>32295:                    end},
<a name="32296"/>32296:          #{desc =&gt; &quot;await (client 4) down received&quot;,
<a name="32297"/>32297:            cmd  =&gt; fun(#{client4 := Pid} = _State) -&gt;
<a name="32298"/>32298:                            ok = ?SEV_AWAIT_READY(Pid, client4, down)
<a name="32299"/>32299:                    end},
<a name="32300"/>32300:          #{desc =&gt; &quot;await (client 5) down received&quot;,
<a name="32301"/>32301:            cmd  =&gt; fun(#{client5 := Pid} = _State) -&gt;
<a name="32302"/>32302:                            ok = ?SEV_AWAIT_READY(Pid, client5, down)
<a name="32303"/>32303:                    end},
<a name="32304"/>32304:          #{desc =&gt; &quot;verify total number of monitors (=0)&quot;,
<a name="32305"/>32305:            cmd  =&gt; fun(_State) -&gt;
<a name="32306"/>32306: 			   0 = socket:number_of_monitors(),
<a name="32307"/>32307: 			   ok
<a name="32308"/>32308:                    end},
<a name="32309"/>32309: 
<a name="32310"/>32310: 	 ?SEV_SLEEP(?SECS(1)),
<a name="32311"/>32311: 
<a name="32312"/>32312:          %% Cleanup
<a name="32313"/>32313:          #{desc =&gt; &quot;order (owner) terminate&quot;,
<a name="32314"/>32314:            cmd  =&gt; fun(#{owner := Pid} = _State) -&gt;
<a name="32315"/>32315:                            ?SEV_ANNOUNCE_TERMINATE(Pid),
<a name="32316"/>32316:                            ok
<a name="32317"/>32317:                    end},
<a name="32318"/>32318:          #{desc =&gt; &quot;await (owner) termination&quot;,
<a name="32319"/>32319:            cmd  =&gt; fun(#{owner := Pid} = State) -&gt;
<a name="32320"/>32320:                            case ?SEV_AWAIT_TERMINATION(Pid) of
<a name="32321"/>32321:                                ok -&gt;
<a name="32322"/>32322:                                    {ok, maps:remove(owner, State)};
<a name="32323"/>32323:                                {error, _} = ERROR -&gt;
<a name="32324"/>32324:                                    ERROR
<a name="32325"/>32325:                            end
<a name="32326"/>32326:                    end},
<a name="32327"/>32327: 
<a name="32328"/>32328:          #{desc =&gt; &quot;order (client 1) terminate&quot;,
<a name="32329"/>32329:            cmd  =&gt; fun(#{client1 := Pid} = _State) -&gt;
<a name="32330"/>32330:                            ?SEV_ANNOUNCE_TERMINATE(Pid),
<a name="32331"/>32331:                            ok
<a name="32332"/>32332:                    end},
<a name="32333"/>32333:          #{desc =&gt; &quot;await (client 1) termination&quot;,
<a name="32334"/>32334:            cmd  =&gt; fun(#{client1 := Pid} = State) -&gt;
<a name="32335"/>32335:                            case ?SEV_AWAIT_TERMINATION(Pid) of
<a name="32336"/>32336:                                ok -&gt;
<a name="32337"/>32337:                                    {ok, maps:remove(client1, State)};
<a name="32338"/>32338:                                {error, _} = ERROR -&gt;
<a name="32339"/>32339:                                    ERROR
<a name="32340"/>32340:                            end
<a name="32341"/>32341:                    end},
<a name="32342"/>32342: 
<a name="32343"/>32343:          #{desc =&gt; &quot;order (client 2) terminate&quot;,
<a name="32344"/>32344:            cmd  =&gt; fun(#{client2 := Pid} = _State) -&gt;
<a name="32345"/>32345:                            ?SEV_ANNOUNCE_TERMINATE(Pid),
<a name="32346"/>32346:                            ok
<a name="32347"/>32347:                    end},
<a name="32348"/>32348:          #{desc =&gt; &quot;await (client 2) termination&quot;,
<a name="32349"/>32349:            cmd  =&gt; fun(#{client2 := Pid} = State) -&gt;
<a name="32350"/>32350:                            case ?SEV_AWAIT_TERMINATION(Pid) of
<a name="32351"/>32351:                                ok -&gt;
<a name="32352"/>32352:                                    {ok, maps:remove(client2, State)};
<a name="32353"/>32353:                                {error, _} = ERROR -&gt;
<a name="32354"/>32354:                                    ERROR
<a name="32355"/>32355:                            end
<a name="32356"/>32356:                    end},
<a name="32357"/>32357: 
<a name="32358"/>32358:          #{desc =&gt; &quot;order (client 3) terminate&quot;,
<a name="32359"/>32359:            cmd  =&gt; fun(#{client3 := Pid} = _State) -&gt;
<a name="32360"/>32360:                            ?SEV_ANNOUNCE_TERMINATE(Pid),
<a name="32361"/>32361:                            ok
<a name="32362"/>32362:                    end},
<a name="32363"/>32363:          #{desc =&gt; &quot;await (client 3) termination&quot;,
<a name="32364"/>32364:            cmd  =&gt; fun(#{client3 := Pid} = State) -&gt;
<a name="32365"/>32365:                            case ?SEV_AWAIT_TERMINATION(Pid) of
<a name="32366"/>32366:                                ok -&gt;
<a name="32367"/>32367:                                    {ok, maps:remove(client3, State)};
<a name="32368"/>32368:                                {error, _} = ERROR -&gt;
<a name="32369"/>32369:                                    ERROR
<a name="32370"/>32370:                            end
<a name="32371"/>32371:                    end},
<a name="32372"/>32372: 
<a name="32373"/>32373:          #{desc =&gt; &quot;order (client 4) terminate&quot;,
<a name="32374"/>32374:            cmd  =&gt; fun(#{client4 := Pid} = _State) -&gt;
<a name="32375"/>32375:                            ?SEV_ANNOUNCE_TERMINATE(Pid),
<a name="32376"/>32376:                            ok
<a name="32377"/>32377:                    end},
<a name="32378"/>32378:          #{desc =&gt; &quot;await (client 4) termination&quot;,
<a name="32379"/>32379:            cmd  =&gt; fun(#{client4 := Pid} = State) -&gt;
<a name="32380"/>32380:                            case ?SEV_AWAIT_TERMINATION(Pid) of
<a name="32381"/>32381:                                ok -&gt;
<a name="32382"/>32382:                                    {ok, maps:remove(client4, State)};
<a name="32383"/>32383:                                {error, _} = ERROR -&gt;
<a name="32384"/>32384:                                    ERROR
<a name="32385"/>32385:                            end
<a name="32386"/>32386:                    end},
<a name="32387"/>32387: 
<a name="32388"/>32388:          #{desc =&gt; &quot;order (client 5) terminate&quot;,
<a name="32389"/>32389:            cmd  =&gt; fun(#{client5 := Pid} = _State) -&gt;
<a name="32390"/>32390:                            ?SEV_ANNOUNCE_TERMINATE(Pid),
<a name="32391"/>32391:                            ok
<a name="32392"/>32392:                    end},
<a name="32393"/>32393:          #{desc =&gt; &quot;await (client 5) termination&quot;,
<a name="32394"/>32394:            cmd  =&gt; fun(#{client5 := Pid} = State) -&gt;
<a name="32395"/>32395:                            case ?SEV_AWAIT_TERMINATION(Pid) of
<a name="32396"/>32396:                                ok -&gt;
<a name="32397"/>32397:                                    {ok, maps:remove(client5, State)};
<a name="32398"/>32398:                                {error, _} = ERROR -&gt;
<a name="32399"/>32399:                                    ERROR
<a name="32400"/>32400:                            end
<a name="32401"/>32401:                    end},
<a name="32402"/>32402: 
<a name="32403"/>32403:          %% *** We are done ***
<a name="32404"/>32404:          ?SEV_FINISH_NORMAL
<a name="32405"/>32405:         ],
<a name="32406"/>32406: 
<a name="32407"/>32407:     i(&quot;start (socket) owner evaluator&quot;),
<a name="32408"/>32408:     Owner = ?SEV_START(&quot;owner&quot;, OwnerSeq, InitState),
<a name="32409"/>32409: 
<a name="32410"/>32410:     i(&quot;start client 1 evaluator&quot;),
<a name="32411"/>32411:     Client1 = ?SEV_START(&quot;client-1&quot;, ClientSeq, InitState),
<a name="32412"/>32412: 
<a name="32413"/>32413:     i(&quot;start client 2 evaluator&quot;),
<a name="32414"/>32414:     Client2 = ?SEV_START(&quot;client-2&quot;, ClientSeq, InitState),
<a name="32415"/>32415: 
<a name="32416"/>32416:     i(&quot;start client 3 evaluator&quot;),
<a name="32417"/>32417:     Client3 = ?SEV_START(&quot;client-3&quot;, ClientSeq, InitState),
<a name="32418"/>32418: 
<a name="32419"/>32419:     i(&quot;start client 4 evaluator&quot;),
<a name="32420"/>32420:     Client4 = ?SEV_START(&quot;client-4&quot;, ClientSeq, InitState),
<a name="32421"/>32421: 
<a name="32422"/>32422:     i(&quot;start client 5 evaluator&quot;),
<a name="32423"/>32423:     Client5 = ?SEV_START(&quot;client-5&quot;, ClientSeq, InitState),
<a name="32424"/>32424: 
<a name="32425"/>32425:     i(&quot;start tester evaluator&quot;),
<a name="32426"/>32426:     TesterInitState = #{owner   =&gt; Owner#ev.pid,
<a name="32427"/>32427: 			client1 =&gt; Client1#ev.pid,
<a name="32428"/>32428: 			client2 =&gt; Client2#ev.pid,
<a name="32429"/>32429: 			client3 =&gt; Client3#ev.pid,
<a name="32430"/>32430: 			client4 =&gt; Client4#ev.pid,
<a name="32431"/>32431: 			client5 =&gt; Client5#ev.pid},
<a name="32432"/>32432:     Tester = ?SEV_START(&quot;tester&quot;, TesterSeq, TesterInitState),
<a name="32433"/>32433: 
<a name="32434"/>32434:     i(&quot;await evaluator&quot;),
<a name="mon_open_and_close_multi_socks_and_mon-last_expr"/><a name="32435"/>32435: <b>    ok = ?SEV_AWAIT_FINISH</b>([Owner, Tester]).
<a name="32436"/>32436: 
<a name="32437"/>32437: 
<a name="32438"/>32438: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="32439"/>32439: <i>%% Create several sockets (by 'owner' process), monitor each from several</i>
<a name="32440"/>32440: <i>%% different processes, then exit the owner.</i>
<a name="32441"/>32441: <i>%% The processes that did the monitor shall receive one socket DOWN for</i>
<a name="32442"/>32442: <i>%% each socket.</i>
<a name="32443"/>32443: 
<a name="monitor_open_and_exit_multi_socks_and_mon-1"/><a name="32444"/>32444: <b>monitor_open_and_exit_multi_socks_and_mon</b>(_Config) when is_list(_Config) -&gt;
<a name="32445"/>32445:     ?TT(?SECS(10)),
<a name="monitor_open_and_exit_multi_socks_and_mon-last_expr"/><a name="32446"/>32446: <b>    tc_try</b>(monitor_open_and_exit_multi_socks_and_mon,
<a name="32447"/>32447:            fun() -&gt;
<a name="32448"/>32448: 		   InitState = #{domain   =&gt; inet,
<a name="32449"/>32449:                                  type     =&gt; stream,
<a name="32450"/>32450:                                  protocol =&gt; tcp},
<a name="32451"/>32451:                    ok = mon_open_and_exit_multi_socks_and_mon(InitState)
<a name="32452"/>32452:            end).
<a name="32453"/>32453: 
<a name="32454"/>32454: 
<a name="mon_open_and_exit_multi_socks_and_mon-1"/><a name="32455"/>32455: <b>mon_open_and_exit_multi_socks_and_mon</b>(InitState) -&gt;
<a name="32456"/>32456:     OwnerSeq =
<a name="32457"/>32457:         [
<a name="32458"/>32458:          %% *** Wait for start order part ***
<a name="32459"/>32459:          #{desc =&gt; &quot;await start (from tester)&quot;,
<a name="32460"/>32460:            cmd  =&gt; fun(State) -&gt;
<a name="32461"/>32461:                            Tester = ?SEV_AWAIT_START(),
<a name="32462"/>32462:                            {ok, State#{tester =&gt; Tester}}
<a name="32463"/>32463:                    end},
<a name="32464"/>32464:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="32465"/>32465:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="32466"/>32466:                            _MRef = erlang:monitor(process, Tester),
<a name="32467"/>32467:                            ok
<a name="32468"/>32468:                    end},
<a name="32469"/>32469: 
<a name="32470"/>32470:          %% *** Init part ***
<a name="32471"/>32471:          #{desc =&gt; &quot;create socket 1&quot;,
<a name="32472"/>32472:            cmd  =&gt; fun(#{domain   := Domain, 
<a name="32473"/>32473:                          type     := Type, 
<a name="32474"/>32474:                          protocol := Proto} = State) -&gt;
<a name="32475"/>32475:                            case socket:open(Domain, Type, Proto) of
<a name="32476"/>32476:                                {ok, Sock} -&gt;
<a name="32477"/>32477:                                    {ok, State#{sock1 =&gt; Sock}};
<a name="32478"/>32478:                                {error, _} = ERROR -&gt;
<a name="32479"/>32479:                                    ERROR
<a name="32480"/>32480:                            end
<a name="32481"/>32481:                    end},
<a name="32482"/>32482:          #{desc =&gt; &quot;create socket 2&quot;,
<a name="32483"/>32483:            cmd  =&gt; fun(#{domain   := Domain, 
<a name="32484"/>32484:                          type     := Type, 
<a name="32485"/>32485:                          protocol := Proto} = State) -&gt;
<a name="32486"/>32486:                            case socket:open(Domain, Type, Proto) of
<a name="32487"/>32487:                                {ok, Sock} -&gt;
<a name="32488"/>32488:                                    {ok, State#{sock2 =&gt; Sock}};
<a name="32489"/>32489:                                {error, _} = ERROR -&gt;
<a name="32490"/>32490:                                    ERROR
<a name="32491"/>32491:                            end
<a name="32492"/>32492:                    end},
<a name="32493"/>32493:          #{desc =&gt; &quot;create socket 3&quot;,
<a name="32494"/>32494:            cmd  =&gt; fun(#{domain   := Domain, 
<a name="32495"/>32495:                          type     := Type, 
<a name="32496"/>32496:                          protocol := Proto} = State) -&gt;
<a name="32497"/>32497:                            case socket:open(Domain, Type, Proto) of
<a name="32498"/>32498:                                {ok, Sock} -&gt;
<a name="32499"/>32499:                                    {ok, State#{sock3 =&gt; Sock}};
<a name="32500"/>32500:                                {error, _} = ERROR -&gt;
<a name="32501"/>32501:                                    ERROR
<a name="32502"/>32502:                            end
<a name="32503"/>32503:                    end},
<a name="32504"/>32504:          #{desc =&gt; &quot;create socket 4&quot;,
<a name="32505"/>32505:            cmd  =&gt; fun(#{domain   := Domain, 
<a name="32506"/>32506:                          type     := Type, 
<a name="32507"/>32507:                          protocol := Proto} = State) -&gt;
<a name="32508"/>32508:                            case socket:open(Domain, Type, Proto) of
<a name="32509"/>32509:                                {ok, Sock} -&gt;
<a name="32510"/>32510:                                    {ok, State#{sock4 =&gt; Sock}};
<a name="32511"/>32511:                                {error, _} = ERROR -&gt;
<a name="32512"/>32512:                                    ERROR
<a name="32513"/>32513:                            end
<a name="32514"/>32514:                    end},
<a name="32515"/>32515:          #{desc =&gt; &quot;create socket 5&quot;,
<a name="32516"/>32516:            cmd  =&gt; fun(#{domain   := Domain, 
<a name="32517"/>32517:                          type     := Type, 
<a name="32518"/>32518:                          protocol := Proto} = State) -&gt;
<a name="32519"/>32519:                            case socket:open(Domain, Type, Proto) of
<a name="32520"/>32520:                                {ok, Sock} -&gt;
<a name="32521"/>32521:                                    {ok, State#{sock5 =&gt; Sock}};
<a name="32522"/>32522:                                {error, _} = ERROR -&gt;
<a name="32523"/>32523:                                    ERROR
<a name="32524"/>32524:                            end
<a name="32525"/>32525:                    end},
<a name="32526"/>32526:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="32527"/>32527:            cmd  =&gt; fun(#{tester := Tester,
<a name="32528"/>32528: 			 sock1  := Sock1,
<a name="32529"/>32529: 			 sock2  := Sock2,
<a name="32530"/>32530: 			 sock3  := Sock3,
<a name="32531"/>32531: 			 sock4  := Sock4,
<a name="32532"/>32532: 			 sock5  := Sock5} = _State) -&gt;
<a name="32533"/>32533: 			   Socks = [Sock1, Sock2, Sock3, Sock4, Sock5],
<a name="32534"/>32534:                            ?SEV_ANNOUNCE_READY(Tester, init, Socks),
<a name="32535"/>32535:                            ok
<a name="32536"/>32536:                    end},
<a name="32537"/>32537: 
<a name="32538"/>32538:          %% The actual test
<a name="32539"/>32539:          #{desc =&gt; &quot;await terminate (from tester)&quot;,
<a name="32540"/>32540:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="32541"/>32541:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="32542"/>32542:                                ok -&gt;
<a name="32543"/>32543:                                    {ok, maps:remove(tester, State)};
<a name="32544"/>32544:                                {error, _} = ERROR -&gt;
<a name="32545"/>32545:                                    ERROR
<a name="32546"/>32546:                            end
<a name="32547"/>32547:                    end},
<a name="32548"/>32548: 
<a name="32549"/>32549:          %% *** We are done ***
<a name="32550"/>32550:          ?SEV_FINISH_NORMAL
<a name="32551"/>32551:         ],
<a name="32552"/>32552: 
<a name="32553"/>32553: 
<a name="32554"/>32554:     ClientSeq =
<a name="32555"/>32555:         [
<a name="32556"/>32556:          %% *** Wait for start order part ***
<a name="32557"/>32557:          #{desc =&gt; &quot;await start (from tester)&quot;,
<a name="32558"/>32558:            cmd  =&gt; fun(State) -&gt;
<a name="32559"/>32559:                            Tester = ?SEV_AWAIT_START(),
<a name="32560"/>32560:                            {ok, State#{tester =&gt; Tester}}
<a name="32561"/>32561:                    end},
<a name="32562"/>32562:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="32563"/>32563:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="32564"/>32564:                            _MRef = erlang:monitor(process, Tester),
<a name="32565"/>32565:                            ok
<a name="32566"/>32566:                    end},
<a name="32567"/>32567: 
<a name="32568"/>32568:          %% *** Init part ***
<a name="32569"/>32569:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="32570"/>32570:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="32571"/>32571:                            ?SEV_ANNOUNCE_READY(Tester, init),
<a name="32572"/>32572:                            ok
<a name="32573"/>32573:                    end},
<a name="32574"/>32574:          #{desc =&gt; &quot;await continue (socket)&quot;,
<a name="32575"/>32575:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="32576"/>32576:                            {ok, [Sock1, Sock2, Sock3, Sock4, Sock5]} =
<a name="32577"/>32577: 			       ?SEV_AWAIT_CONTINUE(Tester, tester, socket),
<a name="32578"/>32578: 			   ?SEV_IPRINT(&quot;Sockets: &quot;
<a name="32579"/>32579: 				       &quot;~n   1: ~p&quot;
<a name="32580"/>32580: 				       &quot;~n   2: ~p&quot;
<a name="32581"/>32581: 				       &quot;~n   3: ~p&quot;
<a name="32582"/>32582: 				       &quot;~n   4: ~p&quot;
<a name="32583"/>32583: 				       &quot;~n   5: ~p&quot;,
<a name="32584"/>32584: 				       [Sock1, Sock2, Sock3, Sock4, Sock5]),
<a name="32585"/>32585: 			   {ok, State#{sock1 =&gt; Sock1,
<a name="32586"/>32586: 				       sock2 =&gt; Sock2,
<a name="32587"/>32587: 				       sock3 =&gt; Sock3,
<a name="32588"/>32588: 				       sock4 =&gt; Sock4,
<a name="32589"/>32589: 				       sock5 =&gt; Sock5}}
<a name="32590"/>32590:                    end},
<a name="32591"/>32591: 
<a name="32592"/>32592: 
<a name="32593"/>32593:          %% The actual test
<a name="32594"/>32594:          #{desc =&gt; &quot;await continue (monitor)&quot;,
<a name="32595"/>32595:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="32596"/>32596:                            ?SEV_AWAIT_CONTINUE(Tester, tester, monitor)
<a name="32597"/>32597:                    end},
<a name="32598"/>32598: 
<a name="32599"/>32599:          #{desc =&gt; &quot;verify own number of monitors (=0)&quot;,
<a name="32600"/>32600:            cmd  =&gt; fun(_State) -&gt;
<a name="32601"/>32601: 			   0 = socket:number_of_monitors(self()),
<a name="32602"/>32602: 			   ok
<a name="32603"/>32603:                    end},
<a name="32604"/>32604:          #{desc =&gt; &quot;monitor socket&quot;,
<a name="32605"/>32605:            cmd  =&gt; fun(#{sock1 := Sock1,
<a name="32606"/>32606: 			 sock2 := Sock2,
<a name="32607"/>32607: 			 sock3 := Sock3,
<a name="32608"/>32608: 			 sock4 := Sock4,
<a name="32609"/>32609: 			 sock5 := Sock5} = State) -&gt;
<a name="32610"/>32610:                            MRef1 = socket:monitor(Sock1),
<a name="32611"/>32611:                            MRef2 = socket:monitor(Sock2),
<a name="32612"/>32612:                            MRef3 = socket:monitor(Sock3),
<a name="32613"/>32613:                            MRef4 = socket:monitor(Sock4),
<a name="32614"/>32614:                            MRef5 = socket:monitor(Sock5),
<a name="32615"/>32615: 			   ?SEV_IPRINT(&quot;Monitors: &quot;
<a name="32616"/>32616: 				       &quot;~n   1: ~p&quot;
<a name="32617"/>32617: 				       &quot;~n   2: ~p&quot;
<a name="32618"/>32618: 				       &quot;~n   3: ~p&quot;
<a name="32619"/>32619: 				       &quot;~n   4: ~p&quot;
<a name="32620"/>32620: 				       &quot;~n   5: ~p&quot;,
<a name="32621"/>32621: 				       [MRef1, MRef2, MRef3, MRef4, MRef5]),
<a name="32622"/>32622: 			   {ok, State#{mon1 =&gt; MRef1,
<a name="32623"/>32623: 				       mon2 =&gt; MRef2,
<a name="32624"/>32624: 				       mon3 =&gt; MRef3,
<a name="32625"/>32625: 				       mon4 =&gt; MRef4,
<a name="32626"/>32626: 				       mon5 =&gt; MRef5}}
<a name="32627"/>32627:                    end},
<a name="32628"/>32628:          #{desc =&gt; &quot;verify own number of monitors (=5)&quot;,
<a name="32629"/>32629:            cmd  =&gt; fun(_State) -&gt;
<a name="32630"/>32630: 			   5 = socket:number_of_monitors(self()),
<a name="32631"/>32631: 			   ok
<a name="32632"/>32632:                    end},
<a name="32633"/>32633:          #{desc =&gt; &quot;announce ready (monitor)&quot;,
<a name="32634"/>32634:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="32635"/>32635:                            ?SEV_ANNOUNCE_READY(Tester, monitor),
<a name="32636"/>32636:                            ok
<a name="32637"/>32637:                    end},
<a name="32638"/>32638: 
<a name="32639"/>32639:          #{desc =&gt; &quot;await continue (down)&quot;,
<a name="32640"/>32640:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="32641"/>32641:                            ?SEV_AWAIT_CONTINUE(Tester, tester, down)
<a name="32642"/>32642:                    end},
<a name="32643"/>32643: 
<a name="32644"/>32644:          #{desc =&gt; &quot;await socket 1 down&quot;,
<a name="32645"/>32645:            cmd  =&gt; fun(#{sock1 := Sock,
<a name="32646"/>32646: 			 mon1  := MRef} = State) -&gt;
<a name="32647"/>32647: 			   receive
<a name="32648"/>32648: 			       {'DOWN', MRef, socket, Sock, Info} -&gt;
<a name="32649"/>32649: 				   ?SEV_IPRINT(&quot;received expected down: &quot;
<a name="32650"/>32650: 					       &quot;~n      MRef:   ~p&quot;
<a name="32651"/>32651: 					       &quot;~n      Socket: ~p&quot;
<a name="32652"/>32652: 					       &quot;~n      Info:   ~p&quot;,
<a name="32653"/>32653: 					       [MRef, Sock, Info]),
<a name="32654"/>32654: 				   State2 = maps:remove(mon1, State),
<a name="32655"/>32655: 				   State3 = maps:remove(sock1, State2),
<a name="32656"/>32656: 				   {ok, State3}
<a name="32657"/>32657: 			   after 5000 -&gt;
<a name="32658"/>32658: 				   ?SEV_EPRINT(&quot;socket down timeout&quot;),
<a name="32659"/>32659: 				   {error, timeout}
<a name="32660"/>32660: 			   end
<a name="32661"/>32661:                    end},
<a name="32662"/>32662: 
<a name="32663"/>32663:          #{desc =&gt; &quot;await socket 2 down&quot;,
<a name="32664"/>32664:            cmd  =&gt; fun(#{sock2 := Sock,
<a name="32665"/>32665: 			 mon2  := MRef} = State) -&gt;
<a name="32666"/>32666: 			   receive
<a name="32667"/>32667: 			       {'DOWN', MRef, socket, Sock, Info} -&gt;
<a name="32668"/>32668: 				   ?SEV_IPRINT(&quot;received expected down: &quot;
<a name="32669"/>32669: 					       &quot;~n      MRef:   ~p&quot;
<a name="32670"/>32670: 					       &quot;~n      Socket: ~p&quot;
<a name="32671"/>32671: 					       &quot;~n      Info:   ~p&quot;,
<a name="32672"/>32672: 					       [MRef, Sock, Info]),
<a name="32673"/>32673: 				   State2 = maps:remove(mon2, State),
<a name="32674"/>32674: 				   State3 = maps:remove(sock2, State2),
<a name="32675"/>32675: 				   {ok, State3}
<a name="32676"/>32676: 			   after 5000 -&gt;
<a name="32677"/>32677: 				   ?SEV_EPRINT(&quot;socket down timeout&quot;),
<a name="32678"/>32678: 				   {error, timeout}
<a name="32679"/>32679: 			   end
<a name="32680"/>32680:                    end},
<a name="32681"/>32681: 
<a name="32682"/>32682:          #{desc =&gt; &quot;await socket 3 down&quot;,
<a name="32683"/>32683:            cmd  =&gt; fun(#{sock3 := Sock,
<a name="32684"/>32684: 			 mon3  := MRef} = State) -&gt;
<a name="32685"/>32685: 			   receive
<a name="32686"/>32686: 			       {'DOWN', MRef, socket, Sock, Info} -&gt;
<a name="32687"/>32687: 				   ?SEV_IPRINT(&quot;received expected down: &quot;
<a name="32688"/>32688: 					       &quot;~n      MRef:   ~p&quot;
<a name="32689"/>32689: 					       &quot;~n      Socket: ~p&quot;
<a name="32690"/>32690: 					       &quot;~n      Info:   ~p&quot;,
<a name="32691"/>32691: 					       [MRef, Sock, Info]),
<a name="32692"/>32692: 				   State2 = maps:remove(mon3, State),
<a name="32693"/>32693: 				   State3 = maps:remove(sock3, State2),
<a name="32694"/>32694: 				   {ok, State3}
<a name="32695"/>32695: 			   after 5000 -&gt;
<a name="32696"/>32696: 				   ?SEV_EPRINT(&quot;socket down timeout&quot;),
<a name="32697"/>32697: 				   {error, timeout}
<a name="32698"/>32698: 			   end
<a name="32699"/>32699:                    end},
<a name="32700"/>32700: 
<a name="32701"/>32701:          #{desc =&gt; &quot;await socket 4 down&quot;,
<a name="32702"/>32702:            cmd  =&gt; fun(#{sock4 := Sock,
<a name="32703"/>32703: 			 mon4  := MRef} = State) -&gt;
<a name="32704"/>32704: 			   receive
<a name="32705"/>32705: 			       {'DOWN', MRef, socket, Sock, Info} -&gt;
<a name="32706"/>32706: 				   ?SEV_IPRINT(&quot;received expected down: &quot;
<a name="32707"/>32707: 					       &quot;~n      MRef:   ~p&quot;
<a name="32708"/>32708: 					       &quot;~n      Socket: ~p&quot;
<a name="32709"/>32709: 					       &quot;~n      Info:   ~p&quot;,
<a name="32710"/>32710: 					       [MRef, Sock, Info]),
<a name="32711"/>32711: 				   State2 = maps:remove(mon4, State),
<a name="32712"/>32712: 				   State3 = maps:remove(sock4, State2),
<a name="32713"/>32713: 				   {ok, State3}
<a name="32714"/>32714: 			   after 5000 -&gt;
<a name="32715"/>32715: 				   ?SEV_EPRINT(&quot;socket down timeout&quot;),
<a name="32716"/>32716: 				   {error, timeout}
<a name="32717"/>32717: 			   end
<a name="32718"/>32718:                    end},
<a name="32719"/>32719: 
<a name="32720"/>32720:          #{desc =&gt; &quot;await socket 5 down&quot;,
<a name="32721"/>32721:            cmd  =&gt; fun(#{sock5 := Sock,
<a name="32722"/>32722: 			 mon5  := MRef} = State) -&gt;
<a name="32723"/>32723: 			   receive
<a name="32724"/>32724: 			       {'DOWN', MRef, socket, Sock, Info} -&gt;
<a name="32725"/>32725: 				   ?SEV_IPRINT(&quot;received expected down: &quot;
<a name="32726"/>32726: 					       &quot;~n      MRef:   ~p&quot;
<a name="32727"/>32727: 					       &quot;~n      Socket: ~p&quot;
<a name="32728"/>32728: 					       &quot;~n      Info:   ~p&quot;,
<a name="32729"/>32729: 					       [MRef, Sock, Info]),
<a name="32730"/>32730: 				   State2 = maps:remove(mon5, State),
<a name="32731"/>32731: 				   State3 = maps:remove(sock5, State2),
<a name="32732"/>32732: 				   {ok, State3}
<a name="32733"/>32733: 			   after 5000 -&gt;
<a name="32734"/>32734: 				   ?SEV_EPRINT(&quot;socket down timeout&quot;),
<a name="32735"/>32735: 				   {error, timeout}
<a name="32736"/>32736: 			   end
<a name="32737"/>32737:                    end},
<a name="32738"/>32738:          #{desc =&gt; &quot;verify own number of monitors (=0)&quot;,
<a name="32739"/>32739:            cmd  =&gt; fun(_State) -&gt;
<a name="32740"/>32740: 			   0 = socket:number_of_monitors(self()),
<a name="32741"/>32741: 			   ok
<a name="32742"/>32742:                    end},
<a name="32743"/>32743:          #{desc =&gt; &quot;announce ready (down)&quot;,
<a name="32744"/>32744:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="32745"/>32745:                            ?SEV_ANNOUNCE_READY(Tester, down),
<a name="32746"/>32746:                            ok
<a name="32747"/>32747:                    end},
<a name="32748"/>32748: 
<a name="32749"/>32749: 
<a name="32750"/>32750:          #{desc =&gt; &quot;await terminate (from tester)&quot;,
<a name="32751"/>32751:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="32752"/>32752:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="32753"/>32753:                                ok -&gt;
<a name="32754"/>32754:                                    {ok, maps:remove(tester, State)};
<a name="32755"/>32755:                                {error, _} = ERROR -&gt;
<a name="32756"/>32756:                                    ERROR
<a name="32757"/>32757:                            end
<a name="32758"/>32758:                    end},
<a name="32759"/>32759: 
<a name="32760"/>32760:          %% *** We are done ***
<a name="32761"/>32761:          ?SEV_FINISH_NORMAL
<a name="32762"/>32762:         ],
<a name="32763"/>32763: 
<a name="32764"/>32764:     TesterSeq =
<a name="32765"/>32765:         [
<a name="32766"/>32766:          %% *** Init part ***
<a name="32767"/>32767:          #{desc =&gt; &quot;monitor 'owner'&quot;,
<a name="32768"/>32768:            cmd  =&gt; fun(#{owner := Owner} = _State) -&gt;
<a name="32769"/>32769:                            _MRef = erlang:monitor(process, Owner),
<a name="32770"/>32770:                            ok
<a name="32771"/>32771:                    end},
<a name="32772"/>32772:          #{desc =&gt; &quot;order (owner) start&quot;,
<a name="32773"/>32773:            cmd  =&gt; fun(#{owner := Pid} = _State) -&gt;
<a name="32774"/>32774:                            ?SEV_ANNOUNCE_START(Pid),
<a name="32775"/>32775:                            ok
<a name="32776"/>32776:                    end},
<a name="32777"/>32777:          #{desc =&gt; &quot;await (owner) ready&quot;,
<a name="32778"/>32778:            cmd  =&gt; fun(#{owner := Pid} = State) -&gt;
<a name="32779"/>32779:                            {ok, [Sock1, Sock2, Sock3, Sock4, Sock5]} =
<a name="32780"/>32780: 			       ?SEV_AWAIT_READY(Pid, owner, init),
<a name="32781"/>32781:                            {ok, State#{sock1 =&gt; Sock1,
<a name="32782"/>32782: 				       sock2 =&gt; Sock2,
<a name="32783"/>32783: 				       sock3 =&gt; Sock3,
<a name="32784"/>32784: 				       sock4 =&gt; Sock4,
<a name="32785"/>32785: 				       sock5 =&gt; Sock5}}
<a name="32786"/>32786:                    end},
<a name="32787"/>32787: 
<a name="32788"/>32788:          #{desc =&gt; &quot;monitor 'client 1'&quot;,
<a name="32789"/>32789:            cmd  =&gt; fun(#{client1 := Pid} = _State) -&gt;
<a name="32790"/>32790:                            _MRef = erlang:monitor(process, Pid),
<a name="32791"/>32791:                            ok
<a name="32792"/>32792:                    end},
<a name="32793"/>32793:          #{desc =&gt; &quot;order (client 1) start&quot;,
<a name="32794"/>32794:            cmd  =&gt; fun(#{client1 := Pid} = _State) -&gt;
<a name="32795"/>32795:                            ?SEV_ANNOUNCE_START(Pid),
<a name="32796"/>32796:                            ok
<a name="32797"/>32797:                    end},
<a name="32798"/>32798:          #{desc =&gt; &quot;await (client 1) ready&quot;,
<a name="32799"/>32799:            cmd  =&gt; fun(#{client1 := Pid} = _State) -&gt;
<a name="32800"/>32800:                            ok = ?SEV_AWAIT_READY(Pid, client1, init)
<a name="32801"/>32801:                    end},
<a name="32802"/>32802:          #{desc =&gt; &quot;send socket to client 1&quot;,
<a name="32803"/>32803:            cmd  =&gt; fun(#{client1 := Pid,
<a name="32804"/>32804: 			 sock1   := Sock1,
<a name="32805"/>32805: 			 sock2   := Sock2,
<a name="32806"/>32806: 			 sock3   := Sock3,
<a name="32807"/>32807: 			 sock4   := Sock4,
<a name="32808"/>32808: 			 sock5   := Sock5} = _State) -&gt;
<a name="32809"/>32809: 			   Socks = [Sock1, Sock2, Sock3, Sock4, Sock5],
<a name="32810"/>32810:                            ?SEV_ANNOUNCE_CONTINUE(Pid, socket, Socks),
<a name="32811"/>32811:                            ok
<a name="32812"/>32812:                    end},
<a name="32813"/>32813: 
<a name="32814"/>32814:          #{desc =&gt; &quot;monitor 'client 2'&quot;,
<a name="32815"/>32815:            cmd  =&gt; fun(#{client2 := Pid} = _State) -&gt;
<a name="32816"/>32816:                            _MRef = erlang:monitor(process, Pid),
<a name="32817"/>32817:                            ok
<a name="32818"/>32818:                    end},
<a name="32819"/>32819:          #{desc =&gt; &quot;order (client 2) start&quot;,
<a name="32820"/>32820:            cmd  =&gt; fun(#{client2 := Pid} = _State) -&gt;
<a name="32821"/>32821:                            ?SEV_ANNOUNCE_START(Pid),
<a name="32822"/>32822:                            ok
<a name="32823"/>32823:                    end},
<a name="32824"/>32824:          #{desc =&gt; &quot;await (client 2) ready&quot;,
<a name="32825"/>32825:            cmd  =&gt; fun(#{client2 := Pid} = _State) -&gt;
<a name="32826"/>32826:                            ok = ?SEV_AWAIT_READY(Pid, client2, init)
<a name="32827"/>32827:                    end},
<a name="32828"/>32828:          #{desc =&gt; &quot;send socket to client 2&quot;,
<a name="32829"/>32829:            cmd  =&gt; fun(#{client2 := Pid,
<a name="32830"/>32830: 			 sock1   := Sock1,
<a name="32831"/>32831: 			 sock2   := Sock2,
<a name="32832"/>32832: 			 sock3   := Sock3,
<a name="32833"/>32833: 			 sock4   := Sock4,
<a name="32834"/>32834: 			 sock5   := Sock5} = _State) -&gt;
<a name="32835"/>32835: 			   Socks = [Sock1, Sock2, Sock3, Sock4, Sock5],
<a name="32836"/>32836:                            ?SEV_ANNOUNCE_CONTINUE(Pid, socket, Socks),
<a name="32837"/>32837:                            ok
<a name="32838"/>32838:                    end},
<a name="32839"/>32839: 
<a name="32840"/>32840:          #{desc =&gt; &quot;monitor 'client 3'&quot;,
<a name="32841"/>32841:            cmd  =&gt; fun(#{client3 := Pid} = _State) -&gt;
<a name="32842"/>32842:                            _MRef = erlang:monitor(process, Pid),
<a name="32843"/>32843:                            ok
<a name="32844"/>32844:                    end},
<a name="32845"/>32845:          #{desc =&gt; &quot;order (client 3) start&quot;,
<a name="32846"/>32846:            cmd  =&gt; fun(#{client3 := Pid} = _State) -&gt;
<a name="32847"/>32847:                            ?SEV_ANNOUNCE_START(Pid),
<a name="32848"/>32848:                            ok
<a name="32849"/>32849:                    end},
<a name="32850"/>32850:          #{desc =&gt; &quot;await (client 3) ready&quot;,
<a name="32851"/>32851:            cmd  =&gt; fun(#{client3 := Pid} = _State) -&gt;
<a name="32852"/>32852:                            ok = ?SEV_AWAIT_READY(Pid, client3, init)
<a name="32853"/>32853:                    end},
<a name="32854"/>32854:          #{desc =&gt; &quot;send socket to client 3&quot;,
<a name="32855"/>32855:            cmd  =&gt; fun(#{client3 := Pid,
<a name="32856"/>32856: 			 sock1   := Sock1,
<a name="32857"/>32857: 			 sock2   := Sock2,
<a name="32858"/>32858: 			 sock3   := Sock3,
<a name="32859"/>32859: 			 sock4   := Sock4,
<a name="32860"/>32860: 			 sock5   := Sock5} = _State) -&gt;
<a name="32861"/>32861: 			   Socks = [Sock1, Sock2, Sock3, Sock4, Sock5],
<a name="32862"/>32862:                            ?SEV_ANNOUNCE_CONTINUE(Pid, socket, Socks),
<a name="32863"/>32863:                            ok
<a name="32864"/>32864:                    end},
<a name="32865"/>32865: 
<a name="32866"/>32866:          #{desc =&gt; &quot;monitor 'client 4'&quot;,
<a name="32867"/>32867:            cmd  =&gt; fun(#{client4 := Pid} = _State) -&gt;
<a name="32868"/>32868:                            _MRef = erlang:monitor(process, Pid),
<a name="32869"/>32869:                            ok
<a name="32870"/>32870:                    end},
<a name="32871"/>32871:          #{desc =&gt; &quot;order (client 4) start&quot;,
<a name="32872"/>32872:            cmd  =&gt; fun(#{client4 := Pid} = _State) -&gt;
<a name="32873"/>32873:                            ?SEV_ANNOUNCE_START(Pid),
<a name="32874"/>32874:                            ok
<a name="32875"/>32875:                    end},
<a name="32876"/>32876:          #{desc =&gt; &quot;await (client 4) ready&quot;,
<a name="32877"/>32877:            cmd  =&gt; fun(#{client4 := Pid} = _State) -&gt;
<a name="32878"/>32878:                            ok = ?SEV_AWAIT_READY(Pid, client4, init)
<a name="32879"/>32879:                    end},
<a name="32880"/>32880:          #{desc =&gt; &quot;send socket to client 4&quot;,
<a name="32881"/>32881:            cmd  =&gt; fun(#{client4 := Pid,
<a name="32882"/>32882: 			 sock1   := Sock1,
<a name="32883"/>32883: 			 sock2   := Sock2,
<a name="32884"/>32884: 			 sock3   := Sock3,
<a name="32885"/>32885: 			 sock4   := Sock4,
<a name="32886"/>32886: 			 sock5   := Sock5} = _State) -&gt;
<a name="32887"/>32887: 			   Socks = [Sock1, Sock2, Sock3, Sock4, Sock5],
<a name="32888"/>32888:                            ?SEV_ANNOUNCE_CONTINUE(Pid, socket, Socks),
<a name="32889"/>32889:                            ok
<a name="32890"/>32890:                    end},
<a name="32891"/>32891: 
<a name="32892"/>32892:          #{desc =&gt; &quot;monitor 'client 5'&quot;,
<a name="32893"/>32893:            cmd  =&gt; fun(#{client5 := Pid} = _State) -&gt;
<a name="32894"/>32894:                            _MRef = erlang:monitor(process, Pid),
<a name="32895"/>32895:                            ok
<a name="32896"/>32896:                    end},
<a name="32897"/>32897:          #{desc =&gt; &quot;order (client 5) start&quot;,
<a name="32898"/>32898:            cmd  =&gt; fun(#{client5 := Pid} = _State) -&gt;
<a name="32899"/>32899:                            ?SEV_ANNOUNCE_START(Pid),
<a name="32900"/>32900:                            ok
<a name="32901"/>32901:                    end},
<a name="32902"/>32902:          #{desc =&gt; &quot;await (client 5) ready&quot;,
<a name="32903"/>32903:            cmd  =&gt; fun(#{client5 := Pid} = _State) -&gt;
<a name="32904"/>32904:                            ok = ?SEV_AWAIT_READY(Pid, client5, init)
<a name="32905"/>32905:                    end},
<a name="32906"/>32906:          #{desc =&gt; &quot;send socket to client 5&quot;,
<a name="32907"/>32907:            cmd  =&gt; fun(#{client5 := Pid,
<a name="32908"/>32908: 			 sock1   := Sock1,
<a name="32909"/>32909: 			 sock2   := Sock2,
<a name="32910"/>32910: 			 sock3   := Sock3,
<a name="32911"/>32911: 			 sock4   := Sock4,
<a name="32912"/>32912: 			 sock5   := Sock5} = _State) -&gt;
<a name="32913"/>32913: 			   Socks = [Sock1, Sock2, Sock3, Sock4, Sock5],
<a name="32914"/>32914:                            ?SEV_ANNOUNCE_CONTINUE(Pid, socket, Socks),
<a name="32915"/>32915:                            ok
<a name="32916"/>32916:                    end},
<a name="32917"/>32917: 
<a name="32918"/>32918: 
<a name="32919"/>32919:          %% The actual test
<a name="32920"/>32920: 	 #{desc =&gt; &quot;verify total number of monitors (=0)&quot;,
<a name="32921"/>32921:            cmd  =&gt; fun(_State) -&gt;
<a name="32922"/>32922: 			   0 = socket:number_of_monitors(),
<a name="32923"/>32923: 			   ok
<a name="32924"/>32924:                    end},
<a name="32925"/>32925: 
<a name="32926"/>32926:          #{desc =&gt; &quot;order client 1 to monitor&quot;,
<a name="32927"/>32927:            cmd  =&gt; fun(#{client1 := Pid} = _State) -&gt;
<a name="32928"/>32928:                            ?SEV_ANNOUNCE_CONTINUE(Pid, monitor),
<a name="32929"/>32929:                            ok
<a name="32930"/>32930:                    end},
<a name="32931"/>32931:          #{desc =&gt; &quot;await (client 1) ready&quot;,
<a name="32932"/>32932:            cmd  =&gt; fun(#{client1 := Pid} = _State) -&gt;
<a name="32933"/>32933:                            ok = ?SEV_AWAIT_READY(Pid, client1, monitor)
<a name="32934"/>32934:                    end},
<a name="32935"/>32935: 	 #{desc =&gt; &quot;verify total number of monitors (=1*5)&quot;,
<a name="32936"/>32936:            cmd  =&gt; fun(_State) -&gt;
<a name="32937"/>32937: 			   1*5 = socket:number_of_monitors(),
<a name="32938"/>32938: 			   ok
<a name="32939"/>32939:                    end},
<a name="32940"/>32940: 
<a name="32941"/>32941:          #{desc =&gt; &quot;order client 2 to monitor&quot;,
<a name="32942"/>32942:            cmd  =&gt; fun(#{client2 := Pid} = _State) -&gt;
<a name="32943"/>32943:                            ?SEV_ANNOUNCE_CONTINUE(Pid, monitor),
<a name="32944"/>32944:                            ok
<a name="32945"/>32945:                    end},
<a name="32946"/>32946:          #{desc =&gt; &quot;await (client 2) ready&quot;,
<a name="32947"/>32947:            cmd  =&gt; fun(#{client2 := Pid} = _State) -&gt;
<a name="32948"/>32948:                            ok = ?SEV_AWAIT_READY(Pid, client2, monitor)
<a name="32949"/>32949:                    end},
<a name="32950"/>32950: 	 #{desc =&gt; &quot;verify total number of monitors (=2*5)&quot;,
<a name="32951"/>32951:            cmd  =&gt; fun(_State) -&gt;
<a name="32952"/>32952: 			   2*5 = socket:number_of_monitors(),
<a name="32953"/>32953: 			   ok
<a name="32954"/>32954:                    end},
<a name="32955"/>32955: 
<a name="32956"/>32956:          #{desc =&gt; &quot;order client 3 to monitor&quot;,
<a name="32957"/>32957:            cmd  =&gt; fun(#{client3 := Pid} = _State) -&gt;
<a name="32958"/>32958:                            ?SEV_ANNOUNCE_CONTINUE(Pid, monitor),
<a name="32959"/>32959:                            ok
<a name="32960"/>32960:                    end},
<a name="32961"/>32961:          #{desc =&gt; &quot;await (client 3) ready&quot;,
<a name="32962"/>32962:            cmd  =&gt; fun(#{client3 := Pid} = _State) -&gt;
<a name="32963"/>32963:                            ok = ?SEV_AWAIT_READY(Pid, client3, monitor)
<a name="32964"/>32964:                    end},
<a name="32965"/>32965: 	 #{desc =&gt; &quot;verify total number of monitors (=3*5)&quot;,
<a name="32966"/>32966:            cmd  =&gt; fun(_State) -&gt;
<a name="32967"/>32967: 			   3*5 = socket:number_of_monitors(),
<a name="32968"/>32968: 			   ok
<a name="32969"/>32969:                    end},
<a name="32970"/>32970: 
<a name="32971"/>32971:          #{desc =&gt; &quot;order client 4 to monitor&quot;,
<a name="32972"/>32972:            cmd  =&gt; fun(#{client4 := Pid} = _State) -&gt;
<a name="32973"/>32973:                            ?SEV_ANNOUNCE_CONTINUE(Pid, monitor),
<a name="32974"/>32974:                            ok
<a name="32975"/>32975:                    end},
<a name="32976"/>32976:          #{desc =&gt; &quot;await (client 4) ready&quot;,
<a name="32977"/>32977:            cmd  =&gt; fun(#{client4 := Pid} = _State) -&gt;
<a name="32978"/>32978:                            ok = ?SEV_AWAIT_READY(Pid, client4, monitor)
<a name="32979"/>32979:                    end},
<a name="32980"/>32980: 	 #{desc =&gt; &quot;verify total number of monitors (=4*5)&quot;,
<a name="32981"/>32981:            cmd  =&gt; fun(_State) -&gt;
<a name="32982"/>32982: 			   4*5 = socket:number_of_monitors(),
<a name="32983"/>32983: 			   ok
<a name="32984"/>32984:                    end},
<a name="32985"/>32985: 
<a name="32986"/>32986:          #{desc =&gt; &quot;order client 5 to monitor&quot;,
<a name="32987"/>32987:            cmd  =&gt; fun(#{client5 := Pid} = _State) -&gt;
<a name="32988"/>32988:                            ?SEV_ANNOUNCE_CONTINUE(Pid, monitor),
<a name="32989"/>32989:                            ok
<a name="32990"/>32990:                    end},
<a name="32991"/>32991:          #{desc =&gt; &quot;await (client 5) ready&quot;,
<a name="32992"/>32992:            cmd  =&gt; fun(#{client5 := Pid} = _State) -&gt;
<a name="32993"/>32993:                            ok = ?SEV_AWAIT_READY(Pid, client5, monitor)
<a name="32994"/>32994:                    end},
<a name="32995"/>32995: 	 #{desc =&gt; &quot;verify total number of monitors (=5*5)&quot;,
<a name="32996"/>32996:            cmd  =&gt; fun(_State) -&gt;
<a name="32997"/>32997: 			   5*5 = socket:number_of_monitors(),
<a name="32998"/>32998: 			   ok
<a name="32999"/>32999:                    end},
<a name="33000"/>33000: 
<a name="33001"/>33001:          #{desc =&gt; &quot;order client 1 to await down&quot;,
<a name="33002"/>33002:            cmd  =&gt; fun(#{client1 := Pid} = _State) -&gt;
<a name="33003"/>33003:                            ?SEV_ANNOUNCE_CONTINUE(Pid, down),
<a name="33004"/>33004:                            ok
<a name="33005"/>33005:                    end},
<a name="33006"/>33006:          #{desc =&gt; &quot;order client 2 to await down&quot;,
<a name="33007"/>33007:            cmd  =&gt; fun(#{client2 := Pid} = _State) -&gt;
<a name="33008"/>33008:                            ?SEV_ANNOUNCE_CONTINUE(Pid, down),
<a name="33009"/>33009:                            ok
<a name="33010"/>33010:                    end},
<a name="33011"/>33011:          #{desc =&gt; &quot;order client 3 to await down&quot;,
<a name="33012"/>33012:            cmd  =&gt; fun(#{client3 := Pid} = _State) -&gt;
<a name="33013"/>33013:                            ?SEV_ANNOUNCE_CONTINUE(Pid, down),
<a name="33014"/>33014:                            ok
<a name="33015"/>33015:                    end},
<a name="33016"/>33016:          #{desc =&gt; &quot;order client 4 to await down&quot;,
<a name="33017"/>33017:            cmd  =&gt; fun(#{client4 := Pid} = _State) -&gt;
<a name="33018"/>33018:                            ?SEV_ANNOUNCE_CONTINUE(Pid, down),
<a name="33019"/>33019:                            ok
<a name="33020"/>33020:                    end},
<a name="33021"/>33021:          #{desc =&gt; &quot;order client 5 to await down&quot;,
<a name="33022"/>33022:            cmd  =&gt; fun(#{client5 := Pid} = _State) -&gt;
<a name="33023"/>33023:                            ?SEV_ANNOUNCE_CONTINUE(Pid, down),
<a name="33024"/>33024:                            ok
<a name="33025"/>33025:                    end},
<a name="33026"/>33026: 
<a name="33027"/>33027: 	 ?SEV_SLEEP(?SECS(1)),
<a name="33028"/>33028: 
<a name="33029"/>33029:          #{desc =&gt; &quot;order (owner) terminate&quot;,
<a name="33030"/>33030:            cmd  =&gt; fun(#{owner := Pid} = _State) -&gt;
<a name="33031"/>33031:                            ?SEV_ANNOUNCE_TERMINATE(Pid),
<a name="33032"/>33032:                            ok
<a name="33033"/>33033:                    end},
<a name="33034"/>33034:          #{desc =&gt; &quot;await (owner) termination&quot;,
<a name="33035"/>33035:            cmd  =&gt; fun(#{owner := Pid} = State) -&gt;
<a name="33036"/>33036:                            case ?SEV_AWAIT_TERMINATION(Pid) of
<a name="33037"/>33037:                                ok -&gt;
<a name="33038"/>33038:                                    {ok, maps:remove(owner, State)};
<a name="33039"/>33039:                                {error, _} = ERROR -&gt;
<a name="33040"/>33040:                                    ERROR
<a name="33041"/>33041:                            end
<a name="33042"/>33042:                    end},
<a name="33043"/>33043: 
<a name="33044"/>33044:          #{desc =&gt; &quot;await (client 1) ready&quot;,
<a name="33045"/>33045:            cmd  =&gt; fun(#{client1 := Pid} = _State) -&gt;
<a name="33046"/>33046:                            ok = ?SEV_AWAIT_READY(Pid, client1, down)
<a name="33047"/>33047:                    end},
<a name="33048"/>33048:          #{desc =&gt; &quot;await (client 2) ready&quot;,
<a name="33049"/>33049:            cmd  =&gt; fun(#{client2 := Pid} = _State) -&gt;
<a name="33050"/>33050:                            ok = ?SEV_AWAIT_READY(Pid, client2, down)
<a name="33051"/>33051:                    end},
<a name="33052"/>33052:          #{desc =&gt; &quot;await (client 3) ready&quot;,
<a name="33053"/>33053:            cmd  =&gt; fun(#{client3 := Pid} = _State) -&gt;
<a name="33054"/>33054:                            ok = ?SEV_AWAIT_READY(Pid, client3, down)
<a name="33055"/>33055:                    end},
<a name="33056"/>33056:          #{desc =&gt; &quot;await (client 4) ready&quot;,
<a name="33057"/>33057:            cmd  =&gt; fun(#{client4 := Pid} = _State) -&gt;
<a name="33058"/>33058:                            ok = ?SEV_AWAIT_READY(Pid, client4, down)
<a name="33059"/>33059:                    end},
<a name="33060"/>33060:          #{desc =&gt; &quot;await (client 5) ready&quot;,
<a name="33061"/>33061:            cmd  =&gt; fun(#{client5 := Pid} = _State) -&gt;
<a name="33062"/>33062:                            ok = ?SEV_AWAIT_READY(Pid, client5, down)
<a name="33063"/>33063:                    end},
<a name="33064"/>33064: 
<a name="33065"/>33065: 	 #{desc =&gt; &quot;verify total number of monitors (=0)&quot;,
<a name="33066"/>33066:            cmd  =&gt; fun(_State) -&gt;
<a name="33067"/>33067: 			   0 = socket:number_of_monitors(),
<a name="33068"/>33068: 			   ok
<a name="33069"/>33069:                    end},
<a name="33070"/>33070: 
<a name="33071"/>33071: 	 ?SEV_SLEEP(?SECS(1)),
<a name="33072"/>33072: 
<a name="33073"/>33073:          %% Cleanup
<a name="33074"/>33074:          #{desc =&gt; &quot;order (client 1) terminate&quot;,
<a name="33075"/>33075:            cmd  =&gt; fun(#{client1 := Pid} = _State) -&gt;
<a name="33076"/>33076:                            ?SEV_ANNOUNCE_TERMINATE(Pid),
<a name="33077"/>33077:                            ok
<a name="33078"/>33078:                    end},
<a name="33079"/>33079:          #{desc =&gt; &quot;await (client 1) termination&quot;,
<a name="33080"/>33080:            cmd  =&gt; fun(#{client1 := Pid} = State) -&gt;
<a name="33081"/>33081:                            case ?SEV_AWAIT_TERMINATION(Pid) of
<a name="33082"/>33082:                                ok -&gt;
<a name="33083"/>33083:                                    {ok, maps:remove(client1, State)};
<a name="33084"/>33084:                                {error, _} = ERROR -&gt;
<a name="33085"/>33085:                                    ERROR
<a name="33086"/>33086:                            end
<a name="33087"/>33087:                    end},
<a name="33088"/>33088: 
<a name="33089"/>33089:          #{desc =&gt; &quot;order (client 2) terminate&quot;,
<a name="33090"/>33090:            cmd  =&gt; fun(#{client2 := Pid} = _State) -&gt;
<a name="33091"/>33091:                            ?SEV_ANNOUNCE_TERMINATE(Pid),
<a name="33092"/>33092:                            ok
<a name="33093"/>33093:                    end},
<a name="33094"/>33094:          #{desc =&gt; &quot;await (client 2) termination&quot;,
<a name="33095"/>33095:            cmd  =&gt; fun(#{client2 := Pid} = State) -&gt;
<a name="33096"/>33096:                            case ?SEV_AWAIT_TERMINATION(Pid) of
<a name="33097"/>33097:                                ok -&gt;
<a name="33098"/>33098:                                    {ok, maps:remove(client2, State)};
<a name="33099"/>33099:                                {error, _} = ERROR -&gt;
<a name="33100"/>33100:                                    ERROR
<a name="33101"/>33101:                            end
<a name="33102"/>33102:                    end},
<a name="33103"/>33103: 
<a name="33104"/>33104:          #{desc =&gt; &quot;order (client 3) terminate&quot;,
<a name="33105"/>33105:            cmd  =&gt; fun(#{client3 := Pid} = _State) -&gt;
<a name="33106"/>33106:                            ?SEV_ANNOUNCE_TERMINATE(Pid),
<a name="33107"/>33107:                            ok
<a name="33108"/>33108:                    end},
<a name="33109"/>33109:          #{desc =&gt; &quot;await (client 3) termination&quot;,
<a name="33110"/>33110:            cmd  =&gt; fun(#{client3 := Pid} = State) -&gt;
<a name="33111"/>33111:                            case ?SEV_AWAIT_TERMINATION(Pid) of
<a name="33112"/>33112:                                ok -&gt;
<a name="33113"/>33113:                                    {ok, maps:remove(client3, State)};
<a name="33114"/>33114:                                {error, _} = ERROR -&gt;
<a name="33115"/>33115:                                    ERROR
<a name="33116"/>33116:                            end
<a name="33117"/>33117:                    end},
<a name="33118"/>33118: 
<a name="33119"/>33119:          #{desc =&gt; &quot;order (client 4) terminate&quot;,
<a name="33120"/>33120:            cmd  =&gt; fun(#{client4 := Pid} = _State) -&gt;
<a name="33121"/>33121:                            ?SEV_ANNOUNCE_TERMINATE(Pid),
<a name="33122"/>33122:                            ok
<a name="33123"/>33123:                    end},
<a name="33124"/>33124:          #{desc =&gt; &quot;await (client 4) termination&quot;,
<a name="33125"/>33125:            cmd  =&gt; fun(#{client4 := Pid} = State) -&gt;
<a name="33126"/>33126:                            case ?SEV_AWAIT_TERMINATION(Pid) of
<a name="33127"/>33127:                                ok -&gt;
<a name="33128"/>33128:                                    {ok, maps:remove(client4, State)};
<a name="33129"/>33129:                                {error, _} = ERROR -&gt;
<a name="33130"/>33130:                                    ERROR
<a name="33131"/>33131:                            end
<a name="33132"/>33132:                    end},
<a name="33133"/>33133: 
<a name="33134"/>33134:          #{desc =&gt; &quot;order (client 5) terminate&quot;,
<a name="33135"/>33135:            cmd  =&gt; fun(#{client5 := Pid} = _State) -&gt;
<a name="33136"/>33136:                            ?SEV_ANNOUNCE_TERMINATE(Pid),
<a name="33137"/>33137:                            ok
<a name="33138"/>33138:                    end},
<a name="33139"/>33139:          #{desc =&gt; &quot;await (client 5) termination&quot;,
<a name="33140"/>33140:            cmd  =&gt; fun(#{client5 := Pid} = State) -&gt;
<a name="33141"/>33141:                            case ?SEV_AWAIT_TERMINATION(Pid) of
<a name="33142"/>33142:                                ok -&gt;
<a name="33143"/>33143:                                    {ok, maps:remove(client5, State)};
<a name="33144"/>33144:                                {error, _} = ERROR -&gt;
<a name="33145"/>33145:                                    ERROR
<a name="33146"/>33146:                            end
<a name="33147"/>33147:                    end},
<a name="33148"/>33148: 
<a name="33149"/>33149:          %% *** We are done ***
<a name="33150"/>33150:          ?SEV_FINISH_NORMAL
<a name="33151"/>33151:         ],
<a name="33152"/>33152: 
<a name="33153"/>33153:     i(&quot;start (socket) owner evaluator&quot;),
<a name="33154"/>33154:     Owner = ?SEV_START(&quot;owner&quot;, OwnerSeq, InitState),
<a name="33155"/>33155: 
<a name="33156"/>33156:     i(&quot;start client 1 evaluator&quot;),
<a name="33157"/>33157:     Client1 = ?SEV_START(&quot;client-1&quot;, ClientSeq, InitState),
<a name="33158"/>33158: 
<a name="33159"/>33159:     i(&quot;start client 2 evaluator&quot;),
<a name="33160"/>33160:     Client2 = ?SEV_START(&quot;client-2&quot;, ClientSeq, InitState),
<a name="33161"/>33161: 
<a name="33162"/>33162:     i(&quot;start client 3 evaluator&quot;),
<a name="33163"/>33163:     Client3 = ?SEV_START(&quot;client-3&quot;, ClientSeq, InitState),
<a name="33164"/>33164: 
<a name="33165"/>33165:     i(&quot;start client 4 evaluator&quot;),
<a name="33166"/>33166:     Client4 = ?SEV_START(&quot;client-4&quot;, ClientSeq, InitState),
<a name="33167"/>33167: 
<a name="33168"/>33168:     i(&quot;start client 5 evaluator&quot;),
<a name="33169"/>33169:     Client5 = ?SEV_START(&quot;client-5&quot;, ClientSeq, InitState),
<a name="33170"/>33170: 
<a name="33171"/>33171:     i(&quot;start tester evaluator&quot;),
<a name="33172"/>33172:     TesterInitState = #{owner   =&gt; Owner#ev.pid,
<a name="33173"/>33173: 			client1 =&gt; Client1#ev.pid,
<a name="33174"/>33174: 			client2 =&gt; Client2#ev.pid,
<a name="33175"/>33175: 			client3 =&gt; Client3#ev.pid,
<a name="33176"/>33176: 			client4 =&gt; Client4#ev.pid,
<a name="33177"/>33177: 			client5 =&gt; Client5#ev.pid},
<a name="33178"/>33178:     Tester = ?SEV_START(&quot;tester&quot;, TesterSeq, TesterInitState),
<a name="33179"/>33179: 
<a name="33180"/>33180:     i(&quot;await evaluator&quot;),
<a name="mon_open_and_exit_multi_socks_and_mon-last_expr"/><a name="33181"/>33181: <b>    ok = ?SEV_AWAIT_FINISH</b>([Owner, Tester]).
<a name="33182"/>33182: 
<a name="33183"/>33183: 
<a name="33184"/>33184: 
<a name="33185"/>33185: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="33186"/>33186: <i>%% Create several sockets (by 'owner' process), monitor each from several</i>
<a name="33187"/>33187: <i>%% different processes, then exit the owner.</i>
<a name="33188"/>33188: <i>%% The processes that did the monitor shall receive one socket DOWN for</i>
<a name="33189"/>33189: <i>%% each socket.</i>
<a name="33190"/>33190: 
<a name="monitor_closed_socket-1"/><a name="33191"/>33191: <b>monitor_closed_socket</b>(_Config) when is_list(_Config) -&gt;
<a name="33192"/>33192:     ?TT(?SECS(5)),
<a name="monitor_closed_socket-last_expr"/><a name="33193"/>33193: <b>    tc_try</b>(monitor_closed_socket,
<a name="33194"/>33194:            fun() -&gt;
<a name="33195"/>33195: 		   InitState = #{domain   =&gt; inet,
<a name="33196"/>33196:                                  type     =&gt; stream,
<a name="33197"/>33197:                                  protocol =&gt; tcp},
<a name="33198"/>33198:                    ok = mon_closed_socket(InitState)
<a name="33199"/>33199:            end).
<a name="33200"/>33200: 
<a name="33201"/>33201: 
<a name="mon_closed_socket-1"/><a name="33202"/>33202: <b>mon_closed_socket</b>(InitState) -&gt;
<a name="33203"/>33203:     OwnerSeq =
<a name="33204"/>33204:         [
<a name="33205"/>33205:          %% *** Wait for start order part ***
<a name="33206"/>33206:          #{desc =&gt; &quot;await start (from tester)&quot;,
<a name="33207"/>33207:            cmd  =&gt; fun(State) -&gt;
<a name="33208"/>33208:                            Tester = ?SEV_AWAIT_START(),
<a name="33209"/>33209:                            {ok, State#{tester =&gt; Tester}}
<a name="33210"/>33210:                    end},
<a name="33211"/>33211:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="33212"/>33212:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="33213"/>33213:                            _MRef = erlang:monitor(process, Tester),
<a name="33214"/>33214:                            ok
<a name="33215"/>33215:                    end},
<a name="33216"/>33216: 
<a name="33217"/>33217:          %% *** Init part ***
<a name="33218"/>33218:          #{desc =&gt; &quot;create socket&quot;,
<a name="33219"/>33219:            cmd  =&gt; fun(#{domain   := Domain, 
<a name="33220"/>33220:                          type     := Type, 
<a name="33221"/>33221:                          protocol := Proto} = State) -&gt;
<a name="33222"/>33222:                            case socket:open(Domain, Type, Proto) of
<a name="33223"/>33223:                                {ok, Sock} -&gt;
<a name="33224"/>33224:                                    {ok, State#{sock =&gt; Sock}};
<a name="33225"/>33225:                                {error, _} = ERROR -&gt;
<a name="33226"/>33226:                                    ERROR
<a name="33227"/>33227:                            end
<a name="33228"/>33228:                    end},
<a name="33229"/>33229:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="33230"/>33230:            cmd  =&gt; fun(#{tester := Tester,
<a name="33231"/>33231: 			 sock   := Sock} = State) -&gt;
<a name="33232"/>33232:                            ?SEV_ANNOUNCE_READY(Tester, init, Sock),
<a name="33233"/>33233:                            (catch socket:close(Sock)),
<a name="33234"/>33234:                            {ok, maps:remove(sock, State)}
<a name="33235"/>33235:                    end},
<a name="33236"/>33236: 
<a name="33237"/>33237:          %% The actual test
<a name="33238"/>33238:          #{desc =&gt; &quot;await terminate (from tester)&quot;,
<a name="33239"/>33239:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="33240"/>33240:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="33241"/>33241:                                ok -&gt;
<a name="33242"/>33242:                                    {ok, maps:remove(tester, State)};
<a name="33243"/>33243:                                {error, _} = ERROR -&gt;
<a name="33244"/>33244:                                    ERROR
<a name="33245"/>33245:                            end
<a name="33246"/>33246:                    end},
<a name="33247"/>33247: 
<a name="33248"/>33248:          %% *** We are done ***
<a name="33249"/>33249:          ?SEV_FINISH_NORMAL
<a name="33250"/>33250:         ],
<a name="33251"/>33251: 
<a name="33252"/>33252: 
<a name="33253"/>33253:     ClientSeq =
<a name="33254"/>33254:         [
<a name="33255"/>33255:          %% *** Wait for start order part ***
<a name="33256"/>33256:          #{desc =&gt; &quot;await start (from tester)&quot;,
<a name="33257"/>33257:            cmd  =&gt; fun(State) -&gt;
<a name="33258"/>33258:                            Tester = ?SEV_AWAIT_START(),
<a name="33259"/>33259:                            {ok, State#{tester =&gt; Tester}}
<a name="33260"/>33260:                    end},
<a name="33261"/>33261:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="33262"/>33262:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="33263"/>33263:                            _MRef = erlang:monitor(process, Tester),
<a name="33264"/>33264:                            ok
<a name="33265"/>33265:                    end},
<a name="33266"/>33266: 
<a name="33267"/>33267:          %% *** Init part ***
<a name="33268"/>33268:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="33269"/>33269:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="33270"/>33270:                            ?SEV_ANNOUNCE_READY(Tester, init),
<a name="33271"/>33271:                            ok
<a name="33272"/>33272:                    end},
<a name="33273"/>33273:          #{desc =&gt; &quot;await continue (socket)&quot;,
<a name="33274"/>33274:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="33275"/>33275:                            {ok, Sock} =
<a name="33276"/>33276:                                ?SEV_AWAIT_CONTINUE(Tester, tester, socket),
<a name="33277"/>33277: 			   ?SEV_IPRINT(&quot;Socket: &quot;
<a name="33278"/>33278: 				       &quot;~n      ~p&quot;, [Sock]),
<a name="33279"/>33279: 			   {ok, State#{sock =&gt; Sock}}
<a name="33280"/>33280:                    end},
<a name="33281"/>33281: 
<a name="33282"/>33282: 
<a name="33283"/>33283:          %% The actual test
<a name="33284"/>33284:          #{desc =&gt; &quot;await continue (monitor)&quot;,
<a name="33285"/>33285:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="33286"/>33286:                            ?SEV_AWAIT_CONTINUE(Tester, tester, monitor)
<a name="33287"/>33287:                    end},
<a name="33288"/>33288: 
<a name="33289"/>33289:          #{desc =&gt; &quot;monitor socket&quot;,
<a name="33290"/>33290:            cmd  =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="33291"/>33291:                            MRef = socket:monitor(Sock),
<a name="33292"/>33292: 			   ?SEV_IPRINT(&quot;Monitors: &quot;
<a name="33293"/>33293: 				       &quot;~n      ~p&quot;, [MRef]),
<a name="33294"/>33294: 			   {ok, State#{mon =&gt; MRef}}
<a name="33295"/>33295:                    end},
<a name="33296"/>33296:          
<a name="33297"/>33297:          #{desc =&gt; &quot;announce ready (monitor)&quot;,
<a name="33298"/>33298:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="33299"/>33299:                            ?SEV_ANNOUNCE_READY(Tester, monitor),
<a name="33300"/>33300:                            ok
<a name="33301"/>33301:                    end},
<a name="33302"/>33302: 
<a name="33303"/>33303:          #{desc =&gt; &quot;await continue (down)&quot;,
<a name="33304"/>33304:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="33305"/>33305:                            ?SEV_AWAIT_CONTINUE(Tester, tester, down)
<a name="33306"/>33306:                    end},
<a name="33307"/>33307: 
<a name="33308"/>33308:          #{desc =&gt; &quot;await socket down&quot;,
<a name="33309"/>33309:            cmd  =&gt; fun(#{sock := Sock,
<a name="33310"/>33310: 			 mon  := MRef} = State) -&gt;
<a name="33311"/>33311: 			   receive
<a name="33312"/>33312: 			       {'DOWN', MRef, socket, Sock, Info} -&gt;
<a name="33313"/>33313: 				   ?SEV_IPRINT(&quot;received expected down: &quot;
<a name="33314"/>33314: 					       &quot;~n      MRef:   ~p&quot;
<a name="33315"/>33315: 					       &quot;~n      Socket: ~p&quot;
<a name="33316"/>33316: 					       &quot;~n      Info:   ~p&quot;,
<a name="33317"/>33317: 					       [MRef, Sock, Info]),
<a name="33318"/>33318: 				   State2 = maps:remove(mon,  State),
<a name="33319"/>33319: 				   State3 = maps:remove(sock, State2),
<a name="33320"/>33320: 				   {ok, State3}
<a name="33321"/>33321: 			   after 1000 -&gt;
<a name="33322"/>33322: 				   ?SEV_EPRINT(&quot;socket down timeout&quot;),
<a name="33323"/>33323: 				   {error, timeout}
<a name="33324"/>33324: 			   end
<a name="33325"/>33325:                    end},
<a name="33326"/>33326: 
<a name="33327"/>33327:          #{desc =&gt; &quot;announce ready (down)&quot;,
<a name="33328"/>33328:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="33329"/>33329:                            ?SEV_ANNOUNCE_READY(Tester, down),
<a name="33330"/>33330:                            ok
<a name="33331"/>33331:                    end},
<a name="33332"/>33332: 
<a name="33333"/>33333: 
<a name="33334"/>33334:          #{desc =&gt; &quot;await terminate (from tester)&quot;,
<a name="33335"/>33335:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="33336"/>33336:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="33337"/>33337:                                ok -&gt;
<a name="33338"/>33338:                                    {ok, maps:remove(tester, State)};
<a name="33339"/>33339:                                {error, _} = ERROR -&gt;
<a name="33340"/>33340:                                    ERROR
<a name="33341"/>33341:                            end
<a name="33342"/>33342:                    end},
<a name="33343"/>33343: 
<a name="33344"/>33344:          %% *** We are done ***
<a name="33345"/>33345:          ?SEV_FINISH_NORMAL
<a name="33346"/>33346:         ],
<a name="33347"/>33347: 
<a name="33348"/>33348:     TesterSeq =
<a name="33349"/>33349:         [
<a name="33350"/>33350:          %% *** Init part ***
<a name="33351"/>33351:          #{desc =&gt; &quot;monitor 'owner'&quot;,
<a name="33352"/>33352:            cmd  =&gt; fun(#{owner := Owner} = _State) -&gt;
<a name="33353"/>33353:                            _MRef = erlang:monitor(process, Owner),
<a name="33354"/>33354:                            ok
<a name="33355"/>33355:                    end},
<a name="33356"/>33356:          #{desc =&gt; &quot;order (owner) start&quot;,
<a name="33357"/>33357:            cmd  =&gt; fun(#{owner := Pid} = _State) -&gt;
<a name="33358"/>33358:                            ?SEV_ANNOUNCE_START(Pid),
<a name="33359"/>33359:                            ok
<a name="33360"/>33360:                    end},
<a name="33361"/>33361:          #{desc =&gt; &quot;await (owner) ready&quot;,
<a name="33362"/>33362:            cmd  =&gt; fun(#{owner := Pid} = State) -&gt;
<a name="33363"/>33363:                            {ok, Sock} = ?SEV_AWAIT_READY(Pid, owner, init),
<a name="33364"/>33364:                            {ok, State#{sock =&gt; Sock}}
<a name="33365"/>33365:                    end},
<a name="33366"/>33366: 
<a name="33367"/>33367:          #{desc =&gt; &quot;monitor client&quot;,
<a name="33368"/>33368:            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;
<a name="33369"/>33369:                            _MRef = erlang:monitor(process, Pid),
<a name="33370"/>33370:                            ok
<a name="33371"/>33371:                    end},
<a name="33372"/>33372:          #{desc =&gt; &quot;order client start&quot;,
<a name="33373"/>33373:            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;
<a name="33374"/>33374:                            ?SEV_ANNOUNCE_START(Pid),
<a name="33375"/>33375:                            ok
<a name="33376"/>33376:                    end},
<a name="33377"/>33377:          #{desc =&gt; &quot;await client ready&quot;,
<a name="33378"/>33378:            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;
<a name="33379"/>33379:                            ok = ?SEV_AWAIT_READY(Pid, client, init)
<a name="33380"/>33380:                    end},
<a name="33381"/>33381:          #{desc =&gt; &quot;send socket to client&quot;,
<a name="33382"/>33382:            cmd  =&gt; fun(#{client := Pid,
<a name="33383"/>33383: 			 sock   := Sock} = _State) -&gt;
<a name="33384"/>33384:                            ?SEV_ANNOUNCE_CONTINUE(Pid, socket, Sock),
<a name="33385"/>33385:                            ok
<a name="33386"/>33386:                    end},
<a name="33387"/>33387: 
<a name="33388"/>33388:          %% The actual test
<a name="33389"/>33389:          %% There is no way we can actually know that the &quot;system&quot;
<a name="33390"/>33390:          %% does not create *any* sockets...
<a name="33391"/>33391:          #{desc =&gt; &quot;order client to monitor&quot;,
<a name="33392"/>33392:            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;
<a name="33393"/>33393:                            ?SEV_ANNOUNCE_CONTINUE(Pid, monitor),
<a name="33394"/>33394:                            ok
<a name="33395"/>33395:                    end},
<a name="33396"/>33396:          #{desc =&gt; &quot;await client ready&quot;,
<a name="33397"/>33397:            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;
<a name="33398"/>33398:                            ok = ?SEV_AWAIT_READY(Pid, client, monitor)
<a name="33399"/>33399:                    end},
<a name="33400"/>33400: 
<a name="33401"/>33401:          #{desc =&gt; &quot;order client to await down&quot;,
<a name="33402"/>33402:            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;
<a name="33403"/>33403:                            ?SEV_ANNOUNCE_CONTINUE(Pid, down),
<a name="33404"/>33404:                            ok
<a name="33405"/>33405:                    end},
<a name="33406"/>33406: 
<a name="33407"/>33407: 	 ?SEV_SLEEP(?SECS(1)),
<a name="33408"/>33408: 
<a name="33409"/>33409:          #{desc =&gt; &quot;order (owner) terminate&quot;,
<a name="33410"/>33410:            cmd  =&gt; fun(#{owner := Pid} = _State) -&gt;
<a name="33411"/>33411:                            ?SEV_ANNOUNCE_TERMINATE(Pid),
<a name="33412"/>33412:                            ok
<a name="33413"/>33413:                    end},
<a name="33414"/>33414:          #{desc =&gt; &quot;await (owner) termination&quot;,
<a name="33415"/>33415:            cmd  =&gt; fun(#{owner := Pid} = State) -&gt;
<a name="33416"/>33416:                            case ?SEV_AWAIT_TERMINATION(Pid) of
<a name="33417"/>33417:                                ok -&gt;
<a name="33418"/>33418:                                    {ok, maps:remove(owner, State)};
<a name="33419"/>33419:                                {error, _} = ERROR -&gt;
<a name="33420"/>33420:                                    ERROR
<a name="33421"/>33421:                            end
<a name="33422"/>33422:                    end},
<a name="33423"/>33423: 
<a name="33424"/>33424:          #{desc =&gt; &quot;await client ready&quot;,
<a name="33425"/>33425:            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;
<a name="33426"/>33426:                            ok = ?SEV_AWAIT_READY(Pid, client, down)
<a name="33427"/>33427:                    end},
<a name="33428"/>33428: 
<a name="33429"/>33429: 	 #{desc =&gt; &quot;verify total number of monitors (=0)&quot;,
<a name="33430"/>33430:            cmd  =&gt; fun(_State) -&gt;
<a name="33431"/>33431: 			   0 = socket:number_of_monitors(),
<a name="33432"/>33432: 			   ok
<a name="33433"/>33433:                    end},
<a name="33434"/>33434: 
<a name="33435"/>33435: 	 ?SEV_SLEEP(?SECS(1)),
<a name="33436"/>33436: 
<a name="33437"/>33437:          %% Cleanup
<a name="33438"/>33438:          #{desc =&gt; &quot;order client terminate&quot;,
<a name="33439"/>33439:            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;
<a name="33440"/>33440:                            ?SEV_ANNOUNCE_TERMINATE(Pid),
<a name="33441"/>33441:                            ok
<a name="33442"/>33442:                    end},
<a name="33443"/>33443:          #{desc =&gt; &quot;await client termination&quot;,
<a name="33444"/>33444:            cmd  =&gt; fun(#{client := Pid} = State) -&gt;
<a name="33445"/>33445:                            case ?SEV_AWAIT_TERMINATION(Pid) of
<a name="33446"/>33446:                                ok -&gt;
<a name="33447"/>33447:                                    {ok, maps:remove(client, State)};
<a name="33448"/>33448:                                {error, _} = ERROR -&gt;
<a name="33449"/>33449:                                    ERROR
<a name="33450"/>33450:                            end
<a name="33451"/>33451:                    end},
<a name="33452"/>33452: 
<a name="33453"/>33453:          %% *** We are done ***
<a name="33454"/>33454:          ?SEV_FINISH_NORMAL
<a name="33455"/>33455:         ],
<a name="33456"/>33456: 
<a name="33457"/>33457:     i(&quot;start (socket) owner evaluator&quot;),
<a name="33458"/>33458:     Owner = ?SEV_START(&quot;owner&quot;, OwnerSeq, InitState),
<a name="33459"/>33459: 
<a name="33460"/>33460:     i(&quot;start client  evaluator&quot;),
<a name="33461"/>33461:     Client = ?SEV_START(&quot;client&quot;, ClientSeq, InitState),
<a name="33462"/>33462: 
<a name="33463"/>33463:     i(&quot;start tester evaluator&quot;),
<a name="33464"/>33464:     TesterInitState = #{owner  =&gt; Owner#ev.pid,
<a name="33465"/>33465: 			client =&gt; Client#ev.pid},
<a name="33466"/>33466:     Tester = ?SEV_START(&quot;tester&quot;, TesterSeq, TesterInitState),
<a name="33467"/>33467: 
<a name="33468"/>33468:     i(&quot;await evaluator&quot;),
<a name="mon_closed_socket-last_expr"/><a name="33469"/>33469: <b>    ok = ?SEV_AWAIT_FINISH</b>([Owner, Client, Tester]).
<a name="33470"/>33470: 
<a name="33471"/>33471: 
<a name="33472"/>33472: 
<a name="33473"/>33473: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="33474"/>33474: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="33475"/>33475: <i>%%                                                                     %%</i>
<a name="33476"/>33476: <i>%%                         SOCKET CLOSURE                              %%</i>
<a name="33477"/>33477: <i>%%                                                                     %%</i>
<a name="33478"/>33478: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="33479"/>33479: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="33480"/>33480: 
<a name="33481"/>33481: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="33482"/>33482: <i>%% This test case is intended to test that the sockets are cleaned up</i>
<a name="33483"/>33483: <i>%% (&quot;removed&quot;) when the controlling process terminates (without explicitly </i>
<a name="33484"/>33484: <i>%% calling the close function). For a IPv4 TCP (stream) socket.</i>
<a name="33485"/>33485: 
<a name="sc_cpe_socket_cleanup_tcp4-1"/><a name="33486"/>33486: <b>sc_cpe_socket_cleanup_tcp4</b>(_Config) when is_list(_Config) -&gt;
<a name="33487"/>33487:     ?TT(?SECS(30)),
<a name="sc_cpe_socket_cleanup_tcp4-last_expr"/><a name="33488"/>33488: <b>    tc_try</b>(sc_cpe_socket_cleanup_tcp4,
<a name="33489"/>33489:            fun() -&gt;
<a name="33490"/>33490:                    InitState = #{domain   =&gt; inet,
<a name="33491"/>33491:                                  type     =&gt; stream,
<a name="33492"/>33492:                                  protocol =&gt; tcp},
<a name="33493"/>33493:                    ok = sc_cpe_socket_cleanup(InitState)
<a name="33494"/>33494:            end).
<a name="33495"/>33495: 
<a name="33496"/>33496: 
<a name="33497"/>33497: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="33498"/>33498: <i>%% This test case is intended to test that the sockets are cleaned up</i>
<a name="33499"/>33499: <i>%% (&quot;removed&quot;) when the controlling process terminates (without explicitly </i>
<a name="33500"/>33500: <i>%% calling the close function). For a IPv6 TCP (stream) socket.</i>
<a name="33501"/>33501: 
<a name="sc_cpe_socket_cleanup_tcp6-1"/><a name="33502"/>33502: <b>sc_cpe_socket_cleanup_tcp6</b>(_Config) when is_list(_Config) -&gt;
<a name="33503"/>33503:     ?TT(?SECS(30)),
<a name="sc_cpe_socket_cleanup_tcp6-last_expr"/><a name="33504"/>33504: <b>    tc_try</b>(sc_cpe_socket_cleanup_tcp6,
<a name="33505"/>33505:            fun() -&gt; has_support_ipv6() end,
<a name="33506"/>33506:            fun() -&gt;
<a name="33507"/>33507:                    InitState = #{domain   =&gt; inet6,
<a name="33508"/>33508:                                  type     =&gt; stream,
<a name="33509"/>33509:                                  protocol =&gt; tcp},
<a name="33510"/>33510:                    ok = sc_cpe_socket_cleanup(InitState)
<a name="33511"/>33511:            end).
<a name="33512"/>33512: 
<a name="33513"/>33513: 
<a name="33514"/>33514: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="33515"/>33515: <i>%% This test case is intended to test that the sockets are cleaned up</i>
<a name="33516"/>33516: <i>%% (&quot;removed&quot;) when the controlling process terminates (without explicitly </i>
<a name="33517"/>33517: <i>%% calling the close function). For a Unix Domain (stream) socket (TCP).</i>
<a name="33518"/>33518: 
<a name="sc_cpe_socket_cleanup_tcpL-1"/><a name="33519"/>33519: <b>sc_cpe_socket_cleanup_tcpL</b>(_Config) when is_list(_Config) -&gt;
<a name="33520"/>33520:     ?TT(?SECS(30)),
<a name="sc_cpe_socket_cleanup_tcpL-last_expr"/><a name="33521"/>33521: <b>    tc_try</b>(sc_cpe_socket_cleanup_tcpL,
<a name="33522"/>33522:            fun() -&gt; has_support_unix_domain_socket() end,
<a name="33523"/>33523:            fun() -&gt;
<a name="33524"/>33524:                    InitState = #{domain   =&gt; local,
<a name="33525"/>33525:                                  type     =&gt; stream,
<a name="33526"/>33526:                                  protocol =&gt; default},
<a name="33527"/>33527:                    ok = sc_cpe_socket_cleanup(InitState)
<a name="33528"/>33528:            end).
<a name="33529"/>33529: 
<a name="33530"/>33530: 
<a name="33531"/>33531: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="33532"/>33532: <i>%% This test case is intended to test that the sockets are cleaned up</i>
<a name="33533"/>33533: <i>%% (&quot;removed&quot;) when the controlling process terminates (without explicitly </i>
<a name="33534"/>33534: <i>%% calling the close function). For a IPv4 UDP (dgram) socket.</i>
<a name="33535"/>33535: 
<a name="sc_cpe_socket_cleanup_udp4-1"/><a name="33536"/>33536: <b>sc_cpe_socket_cleanup_udp4</b>(_Config) when is_list(_Config) -&gt;
<a name="33537"/>33537:     ?TT(?SECS(30)),
<a name="sc_cpe_socket_cleanup_udp4-last_expr"/><a name="33538"/>33538: <b>    tc_try</b>(sc_cpe_socket_cleanup_udp4,
<a name="33539"/>33539:            fun() -&gt; has_support_ipv4() end,
<a name="33540"/>33540:            fun() -&gt;
<a name="33541"/>33541:                    InitState = #{domain   =&gt; inet,
<a name="33542"/>33542:                                  type     =&gt; dgram,
<a name="33543"/>33543:                                  protocol =&gt; udp},
<a name="33544"/>33544:                    ok = sc_cpe_socket_cleanup(InitState)
<a name="33545"/>33545:            end).
<a name="33546"/>33546: 
<a name="33547"/>33547: 
<a name="33548"/>33548: 
<a name="33549"/>33549: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="33550"/>33550: <i>%% This test case is intended to test that the sockets are cleaned up</i>
<a name="33551"/>33551: <i>%% (removed) when the controlling process terminates (without explicitly </i>
<a name="33552"/>33552: <i>%% calling the close function). For a IPv6 UDP (dgram) socket.</i>
<a name="33553"/>33553: 
<a name="sc_cpe_socket_cleanup_udp6-1"/><a name="33554"/>33554: <b>sc_cpe_socket_cleanup_udp6</b>(_Config) when is_list(_Config) -&gt;
<a name="33555"/>33555:     ?TT(?SECS(30)),
<a name="sc_cpe_socket_cleanup_udp6-last_expr"/><a name="33556"/>33556: <b>    tc_try</b>(sc_cpe_socket_cleanup_udp6,
<a name="33557"/>33557:            fun() -&gt; has_support_ipv6() end,
<a name="33558"/>33558:            fun() -&gt;
<a name="33559"/>33559:                    InitState = #{domain   =&gt; inet6,
<a name="33560"/>33560:                                  type     =&gt; dgram,
<a name="33561"/>33561:                                  protocol =&gt; udp},
<a name="33562"/>33562:                    ok = sc_cpe_socket_cleanup(InitState)
<a name="33563"/>33563:            end).
<a name="33564"/>33564: 
<a name="33565"/>33565: 
<a name="33566"/>33566: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="33567"/>33567: <i>%% This test case is intended to test that the sockets are cleaned up</i>
<a name="33568"/>33568: <i>%% (&quot;removed&quot;) when the controlling process terminates (without explicitly </i>
<a name="33569"/>33569: <i>%% calling the close function). For a Unix Domain (dgram) socket (UDP).</i>
<a name="33570"/>33570: 
<a name="sc_cpe_socket_cleanup_udpL-1"/><a name="33571"/>33571: <b>sc_cpe_socket_cleanup_udpL</b>(_Config) when is_list(_Config) -&gt;
<a name="33572"/>33572:     ?TT(?SECS(30)),
<a name="sc_cpe_socket_cleanup_udpL-last_expr"/><a name="33573"/>33573: <b>    tc_try</b>(sc_cpe_socket_cleanup_udpL,
<a name="33574"/>33574:            fun() -&gt;
<a name="33575"/>33575: 		   has_support_unix_domain_socket(),
<a name="33576"/>33576: 		   is_not_windows()
<a name="33577"/>33577: 	   end,
<a name="33578"/>33578:            fun() -&gt;
<a name="33579"/>33579:                    InitState = #{domain   =&gt; local,
<a name="33580"/>33580:                                  type     =&gt; dgram,
<a name="33581"/>33581:                                  protocol =&gt; default},
<a name="33582"/>33582:                    ok = sc_cpe_socket_cleanup(InitState)
<a name="33583"/>33583:            end).
<a name="33584"/>33584: 
<a name="33585"/>33585: 
<a name="33586"/>33586: 
<a name="33587"/>33587: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="33588"/>33588: 
<a name="sc_cpe_socket_cleanup-1"/><a name="33589"/>33589: <b>sc_cpe_socket_cleanup</b>(InitState) -&gt;
<a name="33590"/>33590:     OwnerSeq =
<a name="33591"/>33591:         [
<a name="33592"/>33592:          %% *** Wait for start order part ***
<a name="33593"/>33593:          #{desc =&gt; &quot;await start (from tester)&quot;,
<a name="33594"/>33594:            cmd  =&gt; fun(State) -&gt;
<a name="33595"/>33595:                            Tester = ?SEV_AWAIT_START(),
<a name="33596"/>33596:                            {ok, State#{tester =&gt; Tester}}
<a name="33597"/>33597:                    end},
<a name="33598"/>33598:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="33599"/>33599:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="33600"/>33600:                            _MRef = erlang:monitor(process, Tester),
<a name="33601"/>33601:                            ok
<a name="33602"/>33602:                    end},
<a name="33603"/>33603: 
<a name="33604"/>33604:          %% *** Init part ***
<a name="33605"/>33605:          #{desc =&gt; &quot;create socket&quot;,
<a name="33606"/>33606:            cmd  =&gt; fun(#{domain   := Domain, 
<a name="33607"/>33607:                          type     := Type, 
<a name="33608"/>33608:                          protocol := Proto} = State) -&gt;
<a name="33609"/>33609:                            case socket:open(Domain, Type, Proto) of
<a name="33610"/>33610:                                {ok, Sock} -&gt;
<a name="33611"/>33611:                                    {ok, State#{sock =&gt; Sock}};
<a name="33612"/>33612:                                {error, _} = ERROR -&gt;
<a name="33613"/>33613:                                    ERROR
<a name="33614"/>33614:                            end
<a name="33615"/>33615:                    end},
<a name="33616"/>33616:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="33617"/>33617:            cmd  =&gt; fun(#{tester := Tester, sock := Sock} = _State) -&gt;
<a name="33618"/>33618:                            ?SEV_ANNOUNCE_READY(Tester, init, Sock),
<a name="33619"/>33619:                            ok
<a name="33620"/>33620:                    end},
<a name="33621"/>33621: 
<a name="33622"/>33622:          %% *** The actual test ***
<a name="33623"/>33623:          %% We *intentionally* leave the socket &quot;as is&quot;, no explicit close
<a name="33624"/>33624:          #{desc =&gt; &quot;await terminate (from tester)&quot;,
<a name="33625"/>33625:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="33626"/>33626:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="33627"/>33627:                                ok -&gt;
<a name="33628"/>33628:                                    {ok, maps:remove(tester, State)};
<a name="33629"/>33629:                                {error, _} = ERROR -&gt;
<a name="33630"/>33630:                                    ERROR
<a name="33631"/>33631:                            end
<a name="33632"/>33632:                    end},
<a name="33633"/>33633: 
<a name="33634"/>33634:          %% *** We are done ***
<a name="33635"/>33635:          ?SEV_FINISH_NORMAL
<a name="33636"/>33636:         ],
<a name="33637"/>33637: 
<a name="33638"/>33638:     TesterSeq =
<a name="33639"/>33639:         [
<a name="33640"/>33640:          %% *** Init part ***
<a name="33641"/>33641:          #{desc =&gt; &quot;monitor owner&quot;,
<a name="33642"/>33642:            cmd  =&gt; fun(#{owner := Owner} = _State) -&gt;
<a name="33643"/>33643:                            _MRef = erlang:monitor(process, Owner),
<a name="33644"/>33644:                            ok
<a name="33645"/>33645:                    end},
<a name="33646"/>33646:          #{desc =&gt; &quot;order (owner) start&quot;,
<a name="33647"/>33647:            cmd  =&gt; fun(#{owner := Pid} = _State) -&gt;
<a name="33648"/>33648:                            ?SEV_ANNOUNCE_START(Pid),
<a name="33649"/>33649:                            ok
<a name="33650"/>33650:                    end},
<a name="33651"/>33651:          #{desc =&gt; &quot;await (owner) ready&quot;,
<a name="33652"/>33652:            cmd  =&gt; fun(#{owner := Pid} = State) -&gt;
<a name="33653"/>33653:                            {ok, Sock} = ?SEV_AWAIT_READY(Pid, owner, init),
<a name="33654"/>33654:                            {ok, State#{sock =&gt; Sock}}
<a name="33655"/>33655:                    end},
<a name="33656"/>33656:          #{desc =&gt; &quot;verify owner as controlling-process&quot;,
<a name="33657"/>33657:            cmd  =&gt; fun(#{owner := Pid, sock := Sock} = _State) -&gt;
<a name="33658"/>33658:                            case socket:getopt(Sock, otp, controlling_process) of
<a name="33659"/>33659:                                {ok, Pid} -&gt;
<a name="33660"/>33660:                                    ok;
<a name="33661"/>33661:                                {ok, Other} -&gt;
<a name="33662"/>33662:                                    {error, {unexpected_owner, Other}};
<a name="33663"/>33663:                                {error, _} = ERROR -&gt;
<a name="33664"/>33664:                                    ERROR
<a name="33665"/>33665:                            end
<a name="33666"/>33666:                    end},
<a name="33667"/>33667:          #{desc =&gt; &quot;order (owner) terminate&quot;,
<a name="33668"/>33668:            cmd  =&gt; fun(#{owner := Pid} = _State) -&gt;
<a name="33669"/>33669:                            ?SEV_ANNOUNCE_TERMINATE(Pid),
<a name="33670"/>33670:                            ok
<a name="33671"/>33671:                    end},
<a name="33672"/>33672:          #{desc =&gt; &quot;await (owner) termination&quot;,
<a name="33673"/>33673:            cmd  =&gt; fun(#{owner := Pid} = _State) -&gt;
<a name="33674"/>33674:                            case ?SEV_AWAIT_TERMINATION(Pid) of
<a name="33675"/>33675:                                ok -&gt;
<a name="33676"/>33676:                                    ok;
<a name="33677"/>33677:                                {error, _} = ERROR -&gt;
<a name="33678"/>33678:                                    ERROR
<a name="33679"/>33679:                            end
<a name="33680"/>33680:                    end},
<a name="33681"/>33681: 
<a name="33682"/>33682:          ?SEV_SLEEP(?SECS(5)),
<a name="33683"/>33683: 
<a name="33684"/>33684:          %% The reason we get closed, is that as long as there is a ref to 
<a name="33685"/>33685:          %% the resource (socket), then it will not be garbage collected.
<a name="33686"/>33686:          %% Note that its still a race that the nif has processed that the
<a name="33687"/>33687:          %% &quot;controlling process&quot; has terminated. There really is no 
<a name="33688"/>33688:          %% proper timeout for this, but the 5 seconds &quot;should&quot; be enough...
<a name="33689"/>33689:          %% We should really have some way to subscribe to socket events...
<a name="33690"/>33690:          #{desc =&gt; &quot;verify no socket (closed)&quot;,
<a name="33691"/>33691:            cmd  =&gt; fun(#{owner := Pid, sock := Sock} = _State) -&gt;
<a name="33692"/>33692:                            case socket:getopt(Sock, otp, controlling_process) of
<a name="33693"/>33693:                                {ok, OtherPid} -&gt;
<a name="33694"/>33694:                                    {error, {unexpected_success, Pid, OtherPid}};
<a name="33695"/>33695:                                {error, closed} -&gt;
<a name="33696"/>33696:                                    ok;
<a name="33697"/>33697:                                {error, Reason} -&gt;
<a name="33698"/>33698:                                    ?SEV_IPRINT(&quot;expected failure: ~p&quot;, [Reason]),
<a name="33699"/>33699:                                    {error, {unexpected_failure, Reason}}
<a name="33700"/>33700:                            end
<a name="33701"/>33701:                    end},
<a name="33702"/>33702: 
<a name="33703"/>33703:          %% *** We are done ***
<a name="33704"/>33704:          ?SEV_FINISH_NORMAL
<a name="33705"/>33705:         ],
<a name="33706"/>33706: 
<a name="33707"/>33707:     i(&quot;start (socket) owner evaluator&quot;),
<a name="33708"/>33708:     Owner = ?SEV_START(&quot;owner&quot;, OwnerSeq, InitState),
<a name="33709"/>33709: 
<a name="33710"/>33710:     i(&quot;start tester evaluator&quot;),
<a name="33711"/>33711:     TesterInitState = #{owner =&gt; Owner#ev.pid},
<a name="33712"/>33712:     Tester = ?SEV_START(&quot;tester&quot;, TesterSeq, TesterInitState),
<a name="33713"/>33713: 
<a name="33714"/>33714:     i(&quot;await evaluator&quot;),
<a name="sc_cpe_socket_cleanup-last_expr"/><a name="33715"/>33715: <b>    ok = ?SEV_AWAIT_FINISH</b>([Owner, Tester]).
<a name="33716"/>33716: 
<a name="33717"/>33717: 
<a name="33718"/>33718: 
<a name="33719"/>33719: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="33720"/>33720: <i>%% This test case is intended to test what happens when a socket is </i>
<a name="33721"/>33721: <i>%% locally closed while a process is calling the recv function.</i>
<a name="33722"/>33722: <i>%% Socket is IPv4.</i>
<a name="33723"/>33723: <i>%% </i>
<a name="33724"/>33724: <i>%% &lt;KOLLA&gt;</i>
<a name="33725"/>33725: <i>%% </i>
<a name="33726"/>33726: <i>%% We should really have a similar test cases for when the controlling</i>
<a name="33727"/>33727: <i>%% process exits and there are other processes in recv, accept, and </i>
<a name="33728"/>33728: <i>%% all the other functions.</i>
<a name="33729"/>33729: <i>%% </i>
<a name="33730"/>33730: <i>%% &lt;/KOLLA&gt;</i>
<a name="33731"/>33731: 
<a name="sc_lc_recv_response_tcp4-1"/><a name="33732"/>33732: <b>sc_lc_recv_response_tcp4</b>(_Config) when is_list(_Config) -&gt;
<a name="33733"/>33733:     ?TT(?SECS(10)),
<a name="sc_lc_recv_response_tcp4-last_expr"/><a name="33734"/>33734: <b>    tc_try</b>(sc_lc_recv_response_tcp4,
<a name="33735"/>33735:            fun() -&gt; has_support_ipv4() end,
<a name="33736"/>33736:            fun() -&gt;
<a name="33737"/>33737:                    Recv      = fun(Sock) -&gt; socket:recv(Sock) end,
<a name="33738"/>33738:                    InitState = #{domain   =&gt; inet,
<a name="33739"/>33739:                                  protocol =&gt; tcp,
<a name="33740"/>33740:                                  recv     =&gt; Recv},
<a name="33741"/>33741:                    ok = sc_lc_receive_response_tcp(InitState)
<a name="33742"/>33742:            end).
<a name="33743"/>33743: 
<a name="33744"/>33744: 
<a name="33745"/>33745: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="33746"/>33746: <i>%% This test case is intended to test what happens when a socket is </i>
<a name="33747"/>33747: <i>%% locally closed while the process is calling the recv function.</i>
<a name="33748"/>33748: <i>%% Socket is IPv6.</i>
<a name="33749"/>33749: 
<a name="sc_lc_recv_response_tcp6-1"/><a name="33750"/>33750: <b>sc_lc_recv_response_tcp6</b>(_Config) when is_list(_Config) -&gt;
<a name="33751"/>33751:     ?TT(?SECS(10)),
<a name="sc_lc_recv_response_tcp6-last_expr"/><a name="33752"/>33752: <b>    tc_try</b>(sc_lc_recv_response_tcp6,
<a name="33753"/>33753:            fun() -&gt; has_support_ipv6() end,
<a name="33754"/>33754:            fun() -&gt;
<a name="33755"/>33755:                    Recv      = fun(Sock) -&gt; socket:recv(Sock) end,
<a name="33756"/>33756:                    InitState = #{domain   =&gt; inet6,
<a name="33757"/>33757:                                  protocol =&gt; tcp,
<a name="33758"/>33758:                                  recv     =&gt; Recv},
<a name="33759"/>33759:                    ok = sc_lc_receive_response_tcp(InitState)
<a name="33760"/>33760:            end).
<a name="33761"/>33761: 
<a name="33762"/>33762: 
<a name="33763"/>33763: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="33764"/>33764: <i>%% This test case is intended to test what happens when a socket is </i>
<a name="33765"/>33765: <i>%% locally closed while the process is calling the recv function.</i>
<a name="33766"/>33766: <i>%% Socket is Unix Domain (stream) socket.</i>
<a name="33767"/>33767: 
<a name="sc_lc_recv_response_tcpL-1"/><a name="33768"/>33768: <b>sc_lc_recv_response_tcpL</b>(_Config) when is_list(_Config) -&gt;
<a name="33769"/>33769:     ?TT(?SECS(10)),
<a name="sc_lc_recv_response_tcpL-last_expr"/><a name="33770"/>33770: <b>    tc_try</b>(sc_lc_recv_response_tcpL,
<a name="33771"/>33771:            fun() -&gt;
<a name="33772"/>33772: 		   has_support_unix_domain_socket()
<a name="33773"/>33773: 	   end,
<a name="33774"/>33774:            fun() -&gt;
<a name="33775"/>33775:                    Recv      = fun(Sock) -&gt; socket:recv(Sock) end,
<a name="33776"/>33776:                    InitState = #{domain   =&gt; local,
<a name="33777"/>33777:                                  protocol =&gt; default,
<a name="33778"/>33778:                                  recv     =&gt; Recv},
<a name="33779"/>33779:                    ok = sc_lc_receive_response_tcp(InitState)
<a name="33780"/>33780:            end).
<a name="33781"/>33781: 
<a name="33782"/>33782: 
<a name="33783"/>33783: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="33784"/>33784: 
<a name="sc_lc_receive_response_tcp-1"/><a name="33785"/>33785: <b>sc_lc_receive_response_tcp</b>(InitState) -&gt;
<a name="33786"/>33786:     %% This (acceptor) is the server that accepts connections.
<a name="33787"/>33787:     %% But it is also suppose to close the connection socket, 
<a name="33788"/>33788:     %% and trigger the read failure (=closed) for the handler process.
<a name="33789"/>33789:     AcceptorSeq =
<a name="33790"/>33790:         [
<a name="33791"/>33791:          %% *** Wait for start order part ***
<a name="33792"/>33792:          #{desc =&gt; &quot;await start (from tester)&quot;,
<a name="33793"/>33793:            cmd  =&gt; fun(State) -&gt;
<a name="33794"/>33794:                            Tester = ?SEV_AWAIT_START(),
<a name="33795"/>33795:                            {ok, State#{tester =&gt; Tester}}
<a name="33796"/>33796:                    end},
<a name="33797"/>33797:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="33798"/>33798:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="33799"/>33799:                            _MRef = erlang:monitor(process, Tester),
<a name="33800"/>33800:                            ok
<a name="33801"/>33801:                    end},
<a name="33802"/>33802: 
<a name="33803"/>33803:          %% *** Init part ***
<a name="33804"/>33804:          #{desc =&gt; &quot;which local address&quot;,
<a name="33805"/>33805:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="33806"/>33806:                            LSA = which_local_socket_addr(Domain),
<a name="33807"/>33807:                            {ok, State#{lsa =&gt; LSA}}
<a name="33808"/>33808:                    end},
<a name="33809"/>33809:          #{desc =&gt; &quot;create (listen) socket&quot;,
<a name="33810"/>33810:            cmd  =&gt; fun(#{domain   := Domain, 
<a name="33811"/>33811:                          protocol := Proto} = State) -&gt;
<a name="33812"/>33812:                            case socket:open(Domain, stream, Proto) of
<a name="33813"/>33813:                                {ok, Sock} -&gt;
<a name="33814"/>33814:                                    {ok, State#{lsock =&gt; Sock}};
<a name="33815"/>33815:                                {error, _} = ERROR -&gt;
<a name="33816"/>33816:                                    ERROR
<a name="33817"/>33817:                            end
<a name="33818"/>33818:                    end},
<a name="33819"/>33819:          #{desc =&gt; &quot;bind to local address&quot;,
<a name="33820"/>33820:            cmd  =&gt; fun(#{domain := local,
<a name="33821"/>33821:                          lsock  := LSock,
<a name="33822"/>33822:                          lsa    := LSA} = _State) -&gt;
<a name="33823"/>33823:                            ?SEV_IPRINT(&quot;bind to LSA: &quot;
<a name="33824"/>33824:                                        &quot;~n   ~p&quot;, [LSA]),
<a name="33825"/>33825:                            case socket:bind(LSock, LSA) of
<a name="33826"/>33826:                                ok -&gt;
<a name="33827"/>33827:                                    ok; % We do not care about the port for local
<a name="33828"/>33828:                                {error, _} = ERROR -&gt;
<a name="33829"/>33829:                                    ERROR
<a name="33830"/>33830:                            end;
<a name="33831"/>33831:                       (#{lsock := LSock,
<a name="33832"/>33832:                          lsa   := LSA} = State) -&gt;
<a name="33833"/>33833:                            case sock_bind(LSock, LSA) of
<a name="33834"/>33834:                                ok -&gt;
<a name="33835"/>33835:                                    Port = sock_port(LSock),
<a name="33836"/>33836:                                    ?SEV_IPRINT(&quot;bound to port: ~w&quot;, [Port]),
<a name="33837"/>33837:                                    {ok, State#{lport =&gt; Port}};
<a name="33838"/>33838:                                {error, _} = ERROR -&gt;
<a name="33839"/>33839:                                    ERROR
<a name="33840"/>33840:                            end
<a name="33841"/>33841:                    end},
<a name="33842"/>33842:          #{desc =&gt; &quot;make listen socket&quot;,
<a name="33843"/>33843:            cmd  =&gt; fun(#{lsock := LSock}) -&gt;
<a name="33844"/>33844:                            socket:listen(LSock)
<a name="33845"/>33845:                    end},
<a name="33846"/>33846:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="33847"/>33847:            cmd  =&gt; fun(#{domain := local,
<a name="33848"/>33848:                          tester := Tester,
<a name="33849"/>33849:                          lsa    := #{path := Path}}) -&gt;
<a name="33850"/>33850:                            ?SEV_ANNOUNCE_READY(Tester, init, Path),
<a name="33851"/>33851:                            ok;
<a name="33852"/>33852:                       (#{tester := Tester, lport := Port}) -&gt;
<a name="33853"/>33853:                            ?SEV_ANNOUNCE_READY(Tester, init, Port),
<a name="33854"/>33854:                            ok
<a name="33855"/>33855:                    end},
<a name="33856"/>33856:                            
<a name="33857"/>33857:          %% The actual test
<a name="33858"/>33858:          #{desc =&gt; &quot;await continue (accept)&quot;,
<a name="33859"/>33859:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="33860"/>33860:                            case ?SEV_AWAIT_CONTINUE(Tester, tester, accept) of
<a name="33861"/>33861:                                {ok, {H1, H2, H3}} -&gt;
<a name="33862"/>33862:                                    {ok, State#{handler1 =&gt; H1,
<a name="33863"/>33863:                                                handler2 =&gt; H2,
<a name="33864"/>33864:                                                handler3 =&gt; H3}};
<a name="33865"/>33865:                                {error, _} = ERROR -&gt;
<a name="33866"/>33866:                                    ERROR
<a name="33867"/>33867:                            end
<a name="33868"/>33868:                    end},
<a name="33869"/>33869:          #{desc =&gt; &quot;await accept&quot;,
<a name="33870"/>33870:            cmd  =&gt; fun(#{lsock := LSock} = State) -&gt;
<a name="33871"/>33871:                            case socket:accept(LSock) of
<a name="33872"/>33872:                                {ok, Sock} -&gt;
<a name="33873"/>33873:                                    ?SEV_IPRINT(&quot;connection accepted: &quot;
<a name="33874"/>33874:                                                &quot;~n   ~p&quot;, [socket:sockname(Sock)]),
<a name="33875"/>33875:                                    {ok, State#{csock =&gt; Sock}};
<a name="33876"/>33876:                                {error, _} = ERROR -&gt;
<a name="33877"/>33877:                                    ERROR
<a name="33878"/>33878:                            end
<a name="33879"/>33879:                    end},
<a name="33880"/>33880:          #{desc =&gt; &quot;announce ready (accept)&quot;,
<a name="33881"/>33881:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="33882"/>33882:                            ?SEV_ANNOUNCE_READY(Tester, accept),
<a name="33883"/>33883:                            ok
<a name="33884"/>33884:                    end},
<a name="33885"/>33885:          #{desc =&gt; &quot;transfer connection to handler 1&quot;,
<a name="33886"/>33886:            cmd  =&gt; fun(#{handler1 := Handler, csock := Sock}) -&gt;
<a name="33887"/>33887:                            ?SEV_ANNOUNCE_CONTINUE(Handler, transfer, Sock),
<a name="33888"/>33888:                            ok
<a name="33889"/>33889:                    end},
<a name="33890"/>33890:          #{desc =&gt; &quot;transfer connection to handler 2&quot;,
<a name="33891"/>33891:            cmd  =&gt; fun(#{handler2 := Handler, csock := Sock}) -&gt;
<a name="33892"/>33892:                            ?SEV_ANNOUNCE_CONTINUE(Handler, transfer, Sock),
<a name="33893"/>33893:                            ok
<a name="33894"/>33894:                    end},
<a name="33895"/>33895:          #{desc =&gt; &quot;transfer connection to handler 3&quot;,
<a name="33896"/>33896:            cmd  =&gt; fun(#{handler3 := Handler, csock := Sock}) -&gt;
<a name="33897"/>33897:                            ?SEV_ANNOUNCE_CONTINUE(Handler, transfer, Sock),
<a name="33898"/>33898:                            ok
<a name="33899"/>33899:                    end},
<a name="33900"/>33900:          #{desc =&gt; &quot;await continue (close)&quot;,
<a name="33901"/>33901:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="33902"/>33902:                            ?SEV_AWAIT_CONTINUE(Tester, tester, close),
<a name="33903"/>33903:                            ok
<a name="33904"/>33904:                    end},
<a name="33905"/>33905:          #{desc =&gt; &quot;close connection socket&quot;,
<a name="33906"/>33906:            cmd  =&gt; fun(#{csock := Sock} = State) -&gt;
<a name="33907"/>33907:                            case socket:close(Sock) of
<a name="33908"/>33908:                                ok -&gt;
<a name="33909"/>33909:                                    {ok, maps:remove(csock, State)};
<a name="33910"/>33910:                                {error, _} = ERROR -&gt;
<a name="33911"/>33911:                                    ERROR
<a name="33912"/>33912:                            end
<a name="33913"/>33913:                    end},
<a name="33914"/>33914:          #{desc =&gt; &quot;announce ready (close)&quot;,
<a name="33915"/>33915:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="33916"/>33916:                            ?SEV_ANNOUNCE_READY(Tester, close),
<a name="33917"/>33917:                            ok
<a name="33918"/>33918:                    end},
<a name="33919"/>33919: 
<a name="33920"/>33920:          %% *** Terminate ***
<a name="33921"/>33921:          #{desc =&gt; &quot;await terminate&quot;,
<a name="33922"/>33922:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="33923"/>33923:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="33924"/>33924:                                ok -&gt;
<a name="33925"/>33925:                                    {ok, maps:remove(tester, State)};
<a name="33926"/>33926:                                {error, _} = ERROR -&gt;
<a name="33927"/>33927:                                    ERROR
<a name="33928"/>33928:                            end
<a name="33929"/>33929:                    end},
<a name="33930"/>33930:          #{desc =&gt; &quot;close listen socket&quot;,
<a name="33931"/>33931:            cmd  =&gt; fun(#{domain := local,
<a name="33932"/>33932:                          lsock  := Sock,
<a name="33933"/>33933:                          lsa    := #{path := Path}} = State) -&gt;
<a name="33934"/>33934:                            ok = socket:close(Sock),
<a name="33935"/>33935:                            State1 =
<a name="33936"/>33936:                                unlink_path(Path,
<a name="33937"/>33937:                                            fun() -&gt;maps:remove(lsa, State) end,
<a name="33938"/>33938:                                            fun() -&gt; State end),
<a name="33939"/>33939:                            State2 = maps:remove(lsock, State1),
<a name="33940"/>33940:                            State3 = maps:remove(lport, State2),
<a name="33941"/>33941:                            {ok, State3};
<a name="33942"/>33942:                       (#{lsock := Sock} = State) -&gt;
<a name="33943"/>33943:                            case socket:close(Sock) of
<a name="33944"/>33944:                                ok -&gt;
<a name="33945"/>33945:                                    State1 = maps:remove(lsock, State),
<a name="33946"/>33946:                                    State2 = maps:remove(lport, State1),
<a name="33947"/>33947:                                    {ok, State2};
<a name="33948"/>33948:                                {error, _} = ERROR -&gt;
<a name="33949"/>33949:                                    ERROR
<a name="33950"/>33950:                            end
<a name="33951"/>33951:                    end},
<a name="33952"/>33952: 
<a name="33953"/>33953:          %% *** We are done ***
<a name="33954"/>33954:          ?SEV_FINISH_NORMAL
<a name="33955"/>33955:         ],
<a name="33956"/>33956: 
<a name="33957"/>33957:     %% The point of this is to perform the recv for which
<a name="33958"/>33958:     %% we are testing the response.
<a name="33959"/>33959:     HandlerSeq =
<a name="33960"/>33960:         [
<a name="33961"/>33961:          %% *** Wait for start order part ***
<a name="33962"/>33962:          #{desc =&gt; &quot;await start (from tester)&quot;,
<a name="33963"/>33963:            cmd  =&gt; fun(State) -&gt;
<a name="33964"/>33964:                            {Tester, Acceptor} = ?SEV_AWAIT_START(),
<a name="33965"/>33965:                            {ok, State#{tester  =&gt; Tester, 
<a name="33966"/>33966:                                       acceptor =&gt; Acceptor}}
<a name="33967"/>33967:                    end},
<a name="33968"/>33968:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="33969"/>33969:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="33970"/>33970:                            _MRef = erlang:monitor(process, Tester),
<a name="33971"/>33971:                            ok
<a name="33972"/>33972:                    end},
<a name="33973"/>33973:          #{desc =&gt; &quot;monitor acceptor&quot;,
<a name="33974"/>33974:            cmd  =&gt; fun(#{acceptor := Acceptor} = _State) -&gt;
<a name="33975"/>33975:                            _MRef = erlang:monitor(process, Acceptor),
<a name="33976"/>33976:                            ok
<a name="33977"/>33977:                    end},
<a name="33978"/>33978:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="33979"/>33979:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="33980"/>33980:                            ?SEV_ANNOUNCE_READY(Tester, init),
<a name="33981"/>33981:                            ok
<a name="33982"/>33982:                    end},
<a name="33983"/>33983: 
<a name="33984"/>33984:          %% The actual test
<a name="33985"/>33985:          #{desc =&gt; &quot;await continue (transfer)&quot;,
<a name="33986"/>33986:            cmd  =&gt; fun(#{acceptor := Pid} = State) -&gt;
<a name="33987"/>33987:                            case ?SEV_AWAIT_CONTINUE(Pid, acceptor, transfer) of
<a name="33988"/>33988:                                {ok, Sock} -&gt;
<a name="33989"/>33989:                                    {ok, State#{sock =&gt; Sock}};
<a name="33990"/>33990:                                {error, _} = ERROR -&gt;
<a name="33991"/>33991:                                    ERROR
<a name="33992"/>33992:                            end
<a name="33993"/>33993:                    end},
<a name="33994"/>33994:          #{desc =&gt; &quot;announce ready (transfer)&quot;,
<a name="33995"/>33995:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="33996"/>33996:                            ?SEV_ANNOUNCE_READY(Tester, transfer),
<a name="33997"/>33997:                            ok
<a name="33998"/>33998:                    end},
<a name="33999"/>33999:          #{desc =&gt; &quot;attempt recv (=&gt; closed)&quot;,
<a name="34000"/>34000:            cmd  =&gt; fun(#{sock := Sock, recv := Recv} = State) -&gt;
<a name="34001"/>34001:                            %% ok = socket:setopt(Sock, otp, debug, true),
<a name="34002"/>34002:                            case Recv(Sock) of
<a name="34003"/>34003:                                {ok, _Data} -&gt;
<a name="34004"/>34004:                                    ?SEV_EPRINT(&quot;Unexpected data received&quot;),
<a name="34005"/>34005:                                    {error, unexpected_success};
<a name="34006"/>34006:                                {error, closed} -&gt;
<a name="34007"/>34007:                                    ?SEV_IPRINT(&quot;received expected 'closed' &quot;
<a name="34008"/>34008:                                                &quot;result&quot;),
<a name="34009"/>34009:                                    State1 = maps:remove(sock, State),
<a name="34010"/>34010:                                    {ok, State1};
<a name="34011"/>34011:                                {error, Reason} = ERROR -&gt;
<a name="34012"/>34012:                                    ?SEV_EPRINT(&quot;Unexpected read failure: &quot;
<a name="34013"/>34013:                                                &quot;~n   ~p&quot;, [Reason]),
<a name="34014"/>34014:                                    ERROR
<a name="34015"/>34015:                            end
<a name="34016"/>34016:                    end},
<a name="34017"/>34017:          #{desc =&gt; &quot;announce ready (recv closed)&quot;,
<a name="34018"/>34018:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="34019"/>34019:                            ?SEV_ANNOUNCE_READY(Tester, recv_closed),
<a name="34020"/>34020:                            ok
<a name="34021"/>34021:                    end},
<a name="34022"/>34022: 
<a name="34023"/>34023:          %% *** Terminate ***
<a name="34024"/>34024:          #{desc =&gt; &quot;await terminate&quot;,
<a name="34025"/>34025:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="34026"/>34026:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="34027"/>34027:                                ok -&gt;
<a name="34028"/>34028:                                    {ok, maps:remove(tester, State)};
<a name="34029"/>34029:                                {error, _} = ERROR -&gt;
<a name="34030"/>34030:                                    ERROR
<a name="34031"/>34031:                            end
<a name="34032"/>34032:                    end},
<a name="34033"/>34033: 
<a name="34034"/>34034: 
<a name="34035"/>34035:          %% *** We are done ***
<a name="34036"/>34036:          ?SEV_FINISH_NORMAL
<a name="34037"/>34037:         ],
<a name="34038"/>34038: 
<a name="34039"/>34039:     %% The point of this is basically just to create the connection.
<a name="34040"/>34040:     ClientSeq =
<a name="34041"/>34041:         [
<a name="34042"/>34042:          %% *** Wait for start order part ***
<a name="34043"/>34043:          #{desc =&gt; &quot;await start (from tester)&quot;,
<a name="34044"/>34044:            cmd  =&gt; fun(State) -&gt;
<a name="34045"/>34045:                            Tester = ?SEV_AWAIT_START(),
<a name="34046"/>34046:                            {ok, State#{tester =&gt; Tester}}
<a name="34047"/>34047:                    end},
<a name="34048"/>34048:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="34049"/>34049:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="34050"/>34050:                            _MRef = erlang:monitor(process, Tester),
<a name="34051"/>34051:                            ok
<a name="34052"/>34052:                    end},
<a name="34053"/>34053: 
<a name="34054"/>34054:          %% *** Init part ***
<a name="34055"/>34055:          #{desc =&gt; &quot;which local address&quot;,
<a name="34056"/>34056:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="34057"/>34057:                            LSA = which_local_socket_addr(Domain),
<a name="34058"/>34058:                            {ok, State#{local_sa =&gt; LSA}}
<a name="34059"/>34059:                    end},
<a name="34060"/>34060:          #{desc =&gt; &quot;create socket&quot;,
<a name="34061"/>34061:            cmd  =&gt; fun(#{domain   := Domain, 
<a name="34062"/>34062:                          protocol := Proto} = State) -&gt;
<a name="34063"/>34063:                            case socket:open(Domain, stream, Proto) of
<a name="34064"/>34064:                                {ok, Sock} -&gt;
<a name="34065"/>34065:                                    {ok, State#{sock =&gt; Sock}};
<a name="34066"/>34066:                                {error, _} = ERROR -&gt;
<a name="34067"/>34067:                                    ERROR
<a name="34068"/>34068:                            end
<a name="34069"/>34069:                    end},
<a name="34070"/>34070:          #{desc =&gt; &quot;bind socket to local address&quot;,
<a name="34071"/>34071:            cmd  =&gt; fun(#{sock := Sock, local_sa := LSA} = _State) -&gt;
<a name="34072"/>34072:                            ?SEV_IPRINT(&quot;bind to LSA: &quot;
<a name="34073"/>34073:                                        &quot;~n   ~p&quot;, [LSA]),
<a name="34074"/>34074:                            case sock_bind(Sock, LSA) of
<a name="34075"/>34075:                                ok -&gt;
<a name="34076"/>34076:                                    ok;
<a name="34077"/>34077:                                {error, _} = ERROR -&gt;
<a name="34078"/>34078:                                    ERROR
<a name="34079"/>34079:                            end
<a name="34080"/>34080:                    end},
<a name="34081"/>34081:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="34082"/>34082:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="34083"/>34083:                            ?SEV_ANNOUNCE_READY(Tester, init),
<a name="34084"/>34084:                            ok
<a name="34085"/>34085:                    end},
<a name="34086"/>34086: 
<a name="34087"/>34087:          %% The actual test
<a name="34088"/>34088:          #{desc =&gt; &quot;await continue (connect)&quot;,
<a name="34089"/>34089:            cmd  =&gt; fun(#{domain := local = Domain,
<a name="34090"/>34090:                          tester := Tester} = State) -&gt;
<a name="34091"/>34091:                            case ?SEV_AWAIT_CONTINUE(Tester, tester, connect) of
<a name="34092"/>34092:                                {ok, ServerPath} -&gt;
<a name="34093"/>34093:                                    ?SEV_IPRINT(&quot;Server Path: &quot;
<a name="34094"/>34094:                                                &quot;~n   ~s&quot;, [ServerPath]),
<a name="34095"/>34095:                                    ServerSA = #{family =&gt; Domain,
<a name="34096"/>34096:                                                 path   =&gt; ServerPath},
<a name="34097"/>34097:                                    {ok, State#{server_sa =&gt; ServerSA}};
<a name="34098"/>34098:                                {error, _} = ERROR -&gt;
<a name="34099"/>34099:                                    ERROR
<a name="34100"/>34100:                            end;
<a name="34101"/>34101:                       (#{tester := Tester, local_sa := LSA} = State) -&gt;
<a name="34102"/>34102:                            case ?SEV_AWAIT_CONTINUE(Tester, tester, connect) of
<a name="34103"/>34103:                                {ok, Port} -&gt;
<a name="34104"/>34104:                                    ServerSA = LSA#{port =&gt; Port},
<a name="34105"/>34105:                                    {ok, State#{server_sa =&gt; ServerSA}};
<a name="34106"/>34106:                                {error, _} = ERROR -&gt;
<a name="34107"/>34107:                                    ERROR
<a name="34108"/>34108:                            end
<a name="34109"/>34109:                    end},
<a name="34110"/>34110:          #{desc =&gt; &quot;connect to server&quot;,
<a name="34111"/>34111:            cmd  =&gt; fun(#{sock := Sock, server_sa := ServerSA}) -&gt;
<a name="34112"/>34112:                            socket:connect(Sock, ServerSA)
<a name="34113"/>34113:                    end},
<a name="34114"/>34114:          #{desc =&gt; &quot;announce ready (connect)&quot;,
<a name="34115"/>34115:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="34116"/>34116:                            ?SEV_ANNOUNCE_READY(Tester, connect),
<a name="34117"/>34117:                            ok
<a name="34118"/>34118:                    end},
<a name="34119"/>34119: 
<a name="34120"/>34120:          %% *** Terminate ***
<a name="34121"/>34121:          #{desc =&gt; &quot;await terminate (from tester)&quot;,
<a name="34122"/>34122:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="34123"/>34123:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="34124"/>34124:                                ok -&gt;
<a name="34125"/>34125:                                    {ok, maps:remove(tester, State)};
<a name="34126"/>34126:                                {error, _} = ERROR -&gt;
<a name="34127"/>34127:                                    ERROR
<a name="34128"/>34128:                            end                           
<a name="34129"/>34129:                    end},
<a name="34130"/>34130:          #{desc =&gt; &quot;close socket&quot;,
<a name="34131"/>34131:            cmd  =&gt; fun(#{domain   := local,
<a name="34132"/>34132:                          sock     := Sock,
<a name="34133"/>34133:                          local_sa := #{path := Path}} = State) -&gt;
<a name="34134"/>34134:                            sock_close(Sock),
<a name="34135"/>34135:                            State1 =
<a name="34136"/>34136:                                unlink_path(Path,
<a name="34137"/>34137:                                            fun() -&gt;
<a name="34138"/>34138:                                                    maps:remove(local_sa, State)
<a name="34139"/>34139:                                            end,
<a name="34140"/>34140:                                            fun() -&gt; State end),
<a name="34141"/>34141:                            {ok, maps:remove(sock, State1)};
<a name="34142"/>34142:                        (#{sock := Sock} = State) -&gt;
<a name="34143"/>34143:                            sock_close(Sock),
<a name="34144"/>34144:                            {ok, maps:remove(sock, State)}
<a name="34145"/>34145:                    end},
<a name="34146"/>34146: 
<a name="34147"/>34147:          %% *** We are done ***
<a name="34148"/>34148:          ?SEV_FINISH_NORMAL
<a name="34149"/>34149:         ],
<a name="34150"/>34150: 
<a name="34151"/>34151:     TesterSeq =
<a name="34152"/>34152:         [
<a name="34153"/>34153:          %% *** Init part ***
<a name="34154"/>34154:          #{desc =&gt; &quot;monitor acceptor&quot;,
<a name="34155"/>34155:            cmd  =&gt; fun(#{acceptor := Pid} = _State) -&gt;
<a name="34156"/>34156:                            _MRef = erlang:monitor(process, Pid),
<a name="34157"/>34157:                            ok
<a name="34158"/>34158:                    end},
<a name="34159"/>34159:          #{desc =&gt; &quot;monitor handler 1&quot;,
<a name="34160"/>34160:            cmd  =&gt; fun(#{handler1 := Pid} = _State) -&gt;
<a name="34161"/>34161:                            _MRef = erlang:monitor(process, Pid),
<a name="34162"/>34162:                            ok
<a name="34163"/>34163:                    end},
<a name="34164"/>34164:          #{desc =&gt; &quot;monitor handler 2&quot;,
<a name="34165"/>34165:            cmd  =&gt; fun(#{handler2 := Pid} = _State) -&gt;
<a name="34166"/>34166:                            _MRef = erlang:monitor(process, Pid),
<a name="34167"/>34167:                            ok
<a name="34168"/>34168:                    end},
<a name="34169"/>34169:          #{desc =&gt; &quot;monitor handler 3&quot;,
<a name="34170"/>34170:            cmd  =&gt; fun(#{handler3 := Pid} = _State) -&gt;
<a name="34171"/>34171:                            _MRef = erlang:monitor(process, Pid),
<a name="34172"/>34172:                            ok
<a name="34173"/>34173:                    end},
<a name="34174"/>34174:          #{desc =&gt; &quot;monitor client&quot;,
<a name="34175"/>34175:            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;
<a name="34176"/>34176:                            _MRef = erlang:monitor(process, Pid),
<a name="34177"/>34177:                            ok
<a name="34178"/>34178:                    end},
<a name="34179"/>34179: 
<a name="34180"/>34180:          %% Start the acceptor
<a name="34181"/>34181:          #{desc =&gt; &quot;order acceptor start&quot;,
<a name="34182"/>34182:            cmd  =&gt; fun(#{acceptor := Pid} = _State) -&gt;
<a name="34183"/>34183:                            ?SEV_ANNOUNCE_START(Pid),
<a name="34184"/>34184:                            ok
<a name="34185"/>34185:                    end},
<a name="34186"/>34186:          #{desc =&gt; &quot;await acceptor ready (init)&quot;,
<a name="34187"/>34187:            cmd  =&gt; fun(#{acceptor := Pid} = State) -&gt;
<a name="34188"/>34188:                            case ?SEV_AWAIT_READY(Pid, acceptor, init) of
<a name="34189"/>34189:                                {ok, PortOrPath} -&gt;
<a name="34190"/>34190:                                    {ok, State#{server_info =&gt; PortOrPath}};
<a name="34191"/>34191:                                {error, _} = ERROR -&gt;
<a name="34192"/>34192:                                    ERROR
<a name="34193"/>34193:                            end
<a name="34194"/>34194:                    end},
<a name="34195"/>34195: 
<a name="34196"/>34196:          %% Start the handler(s)
<a name="34197"/>34197:          #{desc =&gt; &quot;order handler 1 start&quot;,
<a name="34198"/>34198:            cmd  =&gt; fun(#{acceptor := Acceptor, handler1 := Pid} = _State) -&gt;
<a name="34199"/>34199:                            ?SEV_ANNOUNCE_START(Pid, Acceptor),
<a name="34200"/>34200:                            ok
<a name="34201"/>34201:                    end},
<a name="34202"/>34202:          #{desc =&gt; &quot;await handler 1 ready (init)&quot;,
<a name="34203"/>34203:            cmd  =&gt; fun(#{handler1 := Pid} = _State) -&gt;
<a name="34204"/>34204:                            ?SEV_AWAIT_READY(Pid, handler1, init)
<a name="34205"/>34205:                    end},
<a name="34206"/>34206:          #{desc =&gt; &quot;order handler 2 start&quot;,
<a name="34207"/>34207:            cmd  =&gt; fun(#{acceptor := Acceptor, handler2 := Pid} = _State) -&gt;
<a name="34208"/>34208:                            ?SEV_ANNOUNCE_START(Pid, Acceptor),
<a name="34209"/>34209:                            ok
<a name="34210"/>34210:                    end},
<a name="34211"/>34211:          #{desc =&gt; &quot;await handler 2 ready (init)&quot;,
<a name="34212"/>34212:            cmd  =&gt; fun(#{handler2 := Pid} = _State) -&gt;
<a name="34213"/>34213:                            ?SEV_AWAIT_READY(Pid, handler2, init)
<a name="34214"/>34214:                    end},
<a name="34215"/>34215:          #{desc =&gt; &quot;order handler 3 start&quot;,
<a name="34216"/>34216:            cmd  =&gt; fun(#{acceptor := Acceptor, handler3 := Pid} = _State) -&gt;
<a name="34217"/>34217:                            ?SEV_ANNOUNCE_START(Pid, Acceptor),
<a name="34218"/>34218:                            ok
<a name="34219"/>34219:                    end},
<a name="34220"/>34220:          #{desc =&gt; &quot;await handler 3 ready (init)&quot;,
<a name="34221"/>34221:            cmd  =&gt; fun(#{handler3 := Pid} = _State) -&gt;
<a name="34222"/>34222:                            ?SEV_AWAIT_READY(Pid, handler3, init)
<a name="34223"/>34223:                    end},
<a name="34224"/>34224: 
<a name="34225"/>34225:          %% Start the client
<a name="34226"/>34226:          #{desc =&gt; &quot;order client start&quot;,
<a name="34227"/>34227:            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;
<a name="34228"/>34228:                            ?SEV_ANNOUNCE_START(Pid),
<a name="34229"/>34229:                            ok
<a name="34230"/>34230:                    end},
<a name="34231"/>34231:          #{desc =&gt; &quot;await client ready (init)&quot;,
<a name="34232"/>34232:            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;
<a name="34233"/>34233:                            ?SEV_AWAIT_READY(Pid, client, init)
<a name="34234"/>34234:                    end},
<a name="34235"/>34235: 
<a name="34236"/>34236:          %% The actual test
<a name="34237"/>34237:          #{desc =&gt; &quot;order acceptor to continue (accept)&quot;,
<a name="34238"/>34238:            cmd  =&gt; fun(#{acceptor := Pid, 
<a name="34239"/>34239:                          handler1 := H1, 
<a name="34240"/>34240:                          handler2 := H2, 
<a name="34241"/>34241:                          handler3 := H3} = _State) -&gt;
<a name="34242"/>34242:                            ?SEV_ANNOUNCE_CONTINUE(Pid, accept, {H1, H2, H3}),
<a name="34243"/>34243:                            ok
<a name="34244"/>34244:                    end},
<a name="34245"/>34245:          ?SEV_SLEEP(?SECS(1)),
<a name="34246"/>34246:          #{desc =&gt; &quot;order client to continue (connect)&quot;,
<a name="34247"/>34247:            cmd  =&gt; fun(#{client := Pid, server_info := Info} = _State) -&gt;
<a name="34248"/>34248:                            ?SEV_ANNOUNCE_CONTINUE(Pid, connect, Info),
<a name="34249"/>34249:                            ok
<a name="34250"/>34250:                    end},
<a name="34251"/>34251:          #{desc =&gt; &quot;await acceptor ready (accept)&quot;,
<a name="34252"/>34252:            cmd  =&gt; fun(#{acceptor := Pid} = _State) -&gt;
<a name="34253"/>34253:                            ok = ?SEV_AWAIT_READY(Pid, acceptor, accept)
<a name="34254"/>34254:                    end},
<a name="34255"/>34255:          #{desc =&gt; &quot;await client ready (connect)&quot;,
<a name="34256"/>34256:            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;
<a name="34257"/>34257:                            ok = ?SEV_AWAIT_READY(Pid, client, connect)
<a name="34258"/>34258:                    end},
<a name="34259"/>34259:          #{desc =&gt; &quot;await handler 1 ready (transfer)&quot;,
<a name="34260"/>34260:            cmd  =&gt; fun(#{handler1 := Pid} = _State) -&gt;
<a name="34261"/>34261:                            ok = ?SEV_AWAIT_READY(Pid, handler1, transfer)
<a name="34262"/>34262:                    end},
<a name="34263"/>34263:          #{desc =&gt; &quot;await handler 2 ready (transfer)&quot;,
<a name="34264"/>34264:            cmd  =&gt; fun(#{handler2 := Pid} = _State) -&gt;
<a name="34265"/>34265:                            ok = ?SEV_AWAIT_READY(Pid, handler2, transfer)
<a name="34266"/>34266:                    end},
<a name="34267"/>34267:          #{desc =&gt; &quot;await handler 3 ready (transfer)&quot;,
<a name="34268"/>34268:            cmd  =&gt; fun(#{handler3 := Pid} = _State) -&gt;
<a name="34269"/>34269:                            ok = ?SEV_AWAIT_READY(Pid, handler3, transfer)
<a name="34270"/>34270:                    end},
<a name="34271"/>34271:          ?SEV_SLEEP(?SECS(1)),
<a name="34272"/>34272:          #{desc =&gt; &quot;order acceptor to continue (close connection socket)&quot;,
<a name="34273"/>34273:            cmd  =&gt; fun(#{acceptor := Pid} = _State) -&gt;
<a name="34274"/>34274:                            ?SEV_ANNOUNCE_CONTINUE(Pid, close),
<a name="34275"/>34275:                            ok
<a name="34276"/>34276:                    end},
<a name="34277"/>34277:          #{desc =&gt; &quot;await acceptor ready (close)&quot;,
<a name="34278"/>34278:            cmd  =&gt; fun(#{acceptor := Pid} = _State) -&gt;
<a name="34279"/>34279:                            ok = ?SEV_AWAIT_READY(Pid, acceptor, close)
<a name="34280"/>34280:                    end},
<a name="34281"/>34281:          #{desc =&gt; &quot;await handler 1 ready (recv closed)&quot;,
<a name="34282"/>34282:            cmd  =&gt; fun(#{handler1 := Pid} = _State) -&gt;
<a name="34283"/>34283:                            ok = ?SEV_AWAIT_READY(Pid, handler1, recv_closed)
<a name="34284"/>34284:                    end},
<a name="34285"/>34285:          #{desc =&gt; &quot;await handler 2 ready (recv closed)&quot;,
<a name="34286"/>34286:            cmd  =&gt; fun(#{handler2 := Pid} = _State) -&gt;
<a name="34287"/>34287:                            ok = ?SEV_AWAIT_READY(Pid, handler2, recv_closed)
<a name="34288"/>34288:                    end},
<a name="34289"/>34289:          #{desc =&gt; &quot;await handler 3 ready (recv closed)&quot;,
<a name="34290"/>34290:            cmd  =&gt; fun(#{handler3 := Pid} = _State) -&gt;
<a name="34291"/>34291:                            ok = ?SEV_AWAIT_READY(Pid, handler3, recv_closed)
<a name="34292"/>34292:                    end},
<a name="34293"/>34293: 
<a name="34294"/>34294:          %% Terminations
<a name="34295"/>34295:          #{desc =&gt; &quot;order client to terminate&quot;,
<a name="34296"/>34296:            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;
<a name="34297"/>34297:                            ?SEV_ANNOUNCE_TERMINATE(Pid),
<a name="34298"/>34298:                            ok
<a name="34299"/>34299:                    end},
<a name="34300"/>34300:          #{desc =&gt; &quot;await client termination&quot;,
<a name="34301"/>34301:            cmd  =&gt; fun(#{client := Pid} = State) -&gt;
<a name="34302"/>34302:                            case ?SEV_AWAIT_TERMINATION(Pid) of
<a name="34303"/>34303:                                ok -&gt;
<a name="34304"/>34304:                                    {ok, maps:remove(client, State)};
<a name="34305"/>34305:                                {error, _} = ERROR -&gt;
<a name="34306"/>34306:                                    ERROR
<a name="34307"/>34307:                            end
<a name="34308"/>34308:                    end},
<a name="34309"/>34309:          #{desc =&gt; &quot;order handler 1 to terminate&quot;,
<a name="34310"/>34310:            cmd  =&gt; fun(#{handler1 := Pid} = _State) -&gt;
<a name="34311"/>34311:                            ?SEV_ANNOUNCE_TERMINATE(Pid),
<a name="34312"/>34312:                            ok
<a name="34313"/>34313:                    end},
<a name="34314"/>34314:          #{desc =&gt; &quot;await handler 1 termination&quot;,
<a name="34315"/>34315:            cmd  =&gt; fun(#{handler1 := Pid} = State) -&gt;
<a name="34316"/>34316:                            case ?SEV_AWAIT_TERMINATION(Pid) of
<a name="34317"/>34317:                                ok -&gt;
<a name="34318"/>34318:                                    {ok, maps:remove(handler1, State)};
<a name="34319"/>34319:                                {error, _} = ERROR -&gt;
<a name="34320"/>34320:                                    ERROR
<a name="34321"/>34321:                            end
<a name="34322"/>34322:                    end},
<a name="34323"/>34323:          #{desc =&gt; &quot;order handler 2 to terminate&quot;,
<a name="34324"/>34324:            cmd  =&gt; fun(#{handler2 := Pid} = _State) -&gt;
<a name="34325"/>34325:                            ?SEV_ANNOUNCE_TERMINATE(Pid),
<a name="34326"/>34326:                            ok
<a name="34327"/>34327:                    end},
<a name="34328"/>34328:          #{desc =&gt; &quot;await handler 2 termination&quot;,
<a name="34329"/>34329:            cmd  =&gt; fun(#{handler2 := Pid} = State) -&gt;
<a name="34330"/>34330:                            case ?SEV_AWAIT_TERMINATION(Pid) of
<a name="34331"/>34331:                                ok -&gt;
<a name="34332"/>34332:                                    {ok, maps:remove(handler2, State)};
<a name="34333"/>34333:                                {error, _} = ERROR -&gt;
<a name="34334"/>34334:                                    ERROR
<a name="34335"/>34335:                            end
<a name="34336"/>34336:                    end},
<a name="34337"/>34337:          #{desc =&gt; &quot;order handler 3 to terminate&quot;,
<a name="34338"/>34338:            cmd  =&gt; fun(#{handler3 := Pid} = _State) -&gt;
<a name="34339"/>34339:                            ?SEV_ANNOUNCE_TERMINATE(Pid),
<a name="34340"/>34340:                            ok
<a name="34341"/>34341:                    end},
<a name="34342"/>34342:          #{desc =&gt; &quot;await handler 3 termination&quot;,
<a name="34343"/>34343:            cmd  =&gt; fun(#{handler3 := Pid} = State) -&gt;
<a name="34344"/>34344:                            case ?SEV_AWAIT_TERMINATION(Pid) of
<a name="34345"/>34345:                                ok -&gt;
<a name="34346"/>34346:                                    {ok, maps:remove(handler3, State)};
<a name="34347"/>34347:                                {error, _} = ERROR -&gt;
<a name="34348"/>34348:                                    ERROR
<a name="34349"/>34349:                            end
<a name="34350"/>34350:                    end},
<a name="34351"/>34351:          #{desc =&gt; &quot;order acceptor to terminate&quot;,
<a name="34352"/>34352:            cmd  =&gt; fun(#{acceptor := Pid} = _State) -&gt;
<a name="34353"/>34353:                            ?SEV_ANNOUNCE_TERMINATE(Pid),
<a name="34354"/>34354:                            ok
<a name="34355"/>34355:                    end},
<a name="34356"/>34356:          #{desc =&gt; &quot;await acceptor termination&quot;,
<a name="34357"/>34357:            cmd  =&gt; fun(#{acceptor := Pid} = State) -&gt;
<a name="34358"/>34358:                            case ?SEV_AWAIT_TERMINATION(Pid) of
<a name="34359"/>34359:                                ok -&gt;
<a name="34360"/>34360:                                    {ok, maps:remove(acceptor, State)};
<a name="34361"/>34361:                                {error, _} = ERROR -&gt;
<a name="34362"/>34362:                                    ERROR
<a name="34363"/>34363:                            end
<a name="34364"/>34364:                    end},
<a name="34365"/>34365: 
<a name="34366"/>34366: 
<a name="34367"/>34367:          %% *** We are done ***
<a name="34368"/>34368:          ?SEV_FINISH_NORMAL
<a name="34369"/>34369:         ],
<a name="34370"/>34370: 
<a name="34371"/>34371:     i(&quot;start acceptor evaluator&quot;),
<a name="34372"/>34372:     AccInitState = InitState,
<a name="34373"/>34373:     Acceptor = ?SEV_START(&quot;acceptor&quot;, AcceptorSeq, AccInitState),
<a name="34374"/>34374: 
<a name="34375"/>34375:     i(&quot;start handler 1 evaluator&quot;),
<a name="34376"/>34376:     HandlerInitState = #{recv =&gt; maps:get(recv, InitState)},
<a name="34377"/>34377:     Handler1 = ?SEV_START(&quot;handler-1&quot;, HandlerSeq, HandlerInitState),
<a name="34378"/>34378: 
<a name="34379"/>34379:     i(&quot;start handler 2 evaluator&quot;),
<a name="34380"/>34380:     Handler2 = ?SEV_START(&quot;handler-2&quot;, HandlerSeq, HandlerInitState),
<a name="34381"/>34381: 
<a name="34382"/>34382:     i(&quot;start handler 3 evaluator&quot;),
<a name="34383"/>34383:     Handler3 = ?SEV_START(&quot;handler-3&quot;, HandlerSeq, HandlerInitState),
<a name="34384"/>34384: 
<a name="34385"/>34385:     i(&quot;start client evaluator&quot;),
<a name="34386"/>34386:     ClientInitState = InitState,
<a name="34387"/>34387:     Client = ?SEV_START(&quot;client&quot;, ClientSeq, ClientInitState),
<a name="34388"/>34388: 
<a name="34389"/>34389:     i(&quot;start tester evaluator&quot;),
<a name="34390"/>34390:     TesterInitState = #{acceptor =&gt; Acceptor#ev.pid,
<a name="34391"/>34391:                         handler1 =&gt; Handler1#ev.pid,
<a name="34392"/>34392:                         handler2 =&gt; Handler2#ev.pid,
<a name="34393"/>34393:                         handler3 =&gt; Handler3#ev.pid,
<a name="34394"/>34394:                         client   =&gt; Client#ev.pid},
<a name="34395"/>34395:     Tester = ?SEV_START(&quot;tester&quot;, TesterSeq, TesterInitState),
<a name="34396"/>34396: 
<a name="34397"/>34397:     i(&quot;await evaluator&quot;),
<a name="sc_lc_receive_response_tcp-last_expr"/><a name="34398"/>34398: <b>    ok = ?SEV_AWAIT_FINISH</b>([Acceptor, 
<a name="34399"/>34399:                             Handler1, Handler2, Handler3, 
<a name="34400"/>34400:                             Client, Tester]).
<a name="34401"/>34401: 
<a name="34402"/>34402: 
<a name="34403"/>34403: 
<a name="34404"/>34404: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="34405"/>34405: <i>%% This test case is intended to test what happens when a socket is </i>
<a name="34406"/>34406: <i>%% locally closed while a process is calling the recvfrom function.</i>
<a name="34407"/>34407: <i>%% Socket is IPv4.</i>
<a name="34408"/>34408: <i>%% </i>
<a name="34409"/>34409: 
<a name="sc_lc_recvfrom_response_udp4-1"/><a name="34410"/>34410: <b>sc_lc_recvfrom_response_udp4</b>(_Config) when is_list(_Config) -&gt;
<a name="34411"/>34411:     ?TT(?SECS(30)),
<a name="sc_lc_recvfrom_response_udp4-last_expr"/><a name="34412"/>34412: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="34413"/>34413:            fun() -&gt; has_support_ipv4() end,
<a name="34414"/>34414:            fun() -&gt;
<a name="34415"/>34415:                    Recv      = fun(Sock, To) -&gt;
<a name="34416"/>34416:                                        socket:recvfrom(Sock, [], To)
<a name="34417"/>34417:                                end,
<a name="34418"/>34418:                    InitState = #{domain   =&gt; inet,
<a name="34419"/>34419:                                  protocol =&gt; udp,
<a name="34420"/>34420:                                  recv     =&gt; Recv},
<a name="34421"/>34421:                    ok = sc_lc_receive_response_udp(InitState)
<a name="34422"/>34422:            end).
<a name="34423"/>34423: 
<a name="34424"/>34424: 
<a name="34425"/>34425: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="34426"/>34426: <i>%% This test case is intended to test what happens when a socket is </i>
<a name="34427"/>34427: <i>%% locally closed while the process is calling the recv function.</i>
<a name="34428"/>34428: <i>%% Socket is IPv6.</i>
<a name="34429"/>34429: 
<a name="sc_lc_recvfrom_response_udp6-1"/><a name="34430"/>34430: <b>sc_lc_recvfrom_response_udp6</b>(_Config) when is_list(_Config) -&gt;
<a name="34431"/>34431:     ?TT(?SECS(30)),
<a name="sc_lc_recvfrom_response_udp6-last_expr"/><a name="34432"/>34432: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="34433"/>34433:            fun() -&gt; has_support_ipv6() end,
<a name="34434"/>34434:            fun() -&gt;
<a name="34435"/>34435:                    Recv      = fun(Sock, To) -&gt;
<a name="34436"/>34436:                                        socket:recvfrom(Sock, [], To)
<a name="34437"/>34437:                                end,
<a name="34438"/>34438:                    InitState = #{domain   =&gt; inet6,
<a name="34439"/>34439:                                  protocol =&gt; udp,
<a name="34440"/>34440:                                  recv     =&gt; Recv},
<a name="34441"/>34441:                    ok = sc_lc_receive_response_udp(InitState)
<a name="34442"/>34442:            end).
<a name="34443"/>34443: 
<a name="34444"/>34444: 
<a name="34445"/>34445: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="34446"/>34446: <i>%% This test case is intended to test what happens when a socket is </i>
<a name="34447"/>34447: <i>%% locally closed while the process is calling the recv function.</i>
<a name="34448"/>34448: <i>%% Socket is Unix Domainm (dgram) socket.</i>
<a name="34449"/>34449: 
<a name="sc_lc_recvfrom_response_udpL-1"/><a name="34450"/>34450: <b>sc_lc_recvfrom_response_udpL</b>(_Config) when is_list(_Config) -&gt;
<a name="34451"/>34451:     ?TT(?SECS(30)),
<a name="sc_lc_recvfrom_response_udpL-last_expr"/><a name="34452"/>34452: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="34453"/>34453:            fun() -&gt;
<a name="34454"/>34454: 		   has_support_unix_domain_socket(),
<a name="34455"/>34455: 		   is_not_windows()
<a name="34456"/>34456: 	   end,
<a name="34457"/>34457:            fun() -&gt;
<a name="34458"/>34458:                    Recv      = fun(Sock, To) -&gt;
<a name="34459"/>34459:                                        socket:recvfrom(Sock, [], To)
<a name="34460"/>34460:                                end,
<a name="34461"/>34461:                    InitState = #{domain   =&gt; local,
<a name="34462"/>34462:                                  protocol =&gt; default,
<a name="34463"/>34463:                                  recv     =&gt; Recv},
<a name="34464"/>34464:                    ok = sc_lc_receive_response_udp(InitState)
<a name="34465"/>34465:            end).
<a name="34466"/>34466: 
<a name="34467"/>34467: 
<a name="34468"/>34468: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="34469"/>34469: 
<a name="sc_lc_receive_response_udp-1"/><a name="34470"/>34470: <b>sc_lc_receive_response_udp</b>(InitState) -&gt;
<a name="34471"/>34471:     PrimServerSeq =
<a name="34472"/>34472:         [
<a name="34473"/>34473:          %% *** Wait for start order part ***
<a name="34474"/>34474:          #{desc =&gt; &quot;await start&quot;,
<a name="34475"/>34475:            cmd  =&gt; fun(State) -&gt;
<a name="34476"/>34476:                            Tester = ?SEV_AWAIT_START(),
<a name="34477"/>34477:                            {ok, State#{tester =&gt; Tester}}
<a name="34478"/>34478:                    end},
<a name="34479"/>34479:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="34480"/>34480:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="34481"/>34481:                            _MRef = erlang:monitor(process, Tester),
<a name="34482"/>34482:                            ok
<a name="34483"/>34483:                    end},
<a name="34484"/>34484: 
<a name="34485"/>34485:          %% *** Init part ***
<a name="34486"/>34486:          #{desc =&gt; &quot;local address&quot;,
<a name="34487"/>34487:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="34488"/>34488:                            LSA = which_local_socket_addr(Domain),
<a name="34489"/>34489:                            {ok, State#{local_sa =&gt; LSA}}
<a name="34490"/>34490:                    end},
<a name="34491"/>34491:          #{desc =&gt; &quot;open socket&quot;,
<a name="34492"/>34492:            cmd  =&gt; fun(#{domain := Domain, protocol := Proto} = State) -&gt;
<a name="34493"/>34493:                            Sock = sock_open(Domain, dgram, Proto),
<a name="34494"/>34494:                            {ok, State#{sock =&gt; Sock}}
<a name="34495"/>34495:                    end},
<a name="34496"/>34496:          #{desc =&gt; &quot;bind socket&quot;,
<a name="34497"/>34497:            cmd  =&gt; fun(#{sock := Sock, local_sa := LSA}) -&gt;
<a name="34498"/>34498:                            case sock_bind(Sock, LSA) of
<a name="34499"/>34499:                                ok -&gt;
<a name="34500"/>34500:                                    ?SEV_IPRINT(&quot;src bound&quot;),
<a name="34501"/>34501:                                    ok;
<a name="34502"/>34502:                                {error, Reason} = ERROR -&gt;
<a name="34503"/>34503:                                    ?SEV_EPRINT(&quot;src bind failed: ~p&quot;, [Reason]),
<a name="34504"/>34504:                                    ERROR
<a name="34505"/>34505:                            end
<a name="34506"/>34506:                    end},
<a name="34507"/>34507:          #{desc =&gt; &quot;socket name&quot;,
<a name="34508"/>34508:            cmd  =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="34509"/>34509:                            case socket:sockname(Sock) of
<a name="34510"/>34510:                                {ok, SA} -&gt;
<a name="34511"/>34511:                                    {ok, State#{sa =&gt; SA}};
<a name="34512"/>34512:                                {error, eafnosupport = Reason} -&gt;
<a name="34513"/>34513:                                    ?SEV_IPRINT(&quot;Failed get socket name: &quot;
<a name="34514"/>34514:                                                &quot;~n   ~p&quot;, [Reason]),
<a name="34515"/>34515:                                    (catch socket:close(Sock)),
<a name="34516"/>34516:                                    {skip, Reason};
<a name="34517"/>34517:                                {error, Reason} = ERROR -&gt;
<a name="34518"/>34518:                                    ?SEV_EPRINT(&quot;Failed get socket name: &quot;
<a name="34519"/>34519:                                                &quot;~n   ~p&quot;, [Reason]),
<a name="34520"/>34520:                                    ERROR
<a name="34521"/>34521:                            end
<a name="34522"/>34522:                    end},
<a name="34523"/>34523:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="34524"/>34524:            cmd  =&gt; fun(#{tester := Tester, sock := Sock}) -&gt;
<a name="34525"/>34525:                            ?SEV_ANNOUNCE_READY(Tester, init, Sock),
<a name="34526"/>34526:                            ok
<a name="34527"/>34527:                    end},
<a name="34528"/>34528: 
<a name="34529"/>34529:          %% The actual test
<a name="34530"/>34530:          #{desc =&gt; &quot;await continue (recv, with timeout)&quot;,
<a name="34531"/>34531:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="34532"/>34532:                            case ?SEV_AWAIT_CONTINUE(Tester, tester, recv) of
<a name="34533"/>34533:                                {ok, Timeout} -&gt;
<a name="34534"/>34534:                                    {ok, State#{timeout =&gt; Timeout}};
<a name="34535"/>34535:                                {error, _} = ERROR -&gt;
<a name="34536"/>34536:                                    ERROR
<a name="34537"/>34537:                            end
<a name="34538"/>34538:                    end},
<a name="34539"/>34539:          #{desc =&gt; &quot;receive, with timeout&quot;,
<a name="34540"/>34540:            cmd  =&gt; fun(#{sock := Sock, recv := Recv, timeout := Timeout}) -&gt;
<a name="34541"/>34541:                            case Recv(Sock, Timeout) of
<a name="34542"/>34542:                                {error, timeout} -&gt;
<a name="34543"/>34543:                                    ok;
<a name="34544"/>34544:                                {ok, _} -&gt;
<a name="34545"/>34545:                                    {error, unexpected_success};
<a name="34546"/>34546:                                {error, _} = ERROR -&gt;
<a name="34547"/>34547:                                    ERROR
<a name="34548"/>34548:                            end
<a name="34549"/>34549:                    end},
<a name="34550"/>34550:          #{desc =&gt; &quot;announce ready (recv, with timeout)&quot;,
<a name="34551"/>34551:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="34552"/>34552:                            ?SEV_ANNOUNCE_READY(Tester, recv),
<a name="34553"/>34553:                            ok
<a name="34554"/>34554:                    end},
<a name="34555"/>34555:          #{desc =&gt; &quot;await continue (close)&quot;,
<a name="34556"/>34556:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="34557"/>34557:                            ok = ?SEV_AWAIT_CONTINUE(Tester, tester, close)
<a name="34558"/>34558:                    end},
<a name="34559"/>34559:          #{desc =&gt; &quot;close socket&quot;,
<a name="34560"/>34560:            cmd  =&gt; fun(#{domain   := local,
<a name="34561"/>34561:                          sock     := Sock,
<a name="34562"/>34562:                          local_sa := #{path := Path}} = State) -&gt;
<a name="34563"/>34563:                            ok = socket:close(Sock),
<a name="34564"/>34564:                            State1 =
<a name="34565"/>34565:                                unlink_path(Path,
<a name="34566"/>34566:                                            fun() -&gt;
<a name="34567"/>34567:                                                    maps:remove(local_sa, State)
<a name="34568"/>34568:                                            end,
<a name="34569"/>34569:                                            fun() -&gt; State end),
<a name="34570"/>34570:                            {ok, maps:remove(sock, State1)};
<a name="34571"/>34571:                       (#{sock := Sock} = State) -&gt;
<a name="34572"/>34572:                            case socket:close(Sock) of
<a name="34573"/>34573:                                ok -&gt;
<a name="34574"/>34574:                                    {ok, maps:remove(sock, State)};
<a name="34575"/>34575:                                {error, _} = ERROR -&gt;
<a name="34576"/>34576:                                    ERROR
<a name="34577"/>34577:                            end
<a name="34578"/>34578:                    end},
<a name="34579"/>34579:          #{desc =&gt; &quot;announce ready (close)&quot;,
<a name="34580"/>34580:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="34581"/>34581:                            ?SEV_ANNOUNCE_READY(Tester, close),
<a name="34582"/>34582:                            ok
<a name="34583"/>34583:                    end},
<a name="34584"/>34584: 
<a name="34585"/>34585:          %% Termination
<a name="34586"/>34586:          #{desc =&gt; &quot;await terminate (from tester)&quot;,
<a name="34587"/>34587:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="34588"/>34588:                            case ?SEV_AWAIT_TERMINATE(Tester, terminate) of
<a name="34589"/>34589:                                ok -&gt;
<a name="34590"/>34590:                                    {ok, maps:remove(tester, State)};
<a name="34591"/>34591:                                {error, _} = ERROR -&gt;
<a name="34592"/>34592:                                    ERROR
<a name="34593"/>34593:                            end
<a name="34594"/>34594:                    end},
<a name="34595"/>34595: 
<a name="34596"/>34596:          %% *** We are done ***
<a name="34597"/>34597:          ?SEV_FINISH_NORMAL
<a name="34598"/>34598:         ],
<a name="34599"/>34599: 
<a name="34600"/>34600:     SecServerSeq =
<a name="34601"/>34601:         [
<a name="34602"/>34602:          %% *** Init part ***
<a name="34603"/>34603:          #{desc =&gt; &quot;await start&quot;,
<a name="34604"/>34604:            cmd  =&gt; fun(State) -&gt;
<a name="34605"/>34605:                            {Tester, Sock} = ?SEV_AWAIT_START(),
<a name="34606"/>34606:                            {ok, State#{tester =&gt; Tester, sock =&gt; Sock}}
<a name="34607"/>34607:                    end},
<a name="34608"/>34608:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="34609"/>34609:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="34610"/>34610:                            _MRef = erlang:monitor(process, Tester),
<a name="34611"/>34611:                            ok
<a name="34612"/>34612:                    end},
<a name="34613"/>34613:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="34614"/>34614:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="34615"/>34615:                            ?SEV_ANNOUNCE_READY(Tester, init),
<a name="34616"/>34616:                            ok
<a name="34617"/>34617:                    end},
<a name="34618"/>34618: 
<a name="34619"/>34619:          %% The actual test
<a name="34620"/>34620:          #{desc =&gt; &quot;await continue (recv)&quot;,
<a name="34621"/>34621:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="34622"/>34622:                            ok = ?SEV_AWAIT_CONTINUE(Tester, tester, recv)
<a name="34623"/>34623:                            
<a name="34624"/>34624:                    end},
<a name="34625"/>34625:          #{desc =&gt; &quot;receive&quot;,
<a name="34626"/>34626:            cmd  =&gt; fun(#{sock := Sock, recv := Recv} = State) -&gt;
<a name="34627"/>34627:                            case Recv(Sock, infinity) of
<a name="34628"/>34628:                                {error, closed} -&gt;
<a name="34629"/>34629:                                    {ok, maps:remove(sock, State)};
<a name="34630"/>34630:                                {ok, _} -&gt;
<a name="34631"/>34631:                                    {error, unexpected_success};
<a name="34632"/>34632:                                {error, _} = ERROR -&gt;
<a name="34633"/>34633:                                    ERROR
<a name="34634"/>34634:                            end
<a name="34635"/>34635:                    end},
<a name="34636"/>34636:          #{desc =&gt; &quot;announce ready (recv closed)&quot;,
<a name="34637"/>34637:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="34638"/>34638:                            ?SEV_ANNOUNCE_READY(Tester, recv_closed),
<a name="34639"/>34639:                            ok
<a name="34640"/>34640:                    end},
<a name="34641"/>34641: 
<a name="34642"/>34642:          %% Termination
<a name="34643"/>34643:          #{desc =&gt; &quot;await terminate (from tester)&quot;,
<a name="34644"/>34644:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="34645"/>34645:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="34646"/>34646:                                ok -&gt;
<a name="34647"/>34647:                                    {ok, maps:remove(tester, State)};
<a name="34648"/>34648:                                {error, _} = ERROR -&gt;
<a name="34649"/>34649:                                    ERROR
<a name="34650"/>34650:                            end
<a name="34651"/>34651:                    end},
<a name="34652"/>34652: 
<a name="34653"/>34653:          %% *** We are done ***
<a name="34654"/>34654:          ?SEV_FINISH_NORMAL
<a name="34655"/>34655:         ],
<a name="34656"/>34656: 
<a name="34657"/>34657: 
<a name="34658"/>34658:     TesterSeq =
<a name="34659"/>34659:         [
<a name="34660"/>34660:          %% *** Init part ***
<a name="34661"/>34661:          #{desc =&gt; &quot;monitor primary server&quot;,
<a name="34662"/>34662:            cmd  =&gt; fun(#{prim_server := Pid} = _State) -&gt;
<a name="34663"/>34663:                            _MRef = erlang:monitor(process, Pid),
<a name="34664"/>34664:                            ok
<a name="34665"/>34665:                    end},
<a name="34666"/>34666:          #{desc =&gt; &quot;monitor secondary server 1&quot;,
<a name="34667"/>34667:            cmd  =&gt; fun(#{sec_server1 := Pid} = _State) -&gt;
<a name="34668"/>34668:                            _MRef = erlang:monitor(process, Pid),
<a name="34669"/>34669:                            ok
<a name="34670"/>34670:                    end},
<a name="34671"/>34671:          #{desc =&gt; &quot;monitor secondary server 2&quot;,
<a name="34672"/>34672:            cmd  =&gt; fun(#{sec_server2 := Pid} = _State) -&gt;
<a name="34673"/>34673:                            _MRef = erlang:monitor(process, Pid),
<a name="34674"/>34674:                            ok
<a name="34675"/>34675:                    end},
<a name="34676"/>34676:          #{desc =&gt; &quot;monitor secondary server 3&quot;,
<a name="34677"/>34677:            cmd  =&gt; fun(#{sec_server3 := Pid} = _State) -&gt;
<a name="34678"/>34678:                            _MRef = erlang:monitor(process, Pid),
<a name="34679"/>34679:                            ok
<a name="34680"/>34680:                    end},
<a name="34681"/>34681: 
<a name="34682"/>34682:          %% Start the primary server
<a name="34683"/>34683:          #{desc =&gt; &quot;order 'primary server' start&quot;,
<a name="34684"/>34684:            cmd  =&gt; fun(#{prim_server := Pid} = _State) -&gt;
<a name="34685"/>34685:                            ?SEV_ANNOUNCE_START(Pid),
<a name="34686"/>34686:                            ok
<a name="34687"/>34687:                    end},
<a name="34688"/>34688:          #{desc =&gt; &quot;await 'primary server' ready (init)&quot;,
<a name="34689"/>34689:            cmd  =&gt; fun(#{prim_server := Pid} = State) -&gt;
<a name="34690"/>34690:                            {ok, Sock} = ?SEV_AWAIT_READY(Pid, prim_server, init),
<a name="34691"/>34691:                            {ok, State#{sock =&gt; Sock}}
<a name="34692"/>34692:                    end},
<a name="34693"/>34693: 
<a name="34694"/>34694:          %% Start the secondary server 1
<a name="34695"/>34695:          #{desc =&gt; &quot;order 'secondary server 1' start&quot;,
<a name="34696"/>34696:            cmd  =&gt; fun(#{sec_server1 := Pid, sock := Sock} = _State) -&gt;
<a name="34697"/>34697:                            ?SEV_ANNOUNCE_START(Pid, Sock),
<a name="34698"/>34698:                            ok
<a name="34699"/>34699:                    end},
<a name="34700"/>34700:          #{desc =&gt; &quot;await 'secondary server 1' ready (init)&quot;,
<a name="34701"/>34701:            cmd  =&gt; fun(#{sec_server1 := Pid} = _State) -&gt;
<a name="34702"/>34702:                            ok = ?SEV_AWAIT_READY(Pid, sec_server1, init)
<a name="34703"/>34703:                    end},
<a name="34704"/>34704: 
<a name="34705"/>34705:          %% Start the secondary server 2
<a name="34706"/>34706:          #{desc =&gt; &quot;order 'secondary server 2' start&quot;,
<a name="34707"/>34707:            cmd  =&gt; fun(#{sec_server2 := Pid, sock := Sock} = _State) -&gt;
<a name="34708"/>34708:                            ?SEV_ANNOUNCE_START(Pid, Sock),
<a name="34709"/>34709:                            ok
<a name="34710"/>34710:                    end},
<a name="34711"/>34711:          #{desc =&gt; &quot;await 'secondary server 2' ready (init)&quot;,
<a name="34712"/>34712:            cmd  =&gt; fun(#{sec_server2 := Pid} = _State) -&gt;
<a name="34713"/>34713:                            ok = ?SEV_AWAIT_READY(Pid, sec_server2, init)
<a name="34714"/>34714:                    end},
<a name="34715"/>34715: 
<a name="34716"/>34716:          %% Start the secondary server 3
<a name="34717"/>34717:          #{desc =&gt; &quot;order 'secondary server 3' start&quot;,
<a name="34718"/>34718:            cmd  =&gt; fun(#{sec_server3 := Pid, sock := Sock} = _State) -&gt;
<a name="34719"/>34719:                            ?SEV_ANNOUNCE_START(Pid, Sock),
<a name="34720"/>34720:                            ok
<a name="34721"/>34721:                    end},
<a name="34722"/>34722:          #{desc =&gt; &quot;await 'secondary server 3' ready (init)&quot;,
<a name="34723"/>34723:            cmd  =&gt; fun(#{sec_server3 := Pid} = _State) -&gt;
<a name="34724"/>34724:                            ok = ?SEV_AWAIT_READY(Pid, sec_server3, init)
<a name="34725"/>34725:                    end},
<a name="34726"/>34726: 
<a name="34727"/>34727: 
<a name="34728"/>34728:          %% The actual test
<a name="34729"/>34729:          %% Make all the seondary servers continue, with an infinite recvfrom
<a name="34730"/>34730:          %% and then the prim-server with a timed recvfrom.
<a name="34731"/>34731:          %% After the prim server notifies us (about the timeout) we order it
<a name="34732"/>34732:          %% to close the socket, which should cause the all the secondary 
<a name="34733"/>34733:          %% server to return with error-closed.
<a name="34734"/>34734: 
<a name="34735"/>34735:          #{desc =&gt; &quot;order 'secondary server 1' to continue (recv)&quot;,
<a name="34736"/>34736:            cmd  =&gt; fun(#{sec_server1 := Pid} = _State) -&gt;
<a name="34737"/>34737:                            ?SEV_ANNOUNCE_CONTINUE(Pid, recv),
<a name="34738"/>34738:                            ok
<a name="34739"/>34739:                    end},
<a name="34740"/>34740:          ?SEV_SLEEP(?SECS(1)),
<a name="34741"/>34741:          #{desc =&gt; &quot;order 'secondary server 2' to continue (recv)&quot;,
<a name="34742"/>34742:            cmd  =&gt; fun(#{sec_server2 := Pid} = _State) -&gt;
<a name="34743"/>34743:                            ?SEV_ANNOUNCE_CONTINUE(Pid, recv),
<a name="34744"/>34744:                            ok
<a name="34745"/>34745:                    end},
<a name="34746"/>34746:          ?SEV_SLEEP(?SECS(1)),
<a name="34747"/>34747:          #{desc =&gt; &quot;order 'secondary server 3' to continue (recv)&quot;,
<a name="34748"/>34748:            cmd  =&gt; fun(#{sec_server3 := Pid} = _State) -&gt;
<a name="34749"/>34749:                            ?SEV_ANNOUNCE_CONTINUE(Pid, recv),
<a name="34750"/>34750:                            ok
<a name="34751"/>34751:                    end},
<a name="34752"/>34752:          ?SEV_SLEEP(?SECS(1)),
<a name="34753"/>34753:          #{desc =&gt; &quot;order 'primary server' to continue (recv, with timeout)&quot;,
<a name="34754"/>34754:            cmd  =&gt; fun(#{prim_server := Pid} = _State) -&gt;
<a name="34755"/>34755:                            ?SEV_ANNOUNCE_CONTINUE(Pid, recv, ?SECS(5)),
<a name="34756"/>34756:                            ok
<a name="34757"/>34757:                    end},
<a name="34758"/>34758:          #{desc =&gt; &quot;await 'primary server' ready (recv, with timeout)&quot;,
<a name="34759"/>34759:            cmd  =&gt; fun(#{prim_server := Pid} = _State) -&gt;
<a name="34760"/>34760:                            ?SEV_AWAIT_READY(Pid, prim_server, recv)
<a name="34761"/>34761:                    end},
<a name="34762"/>34762:          #{desc =&gt; &quot;order 'primary server' to continue (close)&quot;,
<a name="34763"/>34763:            cmd  =&gt; fun(#{prim_server := Pid} = _State) -&gt;
<a name="34764"/>34764:                            ?SEV_ANNOUNCE_CONTINUE(Pid, close),
<a name="34765"/>34765:                            ok
<a name="34766"/>34766:                    end},
<a name="34767"/>34767:          #{desc =&gt; &quot;await 'primary server' ready (close)&quot;,
<a name="34768"/>34768:            cmd  =&gt; fun(#{prim_server := Pid} = _State) -&gt;
<a name="34769"/>34769:                            ?SEV_AWAIT_READY(Pid, prim_server, close)
<a name="34770"/>34770:                    end},
<a name="34771"/>34771:          #{desc =&gt; &quot;await 'secondary server 1' ready (closed)&quot;,
<a name="34772"/>34772:            cmd  =&gt; fun(#{sec_server1 := Pid} = _State) -&gt;
<a name="34773"/>34773:                            ?SEV_AWAIT_READY(Pid, sec_server1, recv_closed)
<a name="34774"/>34774:                    end},
<a name="34775"/>34775:          #{desc =&gt; &quot;await 'secondary server 2' ready (closed)&quot;,
<a name="34776"/>34776:            cmd  =&gt; fun(#{sec_server2 := Pid} = _State) -&gt;
<a name="34777"/>34777:                            ?SEV_AWAIT_READY(Pid, sec_server2, recv_closed)
<a name="34778"/>34778:                    end},
<a name="34779"/>34779:          #{desc =&gt; &quot;await 'secondary server 3' ready (closed)&quot;,
<a name="34780"/>34780:            cmd  =&gt; fun(#{sec_server3 := Pid} = _State) -&gt;
<a name="34781"/>34781:                            ?SEV_AWAIT_READY(Pid, sec_server3, recv_closed)
<a name="34782"/>34782:                    end},
<a name="34783"/>34783: 
<a name="34784"/>34784:          %% Terminations
<a name="34785"/>34785:          #{desc =&gt; &quot;order 'secondary server 3' to terminate&quot;,
<a name="34786"/>34786:            cmd  =&gt; fun(#{sec_server3 := Pid} = _State) -&gt;
<a name="34787"/>34787:                            ?SEV_ANNOUNCE_TERMINATE(Pid),
<a name="34788"/>34788:                            ok
<a name="34789"/>34789:                    end},
<a name="34790"/>34790:          #{desc =&gt; &quot;await 'secondary server 3' termination&quot;,
<a name="34791"/>34791:            cmd  =&gt; fun(#{sec_server3 := Pid} = State) -&gt;
<a name="34792"/>34792:                            case ?SEV_AWAIT_TERMINATION(Pid) of
<a name="34793"/>34793:                                ok -&gt;
<a name="34794"/>34794:                                    {ok, maps:remove(sec_server3, State)};
<a name="34795"/>34795:                                {error, _} = ERROR -&gt;
<a name="34796"/>34796:                                    ERROR
<a name="34797"/>34797:                            end
<a name="34798"/>34798:                    end},
<a name="34799"/>34799:          #{desc =&gt; &quot;order 'secondary server 2' to terminate&quot;,
<a name="34800"/>34800:            cmd  =&gt; fun(#{sec_server2 := Pid} = _State) -&gt;
<a name="34801"/>34801:                            ?SEV_ANNOUNCE_TERMINATE(Pid),
<a name="34802"/>34802:                            ok
<a name="34803"/>34803:                    end},
<a name="34804"/>34804:          #{desc =&gt; &quot;await 'secondary server 2' termination&quot;,
<a name="34805"/>34805:            cmd  =&gt; fun(#{sec_server2 := Pid} = State) -&gt;
<a name="34806"/>34806:                            case ?SEV_AWAIT_TERMINATION(Pid) of
<a name="34807"/>34807:                                ok -&gt;
<a name="34808"/>34808:                                    {ok, maps:remove(sec_server2, State)};
<a name="34809"/>34809:                                {error, _} = ERROR -&gt;
<a name="34810"/>34810:                                    ERROR
<a name="34811"/>34811:                            end
<a name="34812"/>34812:                    end},
<a name="34813"/>34813:          #{desc =&gt; &quot;order 'secondary server 1' to terminate&quot;,
<a name="34814"/>34814:            cmd  =&gt; fun(#{sec_server1 := Pid} = _State) -&gt;
<a name="34815"/>34815:                            ?SEV_ANNOUNCE_TERMINATE(Pid),
<a name="34816"/>34816:                            ok
<a name="34817"/>34817:                    end},
<a name="34818"/>34818:          #{desc =&gt; &quot;await 'secondary server 1' termination&quot;,
<a name="34819"/>34819:            cmd  =&gt; fun(#{sec_server1 := Pid} = State) -&gt;
<a name="34820"/>34820:                            case ?SEV_AWAIT_TERMINATION(Pid) of
<a name="34821"/>34821:                                ok -&gt;
<a name="34822"/>34822:                                    {ok, maps:remove(sec_server1, State)};
<a name="34823"/>34823:                                {error, _} = ERROR -&gt;
<a name="34824"/>34824:                                    ERROR
<a name="34825"/>34825:                            end
<a name="34826"/>34826:                    end},
<a name="34827"/>34827:          #{desc =&gt; &quot;order 'primary server' to terminate&quot;,
<a name="34828"/>34828:            cmd  =&gt; fun(#{prim_server := Pid} = _State) -&gt;
<a name="34829"/>34829:                            ?SEV_ANNOUNCE_TERMINATE(Pid),
<a name="34830"/>34830:                            ok
<a name="34831"/>34831:                    end},
<a name="34832"/>34832:          #{desc =&gt; &quot;await 'primary server' termination&quot;,
<a name="34833"/>34833:            cmd  =&gt; fun(#{prim_server := Pid} = State) -&gt;
<a name="34834"/>34834:                            case ?SEV_AWAIT_TERMINATION(Pid) of
<a name="34835"/>34835:                                ok -&gt;
<a name="34836"/>34836:                                    {ok, maps:remove(prim_server, State)};
<a name="34837"/>34837:                                {error, _} = ERROR -&gt;
<a name="34838"/>34838:                                    ERROR
<a name="34839"/>34839:                            end
<a name="34840"/>34840:                    end},
<a name="34841"/>34841: 
<a name="34842"/>34842: 
<a name="34843"/>34843:          %% *** We are done ***
<a name="34844"/>34844:          ?SEV_FINISH_NORMAL
<a name="34845"/>34845:         ],
<a name="34846"/>34846:     
<a name="34847"/>34847: 
<a name="34848"/>34848:     i(&quot;start 'primary server' evaluator&quot;),
<a name="34849"/>34849:     PrimSrvInitState = InitState,
<a name="34850"/>34850:     PrimServer = ?SEV_START(&quot;prim-server&quot;, PrimServerSeq, PrimSrvInitState),
<a name="34851"/>34851: 
<a name="34852"/>34852:     i(&quot;start 'secondary server 1' evaluator&quot;),
<a name="34853"/>34853:     SecSrvInitState = #{recv =&gt; maps:get(recv, InitState)},
<a name="34854"/>34854:     SecServer1 = ?SEV_START(&quot;sec-server-1&quot;, SecServerSeq, SecSrvInitState),
<a name="34855"/>34855: 
<a name="34856"/>34856:     i(&quot;start 'secondary server 2' evaluator&quot;),
<a name="34857"/>34857:     SecServer2 = ?SEV_START(&quot;sec-server-2&quot;, SecServerSeq, SecSrvInitState),
<a name="34858"/>34858: 
<a name="34859"/>34859:     i(&quot;start 'secondary server 3' evaluator&quot;),
<a name="34860"/>34860:     SecServer3 = ?SEV_START(&quot;sec-server-3&quot;, SecServerSeq, SecSrvInitState),
<a name="34861"/>34861: 
<a name="34862"/>34862:     i(&quot;start 'tester' evaluator&quot;),
<a name="34863"/>34863:     TesterInitState = #{prim_server =&gt; PrimServer#ev.pid,
<a name="34864"/>34864:                         sec_server1 =&gt; SecServer1#ev.pid,
<a name="34865"/>34865:                         sec_server2 =&gt; SecServer2#ev.pid,
<a name="34866"/>34866:                         sec_server3 =&gt; SecServer3#ev.pid},
<a name="34867"/>34867:     Tester = ?SEV_START(&quot;tester&quot;, TesterSeq, TesterInitState),
<a name="34868"/>34868: 
<a name="34869"/>34869:     i(&quot;await evaluator&quot;),
<a name="sc_lc_receive_response_udp-last_expr"/><a name="34870"/>34870: <b>    ok = ?SEV_AWAIT_FINISH</b>([PrimServer, 
<a name="34871"/>34871:                             SecServer1, SecServer2, SecServer3,
<a name="34872"/>34872:                             Tester]).
<a name="34873"/>34873: 
<a name="34874"/>34874: 
<a name="34875"/>34875: 
<a name="34876"/>34876: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="34877"/>34877: <i>%% This test case is intended to test what happens when a socket is </i>
<a name="34878"/>34878: <i>%% locally closed while the process is calling the recvmsg function.</i>
<a name="34879"/>34879: <i>%% Socket is IPv4.</i>
<a name="34880"/>34880: 
<a name="sc_lc_recvmsg_response_tcp4-1"/><a name="34881"/>34881: <b>sc_lc_recvmsg_response_tcp4</b>(_Config) when is_list(_Config) -&gt;
<a name="34882"/>34882:     ?TT(?SECS(10)),
<a name="sc_lc_recvmsg_response_tcp4-last_expr"/><a name="34883"/>34883: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="34884"/>34884:            fun() -&gt;
<a name="34885"/>34885:                    is_not_windows(), % recvmsg does not work on Windows
<a name="34886"/>34886:                    has_support_ipv4()
<a name="34887"/>34887:            end,
<a name="34888"/>34888:            fun() -&gt;
<a name="34889"/>34889:                    Recv      = fun(Sock) -&gt; socket:recvmsg(Sock) end,
<a name="34890"/>34890:                    InitState = #{domain   =&gt; inet,
<a name="34891"/>34891:                                  protocol =&gt; tcp,
<a name="34892"/>34892:                                  recv     =&gt; Recv},
<a name="34893"/>34893:                    ok = sc_lc_receive_response_tcp(InitState)
<a name="34894"/>34894:            end).
<a name="34895"/>34895: 
<a name="34896"/>34896: 
<a name="34897"/>34897: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="34898"/>34898: <i>%% This test case is intended to test what happens when a socket is </i>
<a name="34899"/>34899: <i>%% locally closed while the process is calling the recvmsg function.</i>
<a name="34900"/>34900: <i>%% Socket is IPv6.</i>
<a name="34901"/>34901: 
<a name="sc_lc_recvmsg_response_tcp6-1"/><a name="34902"/>34902: <b>sc_lc_recvmsg_response_tcp6</b>(_Config) when is_list(_Config) -&gt;
<a name="34903"/>34903:     ?TT(?SECS(10)),
<a name="sc_lc_recvmsg_response_tcp6-last_expr"/><a name="34904"/>34904: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="34905"/>34905:            fun() -&gt;
<a name="34906"/>34906:                    is_not_windows(), % recvmsg does not work on Windows
<a name="34907"/>34907:                    has_support_ipv6()
<a name="34908"/>34908:            end,
<a name="34909"/>34909:            fun() -&gt;
<a name="34910"/>34910:                    Recv      = fun(Sock) -&gt; socket:recvmsg(Sock) end,
<a name="34911"/>34911:                    InitState = #{domain   =&gt; inet6,
<a name="34912"/>34912:                                  protocol =&gt; tcp,
<a name="34913"/>34913:                                  recv     =&gt; Recv},
<a name="34914"/>34914:                    ok = sc_lc_receive_response_tcp(InitState)
<a name="34915"/>34915:            end).
<a name="34916"/>34916: 
<a name="34917"/>34917: 
<a name="34918"/>34918: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="34919"/>34919: <i>%% This test case is intended to test what happens when a socket is </i>
<a name="34920"/>34920: <i>%% locally closed while the process is calling the recvmsg function.</i>
<a name="34921"/>34921: <i>%% Socket is Unix Domain (stream) socket.</i>
<a name="34922"/>34922: 
<a name="sc_lc_recvmsg_response_tcpL-1"/><a name="34923"/>34923: <b>sc_lc_recvmsg_response_tcpL</b>(_Config) when is_list(_Config) -&gt;
<a name="34924"/>34924:     ?TT(?SECS(10)),
<a name="sc_lc_recvmsg_response_tcpL-last_expr"/><a name="34925"/>34925: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="34926"/>34926:            fun() -&gt;
<a name="34927"/>34927:                    is_not_windows(), % recvmsg does not work on Windows
<a name="34928"/>34928:                    has_support_unix_domain_socket()
<a name="34929"/>34929:            end,
<a name="34930"/>34930:            fun() -&gt;
<a name="34931"/>34931:                    Recv      = fun(Sock) -&gt; socket:recvmsg(Sock) end,
<a name="34932"/>34932:                    InitState = #{domain   =&gt; local,
<a name="34933"/>34933:                                  protocol =&gt; default,
<a name="34934"/>34934:                                  recv     =&gt; Recv},
<a name="34935"/>34935:                    ok = sc_lc_receive_response_tcp(InitState)
<a name="34936"/>34936:            end).
<a name="34937"/>34937: 
<a name="34938"/>34938: 
<a name="34939"/>34939: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="34940"/>34940: <i>%% This test case is intended to test what happens when a socket is </i>
<a name="34941"/>34941: <i>%% locally closed while the process is calling the recvmsg function.</i>
<a name="34942"/>34942: <i>%% Socket is IPv4.</i>
<a name="34943"/>34943: 
<a name="sc_lc_recvmsg_response_udp4-1"/><a name="34944"/>34944: <b>sc_lc_recvmsg_response_udp4</b>(_Config) when is_list(_Config) -&gt;
<a name="sc_lc_recvmsg_response_udp4-last_expr"/><a name="34945"/>34945: <b>    tc_try</b>(sc_lc_recvmsg_response_udp4,
<a name="34946"/>34946:            fun() -&gt; has_support_ipv4() end,
<a name="34947"/>34947:            fun() -&gt;
<a name="34948"/>34948:                    ?TT(?SECS(10)),
<a name="34949"/>34949:                    Recv      = fun(Sock, To) -&gt; socket:recvmsg(Sock, To) end,
<a name="34950"/>34950:                    InitState = #{domain   =&gt; inet,
<a name="34951"/>34951:                                  protocol =&gt; udp,
<a name="34952"/>34952:                                  recv     =&gt; Recv},
<a name="34953"/>34953:                    ok = sc_lc_receive_response_udp(InitState)
<a name="34954"/>34954:            end).
<a name="34955"/>34955: 
<a name="34956"/>34956: 
<a name="34957"/>34957: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="34958"/>34958: <i>%% This test case is intended to test what happens when a socket is </i>
<a name="34959"/>34959: <i>%% locally closed while the process is calling the recvmsg function.</i>
<a name="34960"/>34960: <i>%% Socket is IPv6.</i>
<a name="34961"/>34961: 
<a name="sc_lc_recvmsg_response_udp6-1"/><a name="34962"/>34962: <b>sc_lc_recvmsg_response_udp6</b>(_Config) when is_list(_Config) -&gt;
<a name="sc_lc_recvmsg_response_udp6-last_expr"/><a name="34963"/>34963: <b>    tc_try</b>(sc_recvmsg_response_udp6,
<a name="34964"/>34964:            fun() -&gt; has_support_ipv6() end,
<a name="34965"/>34965:            fun() -&gt;
<a name="34966"/>34966:                    ?TT(?SECS(10)),
<a name="34967"/>34967:                    Recv      = fun(Sock, To) -&gt; socket:recvmsg(Sock, To) end,
<a name="34968"/>34968:                    InitState = #{domain   =&gt; inet6,
<a name="34969"/>34969:                                  protocol =&gt; udp,
<a name="34970"/>34970:                                  recv     =&gt; Recv},
<a name="34971"/>34971:                    ok = sc_lc_receive_response_udp(InitState)
<a name="34972"/>34972:            end).
<a name="34973"/>34973: 
<a name="34974"/>34974: 
<a name="34975"/>34975: 
<a name="34976"/>34976: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="34977"/>34977: <i>%% This test case is intended to test what happens when a socket is </i>
<a name="34978"/>34978: <i>%% locally closed while the process is calling the recvmsg function.</i>
<a name="34979"/>34979: <i>%% Socket is Unix Domain (dgram) socket.</i>
<a name="34980"/>34980: 
<a name="sc_lc_recvmsg_response_udpL-1"/><a name="34981"/>34981: <b>sc_lc_recvmsg_response_udpL</b>(_Config) when is_list(_Config) -&gt;
<a name="34982"/>34982:     ?TT(?SECS(10)),
<a name="sc_lc_recvmsg_response_udpL-last_expr"/><a name="34983"/>34983: <b>    tc_try</b>(sc_recvmsg_response_udpL,
<a name="34984"/>34984:            fun() -&gt;
<a name="34985"/>34985: 		   has_support_unix_domain_socket(),
<a name="34986"/>34986: 		   is_not_windows()
<a name="34987"/>34987: 	   end,
<a name="34988"/>34988:            fun() -&gt;
<a name="34989"/>34989:                    Recv      = fun(Sock, To) -&gt; socket:recvmsg(Sock, To) end,
<a name="34990"/>34990:                    InitState = #{domain   =&gt; local,
<a name="34991"/>34991:                                  protocol =&gt; default,
<a name="34992"/>34992:                                  recv     =&gt; Recv},
<a name="34993"/>34993:                    ok = sc_lc_receive_response_udp(InitState)
<a name="34994"/>34994:            end).
<a name="34995"/>34995: 
<a name="34996"/>34996: 
<a name="34997"/>34997: 
<a name="34998"/>34998: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="34999"/>34999: <i>%% This test case is intended to test what happens when a socket is </i>
<a name="35000"/>35000: <i>%% locally closed while the process is calling the accept function.</i>
<a name="35001"/>35001: <i>%% We test what happens with a non-controlling_process also, since we </i>
<a name="35002"/>35002: <i>%% git the setup anyway.</i>
<a name="35003"/>35003: <i>%% Socket is IPv4.</i>
<a name="35004"/>35004: 
<a name="sc_lc_acceptor_response_tcp4-1"/><a name="35005"/>35005: <b>sc_lc_acceptor_response_tcp4</b>(_Config) when is_list(_Config) -&gt;
<a name="35006"/>35006:     ?TT(?SECS(10)),
<a name="sc_lc_acceptor_response_tcp4-last_expr"/><a name="35007"/>35007: <b>    tc_try</b>(sc_lc_acceptor_response_tcp4,
<a name="35008"/>35008:            fun() -&gt; has_support_ipv4() end,
<a name="35009"/>35009:            fun() -&gt;
<a name="35010"/>35010:                    InitState = #{domain   =&gt; inet,
<a name="35011"/>35011:                                  protocol =&gt; tcp},
<a name="35012"/>35012:                    ok = sc_lc_acceptor_response_tcp(InitState)
<a name="35013"/>35013:            end).
<a name="35014"/>35014: 
<a name="35015"/>35015: 
<a name="35016"/>35016: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="35017"/>35017: <i>%% This test case is intended to test what happens when a socket is </i>
<a name="35018"/>35018: <i>%% locally closed while the process is calling the accept function.</i>
<a name="35019"/>35019: <i>%% We test what happens with a non-controlling_process also, since we </i>
<a name="35020"/>35020: <i>%% git the setup anyway.</i>
<a name="35021"/>35021: <i>%% Socket is IPv6.</i>
<a name="35022"/>35022: 
<a name="sc_lc_acceptor_response_tcp6-1"/><a name="35023"/>35023: <b>sc_lc_acceptor_response_tcp6</b>(_Config) when is_list(_Config) -&gt;
<a name="35024"/>35024:     ?TT(?SECS(10)),
<a name="sc_lc_acceptor_response_tcp6-last_expr"/><a name="35025"/>35025: <b>    tc_try</b>(sc_lc_acceptor_response_tcp6,
<a name="35026"/>35026:            fun() -&gt; has_support_ipv6() end,
<a name="35027"/>35027:            fun() -&gt;
<a name="35028"/>35028:                    InitState = #{domain   =&gt; inet6,
<a name="35029"/>35029:                                  protocol =&gt; tcp},
<a name="35030"/>35030:                    ok = sc_lc_acceptor_response_tcp(InitState)
<a name="35031"/>35031:            end).
<a name="35032"/>35032: 
<a name="35033"/>35033: 
<a name="35034"/>35034: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="35035"/>35035: <i>%% This test case is intended to test what happens when a socket is </i>
<a name="35036"/>35036: <i>%% locally closed while the process is calling the accept function.</i>
<a name="35037"/>35037: <i>%% We test what happens with a non-controlling_process also, since we </i>
<a name="35038"/>35038: <i>%% git the setup anyway.</i>
<a name="35039"/>35039: <i>%% Socket is Unix Domain (stream) socket.</i>
<a name="35040"/>35040: 
<a name="sc_lc_acceptor_response_tcpL-1"/><a name="35041"/>35041: <b>sc_lc_acceptor_response_tcpL</b>(_Config) when is_list(_Config) -&gt;
<a name="35042"/>35042:     ?TT(?SECS(10)),
<a name="sc_lc_acceptor_response_tcpL-last_expr"/><a name="35043"/>35043: <b>    tc_try</b>(sc_lc_acceptor_response_tcpL,
<a name="35044"/>35044:            fun() -&gt; has_support_unix_domain_socket() end,
<a name="35045"/>35045:            fun() -&gt;
<a name="35046"/>35046:                    InitState = #{domain   =&gt; local,
<a name="35047"/>35047:                                  protocol =&gt; default},
<a name="35048"/>35048:                    ok = sc_lc_acceptor_response_tcp(InitState)
<a name="35049"/>35049:            end).
<a name="35050"/>35050: 
<a name="35051"/>35051: 
<a name="35052"/>35052: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="35053"/>35053: 
<a name="sc_lc_acceptor_response_tcp-1"/><a name="35054"/>35054: <b>sc_lc_acceptor_response_tcp</b>(InitState) -&gt;
<a name="35055"/>35055:     PrimAcceptorSeq =
<a name="35056"/>35056:         [
<a name="35057"/>35057:          %% *** Wait for start order part ***
<a name="35058"/>35058:          #{desc =&gt; &quot;await start (from tester)&quot;,
<a name="35059"/>35059:            cmd  =&gt; fun(State) -&gt;
<a name="35060"/>35060:                            Tester = ?SEV_AWAIT_START(),
<a name="35061"/>35061:                            {ok, State#{tester =&gt; Tester}}
<a name="35062"/>35062:                    end},
<a name="35063"/>35063:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="35064"/>35064:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="35065"/>35065:                            _MRef = erlang:monitor(process, Tester),
<a name="35066"/>35066:                            ok
<a name="35067"/>35067:                    end},
<a name="35068"/>35068: 
<a name="35069"/>35069:          %% *** Init part ***
<a name="35070"/>35070:          #{desc =&gt; &quot;which local address&quot;,
<a name="35071"/>35071:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="35072"/>35072:                            LSA = which_local_socket_addr(Domain),
<a name="35073"/>35073:                            {ok, State#{lsa =&gt; LSA}}
<a name="35074"/>35074:                    end},
<a name="35075"/>35075:          #{desc =&gt; &quot;create (listen) socket&quot;,
<a name="35076"/>35076:            cmd  =&gt; fun(#{domain   := Domain, 
<a name="35077"/>35077:                          protocol := Proto} = State) -&gt;
<a name="35078"/>35078:                            case socket:open(Domain, stream, Proto) of
<a name="35079"/>35079:                                {ok, Sock} -&gt;
<a name="35080"/>35080:                                    {ok, State#{sock =&gt; Sock}};
<a name="35081"/>35081:                                {error, _} = ERROR -&gt;
<a name="35082"/>35082:                                    ERROR
<a name="35083"/>35083:                            end
<a name="35084"/>35084:                    end},
<a name="35085"/>35085:          #{desc =&gt; &quot;bind to local address&quot;,
<a name="35086"/>35086:            cmd  =&gt; fun(#{sock := Sock, lsa := LSA} = _State) -&gt;
<a name="35087"/>35087:                            case sock_bind(Sock, LSA) of
<a name="35088"/>35088:                                ok -&gt;
<a name="35089"/>35089:                                    ok;
<a name="35090"/>35090:                                {error, _} = ERROR -&gt;
<a name="35091"/>35091:                                    ERROR
<a name="35092"/>35092:                            end
<a name="35093"/>35093:                    end},
<a name="35094"/>35094:          #{desc =&gt; &quot;make listen socket&quot;,
<a name="35095"/>35095:            cmd  =&gt; fun(#{sock := Sock}) -&gt;
<a name="35096"/>35096:                            socket:listen(Sock)
<a name="35097"/>35097:                    end},
<a name="35098"/>35098:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="35099"/>35099:            cmd  =&gt; fun(#{tester := Tester, sock := Sock} = _State) -&gt;
<a name="35100"/>35100:                            ?SEV_ANNOUNCE_READY(Tester, init, Sock),
<a name="35101"/>35101:                            ok
<a name="35102"/>35102:                    end},
<a name="35103"/>35103: 
<a name="35104"/>35104:          %% The actual test
<a name="35105"/>35105:          #{desc =&gt; &quot;await continue (accept)&quot;,
<a name="35106"/>35106:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="35107"/>35107:                            case ?SEV_AWAIT_CONTINUE(Tester, tester, accept) of
<a name="35108"/>35108:                                {ok, Timeout} -&gt;
<a name="35109"/>35109:                                    {ok, State#{timeout =&gt; Timeout}};
<a name="35110"/>35110:                                {error, _} = ERROR -&gt;
<a name="35111"/>35111:                                    ERROR
<a name="35112"/>35112:                            end
<a name="35113"/>35113:                    end},
<a name="35114"/>35114:          #{desc =&gt; &quot;await connection&quot;,
<a name="35115"/>35115:            cmd  =&gt; fun(#{sock := LSock, timeout := Timeout} = _State) -&gt;
<a name="35116"/>35116:                            case socket:accept(LSock, Timeout) of
<a name="35117"/>35117:                                {error, timeout} -&gt;
<a name="35118"/>35118:                                    ok;
<a name="35119"/>35119:                                {ok, Sock} -&gt;
<a name="35120"/>35120:                                    ?SEV_EPRINT(&quot;unexpected success&quot;),
<a name="35121"/>35121:                                    (catch socket:close(Sock)),
<a name="35122"/>35122:                                    {error, unexpected_success};
<a name="35123"/>35123:                                {error, _} = ERROR -&gt;
<a name="35124"/>35124:                                    ERROR
<a name="35125"/>35125:                            end
<a name="35126"/>35126:                    end},
<a name="35127"/>35127:          #{desc =&gt; &quot;announce ready (accept timeout)&quot;,
<a name="35128"/>35128:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="35129"/>35129:                            ?SEV_ANNOUNCE_READY(Tester, accept_timeout),
<a name="35130"/>35130:                            ok
<a name="35131"/>35131:                    end},
<a name="35132"/>35132:          #{desc =&gt; &quot;await continue (close)&quot;,
<a name="35133"/>35133:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="35134"/>35134:                            ok = ?SEV_AWAIT_CONTINUE(Tester, tester, close)
<a name="35135"/>35135:                    end},
<a name="35136"/>35136:          #{desc =&gt; &quot;close socket&quot;,
<a name="35137"/>35137:            cmd  =&gt; fun(#{domain := local,
<a name="35138"/>35138:                          sock   := Sock,
<a name="35139"/>35139:                          lsa    := #{path := Path}} = State) -&gt;
<a name="35140"/>35140:                            case socket:close(Sock) of
<a name="35141"/>35141:                                ok -&gt;
<a name="35142"/>35142:                                    State1 =
<a name="35143"/>35143:                                        unlink_path(Path,
<a name="35144"/>35144:                                                    fun() -&gt;
<a name="35145"/>35145:                                                            maps:remove(lsa, State)
<a name="35146"/>35146:                                                    end,
<a name="35147"/>35147:                                                    fun() -&gt;
<a name="35148"/>35148:                                                            State
<a name="35149"/>35149:                                                    end),
<a name="35150"/>35150:                                    {ok, maps:remove(sock, State1)};
<a name="35151"/>35151:                                {error, _} = ERROR -&gt;
<a name="35152"/>35152:                                    unlink_path(Path),
<a name="35153"/>35153:                                    ERROR
<a name="35154"/>35154:                            end;
<a name="35155"/>35155:                       (#{sock := Sock} = State) -&gt;
<a name="35156"/>35156:                            case socket:close(Sock) of
<a name="35157"/>35157:                                ok -&gt;
<a name="35158"/>35158:                                    {ok, maps:remove(sock, State)};
<a name="35159"/>35159:                                {error, _} = ERROR -&gt;
<a name="35160"/>35160:                                    ERROR
<a name="35161"/>35161:                            end
<a name="35162"/>35162:                    end},
<a name="35163"/>35163:          #{desc =&gt; &quot;announce ready (close)&quot;,
<a name="35164"/>35164:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="35165"/>35165:                            ?SEV_ANNOUNCE_READY(Tester, close),
<a name="35166"/>35166:                            ok
<a name="35167"/>35167:                    end},
<a name="35168"/>35168: 
<a name="35169"/>35169:                                                 % Termination
<a name="35170"/>35170:          #{desc =&gt; &quot;await terminate&quot;,
<a name="35171"/>35171:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="35172"/>35172:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="35173"/>35173:                                ok -&gt;
<a name="35174"/>35174:                                    {ok, maps:remove(tester, State)};
<a name="35175"/>35175:                                {error, _} = ERROR -&gt;
<a name="35176"/>35176:                                    ERROR
<a name="35177"/>35177:                            end
<a name="35178"/>35178:                    end},
<a name="35179"/>35179: 
<a name="35180"/>35180:          %% *** We are done ***
<a name="35181"/>35181:          ?SEV_FINISH_NORMAL
<a name="35182"/>35182:         ],
<a name="35183"/>35183: 
<a name="35184"/>35184:     SecAcceptorSeq =
<a name="35185"/>35185:         [
<a name="35186"/>35186:          %% *** Init part ***
<a name="35187"/>35187:          #{desc =&gt; &quot;await start&quot;,
<a name="35188"/>35188:            cmd  =&gt; fun(State) -&gt;
<a name="35189"/>35189:                            {Tester, Sock} = ?SEV_AWAIT_START(),
<a name="35190"/>35190:                            {ok, State#{tester =&gt; Tester, sock =&gt; Sock}}
<a name="35191"/>35191:                    end},
<a name="35192"/>35192:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="35193"/>35193:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="35194"/>35194:                            _MRef = erlang:monitor(process, Tester),
<a name="35195"/>35195:                            ok
<a name="35196"/>35196:                    end},
<a name="35197"/>35197:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="35198"/>35198:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="35199"/>35199:                            ?SEV_ANNOUNCE_READY(Tester, init)
<a name="35200"/>35200:                    end},
<a name="35201"/>35201: 
<a name="35202"/>35202:          %% The actual test
<a name="35203"/>35203:          #{desc =&gt; &quot;await continue (accept)&quot;,
<a name="35204"/>35204:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="35205"/>35205:                            ok = ?SEV_AWAIT_CONTINUE(Tester, tester, accept)
<a name="35206"/>35206:                    end},
<a name="35207"/>35207:          #{desc =&gt; &quot;accept&quot;,
<a name="35208"/>35208:            cmd  =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="35209"/>35209:                            case socket:accept(Sock) of
<a name="35210"/>35210:                                {error, closed} -&gt;
<a name="35211"/>35211:                                    {ok, maps:remove(sock, State)};
<a name="35212"/>35212:                                {ok, _} -&gt;
<a name="35213"/>35213:                                    {error, unexpected_success};
<a name="35214"/>35214:                                {error, _} = ERROR -&gt;
<a name="35215"/>35215:                                    ERROR
<a name="35216"/>35216:                            end
<a name="35217"/>35217:                    end},
<a name="35218"/>35218:          #{desc =&gt; &quot;announce ready (accept closed)&quot;,
<a name="35219"/>35219:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="35220"/>35220:                            ?SEV_ANNOUNCE_READY(Tester, accept_closed)
<a name="35221"/>35221:                    end},
<a name="35222"/>35222: 
<a name="35223"/>35223:          %% Termination
<a name="35224"/>35224:          #{desc =&gt; &quot;await terminate (from tester)&quot;,
<a name="35225"/>35225:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="35226"/>35226:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="35227"/>35227:                                ok -&gt;
<a name="35228"/>35228:                                    {ok, maps:remove(tester, State)};
<a name="35229"/>35229:                                {error, _} = ERROR -&gt;
<a name="35230"/>35230:                                    ERROR
<a name="35231"/>35231:                            end
<a name="35232"/>35232:                    end},
<a name="35233"/>35233: 
<a name="35234"/>35234:          %% *** We are done ***
<a name="35235"/>35235:          ?SEV_FINISH_NORMAL
<a name="35236"/>35236:         ],
<a name="35237"/>35237: 
<a name="35238"/>35238:     TesterSeq =
<a name="35239"/>35239:         [
<a name="35240"/>35240:          %% *** Init part ***
<a name="35241"/>35241:          #{desc =&gt; &quot;monitor 'primary acceptor'&quot;,
<a name="35242"/>35242:            cmd  =&gt; fun(#{prim_acc := Pid} = _State) -&gt;
<a name="35243"/>35243:                            _MRef = erlang:monitor(process, Pid),
<a name="35244"/>35244:                            ok
<a name="35245"/>35245:                    end},
<a name="35246"/>35246:          #{desc =&gt; &quot;monitor 'secondary acceptor 1'&quot;,
<a name="35247"/>35247:            cmd  =&gt; fun(#{sec_acc1 := Pid} = _State) -&gt;
<a name="35248"/>35248:                            _MRef = erlang:monitor(process, Pid),
<a name="35249"/>35249:                            ok
<a name="35250"/>35250:                    end},
<a name="35251"/>35251:          #{desc =&gt; &quot;monitor secondary acceptor 2&quot;,
<a name="35252"/>35252:            cmd  =&gt; fun(#{sec_acc2 := Pid} = _State) -&gt;
<a name="35253"/>35253:                            _MRef = erlang:monitor(process, Pid),
<a name="35254"/>35254:                            ok
<a name="35255"/>35255:                    end},
<a name="35256"/>35256:          #{desc =&gt; &quot;monitor secondary acceptor 3&quot;,
<a name="35257"/>35257:            cmd  =&gt; fun(#{sec_acc3 := Pid} = _State) -&gt;
<a name="35258"/>35258:                            _MRef = erlang:monitor(process, Pid),
<a name="35259"/>35259:                            ok
<a name="35260"/>35260:                    end},
<a name="35261"/>35261: 
<a name="35262"/>35262:          %% Start the primary server
<a name="35263"/>35263:          #{desc =&gt; &quot;order 'primary acceptor' start&quot;,
<a name="35264"/>35264:            cmd  =&gt; fun(#{prim_acc := Pid} = _State) -&gt;
<a name="35265"/>35265:                            ?SEV_ANNOUNCE_START(Pid),
<a name="35266"/>35266:                            ok
<a name="35267"/>35267:                    end},
<a name="35268"/>35268:          #{desc =&gt; &quot;await 'primary acceptor' ready (init)&quot;,
<a name="35269"/>35269:            cmd  =&gt; fun(#{prim_acc := Pid} = State) -&gt;
<a name="35270"/>35270:                            {ok, Sock} = ?SEV_AWAIT_READY(Pid, prim_acc, init),
<a name="35271"/>35271:                            {ok, State#{sock =&gt; Sock}}
<a name="35272"/>35272:                    end},
<a name="35273"/>35273: 
<a name="35274"/>35274:          %% Start the secondary acceptor 1
<a name="35275"/>35275:          #{desc =&gt; &quot;order 'secondary acceptor 1' start&quot;,
<a name="35276"/>35276:            cmd  =&gt; fun(#{sec_acc1 := Pid, sock := Sock} = _State) -&gt;
<a name="35277"/>35277:                            ?SEV_ANNOUNCE_START(Pid, Sock),
<a name="35278"/>35278:                            ok
<a name="35279"/>35279:                    end},
<a name="35280"/>35280:          #{desc =&gt; &quot;await 'secondary acceptor 1' ready (init)&quot;,
<a name="35281"/>35281:            cmd  =&gt; fun(#{sec_acc1 := Pid} = _State) -&gt;
<a name="35282"/>35282:                            ok = ?SEV_AWAIT_READY(Pid, sec_acc1, init)
<a name="35283"/>35283:                    end},
<a name="35284"/>35284: 
<a name="35285"/>35285:          %% Start the secondary acceptor 2
<a name="35286"/>35286:          #{desc =&gt; &quot;order 'secondary acceptor 2' start&quot;,
<a name="35287"/>35287:            cmd  =&gt; fun(#{sec_acc2 := Pid, sock := Sock} = _State) -&gt;
<a name="35288"/>35288:                            ?SEV_ANNOUNCE_START(Pid, Sock),
<a name="35289"/>35289:                            ok
<a name="35290"/>35290:                    end},
<a name="35291"/>35291:          #{desc =&gt; &quot;await 'secondary acceptor 2' ready (init)&quot;,
<a name="35292"/>35292:            cmd  =&gt; fun(#{sec_acc2 := Pid} = _State) -&gt;
<a name="35293"/>35293:                            ok = ?SEV_AWAIT_READY(Pid, sec_acc2, init)
<a name="35294"/>35294:                    end},
<a name="35295"/>35295: 
<a name="35296"/>35296:          %% Start the secondary acceptor 3
<a name="35297"/>35297:          #{desc =&gt; &quot;order 'secondary acceptor 3' start&quot;,
<a name="35298"/>35298:            cmd  =&gt; fun(#{sec_acc3 := Pid, sock := Sock} = _State) -&gt;
<a name="35299"/>35299:                            ?SEV_ANNOUNCE_START(Pid, Sock),
<a name="35300"/>35300:                            ok
<a name="35301"/>35301:                    end},
<a name="35302"/>35302:          #{desc =&gt; &quot;await 'secondary acceptor 3' ready (init)&quot;,
<a name="35303"/>35303:            cmd  =&gt; fun(#{sec_acc3 := Pid} = _State) -&gt;
<a name="35304"/>35304:                            ok = ?SEV_AWAIT_READY(Pid, sec_acc3, init)
<a name="35305"/>35305:                    end},
<a name="35306"/>35306: 
<a name="35307"/>35307: 
<a name="35308"/>35308:          %% The actual test
<a name="35309"/>35309:          %% Make all the seondary servers continue, with an infinite recvfrom
<a name="35310"/>35310:          %% and then the prim-server with a timed recvfrom.
<a name="35311"/>35311:          %% After the prim server notifies us (about the timeout) we order it
<a name="35312"/>35312:          %% to close the socket, which should cause the all the secondary 
<a name="35313"/>35313:          %% server to return with error-closed.
<a name="35314"/>35314: 
<a name="35315"/>35315:          #{desc =&gt; &quot;order 'secondary acceptor 1' to continue (accept)&quot;,
<a name="35316"/>35316:            cmd  =&gt; fun(#{sec_acc1 := Pid} = _State) -&gt;
<a name="35317"/>35317:                            ?SEV_ANNOUNCE_CONTINUE(Pid, accept),
<a name="35318"/>35318:                            ok
<a name="35319"/>35319:                    end},
<a name="35320"/>35320:          ?SEV_SLEEP(?SECS(1)),
<a name="35321"/>35321:          #{desc =&gt; &quot;order 'secondary acceptor 2' to continue (accept)&quot;,
<a name="35322"/>35322:            cmd  =&gt; fun(#{sec_acc2 := Pid} = _State) -&gt;
<a name="35323"/>35323:                            ?SEV_ANNOUNCE_CONTINUE(Pid, accept),
<a name="35324"/>35324:                            ok
<a name="35325"/>35325:                    end},
<a name="35326"/>35326:          ?SEV_SLEEP(?SECS(1)),
<a name="35327"/>35327:          #{desc =&gt; &quot;order 'secondary acceptor 3' to continue (accept)&quot;,
<a name="35328"/>35328:            cmd  =&gt; fun(#{sec_acc3 := Pid} = _State) -&gt;
<a name="35329"/>35329:                            ?SEV_ANNOUNCE_CONTINUE(Pid, accept),
<a name="35330"/>35330:                            ok
<a name="35331"/>35331:                    end},
<a name="35332"/>35332:          ?SEV_SLEEP(?SECS(1)),
<a name="35333"/>35333:          #{desc =&gt; &quot;order 'primary acceptor' to continue&quot;,
<a name="35334"/>35334:            cmd  =&gt; fun(#{prim_acc := Pid} = _State) -&gt;
<a name="35335"/>35335:                            ?SEV_ANNOUNCE_CONTINUE(Pid, accept, ?SECS(5)),
<a name="35336"/>35336:                            ok
<a name="35337"/>35337:                    end},
<a name="35338"/>35338:          #{desc =&gt; &quot;await 'primary acceptor' ready (accept timeout)&quot;,
<a name="35339"/>35339:            cmd  =&gt; fun(#{prim_acc := Pid} = _State) -&gt;
<a name="35340"/>35340:                            ok = ?SEV_AWAIT_READY(Pid, prim_acc, accept_timeout)
<a name="35341"/>35341:                    end},
<a name="35342"/>35342:          #{desc =&gt; &quot;order 'primary acceptor' to continue (close)&quot;,
<a name="35343"/>35343:            cmd  =&gt; fun(#{prim_acc := Pid} = _State) -&gt;
<a name="35344"/>35344:                            ?SEV_ANNOUNCE_CONTINUE(Pid, close),
<a name="35345"/>35345:                            ok
<a name="35346"/>35346:                    end},
<a name="35347"/>35347:          #{desc =&gt; &quot;await 'primary acceptor' ready (close)&quot;,
<a name="35348"/>35348:            cmd  =&gt; fun(#{prim_acc := Pid} = _State) -&gt;
<a name="35349"/>35349:                            ok = ?SEV_AWAIT_READY(Pid, prim_acc, close)
<a name="35350"/>35350:                    end},
<a name="35351"/>35351:          #{desc =&gt; &quot;await 'secondary acceptor 1' ready (accept closed)&quot;,
<a name="35352"/>35352:            cmd  =&gt; fun(#{sec_acc1 := Pid} = _State) -&gt;
<a name="35353"/>35353:                            ok = ?SEV_AWAIT_READY(Pid, sec_acc1, accept_closed)
<a name="35354"/>35354:                    end},
<a name="35355"/>35355:          #{desc =&gt; &quot;await 'secondary acceptor 2' ready (accept closed)&quot;,
<a name="35356"/>35356:            cmd  =&gt; fun(#{sec_acc2 := Pid} = _State) -&gt;
<a name="35357"/>35357:                            ok = ?SEV_AWAIT_READY(Pid, sec_acc2, accept_closed)
<a name="35358"/>35358:                    end},
<a name="35359"/>35359:          #{desc =&gt; &quot;await 'secondary acceptor 3' ready (accept closed)&quot;,
<a name="35360"/>35360:            cmd  =&gt; fun(#{sec_acc3 := Pid} = _State) -&gt;
<a name="35361"/>35361:                            ok = ?SEV_AWAIT_READY(Pid, sec_acc3, accept_closed)
<a name="35362"/>35362:                    end},
<a name="35363"/>35363: 
<a name="35364"/>35364: 
<a name="35365"/>35365:          %% Terminations
<a name="35366"/>35366:          #{desc =&gt; &quot;order 'secondary acceptor 3' to terminate&quot;,
<a name="35367"/>35367:            cmd  =&gt; fun(#{sec_acc3 := Pid} = _State) -&gt;
<a name="35368"/>35368:                            ?SEV_ANNOUNCE_TERMINATE(Pid),
<a name="35369"/>35369:                            ok
<a name="35370"/>35370:                    end},
<a name="35371"/>35371:          #{desc =&gt; &quot;await 'secondary acceptor 3' termination&quot;,
<a name="35372"/>35372:            cmd  =&gt; fun(#{sec_acc3 := Pid} = State) -&gt;
<a name="35373"/>35373:                            case ?SEV_AWAIT_TERMINATION(Pid) of
<a name="35374"/>35374:                                ok -&gt;
<a name="35375"/>35375:                                    {ok, maps:remove(sec_acc3, State)};
<a name="35376"/>35376:                                {error, _} = ERROR -&gt;
<a name="35377"/>35377:                                    ERROR
<a name="35378"/>35378:                            end
<a name="35379"/>35379:                    end},
<a name="35380"/>35380:          #{desc =&gt; &quot;order 'secondary acceptor 2' to terminate&quot;,
<a name="35381"/>35381:            cmd  =&gt; fun(#{sec_acc2 := Pid} = _State) -&gt;
<a name="35382"/>35382:                            ?SEV_ANNOUNCE_TERMINATE(Pid),
<a name="35383"/>35383:                            ok
<a name="35384"/>35384:                    end},
<a name="35385"/>35385:          #{desc =&gt; &quot;await 'secondary acceptor 2' termination&quot;,
<a name="35386"/>35386:            cmd  =&gt; fun(#{sec_acc2 := Pid} = State) -&gt;
<a name="35387"/>35387:                            case ?SEV_AWAIT_TERMINATION(Pid) of
<a name="35388"/>35388:                                ok -&gt;
<a name="35389"/>35389:                                    {ok, maps:remove(sec_acc2, State)};
<a name="35390"/>35390:                                {error, _} = ERROR -&gt;
<a name="35391"/>35391:                                    ERROR
<a name="35392"/>35392:                            end
<a name="35393"/>35393:                    end},
<a name="35394"/>35394:          #{desc =&gt; &quot;order 'secondary acceptor 1' to terminate&quot;,
<a name="35395"/>35395:            cmd  =&gt; fun(#{sec_acc1 := Pid} = _State) -&gt;
<a name="35396"/>35396:                            ?SEV_ANNOUNCE_TERMINATE(Pid),
<a name="35397"/>35397:                            ok
<a name="35398"/>35398:                    end},
<a name="35399"/>35399:          #{desc =&gt; &quot;await 'secondary acceptor 1' termination&quot;,
<a name="35400"/>35400:            cmd  =&gt; fun(#{sec_acc1 := Pid} = State) -&gt;
<a name="35401"/>35401:                            case ?SEV_AWAIT_TERMINATION(Pid) of
<a name="35402"/>35402:                                ok -&gt;
<a name="35403"/>35403:                                    {ok, maps:remove(sec_acc1, State)};
<a name="35404"/>35404:                                {error, _} = ERROR -&gt;
<a name="35405"/>35405:                                    ERROR
<a name="35406"/>35406:                            end
<a name="35407"/>35407:                    end},
<a name="35408"/>35408:          #{desc =&gt; &quot;order 'primary acceptor' to terminate&quot;,
<a name="35409"/>35409:            cmd  =&gt; fun(#{prim_acc := Pid} = _State) -&gt;
<a name="35410"/>35410:                            ?SEV_ANNOUNCE_TERMINATE(Pid),
<a name="35411"/>35411:                            ok
<a name="35412"/>35412:                    end},
<a name="35413"/>35413:          #{desc =&gt; &quot;await 'primary acceptor' termination&quot;,
<a name="35414"/>35414:            cmd  =&gt; fun(#{prim_acc := Pid} = State) -&gt;
<a name="35415"/>35415:                            case ?SEV_AWAIT_TERMINATION(Pid) of
<a name="35416"/>35416:                                ok -&gt;
<a name="35417"/>35417:                                    {ok, maps:remove(prim_acc, State)};
<a name="35418"/>35418:                                {error, _} = ERROR -&gt;
<a name="35419"/>35419:                                    ERROR
<a name="35420"/>35420:                            end
<a name="35421"/>35421:                    end},
<a name="35422"/>35422: 
<a name="35423"/>35423: 
<a name="35424"/>35424:          %% *** We are done ***
<a name="35425"/>35425:          ?SEV_FINISH_NORMAL
<a name="35426"/>35426:         ],
<a name="35427"/>35427: 
<a name="35428"/>35428: 
<a name="35429"/>35429:     i(&quot;start 'primary acceptor' evaluator&quot;),
<a name="35430"/>35430:     PrimAccInitState = InitState,
<a name="35431"/>35431:     PrimAcc = ?SEV_START(&quot;prim-acceptor&quot;, PrimAcceptorSeq, PrimAccInitState),
<a name="35432"/>35432: 
<a name="35433"/>35433:     i(&quot;start 'secondary acceptor 1' evaluator&quot;),
<a name="35434"/>35434:     SecAccInitState = #{},
<a name="35435"/>35435:     SecAcc1 = ?SEV_START(&quot;sec-acceptor-1&quot;, SecAcceptorSeq, SecAccInitState),
<a name="35436"/>35436: 
<a name="35437"/>35437:     i(&quot;start 'secondary acceptor 2' evaluator&quot;),
<a name="35438"/>35438:     SecAcc2 = ?SEV_START(&quot;sec-acceptor-2&quot;, SecAcceptorSeq, SecAccInitState),
<a name="35439"/>35439: 
<a name="35440"/>35440:     i(&quot;start 'secondary acceptor 3' evaluator&quot;),
<a name="35441"/>35441:     SecAcc3 = ?SEV_START(&quot;sec-acceptor-3&quot;, SecAcceptorSeq, SecAccInitState),
<a name="35442"/>35442: 
<a name="35443"/>35443:     i(&quot;start 'tester' evaluator&quot;),
<a name="35444"/>35444:     TesterInitState = #{prim_acc =&gt; PrimAcc#ev.pid,
<a name="35445"/>35445:                         sec_acc1 =&gt; SecAcc1#ev.pid,
<a name="35446"/>35446:                         sec_acc2 =&gt; SecAcc2#ev.pid,
<a name="35447"/>35447:                         sec_acc3 =&gt; SecAcc3#ev.pid},
<a name="35448"/>35448:     Tester = ?SEV_START(&quot;tester&quot;, TesterSeq, TesterInitState),
<a name="35449"/>35449: 
<a name="35450"/>35450:     i(&quot;await evaluator&quot;),
<a name="sc_lc_acceptor_response_tcp-last_expr"/><a name="35451"/>35451: <b>    ok = ?SEV_AWAIT_FINISH</b>([PrimAcc, SecAcc1, SecAcc2, SecAcc3, Tester]).
<a name="35452"/>35452: 
<a name="35453"/>35453: 
<a name="35454"/>35454: 
<a name="35455"/>35455: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="35456"/>35456: <i>%% This test case is intended to test what happens when a socket is </i>
<a name="35457"/>35457: <i>%% remotely closed while the process is calling the recv function.</i>
<a name="35458"/>35458: <i>%% Socket is IPv4.</i>
<a name="35459"/>35459: <i>%%</i>
<a name="35460"/>35460: <i>%% To minimize the chance of &quot;weirdness&quot;, we should really have test cases</i>
<a name="35461"/>35461: <i>%% where the two sides of the connection is on different machines. But for</i>
<a name="35462"/>35462: <i>%% now, we will make do with different VMs on the same host.</i>
<a name="35463"/>35463: <i>%%</i>
<a name="35464"/>35464: 
<a name="sc_rc_recv_response_tcp4-1"/><a name="35465"/>35465: <b>sc_rc_recv_response_tcp4</b>(_Config) when is_list(_Config) -&gt;
<a name="35466"/>35466:     ?TT(?SECS(30)),
<a name="sc_rc_recv_response_tcp4-last_expr"/><a name="35467"/>35467: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="35468"/>35468:            fun() -&gt; has_support_ipv4() end,
<a name="35469"/>35469:            fun() -&gt;
<a name="35470"/>35470:                    Recv      = fun(Sock) -&gt; socket:recv(Sock) end,
<a name="35471"/>35471:                    InitState = #{domain   =&gt; inet,
<a name="35472"/>35472:                                  protocol =&gt; tcp,
<a name="35473"/>35473:                                  recv     =&gt; Recv},
<a name="35474"/>35474:                    ok = sc_rc_receive_response_tcp(InitState)
<a name="35475"/>35475:            end).
<a name="35476"/>35476: 
<a name="35477"/>35477: 
<a name="35478"/>35478: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="35479"/>35479: <i>%% This test case is intended to test what happens when a socket is </i>
<a name="35480"/>35480: <i>%% remotely closed while the process is calling the recv function.</i>
<a name="35481"/>35481: <i>%% Socket is IPv6.</i>
<a name="35482"/>35482: 
<a name="sc_rc_recv_response_tcp6-1"/><a name="35483"/>35483: <b>sc_rc_recv_response_tcp6</b>(_Config) when is_list(_Config) -&gt;
<a name="35484"/>35484:     ?TT(?SECS(30)),
<a name="sc_rc_recv_response_tcp6-last_expr"/><a name="35485"/>35485: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="35486"/>35486:            fun() -&gt; has_support_ipv6() end,
<a name="35487"/>35487:            fun() -&gt;
<a name="35488"/>35488:                    Recv      = fun(Sock) -&gt; socket:recv(Sock) end,
<a name="35489"/>35489:                    InitState = #{domain   =&gt; inet6,
<a name="35490"/>35490:                                  protocol =&gt; tcp,
<a name="35491"/>35491:                                  recv     =&gt; Recv},
<a name="35492"/>35492:                    ok = sc_rc_receive_response_tcp(InitState)
<a name="35493"/>35493:            end).
<a name="35494"/>35494: 
<a name="35495"/>35495: 
<a name="35496"/>35496: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="35497"/>35497: <i>%% This test case is intended to test what happens when a socket is </i>
<a name="35498"/>35498: <i>%% remotely closed while the process is calling the recv function.</i>
<a name="35499"/>35499: <i>%% Socket is Unix Domain (stream) socket.</i>
<a name="35500"/>35500: 
<a name="sc_rc_recv_response_tcpL-1"/><a name="35501"/>35501: <b>sc_rc_recv_response_tcpL</b>(_Config) when is_list(_Config) -&gt;
<a name="35502"/>35502:     ?TT(?SECS(30)),
<a name="sc_rc_recv_response_tcpL-last_expr"/><a name="35503"/>35503: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="35504"/>35504:            fun() -&gt; has_support_unix_domain_socket() end,
<a name="35505"/>35505:            fun() -&gt;
<a name="35506"/>35506:                    Recv      = fun(Sock) -&gt; socket:recv(Sock) end,
<a name="35507"/>35507:                    InitState = #{domain   =&gt; local,
<a name="35508"/>35508:                                  protocol =&gt; default,
<a name="35509"/>35509:                                  recv     =&gt; Recv},
<a name="35510"/>35510:                    ok = sc_rc_receive_response_tcp(InitState)
<a name="35511"/>35511:            end).
<a name="35512"/>35512: 
<a name="35513"/>35513: 
<a name="35514"/>35514: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="35515"/>35515: 
<a name="sc_rc_receive_response_tcp-1"/><a name="35516"/>35516: <b>sc_rc_receive_response_tcp</b>(InitState) -&gt;
<a name="35517"/>35517:     %% Each connection are handled by handler processes.
<a name="35518"/>35518:     %% These are created (on the fly) and handled internally 
<a name="35519"/>35519:     %% by the server!
<a name="35520"/>35520:     ServerSeq =
<a name="35521"/>35521:         [
<a name="35522"/>35522:          %% *** Wait for start order part ***
<a name="35523"/>35523:          #{desc =&gt; &quot;await start&quot;,
<a name="35524"/>35524:            cmd  =&gt; fun(State) -&gt;
<a name="35525"/>35525:                            Tester = ?SEV_AWAIT_START(),
<a name="35526"/>35526:                            {ok, State#{tester =&gt; Tester}}
<a name="35527"/>35527:                    end},
<a name="35528"/>35528:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="35529"/>35529:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="35530"/>35530:                            _MRef = erlang:monitor(process, Tester),
<a name="35531"/>35531:                            ok
<a name="35532"/>35532:                    end},
<a name="35533"/>35533: 
<a name="35534"/>35534:          %% *** Init part ***
<a name="35535"/>35535:          #{desc =&gt; &quot;which local address&quot;,
<a name="35536"/>35536:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="35537"/>35537:                            LSA = which_local_socket_addr(Domain),
<a name="35538"/>35538:                            {ok, State#{local_sa =&gt; LSA}}
<a name="35539"/>35539:                    end},
<a name="35540"/>35540:          #{desc =&gt; &quot;create listen socket&quot;,
<a name="35541"/>35541:            cmd  =&gt; fun(#{domain := Domain, protocol := Proto} = State) -&gt;
<a name="35542"/>35542:                            case socket:open(Domain, stream, Proto) of
<a name="35543"/>35543:                                {ok, Sock} -&gt;
<a name="35544"/>35544:                                    {ok, State#{lsock =&gt; Sock}};
<a name="35545"/>35545:                                {error, _} = ERROR -&gt;
<a name="35546"/>35546:                                    ERROR
<a name="35547"/>35547:                            end
<a name="35548"/>35548:                    end},
<a name="35549"/>35549:          #{desc =&gt; &quot;bind to local address&quot;,
<a name="35550"/>35550:            cmd  =&gt; fun(#{domain := local,
<a name="35551"/>35551:                          lsock  := LSock,
<a name="35552"/>35552:                          lsa    := LSA} = _State) -&gt;
<a name="35553"/>35553:                            case socket:bind(LSock, LSA) of
<a name="35554"/>35554:                                ok -&gt;
<a name="35555"/>35555:                                    ok; % We do not care about the port for local
<a name="35556"/>35556:                                {error, _} = ERROR -&gt;
<a name="35557"/>35557:                                    ERROR
<a name="35558"/>35558:                            end;
<a name="35559"/>35559:                       (#{lsock    := LSock,
<a name="35560"/>35560:                          local_sa := LSA} = State) -&gt;
<a name="35561"/>35561:                            case sock_bind(LSock, LSA) of
<a name="35562"/>35562:                                ok -&gt;
<a name="35563"/>35563:                                    Port = sock_port(LSock),
<a name="35564"/>35564:                                    {ok, State#{lport =&gt; Port}};
<a name="35565"/>35565:                                {error, _} = ERROR -&gt;
<a name="35566"/>35566:                                    ERROR
<a name="35567"/>35567:                            end
<a name="35568"/>35568:                    end},
<a name="35569"/>35569:          #{desc =&gt; &quot;make listen socket&quot;,
<a name="35570"/>35570:            cmd  =&gt; fun(#{lsock := LSock}) -&gt;
<a name="35571"/>35571:                            socket:listen(LSock)
<a name="35572"/>35572:                    end},
<a name="35573"/>35573:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="35574"/>35574:            cmd  =&gt; fun(#{domain   := local,
<a name="35575"/>35575:                          tester   := Tester,
<a name="35576"/>35576:                          local_sa := LSA}) -&gt;
<a name="35577"/>35577:                            %% Actually we only need to send the path,
<a name="35578"/>35578:                            %% but to keep it simple, we send the &quot;same&quot;
<a name="35579"/>35579:                            %% as for non-local.
<a name="35580"/>35580:                            ?SEV_ANNOUNCE_READY(Tester, init, LSA),
<a name="35581"/>35581:                            ok;
<a name="35582"/>35582:                       (#{tester := Tester, local_sa := LSA, lport := Port}) -&gt;
<a name="35583"/>35583:                            ServerSA = LSA#{port =&gt; Port},
<a name="35584"/>35584:                            ?SEV_ANNOUNCE_READY(Tester, init, ServerSA),
<a name="35585"/>35585:                            ok
<a name="35586"/>35586:                    end},
<a name="35587"/>35587: 
<a name="35588"/>35588:          %% The actual test
<a name="35589"/>35589:          #{desc =&gt; &quot;await continue (accept all three connections)&quot;,
<a name="35590"/>35590:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="35591"/>35591:                            ?SEV_ANNOUNCE_CONTINUE(Tester, tester, accept)
<a name="35592"/>35592:                    end},
<a name="35593"/>35593:          #{desc =&gt; &quot;accept 1&quot;,
<a name="35594"/>35594:            cmd  =&gt; fun(#{lsock := LSock, recv := Recv} = State) -&gt;
<a name="35595"/>35595:                            case socket:accept(LSock) of
<a name="35596"/>35596:                                {ok, Sock} -&gt;
<a name="35597"/>35597:                                    ?SEV_IPRINT(&quot;accepted: try start handler&quot;),
<a name="35598"/>35598:                                    Handler = sc_rc_tcp_handler_start(1, Recv, Sock),
<a name="35599"/>35599:                                    ?SEV_IPRINT(&quot;handler started&quot;),
<a name="35600"/>35600:                                    {ok, State#{csock1   =&gt; Sock,
<a name="35601"/>35601:                                                handler1 =&gt; Handler}};
<a name="35602"/>35602:                                {error, _} = ERROR -&gt;
<a name="35603"/>35603:                                    ERROR
<a name="35604"/>35604:                            end
<a name="35605"/>35605:                    end},
<a name="35606"/>35606:          #{desc =&gt; &quot;await handler 1 ready (init)&quot;,
<a name="35607"/>35607:            cmd  =&gt; fun(#{tester   := Tester, 
<a name="35608"/>35608:                          handler1 := Handler1} = _State) -&gt;
<a name="35609"/>35609:                            ?SEV_AWAIT_READY(Handler1, handler1, init, 
<a name="35610"/>35610:                                             [{tester, Tester}])
<a name="35611"/>35611:                    end},
<a name="35612"/>35612:          #{desc =&gt; &quot;accept 2&quot;,
<a name="35613"/>35613:            cmd  =&gt; fun(#{lsock := LSock, recv := Recv} = State) -&gt;
<a name="35614"/>35614:                            case socket:accept(LSock) of
<a name="35615"/>35615:                                {ok, Sock} -&gt;
<a name="35616"/>35616:                                    ?SEV_IPRINT(&quot;accepted: try start handler&quot;),
<a name="35617"/>35617:                                    Handler = sc_rc_tcp_handler_start(2, Recv, Sock),
<a name="35618"/>35618:                                    ?SEV_IPRINT(&quot;handler started&quot;),
<a name="35619"/>35619:                                    {ok, State#{csock2   =&gt; Sock,
<a name="35620"/>35620:                                                handler2 =&gt; Handler}};
<a name="35621"/>35621:                                {error, _} = ERROR -&gt;
<a name="35622"/>35622:                                    ERROR
<a name="35623"/>35623:                            end
<a name="35624"/>35624:                    end},
<a name="35625"/>35625:          #{desc =&gt; &quot;await handler 2 ready (init)&quot;,
<a name="35626"/>35626:            cmd  =&gt; fun(#{tester   := Tester, 
<a name="35627"/>35627:                          handler1 := Handler1, 
<a name="35628"/>35628:                          handler2 := Handler2} = _State) -&gt;
<a name="35629"/>35629:                            ?SEV_AWAIT_READY(Handler2, handler2, init, 
<a name="35630"/>35630:                                             [{tester,   Tester},
<a name="35631"/>35631:                                              {handler1, Handler1}])
<a name="35632"/>35632:                    end},
<a name="35633"/>35633:          #{desc =&gt; &quot;accept 3&quot;,
<a name="35634"/>35634:            cmd  =&gt; fun(#{lsock := LSock, recv := Recv} = State) -&gt;
<a name="35635"/>35635:                            case socket:accept(LSock) of
<a name="35636"/>35636:                                {ok, Sock} -&gt;
<a name="35637"/>35637:                                    ?SEV_IPRINT(&quot;accepted: try start handler&quot;),
<a name="35638"/>35638:                                    Handler = sc_rc_tcp_handler_start(3, Recv, Sock),
<a name="35639"/>35639:                                    ?SEV_IPRINT(&quot;handler started&quot;),
<a name="35640"/>35640:                                    {ok, State#{csock3   =&gt; Sock,
<a name="35641"/>35641:                                                handler3 =&gt; Handler}};
<a name="35642"/>35642:                                {error, _} = ERROR -&gt;
<a name="35643"/>35643:                                    ERROR
<a name="35644"/>35644:                            end
<a name="35645"/>35645:                    end},
<a name="35646"/>35646:          #{desc =&gt; &quot;await handler 3 ready (init)&quot;,
<a name="35647"/>35647:            cmd  =&gt; fun(#{tester   := Tester, 
<a name="35648"/>35648:                          handler1 := Handler1, 
<a name="35649"/>35649:                          handler2 := Handler2, 
<a name="35650"/>35650:                          handler3 := Handler3} = _State) -&gt;
<a name="35651"/>35651:                            ?SEV_AWAIT_READY(Handler3, handler3, init, 
<a name="35652"/>35652:                                             [{tester,   Tester},
<a name="35653"/>35653:                                              {handler1, Handler1},
<a name="35654"/>35654:                                              {handler2, Handler2}])
<a name="35655"/>35655:                    end},
<a name="35656"/>35656:          #{desc =&gt; &quot;announce ready (accept all three connections)&quot;,
<a name="35657"/>35657:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="35658"/>35658:                            ?SEV_ANNOUNCE_READY(Tester, accept),
<a name="35659"/>35659:                            ok
<a name="35660"/>35660:                    end},
<a name="35661"/>35661: 
<a name="35662"/>35662: 
<a name="35663"/>35663:          #{desc =&gt; &quot;await continue (recv)&quot;,
<a name="35664"/>35664:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="35665"/>35665:                            ?SEV_AWAIT_CONTINUE(Tester, tester, recv)
<a name="35666"/>35666:                    end},
<a name="35667"/>35667:          #{desc =&gt; &quot;order handler 1 to receive&quot;,
<a name="35668"/>35668:            cmd  =&gt; fun(#{handler1 := Pid} = _State) -&gt;
<a name="35669"/>35669:                            ?SEV_ANNOUNCE_CONTINUE(Pid, recv),
<a name="35670"/>35670:                            ok
<a name="35671"/>35671:                    end},
<a name="35672"/>35672:          #{desc =&gt; &quot;order handler 2 to receive&quot;,
<a name="35673"/>35673:            cmd  =&gt; fun(#{handler2 := Pid} = _State) -&gt;
<a name="35674"/>35674:                            ?SEV_ANNOUNCE_CONTINUE(Pid, recv),
<a name="35675"/>35675:                            ok
<a name="35676"/>35676:                    end},
<a name="35677"/>35677:          #{desc =&gt; &quot;order handler 3 to receive&quot;,
<a name="35678"/>35678:            cmd  =&gt; fun(#{handler3 := Pid} = _State) -&gt;
<a name="35679"/>35679:                            ?SEV_ANNOUNCE_CONTINUE(Pid, recv),
<a name="35680"/>35680:                            ok
<a name="35681"/>35681:                    end},
<a name="35682"/>35682:          #{desc =&gt; &quot;await ready from handler 1 (recv)&quot;,
<a name="35683"/>35683:            cmd  =&gt; fun(#{tester := Tester,
<a name="35684"/>35684:                          handler1 := Pid1,
<a name="35685"/>35685:                          handler2 := Pid2,
<a name="35686"/>35686:                          handler3 := Pid3} = _State) -&gt;
<a name="35687"/>35687:                            case ?SEV_AWAIT_READY(Pid1, handler1, recv, 
<a name="35688"/>35688:                                                  [{tester, Tester},
<a name="35689"/>35689:                                                   {handler2, Pid2},
<a name="35690"/>35690:                                                   {handler3, Pid3}]) of
<a name="35691"/>35691:                                {ok, Result} -&gt;
<a name="35692"/>35692:                                    Result;
<a name="35693"/>35693:                                {error, Reason} = ERROR -&gt;
<a name="35694"/>35694:                                    ?SEV_EPRINT(&quot;Unexpected failure: &quot;
<a name="35695"/>35695:                                                &quot;~n   ~p&quot;, [Reason]),
<a name="35696"/>35696:                                    ERROR
<a name="35697"/>35697:                            end
<a name="35698"/>35698:                    end},
<a name="35699"/>35699:          #{desc =&gt; &quot;await ready from handler 2 (recv)&quot;,
<a name="35700"/>35700:            cmd  =&gt; fun(#{tester := Tester,
<a name="35701"/>35701:                          handler1 := Pid1,
<a name="35702"/>35702:                          handler2 := Pid2,
<a name="35703"/>35703:                          handler3 := Pid3} = _State) -&gt;
<a name="35704"/>35704:                            case ?SEV_AWAIT_READY(Pid2, handler2, recv, 
<a name="35705"/>35705:                                                  [{tester, Tester},
<a name="35706"/>35706:                                                   {handler1, Pid1},
<a name="35707"/>35707:                                                   {handler3, Pid3}]) of
<a name="35708"/>35708:                                {ok, Result} -&gt;
<a name="35709"/>35709:                                    Result;
<a name="35710"/>35710:                                {error, _} = ERROR -&gt;
<a name="35711"/>35711:                                    ERROR
<a name="35712"/>35712:                            end
<a name="35713"/>35713:                    end},
<a name="35714"/>35714:          #{desc =&gt; &quot;await ready from handler 3 (recv)&quot;,
<a name="35715"/>35715:            cmd  =&gt; fun(#{tester := Tester,
<a name="35716"/>35716:                          handler1 := Pid1,
<a name="35717"/>35717:                          handler2 := Pid2,
<a name="35718"/>35718:                          handler3 := Pid3} = _State) -&gt;
<a name="35719"/>35719:                            case ?SEV_AWAIT_READY(Pid3, handler3, recv, 
<a name="35720"/>35720:                                                  [{tester, Tester},
<a name="35721"/>35721:                                                   {handler1, Pid1},
<a name="35722"/>35722:                                                   {handler2, Pid2}]) of
<a name="35723"/>35723:                                {ok, Result} -&gt;
<a name="35724"/>35724:                                    Result;
<a name="35725"/>35725:                                {error, _} = ERROR -&gt;
<a name="35726"/>35726:                                    ERROR
<a name="35727"/>35727:                            end
<a name="35728"/>35728:                    end},
<a name="35729"/>35729:          #{desc =&gt; &quot;announce ready (recv closed from all handlers)&quot;,
<a name="35730"/>35730:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="35731"/>35731:                            ?SEV_ANNOUNCE_READY(Tester, recv_closed),
<a name="35732"/>35732:                            ok
<a name="35733"/>35733:                    end},
<a name="35734"/>35734: 
<a name="35735"/>35735:          %% Termination
<a name="35736"/>35736:          #{desc =&gt; &quot;await terminate (from tester)&quot;,
<a name="35737"/>35737:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="35738"/>35738:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="35739"/>35739:                                ok -&gt;
<a name="35740"/>35740:                                    {ok, maps:remove(tester, State)};
<a name="35741"/>35741:                                {error, _} = ERROR -&gt;
<a name="35742"/>35742:                                    ERROR
<a name="35743"/>35743:                            end
<a name="35744"/>35744:                    end},
<a name="35745"/>35745:          #{desc =&gt; &quot;order handler 1 to terminate&quot;,
<a name="35746"/>35746:            cmd  =&gt; fun(#{handler1 := Pid} = _State) -&gt;
<a name="35747"/>35747:                            %% Pid ! {terminate, self(), ok},
<a name="35748"/>35748:                            ?SEV_ANNOUNCE_TERMINATE(Pid),
<a name="35749"/>35749:                            ok
<a name="35750"/>35750:                    end},
<a name="35751"/>35751:          #{desc =&gt; &quot;await handler 1 termination&quot;,
<a name="35752"/>35752:            cmd  =&gt; fun(#{handler1 := Pid} = State) -&gt;
<a name="35753"/>35753:                            ?SEV_AWAIT_TERMINATION(Pid),
<a name="35754"/>35754:                            State1 = maps:remove(csock1,   State),
<a name="35755"/>35755:                            State2 = maps:remove(handler1, State1),
<a name="35756"/>35756:                            {ok, State2}
<a name="35757"/>35757:                    end},
<a name="35758"/>35758:          #{desc =&gt; &quot;order handler 2 to terminate&quot;,
<a name="35759"/>35759:            cmd  =&gt; fun(#{handler2 := Pid} = _State) -&gt;
<a name="35760"/>35760:                            ?SEV_ANNOUNCE_TERMINATE(Pid),
<a name="35761"/>35761:                            ok
<a name="35762"/>35762:                    end},
<a name="35763"/>35763:          #{desc =&gt; &quot;await handler 2 termination&quot;,
<a name="35764"/>35764:            cmd  =&gt; fun(#{handler2 := Pid} = State) -&gt;
<a name="35765"/>35765:                            ?SEV_AWAIT_TERMINATION(Pid),
<a name="35766"/>35766:                            State1 = maps:remove(csock2,   State),
<a name="35767"/>35767:                            State2 = maps:remove(handler2, State1),
<a name="35768"/>35768:                            {ok, State2}
<a name="35769"/>35769:                    end},
<a name="35770"/>35770:          #{desc =&gt; &quot;order handler 3 to terminate&quot;,
<a name="35771"/>35771:            cmd  =&gt; fun(#{handler3 := Pid} = _State) -&gt;
<a name="35772"/>35772:                            ?SEV_ANNOUNCE_TERMINATE(Pid),
<a name="35773"/>35773:                            ok
<a name="35774"/>35774:                    end},
<a name="35775"/>35775:          #{desc =&gt; &quot;await handler 3 termination&quot;,
<a name="35776"/>35776:            cmd  =&gt; fun(#{handler3 := Pid} = State) -&gt;
<a name="35777"/>35777:                            ?SEV_AWAIT_TERMINATION(Pid),
<a name="35778"/>35778:                            State1 = maps:remove(csock3,   State),
<a name="35779"/>35779:                            State2 = maps:remove(handler3, State1),
<a name="35780"/>35780:                            {ok, State2}
<a name="35781"/>35781:                    end},
<a name="35782"/>35782:          #{desc =&gt; &quot;close listen socket&quot;,
<a name="35783"/>35783:            cmd  =&gt; fun(#{domain := local,
<a name="35784"/>35784:                          lsock  := LSock,
<a name="35785"/>35785:                          lsa    := #{path := Path}} = State) -&gt;
<a name="35786"/>35786:                            case socket:close(LSock) of
<a name="35787"/>35787:                                ok -&gt;
<a name="35788"/>35788:                                    State1 =
<a name="35789"/>35789:                                        unlink_path(Path,
<a name="35790"/>35790:                                                    fun() -&gt;
<a name="35791"/>35791:                                                            maps:remove(lsa, State)
<a name="35792"/>35792:                                                    end,
<a name="35793"/>35793:                                                    fun() -&gt;
<a name="35794"/>35794:                                                            State
<a name="35795"/>35795:                                                    end),
<a name="35796"/>35796:                                    {ok, maps:remove(lsock, State1)};
<a name="35797"/>35797:                                {error, _} = ERROR -&gt;
<a name="35798"/>35798:                                    unlink_path(Path),
<a name="35799"/>35799:                                    ERROR
<a name="35800"/>35800:                            end;
<a name="35801"/>35801:                       (#{lsock := LSock} = State) -&gt;
<a name="35802"/>35802:                            case socket:close(LSock) of
<a name="35803"/>35803:                                ok -&gt;
<a name="35804"/>35804:                                    {ok, maps:remove(lsock, State)};
<a name="35805"/>35805:                                {error, _} = ERROR -&gt;
<a name="35806"/>35806:                                    ERROR
<a name="35807"/>35807:                            end
<a name="35808"/>35808:                    end},
<a name="35809"/>35809: 
<a name="35810"/>35810:          %% *** We are done ***
<a name="35811"/>35811:          ?SEV_FINISH_NORMAL
<a name="35812"/>35812:         ],
<a name="35813"/>35813: 
<a name="35814"/>35814:     ClientSeq =
<a name="35815"/>35815:         [
<a name="35816"/>35816:          %% *** Wait for start order part ***
<a name="35817"/>35817:          #{desc =&gt; &quot;await start&quot;,
<a name="35818"/>35818:            cmd  =&gt; fun(State) -&gt;
<a name="35819"/>35819:                            {Tester, {NodeID, ServerSA}} = ?SEV_AWAIT_START(),
<a name="35820"/>35820:                            {ok, State#{tester    =&gt; Tester, 
<a name="35821"/>35821:                                        node_id   =&gt; NodeID, 
<a name="35822"/>35822:                                        server_sa =&gt; ServerSA}}
<a name="35823"/>35823:                    end},
<a name="35824"/>35824:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="35825"/>35825:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="35826"/>35826:                            _MRef = erlang:monitor(process, Tester),
<a name="35827"/>35827:                            ok
<a name="35828"/>35828:                    end},
<a name="35829"/>35829: 
<a name="35830"/>35830:          %% *** Init part ***
<a name="35831"/>35831:          #{desc =&gt; &quot;create node&quot;,
<a name="35832"/>35832:            cmd  =&gt; fun(#{node_id := NodeID} = State) -&gt;
<a name="35833"/>35833:                            {Peer, Node} =
<a name="35834"/>35834:                                ?START_NODE(?CT_PEER_NAME(f(&quot;client_~w&quot;,
<a name="35835"/>35835:                                                            [NodeID]))),
<a name="35836"/>35836:                            {ok, State#{node =&gt; Node, peer =&gt; Peer}}
<a name="35837"/>35837:                    end},
<a name="35838"/>35838:          #{desc =&gt; &quot;monitor client node 1&quot;,
<a name="35839"/>35839:            cmd  =&gt; fun(#{node := Node} = _State) -&gt;
<a name="35840"/>35840:                            true = erlang:monitor_node(Node, true),
<a name="35841"/>35841:                            ok
<a name="35842"/>35842:                    end},
<a name="35843"/>35843:          #{desc =&gt; &quot;start remote client on client node&quot;,
<a name="35844"/>35844:            cmd  =&gt; fun(#{node := Node} = State) -&gt;
<a name="35845"/>35845:                            Pid = sc_rc_tcp_client_start(Node),
<a name="35846"/>35846:                            ?SEV_IPRINT(&quot;client ~p started&quot;, [Pid]),
<a name="35847"/>35847:                            {ok, State#{rclient =&gt; Pid}}
<a name="35848"/>35848:                    end},
<a name="35849"/>35849:          #{desc =&gt; &quot;monitor remote client&quot;,
<a name="35850"/>35850:            cmd  =&gt; fun(#{rclient := Pid}) -&gt;
<a name="35851"/>35851:                            _MRef = erlang:monitor(process, Pid),
<a name="35852"/>35852:                            ok
<a name="35853"/>35853:                    end},
<a name="35854"/>35854:          #{desc =&gt; &quot;order remote client to start&quot;,
<a name="35855"/>35855:            cmd  =&gt; fun(#{rclient   := Client,
<a name="35856"/>35856:                          server_sa := ServerSA,
<a name="35857"/>35857:                          protocol  := Proto}) -&gt;
<a name="35858"/>35858:                            ?SEV_ANNOUNCE_START(Client, {ServerSA, Proto}),
<a name="35859"/>35859:                            ok
<a name="35860"/>35860:                    end},
<a name="35861"/>35861:          #{desc =&gt; &quot;await remote client ready&quot;,
<a name="35862"/>35862:            cmd  =&gt; fun(#{tester  := Tester,
<a name="35863"/>35863:                          rclient := Client} = _State) -&gt;
<a name="35864"/>35864:                            ?SEV_AWAIT_READY(Client, rclient, init, 
<a name="35865"/>35865:                                             [{tester, Tester}])
<a name="35866"/>35866:                    end},
<a name="35867"/>35867:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="35868"/>35868:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="35869"/>35869:                            ?SEV_ANNOUNCE_READY(Tester, init),
<a name="35870"/>35870:                            ok
<a name="35871"/>35871:                    end},
<a name="35872"/>35872: 
<a name="35873"/>35873:          %% The actual test
<a name="35874"/>35874:          #{desc =&gt; &quot;await continue (connect)&quot;,
<a name="35875"/>35875:            cmd  =&gt; fun(#{tester  := Tester,
<a name="35876"/>35876:                          rclient := Client} = _State) -&gt;
<a name="35877"/>35877:                            ?SEV_AWAIT_CONTINUE(Tester, tester, connect, 
<a name="35878"/>35878:                                                [{rclient, Client}]),
<a name="35879"/>35879:                            ok
<a name="35880"/>35880:                    end},
<a name="35881"/>35881:          #{desc =&gt; &quot;order remote client to continue (connect)&quot;,
<a name="35882"/>35882:            cmd  =&gt; fun(#{rclient := Client}) -&gt;
<a name="35883"/>35883:                            ?SEV_ANNOUNCE_CONTINUE(Client, connect),
<a name="35884"/>35884:                            ok
<a name="35885"/>35885:                    end},
<a name="35886"/>35886:          #{desc =&gt; &quot;await client process ready (connect)&quot;,
<a name="35887"/>35887:            cmd  =&gt; fun(#{tester  := Tester,
<a name="35888"/>35888:                          rclient := Client} = _State) -&gt;
<a name="35889"/>35889:                            ?SEV_AWAIT_READY(Client, rclient, connect, 
<a name="35890"/>35890:                                             [{tester, Tester}])
<a name="35891"/>35891:                    end},
<a name="35892"/>35892:          #{desc =&gt; &quot;announce ready (connected)&quot;,
<a name="35893"/>35893:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="35894"/>35894:                            ?SEV_ANNOUNCE_READY(Tester, connect),
<a name="35895"/>35895:                            ok
<a name="35896"/>35896:                    end},
<a name="35897"/>35897:          #{desc =&gt; &quot;await continue (close)&quot;,
<a name="35898"/>35898:            cmd  =&gt; fun(#{tester  := Tester,
<a name="35899"/>35899:                          rclient := Client} = _State) -&gt;
<a name="35900"/>35900:                            ?SEV_AWAIT_CONTINUE(Tester, tester, close, 
<a name="35901"/>35901:                                                [{rclient, Client}]),
<a name="35902"/>35902:                            ok
<a name="35903"/>35903:                    end},
<a name="35904"/>35904:          #{desc =&gt; &quot;order remote client to close&quot;,
<a name="35905"/>35905:            cmd  =&gt; fun(#{rclient := Client}) -&gt;
<a name="35906"/>35906:                            ?SEV_ANNOUNCE_CONTINUE(Client, close),
<a name="35907"/>35907:                            ok
<a name="35908"/>35908:                    end},
<a name="35909"/>35909:          #{desc =&gt; &quot;await remote client ready (closed)&quot;,
<a name="35910"/>35910:            cmd  =&gt; fun(#{tester  := Tester,
<a name="35911"/>35911:                          rclient := Client} = _State) -&gt;
<a name="35912"/>35912:                            ?SEV_AWAIT_READY(Client, rclient, close, 
<a name="35913"/>35913:                                             [{tester, Tester}])
<a name="35914"/>35914:                    end},
<a name="35915"/>35915:          #{desc =&gt; &quot;announce ready (close)&quot;,
<a name="35916"/>35916:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="35917"/>35917:                            ?SEV_ANNOUNCE_READY(Tester, close),
<a name="35918"/>35918:                            ok
<a name="35919"/>35919:                    end},
<a name="35920"/>35920: 
<a name="35921"/>35921:          %% Termination
<a name="35922"/>35922:          #{desc =&gt; &quot;await terminate (from tester)&quot;,
<a name="35923"/>35923:            cmd  =&gt; fun(#{tester  := Tester, 
<a name="35924"/>35924:                          rclient := Client} = State) -&gt;
<a name="35925"/>35925:                            case ?SEV_AWAIT_TERMINATE(Tester, tester,
<a name="35926"/>35926:                                                      [{rclient, Client}]) of
<a name="35927"/>35927:                                ok -&gt;
<a name="35928"/>35928:                                    {ok, maps:remove(tester, State)};
<a name="35929"/>35929:                                {error,
<a name="35930"/>35930:                                 {unexpected_exit, rclient, noconnection}} -&gt;
<a name="35931"/>35931:                                    %% Global might have disconnected =&gt; SKIP
<a name="35932"/>35932:                                    ?SEV_IPRINT(&quot;lost connection &quot;
<a name="35933"/>35933:                                                &quot;to remote client node =&gt; SKIP&quot;),
<a name="35934"/>35934:                                    {skip, {rclient, noconnection}};
<a name="35935"/>35935:                                {error, _} = ERROR -&gt;
<a name="35936"/>35936:                                    ERROR
<a name="35937"/>35937:                            end
<a name="35938"/>35938:                    end},
<a name="35939"/>35939:          #{desc =&gt; &quot;kill remote client&quot;,
<a name="35940"/>35940:            cmd  =&gt; fun(#{rclient := RClient}) -&gt;
<a name="35941"/>35941:                            ?SEV_IPRINT(&quot;try kill remote client ~p&quot;, [RClient]),
<a name="35942"/>35942:                            ?SEV_ANNOUNCE_TERMINATE(RClient),
<a name="35943"/>35943:                            ok
<a name="35944"/>35944:                    end},
<a name="35945"/>35945:          #{desc =&gt; &quot;await remote client termination&quot;,
<a name="35946"/>35946:            cmd  =&gt; fun(#{rclient := RClient} = State) -&gt;
<a name="35947"/>35947:                            ?SEV_AWAIT_TERMINATION(RClient),
<a name="35948"/>35948:                            ?SEV_IPRINT(&quot;remote client ~p terminated&quot;,
<a name="35949"/>35949:                                        [RClient]),
<a name="35950"/>35950:                            State1 = maps:remove(rclient, State),
<a name="35951"/>35951:                            {ok, State1}
<a name="35952"/>35952:                    end},
<a name="35953"/>35953:          #{desc =&gt; &quot;stop client node&quot;,
<a name="35954"/>35954:            cmd  =&gt; fun(#{peer := Peer} = State) -&gt;
<a name="35955"/>35955:                            {ok,
<a name="35956"/>35956:                             try peer:stop(Peer) of
<a name="35957"/>35957:                                 ok -&gt;
<a name="35958"/>35958:                                     State#{node_stop =&gt; ok};
<a name="35959"/>35959:                                 {error, Reason} -&gt;
<a name="35960"/>35960:                                     ?SEV_EPRINT(&quot;Unexpected node stop result: &quot;
<a name="35961"/>35961:                                                 &quot;~n   ~p&quot;, [Reason]),
<a name="35962"/>35962:                                     State#{node_stop =&gt; error}
<a name="35963"/>35963:                             catch
<a name="35964"/>35964:                                 C:E:S -&gt;
<a name="35965"/>35965:                                     ?SEV_EPRINT(&quot;Unexpected node stop result: &quot;
<a name="35966"/>35966:                                                 &quot;~n   Class: ~p&quot;
<a name="35967"/>35967:                                                 &quot;~n   Error: ~p&quot;
<a name="35968"/>35968:                                                 &quot;~n   Stack: ~p&quot;,[C, E, S]),
<a name="35969"/>35969:                                     State#{node_stop =&gt; error}
<a name="35970"/>35970:                             end}
<a name="35971"/>35971:                    end},
<a name="35972"/>35972:          #{desc =&gt; &quot;await client node termination&quot;,
<a name="35973"/>35973:            cmd  =&gt; fun(#{node := Node, node_stop := ok} = State) -&gt;
<a name="35974"/>35974:                            ?SEV_IPRINT(&quot;Success node stop - await nodedown: &quot;
<a name="35975"/>35975:                                        &quot;~n      ~p&quot;, [Node]),
<a name="35976"/>35976:                            receive
<a name="35977"/>35977:                                {nodedown, Node} -&gt;
<a name="35978"/>35978:                                    ?SEV_IPRINT(&quot;nodedown received - cleanup&quot;),
<a name="35979"/>35979:                                    State1 = maps:remove(peer, State),
<a name="35980"/>35980:                                    State2 = maps:remove(node, State1),
<a name="35981"/>35981:                                    {ok, State2}
<a name="35982"/>35982:                            end;
<a name="35983"/>35983:                       (#{node_stop := error} = State) -&gt;
<a name="35984"/>35984:                            ?SEV_IPRINT(&quot;Failed node stop - cleanup&quot;),
<a name="35985"/>35985:                            State1 = maps:remove(peer, State),
<a name="35986"/>35986:                            State2 = maps:remove(node, State1),
<a name="35987"/>35987:                            {ok, State2}
<a name="35988"/>35988:                    end},
<a name="35989"/>35989: 
<a name="35990"/>35990:          %% *** We are done ***
<a name="35991"/>35991:          ?SEV_FINISH_NORMAL
<a name="35992"/>35992:         ],
<a name="35993"/>35993: 
<a name="35994"/>35994:     TesterSeq =
<a name="35995"/>35995:         [
<a name="35996"/>35996:          %% *** Init part ***
<a name="35997"/>35997:          #{desc =&gt; &quot;monitor server&quot;,
<a name="35998"/>35998:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="35999"/>35999:                            _MRef = erlang:monitor(process, Pid),
<a name="36000"/>36000:                            ok
<a name="36001"/>36001:                    end},
<a name="36002"/>36002:          #{desc =&gt; &quot;monitor client 1&quot;,
<a name="36003"/>36003:            cmd  =&gt; fun(#{client1 := Pid} = _State) -&gt;
<a name="36004"/>36004:                            _MRef = erlang:monitor(process, Pid),
<a name="36005"/>36005:                            ok
<a name="36006"/>36006:                    end},
<a name="36007"/>36007:          #{desc =&gt; &quot;monitor client 2&quot;,
<a name="36008"/>36008:            cmd  =&gt; fun(#{client2 := Pid} = _State) -&gt;
<a name="36009"/>36009:                            _MRef = erlang:monitor(process, Pid),
<a name="36010"/>36010:                            ok
<a name="36011"/>36011:                    end},
<a name="36012"/>36012:          #{desc =&gt; &quot;monitor client 3&quot;,
<a name="36013"/>36013:            cmd  =&gt; fun(#{client3 := Pid} = _State) -&gt;
<a name="36014"/>36014:                            _MRef = erlang:monitor(process, Pid),
<a name="36015"/>36015:                            ok
<a name="36016"/>36016:                    end},
<a name="36017"/>36017: 
<a name="36018"/>36018:          %% Start the server
<a name="36019"/>36019:          #{desc =&gt; &quot;order server start&quot;,
<a name="36020"/>36020:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="36021"/>36021:                            ?SEV_ANNOUNCE_START(Pid),
<a name="36022"/>36022:                            ok
<a name="36023"/>36023:                    end},
<a name="36024"/>36024:          #{desc =&gt; &quot;await server ready (init)&quot;,
<a name="36025"/>36025:            cmd  =&gt; fun(#{server := Pid} = State) -&gt;
<a name="36026"/>36026:                            {ok, ServerSA} = ?SEV_AWAIT_READY(Pid, server, init),
<a name="36027"/>36027:                            {ok, State#{server_sa =&gt; ServerSA}}
<a name="36028"/>36028:                    end},
<a name="36029"/>36029: 
<a name="36030"/>36030:          %% Start the client(s)
<a name="36031"/>36031:          #{desc =&gt; &quot;order client 1 start&quot;,
<a name="36032"/>36032:            cmd  =&gt; fun(#{client1   := Pid, 
<a name="36033"/>36033:                          server_sa := ServerSA} = _State) -&gt;
<a name="36034"/>36034:                            ?SEV_ANNOUNCE_START(Pid, {1, ServerSA}),
<a name="36035"/>36035:                            ok
<a name="36036"/>36036:                    end},
<a name="36037"/>36037:          #{desc =&gt; &quot;await client 1 ready (init)&quot;,
<a name="36038"/>36038:            cmd  =&gt; fun(#{client1 := Pid} = _State) -&gt;
<a name="36039"/>36039:                            ok = ?SEV_AWAIT_READY(Pid, client1, init)
<a name="36040"/>36040:                    end},
<a name="36041"/>36041:          #{desc =&gt; &quot;order client 2 start&quot;,
<a name="36042"/>36042:            cmd  =&gt; fun(#{client2   := Pid, 
<a name="36043"/>36043:                          server_sa := ServerSA} = _State) -&gt;
<a name="36044"/>36044:                            ?SEV_ANNOUNCE_START(Pid, {2, ServerSA}),
<a name="36045"/>36045:                            ok
<a name="36046"/>36046:                    end},
<a name="36047"/>36047:          #{desc =&gt; &quot;await client 2 ready (init)&quot;,
<a name="36048"/>36048:            cmd  =&gt; fun(#{client2 := Pid} = _State) -&gt;
<a name="36049"/>36049:                            ok = ?SEV_AWAIT_READY(Pid, client2, init)
<a name="36050"/>36050:                    end},
<a name="36051"/>36051:          #{desc =&gt; &quot;order client 3 start&quot;,
<a name="36052"/>36052:            cmd  =&gt; fun(#{client3   := Pid, 
<a name="36053"/>36053:                          server_sa := ServerSA} = _State) -&gt;
<a name="36054"/>36054:                            ?SEV_ANNOUNCE_START(Pid, {3, ServerSA}),
<a name="36055"/>36055:                            ok
<a name="36056"/>36056:                    end},
<a name="36057"/>36057:          #{desc =&gt; &quot;await client 3 ready (init)&quot;,
<a name="36058"/>36058:            cmd  =&gt; fun(#{client3 := Pid} = _State) -&gt;
<a name="36059"/>36059:                            ok = ?SEV_AWAIT_READY(Pid, client3, init)
<a name="36060"/>36060:                    end},
<a name="36061"/>36061: 
<a name="36062"/>36062:          %% The actual test
<a name="36063"/>36063:          #{desc =&gt; &quot;order server continue (accept)&quot;,
<a name="36064"/>36064:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="36065"/>36065:                            ?SEV_ANNOUNCE_CONTINUE(Pid, accept),
<a name="36066"/>36066:                            ok
<a name="36067"/>36067:                    end},
<a name="36068"/>36068:          ?SEV_SLEEP(?SECS(1)),
<a name="36069"/>36069:          #{desc =&gt; &quot;order client 1 continue (connect)&quot;,
<a name="36070"/>36070:            cmd  =&gt; fun(#{client1 := Pid} = _State) -&gt;
<a name="36071"/>36071:                            ?SEV_ANNOUNCE_CONTINUE(Pid, connect),
<a name="36072"/>36072:                            ok
<a name="36073"/>36073:                    end},
<a name="36074"/>36074:          #{desc =&gt; &quot;await client 1 ready (connect)&quot;,
<a name="36075"/>36075:            cmd  =&gt; fun(#{server  := Server,
<a name="36076"/>36076:                          client1 := Client1,
<a name="36077"/>36077:                          client2 := Client2,
<a name="36078"/>36078:                          client3 := Client3} = _State) -&gt;
<a name="36079"/>36079:                            ?SEV_AWAIT_READY(Client1, client1, connect, 
<a name="36080"/>36080:                                             [{server,  Server},
<a name="36081"/>36081:                                              {client2, Client2},
<a name="36082"/>36082:                                              {client3, Client3}]),
<a name="36083"/>36083:                            ok
<a name="36084"/>36084:                    end},
<a name="36085"/>36085:          #{desc =&gt; &quot;order client 2 continue (connect)&quot;,
<a name="36086"/>36086:            cmd  =&gt; fun(#{client2 := Pid} = _State) -&gt;
<a name="36087"/>36087:                            ?SEV_ANNOUNCE_CONTINUE(Pid, connect),
<a name="36088"/>36088:                            ok
<a name="36089"/>36089:                    end},
<a name="36090"/>36090:          #{desc =&gt; &quot;await client 2 ready (connect)&quot;,
<a name="36091"/>36091:            cmd  =&gt; fun(#{server  := Server,
<a name="36092"/>36092:                          client1 := Client1,
<a name="36093"/>36093:                          client2 := Client2,
<a name="36094"/>36094:                          client3 := Client3} = _State) -&gt;
<a name="36095"/>36095:                            ?SEV_AWAIT_READY(Client2, client2, connect, 
<a name="36096"/>36096:                                             [{server,  Server},
<a name="36097"/>36097:                                              {client1, Client1},
<a name="36098"/>36098:                                              {client3, Client3}]),
<a name="36099"/>36099:                            ok
<a name="36100"/>36100:                    end},
<a name="36101"/>36101:          #{desc =&gt; &quot;order client 3 continue (connect)&quot;,
<a name="36102"/>36102:            cmd  =&gt; fun(#{client3 := Pid} = _State) -&gt;
<a name="36103"/>36103:                            ?SEV_ANNOUNCE_CONTINUE(Pid, connect),
<a name="36104"/>36104:                            ok
<a name="36105"/>36105:                    end},
<a name="36106"/>36106:          #{desc =&gt; &quot;await client 3 ready (connect)&quot;,
<a name="36107"/>36107:            cmd  =&gt; fun(#{server  := Server,
<a name="36108"/>36108:                          client1 := Client1,
<a name="36109"/>36109:                          client2 := Client2,
<a name="36110"/>36110:                          client3 := Client3} = _State) -&gt;
<a name="36111"/>36111:                            ?SEV_AWAIT_READY(Client3, client3, connect, 
<a name="36112"/>36112:                                             [{server,  Server},
<a name="36113"/>36113:                                              {client1, Client1},
<a name="36114"/>36114:                                              {client2, Client2}]),
<a name="36115"/>36115:                            ok
<a name="36116"/>36116:                    end},
<a name="36117"/>36117:          #{desc =&gt; &quot;await server ready (accept from all connections)&quot;,
<a name="36118"/>36118:            cmd  =&gt; fun(#{server  := Server,
<a name="36119"/>36119:                          client1 := Client1,
<a name="36120"/>36120:                          client2 := Client2,
<a name="36121"/>36121:                          client3 := Client3} = _State) -&gt;
<a name="36122"/>36122:                            ?SEV_AWAIT_READY(Server, server, accept,
<a name="36123"/>36123:                                             [{client1, Client1},
<a name="36124"/>36124:                                              {client2, Client2},
<a name="36125"/>36125:                                              {client3, Client3}]),
<a name="36126"/>36126:                            ok
<a name="36127"/>36127:                    end},
<a name="36128"/>36128:          #{desc =&gt; &quot;order server continue (recv for all connections)&quot;,
<a name="36129"/>36129:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="36130"/>36130:                            ?SEV_ANNOUNCE_CONTINUE(Pid, recv),
<a name="36131"/>36131:                            ok
<a name="36132"/>36132:                    end},
<a name="36133"/>36133:          ?SEV_SLEEP(?SECS(1)),
<a name="36134"/>36134:          #{desc =&gt; &quot;order client 1 continue (close)&quot;,
<a name="36135"/>36135:            cmd  =&gt; fun(#{client1 := Pid} = _State) -&gt;
<a name="36136"/>36136:                            ?SEV_ANNOUNCE_CONTINUE(Pid, close),
<a name="36137"/>36137:                            ok
<a name="36138"/>36138:                    end},
<a name="36139"/>36139:          #{desc =&gt; &quot;await client 1 ready (close)&quot;,
<a name="36140"/>36140:            cmd  =&gt; fun(#{server  := Server,
<a name="36141"/>36141:                          client1 := Client1,
<a name="36142"/>36142:                          client2 := Client2,
<a name="36143"/>36143:                          client3 := Client3} = _State) -&gt;
<a name="36144"/>36144:                            ?SEV_AWAIT_READY(Client1, client1, close, 
<a name="36145"/>36145:                                             [{server,  Server},
<a name="36146"/>36146:                                              {client2, Client2},
<a name="36147"/>36147:                                              {client3, Client3}]),
<a name="36148"/>36148:                            ok
<a name="36149"/>36149:                    end},
<a name="36150"/>36150:          #{desc =&gt; &quot;order client 2 continue (close)&quot;,
<a name="36151"/>36151:            cmd  =&gt; fun(#{client2 := Pid} = _State) -&gt;
<a name="36152"/>36152:                            ?SEV_ANNOUNCE_CONTINUE(Pid, close),
<a name="36153"/>36153:                            ok
<a name="36154"/>36154:                    end},
<a name="36155"/>36155:          #{desc =&gt; &quot;await client 2 ready (close)&quot;,
<a name="36156"/>36156:            cmd  =&gt; fun(#{server  := Server,
<a name="36157"/>36157:                          client1 := Client1,
<a name="36158"/>36158:                          client2 := Client2,
<a name="36159"/>36159:                          client3 := Client3} = _State) -&gt;
<a name="36160"/>36160:                            ?SEV_AWAIT_READY(Client2, client2, close, 
<a name="36161"/>36161:                                             [{server,  Server},
<a name="36162"/>36162:                                              {client1, Client1},
<a name="36163"/>36163:                                              {client3, Client3}]),
<a name="36164"/>36164:                            ok
<a name="36165"/>36165:                    end},
<a name="36166"/>36166:          #{desc =&gt; &quot;order client 3 continue (close)&quot;,
<a name="36167"/>36167:            cmd  =&gt; fun(#{client3 := Pid} = _State) -&gt;
<a name="36168"/>36168:                            ?SEV_ANNOUNCE_CONTINUE(Pid, close),
<a name="36169"/>36169:                            ok
<a name="36170"/>36170:                    end},
<a name="36171"/>36171:          #{desc =&gt; &quot;await client 3 ready (close)&quot;,
<a name="36172"/>36172:            cmd  =&gt; fun(#{server  := Server,
<a name="36173"/>36173:                          client1 := Client1,
<a name="36174"/>36174:                          client2 := Client2,
<a name="36175"/>36175:                          client3 := Client3} = _State) -&gt;
<a name="36176"/>36176:                            ?SEV_AWAIT_READY(Client3, client1, close, 
<a name="36177"/>36177:                                             [{server,  Server},
<a name="36178"/>36178:                                              {client1, Client1},
<a name="36179"/>36179:                                              {client2, Client2}]),
<a name="36180"/>36180:                            ok
<a name="36181"/>36181:                    end},
<a name="36182"/>36182:          #{desc =&gt; &quot;await server ready (close for all connections)&quot;,
<a name="36183"/>36183:            cmd  =&gt; fun(#{server  := Server,
<a name="36184"/>36184:                          client1 := Client1,
<a name="36185"/>36185:                          client2 := Client2,
<a name="36186"/>36186:                          client3 := Client3} = _State) -&gt;
<a name="36187"/>36187:                            ?SEV_AWAIT_READY(Server, server, recv_closed,
<a name="36188"/>36188:                                             [{client1, Client1},
<a name="36189"/>36189:                                              {client2, Client2},
<a name="36190"/>36190:                                              {client3, Client3}]),
<a name="36191"/>36191:                            ok
<a name="36192"/>36192:                    end},
<a name="36193"/>36193: 
<a name="36194"/>36194:          %% Terminations
<a name="36195"/>36195:          #{desc =&gt; &quot;order client 1 to terminate&quot;,
<a name="36196"/>36196:            cmd  =&gt; fun(#{client1 := Pid} = _State) -&gt;
<a name="36197"/>36197:                            ?SEV_ANNOUNCE_TERMINATE(Pid),
<a name="36198"/>36198:                            ok
<a name="36199"/>36199:                    end},
<a name="36200"/>36200:          #{desc =&gt; &quot;await client 1 termination&quot;,
<a name="36201"/>36201:            cmd  =&gt; fun(#{client1 := Pid} = State) -&gt;
<a name="36202"/>36202:                            case ?SEV_AWAIT_TERMINATION(Pid) of
<a name="36203"/>36203:                                ok -&gt;
<a name="36204"/>36204:                                    State1 = maps:remove(client1, State),
<a name="36205"/>36205:                                    {ok, State1};
<a name="36206"/>36206:                                {error, _} = ERROR -&gt;
<a name="36207"/>36207:                                    ERROR
<a name="36208"/>36208:                            end
<a name="36209"/>36209:                    end},
<a name="36210"/>36210:          #{desc =&gt; &quot;order client 2 to terminate&quot;,
<a name="36211"/>36211:            cmd  =&gt; fun(#{client2 := Pid} = _State) -&gt;
<a name="36212"/>36212:                            ?SEV_ANNOUNCE_TERMINATE(Pid),
<a name="36213"/>36213:                            ok
<a name="36214"/>36214:                    end},
<a name="36215"/>36215:          #{desc =&gt; &quot;await client 2 termination&quot;,
<a name="36216"/>36216:            cmd  =&gt; fun(#{client2 := Pid} = State) -&gt;
<a name="36217"/>36217:                            case ?SEV_AWAIT_TERMINATION(Pid) of
<a name="36218"/>36218:                                ok -&gt;
<a name="36219"/>36219:                                    State1 = maps:remove(client2, State),
<a name="36220"/>36220:                                    {ok, State1};
<a name="36221"/>36221:                                {error, _} = ERROR -&gt;
<a name="36222"/>36222:                                    ERROR
<a name="36223"/>36223:                            end
<a name="36224"/>36224:                    end},
<a name="36225"/>36225:          #{desc =&gt; &quot;order client 3 to terminate&quot;,
<a name="36226"/>36226:            cmd  =&gt; fun(#{client3 := Pid} = _State) -&gt;
<a name="36227"/>36227:                            ?SEV_ANNOUNCE_TERMINATE(Pid),
<a name="36228"/>36228:                            ok
<a name="36229"/>36229:                    end},
<a name="36230"/>36230:          #{desc =&gt; &quot;await client 3 termination&quot;,
<a name="36231"/>36231:            cmd  =&gt; fun(#{client3 := Pid} = State) -&gt;
<a name="36232"/>36232:                            case ?SEV_AWAIT_TERMINATION(Pid) of
<a name="36233"/>36233:                                ok -&gt;
<a name="36234"/>36234:                                    State1 = maps:remove(client3, State),
<a name="36235"/>36235:                                    {ok, State1};
<a name="36236"/>36236:                                {error, _} = ERROR -&gt;
<a name="36237"/>36237:                                    ERROR
<a name="36238"/>36238:                            end
<a name="36239"/>36239:                    end},
<a name="36240"/>36240:          #{desc =&gt; &quot;order server to terminate&quot;,
<a name="36241"/>36241:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="36242"/>36242:                            ?SEV_ANNOUNCE_TERMINATE(Pid),
<a name="36243"/>36243:                            ok
<a name="36244"/>36244:                    end},
<a name="36245"/>36245:          #{desc =&gt; &quot;await server termination&quot;,
<a name="36246"/>36246:            cmd  =&gt; fun(#{server := Pid} = State) -&gt;
<a name="36247"/>36247:                            case ?SEV_AWAIT_TERMINATION(Pid) of
<a name="36248"/>36248:                                ok -&gt;
<a name="36249"/>36249:                                    State1 = maps:remove(server, State),
<a name="36250"/>36250:                                    {ok, State1};
<a name="36251"/>36251:                                {error, _} = ERROR -&gt;
<a name="36252"/>36252:                                    ERROR
<a name="36253"/>36253:                            end
<a name="36254"/>36254:                    end},
<a name="36255"/>36255: 
<a name="36256"/>36256:          %% *** We are done ***
<a name="36257"/>36257:          ?SEV_FINISH_NORMAL
<a name="36258"/>36258:         ],
<a name="36259"/>36259: 
<a name="36260"/>36260:     i(&quot;start server evaluator&quot;),
<a name="36261"/>36261:     ServerInitState = InitState,
<a name="36262"/>36262:     Server = ?SEV_START(&quot;server&quot;, ServerSeq, ServerInitState),
<a name="36263"/>36263: 
<a name="36264"/>36264:     i(&quot;start client evaluator(s)&quot;),
<a name="36265"/>36265:     ClientInitState = InitState#{host =&gt; local_host()},
<a name="36266"/>36266:     Client1 = ?SEV_START(&quot;client-1&quot;, ClientSeq, ClientInitState),
<a name="36267"/>36267:     Client2 = ?SEV_START(&quot;client-2&quot;, ClientSeq, ClientInitState),
<a name="36268"/>36268:     Client3 = ?SEV_START(&quot;client-3&quot;, ClientSeq, ClientInitState),
<a name="36269"/>36269: 
<a name="36270"/>36270:     i(&quot;start 'tester' evaluator&quot;),
<a name="36271"/>36271:     TesterInitState = #{server  =&gt; Server#ev.pid,
<a name="36272"/>36272:                         client1 =&gt; Client1#ev.pid,
<a name="36273"/>36273:                         client2 =&gt; Client2#ev.pid,
<a name="36274"/>36274:                         client3 =&gt; Client3#ev.pid},
<a name="36275"/>36275:     Tester = ?SEV_START(&quot;tester&quot;, TesterSeq, TesterInitState),
<a name="36276"/>36276: 
<a name="36277"/>36277:     i(&quot;await evaluator&quot;),
<a name="sc_rc_receive_response_tcp-last_expr"/><a name="36278"/>36278: <b>    ok = ?SEV_AWAIT_FINISH</b>([Server,
<a name="36279"/>36279:                             Client1, Client2, Client3,
<a name="36280"/>36280:                             Tester]).
<a name="36281"/>36281: 
<a name="36282"/>36282: 
<a name="sc_rc_tcp_client_start-1"/><a name="36283"/>36283: <b>sc_rc_tcp_client_start</b>(Node) -&gt;
<a name="36284"/>36284:     Self = self(),
<a name="36285"/>36285:     Fun  = fun() -&gt; sc_rc_tcp_client(Self) end,
<a name="sc_rc_tcp_client_start-last_expr"/><a name="36286"/>36286: <b>    erlang:spawn</b>(Node, Fun).
<a name="36287"/>36287: 
<a name="36288"/>36288: 
<a name="sc_rc_tcp_client-1"/><a name="36289"/>36289: <b>sc_rc_tcp_client</b>(Parent) -&gt;
<a name="36290"/>36290:     sc_rc_tcp_client_init(Parent),
<a name="36291"/>36291:     {ServerSA, Proto} = sc_rc_tcp_client_await_start(Parent),
<a name="36292"/>36292:     Domain   = maps:get(family, ServerSA),
<a name="36293"/>36293:     Sock     = sc_rc_tcp_client_create(Domain, Proto),
<a name="36294"/>36294:     Path     = sc_rc_tcp_client_bind(Sock, Domain),
<a name="36295"/>36295:     sc_rc_tcp_client_announce_ready(Parent, init),
<a name="36296"/>36296:     sc_rc_tcp_client_await_continue(Parent, connect),
<a name="36297"/>36297:     sc_rc_tcp_client_connect(Sock, ServerSA),
<a name="36298"/>36298:     sc_rc_tcp_client_announce_ready(Parent, connect),
<a name="36299"/>36299:     sc_rc_tcp_client_await_continue(Parent, close),
<a name="36300"/>36300:     sc_rc_tcp_client_close(Sock, Path),
<a name="36301"/>36301:     sc_rc_tcp_client_announce_ready(Parent, close),
<a name="36302"/>36302:     Reason = sc_rc_tcp_client_await_terminate(Parent),
<a name="36303"/>36303:     ?SEV_IPRINT(&quot;terminate&quot;),
<a name="sc_rc_tcp_client-last_expr"/><a name="36304"/>36304: <b>    exit</b>(Reason).
<a name="36305"/>36305: 
<a name="sc_rc_tcp_client_init-1"/><a name="36306"/>36306: <b>sc_rc_tcp_client_init</b>(Parent) -&gt;
<a name="36307"/>36307:     put(sname, &quot;rclient&quot;),
<a name="36308"/>36308:     ?SEV_IPRINT(&quot;init&quot;),
<a name="36309"/>36309:     _MRef = erlang:monitor(process, Parent),
<a name="sc_rc_tcp_client_init-last_expr"/><a name="36310"/>36310:     ok.
<a name="36311"/>36311: 
<a name="sc_rc_tcp_client_await_start-1"/><a name="36312"/>36312: <b>sc_rc_tcp_client_await_start</b>(Parent) -&gt;
<a name="36313"/>36313:     i(&quot;sc_rc_tcp_client_await_start -&gt; entry&quot;),
<a name="sc_rc_tcp_client_await_start-last_expr"/><a name="36314"/>36314: <b>    ?SEV_AWAIT_START</b>(Parent).
<a name="36315"/>36315: 
<a name="sc_rc_tcp_client_create-2"/><a name="36316"/>36316: <b>sc_rc_tcp_client_create</b>(Domain, Proto) -&gt;
<a name="36317"/>36317:     i(&quot;sc_rc_tcp_client_create -&gt; entry&quot;),
<a name="sc_rc_tcp_client_create-last_expr"/><a name="36318"/>36318: <b>    case socket:open</b>(Domain, stream, Proto) of
<a name="36319"/>36319:         {ok, Sock} -&gt;
<a name="36320"/>36320:             case socket:getopt(Sock, otp, fd) of
<a name="36321"/>36321:                 {ok, FD} -&gt;
<a name="36322"/>36322:                     put(sname, f(&quot;rclient-~w&quot;, [FD])); % Update SName
<a name="36323"/>36323:                 _ -&gt;
<a name="36324"/>36324:                     ok
<a name="36325"/>36325:             end,
<a name="36326"/>36326:             Sock;
<a name="36327"/>36327:         {error, Reason} -&gt;
<a name="36328"/>36328:             exit({open_failed, Reason})
<a name="36329"/>36329:     end.
<a name="36330"/>36330: 
<a name="sc_rc_tcp_client_bind-2"/><a name="36331"/>36331: <b>sc_rc_tcp_client_bind</b>(Sock, Domain) -&gt;
<a name="36332"/>36332:     i(&quot;sc_rc_tcp_client_bind -&gt; entry&quot;),
<a name="36333"/>36333:     LSA = which_local_socket_addr(Domain),
<a name="sc_rc_tcp_client_bind-last_expr"/><a name="36334"/>36334: <b>    case socket:bind</b>(Sock, LSA) of
<a name="36335"/>36335:         ok -&gt;
<a name="36336"/>36336:             case socket:sockname(Sock) of
<a name="36337"/>36337:                 {ok, #{family := local, path := Path}} -&gt;
<a name="36338"/>36338:                     Path;
<a name="36339"/>36339:                 {ok, _} -&gt;
<a name="36340"/>36340:                     undefined;
<a name="36341"/>36341:                 {error, Reason1} -&gt;
<a name="36342"/>36342:                     exit({sockname, Reason1})
<a name="36343"/>36343:             end;
<a name="36344"/>36344:         {error, Reason} -&gt;
<a name="36345"/>36345:             exit({bind, Reason})
<a name="36346"/>36346:     end.
<a name="36347"/>36347: 
<a name="sc_rc_tcp_client_announce_ready-2"/><a name="36348"/>36348: <b>sc_rc_tcp_client_announce_ready</b>(Parent, Slogan) -&gt;
<a name="36349"/>36349:     ?SEV_IPRINT(&quot;ready ~w&quot;, [Slogan]),
<a name="sc_rc_tcp_client_announce_ready-last_expr"/><a name="36350"/>36350: <b>    ?SEV_ANNOUNCE_READY</b>(Parent, Slogan).
<a name="36351"/>36351: 
<a name="sc_rc_tcp_client_await_continue-2"/><a name="36352"/>36352: <b>sc_rc_tcp_client_await_continue</b>(Parent, Slogan) -&gt;
<a name="36353"/>36353:     ?SEV_IPRINT(&quot;await ~w continue&quot;, [Slogan]),
<a name="sc_rc_tcp_client_await_continue-last_expr"/><a name="36354"/>36354: <b>    ?SEV_AWAIT_CONTINUE</b>(Parent, parent, Slogan).
<a name="36355"/>36355: 
<a name="sc_rc_tcp_client_connect-2"/><a name="36356"/>36356: <b>sc_rc_tcp_client_connect</b>(Sock, ServerSA) -&gt;
<a name="36357"/>36357:     i(&quot;sc_rc_tcp_client_connect -&gt; entry&quot;),
<a name="sc_rc_tcp_client_connect-last_expr"/><a name="36358"/>36358: <b>    case socket:connect</b>(Sock, ServerSA) of
<a name="36359"/>36359:         ok -&gt;
<a name="36360"/>36360:             ok;
<a name="36361"/>36361:         {error, Reason} -&gt;
<a name="36362"/>36362:             exit({connect, Reason})
<a name="36363"/>36363:     end.
<a name="36364"/>36364: 
<a name="sc_rc_tcp_client_close-2"/><a name="36365"/>36365: <b>sc_rc_tcp_client_close</b>(Sock, Path) -&gt;
<a name="36366"/>36366:     i(&quot;sc_rc_tcp_client_close -&gt; entry&quot;),
<a name="sc_rc_tcp_client_close-last_expr"/><a name="36367"/>36367: <b>    case socket:close</b>(Sock) of
<a name="36368"/>36368:         ok -&gt;
<a name="36369"/>36369:             unlink_path(Path),
<a name="36370"/>36370:             ok;
<a name="36371"/>36371:         {error, Reason} -&gt;
<a name="36372"/>36372:             ?SEV_EPRINT(&quot;failed closing: &quot;
<a name="36373"/>36373:                         &quot;~n   Reason: ~p&quot;, [Reason]),
<a name="36374"/>36374:             unlink_path(Path),
<a name="36375"/>36375:             {error, {close, Reason}}
<a name="36376"/>36376:     end.
<a name="36377"/>36377: 
<a name="sc_rc_tcp_client_await_terminate-1"/><a name="36378"/>36378: <b>sc_rc_tcp_client_await_terminate</b>(Parent) -&gt;
<a name="36379"/>36379:     i(&quot;sc_rc_tcp_client_await_terminate -&gt; entry&quot;),
<a name="sc_rc_tcp_client_await_terminate-last_expr"/><a name="36380"/>36380: <b>    case ?SEV_AWAIT_TERMINATE</b>(Parent, parent) of
<a name="36381"/>36381:         ok -&gt;
<a name="36382"/>36382:             ok;
<a name="36383"/>36383:         {error, Reason} -&gt;
<a name="36384"/>36384:             Reason
<a name="36385"/>36385:     end.
<a name="36386"/>36386: 
<a name="36387"/>36387: 
<a name="36388"/>36388: <i>%% The handlers run on the same node as the server (the local node).</i>
<a name="36389"/>36389: 
<a name="sc_rc_tcp_handler_start-3"/><a name="36390"/>36390: <b>sc_rc_tcp_handler_start</b>(ID, Recv, Sock) -&gt;
<a name="36391"/>36391:     Self     = self(),
<a name="36392"/>36392:     Fun      = fun() -&gt; sc_rc_tcp_handler(ID, Self, Recv, Sock) end,
<a name="36393"/>36393:     {Pid, _} = erlang:spawn_monitor(Fun),
<a name="sc_rc_tcp_handler_start-last_expr"/><a name="36394"/>36394:     Pid.
<a name="36395"/>36395: 
<a name="sc_rc_tcp_handler-4"/><a name="36396"/>36396: <b>sc_rc_tcp_handler</b>(ID, Parent, Recv, Sock) -&gt;
<a name="36397"/>36397:     sc_rc_tcp_handler_init(ID, socket:getopt(Sock, otp, fd), Parent),
<a name="36398"/>36398:     sc_rc_tcp_handler_await(Parent, recv),
<a name="36399"/>36399:     RecvRes = sc_rc_tcp_handler_recv(Recv, Sock),
<a name="36400"/>36400:     sc_rc_tcp_handler_announce_ready(Parent, recv, RecvRes),
<a name="36401"/>36401:     Reason = sc_rc_tcp_handler_await(Parent, terminate),
<a name="sc_rc_tcp_handler-last_expr"/><a name="36402"/>36402: <b>    exit</b>(Reason).
<a name="36403"/>36403: 
<a name="sc_rc_tcp_handler_init-3"/><a name="36404"/>36404: <b>sc_rc_tcp_handler_init</b>(ID, {ok, FD}, Parent) -&gt;
<a name="36405"/>36405:     put(sname, f(&quot;handler-~w:~w&quot;, [ID, FD])),
<a name="36406"/>36406:     _MRef = erlang:monitor(process, Parent),
<a name="36407"/>36407:     ?SEV_IPRINT(&quot;started&quot;),
<a name="36408"/>36408:     ?SEV_ANNOUNCE_READY(Parent, init),
<a name="sc_rc_tcp_handler_init-last_expr"/><a name="36409"/>36409:     ok.
<a name="36410"/>36410: 
<a name="sc_rc_tcp_handler_await-2"/><a name="36411"/>36411: <b>sc_rc_tcp_handler_await</b>(Parent, terminate) -&gt;
<a name="36412"/>36412:     ?SEV_IPRINT(&quot;await terminate&quot;),
<a name="36413"/>36413:     ?SEV_AWAIT_TERMINATE(Parent, tester);
<a name="36414"/>36414: <b>sc_rc_tcp_handler_await</b>(Parent, Slogan) -&gt;
<a name="36415"/>36415:     ?SEV_IPRINT(&quot;await ~w&quot;, [Slogan]),
<a name="sc_rc_tcp_handler_await-last_expr"/><a name="36416"/>36416: <b>    ?SEV_AWAIT_CONTINUE</b>(Parent, parent, Slogan).
<a name="36417"/>36417: 
<a name="sc_rc_tcp_handler_recv-2"/><a name="36418"/>36418: <b>sc_rc_tcp_handler_recv</b>(Recv, Sock) -&gt;
<a name="36419"/>36419:     ?SEV_IPRINT(&quot;recv&quot;),
<a name="sc_rc_tcp_handler_recv-last_expr"/><a name="36420"/>36420: <b>    try Recv</b>(Sock) of
<a name="36421"/>36421:         {error, closed} -&gt;
<a name="36422"/>36422:             ok;
<a name="36423"/>36423:         {ok, Data} -&gt;
<a name="36424"/>36424:             ?SEV_IPRINT(&quot;unexpected success: &quot;
<a name="36425"/>36425:                         &quot;~n   (Unexp) Data: ~p&quot;
<a name="36426"/>36426:                         &quot;~n   Socket Info:  ~p&quot;, [Data, socket:info(Sock)]),
<a name="36427"/>36427:             {error, unexpected_success};
<a name="36428"/>36428:         {error, Reason} = ERROR -&gt;
<a name="36429"/>36429:             ?SEV_IPRINT(&quot;receive error: &quot;
<a name="36430"/>36430:                         &quot;~n   ~p&quot;, [Reason]),
<a name="36431"/>36431:             ERROR
<a name="36432"/>36432:     catch
<a name="36433"/>36433:         error:notsup = Error:Stack -&gt;
<a name="36434"/>36434:             ?SEV_IPRINT(&quot;receive ~w error: skip&quot;
<a name="36435"/>36435:                         &quot;~n   Stack: ~p&quot;, [Error, Stack]),
<a name="36436"/>36436:             exit({skip, Error});
<a name="36437"/>36437:         C:E:S -&gt;
<a name="36438"/>36438:             ?SEV_IPRINT(&quot;receive failure: &quot;
<a name="36439"/>36439:                         &quot;~n   Class: ~p&quot;
<a name="36440"/>36440:                         &quot;~n   Error: ~p&quot;
<a name="36441"/>36441:                         &quot;~n   Stack: ~p&quot;, [C, E, S]),
<a name="36442"/>36442:             {error, {recv, C, E, S}}
<a name="36443"/>36443:     end.
<a name="36444"/>36444: 
<a name="sc_rc_tcp_handler_announce_ready-3"/><a name="36445"/>36445: <b>sc_rc_tcp_handler_announce_ready</b>(Parent, Slogan, Result) -&gt;
<a name="36446"/>36446:     ?SEV_IPRINT(&quot;announce ready&quot;),
<a name="36447"/>36447:     ?SEV_ANNOUNCE_READY(Parent, Slogan, Result),
<a name="sc_rc_tcp_handler_announce_ready-last_expr"/><a name="36448"/>36448:     ok.
<a name="36449"/>36449: 
<a name="36450"/>36450: 
<a name="36451"/>36451: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="36452"/>36452: <i>%% This test case is intended to test what happens when a socket is </i>
<a name="36453"/>36453: <i>%% remotely closed while the process is calling the recvmsg function.</i>
<a name="36454"/>36454: <i>%% Socket is IPv4.</i>
<a name="36455"/>36455: 
<a name="sc_rc_recvmsg_response_tcp4-1"/><a name="36456"/>36456: <b>sc_rc_recvmsg_response_tcp4</b>(_Config) when is_list(_Config) -&gt;
<a name="36457"/>36457:     ?TT(?SECS(30)),
<a name="sc_rc_recvmsg_response_tcp4-last_expr"/><a name="36458"/>36458: <b>    tc_try</b>(sc_rc_recvmsg_response_tcp4,
<a name="36459"/>36459:            fun() -&gt; has_support_ipv4() end,
<a name="36460"/>36460:            fun() -&gt;
<a name="36461"/>36461:                    Recv      = fun(Sock) -&gt; socket:recvmsg(Sock) end,
<a name="36462"/>36462:                    InitState = #{domain   =&gt; inet,
<a name="36463"/>36463:                                  protocol =&gt; tcp,
<a name="36464"/>36464:                                  recv     =&gt; Recv},
<a name="36465"/>36465:                    ok = sc_rc_receive_response_tcp(InitState)
<a name="36466"/>36466:            end).
<a name="36467"/>36467: 
<a name="36468"/>36468: 
<a name="36469"/>36469: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="36470"/>36470: <i>%% This test case is intended to test what happens when a socket is </i>
<a name="36471"/>36471: <i>%% remotely closed while the process is calling the recvmsg function.</i>
<a name="36472"/>36472: <i>%% Socket is IPv6.</i>
<a name="36473"/>36473: 
<a name="sc_rc_recvmsg_response_tcp6-1"/><a name="36474"/>36474: <b>sc_rc_recvmsg_response_tcp6</b>(_Config) when is_list(_Config) -&gt;
<a name="36475"/>36475:     ?TT(?SECS(30)),
<a name="sc_rc_recvmsg_response_tcp6-last_expr"/><a name="36476"/>36476: <b>    tc_try</b>(sc_rc_recvmsg_response_tcp6,
<a name="36477"/>36477:            fun() -&gt; has_support_ipv6() end,
<a name="36478"/>36478:            fun() -&gt;
<a name="36479"/>36479:                    Recv      = fun(Sock) -&gt; socket:recvmsg(Sock) end,
<a name="36480"/>36480:                    InitState = #{domain   =&gt; inet6,
<a name="36481"/>36481:                                  protocol =&gt; tcp,
<a name="36482"/>36482:                                  recv     =&gt; Recv},
<a name="36483"/>36483:                    ok = sc_rc_receive_response_tcp(InitState)
<a name="36484"/>36484:            end).
<a name="36485"/>36485: 
<a name="36486"/>36486: 
<a name="36487"/>36487: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="36488"/>36488: <i>%% This test case is intended to test what happens when a socket is </i>
<a name="36489"/>36489: <i>%% remotely closed while the process is calling the recvmsg function.</i>
<a name="36490"/>36490: <i>%% Socket is Unix Domain (stream) socket.</i>
<a name="36491"/>36491: 
<a name="sc_rc_recvmsg_response_tcpL-1"/><a name="36492"/>36492: <b>sc_rc_recvmsg_response_tcpL</b>(_Config) when is_list(_Config) -&gt;
<a name="36493"/>36493:     ?TT(?SECS(30)),
<a name="sc_rc_recvmsg_response_tcpL-last_expr"/><a name="36494"/>36494: <b>    tc_try</b>(sc_rc_recvmsg_response_tcpL,
<a name="36495"/>36495:            fun() -&gt; has_support_unix_domain_socket() end,
<a name="36496"/>36496:            fun() -&gt;
<a name="36497"/>36497:                    Recv      = fun(Sock) -&gt; socket:recvmsg(Sock) end,
<a name="36498"/>36498:                    InitState = #{domain   =&gt; local,
<a name="36499"/>36499:                                  protocol =&gt; default,
<a name="36500"/>36500:                                  recv     =&gt; Recv},
<a name="36501"/>36501:                    ok = sc_rc_receive_response_tcp(InitState)
<a name="36502"/>36502:            end).
<a name="36503"/>36503: 
<a name="36504"/>36504: 
<a name="36505"/>36505: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="36506"/>36506: <i>%% This test case is intended to test what happens when a socket is</i>
<a name="36507"/>36507: <i>%% remotely closed while the process is calling the recv function.</i>
<a name="36508"/>36508: <i>%% The remote client sends data, then shutdown(write) and then the</i>
<a name="36509"/>36509: <i>%% reader attempts a recv.</i>
<a name="36510"/>36510: <i>%% Socket is IPv4.</i>
<a name="36511"/>36511: <i>%%</i>
<a name="36512"/>36512: <i>%% To minimize the chance of &quot;weirdness&quot;, we should really have test cases</i>
<a name="36513"/>36513: <i>%% where the two sides of the connection is on different machines. But for</i>
<a name="36514"/>36514: <i>%% now, we will make do with different VMs on the same host.</i>
<a name="36515"/>36515: <i>%% This would of course not work for Unix Domain sockets.</i>
<a name="36516"/>36516: <i>%%</i>
<a name="36517"/>36517: 
<a name="sc_rs_recv_send_shutdown_receive_tcp4-1"/><a name="36518"/>36518: <b>sc_rs_recv_send_shutdown_receive_tcp4</b>(_Config) when is_list(_Config) -&gt;
<a name="36519"/>36519:     ?TT(?SECS(30)),
<a name="sc_rs_recv_send_shutdown_receive_tcp4-last_expr"/><a name="36520"/>36520: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="36521"/>36521:            fun() -&gt; has_support_ipv4() end,
<a name="36522"/>36522:            fun() -&gt;
<a name="36523"/>36523:                    MsgData   = ?DATA,
<a name="36524"/>36524:                    Recv      = fun(Sock) -&gt;
<a name="36525"/>36525:                                        socket:recv(Sock)
<a name="36526"/>36526:                                end,
<a name="36527"/>36527:                    Send      = fun(Sock, Data) -&gt;
<a name="36528"/>36528:                                        socket:send(Sock, Data)
<a name="36529"/>36529:                                end,
<a name="36530"/>36530:                    InitState = #{domain =&gt; inet,
<a name="36531"/>36531:                                  proto  =&gt; tcp,
<a name="36532"/>36532:                                  recv   =&gt; Recv,
<a name="36533"/>36533:                                  send   =&gt; Send,
<a name="36534"/>36534:                                  data   =&gt; MsgData},
<a name="36535"/>36535:                    ok = sc_rs_send_shutdown_receive_tcp(InitState)
<a name="36536"/>36536:            end).
<a name="36537"/>36537: 
<a name="36538"/>36538: 
<a name="36539"/>36539: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="36540"/>36540: <i>%% This test case is intended to test what happens when a socket is</i>
<a name="36541"/>36541: <i>%% remotely closed while the process is calling the recv function.</i>
<a name="36542"/>36542: <i>%% The remote client sends data, then shutdown(write) and then the</i>
<a name="36543"/>36543: <i>%% reader attempts a recv.</i>
<a name="36544"/>36544: <i>%% Socket is IPv6.</i>
<a name="36545"/>36545: 
<a name="sc_rs_recv_send_shutdown_receive_tcp6-1"/><a name="36546"/>36546: <b>sc_rs_recv_send_shutdown_receive_tcp6</b>(_Config) when is_list(_Config) -&gt;
<a name="sc_rs_recv_send_shutdown_receive_tcp6-last_expr"/><a name="36547"/>36547: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="36548"/>36548:            fun() -&gt; has_support_ipv6() end,
<a name="36549"/>36549:            fun() -&gt;
<a name="36550"/>36550:                    ?TT(?SECS(10)),
<a name="36551"/>36551:                    MsgData   = ?DATA,
<a name="36552"/>36552:                    Recv      = fun(Sock) -&gt;
<a name="36553"/>36553:                                        socket:recv(Sock)
<a name="36554"/>36554:                                end,
<a name="36555"/>36555:                    Send      = fun(Sock, Data) -&gt;
<a name="36556"/>36556:                                        socket:send(Sock, Data)
<a name="36557"/>36557:                                end,
<a name="36558"/>36558:                    InitState = #{domain =&gt; inet6,
<a name="36559"/>36559:                                  proto  =&gt; tcp,
<a name="36560"/>36560:                                  recv   =&gt; Recv,
<a name="36561"/>36561:                                  send   =&gt; Send,
<a name="36562"/>36562:                                  data   =&gt; MsgData},
<a name="36563"/>36563:                    ok = sc_rs_send_shutdown_receive_tcp(InitState)
<a name="36564"/>36564:            end).
<a name="36565"/>36565: 
<a name="36566"/>36566: 
<a name="36567"/>36567: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="36568"/>36568: <i>%% This test case is intended to test what happens when a socket is</i>
<a name="36569"/>36569: <i>%% remotely closed while the process is calling the recv function.</i>
<a name="36570"/>36570: <i>%% The remote client sends data, then shutdown(write) and then the</i>
<a name="36571"/>36571: <i>%% reader attempts a recv.</i>
<a name="36572"/>36572: <i>%% Socket is Unix Domain (stream) socket.</i>
<a name="36573"/>36573: 
<a name="sc_rs_recv_send_shutdown_receive_tcpL-1"/><a name="36574"/>36574: <b>sc_rs_recv_send_shutdown_receive_tcpL</b>(_Config) when is_list(_Config) -&gt;
<a name="36575"/>36575:     ?TT(?SECS(10)),
<a name="sc_rs_recv_send_shutdown_receive_tcpL-last_expr"/><a name="36576"/>36576: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="36577"/>36577:            fun() -&gt; has_support_unix_domain_socket() end,
<a name="36578"/>36578:            fun() -&gt;
<a name="36579"/>36579:                    MsgData   = ?DATA,
<a name="36580"/>36580:                    Recv      = fun(Sock) -&gt;
<a name="36581"/>36581:                                        socket:recv(Sock)
<a name="36582"/>36582:                                end,
<a name="36583"/>36583:                    Send      = fun(Sock, Data) -&gt;
<a name="36584"/>36584:                                        socket:send(Sock, Data)
<a name="36585"/>36585:                                end,
<a name="36586"/>36586:                    InitState = #{domain =&gt; local,
<a name="36587"/>36587:                                  proto  =&gt; default,
<a name="36588"/>36588:                                  recv   =&gt; Recv,
<a name="36589"/>36589:                                  send   =&gt; Send,
<a name="36590"/>36590:                                  data   =&gt; MsgData},
<a name="36591"/>36591:                    ok = sc_rs_send_shutdown_receive_tcp(InitState)
<a name="36592"/>36592:            end).
<a name="36593"/>36593: 
<a name="36594"/>36594: 
<a name="36595"/>36595: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="36596"/>36596: 
<a name="sc_rs_send_shutdown_receive_tcp-1"/><a name="36597"/>36597: <b>sc_rs_send_shutdown_receive_tcp</b>(InitState) -&gt;
<a name="36598"/>36598:     %% The connection is handled by a handler processes.
<a name="36599"/>36599:     %% This are created (on the fly) and handled internally
<a name="36600"/>36600:     %% by the server!
<a name="36601"/>36601:     ServerSeq =
<a name="36602"/>36602:         [
<a name="36603"/>36603:          %% *** Wait for start order part ***
<a name="36604"/>36604:          #{desc =&gt; &quot;await start&quot;,
<a name="36605"/>36605:            cmd  =&gt; fun(State) -&gt;
<a name="36606"/>36606:                            Tester = ?SEV_AWAIT_START(),
<a name="36607"/>36607:                            {ok, State#{tester =&gt; Tester}}
<a name="36608"/>36608:                    end},
<a name="36609"/>36609:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="36610"/>36610:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="36611"/>36611:                            _MRef = erlang:monitor(process, Tester),
<a name="36612"/>36612:                            ok
<a name="36613"/>36613:                    end},
<a name="36614"/>36614: 
<a name="36615"/>36615:          %% *** Init part ***
<a name="36616"/>36616:          #{desc =&gt; &quot;which local address&quot;,
<a name="36617"/>36617:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="36618"/>36618:                            i(&quot;get local address for ~p&quot;, [Domain]),
<a name="36619"/>36619:                            LSA = which_local_socket_addr(Domain),
<a name="36620"/>36620:                            {ok, State#{local_sa =&gt; LSA}}
<a name="36621"/>36621:                    end},
<a name="36622"/>36622:          #{desc =&gt; &quot;create listen socket&quot;,
<a name="36623"/>36623:            cmd  =&gt; fun(#{domain := Domain, proto := Proto} = State) -&gt;
<a name="36624"/>36624:                            case socket:open(Domain, stream, Proto) of
<a name="36625"/>36625:                                {ok, Sock} -&gt;
<a name="36626"/>36626:                                    {ok, State#{lsock =&gt; Sock}};
<a name="36627"/>36627:                                {error, _} = ERROR -&gt;
<a name="36628"/>36628:                                    ERROR
<a name="36629"/>36629:                            end
<a name="36630"/>36630:                    end},
<a name="36631"/>36631:          #{desc =&gt; &quot;bind to local address&quot;,
<a name="36632"/>36632:            cmd  =&gt; fun(#{domain   := local,
<a name="36633"/>36633:                          lsock    := LSock,
<a name="36634"/>36634:                          local_sa := LSA} = _State) -&gt;
<a name="36635"/>36635:                            case socket:bind(LSock, LSA) of
<a name="36636"/>36636:                                ok -&gt;
<a name="36637"/>36637:                                    ok; % We do not care about the port for local
<a name="36638"/>36638:                                {error, _} = ERROR -&gt;
<a name="36639"/>36639:                                    ERROR
<a name="36640"/>36640:                            end;
<a name="36641"/>36641:                       (#{lsock := LSock, local_sa := LSA} = State) -&gt;
<a name="36642"/>36642:                            case sock_bind(LSock, LSA) of
<a name="36643"/>36643:                                ok -&gt;
<a name="36644"/>36644:                                    Port = sock_port(LSock),
<a name="36645"/>36645:                                    ?SEV_IPRINT(&quot;bound to port: ~w&quot;, [Port]),
<a name="36646"/>36646:                                    {ok, State#{lport =&gt; Port}};
<a name="36647"/>36647:                                {error, _} = ERROR -&gt;
<a name="36648"/>36648:                                    ERROR
<a name="36649"/>36649:                            end
<a name="36650"/>36650:                    end},
<a name="36651"/>36651:          #{desc =&gt; &quot;make listen socket&quot;,
<a name="36652"/>36652:            cmd  =&gt; fun(#{lsock := LSock}) -&gt;
<a name="36653"/>36653:                            socket:listen(LSock)
<a name="36654"/>36654:                    end},
<a name="36655"/>36655:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="36656"/>36656:            cmd  =&gt; fun(#{domain := local,
<a name="36657"/>36657:                          tester := Tester, local_sa := LSA}) -&gt;
<a name="36658"/>36658:                            ?SEV_ANNOUNCE_READY(Tester, init, LSA),
<a name="36659"/>36659:                            ok;
<a name="36660"/>36660:                       (#{tester := Tester, local_sa := LSA, lport := Port}) -&gt;
<a name="36661"/>36661:                            ServerSA = LSA#{port =&gt; Port},
<a name="36662"/>36662:                            ?SEV_ANNOUNCE_READY(Tester, init, ServerSA),
<a name="36663"/>36663:                            ok
<a name="36664"/>36664:                    end},
<a name="36665"/>36665: 
<a name="36666"/>36666:          %% The actual test
<a name="36667"/>36667:          #{desc =&gt; &quot;await continue (accept)&quot;,
<a name="36668"/>36668:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="36669"/>36669:                            ?SEV_ANNOUNCE_CONTINUE(Tester, tester, accept)
<a name="36670"/>36670:                    end},
<a name="36671"/>36671:          #{desc =&gt; &quot;accept&quot;,
<a name="36672"/>36672:            cmd  =&gt; fun(#{lsock := LSock, recv := Recv} = State) -&gt;
<a name="36673"/>36673:                            case socket:accept(LSock) of
<a name="36674"/>36674:                                {ok, Sock} -&gt;
<a name="36675"/>36675:                                    ?SEV_IPRINT(&quot;accepted: try start handler&quot;),
<a name="36676"/>36676:                                    Handler =
<a name="36677"/>36677:                                        sc_rs_tcp_handler_start(Recv, Sock),
<a name="36678"/>36678:                                    ?SEV_IPRINT(&quot;handler started&quot;),
<a name="36679"/>36679:                                    {ok, State#{csock   =&gt; Sock,
<a name="36680"/>36680:                                                handler =&gt; Handler}};
<a name="36681"/>36681:                                {error, _} = ERROR -&gt;
<a name="36682"/>36682:                                    ERROR
<a name="36683"/>36683:                            end
<a name="36684"/>36684:                    end},
<a name="36685"/>36685:          #{desc =&gt; &quot;await handler ready (init)&quot;,
<a name="36686"/>36686:            cmd  =&gt; fun(#{tester  := Tester,
<a name="36687"/>36687:                          handler := Handler} = _State) -&gt;
<a name="36688"/>36688:                            ?SEV_AWAIT_READY(Handler, handler, init,
<a name="36689"/>36689:                                             [{tester, Tester}])
<a name="36690"/>36690:                    end},
<a name="36691"/>36691:          #{desc =&gt; &quot;announce ready (accept)&quot;,
<a name="36692"/>36692:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="36693"/>36693:                            ?SEV_ANNOUNCE_READY(Tester, accept),
<a name="36694"/>36694:                            ok
<a name="36695"/>36695:                    end},
<a name="36696"/>36696: 
<a name="36697"/>36697:          #{desc =&gt; &quot;await continue (first recv)&quot;,
<a name="36698"/>36698:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="36699"/>36699:                            ?SEV_AWAIT_CONTINUE(Tester, tester, recv)
<a name="36700"/>36700:                    end},
<a name="36701"/>36701:          #{desc =&gt; &quot;order handler to receive (first)&quot;,
<a name="36702"/>36702:            cmd  =&gt; fun(#{handler := Pid} = _State) -&gt;
<a name="36703"/>36703:                            ?SEV_ANNOUNCE_CONTINUE(Pid, recv),
<a name="36704"/>36704:                            ok
<a name="36705"/>36705:                    end},
<a name="36706"/>36706:          #{desc =&gt; &quot;await ready from handler (first recv)&quot;,
<a name="36707"/>36707:            cmd  =&gt; fun(#{tester := Tester, handler := Pid} = _State) -&gt;
<a name="36708"/>36708:                            case ?SEV_AWAIT_READY(Pid, handler, recv,
<a name="36709"/>36709:                                                  [{tester, Tester}]) of
<a name="36710"/>36710:                                {ok, Result} -&gt;
<a name="36711"/>36711:                                    ?SEV_IPRINT(&quot;first recv: ~p&quot;, [Result]),
<a name="36712"/>36712:                                    ok;
<a name="36713"/>36713:                                {error, _} = ERROR -&gt;
<a name="36714"/>36714:                                    ERROR
<a name="36715"/>36715:                            end
<a name="36716"/>36716:                    end},
<a name="36717"/>36717:          #{desc =&gt; &quot;announce ready (first recv)&quot;,
<a name="36718"/>36718:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="36719"/>36719:                            ?SEV_ANNOUNCE_READY(Tester, recv),
<a name="36720"/>36720:                            ok
<a name="36721"/>36721:                    end},
<a name="36722"/>36722:          #{desc =&gt; &quot;await continue (second recv)&quot;,
<a name="36723"/>36723:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="36724"/>36724:                            ?SEV_AWAIT_CONTINUE(Tester, tester, recv)
<a name="36725"/>36725:                    end},
<a name="36726"/>36726:          #{desc =&gt; &quot;order handler to receive (second)&quot;,
<a name="36727"/>36727:            cmd  =&gt; fun(#{handler := Pid} = _State) -&gt;
<a name="36728"/>36728:                            ?SEV_ANNOUNCE_CONTINUE(Pid, recv),
<a name="36729"/>36729:                            ok
<a name="36730"/>36730:                    end},
<a name="36731"/>36731:          #{desc =&gt; &quot;await ready from handler (second recv)&quot;,
<a name="36732"/>36732:            cmd  =&gt; fun(#{tester := Tester, handler := Pid} = _State) -&gt;
<a name="36733"/>36733:                            case ?SEV_AWAIT_READY(Pid, handler, recv,
<a name="36734"/>36734:                                                  [{tester, Tester}]) of
<a name="36735"/>36735:                                {ok, Result} -&gt;
<a name="36736"/>36736:                                    ?SEV_IPRINT(&quot;second recv: ~p&quot;, [Result]),
<a name="36737"/>36737:                                    ok;
<a name="36738"/>36738:                                {error, _} = ERROR -&gt;
<a name="36739"/>36739:                                    ERROR
<a name="36740"/>36740:                            end
<a name="36741"/>36741:                    end},
<a name="36742"/>36742:          #{desc =&gt; &quot;announce ready (second recv)&quot;,
<a name="36743"/>36743:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="36744"/>36744:                            ?SEV_ANNOUNCE_READY(Tester, recv),
<a name="36745"/>36745:                            ok
<a name="36746"/>36746:                    end},
<a name="36747"/>36747: 
<a name="36748"/>36748:          %% Termination
<a name="36749"/>36749:          #{desc =&gt; &quot;await terminate (from tester)&quot;,
<a name="36750"/>36750:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="36751"/>36751:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="36752"/>36752:                                ok -&gt;
<a name="36753"/>36753:                                    {ok, maps:remove(tester, State)};
<a name="36754"/>36754:                                {error, _} = ERROR -&gt;
<a name="36755"/>36755:                                    ERROR
<a name="36756"/>36756:                            end
<a name="36757"/>36757:                    end},
<a name="36758"/>36758:          #{desc =&gt; &quot;order handler to terminate&quot;,
<a name="36759"/>36759:            cmd  =&gt; fun(#{handler := Pid} = _State) -&gt;
<a name="36760"/>36760:                            ?SEV_ANNOUNCE_TERMINATE(Pid),
<a name="36761"/>36761:                            ok
<a name="36762"/>36762:                    end},
<a name="36763"/>36763:          #{desc =&gt; &quot;await handler termination&quot;,
<a name="36764"/>36764:            cmd  =&gt; fun(#{handler := Pid} = State) -&gt;
<a name="36765"/>36765:                            ?SEV_AWAIT_TERMINATION(Pid),
<a name="36766"/>36766:                            State1 = maps:remove(csock,   State),
<a name="36767"/>36767:                            State2 = maps:remove(handler, State1),
<a name="36768"/>36768:                            {ok, State2}
<a name="36769"/>36769:                    end},
<a name="36770"/>36770:          #{desc =&gt; &quot;close listen socket&quot;,
<a name="36771"/>36771:            cmd  =&gt; fun(#{domain   := local,
<a name="36772"/>36772:                          lsock    := Sock,
<a name="36773"/>36773:                          local_sa := #{path := Path}} = State) -&gt;
<a name="36774"/>36774:                            socket:close(Sock),
<a name="36775"/>36775:                            State1 =
<a name="36776"/>36776:                                unlink_path(Path,
<a name="36777"/>36777:                                            fun() -&gt;
<a name="36778"/>36778:                                                    maps:remove(local_sa, State)
<a name="36779"/>36779:                                            end,
<a name="36780"/>36780:                                            fun() -&gt; State end),
<a name="36781"/>36781:                            {ok, maps:remove(lsock, State1)};
<a name="36782"/>36782:                       (#{lsock := LSock} = State) -&gt;
<a name="36783"/>36783:                            case socket:close(LSock) of
<a name="36784"/>36784:                                ok -&gt;
<a name="36785"/>36785:                                    {ok, maps:remove(lsock, State)};
<a name="36786"/>36786:                                {error, _} = ERROR -&gt;
<a name="36787"/>36787:                                    ERROR
<a name="36788"/>36788:                            end
<a name="36789"/>36789:                    end},
<a name="36790"/>36790: 
<a name="36791"/>36791:          %% *** We are done ***
<a name="36792"/>36792:          ?SEV_FINISH_NORMAL
<a name="36793"/>36793:         ],
<a name="36794"/>36794: 
<a name="36795"/>36795:     ClientSeq =
<a name="36796"/>36796:         [
<a name="36797"/>36797:          %% *** Wait for start order part ***
<a name="36798"/>36798:          #{desc =&gt; &quot;await start&quot;,
<a name="36799"/>36799:            cmd  =&gt; fun(State) -&gt;
<a name="36800"/>36800:                            {Tester, ServerSA} = ?SEV_AWAIT_START(),
<a name="36801"/>36801:                            {ok, State#{tester    =&gt; Tester, 
<a name="36802"/>36802:                                        server_sa =&gt; ServerSA}}
<a name="36803"/>36803:                    end},
<a name="36804"/>36804:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="36805"/>36805:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="36806"/>36806:                            _MRef = erlang:monitor(process, Tester),
<a name="36807"/>36807:                            ok
<a name="36808"/>36808:                    end},
<a name="36809"/>36809: 
<a name="36810"/>36810:          %% *** Init part ***
<a name="36811"/>36811:          #{desc =&gt; &quot;create node&quot;,
<a name="36812"/>36812:            cmd  =&gt; fun(State) -&gt;
<a name="36813"/>36813:                            {Peer, Node} = ?START_NODE(&quot;client&quot;),
<a name="36814"/>36814:                            {ok, State#{peer =&gt; Peer, node =&gt; Node}}
<a name="36815"/>36815:                    end},
<a name="36816"/>36816:          #{desc =&gt; &quot;monitor client node&quot;,
<a name="36817"/>36817:            cmd  =&gt; fun(#{node := Node} = _State) -&gt;
<a name="36818"/>36818:                            true = erlang:monitor_node(Node, true),
<a name="36819"/>36819:                            ok
<a name="36820"/>36820:                    end},
<a name="36821"/>36821:          #{desc =&gt; &quot;start remote client on client node&quot;,
<a name="36822"/>36822:            cmd  =&gt; fun(#{node := Node,
<a name="36823"/>36823:                          send := Send} = State) -&gt;
<a name="36824"/>36824:                            Pid = sc_rs_tcp_client_start(Node, Send),
<a name="36825"/>36825:                            ?SEV_IPRINT(&quot;client ~p started&quot;, [Pid]),
<a name="36826"/>36826:                            {ok, State#{rclient =&gt; Pid}}
<a name="36827"/>36827:                    end},
<a name="36828"/>36828:          #{desc =&gt; &quot;monitor remote client&quot;,
<a name="36829"/>36829:            cmd  =&gt; fun(#{rclient := Pid}) -&gt;
<a name="36830"/>36830:                            _MRef = erlang:monitor(process, Pid),
<a name="36831"/>36831:                            ok
<a name="36832"/>36832:                    end},
<a name="36833"/>36833:          #{desc =&gt; &quot;order remote client to start&quot;,
<a name="36834"/>36834:            cmd  =&gt; fun(#{rclient   := Client,
<a name="36835"/>36835:                          proto     := Proto,
<a name="36836"/>36836:                          server_sa := ServerSA}) -&gt;
<a name="36837"/>36837:                            ?SEV_ANNOUNCE_START(Client, {ServerSA, Proto}),
<a name="36838"/>36838:                            ok
<a name="36839"/>36839:                    end},
<a name="36840"/>36840:          #{desc =&gt; &quot;await remote client ready&quot;,
<a name="36841"/>36841:            cmd  =&gt; fun(#{tester  := Tester,
<a name="36842"/>36842:                          rclient := Client} = _State) -&gt;
<a name="36843"/>36843:                            ?SEV_AWAIT_READY(Client, rclient, init, 
<a name="36844"/>36844:                                             [{tester, Tester}])
<a name="36845"/>36845:                    end},
<a name="36846"/>36846:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="36847"/>36847:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="36848"/>36848:                            ?SEV_ANNOUNCE_READY(Tester, init),
<a name="36849"/>36849:                            ok
<a name="36850"/>36850:                    end},
<a name="36851"/>36851: 
<a name="36852"/>36852:          %% The actual test
<a name="36853"/>36853:          #{desc =&gt; &quot;await continue (connect)&quot;,
<a name="36854"/>36854:            cmd  =&gt; fun(#{tester  := Tester,
<a name="36855"/>36855:                          rclient := Client} = _State) -&gt;
<a name="36856"/>36856:                            ?SEV_AWAIT_CONTINUE(Tester, tester, connect, 
<a name="36857"/>36857:                                                [{rclient, Client}]),
<a name="36858"/>36858:                            ok
<a name="36859"/>36859:                    end},
<a name="36860"/>36860:          #{desc =&gt; &quot;order remote client to continue (connect)&quot;,
<a name="36861"/>36861:            cmd  =&gt; fun(#{rclient := Client}) -&gt;
<a name="36862"/>36862:                            ?SEV_ANNOUNCE_CONTINUE(Client, connect),
<a name="36863"/>36863:                            ok
<a name="36864"/>36864:                    end},
<a name="36865"/>36865:          #{desc =&gt; &quot;await client process ready (connect)&quot;,
<a name="36866"/>36866:            cmd  =&gt; fun(#{tester  := Tester,
<a name="36867"/>36867:                          rclient := Client} = _State) -&gt;
<a name="36868"/>36868:                            ?SEV_AWAIT_READY(Client, rclient, connect,
<a name="36869"/>36869:                                             [{tester, Tester}])
<a name="36870"/>36870:                    end},
<a name="36871"/>36871:          #{desc =&gt; &quot;announce ready (connect)&quot;,
<a name="36872"/>36872:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="36873"/>36873:                            ?SEV_ANNOUNCE_READY(Tester, connect),
<a name="36874"/>36874:                            ok
<a name="36875"/>36875:                    end},
<a name="36876"/>36876: 
<a name="36877"/>36877:          #{desc =&gt; &quot;await continue (send)&quot;,
<a name="36878"/>36878:            cmd  =&gt; fun(#{tester  := Tester,
<a name="36879"/>36879:                          rclient := Client} = State) -&gt;
<a name="36880"/>36880:                            case ?SEV_AWAIT_CONTINUE(Tester, tester, send,
<a name="36881"/>36881:                                                     [{rclient, Client}]) of
<a name="36882"/>36882:                                {ok, Data} -&gt;
<a name="36883"/>36883:                                    {ok, State#{rclient_data =&gt; Data}};
<a name="36884"/>36884:                                {error, _} = ERROR -&gt;
<a name="36885"/>36885:                                    ERROR
<a name="36886"/>36886:                            end
<a name="36887"/>36887:                    end},
<a name="36888"/>36888:          #{desc =&gt; &quot;order remote client to send&quot;,
<a name="36889"/>36889:            cmd  =&gt; fun(#{rclient      := Client,
<a name="36890"/>36890:                          rclient_data := Data}) -&gt;
<a name="36891"/>36891:                            ?SEV_ANNOUNCE_CONTINUE(Client, send, Data),
<a name="36892"/>36892:                            ok
<a name="36893"/>36893:                    end},
<a name="36894"/>36894:          #{desc =&gt; &quot;await remote client ready (closed)&quot;,
<a name="36895"/>36895:            cmd  =&gt; fun(#{tester  := Tester,
<a name="36896"/>36896:                          rclient := Client} = _State) -&gt;
<a name="36897"/>36897:                            ?SEV_AWAIT_READY(Client, rclient, send,
<a name="36898"/>36898:                                             [{tester, Tester}])
<a name="36899"/>36899:                    end},
<a name="36900"/>36900:          #{desc =&gt; &quot;announce ready (send)&quot;,
<a name="36901"/>36901:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="36902"/>36902:                            ?SEV_ANNOUNCE_READY(Tester, send),
<a name="36903"/>36903:                            ok
<a name="36904"/>36904:                    end},
<a name="36905"/>36905: 
<a name="36906"/>36906: 
<a name="36907"/>36907:          #{desc =&gt; &quot;await continue (shutdown)&quot;,
<a name="36908"/>36908:            cmd  =&gt; fun(#{tester  := Tester,
<a name="36909"/>36909:                          rclient := Client} = _State) -&gt;
<a name="36910"/>36910:                            ?SEV_AWAIT_CONTINUE(Tester, tester, shutdown,
<a name="36911"/>36911:                                                [{rclient, Client}]),
<a name="36912"/>36912:                            ok
<a name="36913"/>36913:                    end},
<a name="36914"/>36914:          #{desc =&gt; &quot;order remote client to shutdown&quot;,
<a name="36915"/>36915:            cmd  =&gt; fun(#{rclient := Client}) -&gt;
<a name="36916"/>36916:                            ?SEV_ANNOUNCE_CONTINUE(Client, shutdown),
<a name="36917"/>36917:                            ok
<a name="36918"/>36918:                    end},
<a name="36919"/>36919:          #{desc =&gt; &quot;await remote client ready (shiutdown)&quot;,
<a name="36920"/>36920:            cmd  =&gt; fun(#{tester  := Tester,
<a name="36921"/>36921:                          rclient := Client} = _State) -&gt;
<a name="36922"/>36922:                            ?SEV_AWAIT_READY(Client, rclient, shutdown,
<a name="36923"/>36923:                                             [{tester, Tester}])
<a name="36924"/>36924:                    end},
<a name="36925"/>36925:          #{desc =&gt; &quot;announce ready (shutdown)&quot;,
<a name="36926"/>36926:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="36927"/>36927:                            ?SEV_ANNOUNCE_READY(Tester, shutdown),
<a name="36928"/>36928:                            ok
<a name="36929"/>36929:                    end},
<a name="36930"/>36930: 
<a name="36931"/>36931:          #{desc =&gt; &quot;await continue (close)&quot;,
<a name="36932"/>36932:            cmd  =&gt; fun(#{tester  := Tester,
<a name="36933"/>36933:                          rclient := Client} = _State) -&gt;
<a name="36934"/>36934:                            ?SEV_AWAIT_CONTINUE(Tester, tester, close,
<a name="36935"/>36935:                                                [{rclient, Client}]),
<a name="36936"/>36936:                            ok
<a name="36937"/>36937:                    end},
<a name="36938"/>36938:          #{desc =&gt; &quot;order remote client to close&quot;,
<a name="36939"/>36939:            cmd  =&gt; fun(#{rclient := Client}) -&gt;
<a name="36940"/>36940:                            ?SEV_ANNOUNCE_CONTINUE(Client, close),
<a name="36941"/>36941:                            ok
<a name="36942"/>36942:                    end},
<a name="36943"/>36943:          #{desc =&gt; &quot;await remote client ready (closed)&quot;,
<a name="36944"/>36944:            cmd  =&gt; fun(#{tester  := Tester,
<a name="36945"/>36945:                          rclient := Client} = _State) -&gt;
<a name="36946"/>36946:                            ?SEV_AWAIT_READY(Client, rclient, close,
<a name="36947"/>36947:                                             [{tester, Tester}])
<a name="36948"/>36948:                    end},
<a name="36949"/>36949:          #{desc =&gt; &quot;announce ready (close)&quot;,
<a name="36950"/>36950:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="36951"/>36951:                            ?SEV_ANNOUNCE_READY(Tester, close),
<a name="36952"/>36952:                            ok
<a name="36953"/>36953:                    end},
<a name="36954"/>36954: 
<a name="36955"/>36955:          %% Termination
<a name="36956"/>36956:          #{desc =&gt; &quot;await terminate (from tester)&quot;,
<a name="36957"/>36957:            cmd  =&gt; fun(#{tester  := Tester,
<a name="36958"/>36958:                          rclient := Client} = State) -&gt;
<a name="36959"/>36959:                            case ?SEV_AWAIT_TERMINATE(Tester, tester,
<a name="36960"/>36960:                                                      [{rclient, Client}]) of
<a name="36961"/>36961:                                ok -&gt;
<a name="36962"/>36962:                                    {ok, maps:remove(tester, State)};
<a name="36963"/>36963:                                {error, _} = ERROR -&gt;
<a name="36964"/>36964:                                    ERROR
<a name="36965"/>36965:                            end
<a name="36966"/>36966:                    end},
<a name="36967"/>36967:          #{desc =&gt; &quot;kill remote client&quot;,
<a name="36968"/>36968:            cmd  =&gt; fun(#{rclient := Client}) -&gt;
<a name="36969"/>36969:                            ?SEV_ANNOUNCE_TERMINATE(Client),
<a name="36970"/>36970:                            ok
<a name="36971"/>36971:                    end},
<a name="36972"/>36972:          #{desc =&gt; &quot;await remote client termination&quot;,
<a name="36973"/>36973:            cmd  =&gt; fun(#{rclient := Client} = State) -&gt;
<a name="36974"/>36974:                            ?SEV_AWAIT_TERMINATION(Client),
<a name="36975"/>36975:                            State1 = maps:remove(rclient, State),
<a name="36976"/>36976:                            {ok, State1}
<a name="36977"/>36977:                    end},
<a name="36978"/>36978:          #{desc =&gt; &quot;stop client node&quot;,
<a name="36979"/>36979:            cmd  =&gt; fun(#{peer := Peer} = State) -&gt;
<a name="36980"/>36980:                            {ok,
<a name="36981"/>36981:                             try peer:stop(Peer) of
<a name="36982"/>36982:                                 ok -&gt;
<a name="36983"/>36983:                                     State#{node_stop =&gt; ok};
<a name="36984"/>36984:                                 {error, Reason} -&gt;
<a name="36985"/>36985:                                     ?SEV_EPRINT(&quot;Unexpected node stop result: &quot;
<a name="36986"/>36986:                                                 &quot;~n   ~p&quot;, [Reason]),
<a name="36987"/>36987:                                     State#{node_stop =&gt; error}
<a name="36988"/>36988:                             catch
<a name="36989"/>36989:                                 C:E:S -&gt;
<a name="36990"/>36990:                                     ?SEV_EPRINT(&quot;Unexpected node stop result: &quot;
<a name="36991"/>36991:                                                 &quot;~n   Class: ~p&quot;
<a name="36992"/>36992:                                                 &quot;~n   Error: ~p&quot;
<a name="36993"/>36993:                                                 &quot;~n   Stack: ~p&quot;,[C, E, S]),
<a name="36994"/>36994:                                     State#{node_stop =&gt; error}
<a name="36995"/>36995:                             end}
<a name="36996"/>36996:                    end},
<a name="36997"/>36997:          #{desc =&gt; &quot;await client node termination&quot;,
<a name="36998"/>36998:            cmd  =&gt; fun(#{node := Node, node_stop := ok} = State) -&gt;
<a name="36999"/>36999:                            ?SEV_IPRINT(&quot;Success node stop - await nodedown&quot;),
<a name="37000"/>37000:                            receive
<a name="37001"/>37001:                                {nodedown, Node} -&gt;
<a name="37002"/>37002:                                    ?SEV_IPRINT(&quot;nodedown received - cleanup&quot;),
<a name="37003"/>37003:                                    State1 = maps:remove(peer, State),
<a name="37004"/>37004:                                    State2 = maps:remove(node, State1),
<a name="37005"/>37005:                                    {ok, State2}
<a name="37006"/>37006:                            end;
<a name="37007"/>37007:                       (#{node_stop := error} = State) -&gt;
<a name="37008"/>37008:                            ?SEV_IPRINT(&quot;Failed node stop - cleanup&quot;),
<a name="37009"/>37009:                            State1 = maps:remove(peer, State),
<a name="37010"/>37010:                            State2 = maps:remove(node, State1),
<a name="37011"/>37011:                            {ok, State2}
<a name="37012"/>37012:                    end},
<a name="37013"/>37013: 
<a name="37014"/>37014:          %% *** We are done ***
<a name="37015"/>37015:          ?SEV_FINISH_NORMAL
<a name="37016"/>37016:         ],
<a name="37017"/>37017: 
<a name="37018"/>37018:     TesterSeq =
<a name="37019"/>37019:         [
<a name="37020"/>37020:          %% *** Init part ***
<a name="37021"/>37021:          #{desc =&gt; &quot;monitor server&quot;,
<a name="37022"/>37022:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="37023"/>37023:                            _MRef = erlang:monitor(process, Pid),
<a name="37024"/>37024:                            ok
<a name="37025"/>37025:                    end},
<a name="37026"/>37026:          #{desc =&gt; &quot;monitor client&quot;,
<a name="37027"/>37027:            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;
<a name="37028"/>37028:                            _MRef = erlang:monitor(process, Pid),
<a name="37029"/>37029:                            ok
<a name="37030"/>37030:                    end},
<a name="37031"/>37031: 
<a name="37032"/>37032:          %% Start the server
<a name="37033"/>37033:          #{desc =&gt; &quot;order server start&quot;,
<a name="37034"/>37034:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="37035"/>37035:                            ?SEV_ANNOUNCE_START(Pid),
<a name="37036"/>37036:                            ok
<a name="37037"/>37037:                    end},
<a name="37038"/>37038:          #{desc =&gt; &quot;await server ready (init)&quot;,
<a name="37039"/>37039:            cmd  =&gt; fun(#{server := Pid} = State) -&gt;
<a name="37040"/>37040:                            {ok, ServerSA} = ?SEV_AWAIT_READY(Pid, server, init),
<a name="37041"/>37041:                            {ok, State#{server_sa =&gt; ServerSA}}
<a name="37042"/>37042:                    end},
<a name="37043"/>37043: 
<a name="37044"/>37044:          %% Start the client(s)
<a name="37045"/>37045:          #{desc =&gt; &quot;order client start&quot;,
<a name="37046"/>37046:            cmd  =&gt; fun(#{client    := Pid,
<a name="37047"/>37047:                          server_sa := ServerSA} = _State) -&gt;
<a name="37048"/>37048:                            ?SEV_ANNOUNCE_START(Pid, ServerSA),
<a name="37049"/>37049:                            ok
<a name="37050"/>37050:                    end},
<a name="37051"/>37051:          #{desc =&gt; &quot;await client ready (init)&quot;,
<a name="37052"/>37052:            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;
<a name="37053"/>37053:                            ok = ?SEV_AWAIT_READY(Pid, client, init)
<a name="37054"/>37054:                    end},
<a name="37055"/>37055: 
<a name="37056"/>37056:          %% The actual test
<a name="37057"/>37057:          #{desc =&gt; &quot;order server continue (accept)&quot;,
<a name="37058"/>37058:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="37059"/>37059:                            ?SEV_ANNOUNCE_CONTINUE(Pid, accept),
<a name="37060"/>37060:                            ok
<a name="37061"/>37061:                    end},
<a name="37062"/>37062:          ?SEV_SLEEP(?SECS(1)),
<a name="37063"/>37063:          #{desc =&gt; &quot;order client continue (connect)&quot;,
<a name="37064"/>37064:            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;
<a name="37065"/>37065:                            ?SEV_ANNOUNCE_CONTINUE(Pid, connect),
<a name="37066"/>37066:                            ok
<a name="37067"/>37067:                    end},
<a name="37068"/>37068:          #{desc =&gt; &quot;await client ready (connect)&quot;,
<a name="37069"/>37069:            cmd  =&gt; fun(#{server := Server,
<a name="37070"/>37070:                          client := Client} = _State) -&gt;
<a name="37071"/>37071:                            ?SEV_AWAIT_READY(Client, client, connect,
<a name="37072"/>37072:                                             [{server, Server}]),
<a name="37073"/>37073:                            ok
<a name="37074"/>37074:                    end},
<a name="37075"/>37075:          #{desc =&gt; &quot;await server ready (accept)&quot;,
<a name="37076"/>37076:            cmd  =&gt; fun(#{server := Server,
<a name="37077"/>37077:                          client := Client} = _State) -&gt;
<a name="37078"/>37078:                            ?SEV_AWAIT_READY(Server, server, accept,
<a name="37079"/>37079:                                             [{client, Client}]),
<a name="37080"/>37080:                            ok
<a name="37081"/>37081:                    end},
<a name="37082"/>37082: 
<a name="37083"/>37083:          #{desc =&gt; &quot;order client continue (send)&quot;,
<a name="37084"/>37084:            cmd  =&gt; fun(#{client := Pid,
<a name="37085"/>37085:                          data   := Data} = _State) -&gt;
<a name="37086"/>37086:                            ?SEV_ANNOUNCE_CONTINUE(Pid, send, Data),
<a name="37087"/>37087:                            ok
<a name="37088"/>37088:                    end},
<a name="37089"/>37089:          #{desc =&gt; &quot;await client ready (send)&quot;,
<a name="37090"/>37090:            cmd  =&gt; fun(#{server := Server,
<a name="37091"/>37091:                          client := Client} = _State) -&gt;
<a name="37092"/>37092:                            ?SEV_AWAIT_READY(Client, client, send,
<a name="37093"/>37093:                                             [{server, Server}]),
<a name="37094"/>37094:                            ok
<a name="37095"/>37095:                    end},
<a name="37096"/>37096: 
<a name="37097"/>37097:          #{desc =&gt; &quot;order client continue (shutdown)&quot;,
<a name="37098"/>37098:            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;
<a name="37099"/>37099:                            ?SEV_ANNOUNCE_CONTINUE(Pid, shutdown),
<a name="37100"/>37100:                            ok
<a name="37101"/>37101:                    end},
<a name="37102"/>37102:          #{desc =&gt; &quot;await client ready (shutdown)&quot;,
<a name="37103"/>37103:            cmd  =&gt; fun(#{server := Server,
<a name="37104"/>37104:                          client := Client} = _State) -&gt;
<a name="37105"/>37105:                            ?SEV_AWAIT_READY(Client, client, shutdown,
<a name="37106"/>37106:                                             [{server, Server}]),
<a name="37107"/>37107:                            ok
<a name="37108"/>37108:                    end},
<a name="37109"/>37109: 
<a name="37110"/>37110:          #{desc =&gt; &quot;order server continue (first recv)&quot;,
<a name="37111"/>37111:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="37112"/>37112:                            ?SEV_ANNOUNCE_CONTINUE(Pid, recv),
<a name="37113"/>37113:                            ok
<a name="37114"/>37114:                    end},
<a name="37115"/>37115:          #{desc =&gt; &quot;await server ready (first recv)&quot;,
<a name="37116"/>37116:            cmd  =&gt; fun(#{server := Server,
<a name="37117"/>37117:                          client := Client} = _State) -&gt;
<a name="37118"/>37118:                            ?SEV_AWAIT_READY(Server, server, recv,
<a name="37119"/>37119:                                             [{client, Client}]),
<a name="37120"/>37120:                            ok
<a name="37121"/>37121:                    end},
<a name="37122"/>37122: 
<a name="37123"/>37123:          #{desc =&gt; &quot;order server continue (second recv)&quot;,
<a name="37124"/>37124:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="37125"/>37125:                            ?SEV_ANNOUNCE_CONTINUE(Pid, recv),
<a name="37126"/>37126:                            ok
<a name="37127"/>37127:                    end},
<a name="37128"/>37128:          #{desc =&gt; &quot;await server ready (second recv)&quot;,
<a name="37129"/>37129:            cmd  =&gt; fun(#{server := Server,
<a name="37130"/>37130:                          client := Client} = _State) -&gt;
<a name="37131"/>37131:                            ?SEV_AWAIT_READY(Server, server, recv,
<a name="37132"/>37132:                                             [{client, Client}]),
<a name="37133"/>37133:                            ok
<a name="37134"/>37134:                    end},
<a name="37135"/>37135: 
<a name="37136"/>37136:          ?SEV_SLEEP(?SECS(1)),
<a name="37137"/>37137: 
<a name="37138"/>37138:          #{desc =&gt; &quot;order client continue (close)&quot;,
<a name="37139"/>37139:            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;
<a name="37140"/>37140:                            ?SEV_ANNOUNCE_CONTINUE(Pid, close),
<a name="37141"/>37141:                            ok
<a name="37142"/>37142:                    end},
<a name="37143"/>37143:          #{desc =&gt; &quot;await client ready (close)&quot;,
<a name="37144"/>37144:            cmd  =&gt; fun(#{server := Server,
<a name="37145"/>37145:                          client := Client} = _State) -&gt;
<a name="37146"/>37146:                            ?SEV_AWAIT_READY(Client, client, close,
<a name="37147"/>37147:                                             [{server, Server}]),
<a name="37148"/>37148:                            ok
<a name="37149"/>37149:                    end},
<a name="37150"/>37150: 
<a name="37151"/>37151:          %% Terminations
<a name="37152"/>37152:          #{desc =&gt; &quot;order client to terminate&quot;,
<a name="37153"/>37153:            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;
<a name="37154"/>37154:                            ?SEV_ANNOUNCE_TERMINATE(Pid),
<a name="37155"/>37155:                            ok
<a name="37156"/>37156:                    end},
<a name="37157"/>37157:          #{desc =&gt; &quot;await client termination&quot;,
<a name="37158"/>37158:            cmd  =&gt; fun(#{client := Pid} = State) -&gt;
<a name="37159"/>37159:                            case ?SEV_AWAIT_TERMINATION(Pid) of
<a name="37160"/>37160:                                ok -&gt;
<a name="37161"/>37161:                                    State1 = maps:remove(client, State),
<a name="37162"/>37162:                                    {ok, State1};
<a name="37163"/>37163:                                {error, _} = ERROR -&gt;
<a name="37164"/>37164:                                    ERROR
<a name="37165"/>37165:                            end
<a name="37166"/>37166:                    end},
<a name="37167"/>37167:          #{desc =&gt; &quot;order server to terminate&quot;,
<a name="37168"/>37168:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="37169"/>37169:                            ?SEV_ANNOUNCE_TERMINATE(Pid),
<a name="37170"/>37170:                            ok
<a name="37171"/>37171:                    end},
<a name="37172"/>37172:          #{desc =&gt; &quot;await server termination&quot;,
<a name="37173"/>37173:            cmd  =&gt; fun(#{server := Pid} = State) -&gt;
<a name="37174"/>37174:                            case ?SEV_AWAIT_TERMINATION(Pid) of
<a name="37175"/>37175:                                ok -&gt;
<a name="37176"/>37176:                                    State1 = maps:remove(server, State),
<a name="37177"/>37177:                                    {ok, State1};
<a name="37178"/>37178:                                {error, _} = ERROR -&gt;
<a name="37179"/>37179:                                    ERROR
<a name="37180"/>37180:                            end
<a name="37181"/>37181:                    end},
<a name="37182"/>37182: 
<a name="37183"/>37183:          %% *** We are done ***
<a name="37184"/>37184:          ?SEV_FINISH_NORMAL
<a name="37185"/>37185:         ],
<a name="37186"/>37186: 
<a name="37187"/>37187:     i(&quot;start server evaluator&quot;),
<a name="37188"/>37188:     ServerInitState = #{domain =&gt; maps:get(domain, InitState),
<a name="37189"/>37189:                         proto  =&gt; maps:get(proto,  InitState),
<a name="37190"/>37190:                         recv   =&gt; maps:get(recv,   InitState)},
<a name="37191"/>37191:     Server = ?SEV_START(&quot;server&quot;, ServerSeq, ServerInitState),
<a name="37192"/>37192: 
<a name="37193"/>37193:     i(&quot;start client evaluator&quot;),
<a name="37194"/>37194:     ClientInitState = #{host   =&gt; local_host(),
<a name="37195"/>37195:                         domain =&gt; maps:get(domain, InitState),
<a name="37196"/>37196:                         proto  =&gt; maps:get(proto,  InitState),
<a name="37197"/>37197:                         send   =&gt; maps:get(send, InitState)},
<a name="37198"/>37198:     Client = ?SEV_START(&quot;client&quot;, ClientSeq, ClientInitState),
<a name="37199"/>37199: 
<a name="37200"/>37200:     i(&quot;start 'tester' evaluator&quot;),
<a name="37201"/>37201:     TesterInitState = #{server =&gt; Server#ev.pid,
<a name="37202"/>37202:                         client =&gt; Client#ev.pid,
<a name="37203"/>37203:                         data   =&gt; maps:get(data, InitState)},
<a name="37204"/>37204:     Tester = ?SEV_START(&quot;tester&quot;, TesterSeq, TesterInitState),
<a name="37205"/>37205: 
<a name="37206"/>37206:     i(&quot;await evaluator&quot;),
<a name="sc_rs_send_shutdown_receive_tcp-last_expr"/><a name="37207"/>37207: <b>    ok = ?SEV_AWAIT_FINISH</b>([Server, Client, Tester]).
<a name="37208"/>37208: 
<a name="37209"/>37209: 
<a name="sc_rs_tcp_client_start-2"/><a name="37210"/>37210: <b>sc_rs_tcp_client_start</b>(Node, Send) -&gt;
<a name="37211"/>37211:     Self = self(),
<a name="37212"/>37212:     Fun  = fun() -&gt; sc_rs_tcp_client(Self, Send) end,
<a name="sc_rs_tcp_client_start-last_expr"/><a name="37213"/>37213: <b>    erlang:spawn</b>(Node, Fun).
<a name="37214"/>37214: 
<a name="37215"/>37215: 
<a name="sc_rs_tcp_client-2"/><a name="37216"/>37216: <b>sc_rs_tcp_client</b>(Parent, Send) -&gt;
<a name="37217"/>37217:     sc_rs_tcp_client_init(Parent),
<a name="37218"/>37218:     {ServerSA, Proto} = sc_rs_tcp_client_await_start(Parent),
<a name="37219"/>37219:     Domain   = maps:get(family, ServerSA),
<a name="37220"/>37220:     Sock     = sc_rs_tcp_client_create(Domain, Proto),
<a name="37221"/>37221:     Path     = sc_rs_tcp_client_bind(Sock, Domain),
<a name="37222"/>37222:     sc_rs_tcp_client_announce_ready(Parent, init),
<a name="37223"/>37223:     sc_rs_tcp_client_await_continue(Parent, connect),
<a name="37224"/>37224:     sc_rs_tcp_client_connect(Sock, ServerSA),
<a name="37225"/>37225:     sc_rs_tcp_client_announce_ready(Parent, connect),
<a name="37226"/>37226:     Data = sc_rs_tcp_client_await_continue(Parent, send),
<a name="37227"/>37227:     sc_rs_tcp_client_send(Sock, Send, Data),
<a name="37228"/>37228:     sc_rs_tcp_client_announce_ready(Parent, send),
<a name="37229"/>37229:     sc_rs_tcp_client_await_continue(Parent, shutdown),
<a name="37230"/>37230:     sc_rs_tcp_client_shutdown(Sock),
<a name="37231"/>37231:     sc_rs_tcp_client_announce_ready(Parent, shutdown),
<a name="37232"/>37232:     sc_rs_tcp_client_await_continue(Parent, close),
<a name="37233"/>37233:     sc_rs_tcp_client_close(Sock, Path),
<a name="37234"/>37234:     sc_rs_tcp_client_announce_ready(Parent, close),
<a name="37235"/>37235:     Reason = sc_rs_tcp_client_await_terminate(Parent),
<a name="37236"/>37236:     ?SEV_IPRINT(&quot;terminate&quot;),
<a name="sc_rs_tcp_client-last_expr"/><a name="37237"/>37237: <b>    exit</b>(Reason).
<a name="37238"/>37238: 
<a name="sc_rs_tcp_client_init-1"/><a name="37239"/>37239: <b>sc_rs_tcp_client_init</b>(Parent) -&gt;
<a name="37240"/>37240:     put(sname, &quot;rclient&quot;),
<a name="37241"/>37241:     ?SEV_IPRINT(&quot;init&quot;),
<a name="37242"/>37242:     _MRef = erlang:monitor(process, Parent),
<a name="sc_rs_tcp_client_init-last_expr"/><a name="37243"/>37243:     ok.
<a name="37244"/>37244: 
<a name="sc_rs_tcp_client_await_start-1"/><a name="37245"/>37245: <b>sc_rs_tcp_client_await_start</b>(Parent) -&gt;
<a name="37246"/>37246:     i(&quot;sc_rs_tcp_client_await_start -&gt; entry&quot;),
<a name="sc_rs_tcp_client_await_start-last_expr"/><a name="37247"/>37247: <b>    ?SEV_AWAIT_START</b>(Parent).
<a name="37248"/>37248: 
<a name="sc_rs_tcp_client_create-2"/><a name="37249"/>37249: <b>sc_rs_tcp_client_create</b>(Domain, Proto) -&gt;
<a name="37250"/>37250:     i(&quot;sc_rs_tcp_client_create -&gt; entry&quot;),
<a name="sc_rs_tcp_client_create-last_expr"/><a name="37251"/>37251: <b>    case socket:open</b>(Domain, stream, Proto) of
<a name="37252"/>37252:         {ok, Sock} -&gt;
<a name="37253"/>37253:             Sock;
<a name="37254"/>37254:         {error, Reason} -&gt;
<a name="37255"/>37255:             exit({open_failed, Reason})
<a name="37256"/>37256:     end.
<a name="37257"/>37257: 
<a name="sc_rs_tcp_client_bind-2"/><a name="37258"/>37258: <b>sc_rs_tcp_client_bind</b>(Sock, Domain) -&gt;
<a name="37259"/>37259:     i(&quot;sc_rs_tcp_client_bind -&gt; entry&quot;),
<a name="37260"/>37260:     LSA = which_local_socket_addr(Domain),
<a name="sc_rs_tcp_client_bind-last_expr"/><a name="37261"/>37261: <b>    case socket:bind</b>(Sock, LSA) of
<a name="37262"/>37262:         ok -&gt;
<a name="37263"/>37263:             case socket:sockname(Sock) of
<a name="37264"/>37264:                 {ok, #{family := local, path := Path}} -&gt;
<a name="37265"/>37265:                     Path;
<a name="37266"/>37266:                 {ok, _} -&gt;
<a name="37267"/>37267:                     undefined;
<a name="37268"/>37268:                 {error, Reason1} -&gt;
<a name="37269"/>37269:                     exit({sockname, Reason1})
<a name="37270"/>37270:             end;
<a name="37271"/>37271:         {error, Reason} -&gt;
<a name="37272"/>37272:             exit({bind, Reason})
<a name="37273"/>37273:     end.
<a name="37274"/>37274: 
<a name="sc_rs_tcp_client_announce_ready-2"/><a name="37275"/>37275: <b>sc_rs_tcp_client_announce_ready</b>(Parent, Slogan) -&gt;
<a name="sc_rs_tcp_client_announce_ready-last_expr"/><a name="37276"/>37276: <b>    ?SEV_ANNOUNCE_READY</b>(Parent, Slogan).
<a name="37277"/>37277: 
<a name="sc_rs_tcp_client_await_continue-2"/><a name="37278"/>37278: <b>sc_rs_tcp_client_await_continue</b>(Parent, Slogan) -&gt;
<a name="37279"/>37279:     i(&quot;sc_rs_tcp_client_await_continue -&gt; entry&quot;),
<a name="sc_rs_tcp_client_await_continue-last_expr"/><a name="37280"/>37280: <b>    case ?SEV_AWAIT_CONTINUE</b>(Parent, parent, Slogan) of
<a name="37281"/>37281:         ok -&gt;
<a name="37282"/>37282:             ok;
<a name="37283"/>37283:         {ok, Extra} -&gt;
<a name="37284"/>37284:             Extra;
<a name="37285"/>37285:         {error, Reason} -&gt;
<a name="37286"/>37286:             exit({await_continue, Slogan, Reason})
<a name="37287"/>37287:     end.
<a name="37288"/>37288: 
<a name="37289"/>37289: 
<a name="sc_rs_tcp_client_connect-2"/><a name="37290"/>37290: <b>sc_rs_tcp_client_connect</b>(Sock, ServerSA) -&gt;
<a name="37291"/>37291:     i(&quot;sc_rs_tcp_client_connect -&gt; entry&quot;),
<a name="sc_rs_tcp_client_connect-last_expr"/><a name="37292"/>37292: <b>    case socket:connect</b>(Sock, ServerSA) of
<a name="37293"/>37293:         ok -&gt;
<a name="37294"/>37294:             ok;
<a name="37295"/>37295:         {error, Reason} -&gt;
<a name="37296"/>37296:             exit({connect, Reason})
<a name="37297"/>37297:     end.
<a name="37298"/>37298: 
<a name="sc_rs_tcp_client_send-3"/><a name="37299"/>37299: <b>sc_rs_tcp_client_send</b>(Sock, Send, Data) -&gt;
<a name="37300"/>37300:     i(&quot;sc_rs_tcp_client_send -&gt; entry&quot;),
<a name="sc_rs_tcp_client_send-last_expr"/><a name="37301"/>37301: <b>    try Send</b>(Sock, Data) of
<a name="37302"/>37302:         ok -&gt;
<a name="37303"/>37303:             ok;
<a name="37304"/>37304:         {error, Reason} -&gt;
<a name="37305"/>37305:             exit({send, Reason})
<a name="37306"/>37306:     catch
<a name="37307"/>37307:         error : notsup = Reason : _ -&gt;
<a name="37308"/>37308:             exit({skip, Reason})
<a name="37309"/>37309:     end.
<a name="37310"/>37310: 
<a name="sc_rs_tcp_client_shutdown-1"/><a name="37311"/>37311: <b>sc_rs_tcp_client_shutdown</b>(Sock) -&gt;
<a name="37312"/>37312:     i(&quot;sc_rs_tcp_client_shutdown -&gt; entry&quot;),
<a name="sc_rs_tcp_client_shutdown-last_expr"/><a name="37313"/>37313: <b>    case socket:shutdown</b>(Sock, write) of
<a name="37314"/>37314:         ok -&gt;
<a name="37315"/>37315:             ok;
<a name="37316"/>37316:         {error, Reason} -&gt;
<a name="37317"/>37317:             exit({shutdown, Reason})
<a name="37318"/>37318:     end.
<a name="37319"/>37319: 
<a name="sc_rs_tcp_client_close-2"/><a name="37320"/>37320: <b>sc_rs_tcp_client_close</b>(Sock, Path) -&gt;
<a name="37321"/>37321:     i(&quot;sc_rs_tcp_client_close -&gt; entry&quot;),
<a name="sc_rs_tcp_client_close-last_expr"/><a name="37322"/>37322: <b>    case socket:close</b>(Sock) of
<a name="37323"/>37323:         ok -&gt;
<a name="37324"/>37324:             unlink_path(Path),
<a name="37325"/>37325:             ok;
<a name="37326"/>37326:         {error, Reason} -&gt;
<a name="37327"/>37327:             ?SEV_EPRINT(&quot;failed closing: &quot;
<a name="37328"/>37328:                         &quot;~n   Reason: ~p&quot;, [Reason]),
<a name="37329"/>37329:             unlink_path(Path),
<a name="37330"/>37330:             {error, {close, Reason}}
<a name="37331"/>37331:     end.
<a name="37332"/>37332: 
<a name="sc_rs_tcp_client_await_terminate-1"/><a name="37333"/>37333: <b>sc_rs_tcp_client_await_terminate</b>(Parent) -&gt;
<a name="37334"/>37334:     i(&quot;sc_rs_tcp_client_await_terminate -&gt; entry&quot;),
<a name="sc_rs_tcp_client_await_terminate-last_expr"/><a name="37335"/>37335: <b>    case ?SEV_AWAIT_TERMINATE</b>(Parent, parent) of
<a name="37336"/>37336:         ok -&gt;
<a name="37337"/>37337:             ok;
<a name="37338"/>37338:         {error, Reason} -&gt;
<a name="37339"/>37339:             Reason
<a name="37340"/>37340:     end.
<a name="37341"/>37341: 
<a name="37342"/>37342: 
<a name="37343"/>37343: <i>%% The handlers run on the same node as the server (the local node).</i>
<a name="37344"/>37344: 
<a name="sc_rs_tcp_handler_start-2"/><a name="37345"/>37345: <b>sc_rs_tcp_handler_start</b>(Recv, Sock) -&gt;
<a name="37346"/>37346:     Self     = self(),
<a name="37347"/>37347:     Fun      = fun() -&gt; sc_rs_tcp_handler(Self, Recv, Sock) end,
<a name="37348"/>37348:     {Pid, _} = erlang:spawn_monitor(Fun),
<a name="sc_rs_tcp_handler_start-last_expr"/><a name="37349"/>37349:     Pid.
<a name="37350"/>37350: 
<a name="sc_rs_tcp_handler-3"/><a name="37351"/>37351: <b>sc_rs_tcp_handler</b>(Parent, Recv, Sock) -&gt;
<a name="37352"/>37352:     sc_rs_tcp_handler_init(Parent),
<a name="37353"/>37353:     sc_rs_tcp_handler_await(Parent, recv),
<a name="37354"/>37354:     ok = sc_rs_tcp_handler_recv(Recv, Sock, true),
<a name="37355"/>37355:     sc_rs_tcp_handler_announce_ready(Parent, recv, received),
<a name="37356"/>37356:     sc_rs_tcp_handler_await(Parent, recv),
<a name="37357"/>37357:     ok = sc_rs_tcp_handler_recv(Recv, Sock, false),
<a name="37358"/>37358:     sc_rs_tcp_handler_announce_ready(Parent, recv, closed),
<a name="37359"/>37359:     Reason = sc_rs_tcp_handler_await(Parent, terminate),
<a name="sc_rs_tcp_handler-last_expr"/><a name="37360"/>37360: <b>    exit</b>(Reason).
<a name="37361"/>37361: 
<a name="sc_rs_tcp_handler_init-1"/><a name="37362"/>37362: <b>sc_rs_tcp_handler_init</b>(Parent) -&gt;
<a name="37363"/>37363:     put(sname, &quot;handler&quot;),
<a name="37364"/>37364:     _MRef = erlang:monitor(process, Parent),
<a name="37365"/>37365:     ?SEV_IPRINT(&quot;started&quot;),
<a name="37366"/>37366:     ?SEV_ANNOUNCE_READY(Parent, init),
<a name="sc_rs_tcp_handler_init-last_expr"/><a name="37367"/>37367:     ok.
<a name="37368"/>37368: 
<a name="sc_rs_tcp_handler_await-2"/><a name="37369"/>37369: <b>sc_rs_tcp_handler_await</b>(Parent, terminate) -&gt;
<a name="37370"/>37370:     ?SEV_IPRINT(&quot;await terminate&quot;),
<a name="37371"/>37371:     ?SEV_AWAIT_TERMINATE(Parent, tester);
<a name="37372"/>37372: <b>sc_rs_tcp_handler_await</b>(Parent, Slogan) -&gt;
<a name="37373"/>37373:     ?SEV_IPRINT(&quot;await ~w&quot;, [Slogan]),
<a name="sc_rs_tcp_handler_await-last_expr"/><a name="37374"/>37374: <b>    ?SEV_AWAIT_CONTINUE</b>(Parent, parent, Slogan).
<a name="37375"/>37375: 
<a name="37376"/>37376: <i>%% This should actually work - we leave it for now</i>
<a name="sc_rs_tcp_handler_recv-3"/><a name="37377"/>37377: <b>sc_rs_tcp_handler_recv</b>(Recv, Sock, First) -&gt;
<a name="37378"/>37378:     ?SEV_IPRINT(&quot;recv&quot;),
<a name="sc_rs_tcp_handler_recv-last_expr"/><a name="37379"/>37379: <b>    try Recv</b>(Sock) of
<a name="37380"/>37380:         {ok, _} when (First =:= true) -&gt;
<a name="37381"/>37381:             ok;
<a name="37382"/>37382:         {error, closed} when (First =:= false) -&gt;
<a name="37383"/>37383:             ok;
<a name="37384"/>37384:         {ok, _} -&gt;
<a name="37385"/>37385:             ?SEV_IPRINT(&quot;unexpected success&quot;),
<a name="37386"/>37386:             {error, unexpected_success};
<a name="37387"/>37387:         {error, Reason} = ERROR -&gt;
<a name="37388"/>37388:             ?SEV_IPRINT(&quot;receive error: &quot;
<a name="37389"/>37389:                         &quot;~n   ~p&quot;, [Reason]),
<a name="37390"/>37390:             ERROR
<a name="37391"/>37391:     catch
<a name="37392"/>37392:         error : notsup = Reason : _ -&gt;
<a name="37393"/>37393:             exit({skip, Reason});
<a name="37394"/>37394:         C:E:S -&gt;
<a name="37395"/>37395:             ?SEV_IPRINT(&quot;receive failure: &quot;
<a name="37396"/>37396:                         &quot;~n   Class: ~p&quot;
<a name="37397"/>37397:                         &quot;~n   Error: ~p&quot;
<a name="37398"/>37398:                         &quot;~n   Stack: ~p&quot;, [C, E, S]),
<a name="37399"/>37399:             {error, {recv, C, E, S}}
<a name="37400"/>37400:     end.
<a name="37401"/>37401: 
<a name="sc_rs_tcp_handler_announce_ready-3"/><a name="37402"/>37402: <b>sc_rs_tcp_handler_announce_ready</b>(Parent, Slogan, Result) -&gt;
<a name="37403"/>37403:     ?SEV_IPRINT(&quot;announce ready&quot;),
<a name="37404"/>37404:     ?SEV_ANNOUNCE_READY(Parent, Slogan, Result),
<a name="sc_rs_tcp_handler_announce_ready-last_expr"/><a name="37405"/>37405:     ok.
<a name="37406"/>37406: 
<a name="37407"/>37407: 
<a name="37408"/>37408: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="37409"/>37409: <i>%% This test case is intended to test what happens when a socket is</i>
<a name="37410"/>37410: <i>%% remotely closed while the process is calling the recvmsg function.</i>
<a name="37411"/>37411: <i>%% The remote client sends data, then shutdown(write) and then the</i>
<a name="37412"/>37412: <i>%% reader attempts a recv.</i>
<a name="37413"/>37413: <i>%% Socket is IPv4.</i>
<a name="37414"/>37414: 
<a name="sc_rs_recvmsg_send_shutdown_receive_tcp4-1"/><a name="37415"/>37415: <b>sc_rs_recvmsg_send_shutdown_receive_tcp4</b>(_Config) when is_list(_Config) -&gt;
<a name="sc_rs_recvmsg_send_shutdown_receive_tcp4-last_expr"/><a name="37416"/>37416: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="37417"/>37417:            fun() -&gt; has_support_ipv4() end,
<a name="37418"/>37418:            fun() -&gt;
<a name="37419"/>37419:                    ?TT(?SECS(30)),
<a name="37420"/>37420:                    MsgData   = ?DATA,
<a name="37421"/>37421:                    Recv      = fun(Sock) -&gt;
<a name="37422"/>37422:                                        case socket:recvmsg(Sock) of
<a name="37423"/>37423:                                            {ok, #{iov   := [Data]}} -&gt;
<a name="37424"/>37424:                                                {ok, Data};
<a name="37425"/>37425:                                            {ok, #{addr  := _} = Msg} -&gt;
<a name="37426"/>37426:                                                {error, {msg, Msg}};
<a name="37427"/>37427:                                            {error, _} = ERROR -&gt;
<a name="37428"/>37428:                                                ERROR
<a name="37429"/>37429:                                        end
<a name="37430"/>37430:                                end,
<a name="37431"/>37431:                    Send      = fun(Sock, Data) when is_binary(Data) -&gt;
<a name="37432"/>37432:                                   Msg = #{iov =&gt; [Data]},
<a name="37433"/>37433:                                   socket:sendmsg(Sock, Msg)
<a name="37434"/>37434:                                end,
<a name="37435"/>37435:                    InitState = #{domain =&gt; inet,
<a name="37436"/>37436:                                  proto  =&gt; tcp,
<a name="37437"/>37437:                                  recv   =&gt; Recv,
<a name="37438"/>37438:                                  send   =&gt; Send,
<a name="37439"/>37439:                                  data   =&gt; MsgData},
<a name="37440"/>37440:                    ok = sc_rs_send_shutdown_receive_tcp(InitState)
<a name="37441"/>37441:            end).
<a name="37442"/>37442: 
<a name="37443"/>37443: 
<a name="37444"/>37444: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="37445"/>37445: <i>%% This test case is intended to test what happens when a socket is</i>
<a name="37446"/>37446: <i>%% remotely closed while the process is calling the recvmsg function.</i>
<a name="37447"/>37447: <i>%% The remote client sends data, then shutdown(write) and then the</i>
<a name="37448"/>37448: <i>%% reader attempts a recv.</i>
<a name="37449"/>37449: <i>%% Socket is IPv6.</i>
<a name="37450"/>37450: 
<a name="sc_rs_recvmsg_send_shutdown_receive_tcp6-1"/><a name="37451"/>37451: <b>sc_rs_recvmsg_send_shutdown_receive_tcp6</b>(_Config) when is_list(_Config) -&gt;
<a name="sc_rs_recvmsg_send_shutdown_receive_tcp6-last_expr"/><a name="37452"/>37452: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="37453"/>37453:            fun() -&gt; has_support_ipv6() end,
<a name="37454"/>37454:            fun() -&gt;
<a name="37455"/>37455:                    ?TT(?SECS(10)),
<a name="37456"/>37456:                    MsgData   = ?DATA,
<a name="37457"/>37457:                    Recv      = fun(Sock) -&gt;
<a name="37458"/>37458:                                        case socket:recvmsg(Sock) of
<a name="37459"/>37459:                                            {ok, #{iov   := [Data]}} -&gt;
<a name="37460"/>37460:                                                {ok, Data};
<a name="37461"/>37461:                                            {ok, #{addr  := _} = Msg} -&gt;
<a name="37462"/>37462:                                                {error, {msg, Msg}};
<a name="37463"/>37463:                                            {error, _} = ERROR -&gt;
<a name="37464"/>37464:                                                ERROR
<a name="37465"/>37465:                                        end
<a name="37466"/>37466:                                end,
<a name="37467"/>37467:                    Send      = fun(Sock, Data) when is_binary(Data) -&gt;
<a name="37468"/>37468:                                        Msg = #{iov =&gt; [Data]},
<a name="37469"/>37469:                                        socket:sendmsg(Sock, Msg)
<a name="37470"/>37470:                                end,
<a name="37471"/>37471:                    InitState = #{domain =&gt; inet6,
<a name="37472"/>37472:                                  proto  =&gt; tcp,
<a name="37473"/>37473:                                  recv   =&gt; Recv,
<a name="37474"/>37474:                                  send   =&gt; Send,
<a name="37475"/>37475:                                  data   =&gt; MsgData},
<a name="37476"/>37476:                    ok = sc_rs_send_shutdown_receive_tcp(InitState)
<a name="37477"/>37477:            end).
<a name="37478"/>37478: 
<a name="37479"/>37479: 
<a name="37480"/>37480: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="37481"/>37481: <i>%% This test case is intended to test what happens when a socket is</i>
<a name="37482"/>37482: <i>%% remotely closed while the process is calling the recvmsg function.</i>
<a name="37483"/>37483: <i>%% The remote client sends data, then shutdown(write) and then the</i>
<a name="37484"/>37484: <i>%% reader attempts a recv.</i>
<a name="37485"/>37485: <i>%% Socket is UNix Domain (stream) socket.</i>
<a name="37486"/>37486: 
<a name="sc_rs_recvmsg_send_shutdown_receive_tcpL-1"/><a name="37487"/>37487: <b>sc_rs_recvmsg_send_shutdown_receive_tcpL</b>(_Config) when is_list(_Config) -&gt;
<a name="37488"/>37488:     ?TT(?SECS(10)),
<a name="sc_rs_recvmsg_send_shutdown_receive_tcpL-last_expr"/><a name="37489"/>37489: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="37490"/>37490:            fun() -&gt; has_support_unix_domain_socket() end,
<a name="37491"/>37491:            fun() -&gt;
<a name="37492"/>37492:                    {ok, CWD} = file:get_cwd(),
<a name="37493"/>37493:                    ?SEV_IPRINT(&quot;CWD: ~s&quot;, [CWD]),
<a name="37494"/>37494:                    MsgData   = ?DATA,
<a name="37495"/>37495:                    Recv      = fun(Sock) -&gt;
<a name="37496"/>37496:                                        case socket:recvmsg(Sock) of
<a name="37497"/>37497:                                            %% On some platforms, the address
<a name="37498"/>37498:                                            %% *is* provided (e.g. linux)
<a name="37499"/>37499:                                            {ok, #{addr  := #{family := local},
<a name="37500"/>37500:                                                   iov   := [Data]}} -&gt;
<a name="37501"/>37501:                                                {ok, Data};
<a name="37502"/>37502:                                            {ok, #{addr := _} = Msg} -&gt;
<a name="37503"/>37503:                                                {error, {msg, Msg}};
<a name="37504"/>37504:                                            %% On some platforms, the address
<a name="37505"/>37505:                                            %% is *not* provided (e.g. FreeBSD)
<a name="37506"/>37506:                                            {ok, #{iov   := [Data]}} -&gt;
<a name="37507"/>37507:                                                {ok, Data};
<a name="37508"/>37508:                                            {ok, Msg} -&gt;
<a name="37509"/>37509:                                                {error, {msg, Msg}};
<a name="37510"/>37510:                                            {error, _} = ERROR -&gt;
<a name="37511"/>37511:                                                ERROR
<a name="37512"/>37512:                                        end
<a name="37513"/>37513:                                end,
<a name="37514"/>37514:                    Send      = fun(Sock, Data) when is_binary(Data) -&gt;
<a name="37515"/>37515:                                        Msg = #{iov =&gt; [Data]},
<a name="37516"/>37516:                                        socket:sendmsg(Sock, Msg)
<a name="37517"/>37517:                                end,
<a name="37518"/>37518:                    InitState = #{domain =&gt; local,
<a name="37519"/>37519:                                  proto  =&gt; default,
<a name="37520"/>37520:                                  recv   =&gt; Recv,
<a name="37521"/>37521:                                  send   =&gt; Send,
<a name="37522"/>37522:                                  data   =&gt; MsgData},
<a name="37523"/>37523:                    ok = sc_rs_send_shutdown_receive_tcp(InitState)
<a name="37524"/>37524:            end).
<a name="37525"/>37525: 
<a name="37526"/>37526: 
<a name="37527"/>37527: 
<a name="37528"/>37528: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="37529"/>37529: <i>%% This test case is intended to (*really* simply) test</i>
<a name="37530"/>37530: <i>%% &quot;some&quot; ioctl features.</i>
<a name="37531"/>37531: <i>%%</i>
<a name="37532"/>37532: 
<a name="ioctl_simple1-1"/><a name="37533"/>37533: <b>ioctl_simple1</b>(_Config) when is_list(_Config) -&gt;
<a name="37534"/>37534:     ?TT(?SECS(5)),
<a name="ioctl_simple1-last_expr"/><a name="37535"/>37535: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="37536"/>37536:            fun() -&gt;
<a name="37537"/>37537:                    has_support_ioctl_requests()
<a name="37538"/>37538:            end,
<a name="37539"/>37539:            fun() -&gt;
<a name="37540"/>37540:                    InitState = #{},
<a name="37541"/>37541:                    ok = do_ioctl_simple1(InitState)
<a name="37542"/>37542:            end).
<a name="37543"/>37543: 
<a name="37544"/>37544: 
<a name="do_ioctl_simple1-1"/><a name="37545"/>37545: <b>do_ioctl_simple1</b>(_State) -&gt;
<a name="37546"/>37546:     Requests = socket:supports(ioctl_requests),
<a name="37547"/>37547:     ?P(&quot;Requests: ~p&quot;, [Requests]),
<a name="do_ioctl_simple1-last_expr"/><a name="37548"/>37548:     ok.
<a name="37549"/>37549: 
<a name="37550"/>37550: 
<a name="37551"/>37551: 
<a name="37552"/>37552: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="37553"/>37553: <i>%% This test case is intended to (simply) test &quot;some&quot; ioctl features.</i>
<a name="37554"/>37554: <i>%%</i>
<a name="37555"/>37555: 
<a name="ioctl_simple2-1"/><a name="37556"/>37556: <b>ioctl_simple2</b>(_Config) when is_list(_Config) -&gt;
<a name="37557"/>37557:     ?TT(?SECS(5)),
<a name="ioctl_simple2-last_expr"/><a name="37558"/>37558: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="37559"/>37559:            fun() -&gt;
<a name="37560"/>37560:                    has_support_ioctl_requests(),
<a name="37561"/>37561:                    has_support_ioctl_gifconf()
<a name="37562"/>37562:            end,
<a name="37563"/>37563:            fun() -&gt;
<a name="37564"/>37564:                    InitState = #{},
<a name="37565"/>37565:                    ok = do_ioctl_simple2(InitState)
<a name="37566"/>37566:            end).
<a name="37567"/>37567: 
<a name="37568"/>37568: 
<a name="do_ioctl_simple2-1"/><a name="37569"/>37569: <b>do_ioctl_simple2</b>(_State) -&gt;
<a name="37570"/>37570:     i(&quot;create dummy dgram:UDP socket&quot;),
<a name="37571"/>37571:     {ok, Sock1} = socket:open(inet, dgram, udp),
<a name="37572"/>37572:     i(&quot;perform simple ioctl (expect success)&quot;),
<a name="37573"/>37573:     case socket:ioctl(Sock1, gifconf) of
<a name="37574"/>37574:         {ok, IfConf1} when is_list(IfConf1) -&gt;
<a name="37575"/>37575:             i(&quot;=&gt; success&quot;),
<a name="37576"/>37576:             ok;
<a name="37577"/>37577:         {error, Reason1} -&gt;
<a name="37578"/>37578:             i(&quot;error: unexpected failure: &quot;
<a name="37579"/>37579:               &quot;~n      ~p&quot;, [Reason1]),
<a name="37580"/>37580:             exit({unexpected_ioctl_failure, dgram, Reason1});
<a name="37581"/>37581:         Else11 -&gt;
<a name="37582"/>37582:             i(&quot;error: unexpected result: &quot;
<a name="37583"/>37583:               &quot;~n      ~p&quot;, [Else11]),
<a name="37584"/>37584:             exit({unexpected_ioctl_result, dgram, Else11})
<a name="37585"/>37585:     end,
<a name="37586"/>37586:     i(&quot;close dummy dgram:UDP socket&quot;),
<a name="37587"/>37587:     ok = socket:close(Sock1),
<a name="37588"/>37588:     i(&quot;perform simple ioctl (expect failure)&quot;),
<a name="37589"/>37589:     case socket:ioctl(Sock1, gifconf) of
<a name="37590"/>37590:         {error, closed} -&gt;
<a name="37591"/>37591:             i(&quot;=&gt; success&quot;),
<a name="37592"/>37592:             ok;
<a name="37593"/>37593:         Else12 -&gt;
<a name="37594"/>37594:             i(&quot;error: unexpected result: &quot;
<a name="37595"/>37595:               &quot;~n      ~p&quot;, [Else12]),
<a name="37596"/>37596:             exit({unexpected_ioctl_result, dgram, Else12})
<a name="37597"/>37597:     end,
<a name="37598"/>37598: 
<a name="37599"/>37599:     i(&quot;create dummy stream:TCP socket&quot;),
<a name="37600"/>37600:     {ok, Sock2} = socket:open(inet, stream, tcp),
<a name="37601"/>37601:     i(&quot;perform simple ioctl (expect success)&quot;),
<a name="37602"/>37602:     case socket:ioctl(Sock2, gifconf) of
<a name="37603"/>37603:         {ok, IfConf2} when is_list(IfConf2) -&gt;
<a name="37604"/>37604:             i(&quot;=&gt; success&quot;),
<a name="37605"/>37605:             ok;
<a name="37606"/>37606:         {error, Reason2} -&gt;
<a name="37607"/>37607:             i(&quot;error: unexpected result: &quot;
<a name="37608"/>37608:               &quot;~n      ~p&quot;, [Reason2]),
<a name="37609"/>37609:             exit({unexpected_ioctl_failure, stream, Reason2});
<a name="37610"/>37610:         Else21 -&gt;
<a name="37611"/>37611:             i(&quot;error: unexpected result: &quot;
<a name="37612"/>37612:               &quot;~n      ~p&quot;, [Else21]),
<a name="37613"/>37613:             exit({unexpected_ioctl_result, stream, Else21})
<a name="37614"/>37614:     end,
<a name="37615"/>37615:     i(&quot;close dummy stream:TCP socket&quot;),
<a name="37616"/>37616:     ok = socket:close(Sock2),
<a name="37617"/>37617:     i(&quot;perform simple ioctl (expect failure)&quot;),
<a name="37618"/>37618:     case socket:ioctl(Sock2, gifconf) of
<a name="37619"/>37619:         {error, closed} -&gt;
<a name="37620"/>37620:             i(&quot;=&gt; success&quot;),
<a name="37621"/>37621:             ok;
<a name="37622"/>37622:         Else22 -&gt;
<a name="37623"/>37623:             i(&quot;error: unexpected result: &quot;
<a name="37624"/>37624:               &quot;~n      ~p&quot;, [Else22]),
<a name="37625"/>37625:             exit({unexpected_ioctl_result, stream, Else22})
<a name="37626"/>37626:     end,
<a name="37627"/>37627: 
<a name="37628"/>37628:     i(&quot;done&quot;),
<a name="do_ioctl_simple2-last_expr"/><a name="37629"/>37629:     ok.
<a name="37630"/>37630: 
<a name="37631"/>37631: 
<a name="37632"/>37632: 
<a name="37633"/>37633: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="37634"/>37634: <i>%% This test case is intended to (simply) test the ioctl nread feature.</i>
<a name="37635"/>37635: <i>%%</i>
<a name="37636"/>37636: 
<a name="ioctl_nread-1"/><a name="37637"/>37637: <b>ioctl_nread</b>(_Config) when is_list(_Config) -&gt;
<a name="37638"/>37638:     ?TT(?SECS(5)),
<a name="ioctl_nread-last_expr"/><a name="37639"/>37639: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="37640"/>37640:            fun() -&gt;
<a name="37641"/>37641:                    has_support_ioctl_requests(),
<a name="37642"/>37642:                    has_support_ioctl_nread()
<a name="37643"/>37643:            end,
<a name="37644"/>37644:            fun() -&gt;
<a name="37645"/>37645:                    InitState = #{},
<a name="37646"/>37646:                    ok = do_ioctl_nread(InitState)
<a name="37647"/>37647:            end).
<a name="37648"/>37648: 
<a name="do_ioctl_nread-1"/><a name="37649"/>37649: <b>do_ioctl_nread</b>(_) -&gt;
<a name="37650"/>37650:     i(&quot;Get local socket address&quot;),
<a name="37651"/>37651:     LSA = which_local_socket_addr(inet),
<a name="37652"/>37652:     i(&quot;Use LSA: ~p&quot;, [LSA]),
<a name="37653"/>37653: 
<a name="37654"/>37654:     i(&quot;Create dgram:UDP socket 1&quot;),
<a name="37655"/>37655:     {ok, S1} = socket:open(inet, dgram, udp),
<a name="37656"/>37656: 
<a name="37657"/>37657:     i(&quot;Bind socket 1&quot;),
<a name="37658"/>37658:     ok = socket:bind(S1, LSA),
<a name="37659"/>37659: 
<a name="37660"/>37660:     i(&quot;Create dgram:UDP socket 2&quot;),
<a name="37661"/>37661:     {ok, S2} = socket:open(inet, dgram, udp),
<a name="37662"/>37662: 
<a name="37663"/>37663:     i(&quot;Bind socket 2&quot;),
<a name="37664"/>37664:     ok = socket:bind(S2, LSA),
<a name="37665"/>37665: 
<a name="37666"/>37666:     i(&quot;Check data to read - expect 0 bytes&quot;),
<a name="37667"/>37667:     {ok, 0} = socket:ioctl(S1, nread),
<a name="37668"/>37668:     
<a name="37669"/>37669:     i(&quot;Get socket 1 port number&quot;),
<a name="37670"/>37670:     {ok, #{port := Port1}} = socket:sockname(S1),
<a name="37671"/>37671:     
<a name="37672"/>37672:     i(&quot;Send data to socket 1 (from socket 2)&quot;),
<a name="37673"/>37673:     Data   = &lt;&lt;0,1,2,3,4,5,6,7,8,9&gt;&gt;,
<a name="37674"/>37674:     DataSz = byte_size(Data),
<a name="37675"/>37675:     ok = socket:sendto(S2, Data, LSA#{port =&gt; Port1}),
<a name="37676"/>37676:     
<a name="37677"/>37677:     i(&quot;Give it some time to arrive&quot;),
<a name="37678"/>37678:     ?SLEEP(?SECS(1)),
<a name="37679"/>37679:     
<a name="37680"/>37680:     i(&quot;Verify that the correct amount of data (atleast ~p) is available&quot;, [DataSz]),
<a name="37681"/>37681:     case socket:ioctl(S1, nread) of
<a name="37682"/>37682:         {ok, DataSize} when (DataSize &gt;= DataSz) -&gt;
<a name="37683"/>37683:             i(&quot;Success: &quot;
<a name="37684"/>37684: 	      &quot;~n   Min Size:    ~p&quot;
<a name="37685"/>37685: 	      &quot;~n   Actual Size: ~p&quot;, [DataSz, DataSize]),
<a name="37686"/>37686: 	    ok;
<a name="37687"/>37687: 	{ok, DataSize} -&gt;
<a name="37688"/>37688:             i(&quot;Unexpected data size: &quot;
<a name="37689"/>37689: 	      &quot;~n   Expected (min) Size: ~p&quot;
<a name="37690"/>37690: 	      &quot;~n   Actual Size:                ~p&quot;, [DataSz, DataSize]),
<a name="37691"/>37691: 	    ct:fail({invalid_data_size, DataSz, DataSize})
<a name="37692"/>37692:     end,
<a name="37693"/>37693: 
<a name="37694"/>37694:     i(&quot;Read the data&quot;),
<a name="37695"/>37695:     {ok, {_, Data}} = socket:recvfrom(S1),
<a name="37696"/>37696:     
<a name="37697"/>37697:     i(&quot;Verify that the data has been read (no more data is available)&quot;),
<a name="37698"/>37698:     {ok, 0} = socket:ioctl(S1, nread),
<a name="37699"/>37699: 
<a name="37700"/>37700:     i(&quot;Cleanup&quot;),
<a name="37701"/>37701:     socket:close(S1),
<a name="37702"/>37702:     socket:close(S2),
<a name="37703"/>37703: 
<a name="37704"/>37704:     i(&quot;Done&quot;),
<a name="do_ioctl_nread-last_expr"/><a name="37705"/>37705:     ok.
<a name="37706"/>37706: 
<a name="37707"/>37707:     
<a name="37708"/>37708: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="37709"/>37709: <i>%% These test case(s) are intended to (simply) test &quot;some&quot; ioctl get</i>
<a name="37710"/>37710: <i>%% request(s).</i>
<a name="37711"/>37711: <i>%%</i>
<a name="37712"/>37712: 
<a name="ioctl_get_gifname-1"/><a name="37713"/>37713: <b>ioctl_get_gifname</b>(_Config) when is_list(_Config) -&gt;
<a name="37714"/>37714:     ?TT(?SECS(5)),
<a name="ioctl_get_gifname-last_expr"/><a name="37715"/>37715: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="37716"/>37716:            fun() -&gt;
<a name="37717"/>37717:                    has_support_net_if_names(),
<a name="37718"/>37718:                    has_support_ioctl_gifname()
<a name="37719"/>37719:            end,
<a name="37720"/>37720:            fun() -&gt;
<a name="37721"/>37721:                    InitState = #{},
<a name="37722"/>37722:                    ok = do_ioctl_get_gifname(InitState)
<a name="37723"/>37723:            end).
<a name="37724"/>37724: 
<a name="37725"/>37725: 
<a name="do_ioctl_get_gifname-1"/><a name="37726"/>37726: <b>do_ioctl_get_gifname</b>(_State) -&gt;
<a name="37727"/>37727:     i(&quot;create dummy dgram:UDP socket&quot;),
<a name="37728"/>37728:     {ok, Sock} = socket:open(inet, dgram, udp),
<a name="37729"/>37729: 
<a name="37730"/>37730:     i(&quot;get if names&quot;),
<a name="37731"/>37731:     {ok, IfNames} = net:if_names(),
<a name="37732"/>37732: 
<a name="37733"/>37733:     i(&quot;try ioctl all if names: &quot;
<a name="37734"/>37734:       &quot;~n      ~p&quot;, [IfNames]),
<a name="37735"/>37735:     _ = [case socket:ioctl(Sock, gifname, IfIdx) of
<a name="37736"/>37736:              {ok, IfName} -&gt;
<a name="37737"/>37737:                  i(&quot;got expected interface name ~p for index ~w&quot;, [IfName, IfIdx]),
<a name="37738"/>37738:                  ok;
<a name="37739"/>37739:              {ok, OtherName} -&gt;
<a name="37740"/>37740:                  %% Oups?!
<a name="37741"/>37741:                  i(&quot;&lt;ERROR&gt; got unexpected interface name for index ~w&quot;
<a name="37742"/>37742:                    &quot;~n      Expected: ~p&quot;
<a name="37743"/>37743:                    &quot;~n      Received: ~p&quot;, [IfIdx, IfName, OtherName]),
<a name="37744"/>37744:                  socket:close(Sock),
<a name="37745"/>37745:                  ?FAIL({unexpected_interface_name, IfIdx, OtherName, IfName});
<a name="37746"/>37746:              {error, Reason} -&gt;
<a name="37747"/>37747:                  i(&quot;&lt;ERROR&gt; got unexpected error for interface index ~w&quot;
<a name="37748"/>37748:                    &quot;~n      Reason: ~p&quot;, [IfIdx, Reason]),
<a name="37749"/>37749:                  socket:close(Sock),
<a name="37750"/>37750:                  ?FAIL({unexpected_failure, IfName, Reason})
<a name="37751"/>37751:          end || {IfIdx, IfName} &lt;- IfNames],
<a name="37752"/>37752: 
<a name="37753"/>37753:     i(&quot;close dummy dgram:UDP socket&quot;),
<a name="37754"/>37754:     ok = socket:close(Sock),
<a name="37755"/>37755: 
<a name="37756"/>37756:     i(&quot;done&quot;),
<a name="do_ioctl_get_gifname-last_expr"/><a name="37757"/>37757:     ok.
<a name="37758"/>37758: 
<a name="37759"/>37759: 
<a name="37760"/>37760: <i>%% --- gifindex ---</i>
<a name="37761"/>37761: 
<a name="ioctl_get_gifindex-1"/><a name="37762"/>37762: <b>ioctl_get_gifindex</b>(_Config) when is_list(_Config) -&gt;
<a name="37763"/>37763:     ?TT(?SECS(5)),
<a name="ioctl_get_gifindex-last_expr"/><a name="37764"/>37764: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="37765"/>37765:            fun() -&gt;
<a name="37766"/>37766:                    has_support_net_if_names(),
<a name="37767"/>37767:                    has_support_ioctl_gifindex()
<a name="37768"/>37768:            end,
<a name="37769"/>37769:            fun() -&gt;
<a name="37770"/>37770:                    InitState = #{},
<a name="37771"/>37771:                    ok = do_ioctl_get_gifindex(InitState)
<a name="37772"/>37772:            end).
<a name="37773"/>37773: 
<a name="37774"/>37774: 
<a name="do_ioctl_get_gifindex-1"/><a name="37775"/>37775: <b>do_ioctl_get_gifindex</b>(_State) -&gt;
<a name="37776"/>37776:     i(&quot;create dummy dgram:UDP socket&quot;),
<a name="37777"/>37777:     {ok, Sock} = socket:open(inet, dgram, udp),
<a name="37778"/>37778: 
<a name="37779"/>37779:     i(&quot;get if names&quot;),
<a name="37780"/>37780:     {ok, IfNames} = net:if_names(),
<a name="37781"/>37781: 
<a name="37782"/>37782:     i(&quot;try ioctl all if indexes: &quot;
<a name="37783"/>37783:       &quot;~n      ~p&quot;, [IfNames]),
<a name="37784"/>37784:     _ = [case socket:ioctl(Sock, gifindex, IfName) of
<a name="37785"/>37785:              {ok, IfIdx} -&gt;
<a name="37786"/>37786:                  i(&quot;got expected interface index ~w for interface ~p&quot;,
<a name="37787"/>37787:                    [IfIdx, IfName]),
<a name="37788"/>37788:                  ok;
<a name="37789"/>37789:              {ok, OtherIdx} -&gt;
<a name="37790"/>37790:                  %% Oups?!
<a name="37791"/>37791:                  i(&quot;&lt;ERROR&gt; got unexpected interface index for interface ~p&quot;
<a name="37792"/>37792:                    &quot;~n      Expected: ~p&quot;
<a name="37793"/>37793:                    &quot;~n      Received: ~p&quot;, [IfName, IfIdx, OtherIdx]),
<a name="37794"/>37794:                  socket:close(Sock),
<a name="37795"/>37795:                  ?FAIL({unexpected_interface_index, IfName, OtherIdx, IfIdx});
<a name="37796"/>37796:              {error, Reason} -&gt;
<a name="37797"/>37797:                  i(&quot;&lt;ERROR&gt; got unexpected error for interface ~p&quot;
<a name="37798"/>37798:                    &quot;~n      Reason: ~p&quot;, [IfName, Reason]),
<a name="37799"/>37799:                  socket:close(Sock),
<a name="37800"/>37800:                  ?FAIL({unexpected_failure, IfIdx, Reason})
<a name="37801"/>37801:          end || {IfIdx, IfName} &lt;- IfNames],
<a name="37802"/>37802: 
<a name="37803"/>37803:     i(&quot;close dummy dgram:UDP socket&quot;),
<a name="37804"/>37804:     ok = socket:close(Sock),
<a name="37805"/>37805: 
<a name="37806"/>37806:     i(&quot;done&quot;),
<a name="do_ioctl_get_gifindex-last_expr"/><a name="37807"/>37807:     ok.
<a name="37808"/>37808: 
<a name="37809"/>37809: 
<a name="37810"/>37810: 
<a name="37811"/>37811: <i>%% --- gifaddr ---</i>
<a name="37812"/>37812: 
<a name="ioctl_get_gifaddr-1"/><a name="37813"/>37813: <b>ioctl_get_gifaddr</b>(_Config) when is_list(_Config) -&gt;
<a name="37814"/>37814:     ?TT(?SECS(5)),
<a name="ioctl_get_gifaddr-last_expr"/><a name="37815"/>37815: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="37816"/>37816:            fun() -&gt;
<a name="37817"/>37817:                    has_support_net_if_names(),
<a name="37818"/>37818:                    has_support_ioctl_gifaddr()
<a name="37819"/>37819:            end,
<a name="37820"/>37820:            fun() -&gt;
<a name="37821"/>37821:                    InitState = #{},
<a name="37822"/>37822:                    ok = do_ioctl_get_gifaddr(InitState)
<a name="37823"/>37823:            end).
<a name="37824"/>37824: 
<a name="37825"/>37825: 
<a name="do_ioctl_get_gifaddr-1"/><a name="37826"/>37826: <b>do_ioctl_get_gifaddr</b>(_State) -&gt;
<a name="37827"/>37827:     i(&quot;create dummy dgram:UDP socket&quot;),
<a name="37828"/>37828:     {ok, Sock} = socket:open(inet, dgram, udp),
<a name="37829"/>37829: 
<a name="37830"/>37830:     i(&quot;get if names&quot;),
<a name="37831"/>37831:     {ok, IfNames} = net:if_names(),
<a name="37832"/>37832: 
<a name="37833"/>37833:     i(&quot;try ioctl all if indexes: &quot;
<a name="37834"/>37834:       &quot;~n      ~p&quot;, [IfNames]),
<a name="37835"/>37835:     %% This a *very* simple test...
<a name="37836"/>37836:     %% ...just to check that we actually get an socket address
<a name="37837"/>37837:     _ = [case socket:ioctl(Sock, gifaddr, IfName) of
<a name="37838"/>37838:              {ok, #{family := Fam,
<a name="37839"/>37839:                     addr   := Addr}} -&gt;
<a name="37840"/>37840:                  i(&quot;got (expected) socket address for interface ~p (~w): &quot;
<a name="37841"/>37841:                    &quot;~n      (~w) ~p&quot;, [IfName, IfIdx, Fam, Addr]),
<a name="37842"/>37842:                  ok;
<a name="37843"/>37843:              {ok, Crap} -&gt;
<a name="37844"/>37844:                  %% Oups?!
<a name="37845"/>37845:                  i(&quot;&lt;ERROR&gt; got unexpected result for interface ~p (~w)&quot;
<a name="37846"/>37846:                    &quot;~n      ~p&quot;, [IfName, IfIdx, Crap]),
<a name="37847"/>37847:                  socket:close(Sock),
<a name="37848"/>37848:                  ?FAIL({unexpected_addr, IfName, IfIdx, Crap});
<a name="37849"/>37849:              {error, eaddrnotavail = Reason} -&gt;
<a name="37850"/>37850:                  i(&quot;got unexpected error for interface ~p (~w) =&gt; &quot;
<a name="37851"/>37851: 		   &quot;SKIP interface&quot;
<a name="37852"/>37852:                    &quot;~n      Reason: ~p&quot;, [IfName, IfIdx, Reason]),
<a name="37853"/>37853:                  ignore;
<a name="37854"/>37854:              {error, eperm = Reason} -&gt;
<a name="37855"/>37855:                  i(&quot;got unexpected error for interface ~p (~w) =&gt; &quot;
<a name="37856"/>37856: 		   &quot;SKIP interface&quot;
<a name="37857"/>37857:                    &quot;~n      Reason: ~p&quot;, [IfName, IfIdx, Reason]),
<a name="37858"/>37858:                  ignore;
<a name="37859"/>37859:              {error, Reason} -&gt;
<a name="37860"/>37860:                  i(&quot;&lt;ERROR&gt; got unexpected error for interface ~p (~w)&quot;
<a name="37861"/>37861:                    &quot;~n      Reason: ~p&quot;, [IfName, IfIdx, Reason]),
<a name="37862"/>37862:                  socket:close(Sock),
<a name="37863"/>37863:                  ?FAIL({unexpected_failure, IfName, IfIdx, Reason})
<a name="37864"/>37864:          end || {IfIdx, IfName} &lt;- IfNames],
<a name="37865"/>37865: 
<a name="37866"/>37866:     i(&quot;close dummy dgram:UDP socket&quot;),
<a name="37867"/>37867:     ok = socket:close(Sock),
<a name="37868"/>37868: 
<a name="37869"/>37869:     i(&quot;done&quot;),
<a name="do_ioctl_get_gifaddr-last_expr"/><a name="37870"/>37870:     ok.
<a name="37871"/>37871: 
<a name="37872"/>37872: 
<a name="37873"/>37873: 
<a name="37874"/>37874: <i>%% --- gifdstaddr ---</i>
<a name="37875"/>37875: 
<a name="ioctl_get_gifdstaddr-1"/><a name="37876"/>37876: <b>ioctl_get_gifdstaddr</b>(_Config) when is_list(_Config) -&gt;
<a name="37877"/>37877:     ?TT(?SECS(5)),
<a name="ioctl_get_gifdstaddr-last_expr"/><a name="37878"/>37878: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="37879"/>37879:            fun() -&gt;
<a name="37880"/>37880:                    has_support_net_if_names(),
<a name="37881"/>37881:                    has_support_ioctl_gifdstaddr()
<a name="37882"/>37882:            end,
<a name="37883"/>37883:            fun() -&gt;
<a name="37884"/>37884:                    InitState = #{},
<a name="37885"/>37885:                    ok = do_ioctl_get_gifdstaddr(InitState)
<a name="37886"/>37886:            end).
<a name="37887"/>37887: 
<a name="37888"/>37888: 
<a name="do_ioctl_get_gifdstaddr-1"/><a name="37889"/>37889: <b>do_ioctl_get_gifdstaddr</b>(_State) -&gt;
<a name="37890"/>37890:     Domain = inet_or_inet6(),
<a name="37891"/>37891:     LSA    = which_local_socket_addr(Domain),
<a name="37892"/>37892: 
<a name="37893"/>37893:     i(&quot;create and init listen stream:TCP socket&quot;),
<a name="37894"/>37894:     {ok, LSock} = socket:open(Domain, stream, tcp),
<a name="37895"/>37895:     ok = socket:bind(LSock, LSA#{port =&gt; 0}),
<a name="37896"/>37896:     ok = socket:listen(LSock),
<a name="37897"/>37897:     {ok, #{port := LPort}} = socket:sockname(LSock),
<a name="37898"/>37898:     
<a name="37899"/>37899:     i(&quot;create and init connection stream:TCP socket&quot;),
<a name="37900"/>37900:     {ok, CSock} = socket:open(Domain, stream, tcp),
<a name="37901"/>37901: 
<a name="37902"/>37902:     i(&quot;attempt connect (nowait)&quot;),
<a name="37903"/>37903:     {ok, ASock} =
<a name="37904"/>37904:         case socket:connect(CSock, LSA#{port =&gt; LPort}, nowait) of
<a name="37905"/>37905:             ok -&gt;
<a name="37906"/>37906:                 i(&quot;connected - accept connection&quot;),
<a name="37907"/>37907:                 socket:accept(LSock);
<a name="37908"/>37908:             {select, {select_info, _Tag, SelectHandle} = _SelectInfo} -&gt;
<a name="37909"/>37909:                 i(&quot;selected - attempt accept&quot;),
<a name="37910"/>37910:                 {ok, AS} = socket:accept(LSock),
<a name="37911"/>37911: 
<a name="37912"/>37912:                 i(&quot;await connection ready&quot;),
<a name="37913"/>37913:                 receive
<a name="37914"/>37914:                     {'$socket', CSock, select, SelectHandle} -&gt;
<a name="37915"/>37915:                         i(&quot;select info - attempt complete connection&quot;),
<a name="37916"/>37916:                         ok = socket:connect(CSock),
<a name="37917"/>37917:                         {ok, AS}
<a name="37918"/>37918:                 end
<a name="37919"/>37919:         end,
<a name="37920"/>37920: 
<a name="37921"/>37921:     i(&quot;get if names&quot;),
<a name="37922"/>37922:     {ok, IfNames} = net:if_names(),
<a name="37923"/>37923: 
<a name="37924"/>37924:     i(&quot;try ioctl all if indexes: &quot;
<a name="37925"/>37925:       &quot;~n      ~p&quot;, [IfNames]),
<a name="37926"/>37926:     %% This a *very* simple test...
<a name="37927"/>37927:     %% ...just to check that we actually get an socket address
<a name="37928"/>37928:     verify_gifdstaddr(ASock, &quot;accept&quot;,  IfNames),
<a name="37929"/>37929:     verify_gifdstaddr(CSock, &quot;connect&quot;, IfNames),
<a name="37930"/>37930:     verify_gifdstaddr(LSock, &quot;listen&quot;,  IfNames),
<a name="37931"/>37931: 
<a name="37932"/>37932:     i(&quot;close socket(s)&quot;),
<a name="37933"/>37933:     _ = socket:close(CSock),
<a name="37934"/>37934:     _ = socket:close(ASock),
<a name="37935"/>37935:     _ = socket:close(LSock),
<a name="37936"/>37936: 
<a name="37937"/>37937:     i(&quot;done&quot;),
<a name="do_ioctl_get_gifdstaddr-last_expr"/><a name="37938"/>37938:     ok.
<a name="37939"/>37939: 
<a name="37940"/>37940: 
<a name="37941"/>37941: 
<a name="verify_gifdstaddr-3"/><a name="37942"/>37942: <b>verify_gifdstaddr</b>(_Sock, _Prefix, []) -&gt;
<a name="37943"/>37943:     ok;
<a name="37944"/>37944: <b>verify_gifdstaddr</b>(Sock, Prefix, [{IfIdx, IfName} | IfNames]) -&gt;
<a name="37945"/>37945:     i(&quot;[~s] attempt verify gifdstaddr for interface ~s (~w)&quot;,
<a name="37946"/>37946:       [Prefix, IfName, IfIdx]),
<a name="37947"/>37947:     verify_gifdstaddr(Sock, Prefix, IfIdx, IfName),
<a name="verify_gifdstaddr-last_expr"/><a name="37948"/>37948: <b>    verify_gifdstaddr</b>(Sock, Prefix, IfNames).
<a name="37949"/>37949: 
<a name="verify_gifdstaddr-4"/><a name="37950"/>37950: <b>verify_gifdstaddr</b>(Sock, Prefix, IfIdx, IfName) -&gt;
<a name="37951"/>37951:     {OsFam, OsName} = os:type(),
<a name="verify_gifdstaddr-last_expr"/><a name="37952"/>37952: <b>    case socket:ioctl</b>(Sock, gifdstaddr, IfName) of
<a name="37953"/>37953:         {ok, #{family := Fam,
<a name="37954"/>37954:                addr   := Addr}} -&gt;
<a name="37955"/>37955:             i(&quot;[~s] got (expected) (dest) socket address &quot;
<a name="37956"/>37956:               &quot;for interface ~p (~w): &quot;
<a name="37957"/>37957:               &quot;~n      (~w) ~p&quot;, [Prefix, IfName, IfIdx, Fam, Addr]),
<a name="37958"/>37958:             ok;
<a name="37959"/>37959:         {ok, Crap} -&gt;
<a name="37960"/>37960:         %% Oups?!
<a name="37961"/>37961:             i(&quot;&lt;ERROR&gt; [~s] got unexpected result for interface ~p (~w)&quot;
<a name="37962"/>37962:               &quot;~n      ~p&quot;, [Prefix, IfName, IfIdx, Crap]),
<a name="37963"/>37963:             socket:close(Sock),
<a name="37964"/>37964:             ?FAIL({unexpected_addr, Prefix, IfName, IfIdx, Crap});
<a name="37965"/>37965:         {error, IgnoredReason} when IgnoredReason =:= eaddrnotavail;
<a name="37966"/>37966:                                     IgnoredReason =:= eperm;
<a name="37967"/>37967:                                     IgnoredReason =:= enotty -&gt;
<a name="37968"/>37968:             i(&quot;[~s] got unexpected error for interface ~p (~w) =&gt; &quot;
<a name="37969"/>37969:               &quot;SKIP interface&quot;
<a name="37970"/>37970:               &quot;~n      Reason: ~p&quot;, [Prefix, IfName, IfIdx, IgnoredReason]),
<a name="37971"/>37971:             ignore;
<a name="37972"/>37972: 	{error, einval = Reason} when (OsFam =:= unix) andalso
<a name="37973"/>37973:                                       ((OsName =:= darwin) orelse 
<a name="37974"/>37974:                                        (OsName =:= freebsd) orelse 
<a name="37975"/>37975:                                        (OsName =:= netbsd) orelse 
<a name="37976"/>37976:                                        (OsName =:= openbsd)) -&gt;
<a name="37977"/>37977: 	    i(&quot;[~s] got unexpected error for interface ~p (~w) =&gt; &quot;
<a name="37978"/>37978: 	      &quot;SKIP interface&quot;
<a name="37979"/>37979: 	      &quot;~n      Reason: ~p&quot;, [Prefix, IfName, IfIdx, Reason]),
<a name="37980"/>37980: 	    ignore;
<a name="37981"/>37981:         {error, Reason} -&gt;
<a name="37982"/>37982:             i(&quot;&lt;ERROR&gt; got unexpected error for interface ~p (~w)&quot;
<a name="37983"/>37983:               &quot;~n      Reason: ~p&quot;, [IfName, IfIdx, Reason]),
<a name="37984"/>37984:             socket:close(Sock),
<a name="37985"/>37985:             ?FAIL({unexpected_failure, Prefix, IfName, IfIdx, Reason})
<a name="37986"/>37986:     end.
<a name="37987"/>37987:     
<a name="37988"/>37988: 
<a name="37989"/>37989: 
<a name="37990"/>37990: 
<a name="37991"/>37991: <i>%% --- gifbrdaddr ---</i>
<a name="37992"/>37992: 
<a name="ioctl_get_gifbrdaddr-1"/><a name="37993"/>37993: <b>ioctl_get_gifbrdaddr</b>(_Config) when is_list(_Config) -&gt;
<a name="37994"/>37994:     ?TT(?SECS(5)),
<a name="ioctl_get_gifbrdaddr-last_expr"/><a name="37995"/>37995: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="37996"/>37996:            fun() -&gt;
<a name="37997"/>37997:                    has_support_net_if_names(),
<a name="37998"/>37998:                    has_support_ioctl_gifbrdaddr()
<a name="37999"/>37999:            end,
<a name="38000"/>38000:            fun() -&gt;
<a name="38001"/>38001:                    InitState = #{},
<a name="38002"/>38002:                    ok = do_ioctl_get_gifbrdaddr(InitState)
<a name="38003"/>38003:            end).
<a name="38004"/>38004: 
<a name="38005"/>38005: 
<a name="do_ioctl_get_gifbrdaddr-1"/><a name="38006"/>38006: <b>do_ioctl_get_gifbrdaddr</b>(_State) -&gt;
<a name="38007"/>38007:     Domain = inet_or_inet6(),
<a name="38008"/>38008:     LSA    = which_local_socket_addr(Domain),
<a name="38009"/>38009: 
<a name="38010"/>38010:     i(&quot;create and init listen stream:TCP socket&quot;),
<a name="38011"/>38011:     {ok, LSock} = socket:open(Domain, stream, tcp),
<a name="38012"/>38012:     ok = socket:bind(LSock, LSA#{port =&gt; 0}),
<a name="38013"/>38013:     ok = socket:listen(LSock),
<a name="38014"/>38014:     {ok, #{port := LPort}} = socket:sockname(LSock),
<a name="38015"/>38015:     
<a name="38016"/>38016:     i(&quot;create and init connection stream:TCP socket&quot;),
<a name="38017"/>38017:     {ok, CSock} = socket:open(Domain, stream, tcp),
<a name="38018"/>38018: 
<a name="38019"/>38019:     i(&quot;attempt connect (nowait)&quot;),
<a name="38020"/>38020:     {ok, ASock} =
<a name="38021"/>38021:         case socket:connect(CSock, LSA#{port =&gt; LPort}, nowait) of
<a name="38022"/>38022:             ok -&gt;
<a name="38023"/>38023:                 i(&quot;connected - accept connection&quot;),
<a name="38024"/>38024:                 socket:accept(LSock);
<a name="38025"/>38025:             {select, {select_info, _Tag, SelectHandle} = _SelectInfo} -&gt;
<a name="38026"/>38026:                 i(&quot;selected - attempt accept&quot;),
<a name="38027"/>38027:                 {ok, AS} = socket:accept(LSock),
<a name="38028"/>38028: 
<a name="38029"/>38029:                 i(&quot;await connection ready&quot;),
<a name="38030"/>38030:                 receive
<a name="38031"/>38031:                     {'$socket', CSock, select, SelectHandle} -&gt;
<a name="38032"/>38032:                         i(&quot;select info - attempt complete connection&quot;),
<a name="38033"/>38033:                         ok = socket:connect(CSock),
<a name="38034"/>38034:                         {ok, AS}
<a name="38035"/>38035:                 end
<a name="38036"/>38036:         end,
<a name="38037"/>38037: 
<a name="38038"/>38038:     i(&quot;get if names&quot;),
<a name="38039"/>38039:     {ok, IfNames} = net:if_names(),
<a name="38040"/>38040: 
<a name="38041"/>38041:     i(&quot;try ioctl all if indexes: &quot;
<a name="38042"/>38042:       &quot;~n      ~p&quot;, [IfNames]),
<a name="38043"/>38043:     %% This a *very* simple test...
<a name="38044"/>38044:     %% ...just to check that we actually get an socket address
<a name="38045"/>38045:     verify_gifbrdaddr(ASock, &quot;accept&quot;,  IfNames),
<a name="38046"/>38046:     verify_gifbrdaddr(CSock, &quot;connect&quot;, IfNames),
<a name="38047"/>38047:     verify_gifbrdaddr(LSock, &quot;listen&quot;,  IfNames),
<a name="38048"/>38048: 
<a name="38049"/>38049:     i(&quot;close socket(s)&quot;),
<a name="38050"/>38050:     _ = socket:close(CSock),
<a name="38051"/>38051:     _ = socket:close(ASock),
<a name="38052"/>38052:     _ = socket:close(LSock),
<a name="38053"/>38053: 
<a name="38054"/>38054:     i(&quot;done&quot;),
<a name="do_ioctl_get_gifbrdaddr-last_expr"/><a name="38055"/>38055:     ok.
<a name="38056"/>38056: 
<a name="38057"/>38057: 
<a name="verify_gifbrdaddr-3"/><a name="38058"/>38058: <b>verify_gifbrdaddr</b>(_Sock, _Prefix, []) -&gt;
<a name="38059"/>38059:     ok;
<a name="38060"/>38060: <b>verify_gifbrdaddr</b>(Sock, Prefix, [{IfIdx, IfName} | IfNames]) -&gt;
<a name="38061"/>38061:     i(&quot;[~s] attempt verify gifbrdaddr for interface ~s (~w)&quot;,
<a name="38062"/>38062:       [Prefix, IfName, IfIdx]),
<a name="38063"/>38063:     verify_gifbrdaddr(Sock, Prefix, IfIdx, IfName),
<a name="verify_gifbrdaddr-last_expr"/><a name="38064"/>38064: <b>    verify_gifbrdaddr</b>(Sock, Prefix, IfNames).
<a name="38065"/>38065: 
<a name="verify_gifbrdaddr-4"/><a name="38066"/>38066: <b>verify_gifbrdaddr</b>(Sock, Prefix, IfIdx, IfName) -&gt;
<a name="38067"/>38067:     {OsFam, OsName} = os:type(),
<a name="verify_gifbrdaddr-last_expr"/><a name="38068"/>38068: <b>    case socket:ioctl</b>(Sock, gifbrdaddr, IfName) of
<a name="38069"/>38069:         {ok, #{family := Fam,
<a name="38070"/>38070:                addr   := Addr}} -&gt;
<a name="38071"/>38071:             i(&quot;[~s] got (expected) (broadcast) socket address for &quot;
<a name="38072"/>38072:               &quot;interface ~p (~w): &quot;
<a name="38073"/>38073:               &quot;~n      (~w) ~p&quot;, [Prefix, IfName, IfIdx, Fam, Addr]),
<a name="38074"/>38074:             ok;
<a name="38075"/>38075:         {ok, Crap} -&gt;
<a name="38076"/>38076:             %% Oups?!
<a name="38077"/>38077:             i(&quot;&lt;ERROR&gt; [~s] got unexpected result for interface ~p (~w)&quot;
<a name="38078"/>38078:               &quot;~n      ~p&quot;, [Prefix, IfName, IfIdx, Crap]),
<a name="38079"/>38079:             socket:close(Sock),
<a name="38080"/>38080:             ?FAIL({unexpected_addr, IfName, IfIdx, Crap});
<a name="38081"/>38081:         {error, IgnoredReason} when IgnoredReason =:= eaddrnotavail;
<a name="38082"/>38082:                                     IgnoredReason =:= eperm;
<a name="38083"/>38083:                                     IgnoredReason =:= enotty -&gt;
<a name="38084"/>38084:             i(&quot;[~s] got unexpected error for interface ~p (~w) =&gt; &quot;
<a name="38085"/>38085:              &quot;SKIP interface&quot;
<a name="38086"/>38086:               &quot;~n      Reason: ~p&quot;, [Prefix, IfName, IfIdx, IgnoredReason]),
<a name="38087"/>38087:             ignore;
<a name="38088"/>38088: 	{error, einval = Reason} when (OsFam =:= unix) andalso
<a name="38089"/>38089:                                       ((OsName =:= darwin) orelse
<a name="38090"/>38090:                                        (OsName =:= freebsd) orelse
<a name="38091"/>38091:                                        (OsName =:= netbsd) orelse
<a name="38092"/>38092:                                        (OsName =:= openbsd)) -&gt;
<a name="38093"/>38093: 	    i(&quot;[~s] got unexpected error for interface ~p (~w) =&gt; &quot;
<a name="38094"/>38094: 	      &quot;SKIP interface&quot;
<a name="38095"/>38095: 	      &quot;~n      Reason: ~p&quot;, [Prefix, IfName, IfIdx, Reason]),
<a name="38096"/>38096: 	    ignore;
<a name="38097"/>38097:         {error, Reason} -&gt;
<a name="38098"/>38098:             i(&quot;&lt;ERROR&gt; [~s] got unexpected error for interface ~p (~w)&quot;
<a name="38099"/>38099:               &quot;~n      Reason: ~p&quot;, [Prefix, IfName, IfIdx, Reason]),
<a name="38100"/>38100:             socket:close(Sock),
<a name="38101"/>38101:             ?FAIL({unexpected_failure, IfName, IfIdx, Reason})
<a name="38102"/>38102:     end.
<a name="38103"/>38103: 
<a name="38104"/>38104: 
<a name="38105"/>38105: 
<a name="38106"/>38106: <i>%% --- gifnetmask ---</i>
<a name="38107"/>38107: 
<a name="ioctl_get_gifnetmask-1"/><a name="38108"/>38108: <b>ioctl_get_gifnetmask</b>(_Config) when is_list(_Config) -&gt;
<a name="38109"/>38109:     ?TT(?SECS(5)),
<a name="ioctl_get_gifnetmask-last_expr"/><a name="38110"/>38110: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="38111"/>38111:            fun() -&gt;
<a name="38112"/>38112:                    has_support_net_if_names(),
<a name="38113"/>38113:                    has_support_ioctl_gifnetmask()
<a name="38114"/>38114:            end,
<a name="38115"/>38115:            fun() -&gt;
<a name="38116"/>38116:                    InitState = #{},
<a name="38117"/>38117:                    ok = do_ioctl_get_gifnetmask(InitState)
<a name="38118"/>38118:            end).
<a name="38119"/>38119: 
<a name="38120"/>38120: 
<a name="do_ioctl_get_gifnetmask-1"/><a name="38121"/>38121: <b>do_ioctl_get_gifnetmask</b>(_State) -&gt;
<a name="38122"/>38122:     i(&quot;create dummy stream:TCP socket&quot;),
<a name="38123"/>38123:     {ok, Sock} = socket:open(inet, stream, tcp),
<a name="38124"/>38124: 
<a name="38125"/>38125:     i(&quot;get if names&quot;),
<a name="38126"/>38126:     {ok, IfNames} = net:if_names(),
<a name="38127"/>38127: 
<a name="38128"/>38128:     i(&quot;try ioctl all if indexes: &quot;
<a name="38129"/>38129:       &quot;~n      ~p&quot;, [IfNames]),
<a name="38130"/>38130:     %% This a *very* simple test...
<a name="38131"/>38131:     %% ...just to check that we actually get an socket address
<a name="38132"/>38132:     _ = [case socket:ioctl(Sock, gifnetmask, IfName) of
<a name="38133"/>38133:              {ok, #{family := Fam,
<a name="38134"/>38134:                     addr   := Addr}} -&gt;
<a name="38135"/>38135:                  i(&quot;got (expected) (netmask) socket address for interface ~p (~w): &quot;
<a name="38136"/>38136:                    &quot;~n      (~w) ~p&quot;, [IfName, IfIdx, Fam, Addr]),
<a name="38137"/>38137:                  ok;
<a name="38138"/>38138:              {ok, Crap} -&gt;
<a name="38139"/>38139:                  %% Oups?!
<a name="38140"/>38140:                  i(&quot;&lt;ERROR&gt; got unexpected result for interface ~p (~w)&quot;
<a name="38141"/>38141:                    &quot;~n      ~p&quot;, [IfName, IfIdx, Crap]),
<a name="38142"/>38142:                  socket:close(Sock),
<a name="38143"/>38143:                  ?FAIL({unexpected_addr, IfName, IfIdx, Crap});
<a name="38144"/>38144:              {error, eaddrnotavail = Reason} -&gt;
<a name="38145"/>38145:                  i(&quot;got unexpected error for interface ~p (~w) =&gt; SKIP interface&quot;
<a name="38146"/>38146:                    &quot;~n      Reason: ~p&quot;, [IfName, IfIdx, Reason]),
<a name="38147"/>38147:                  ignore;
<a name="38148"/>38148: 	     {error, eperm = Reason} -&gt;
<a name="38149"/>38149: 		 i(&quot;got unexpected error for interface ~p (~w) =&gt; &quot;
<a name="38150"/>38150: 		   &quot;SKIP interface&quot;
<a name="38151"/>38151: 		   &quot;~n      Reason: ~p&quot;, [IfName, IfIdx, Reason]),
<a name="38152"/>38152: 		 ignore;
<a name="38153"/>38153:              {error, Reason} -&gt;
<a name="38154"/>38154:                  i(&quot;&lt;ERROR&gt; got unexpected error for interface ~p (~w)&quot;
<a name="38155"/>38155:                    &quot;~n      Reason: ~p&quot;, [IfName, IfIdx, Reason]),
<a name="38156"/>38156:                  socket:close(Sock),
<a name="38157"/>38157:                  ?FAIL({unexpected_failure, IfName, IfIdx, Reason})
<a name="38158"/>38158:          end || {IfIdx, IfName} &lt;- IfNames],
<a name="38159"/>38159: 
<a name="38160"/>38160:     i(&quot;close dummy stream:TCP socket&quot;),
<a name="38161"/>38161:     ok = socket:close(Sock),
<a name="38162"/>38162: 
<a name="38163"/>38163:     i(&quot;done&quot;),
<a name="do_ioctl_get_gifnetmask-last_expr"/><a name="38164"/>38164:     ok.
<a name="38165"/>38165: 
<a name="38166"/>38166: 
<a name="38167"/>38167: 
<a name="38168"/>38168: <i>%% --- gifmtu ---</i>
<a name="38169"/>38169: 
<a name="ioctl_get_gifmtu-1"/><a name="38170"/>38170: <b>ioctl_get_gifmtu</b>(_Config) when is_list(_Config) -&gt;
<a name="38171"/>38171:     ?TT(?SECS(5)),
<a name="ioctl_get_gifmtu-last_expr"/><a name="38172"/>38172: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="38173"/>38173:            fun() -&gt;
<a name="38174"/>38174:                    has_support_net_if_names(),
<a name="38175"/>38175:                    has_support_ioctl_gifmtu()
<a name="38176"/>38176:            end,
<a name="38177"/>38177:            fun() -&gt;
<a name="38178"/>38178:                    InitState = #{},
<a name="38179"/>38179:                    ok = do_ioctl_get_gifmtu(InitState)
<a name="38180"/>38180:            end).
<a name="38181"/>38181: 
<a name="38182"/>38182: 
<a name="do_ioctl_get_gifmtu-1"/><a name="38183"/>38183: <b>do_ioctl_get_gifmtu</b>(_State) -&gt;
<a name="38184"/>38184:     i(&quot;create dummy stream:TCP socket&quot;),
<a name="38185"/>38185:     {ok, Sock} = socket:open(inet, stream, tcp),
<a name="38186"/>38186: 
<a name="38187"/>38187:     i(&quot;get if names&quot;),
<a name="38188"/>38188:     {ok, IfNames} = net:if_names(),
<a name="38189"/>38189: 
<a name="38190"/>38190:     i(&quot;try ioctl all if indexes: &quot;
<a name="38191"/>38191:       &quot;~n      ~p&quot;, [IfNames]),
<a name="38192"/>38192:     %% This a *very* simple test...
<a name="38193"/>38193:     %% ...just to check that we actually get an socket address
<a name="38194"/>38194:     _ = [case socket:ioctl(Sock, gifmtu, IfName) of
<a name="38195"/>38195:              {ok, MTU} when is_integer(MTU) -&gt;
<a name="38196"/>38196:                  i(&quot;got (expected) MTU for interface ~p (~w): &quot;
<a name="38197"/>38197:                    &quot;~n      ~p&quot;, [IfName, IfIdx, MTU]),
<a name="38198"/>38198:                  ok;
<a name="38199"/>38199:              {ok, Crap} -&gt;
<a name="38200"/>38200:                  %% Oups?!
<a name="38201"/>38201:                  i(&quot;&lt;ERROR&gt; got unexpected result for interface ~p (~w)&quot;
<a name="38202"/>38202:                    &quot;~n      ~p&quot;, [IfName, IfIdx, Crap]),
<a name="38203"/>38203:                  socket:close(Sock),
<a name="38204"/>38204:                  ?FAIL({unexpected_mtu, IfName, IfIdx, Crap});
<a name="38205"/>38205:              {error, Reason} -&gt;
<a name="38206"/>38206:                  i(&quot;&lt;ERROR&gt; got unexpected error for interface ~p (~w)&quot;
<a name="38207"/>38207:                    &quot;~n      Reason: ~p&quot;, [IfName, IfIdx, Reason]),
<a name="38208"/>38208:                  socket:close(Sock),
<a name="38209"/>38209:                  ?FAIL({unexpected_failure, IfName, IfIdx, Reason})
<a name="38210"/>38210:          end || {IfIdx, IfName} &lt;- IfNames],
<a name="38211"/>38211: 
<a name="38212"/>38212:     i(&quot;close dummy stream:TCP socket&quot;),
<a name="38213"/>38213:     ok = socket:close(Sock),
<a name="38214"/>38214: 
<a name="38215"/>38215:     i(&quot;done&quot;),
<a name="do_ioctl_get_gifmtu-last_expr"/><a name="38216"/>38216:     ok.
<a name="38217"/>38217: 
<a name="38218"/>38218: 
<a name="38219"/>38219: 
<a name="38220"/>38220: <i>%% --- gifhwaddr ---</i>
<a name="38221"/>38221: 
<a name="ioctl_get_gifhwaddr-1"/><a name="38222"/>38222: <b>ioctl_get_gifhwaddr</b>(_Config) when is_list(_Config) -&gt;
<a name="38223"/>38223:     ?TT(?SECS(5)),
<a name="ioctl_get_gifhwaddr-last_expr"/><a name="38224"/>38224: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="38225"/>38225:            fun() -&gt;
<a name="38226"/>38226:                    has_support_net_if_names(),
<a name="38227"/>38227:                    has_support_ioctl_gifhwaddr()
<a name="38228"/>38228:            end,
<a name="38229"/>38229:            fun() -&gt;
<a name="38230"/>38230:                    InitState = #{},
<a name="38231"/>38231:                    ok = do_ioctl_get_gifhwaddr(InitState)
<a name="38232"/>38232:            end).
<a name="38233"/>38233: 
<a name="38234"/>38234: 
<a name="do_ioctl_get_gifhwaddr-1"/><a name="38235"/>38235: <b>do_ioctl_get_gifhwaddr</b>(_State) -&gt;
<a name="38236"/>38236:     i(&quot;create dummy dgram:UDP socket&quot;),
<a name="38237"/>38237:     {ok, Sock} = socket:open(inet, dgram, udp),
<a name="38238"/>38238: 
<a name="38239"/>38239:     i(&quot;get if names&quot;),
<a name="38240"/>38240:     {ok, IfNames} = net:if_names(),
<a name="38241"/>38241: 
<a name="38242"/>38242:     i(&quot;try ioctl all if indexes: &quot;
<a name="38243"/>38243:       &quot;~n      ~p&quot;, [IfNames]),
<a name="38244"/>38244:     %% This a *very* simple test...
<a name="38245"/>38245:     %% ...just to check that we actually get an socket address
<a name="38246"/>38246:     _ = [case socket:ioctl(Sock, gifhwaddr, IfName) of
<a name="38247"/>38247:              {ok, #{family := Fam,
<a name="38248"/>38248:                     addr   := Addr}} when is_atom(Fam) orelse is_integer(Fam) -&gt;
<a name="38249"/>38249:                  i(&quot;got (expected) socket address for interface ~p (~w): &quot;
<a name="38250"/>38250:                    &quot;~n      (~w) ~p&quot;, [IfName, IfIdx, Fam, Addr]),
<a name="38251"/>38251:                  ok;
<a name="38252"/>38252:              {ok, Crap} -&gt;
<a name="38253"/>38253:                  %% Oups?!
<a name="38254"/>38254:                          i(&quot;&lt;ERROR&gt; got unexpected result for interface ~p (~w)&quot;
<a name="38255"/>38255:                            &quot;~n      ~p&quot;, [IfName, IfIdx, Crap]),
<a name="38256"/>38256:                          socket:close(Sock),
<a name="38257"/>38257:                          ?FAIL({unexpected_addr, IfName, IfIdx, Crap});
<a name="38258"/>38258:              {error, Reason} -&gt;
<a name="38259"/>38259:                  i(&quot;&lt;ERROR&gt; got unexpected error for interface ~p (~w)&quot;
<a name="38260"/>38260:                    &quot;~n      Reason: ~p&quot;, [IfName, IfIdx, Reason]),
<a name="38261"/>38261:                  socket:close(Sock),
<a name="38262"/>38262:                  ?FAIL({unexpected_failure, IfName, IfIdx, Reason})
<a name="38263"/>38263:          end || {IfIdx, IfName} &lt;- IfNames],
<a name="38264"/>38264: 
<a name="38265"/>38265:     i(&quot;close dummy dgram:UDP socket&quot;),
<a name="38266"/>38266:     ok = socket:close(Sock),
<a name="38267"/>38267: 
<a name="38268"/>38268:     i(&quot;done&quot;),
<a name="do_ioctl_get_gifhwaddr-last_expr"/><a name="38269"/>38269:     ok.
<a name="38270"/>38270: 
<a name="38271"/>38271: 
<a name="38272"/>38272: 
<a name="38273"/>38273: <i>%% --- giftxqlen ---</i>
<a name="38274"/>38274: 
<a name="ioctl_get_giftxqlen-1"/><a name="38275"/>38275: <b>ioctl_get_giftxqlen</b>(_Config) when is_list(_Config) -&gt;
<a name="38276"/>38276:     ?TT(?SECS(5)),
<a name="ioctl_get_giftxqlen-last_expr"/><a name="38277"/>38277: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="38278"/>38278:            fun() -&gt;
<a name="38279"/>38279:                    has_support_net_if_names(),
<a name="38280"/>38280:                    has_support_ioctl_giftxqlen()
<a name="38281"/>38281:            end,
<a name="38282"/>38282:            fun() -&gt;
<a name="38283"/>38283:                    InitState = #{},
<a name="38284"/>38284:                    ok = do_ioctl_get_giftxqlen(InitState)
<a name="38285"/>38285:            end).
<a name="38286"/>38286: 
<a name="38287"/>38287: 
<a name="do_ioctl_get_giftxqlen-1"/><a name="38288"/>38288: <b>do_ioctl_get_giftxqlen</b>(_State) -&gt;
<a name="38289"/>38289:     i(&quot;create dummy stream:TCP socket&quot;),
<a name="38290"/>38290:     {ok, Sock} = socket:open(inet, stream, tcp),
<a name="38291"/>38291: 
<a name="38292"/>38292:     i(&quot;get if names&quot;),
<a name="38293"/>38293:     {ok, IfNames} = net:if_names(),
<a name="38294"/>38294: 
<a name="38295"/>38295:     i(&quot;try ioctl all if indexes: &quot;
<a name="38296"/>38296:       &quot;~n      ~p&quot;, [IfNames]),
<a name="38297"/>38297:     %% This a *very* simple test...
<a name="38298"/>38298:     %% ...just to check that we actually get an socket address
<a name="38299"/>38299:     _ = [case socket:ioctl(Sock, giftxqlen, IfName) of
<a name="38300"/>38300:              {ok, QLen} when is_integer(QLen) -&gt;
<a name="38301"/>38301:                  i(&quot;got (expected) TX QLen for interface ~p (~w): &quot;
<a name="38302"/>38302:                    &quot;~n      ~p&quot;, [IfName, IfIdx, QLen]),
<a name="38303"/>38303:                  ok;
<a name="38304"/>38304:              {ok, Crap} -&gt;
<a name="38305"/>38305:                  %% Oups?!
<a name="38306"/>38306:                  i(&quot;&lt;ERROR&gt; got unexpected result for interface ~p (~w)&quot;
<a name="38307"/>38307:                    &quot;~n      ~p&quot;, [IfName, IfIdx, Crap]),
<a name="38308"/>38308:                  socket:close(Sock),
<a name="38309"/>38309:                  ?FAIL({unexpected_mtu, IfName, IfIdx, Crap});
<a name="38310"/>38310:              {error, Reason} -&gt;
<a name="38311"/>38311:                  i(&quot;&lt;ERROR&gt; got unexpected error for interface ~p (~w)&quot;
<a name="38312"/>38312:                    &quot;~n      Reason: ~p&quot;, [IfName, IfIdx, Reason]),
<a name="38313"/>38313:                  socket:close(Sock),
<a name="38314"/>38314:                  ?FAIL({unexpected_failure, IfName, IfIdx, Reason})
<a name="38315"/>38315:          end || {IfIdx, IfName} &lt;- IfNames],
<a name="38316"/>38316: 
<a name="38317"/>38317:     i(&quot;close dummy stream:TCP socket&quot;),
<a name="38318"/>38318:     ok = socket:close(Sock),
<a name="38319"/>38319: 
<a name="38320"/>38320:     i(&quot;done&quot;),
<a name="do_ioctl_get_giftxqlen-last_expr"/><a name="38321"/>38321:     ok.
<a name="38322"/>38322: 
<a name="38323"/>38323: 
<a name="38324"/>38324: 
<a name="38325"/>38325: <i>%% --- gifflags ---</i>
<a name="38326"/>38326: 
<a name="ioctl_get_gifflags-1"/><a name="38327"/>38327: <b>ioctl_get_gifflags</b>(_Config) when is_list(_Config) -&gt;
<a name="38328"/>38328:     ?TT(?SECS(5)),
<a name="ioctl_get_gifflags-last_expr"/><a name="38329"/>38329: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="38330"/>38330:            fun() -&gt;
<a name="38331"/>38331:                    has_support_net_if_names(),
<a name="38332"/>38332:                    has_support_ioctl_gifflags()
<a name="38333"/>38333:            end,
<a name="38334"/>38334:            fun() -&gt;
<a name="38335"/>38335:                    InitState = #{},
<a name="38336"/>38336:                    ok = do_ioctl_get_gifflags(InitState)
<a name="38337"/>38337:            end).
<a name="38338"/>38338: 
<a name="38339"/>38339: 
<a name="do_ioctl_get_gifflags-1"/><a name="38340"/>38340: <b>do_ioctl_get_gifflags</b>(_State) -&gt;
<a name="38341"/>38341:     i(&quot;create dummy stream:TCP socket&quot;),
<a name="38342"/>38342:     {ok, Sock} = socket:open(inet, stream, tcp),
<a name="38343"/>38343: 
<a name="38344"/>38344:     i(&quot;get if names&quot;),
<a name="38345"/>38345:     {ok, IfNames} = net:if_names(),
<a name="38346"/>38346: 
<a name="38347"/>38347:     AllFlags = [Flag || {Flag, Supported} &lt;-
<a name="38348"/>38348:                             socket:supports(ioctl_flags), Supported =:= true],
<a name="38349"/>38349: 
<a name="38350"/>38350:     i(&quot;try ioctl all if indexes: &quot;
<a name="38351"/>38351:       &quot;~n      ~p&quot;, [IfNames]),
<a name="38352"/>38352:     %% This a *very* simple test...
<a name="38353"/>38353:     %% ...just to check that we actually get an socket address
<a name="38354"/>38354:     _ = [case socket:ioctl(Sock, gifflags, IfName) of
<a name="38355"/>38355:              {ok, Flags} when is_list(Flags) -&gt;
<a name="38356"/>38356:                  i(&quot;got  flags for interface ~p (~w): &quot;
<a name="38357"/>38357:                    &quot;~n      ~p&quot;, [IfName, IfIdx, Flags]),
<a name="38358"/>38358:                  case Flags -- AllFlags of
<a name="38359"/>38359:                      [] -&gt;
<a name="38360"/>38360:                          i(&quot;flags accounted for&quot;),
<a name="38361"/>38361:                          ok;
<a name="38362"/>38362:                      ExtraFlags -&gt;
<a name="38363"/>38363:                          i(&quot;&lt;ERROR&gt; got superfluous flags for interface ~p (~w)&quot;
<a name="38364"/>38364:                            &quot;~n      Received Flags:      ~p&quot;
<a name="38365"/>38365:                            &quot;~n      Superfluous Flags:   ~p&quot;
<a name="38366"/>38366:                            &quot;~n      All Supported Flags: ~p&quot;
<a name="38367"/>38367:                            &quot;~n&quot;, [IfName, IfIdx, Flags, ExtraFlags, AllFlags]),
<a name="38368"/>38368:                          socket:close(Sock),
<a name="38369"/>38369:                          ?FAIL({unexpected_superfluous_flags,
<a name="38370"/>38370:                                 IfName, IfIdx, Flags, ExtraFlags, AllFlags})
<a name="38371"/>38371:                  end;
<a name="38372"/>38372:              {ok, Crap} -&gt;
<a name="38373"/>38373:                  %% Oups?!
<a name="38374"/>38374:                  i(&quot;&lt;ERROR&gt; got unexpected result for interface ~p (~w)&quot;
<a name="38375"/>38375:                    &quot;~n      ~p&quot;, [IfName, IfIdx, Crap]),
<a name="38376"/>38376:                  socket:close(Sock),
<a name="38377"/>38377:                  ?FAIL({unexpected_mtu, IfName, IfIdx, Crap});
<a name="38378"/>38378:              {error, Reason} -&gt;
<a name="38379"/>38379:                  i(&quot;&lt;ERROR&gt; got unexpected error for interface ~p (~w)&quot;
<a name="38380"/>38380:                    &quot;~n      Reason: ~p&quot;, [IfName, IfIdx, Reason]),
<a name="38381"/>38381:                  socket:close(Sock),
<a name="38382"/>38382:                  ?FAIL({unexpected_failure, IfName, IfIdx, Reason})
<a name="38383"/>38383:          end || {IfIdx, IfName} &lt;- IfNames],
<a name="38384"/>38384: 
<a name="38385"/>38385:     i(&quot;close dummy stream:TCP socket&quot;),
<a name="38386"/>38386:     ok = socket:close(Sock),
<a name="38387"/>38387: 
<a name="38388"/>38388:     i(&quot;done&quot;),
<a name="do_ioctl_get_gifflags-last_expr"/><a name="38389"/>38389:     ok.
<a name="38390"/>38390: 
<a name="38391"/>38391: 
<a name="38392"/>38392: 
<a name="38393"/>38393: <i>%% --- gifmap ---</i>
<a name="38394"/>38394: 
<a name="ioctl_get_gifmap-1"/><a name="38395"/>38395: <b>ioctl_get_gifmap</b>(_Config) when is_list(_Config) -&gt;
<a name="38396"/>38396:     ?TT(?SECS(5)),
<a name="ioctl_get_gifmap-last_expr"/><a name="38397"/>38397: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="38398"/>38398:            fun() -&gt;
<a name="38399"/>38399:                    has_support_net_if_names(),
<a name="38400"/>38400:                    has_support_ioctl_gifmap()
<a name="38401"/>38401:            end,
<a name="38402"/>38402:            fun() -&gt;
<a name="38403"/>38403:                    InitState = #{},
<a name="38404"/>38404:                    ok = do_ioctl_get_gifmap(InitState)
<a name="38405"/>38405:            end).
<a name="38406"/>38406: 
<a name="38407"/>38407: 
<a name="do_ioctl_get_gifmap-1"/><a name="38408"/>38408: <b>do_ioctl_get_gifmap</b>(_State) -&gt;
<a name="38409"/>38409:     i(&quot;create dummy stream:TCP socket&quot;),
<a name="38410"/>38410:     {ok, Sock} = socket:open(inet, stream, tcp),
<a name="38411"/>38411: 
<a name="38412"/>38412:     i(&quot;get if names&quot;),
<a name="38413"/>38413:     {ok, IfNames} = net:if_names(),
<a name="38414"/>38414: 
<a name="38415"/>38415:     i(&quot;try ioctl all if indexes: &quot;
<a name="38416"/>38416:       &quot;~n      ~p&quot;, [IfNames]),
<a name="38417"/>38417:     %% This a *very* simple test...
<a name="38418"/>38418:     %% ...just to check that we actually get an socket address
<a name="38419"/>38419:     _ = [case socket:ioctl(Sock, gifmap, IfName) of
<a name="38420"/>38420:              {ok, Map} when is_map(Map) -&gt;
<a name="38421"/>38421:                  i(&quot;got (expected) map for interface ~p (~w): &quot;
<a name="38422"/>38422:                    &quot;~n      ~p&quot;, [IfName, IfIdx, Map]),
<a name="38423"/>38423:                  ok;
<a name="38424"/>38424:              {ok, Crap} -&gt;
<a name="38425"/>38425:                  %% Oups?!
<a name="38426"/>38426:                  i(&quot;&lt;ERROR&gt; got unexpected result for interface ~p (~w)&quot;
<a name="38427"/>38427:                    &quot;~n      ~p&quot;, [IfName, IfIdx, Crap]),
<a name="38428"/>38428:                  socket:close(Sock),
<a name="38429"/>38429:                  ?FAIL({unexpected_mtu, IfName, IfIdx, Crap});
<a name="38430"/>38430:              {error, Reason} -&gt;
<a name="38431"/>38431:                  i(&quot;&lt;ERROR&gt; got unexpected error for interface ~p (~w)&quot;
<a name="38432"/>38432:                    &quot;~n      Reason: ~p&quot;, [IfName, IfIdx, Reason]),
<a name="38433"/>38433:                  socket:close(Sock),
<a name="38434"/>38434:                  ?FAIL({unexpected_failure, IfName, IfIdx, Reason})
<a name="38435"/>38435:          end || {IfIdx, IfName} &lt;- IfNames],
<a name="38436"/>38436: 
<a name="38437"/>38437:     i(&quot;close dummy stream:TCP socket&quot;),
<a name="38438"/>38438:     ok = socket:close(Sock),
<a name="38439"/>38439: 
<a name="38440"/>38440:     i(&quot;done&quot;),
<a name="do_ioctl_get_gifmap-last_expr"/><a name="38441"/>38441:     ok.
<a name="38442"/>38442: 
<a name="38443"/>38443: 
<a name="38444"/>38444: 
<a name="38445"/>38445: 
<a name="38446"/>38446: <i>%% --- tcp_info ---</i>
<a name="38447"/>38447: 
<a name="ioctl_tcp_info-1"/><a name="38448"/>38448: <b>ioctl_tcp_info</b>(_Config) when is_list(_Config) -&gt;
<a name="38449"/>38449:     ?TT(?SECS(15)),
<a name="38450"/>38450:     Cond = fun() -&gt;
<a name="38451"/>38451: 		   has_support_ioctl_tcp_info()
<a name="38452"/>38452: 	   end,
<a name="38453"/>38453:     TC   = fun() -&gt;
<a name="38454"/>38454: 		   Domain = inet,
<a name="38455"/>38455: 		   case which_local_addr(Domain) of
<a name="38456"/>38456: 		       {ok, Addr} -&gt;
<a name="38457"/>38457: 			   State = #{domain =&gt; Domain,
<a name="38458"/>38458: 				     laddr  =&gt; Addr},
<a name="38459"/>38459: 			   do_ioctl_tcp_info(State);
<a name="38460"/>38460: 		       {error, Reason} -&gt;
<a name="38461"/>38461: 			   skip({no_local_addr, Reason})
<a name="38462"/>38462: 		   end
<a name="38463"/>38463: 	   end,
<a name="ioctl_tcp_info-last_expr"/><a name="38464"/>38464: <b>    tc_try</b>(?FUNCTION_NAME, Cond, TC).
<a name="38465"/>38465: 
<a name="38466"/>38466: 
<a name="do_ioctl_tcp_info-1"/><a name="38467"/>38467: <b>do_ioctl_tcp_info</b>(#{domain := Domain,
<a name="38468"/>38468: 		    laddr  := LAddr} = _State) -&gt;
<a name="38469"/>38469:     LSA = #{family =&gt; Domain, addr =&gt; LAddr},
<a name="38470"/>38470: 
<a name="38471"/>38471:     i(&quot;[server] create stream:TCP server listen socket&quot;),
<a name="38472"/>38472:     {ok, L} = socket:open(Domain, stream, tcp),
<a name="38473"/>38473: 
<a name="38474"/>38474:     i(&quot;[server] bind to ~p&quot;, [LSA]),
<a name="38475"/>38475:     ok = socket:bind(L, LSA),
<a name="38476"/>38476: 
<a name="38477"/>38477:     i(&quot;[server] make listen socket&quot;),
<a name="38478"/>38478:     ok = socket:listen(L),
<a name="38479"/>38479: 
<a name="38480"/>38480:     i(&quot;[server] get sockname&quot;),
<a name="38481"/>38481:     {ok, SSA} = socket:sockname(L),
<a name="38482"/>38482: 
<a name="38483"/>38483: 
<a name="38484"/>38484:     i(&quot;[client] create stream:TCP socket&quot;),
<a name="38485"/>38485:     {ok, C} = socket:open(Domain, stream, tcp),
<a name="38486"/>38486: 
<a name="38487"/>38487:     i(&quot;[client] bind to ~p&quot;, [LSA]),
<a name="38488"/>38488:     ok = socket:bind(C, LSA),
<a name="38489"/>38489: 
<a name="38490"/>38490:     i(&quot;[client] connect to server: &quot;
<a name="38491"/>38491:       &quot;~n   ~p&quot;, [SSA]),
<a name="38492"/>38492:     ok = socket:connect(C, SSA),
<a name="38493"/>38493: 
<a name="38494"/>38494:     
<a name="38495"/>38495:     i(&quot;[server] accept connection&quot;),
<a name="38496"/>38496:     {ok, A} = socket:accept(L),
<a name="38497"/>38497: 
<a name="38498"/>38498:     
<a name="38499"/>38499:     i(&quot;[client] try get tcp info&quot;),
<a name="38500"/>38500:     case socket:ioctl(C, tcp_info) of
<a name="38501"/>38501: 	{ok, CTcpInfo0} -&gt;
<a name="38502"/>38502: 	    i(&quot;[client] tcp info: &quot;
<a name="38503"/>38503: 	      &quot;~n   ~p&quot;
<a name="38504"/>38504: 	      &quot;~n&quot;, [CTcpInfo0]),
<a name="38505"/>38505: 	    ok;
<a name="38506"/>38506: 	{error, CReason0} -&gt;
<a name="38507"/>38507: 	    i(&quot;[client] failed get TCP info: &quot;
<a name="38508"/>38508: 	      &quot;~n   ~p&quot;
<a name="38509"/>38509: 	      &quot;~n&quot;, [CReason0]),
<a name="38510"/>38510: 	    skip({client_tcp_info, 0, CReason0})
<a name="38511"/>38511:     end,
<a name="38512"/>38512: 
<a name="38513"/>38513:     i(&quot;[server] try get tcp info&quot;),
<a name="38514"/>38514:     case socket:ioctl(A, tcp_info) of
<a name="38515"/>38515: 	{ok, ATcpInfo0} -&gt;
<a name="38516"/>38516: 	    i(&quot;[server] tcp info: &quot;
<a name="38517"/>38517: 	      &quot;~n   ~p&quot;
<a name="38518"/>38518: 	      &quot;~n&quot;, [ATcpInfo0]),
<a name="38519"/>38519: 	    ok;
<a name="38520"/>38520: 	{error, AReason0} -&gt;
<a name="38521"/>38521: 	    i(&quot;[server] failed get TCP info: &quot;
<a name="38522"/>38522: 	      &quot;~n   ~p&quot;
<a name="38523"/>38523: 	      &quot;~n&quot;, [AReason0]),
<a name="38524"/>38524: 	    skip({server_tcp_info, 0, AReason0})
<a name="38525"/>38525:     end,
<a name="38526"/>38526: 
<a name="38527"/>38527: 
<a name="38528"/>38528:     Data = &lt;&lt;0,1,2,3,4,5,6,7,8,9,
<a name="38529"/>38529: 	     0,1,2,3,4,5,6,7,8,9&gt;&gt;,
<a name="38530"/>38530:     DSz  = byte_size(Data),
<a name="38531"/>38531:     i(&quot;[client] send some data&quot;),
<a name="38532"/>38532:     ok = socket:send(C, Data),
<a name="38533"/>38533: 
<a name="38534"/>38534:     i(&quot;[client] try get tcp info (verify bytes-out)&quot;),
<a name="38535"/>38535:     case socket:ioctl(C, tcp_info) of
<a name="38536"/>38536: 	{ok, #{bytes_out := BytesOut} = CTcpInfo1} when (BytesOut =:= DSz) -&gt;
<a name="38537"/>38537: 	    i(&quot;[client] tcp info: &quot;
<a name="38538"/>38538: 	      &quot;~n   ~p&quot;
<a name="38539"/>38539: 	      &quot;~n&quot;, [CTcpInfo1]),
<a name="38540"/>38540: 	    ok;
<a name="38541"/>38541: 	{error, CReason1} -&gt;
<a name="38542"/>38542: 	    i(&quot;[client] failed get TCP info: &quot;
<a name="38543"/>38543: 	      &quot;~n   ~p&quot;
<a name="38544"/>38544: 	      &quot;~n&quot;, [CReason1]),
<a name="38545"/>38545: 	    skip({client_tcp_info, 1, CReason1})
<a name="38546"/>38546:     end,
<a name="38547"/>38547: 
<a name="38548"/>38548:     i(&quot;[server] try get tcp info (verify bytes-in)&quot;),
<a name="38549"/>38549:     case socket:ioctl(A, tcp_info) of
<a name="38550"/>38550: 	{ok, #{bytes_in := BytesIn} = ATcpInfo1} when (BytesIn =:= DSz) -&gt;
<a name="38551"/>38551: 	    i(&quot;[server] tcp info: &quot;
<a name="38552"/>38552: 	      &quot;~n   ~p&quot;
<a name="38553"/>38553: 	      &quot;~n&quot;, [ATcpInfo1]),
<a name="38554"/>38554: 	    ok;
<a name="38555"/>38555: 	{error, AReason1} -&gt;
<a name="38556"/>38556: 	    i(&quot;[server] failed get TCP info: &quot;
<a name="38557"/>38557: 	      &quot;~n   ~p&quot;
<a name="38558"/>38558: 	      &quot;~n&quot;, [AReason1]),
<a name="38559"/>38559: 	    skip({server_tcp_info, 1, AReason1})
<a name="38560"/>38560:     end,
<a name="38561"/>38561: 
<a name="38562"/>38562: 
<a name="38563"/>38563:     i(&quot;[server] recv some data&quot;),
<a name="38564"/>38564:     {ok, _} = socket:recv(A),
<a name="38565"/>38565: 
<a name="38566"/>38566:     i(&quot;[client] try get tcp info&quot;),
<a name="38567"/>38567:     {ok, CConnTime2} =
<a name="38568"/>38568: 	case socket:ioctl(C, tcp_info) of
<a name="38569"/>38569: 	    {ok, #{connection_time := CCT2} = CTcpInfo2} -&gt;
<a name="38570"/>38570: 		i(&quot;[client] tcp info: &quot;
<a name="38571"/>38571: 		  &quot;~n   ~p&quot;
<a name="38572"/>38572: 		  &quot;~n&quot;, [CTcpInfo2]),
<a name="38573"/>38573: 		{ok, CCT2};
<a name="38574"/>38574: 	    {error, CReason2} -&gt;
<a name="38575"/>38575: 		i(&quot;[client] failed get TCP info: &quot;
<a name="38576"/>38576: 		  &quot;~n   ~p&quot;
<a name="38577"/>38577: 		  &quot;~n&quot;, [CReason2]),
<a name="38578"/>38578: 		skip({client_tcp_info, 2, CReason2})
<a name="38579"/>38579: 	end,
<a name="38580"/>38580: 
<a name="38581"/>38581:     i(&quot;[server] try get tcp info&quot;),
<a name="38582"/>38582:     {ok, AConnTime2} =
<a name="38583"/>38583: 	case socket:ioctl(A, tcp_info) of
<a name="38584"/>38584: 	    {ok, #{connection_time := ACT2} = ATcpInfo2} -&gt;
<a name="38585"/>38585: 		i(&quot;[server] tcp info: &quot;
<a name="38586"/>38586: 		  &quot;~n   ~p&quot;
<a name="38587"/>38587: 		  &quot;~n&quot;, [ATcpInfo2]),
<a name="38588"/>38588: 		{ok, ACT2};
<a name="38589"/>38589: 	    {error, AReason2} -&gt;
<a name="38590"/>38590: 		i(&quot;[server] failed get TCP info: &quot;
<a name="38591"/>38591: 		  &quot;~n   ~p&quot;
<a name="38592"/>38592: 		  &quot;~n&quot;, [AReason2]),
<a name="38593"/>38593: 		skip({server_tcp_info, 2, AReason2})
<a name="38594"/>38594: 	end,
<a name="38595"/>38595: 
<a name="38596"/>38596:     SLEEP = ?SECS(5),
<a name="38597"/>38597:     ?SLEEP(SLEEP),
<a name="38598"/>38598: 
<a name="38599"/>38599:     i(&quot;[client] try get tcp info (verify connection time)&quot;),
<a name="38600"/>38600:     case socket:ioctl(C, tcp_info) of
<a name="38601"/>38601: 	{ok, #{connection_time := CCT3} = CTcpInfo3}
<a name="38602"/>38602: 	  when (CCT3 &gt;= (SLEEP+CConnTime2)) -&gt;
<a name="38603"/>38603: 	    i(&quot;[client] tcp info: &quot;
<a name="38604"/>38604: 	      &quot;~n   ~p&quot;
<a name="38605"/>38605: 	      &quot;~n&quot;, [CTcpInfo3]),
<a name="38606"/>38606: 	    ok;
<a name="38607"/>38607: 	{error, CReason3} -&gt;
<a name="38608"/>38608: 	    i(&quot;[client] failed get TCP info: &quot;
<a name="38609"/>38609: 	      &quot;~n   ~p&quot;
<a name="38610"/>38610: 	      &quot;~n&quot;, [CReason3]),
<a name="38611"/>38611: 	    skip({client_tcp_info, 3, CReason3})
<a name="38612"/>38612:     end,
<a name="38613"/>38613: 
<a name="38614"/>38614:     i(&quot;[server] try get tcp info (verify connection time)&quot;),
<a name="38615"/>38615:     case socket:ioctl(A, tcp_info) of
<a name="38616"/>38616: 	{ok, #{connection_time := ACT3} = ATcpInfo3} 
<a name="38617"/>38617: 	  when (ACT3 &gt;= (SLEEP+AConnTime2)) -&gt;
<a name="38618"/>38618: 	    i(&quot;[server] tcp info: &quot;
<a name="38619"/>38619: 	      &quot;~n   ~p&quot;
<a name="38620"/>38620: 	      &quot;~n&quot;, [ATcpInfo3]),
<a name="38621"/>38621: 	    ok;
<a name="38622"/>38622: 	{error, AReason3} -&gt;
<a name="38623"/>38623: 	    i(&quot;[server] failed get TCP info: &quot;
<a name="38624"/>38624: 	      &quot;~n   ~p&quot;
<a name="38625"/>38625: 	      &quot;~n&quot;, [AReason3]),
<a name="38626"/>38626: 	    skip({server_tcp_info, 3, AReason3})
<a name="38627"/>38627:     end,
<a name="38628"/>38628: 
<a name="38629"/>38629: 
<a name="38630"/>38630:     i(&quot;cleanup&quot;),
<a name="38631"/>38631:     ok = socket:close(L),
<a name="38632"/>38632:     ok = socket:close(A),
<a name="38633"/>38633:     ok = socket:close(C),
<a name="38634"/>38634: 
<a name="38635"/>38635:     i(&quot;done&quot;),
<a name="do_ioctl_tcp_info-last_expr"/><a name="38636"/>38636:     ok.
<a name="38637"/>38637: 
<a name="38638"/>38638: 
<a name="38639"/>38639: 
<a name="38640"/>38640: 
<a name="38641"/>38641: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="38642"/>38642: <i>%% This test case is intended to (simply) test that the counters</i>
<a name="38643"/>38643: <i>%% for both read and write.</i>
<a name="38644"/>38644: <i>%% So that its easy to extend, we use fun's for read and write.</i>
<a name="38645"/>38645: <i>%% We use TCP on IPv4.</i>
<a name="38646"/>38646: 
<a name="traffic_send_and_recv_counters_tcp4-1"/><a name="38647"/>38647: <b>traffic_send_and_recv_counters_tcp4</b>(_Config) when is_list(_Config) -&gt;
<a name="38648"/>38648:     ?TT(?SECS(15)),
<a name="traffic_send_and_recv_counters_tcp4-last_expr"/><a name="38649"/>38649: <b>    tc_try</b>(traffic_send_and_recv_counters_tcp4,
<a name="38650"/>38650:            fun() -&gt; has_support_ipv4() end,
<a name="38651"/>38651:            fun() -&gt;
<a name="38652"/>38652:                    InitState = #{domain =&gt; inet,
<a name="38653"/>38653:                                  proto  =&gt; tcp,
<a name="38654"/>38654:                                  recv   =&gt; fun(S)    -&gt; socket:recv(S)    end,
<a name="38655"/>38655:                                  send   =&gt; fun(S, D) -&gt; socket:send(S, D) end},
<a name="38656"/>38656:                    ok = traffic_send_and_recv_tcp(InitState)
<a name="38657"/>38657:            end).
<a name="38658"/>38658: 
<a name="38659"/>38659: 
<a name="38660"/>38660: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="38661"/>38661: <i>%% This test case is intended to (simply) test that the counters</i>
<a name="38662"/>38662: <i>%% for both read and write.</i>
<a name="38663"/>38663: <i>%% So that its easy to extend, we use fun's for read and write.</i>
<a name="38664"/>38664: <i>%% We use TCP on IPv6.</i>
<a name="38665"/>38665: 
<a name="traffic_send_and_recv_counters_tcp6-1"/><a name="38666"/>38666: <b>traffic_send_and_recv_counters_tcp6</b>(_Config) when is_list(_Config) -&gt;
<a name="38667"/>38667:     ?TT(?SECS(15)),
<a name="traffic_send_and_recv_counters_tcp6-last_expr"/><a name="38668"/>38668: <b>    tc_try</b>(traffic_send_and_recv_counters_tcp6,
<a name="38669"/>38669:            fun() -&gt; has_support_ipv6() end,
<a name="38670"/>38670:            fun() -&gt;
<a name="38671"/>38671:                    InitState = #{domain =&gt; inet6,
<a name="38672"/>38672:                                  proto  =&gt; tcp,
<a name="38673"/>38673:                                  recv   =&gt; fun(S)    -&gt; socket:recv(S)    end,
<a name="38674"/>38674:                                  send   =&gt; fun(S, D) -&gt; socket:send(S, D) end},
<a name="38675"/>38675:                    ok = traffic_send_and_recv_tcp(InitState)
<a name="38676"/>38676:            end).
<a name="38677"/>38677: 
<a name="38678"/>38678: 
<a name="38679"/>38679: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="38680"/>38680: <i>%% This test case is intended to (simply) test that the counters</i>
<a name="38681"/>38681: <i>%% for both read and write.</i>
<a name="38682"/>38682: <i>%% So that its easy to extend, we use fun's for read and write.</i>
<a name="38683"/>38683: <i>%% We use default (TCP) on local.</i>
<a name="38684"/>38684: 
<a name="traffic_send_and_recv_counters_tcpL-1"/><a name="38685"/>38685: <b>traffic_send_and_recv_counters_tcpL</b>(_Config) when is_list(_Config) -&gt;
<a name="38686"/>38686:     ?TT(?SECS(15)),
<a name="traffic_send_and_recv_counters_tcpL-last_expr"/><a name="38687"/>38687: <b>    tc_try</b>(traffic_send_and_recv_counters_tcpL,
<a name="38688"/>38688:            fun() -&gt; has_support_unix_domain_socket() end,
<a name="38689"/>38689:            fun() -&gt;
<a name="38690"/>38690:                    InitState = #{domain =&gt; local,
<a name="38691"/>38691:                                  proto  =&gt; default,
<a name="38692"/>38692:                                  recv   =&gt; fun(S)    -&gt; socket:recv(S)    end,
<a name="38693"/>38693:                                  send   =&gt; fun(S, D) -&gt; socket:send(S, D) end},
<a name="38694"/>38694:                    ok = traffic_send_and_recv_tcp(InitState)
<a name="38695"/>38695:            end).
<a name="38696"/>38696: 
<a name="38697"/>38697: 
<a name="38698"/>38698: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="38699"/>38699: <i>%% This test case is intended to (simply) test that the counters</i>
<a name="38700"/>38700: <i>%% for both read and write.</i>
<a name="38701"/>38701: <i>%% So that its easy to extend, we use fun's for read and write.</i>
<a name="38702"/>38702: <i>%% We use TCP on IPv4.</i>
<a name="38703"/>38703: 
<a name="traffic_sendmsg_and_recvmsg_counters_tcp4-1"/><a name="38704"/>38704: <b>traffic_sendmsg_and_recvmsg_counters_tcp4</b>(_Config) when is_list(_Config) -&gt;
<a name="38705"/>38705:     ?TT(?SECS(15)),
<a name="traffic_sendmsg_and_recvmsg_counters_tcp4-last_expr"/><a name="38706"/>38706: <b>    tc_try</b>(traffic_sendmsg_and_recvmsg_counters_tcp4,
<a name="38707"/>38707:            fun() -&gt;
<a name="38708"/>38708:                    is_not_windows(),
<a name="38709"/>38709:                    has_support_ipv4()
<a name="38710"/>38710:            end,
<a name="38711"/>38711:            fun() -&gt;
<a name="38712"/>38712:                    InitState = #{domain =&gt; inet,
<a name="38713"/>38713:                                  proto  =&gt; tcp,
<a name="38714"/>38714:                                  recv   =&gt; fun(S) -&gt;
<a name="38715"/>38715:                                                    case socket:recvmsg(S) of
<a name="38716"/>38716:                                                        {ok, #{iov  := [Data]}} -&gt;
<a name="38717"/>38717:                                                            {ok, Data};
<a name="38718"/>38718:                                                        {error, _} = ERROR -&gt;
<a name="38719"/>38719:                                                            ERROR
<a name="38720"/>38720:                                                    end
<a name="38721"/>38721:                                            end,
<a name="38722"/>38722:                                  send   =&gt; fun(S, Data) -&gt;
<a name="38723"/>38723:                                                    Msg = #{iov =&gt; [Data]},
<a name="38724"/>38724:                                                    socket:sendmsg(S, Msg)
<a name="38725"/>38725:                                            end},
<a name="38726"/>38726:                    ok = traffic_send_and_recv_tcp(InitState)
<a name="38727"/>38727:            end).
<a name="38728"/>38728: 
<a name="38729"/>38729: 
<a name="38730"/>38730: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="38731"/>38731: <i>%% This test case is intended to (simply) test that the counters</i>
<a name="38732"/>38732: <i>%% for both read and write.</i>
<a name="38733"/>38733: <i>%% So that its easy to extend, we use fun's for read and write.</i>
<a name="38734"/>38734: <i>%% We use TCP on IPv6.</i>
<a name="38735"/>38735: 
<a name="traffic_sendmsg_and_recvmsg_counters_tcp6-1"/><a name="38736"/>38736: <b>traffic_sendmsg_and_recvmsg_counters_tcp6</b>(_Config) when is_list(_Config) -&gt;
<a name="38737"/>38737:     ?TT(?SECS(15)),
<a name="traffic_sendmsg_and_recvmsg_counters_tcp6-last_expr"/><a name="38738"/>38738: <b>    tc_try</b>(traffic_sendmsg_and_recvmsg_counters_tcp6,
<a name="38739"/>38739:            fun() -&gt;
<a name="38740"/>38740:                    is_not_windows(),
<a name="38741"/>38741:                    has_support_ipv6()
<a name="38742"/>38742:            end,
<a name="38743"/>38743:            fun() -&gt;
<a name="38744"/>38744:                    InitState = #{domain =&gt; inet6,
<a name="38745"/>38745:                                  proto  =&gt; tcp,
<a name="38746"/>38746:                                  recv   =&gt; fun(S) -&gt;
<a name="38747"/>38747:                                                    case socket:recvmsg(S) of
<a name="38748"/>38748:                                                        {ok, #{iov  := [Data]}} -&gt;
<a name="38749"/>38749:                                                            {ok, Data};
<a name="38750"/>38750:                                                        {error, _} = ERROR -&gt;
<a name="38751"/>38751:                                                            ERROR
<a name="38752"/>38752:                                                    end
<a name="38753"/>38753:                                            end,
<a name="38754"/>38754:                                  send   =&gt; fun(S, Data) -&gt;
<a name="38755"/>38755:                                                    Msg = #{iov =&gt; [Data]},
<a name="38756"/>38756:                                                    socket:sendmsg(S, Msg)
<a name="38757"/>38757:                                            end},
<a name="38758"/>38758:                    ok = traffic_send_and_recv_tcp(InitState)
<a name="38759"/>38759:            end).
<a name="38760"/>38760: 
<a name="38761"/>38761: 
<a name="38762"/>38762: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="38763"/>38763: <i>%% This test case is intended to (simply) test that the counters</i>
<a name="38764"/>38764: <i>%% for both read and write.</i>
<a name="38765"/>38765: <i>%% So that its easy to extend, we use fun's for read and write.</i>
<a name="38766"/>38766: <i>%% We use default (TCP) on local.</i>
<a name="38767"/>38767: 
<a name="traffic_sendmsg_and_recvmsg_counters_tcpL-1"/><a name="38768"/>38768: <b>traffic_sendmsg_and_recvmsg_counters_tcpL</b>(_Config) when is_list(_Config) -&gt;
<a name="38769"/>38769:     ?TT(?SECS(15)),
<a name="traffic_sendmsg_and_recvmsg_counters_tcpL-last_expr"/><a name="38770"/>38770: <b>    tc_try</b>(traffic_sendmsg_and_recvmsg_counters_tcpL,
<a name="38771"/>38771:            fun() -&gt; has_support_unix_domain_socket() end,
<a name="38772"/>38772:            fun() -&gt;
<a name="38773"/>38773:                    InitState = #{domain =&gt; local,
<a name="38774"/>38774:                                  proto  =&gt; default,
<a name="38775"/>38775:                                  recv   =&gt; fun(S) -&gt;
<a name="38776"/>38776:                                                    case socket:recvmsg(S) of
<a name="38777"/>38777:                                                        {ok, #{iov  := [Data]}} -&gt;
<a name="38778"/>38778:                                                            {ok, Data};
<a name="38779"/>38779:                                                        {error, _} = ERROR -&gt;
<a name="38780"/>38780:                                                            ERROR
<a name="38781"/>38781:                                                    end
<a name="38782"/>38782:                                            end,
<a name="38783"/>38783:                                  send   =&gt; fun(S, Data) -&gt;
<a name="38784"/>38784:                                                    Msg = #{iov =&gt; [Data]},
<a name="38785"/>38785:                                                    socket:sendmsg(S, Msg)
<a name="38786"/>38786:                                            end},
<a name="38787"/>38787:                    ok = traffic_send_and_recv_tcp(InitState)
<a name="38788"/>38788:            end).
<a name="38789"/>38789: 
<a name="38790"/>38790: 
<a name="38791"/>38791: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="38792"/>38792: 
<a name="traffic_send_and_recv_tcp-1"/><a name="38793"/>38793: <b>traffic_send_and_recv_tcp</b>(InitState) -&gt;
<a name="38794"/>38794:     ServerSeq =
<a name="38795"/>38795:         [
<a name="38796"/>38796:          %% *** Wait for start order part ***
<a name="38797"/>38797:          #{desc =&gt; &quot;await start&quot;,
<a name="38798"/>38798:            cmd  =&gt; fun(State) -&gt;
<a name="38799"/>38799:                            Tester = ?SEV_AWAIT_START(),
<a name="38800"/>38800:                            {ok, State#{tester =&gt; Tester}}
<a name="38801"/>38801:                    end},
<a name="38802"/>38802:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="38803"/>38803:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="38804"/>38804:                            _MRef = erlang:monitor(process, Tester),
<a name="38805"/>38805:                            ok
<a name="38806"/>38806:                    end},
<a name="38807"/>38807: 
<a name="38808"/>38808:          %% *** Init part ***
<a name="38809"/>38809:          #{desc =&gt; &quot;which local address&quot;,
<a name="38810"/>38810:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="38811"/>38811:                            LSA = which_local_socket_addr(Domain),
<a name="38812"/>38812:                            {ok, State#{local_sa =&gt; LSA}}
<a name="38813"/>38813:                    end},
<a name="38814"/>38814:          #{desc =&gt; &quot;create listen socket&quot;,
<a name="38815"/>38815:            cmd  =&gt; fun(#{domain := Domain, proto := Proto} = State) -&gt;
<a name="38816"/>38816:                            case socket:open(Domain, stream, Proto) of
<a name="38817"/>38817:                                {ok, Sock} -&gt;
<a name="38818"/>38818:                                    {ok, State#{lsock =&gt; Sock}};
<a name="38819"/>38819:                                {error, eafnosupport = Reason} -&gt;
<a name="38820"/>38820:                                    {skip, Reason};
<a name="38821"/>38821:                                {error, _} = ERROR -&gt;
<a name="38822"/>38822:                                    ERROR
<a name="38823"/>38823:                            end
<a name="38824"/>38824:                    end},
<a name="38825"/>38825:          #{desc =&gt; &quot;bind to local address&quot;,
<a name="38826"/>38826:            cmd  =&gt; fun(#{domain   := local,
<a name="38827"/>38827:                          lsock    := LSock,
<a name="38828"/>38828:                          local_sa := LSA} = _State) -&gt;
<a name="38829"/>38829:                            case socket:bind(LSock, LSA) of
<a name="38830"/>38830:                                ok -&gt;
<a name="38831"/>38831:                                    ok; % We do not care about the port for local
<a name="38832"/>38832:                                {error, _} = ERROR -&gt;
<a name="38833"/>38833:                                    ERROR
<a name="38834"/>38834:                            end;
<a name="38835"/>38835:                       (#{lsock    := LSock,
<a name="38836"/>38836:                          local_sa := LSA} = State) -&gt;
<a name="38837"/>38837:                            case sock_bind(LSock, LSA) of
<a name="38838"/>38838:                                ok -&gt;
<a name="38839"/>38839:                                    Port = sock_port(LSock),
<a name="38840"/>38840:                                    {ok, State#{lport =&gt; Port}};
<a name="38841"/>38841:                                {error, _} = ERROR -&gt;
<a name="38842"/>38842:                                    ERROR
<a name="38843"/>38843:                            end
<a name="38844"/>38844:                    end},
<a name="38845"/>38845:          #{desc =&gt; &quot;make listen socket&quot;,
<a name="38846"/>38846:            cmd  =&gt; fun(#{lsock := LSock}) -&gt;
<a name="38847"/>38847:                            socket:listen(LSock)
<a name="38848"/>38848:                    end},
<a name="38849"/>38849:          #{desc =&gt; &quot;initial (listen socket) counter validation (=zero)&quot;,
<a name="38850"/>38850:            cmd  =&gt; fun(#{lsock := LSock} = _State) -&gt;
<a name="38851"/>38851:                            try socket:info(LSock) of
<a name="38852"/>38852:                                #{counters := Counters} -&gt;
<a name="38853"/>38853:                                    ?SEV_IPRINT(&quot;Validate initial listen socket counters: &quot;
<a name="38854"/>38854:                                                &quot;~s&quot;, [format_counters(listen,
<a name="38855"/>38855:                                                                       Counters)]),
<a name="38856"/>38856:                                    traffic_sar_counters_validation(Counters)
<a name="38857"/>38857:                            catch
<a name="38858"/>38858:                                C:E:S -&gt;
<a name="38859"/>38859:                                    ?SEV_EPRINT(&quot;Failed get socket info: &quot;
<a name="38860"/>38860:                                                &quot;~n   Class: ~p&quot;
<a name="38861"/>38861:                                                &quot;~n   Error: ~p&quot;
<a name="38862"/>38862:                                                &quot;~n   Stack: ~p&quot;, [C, E, S]),
<a name="38863"/>38863:                                    {error, {socket_info_failed, {C, E, S}}}
<a name="38864"/>38864:                            end
<a name="38865"/>38865:                    end},
<a name="38866"/>38866:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="38867"/>38867:            cmd  =&gt; fun(#{domain   := local,
<a name="38868"/>38868:                          tester   := Tester,
<a name="38869"/>38869:                          local_sa := #{path := Path}}) -&gt;
<a name="38870"/>38870:                            ?SEV_ANNOUNCE_READY(Tester, init, Path),
<a name="38871"/>38871:                            ok;
<a name="38872"/>38872:                       (#{tester   := Tester,
<a name="38873"/>38873:                          lport    := Port}) -&gt;
<a name="38874"/>38874:                            ?SEV_ANNOUNCE_READY(Tester, init, Port),
<a name="38875"/>38875:                            ok
<a name="38876"/>38876:                    end},
<a name="38877"/>38877: 
<a name="38878"/>38878:          %% The actual test
<a name="38879"/>38879:          #{desc =&gt; &quot;await continue (accept)&quot;,
<a name="38880"/>38880:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="38881"/>38881:                            ?SEV_AWAIT_CONTINUE(Tester, tester, accept)
<a name="38882"/>38882:                    end},
<a name="38883"/>38883:          #{desc =&gt; &quot;accept&quot;,
<a name="38884"/>38884:            cmd  =&gt; fun(#{lsock := LSock} = State) -&gt;
<a name="38885"/>38885:                            case socket:accept(LSock) of
<a name="38886"/>38886:                                {ok, CSock} -&gt;
<a name="38887"/>38887:                                    #{counters := LCnts} = socket:info(LSock),
<a name="38888"/>38888:                                    ?SEV_IPRINT(&quot;Validate listen counters: &quot;
<a name="38889"/>38889:                                                &quot;~s&quot;, [format_counters(listen,
<a name="38890"/>38890:                                                                       LCnts)]),
<a name="38891"/>38891:                                    traffic_sar_counters_validation(
<a name="38892"/>38892:                                      LCnts,
<a name="38893"/>38893:                                      [{acc_success, 1},
<a name="38894"/>38894:                                       {acc_fails,   0},
<a name="38895"/>38895:                                       {acc_tries,   1},
<a name="38896"/>38896:                                       {acc_waits,   0}]),
<a name="38897"/>38897:                                    #{counters := CCnts} = socket:info(CSock),
<a name="38898"/>38898:                                    ?SEV_IPRINT(&quot;Validate initial accept counters: &quot;
<a name="38899"/>38899:                                                &quot;~s&quot;, [format_counters(CCnts)]),
<a name="38900"/>38900:                                    traffic_sar_counters_validation(CCnts),
<a name="38901"/>38901:                                    {ok, State#{csock =&gt; CSock}};
<a name="38902"/>38902:                                {error, _} = ERROR -&gt;
<a name="38903"/>38903:                                    ERROR
<a name="38904"/>38904:                            end
<a name="38905"/>38905:                    end},
<a name="38906"/>38906:          #{desc =&gt; &quot;initial counter validation (=zero)&quot;,
<a name="38907"/>38907:            cmd  =&gt; fun(#{csock := Sock} = _State) -&gt;
<a name="38908"/>38908:                            try socket:info(Sock) of
<a name="38909"/>38909:                                #{counters := Counters} -&gt;
<a name="38910"/>38910:                                    ?SEV_IPRINT(&quot;Validate initial counters: &quot;
<a name="38911"/>38911:                                                &quot;~s&quot;, [format_counters(Counters)]),
<a name="38912"/>38912:                                    traffic_sar_counters_validation(Counters)
<a name="38913"/>38913:                            catch
<a name="38914"/>38914:                                C:E:S -&gt;
<a name="38915"/>38915:                                    ?SEV_EPRINT(&quot;Failed get socket info: &quot;
<a name="38916"/>38916:                                                &quot;~n   Class: ~p&quot;
<a name="38917"/>38917:                                                &quot;~n   Error: ~p&quot;
<a name="38918"/>38918:                                                &quot;~n   Stack: ~p&quot;, [C, E, S]),
<a name="38919"/>38919:                                    {error, {socket_info_failed, {C, E, S}}}
<a name="38920"/>38920:                            end
<a name="38921"/>38921:                    end},
<a name="38922"/>38922:          #{desc =&gt; &quot;announce ready (accept)&quot;,
<a name="38923"/>38923:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="38924"/>38924:                            ?SEV_ANNOUNCE_READY(Tester, accept),
<a name="38925"/>38925:                            ok
<a name="38926"/>38926:                    end},
<a name="38927"/>38927: 
<a name="38928"/>38928:          #{desc =&gt; &quot;await continue (recv_and_validate 1)&quot;,
<a name="38929"/>38929:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="38930"/>38930:                            ?SEV_AWAIT_CONTINUE(Tester, tester, recv_and_validate)
<a name="38931"/>38931:                    end},
<a name="38932"/>38932:          #{desc =&gt; &quot;recv (1)&quot;,
<a name="38933"/>38933:            cmd  =&gt; fun(#{csock := Sock,
<a name="38934"/>38934:                          recv  := Recv} = State) -&gt;
<a name="38935"/>38935:                            case Recv(Sock) of
<a name="38936"/>38936:                                {ok, Data} -&gt;
<a name="38937"/>38937:                                    ?SEV_IPRINT(&quot;recv ~p bytes&quot;, [size(Data)]),
<a name="38938"/>38938:                                    {ok, State#{read_pkg  =&gt; 1,
<a name="38939"/>38939:                                                read_byte =&gt; size(Data)}};
<a name="38940"/>38940:                                {error, _} = ERROR -&gt;
<a name="38941"/>38941:                                    ERROR
<a name="38942"/>38942:                            end
<a name="38943"/>38943:                    end},
<a name="38944"/>38944:          #{desc =&gt; &quot;validate (recv 1)&quot;,
<a name="38945"/>38945:            cmd  =&gt; fun(#{csock     := Sock,
<a name="38946"/>38946:                          read_pkg  := Pkg,
<a name="38947"/>38947:                          read_byte := Byte} = _State) -&gt;
<a name="38948"/>38948:                            try socket:info(Sock) of
<a name="38949"/>38949:                                #{counters := Counters} -&gt;
<a name="38950"/>38950:                                    ?SEV_IPRINT(&quot;validate counters: &quot;
<a name="38951"/>38951:                                                &quot;~s&quot;, [format_counters(Counters)]),
<a name="38952"/>38952:                                    traffic_sar_counters_validation(
<a name="38953"/>38953:                                      Counters,
<a name="38954"/>38954:                                      [{read_pkg,     Pkg},
<a name="38955"/>38955:                                       {read_byte,    Byte},
<a name="38956"/>38956:                                       {read_tries,   any},
<a name="38957"/>38957:                                       {read_pkg_max, any}])
<a name="38958"/>38958:                            catch
<a name="38959"/>38959:                                C:E:S -&gt;
<a name="38960"/>38960:                                    ?SEV_EPRINT(&quot;Failed get socket info: &quot;
<a name="38961"/>38961:                                                &quot;~n   Class: ~p&quot;
<a name="38962"/>38962:                                                &quot;~n   Error: ~p&quot;
<a name="38963"/>38963:                                                &quot;~n   Stack: ~p&quot;, [C, E, S]),
<a name="38964"/>38964:                                    {error, {socket_info_failed, {C, E, S}}}
<a name="38965"/>38965:                            end
<a name="38966"/>38966:                    end},
<a name="38967"/>38967:          #{desc =&gt; &quot;announce ready (recv_and_validate 1)&quot;,
<a name="38968"/>38968:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="38969"/>38969:                            ?SEV_ANNOUNCE_READY(Tester, recv_and_validate),
<a name="38970"/>38970:                            ok
<a name="38971"/>38971:                    end},
<a name="38972"/>38972: 
<a name="38973"/>38973:          #{desc =&gt; &quot;await continue (send_and_validate 1)&quot;,
<a name="38974"/>38974:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="38975"/>38975:                            ?SEV_AWAIT_CONTINUE(Tester, tester, send_and_validate)
<a name="38976"/>38976:                    end},
<a name="38977"/>38977:          #{desc =&gt; &quot;send (1)&quot;,
<a name="38978"/>38978:            cmd  =&gt; fun(#{csock := Sock,
<a name="38979"/>38979:                          send  := Send} = State) -&gt;
<a name="38980"/>38980:                            Data = ?DATA,
<a name="38981"/>38981:                            case Send(Sock, Data) of
<a name="38982"/>38982:                                ok -&gt;
<a name="38983"/>38983:                                    ?SEV_IPRINT(&quot;sent ~p bytes&quot;, [size(Data)]),
<a name="38984"/>38984:                                    {ok, State#{write_pkg  =&gt; 1,
<a name="38985"/>38985:                                                write_byte =&gt; size(Data)}};
<a name="38986"/>38986:                                {error, _} = ERROR -&gt;
<a name="38987"/>38987:                                    ERROR
<a name="38988"/>38988:                            end
<a name="38989"/>38989:                    end},
<a name="38990"/>38990:          #{desc =&gt; &quot;validate (send 1)&quot;,
<a name="38991"/>38991:            cmd  =&gt; fun(#{csock      := Sock,
<a name="38992"/>38992:                          read_pkg   := RPkg,
<a name="38993"/>38993:                          read_byte  := RByte,
<a name="38994"/>38994:                          write_pkg  := SPkg,
<a name="38995"/>38995:                          write_byte := SByte} = _State) -&gt;
<a name="38996"/>38996:                            try socket:info(Sock) of
<a name="38997"/>38997:                                #{counters := Counters} -&gt;
<a name="38998"/>38998:                                    ?SEV_IPRINT(&quot;validate counters: &quot;
<a name="38999"/>38999:                                                &quot;~s&quot;, [format_counters(Counters)]),
<a name="39000"/>39000:                                    traffic_sar_counters_validation(
<a name="39001"/>39001:                                      Counters,
<a name="39002"/>39002:                                      [{read_pkg,      RPkg},
<a name="39003"/>39003:                                       {read_byte,     RByte},
<a name="39004"/>39004:                                       {write_pkg,     SPkg},
<a name="39005"/>39005:                                       {write_byte,    SByte},
<a name="39006"/>39006:                                       {read_tries,    any},
<a name="39007"/>39007:                                       {write_tries,   any},
<a name="39008"/>39008:                                       {read_pkg_max,  any},
<a name="39009"/>39009:                                       {write_pkg_max, any}])
<a name="39010"/>39010:                            catch
<a name="39011"/>39011:                                C:E:S -&gt;
<a name="39012"/>39012:                                    ?SEV_EPRINT(&quot;Failed get socket info: &quot;
<a name="39013"/>39013:                                                &quot;~n   Class: ~p&quot;
<a name="39014"/>39014:                                                &quot;~n   Error: ~p&quot;
<a name="39015"/>39015:                                                &quot;~n   Stack: ~p&quot;, [C, E, S]),
<a name="39016"/>39016:                                    {error, {socket_info_failed, {C, E, S}}}
<a name="39017"/>39017:                            end
<a name="39018"/>39018:                    end},
<a name="39019"/>39019:          #{desc =&gt; &quot;announce ready (send_and_validate 1)&quot;,
<a name="39020"/>39020:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="39021"/>39021:                            ?SEV_ANNOUNCE_READY(Tester, send_and_validate),
<a name="39022"/>39022:                            ok
<a name="39023"/>39023:                    end},
<a name="39024"/>39024: 
<a name="39025"/>39025:          #{desc =&gt; &quot;await continue (recv_and_validate 2)&quot;,
<a name="39026"/>39026:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="39027"/>39027:                            ?SEV_AWAIT_CONTINUE(Tester, tester, recv_and_validate)
<a name="39028"/>39028:                    end},
<a name="39029"/>39029:          #{desc =&gt; &quot;recv (2)&quot;,
<a name="39030"/>39030:            cmd  =&gt; fun(#{csock     := Sock,
<a name="39031"/>39031:                          recv      := Recv,
<a name="39032"/>39032:                          read_pkg  := Pkg,
<a name="39033"/>39033:                          read_byte := Byte} = State) -&gt;
<a name="39034"/>39034:                            case Recv(Sock) of
<a name="39035"/>39035:                                {ok, Data} -&gt;
<a name="39036"/>39036:                                    ?SEV_IPRINT(&quot;recv ~p bytes&quot;, [size(Data)]),
<a name="39037"/>39037:                                    {ok, State#{read_pkg  =&gt; Pkg + 1,
<a name="39038"/>39038:                                                read_byte =&gt; Byte + size(Data)}};
<a name="39039"/>39039:                                {error, _} = ERROR -&gt;
<a name="39040"/>39040:                                    ERROR
<a name="39041"/>39041:                            end
<a name="39042"/>39042:                    end},
<a name="39043"/>39043:          #{desc =&gt; &quot;validate (recv 2)&quot;,
<a name="39044"/>39044:            cmd  =&gt; fun(#{csock      := Sock,
<a name="39045"/>39045:                          read_pkg   := RPkg,
<a name="39046"/>39046:                          read_byte  := RByte,
<a name="39047"/>39047:                          write_pkg  := SPkg,
<a name="39048"/>39048:                          write_byte := SByte} = _State) -&gt;
<a name="39049"/>39049:                            try socket:info(Sock) of
<a name="39050"/>39050:                                #{counters := Counters} -&gt;
<a name="39051"/>39051:                                    ?SEV_IPRINT(&quot;validate counters: &quot;
<a name="39052"/>39052:                                                &quot;~s&quot;, [format_counters(Counters)]),
<a name="39053"/>39053:                                    traffic_sar_counters_validation(
<a name="39054"/>39054:                                      Counters,
<a name="39055"/>39055:                                      [{read_pkg,      RPkg},
<a name="39056"/>39056:                                       {read_byte,     RByte},
<a name="39057"/>39057:                                       {write_pkg,     SPkg},
<a name="39058"/>39058:                                       {write_byte,    SByte},
<a name="39059"/>39059:                                       {read_tries,    any},
<a name="39060"/>39060:                                       {write_tries,   any},
<a name="39061"/>39061:                                       {read_pkg_max,  any},
<a name="39062"/>39062:                                       {write_pkg_max, any}])
<a name="39063"/>39063:                            catch
<a name="39064"/>39064:                                C:E:S -&gt;
<a name="39065"/>39065:                                    ?SEV_EPRINT(&quot;Failed get socket info: &quot;
<a name="39066"/>39066:                                                &quot;~n   Class: ~p&quot;
<a name="39067"/>39067:                                                &quot;~n   Error: ~p&quot;
<a name="39068"/>39068:                                                &quot;~n   Stack: ~p&quot;, [C, E, S]),
<a name="39069"/>39069:                                    {error, {socket_info_failed, {C, E, S}}}
<a name="39070"/>39070:                            end
<a name="39071"/>39071:                    end},
<a name="39072"/>39072:          #{desc =&gt; &quot;announce ready (recv_and_validate 2)&quot;,
<a name="39073"/>39073:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="39074"/>39074:                            ?SEV_ANNOUNCE_READY(Tester, recv_and_validate),
<a name="39075"/>39075:                            ok
<a name="39076"/>39076:                    end},
<a name="39077"/>39077: 
<a name="39078"/>39078:          #{desc =&gt; &quot;await continue (send_and_validate 2)&quot;,
<a name="39079"/>39079:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="39080"/>39080:                            ?SEV_AWAIT_CONTINUE(Tester, tester, send_and_validate)
<a name="39081"/>39081:                    end},
<a name="39082"/>39082:          #{desc =&gt; &quot;send (2)&quot;,
<a name="39083"/>39083:            cmd  =&gt; fun(#{csock      := Sock,
<a name="39084"/>39084:                          send       := Send,
<a name="39085"/>39085:                          write_pkg  := Pkg,
<a name="39086"/>39086:                          write_byte := Byte} = State) -&gt;
<a name="39087"/>39087:                            Data = ?DATA,
<a name="39088"/>39088:                            case Send(Sock, Data) of
<a name="39089"/>39089:                                ok -&gt;
<a name="39090"/>39090:                                    ?SEV_IPRINT(&quot;sent ~p bytes&quot;, [size(Data)]),
<a name="39091"/>39091:                                    {ok, State#{write_pkg  =&gt; Pkg + 1,
<a name="39092"/>39092:                                                write_byte =&gt; Byte + size(Data)}};
<a name="39093"/>39093:                                {error, _} = ERROR -&gt;
<a name="39094"/>39094:                                    ERROR
<a name="39095"/>39095:                            end
<a name="39096"/>39096:                    end},
<a name="39097"/>39097:          #{desc =&gt; &quot;validate (send 2)&quot;,
<a name="39098"/>39098:            cmd  =&gt; fun(#{csock      := Sock,
<a name="39099"/>39099:                          read_pkg   := RPkg,
<a name="39100"/>39100:                          read_byte  := RByte,
<a name="39101"/>39101:                          write_pkg  := SPkg,
<a name="39102"/>39102:                          write_byte := SByte} = _State) -&gt;
<a name="39103"/>39103:                            try socket:info(Sock) of
<a name="39104"/>39104:                                #{counters := Counters} -&gt;
<a name="39105"/>39105:                                    ?SEV_IPRINT(&quot;validate counters: &quot;
<a name="39106"/>39106:                                                &quot;~s&quot;, [format_counters(Counters)]),
<a name="39107"/>39107:                                    traffic_sar_counters_validation(
<a name="39108"/>39108:                                      Counters,
<a name="39109"/>39109:                                      [{read_pkg,      RPkg},
<a name="39110"/>39110:                                       {read_byte,     RByte},
<a name="39111"/>39111:                                       {write_pkg,     SPkg},
<a name="39112"/>39112:                                       {write_byte,    SByte},
<a name="39113"/>39113:                                       {read_tries,    any},
<a name="39114"/>39114:                                       {write_tries,   any},
<a name="39115"/>39115:                                       {read_pkg_max,  any},
<a name="39116"/>39116:                                       {write_pkg_max, any}])
<a name="39117"/>39117:                            catch
<a name="39118"/>39118:                                C:E:S -&gt;
<a name="39119"/>39119:                                    ?SEV_EPRINT(&quot;Failed get socket info: &quot;
<a name="39120"/>39120:                                                &quot;~n   Class: ~p&quot;
<a name="39121"/>39121:                                                &quot;~n   Error: ~p&quot;
<a name="39122"/>39122:                                                &quot;~n   Stack: ~p&quot;, [C, E, S]),
<a name="39123"/>39123:                                    {error, {socket_info_failed, {C, E, S}}}
<a name="39124"/>39124:                            end
<a name="39125"/>39125:                    end},
<a name="39126"/>39126:          #{desc =&gt; &quot;announce ready (send_and_validate 2)&quot;,
<a name="39127"/>39127:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="39128"/>39128:                            ?SEV_ANNOUNCE_READY(Tester, send_and_validate),
<a name="39129"/>39129:                            ok
<a name="39130"/>39130:                    end},
<a name="39131"/>39131: 
<a name="39132"/>39132: 
<a name="39133"/>39133:          %% Termination
<a name="39134"/>39134:          #{desc =&gt; &quot;await terminate (from tester)&quot;,
<a name="39135"/>39135:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="39136"/>39136:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="39137"/>39137:                                ok -&gt;
<a name="39138"/>39138:                                    {ok, maps:remove(tester, State)};
<a name="39139"/>39139:                                {error, _} = ERROR -&gt;
<a name="39140"/>39140:                                    ERROR
<a name="39141"/>39141:                            end
<a name="39142"/>39142:                    end},
<a name="39143"/>39143:          #{desc =&gt; &quot;close connection socket (just in case)&quot;,
<a name="39144"/>39144:            cmd  =&gt; fun(#{csock := Sock} = State) -&gt;
<a name="39145"/>39145:                            (catch socket:close(Sock)),
<a name="39146"/>39146:                            {ok, maps:remove(csock, State)}
<a name="39147"/>39147:                    end},
<a name="39148"/>39148:          #{desc =&gt; &quot;close listen socket&quot;,
<a name="39149"/>39149:            cmd  =&gt; fun(#{domain   := local,
<a name="39150"/>39150:                          lsock    := Sock,
<a name="39151"/>39151:                          local_sa := #{path := Path}} = State) -&gt;
<a name="39152"/>39152:                            ok = socket:close(Sock),
<a name="39153"/>39153:                            State1 =
<a name="39154"/>39154:                                unlink_path(Path,
<a name="39155"/>39155:                                            fun() -&gt;
<a name="39156"/>39156:                                                    maps:remove(local_sa, State)
<a name="39157"/>39157:                                            end,
<a name="39158"/>39158:                                            fun() -&gt; State end),
<a name="39159"/>39159:                            {ok, maps:remove(lsock, State1)};
<a name="39160"/>39160:                       (#{lsock := Sock} = State) -&gt;
<a name="39161"/>39161:                            (catch socket:close(Sock)),
<a name="39162"/>39162:                            {ok, maps:remove(lsock, State)}
<a name="39163"/>39163:                    end},
<a name="39164"/>39164: 
<a name="39165"/>39165:          %% *** We are done ***
<a name="39166"/>39166:          ?SEV_FINISH_NORMAL
<a name="39167"/>39167:         ],
<a name="39168"/>39168: 
<a name="39169"/>39169:     ClientSeq =
<a name="39170"/>39170:         [
<a name="39171"/>39171:          %% *** Wait for start order part ***
<a name="39172"/>39172:          #{desc =&gt; &quot;await start (from tester)&quot;,
<a name="39173"/>39173:            cmd  =&gt; fun(#{domain := local} = State) -&gt;
<a name="39174"/>39174:                            {Tester, Path} = ?SEV_AWAIT_START(),
<a name="39175"/>39175:                            {ok, State#{tester =&gt; Tester, server_path =&gt; Path}};
<a name="39176"/>39176:                       (State) -&gt;
<a name="39177"/>39177:                            {Tester, Port} = ?SEV_AWAIT_START(),
<a name="39178"/>39178:                            {ok, State#{tester =&gt; Tester, server_port =&gt; Port}}
<a name="39179"/>39179:                    end},
<a name="39180"/>39180:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="39181"/>39181:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="39182"/>39182:                            _MRef = erlang:monitor(process, Tester),
<a name="39183"/>39183:                            ok
<a name="39184"/>39184:                    end},
<a name="39185"/>39185: 
<a name="39186"/>39186:          %% *** Init part ***
<a name="39187"/>39187:          #{desc =&gt; &quot;which server (local) address&quot;,
<a name="39188"/>39188:            cmd  =&gt; fun(#{domain      := local = Domain,
<a name="39189"/>39189:                          server_path := Path} = State) -&gt;
<a name="39190"/>39190:                            LSA = which_local_socket_addr(Domain),
<a name="39191"/>39191:                            SSA = #{family =&gt; Domain, path =&gt; Path},
<a name="39192"/>39192:                            {ok, State#{local_sa =&gt; LSA, server_sa =&gt; SSA}};
<a name="39193"/>39193:                       (#{domain := Domain, server_port := Port} = State) -&gt;
<a name="39194"/>39194:                            LSA = which_local_socket_addr(Domain),
<a name="39195"/>39195:                            SSA = LSA#{port =&gt; Port},
<a name="39196"/>39196:                            {ok, State#{local_sa =&gt; LSA, server_sa =&gt; SSA}}
<a name="39197"/>39197:                    end},
<a name="39198"/>39198:          #{desc =&gt; &quot;create socket&quot;,
<a name="39199"/>39199:            cmd  =&gt; fun(#{domain := Domain,
<a name="39200"/>39200:                          proto  := Proto} = State) -&gt;
<a name="39201"/>39201:                            case socket:open(Domain, stream, Proto) of
<a name="39202"/>39202:                                {ok, Sock} -&gt;
<a name="39203"/>39203:                                    {ok, State#{sock =&gt; Sock}};
<a name="39204"/>39204:                                {error, eafnosupport = Reason} -&gt;
<a name="39205"/>39205:                                    {skip, Reason};
<a name="39206"/>39206:                                {error, _} = ERROR -&gt;
<a name="39207"/>39207:                                    ERROR
<a name="39208"/>39208:                            end
<a name="39209"/>39209:                    end},
<a name="39210"/>39210:          #{desc =&gt; &quot;bind to local address&quot;,
<a name="39211"/>39211:            cmd  =&gt; fun(#{sock := Sock, local_sa := LSA} = _State) -&gt;
<a name="39212"/>39212:                            case sock_bind(Sock, LSA) of
<a name="39213"/>39213:                                ok -&gt;
<a name="39214"/>39214:                                    ok;
<a name="39215"/>39215:                                {error, _} = ERROR -&gt;
<a name="39216"/>39216:                                    ERROR
<a name="39217"/>39217:                            end
<a name="39218"/>39218:                    end},
<a name="39219"/>39219:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="39220"/>39220:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="39221"/>39221:                            ?SEV_ANNOUNCE_READY(Tester, init),
<a name="39222"/>39222:                            ok
<a name="39223"/>39223:                    end},
<a name="39224"/>39224: 
<a name="39225"/>39225:          %% The actual test
<a name="39226"/>39226:          #{desc =&gt; &quot;await continue (connect)&quot;,
<a name="39227"/>39227:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="39228"/>39228:                            ?SEV_AWAIT_CONTINUE(Tester, tester, connect),
<a name="39229"/>39229:                            ok
<a name="39230"/>39230:                    end},
<a name="39231"/>39231:          #{desc =&gt; &quot;connect to server&quot;,
<a name="39232"/>39232:            cmd  =&gt; fun(#{sock := Sock, server_sa := SSA}) -&gt;
<a name="39233"/>39233:                            socket:connect(Sock, SSA)
<a name="39234"/>39234:                    end},
<a name="39235"/>39235:          #{desc =&gt; &quot;announce ready (connect)&quot;,
<a name="39236"/>39236:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="39237"/>39237:                            ?SEV_ANNOUNCE_READY(Tester, connect),
<a name="39238"/>39238:                            ok
<a name="39239"/>39239:                    end},
<a name="39240"/>39240: 
<a name="39241"/>39241:          #{desc =&gt; &quot;await continue (send_and_validate 1)&quot;,
<a name="39242"/>39242:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="39243"/>39243:                            ?SEV_AWAIT_CONTINUE(Tester, tester, send_and_validate)
<a name="39244"/>39244:                    end},
<a name="39245"/>39245:          #{desc =&gt; &quot;send (1)&quot;,
<a name="39246"/>39246:            cmd  =&gt; fun(#{sock := Sock,
<a name="39247"/>39247:                          send := Send} = State) -&gt;
<a name="39248"/>39248:                            Data = ?DATA,
<a name="39249"/>39249:                            case Send(Sock, Data) of
<a name="39250"/>39250:                                ok -&gt;
<a name="39251"/>39251:                                    ?SEV_IPRINT(&quot;sent ~p bytes&quot;, [size(Data)]),
<a name="39252"/>39252:                                    {ok, State#{write_pkg  =&gt; 1,
<a name="39253"/>39253:                                                write_byte =&gt; size(Data)}};
<a name="39254"/>39254:                                {error, _} = ERROR -&gt;
<a name="39255"/>39255:                                    ERROR
<a name="39256"/>39256:                            end
<a name="39257"/>39257:                    end},
<a name="39258"/>39258:          #{desc =&gt; &quot;validate (send 1)&quot;,
<a name="39259"/>39259:            cmd  =&gt; fun(#{sock      := Sock,
<a name="39260"/>39260:                          write_pkg  := SPkg,
<a name="39261"/>39261:                          write_byte := SByte} = _State) -&gt;
<a name="39262"/>39262:                            try socket:info(Sock) of
<a name="39263"/>39263:                                #{counters := Counters} -&gt;
<a name="39264"/>39264:                                    ?SEV_IPRINT(&quot;validate counters: &quot;
<a name="39265"/>39265:                                                &quot;~s&quot;, [format_counters(Counters)]),
<a name="39266"/>39266:                                    traffic_sar_counters_validation(
<a name="39267"/>39267:                                      Counters,
<a name="39268"/>39268:                                      [{write_pkg,     SPkg},
<a name="39269"/>39269:                                       {write_byte,    SByte},
<a name="39270"/>39270:                                       {write_tries,   any},
<a name="39271"/>39271:                                       {write_pkg_max, any}])
<a name="39272"/>39272:                            catch
<a name="39273"/>39273:                                C:E:S -&gt;
<a name="39274"/>39274:                                    ?SEV_EPRINT(&quot;Failed get socket info: &quot;
<a name="39275"/>39275:                                                &quot;~n   Class: ~p&quot;
<a name="39276"/>39276:                                                &quot;~n   Error: ~p&quot;
<a name="39277"/>39277:                                                &quot;~n   Stack: ~p&quot;, [C, E, S]),
<a name="39278"/>39278:                                    {error, {socket_info_failed, {C, E, S}}}
<a name="39279"/>39279:                            end
<a name="39280"/>39280:                    end},
<a name="39281"/>39281:          #{desc =&gt; &quot;announce ready (send_and_validate 1)&quot;,
<a name="39282"/>39282:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="39283"/>39283:                            ?SEV_ANNOUNCE_READY(Tester, send_and_validate),
<a name="39284"/>39284:                            ok
<a name="39285"/>39285:                    end},
<a name="39286"/>39286: 
<a name="39287"/>39287:          #{desc =&gt; &quot;await continue (recv_and_validate 1)&quot;,
<a name="39288"/>39288:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="39289"/>39289:                            ?SEV_AWAIT_CONTINUE(Tester, tester, recv_and_validate)
<a name="39290"/>39290:                    end},
<a name="39291"/>39291:          #{desc =&gt; &quot;recv (1)&quot;,
<a name="39292"/>39292:            cmd  =&gt; fun(#{sock := Sock,
<a name="39293"/>39293:                          recv := Recv} = State) -&gt;
<a name="39294"/>39294:                            case Recv(Sock) of
<a name="39295"/>39295:                                {ok, Data} -&gt;
<a name="39296"/>39296:                                    ?SEV_IPRINT(&quot;recv ~p bytes&quot;, [size(Data)]),
<a name="39297"/>39297:                                    {ok, State#{read_pkg  =&gt; 1,
<a name="39298"/>39298:                                                read_byte =&gt; size(Data)}};
<a name="39299"/>39299:                                {error, _} = ERROR -&gt;
<a name="39300"/>39300:                                    ERROR
<a name="39301"/>39301:                            end
<a name="39302"/>39302:                    end},
<a name="39303"/>39303:          #{desc =&gt; &quot;validate (recv 1)&quot;,
<a name="39304"/>39304:            cmd  =&gt; fun(#{sock       := Sock,
<a name="39305"/>39305:                          read_pkg   := RPkg,
<a name="39306"/>39306:                          read_byte  := RByte,
<a name="39307"/>39307:                          write_pkg  := SPkg,
<a name="39308"/>39308:                          write_byte := SByte} = _State) -&gt;
<a name="39309"/>39309:                            try socket:info(Sock) of
<a name="39310"/>39310:                                #{counters := Counters} -&gt;
<a name="39311"/>39311:                                    ?SEV_IPRINT(&quot;validate counters: &quot;
<a name="39312"/>39312:                                                &quot;~s&quot;, [format_counters(Counters)]),
<a name="39313"/>39313:                                    traffic_sar_counters_validation(
<a name="39314"/>39314:                                      Counters,
<a name="39315"/>39315:                                      [{read_pkg,      RPkg},
<a name="39316"/>39316:                                       {read_byte,     RByte},
<a name="39317"/>39317:                                       {write_pkg,     SPkg},
<a name="39318"/>39318:                                       {write_byte,    SByte},
<a name="39319"/>39319:                                       {read_tries,    any},
<a name="39320"/>39320:                                       {write_tries,   any},
<a name="39321"/>39321:                                       {read_pkg_max,  any},
<a name="39322"/>39322:                                       {write_pkg_max, any}])
<a name="39323"/>39323:                            catch
<a name="39324"/>39324:                                C:E:S -&gt;
<a name="39325"/>39325:                                    ?SEV_EPRINT(&quot;Failed get socket info: &quot;
<a name="39326"/>39326:                                                &quot;~n   Class: ~p&quot;
<a name="39327"/>39327:                                                &quot;~n   Error: ~p&quot;
<a name="39328"/>39328:                                                &quot;~n   Stack: ~p&quot;, [C, E, S]),
<a name="39329"/>39329:                                    {error, {socket_info_failed, {C, E, S}}}
<a name="39330"/>39330:                            end
<a name="39331"/>39331:                    end},
<a name="39332"/>39332:          #{desc =&gt; &quot;announce ready (recv_and_validate 1)&quot;,
<a name="39333"/>39333:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="39334"/>39334:                            ?SEV_ANNOUNCE_READY(Tester, recv_and_validate),
<a name="39335"/>39335:                            ok
<a name="39336"/>39336:                    end},
<a name="39337"/>39337: 
<a name="39338"/>39338:          #{desc =&gt; &quot;await continue (send_and_validate 2)&quot;,
<a name="39339"/>39339:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="39340"/>39340:                            ?SEV_AWAIT_CONTINUE(Tester, tester, send_and_validate)
<a name="39341"/>39341:                    end},
<a name="39342"/>39342:          #{desc =&gt; &quot;send (2)&quot;,
<a name="39343"/>39343:            cmd  =&gt; fun(#{sock       := Sock,
<a name="39344"/>39344:                          send       := Send,
<a name="39345"/>39345:                          write_pkg  := SPkg,
<a name="39346"/>39346:                          write_byte := SByte} = State) -&gt;
<a name="39347"/>39347:                            Data = ?DATA,
<a name="39348"/>39348:                            case Send(Sock, Data) of
<a name="39349"/>39349:                                ok -&gt;
<a name="39350"/>39350:                                    ?SEV_IPRINT(&quot;sent ~p bytes&quot;, [size(Data)]),
<a name="39351"/>39351:                                    {ok, State#{write_pkg  =&gt; SPkg + 1,
<a name="39352"/>39352:                                                write_byte =&gt; SByte + size(Data)}};
<a name="39353"/>39353:                                {error, _} = ERROR -&gt;
<a name="39354"/>39354:                                    ERROR
<a name="39355"/>39355:                            end
<a name="39356"/>39356:                    end},
<a name="39357"/>39357:          #{desc =&gt; &quot;validate (send 2)&quot;,
<a name="39358"/>39358:            cmd  =&gt; fun(#{sock      := Sock,
<a name="39359"/>39359:                          read_pkg  := RPkg,
<a name="39360"/>39360:                          read_byte := RByte,
<a name="39361"/>39361:                          write_pkg  := SPkg,
<a name="39362"/>39362:                          write_byte := SByte} = _State) -&gt;
<a name="39363"/>39363:                            try socket:info(Sock) of
<a name="39364"/>39364:                                #{counters := Counters} -&gt;
<a name="39365"/>39365:                                    ?SEV_IPRINT(&quot;validate counters: &quot;
<a name="39366"/>39366:                                                &quot;~s&quot;, [format_counters(Counters)]),
<a name="39367"/>39367:                                    traffic_sar_counters_validation(
<a name="39368"/>39368:                                      Counters,
<a name="39369"/>39369:                                      [{read_pkg,      RPkg},
<a name="39370"/>39370:                                       {read_byte,     RByte},
<a name="39371"/>39371:                                       {write_pkg,     SPkg},
<a name="39372"/>39372:                                       {write_byte,    SByte},
<a name="39373"/>39373:                                       {read_tries,    any},
<a name="39374"/>39374:                                       {write_tries,   any},
<a name="39375"/>39375:                                       {read_pkg_max,  any},
<a name="39376"/>39376:                                       {write_pkg_max, any}])
<a name="39377"/>39377:                            catch
<a name="39378"/>39378:                                C:E:S -&gt;
<a name="39379"/>39379:                                    ?SEV_EPRINT(&quot;Failed get socket info: &quot;
<a name="39380"/>39380:                                                &quot;~n   Class: ~p&quot;
<a name="39381"/>39381:                                                &quot;~n   Error: ~p&quot;
<a name="39382"/>39382:                                                &quot;~n   Stack: ~p&quot;, [C, E, S]),
<a name="39383"/>39383:                                    {error, {socket_info_failed, {C, E, S}}}
<a name="39384"/>39384:                            end
<a name="39385"/>39385:                    end},
<a name="39386"/>39386:          #{desc =&gt; &quot;announce ready (send_and_validate 2)&quot;,
<a name="39387"/>39387:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="39388"/>39388:                            ?SEV_ANNOUNCE_READY(Tester, send_and_validate),
<a name="39389"/>39389:                            ok
<a name="39390"/>39390:                    end},
<a name="39391"/>39391: 
<a name="39392"/>39392:          #{desc =&gt; &quot;await continue (recv_and_validate 2)&quot;,
<a name="39393"/>39393:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="39394"/>39394:                            ?SEV_AWAIT_CONTINUE(Tester, tester, recv_and_validate)
<a name="39395"/>39395:                    end},
<a name="39396"/>39396:          #{desc =&gt; &quot;recv (2)&quot;,
<a name="39397"/>39397:            cmd  =&gt; fun(#{sock      := Sock,
<a name="39398"/>39398:                          recv      := Recv,
<a name="39399"/>39399:                          read_pkg  := RPkg,
<a name="39400"/>39400:                          read_byte := RByte} = State) -&gt;
<a name="39401"/>39401:                            case Recv(Sock) of
<a name="39402"/>39402:                                {ok, Data} -&gt;
<a name="39403"/>39403:                                    ?SEV_IPRINT(&quot;recv ~p bytes&quot;, [size(Data)]),
<a name="39404"/>39404:                                    {ok, State#{read_pkg  =&gt; RPkg + 1,
<a name="39405"/>39405:                                                read_byte =&gt; RByte + size(Data)}};
<a name="39406"/>39406:                                {error, _} = ERROR -&gt;
<a name="39407"/>39407:                                    ERROR
<a name="39408"/>39408:                            end
<a name="39409"/>39409:                    end},
<a name="39410"/>39410:          #{desc =&gt; &quot;validate (recv 2)&quot;,
<a name="39411"/>39411:            cmd  =&gt; fun(#{sock      := Sock,
<a name="39412"/>39412:                          read_pkg  := RPkg,
<a name="39413"/>39413:                          read_byte := RByte,
<a name="39414"/>39414:                          write_pkg  := SPkg,
<a name="39415"/>39415:                          write_byte := SByte} = _State) -&gt;
<a name="39416"/>39416:                            try socket:info(Sock) of
<a name="39417"/>39417:                                #{counters := Counters} -&gt;
<a name="39418"/>39418:                                    ?SEV_IPRINT(&quot;validate counters: &quot;
<a name="39419"/>39419:                                                &quot;~s&quot;, [format_counters(Counters)]),
<a name="39420"/>39420:                                    traffic_sar_counters_validation(
<a name="39421"/>39421:                                      Counters,
<a name="39422"/>39422:                                      [{read_pkg,      RPkg},
<a name="39423"/>39423:                                       {read_byte,     RByte},
<a name="39424"/>39424:                                       {write_pkg,     SPkg},
<a name="39425"/>39425:                                       {write_byte,    SByte},
<a name="39426"/>39426:                                       {read_tries,    any},
<a name="39427"/>39427:                                       {write_tries,   any},
<a name="39428"/>39428:                                       {read_pkg_max,  any},
<a name="39429"/>39429:                                       {write_pkg_max, any}])
<a name="39430"/>39430:                            catch
<a name="39431"/>39431:                                C:E:S -&gt;
<a name="39432"/>39432:                                    ?SEV_EPRINT(&quot;Failed get socket info: &quot;
<a name="39433"/>39433:                                                &quot;~n   Class: ~p&quot;
<a name="39434"/>39434:                                                &quot;~n   Error: ~p&quot;
<a name="39435"/>39435:                                                &quot;~n   Stack: ~p&quot;, [C, E, S]),
<a name="39436"/>39436:                                    {error, {socket_info_failed, {C, E, S}}}
<a name="39437"/>39437:                            end
<a name="39438"/>39438:                    end},
<a name="39439"/>39439:          #{desc =&gt; &quot;announce ready (recv_and_validate 2)&quot;,
<a name="39440"/>39440:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="39441"/>39441:                            ?SEV_ANNOUNCE_READY(Tester, recv_and_validate),
<a name="39442"/>39442:                            ok
<a name="39443"/>39443:                    end},
<a name="39444"/>39444: 
<a name="39445"/>39445:          %% Termination
<a name="39446"/>39446:          #{desc =&gt; &quot;await terminate (from tester)&quot;,
<a name="39447"/>39447:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="39448"/>39448:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="39449"/>39449:                                ok -&gt;
<a name="39450"/>39450:                                    {ok, maps:remove(tester, State)};
<a name="39451"/>39451:                                {error, _} = ERROR -&gt;
<a name="39452"/>39452:                                    ERROR
<a name="39453"/>39453:                            end
<a name="39454"/>39454:                    end},
<a name="39455"/>39455:          #{desc =&gt; &quot;close connection socket&quot;,
<a name="39456"/>39456:            cmd  =&gt; fun(#{domain   := local,
<a name="39457"/>39457:                          sock     := Sock,
<a name="39458"/>39458:                          local_sa := #{path := Path}} = State) -&gt;
<a name="39459"/>39459:                            ok = socket:close(Sock),
<a name="39460"/>39460:                            State1 =
<a name="39461"/>39461:                                unlink_path(Path,
<a name="39462"/>39462:                                            fun() -&gt;
<a name="39463"/>39463:                                                    maps:remove(local_sa, State)
<a name="39464"/>39464:                                            end,
<a name="39465"/>39465:                                            fun() -&gt; State end),
<a name="39466"/>39466:                            {ok, maps:remove(sock, State1)};
<a name="39467"/>39467:                       (#{sock := Sock} = State) -&gt;
<a name="39468"/>39468:                            socket:close(Sock),
<a name="39469"/>39469:                            {ok, maps:remove(sock, State)}
<a name="39470"/>39470:                    end},
<a name="39471"/>39471: 
<a name="39472"/>39472:          %% *** We are done ***
<a name="39473"/>39473:          ?SEV_FINISH_NORMAL
<a name="39474"/>39474:         ],
<a name="39475"/>39475: 
<a name="39476"/>39476: 
<a name="39477"/>39477:     TesterSeq =
<a name="39478"/>39478:         [
<a name="39479"/>39479:          %% *** Init part ***
<a name="39480"/>39480:          #{desc =&gt; &quot;monitor server&quot;,
<a name="39481"/>39481:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="39482"/>39482:                            _MRef = erlang:monitor(process, Pid),
<a name="39483"/>39483:                            ok
<a name="39484"/>39484:                    end},
<a name="39485"/>39485:          #{desc =&gt; &quot;monitor client&quot;,
<a name="39486"/>39486:            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;
<a name="39487"/>39487:                            _MRef = erlang:monitor(process, Pid),
<a name="39488"/>39488:                            ok
<a name="39489"/>39489:                    end},
<a name="39490"/>39490: 
<a name="39491"/>39491:          %% Start the server
<a name="39492"/>39492:          #{desc =&gt; &quot;order server start&quot;,
<a name="39493"/>39493:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="39494"/>39494:                            ?SEV_ANNOUNCE_START(Pid),
<a name="39495"/>39495:                            ok
<a name="39496"/>39496:                    end},
<a name="39497"/>39497:          #{desc =&gt; &quot;await server ready (init)&quot;,
<a name="39498"/>39498:            cmd  =&gt; fun(#{domain := local,
<a name="39499"/>39499:                          server := Pid} = State) -&gt;
<a name="39500"/>39500:                            {ok, Path} = ?SEV_AWAIT_READY(Pid, server, init),
<a name="39501"/>39501:                            {ok, State#{path =&gt; Path}};
<a name="39502"/>39502:                       (#{server := Pid} = State) -&gt;
<a name="39503"/>39503:                            {ok, Port} = ?SEV_AWAIT_READY(Pid, server, init),
<a name="39504"/>39504:                            {ok, State#{port =&gt; Port}}
<a name="39505"/>39505:                    end},
<a name="39506"/>39506: 
<a name="39507"/>39507:          %% Start the client
<a name="39508"/>39508:          #{desc =&gt; &quot;order client start&quot;,
<a name="39509"/>39509:            cmd  =&gt; fun(#{domain := local,
<a name="39510"/>39510:                          client := Pid,
<a name="39511"/>39511:                          path   := Path} = _State) -&gt;
<a name="39512"/>39512:                            ?SEV_ANNOUNCE_START(Pid, Path),
<a name="39513"/>39513:                            ok;
<a name="39514"/>39514:                       (#{client := Pid,
<a name="39515"/>39515:                          port   := Port} = _State) -&gt;
<a name="39516"/>39516:                            ?SEV_ANNOUNCE_START(Pid, Port),
<a name="39517"/>39517:                            ok
<a name="39518"/>39518:                    end},
<a name="39519"/>39519:          #{desc =&gt; &quot;await client ready (init)&quot;,
<a name="39520"/>39520:            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;
<a name="39521"/>39521:                            ok = ?SEV_AWAIT_READY(Pid, client, init)
<a name="39522"/>39522:                    end},
<a name="39523"/>39523: 
<a name="39524"/>39524:          %% *** The actual test ***
<a name="39525"/>39525: 
<a name="39526"/>39526:          #{desc =&gt; &quot;order server to continue (with accept)&quot;,
<a name="39527"/>39527:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="39528"/>39528:                            ?SEV_ANNOUNCE_CONTINUE(Server, accept),
<a name="39529"/>39529:                            ok
<a name="39530"/>39530:                    end},
<a name="39531"/>39531: 
<a name="39532"/>39532:          ?SEV_SLEEP(?SECS(1)),
<a name="39533"/>39533: 
<a name="39534"/>39534:          #{desc =&gt; &quot;order client to continue (with connect)&quot;,
<a name="39535"/>39535:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="39536"/>39536:                            ?SEV_ANNOUNCE_CONTINUE(Client, connect),
<a name="39537"/>39537:                            ok
<a name="39538"/>39538:                    end},
<a name="39539"/>39539:          #{desc =&gt; &quot;await client ready (connect)&quot;,
<a name="39540"/>39540:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="39541"/>39541:                            ?SEV_AWAIT_READY(Client, client, connect)
<a name="39542"/>39542:                    end},
<a name="39543"/>39543:          #{desc =&gt; &quot;await server ready (accept)&quot;,
<a name="39544"/>39544:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="39545"/>39545:                            ?SEV_AWAIT_READY(Server, server, accept)
<a name="39546"/>39546:                    end},
<a name="39547"/>39547: 
<a name="39548"/>39548:          ?SEV_SLEEP(?SECS(1)),
<a name="39549"/>39549: 
<a name="39550"/>39550:          #{desc =&gt; &quot;order server to continue (recv_and_validate 1)&quot;,
<a name="39551"/>39551:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="39552"/>39552:                            ?SEV_ANNOUNCE_CONTINUE(Server, recv_and_validate),
<a name="39553"/>39553:                            ok
<a name="39554"/>39554:                    end},
<a name="39555"/>39555:          #{desc =&gt; &quot;order client to continue (send_and_validate 1)&quot;,
<a name="39556"/>39556:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="39557"/>39557:                            ?SEV_ANNOUNCE_CONTINUE(Client, send_and_validate),
<a name="39558"/>39558:                            ok
<a name="39559"/>39559:                    end},
<a name="39560"/>39560:          #{desc =&gt; &quot;await client ready (send_and_validate 1)&quot;,
<a name="39561"/>39561:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="39562"/>39562:                            ?SEV_AWAIT_READY(Client, client, send_and_validate)
<a name="39563"/>39563:                    end},
<a name="39564"/>39564:          #{desc =&gt; &quot;await server ready (recv_and_validate 1)&quot;,
<a name="39565"/>39565:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="39566"/>39566:                            ?SEV_AWAIT_READY(Server, server, recv_and_validate)
<a name="39567"/>39567:                    end},
<a name="39568"/>39568: 
<a name="39569"/>39569:          ?SEV_SLEEP(?SECS(1)),
<a name="39570"/>39570: 
<a name="39571"/>39571:          #{desc =&gt; &quot;order client to continue (recv_and_validate 1)&quot;,
<a name="39572"/>39572:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="39573"/>39573:                            ?SEV_ANNOUNCE_CONTINUE(Client, recv_and_validate),
<a name="39574"/>39574:                            ok
<a name="39575"/>39575:                    end},
<a name="39576"/>39576:          #{desc =&gt; &quot;order server to continue (send_and_validate 1)&quot;,
<a name="39577"/>39577:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="39578"/>39578:                            ?SEV_ANNOUNCE_CONTINUE(Server, send_and_validate),
<a name="39579"/>39579:                            ok
<a name="39580"/>39580:                    end},
<a name="39581"/>39581:          #{desc =&gt; &quot;await server ready (send_and_validate 1)&quot;,
<a name="39582"/>39582:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="39583"/>39583:                            ?SEV_AWAIT_READY(Server, server, send_and_validate)
<a name="39584"/>39584:                    end},
<a name="39585"/>39585:          #{desc =&gt; &quot;await client ready (recv_and_validate 1)&quot;,
<a name="39586"/>39586:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="39587"/>39587:                            ?SEV_AWAIT_READY(Client, client, recv_and_validate)
<a name="39588"/>39588:                    end},
<a name="39589"/>39589: 
<a name="39590"/>39590:          ?SEV_SLEEP(?SECS(1)),
<a name="39591"/>39591: 
<a name="39592"/>39592:          #{desc =&gt; &quot;order server to continue (recv_and_validate 2)&quot;,
<a name="39593"/>39593:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="39594"/>39594:                            ?SEV_ANNOUNCE_CONTINUE(Server, recv_and_validate),
<a name="39595"/>39595:                            ok
<a name="39596"/>39596:                    end},
<a name="39597"/>39597:          #{desc =&gt; &quot;order client to continue (send_and_validate 2)&quot;,
<a name="39598"/>39598:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="39599"/>39599:                            ?SEV_ANNOUNCE_CONTINUE(Client, send_and_validate),
<a name="39600"/>39600:                            ok
<a name="39601"/>39601:                    end},
<a name="39602"/>39602:          #{desc =&gt; &quot;await client ready (send_and_validate 2)&quot;,
<a name="39603"/>39603:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="39604"/>39604:                            ?SEV_AWAIT_READY(Client, client, send_and_validate)
<a name="39605"/>39605:                    end},
<a name="39606"/>39606:          #{desc =&gt; &quot;await server ready (recv_and_validate 2)&quot;,
<a name="39607"/>39607:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="39608"/>39608:                            ?SEV_AWAIT_READY(Server, server, recv_and_validate)
<a name="39609"/>39609:                    end},
<a name="39610"/>39610: 
<a name="39611"/>39611:          ?SEV_SLEEP(?SECS(1)),
<a name="39612"/>39612: 
<a name="39613"/>39613:          #{desc =&gt; &quot;order client to continue (recv_and_validate 2)&quot;,
<a name="39614"/>39614:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="39615"/>39615:                            ?SEV_ANNOUNCE_CONTINUE(Client, recv_and_validate),
<a name="39616"/>39616:                            ok
<a name="39617"/>39617:                    end},
<a name="39618"/>39618:          #{desc =&gt; &quot;order server to continue (send_and_validate 2)&quot;,
<a name="39619"/>39619:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="39620"/>39620:                            ?SEV_ANNOUNCE_CONTINUE(Server, send_and_validate),
<a name="39621"/>39621:                            ok
<a name="39622"/>39622:                    end},
<a name="39623"/>39623:          #{desc =&gt; &quot;await server ready (send_and_validate 2)&quot;,
<a name="39624"/>39624:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="39625"/>39625:                            ?SEV_AWAIT_READY(Server, server, send_and_validate)
<a name="39626"/>39626:                    end},
<a name="39627"/>39627:          #{desc =&gt; &quot;await client ready (recv_and_validate 2)&quot;,
<a name="39628"/>39628:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="39629"/>39629:                            ?SEV_AWAIT_READY(Client, client, recv_and_validate)
<a name="39630"/>39630:                    end},
<a name="39631"/>39631: 
<a name="39632"/>39632:          %% *** Termination ***
<a name="39633"/>39633:          #{desc =&gt; &quot;order client to terminate&quot;,
<a name="39634"/>39634:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="39635"/>39635:                            ?SEV_ANNOUNCE_TERMINATE(Client),
<a name="39636"/>39636:                            ok
<a name="39637"/>39637:                    end},
<a name="39638"/>39638:          #{desc =&gt; &quot;await client termination&quot;,
<a name="39639"/>39639:            cmd  =&gt; fun(#{client := Client} = State) -&gt;
<a name="39640"/>39640:                            ?SEV_AWAIT_TERMINATION(Client),
<a name="39641"/>39641:                            State1 = maps:remove(client, State),
<a name="39642"/>39642:                            {ok, State1}
<a name="39643"/>39643:                    end},
<a name="39644"/>39644:          #{desc =&gt; &quot;order server to terminate&quot;,
<a name="39645"/>39645:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="39646"/>39646:                            ?SEV_ANNOUNCE_TERMINATE(Server),
<a name="39647"/>39647:                            ok
<a name="39648"/>39648:                    end},
<a name="39649"/>39649:          #{desc =&gt; &quot;await server termination&quot;,
<a name="39650"/>39650:            cmd  =&gt; fun(#{server := Server} = State) -&gt;
<a name="39651"/>39651:                            ?SEV_AWAIT_TERMINATION(Server),
<a name="39652"/>39652:                            State1 = maps:remove(server, State),
<a name="39653"/>39653:                            {ok, State1}
<a name="39654"/>39654:                    end},
<a name="39655"/>39655: 
<a name="39656"/>39656:          %% *** We are done ***
<a name="39657"/>39657:          ?SEV_FINISH_NORMAL
<a name="39658"/>39658:         ],
<a name="39659"/>39659: 
<a name="39660"/>39660:     i(&quot;start server evaluator&quot;),
<a name="39661"/>39661:     ServerInitState = InitState#{host =&gt; local_host()},
<a name="39662"/>39662:     Server = ?SEV_START(&quot;server&quot;, ServerSeq, ServerInitState),
<a name="39663"/>39663: 
<a name="39664"/>39664:     i(&quot;start client evaluator(s)&quot;),
<a name="39665"/>39665:     ClientInitState = InitState#{host =&gt; local_host()},
<a name="39666"/>39666:     Client = ?SEV_START(&quot;client&quot;, ClientSeq, ClientInitState),
<a name="39667"/>39667: 
<a name="39668"/>39668:     i(&quot;start 'tester' evaluator&quot;),
<a name="39669"/>39669:     TesterInitState = #{server =&gt; Server#ev.pid,
<a name="39670"/>39670:                         client =&gt; Client#ev.pid},
<a name="39671"/>39671:     Tester = ?SEV_START(&quot;tester&quot;, TesterSeq, TesterInitState),
<a name="39672"/>39672: 
<a name="39673"/>39673:     i(&quot;await evaluator&quot;),
<a name="traffic_send_and_recv_tcp-last_expr"/><a name="39674"/>39674: <b>    ok = ?SEV_AWAIT_FINISH</b>([Server, Client, Tester]).
<a name="39675"/>39675: 
<a name="39676"/>39676: 
<a name="format_counters-1"/><a name="39677"/>39677: <b>format_counters</b>(Counters) -&gt;
<a name="format_counters-last_expr"/><a name="39678"/>39678: <b>    format_counters</b>(traffic, Counters).
<a name="39679"/>39679: 
<a name="format_counters-2"/><a name="39680"/>39680: <b>format_counters</b>(Type, Counters) when (Type =:= listen) orelse (Type =:= traffic) -&gt;
<a name="format_counters-last_expr"/><a name="39681"/>39681: <b>    format_counters</b>(&quot;   &quot;, Type, Counters).
<a name="39682"/>39682: 
<a name="format_counters-3"/><a name="39683"/>39683: <b>format_counters</b>(Prefix, traffic, Counters) -&gt;
<a name="39684"/>39684:     ReadByte    = maps:get(read_byte,     Counters, -1),
<a name="39685"/>39685:     ReadFails   = maps:get(read_fails,    Counters, -1),
<a name="39686"/>39686:     ReadPkg     = maps:get(read_pkg,      Counters, -1),
<a name="39687"/>39687:     ReadPkgMax  = maps:get(read_pkg_max,  Counters, -1),
<a name="39688"/>39688:     ReadTries   = maps:get(read_tries,    Counters, -1),
<a name="39689"/>39689:     ReadWaits   = maps:get(read_waits,    Counters, -1),
<a name="39690"/>39690:     WriteByte   = maps:get(write_byte,    Counters, -1),
<a name="39691"/>39691:     WriteFails  = maps:get(write_fails,   Counters, -1),
<a name="39692"/>39692:     WritePkg    = maps:get(write_pkg,     Counters, -1),
<a name="39693"/>39693:     WritePkgMax = maps:get(write_pkg_max, Counters, -1),
<a name="39694"/>39694:     WriteTries  = maps:get(write_tries,   Counters, -1),
<a name="39695"/>39695:     WriteWaits  = maps:get(write_waits,   Counters, -1),
<a name="39696"/>39696:     f(&quot;~n~sNumber Of Read Bytes:     ~p&quot;
<a name="39697"/>39697:       &quot;~n~sNumber Of Read Fails:     ~p&quot;
<a name="39698"/>39698:       &quot;~n~sNumber Of Read Packages:  ~p&quot;
<a name="39699"/>39699:       &quot;~n~sNumber Of Read Tries:     ~p&quot;
<a name="39700"/>39700:       &quot;~n~sNumber Of Read Waits:     ~p&quot;
<a name="39701"/>39701:       &quot;~n~sMax Read Package Size:    ~p&quot;
<a name="39702"/>39702:       &quot;~n~sNumber Of Write Bytes:    ~p&quot;
<a name="39703"/>39703:       &quot;~n~sNumber Of Write Fails:    ~p&quot;
<a name="39704"/>39704:       &quot;~n~sNumber Of Write Packages: ~p&quot;
<a name="39705"/>39705:       &quot;~n~sNumber Of Write Tries:    ~p&quot;
<a name="39706"/>39706:       &quot;~n~sNumber Of Write Waits:    ~p&quot;
<a name="39707"/>39707:       &quot;~n~sMax Write Package Size:   ~p&quot;,
<a name="39708"/>39708:       [Prefix, ReadByte,
<a name="39709"/>39709:        Prefix, ReadFails,
<a name="39710"/>39710:        Prefix, ReadPkg,
<a name="39711"/>39711:        Prefix, ReadTries,
<a name="39712"/>39712:        Prefix, ReadWaits,
<a name="39713"/>39713:        Prefix, ReadPkgMax,
<a name="39714"/>39714:        Prefix, WriteByte,
<a name="39715"/>39715:        Prefix, WriteFails,
<a name="39716"/>39716:        Prefix, WritePkg,
<a name="39717"/>39717:        Prefix, WriteTries,
<a name="39718"/>39718:        Prefix, WriteWaits,
<a name="39719"/>39719:        Prefix, WritePkgMax]);
<a name="39720"/>39720: 
<a name="39721"/>39721: <b>format_counters</b>(Prefix, listen, Counters) -&gt;
<a name="39722"/>39722:     AccSuccess = maps:get(acc_success, Counters, -1),
<a name="39723"/>39723:     AccFails   = maps:get(acc_fails,   Counters, -1),
<a name="39724"/>39724:     AccTries   = maps:get(acc_tries,   Counters, -1),
<a name="39725"/>39725:     AccWaits   = maps:get(acc_waits,   Counters, -1),
<a name="format_counters-last_expr"/><a name="39726"/>39726: <b>    f</b>(&quot;~n~sNumber Of Successful Accepts: ~p&quot;
<a name="39727"/>39727:       &quot;~n~sNumber Of Failed Accepts:     ~p&quot;
<a name="39728"/>39728:       &quot;~n~sNumber Of Accept Attempts:    ~p&quot;
<a name="39729"/>39729:       &quot;~n~sNumber Of Accept Waits:       ~p&quot;,
<a name="39730"/>39730:       [Prefix, AccSuccess,
<a name="39731"/>39731:        Prefix, AccFails,
<a name="39732"/>39732:        Prefix, AccTries,
<a name="39733"/>39733:        Prefix, AccWaits]).
<a name="39734"/>39734: 
<a name="all_counters-0"/><a name="39735"/>39735: <b>all_counters</b>() -&gt;
<a name="all_counters-last_expr"/><a name="39736"/>39736:     [
<a name="39737"/>39737:      read_byte,
<a name="39738"/>39738:      read_fails,
<a name="39739"/>39739:      read_pkg,
<a name="39740"/>39740:      read_pkg_max,
<a name="39741"/>39741:      read_tries,
<a name="39742"/>39742:      read_waits,
<a name="39743"/>39743:      write_byte,
<a name="39744"/>39744:      write_fails,
<a name="39745"/>39745:      write_pkg,
<a name="39746"/>39746:      write_pkg_max,
<a name="39747"/>39747:      write_tries,
<a name="39748"/>39748:      write_waits,
<a name="39749"/>39749:      acc_success,
<a name="39750"/>39750:      acc_fails,
<a name="39751"/>39751:      acc_tries,
<a name="39752"/>39752:      acc_waits
<a name="39753"/>39753:     ].
<a name="39754"/>39754: 
<a name="zero_counters-0"/><a name="39755"/>39755: <b>zero_counters</b>() -&gt;
<a name="zero_counters-last_expr"/><a name="39756"/>39756: <b>    [{Cnt, 0} || Cnt &lt;- all_counters</b>()].
<a name="39757"/>39757: 
<a name="any_counters-0"/><a name="39758"/>39758: <b>any_counters</b>() -&gt;
<a name="any_counters-last_expr"/><a name="39759"/>39759: <b>    [{Cnt, any} || Cnt &lt;- all_counters</b>()].
<a name="39760"/>39760: 
<a name="39761"/>39761: 
<a name="39762"/>39762: <i>%% This function ensures that we have a list of &quot;validate counters&quot;</i>
<a name="39763"/>39763: <i>%% that have an entry for each existing counter.</i>
<a name="39764"/>39764: 
<a name="ensure_counters-1"/><a name="39765"/>39765: <b>ensure_counters</b>(Counters) -&gt;
<a name="ensure_counters-last_expr"/><a name="39766"/>39766: <b>    ensure_counters</b>(any_counters(), Counters, []).
<a name="39767"/>39767: 
<a name="ensure_counters-3"/><a name="39768"/>39768: <b>ensure_counters</b>([], [], Acc) -&gt;
<a name="39769"/>39769:     lists:reverse(Acc);
<a name="39770"/>39770: <b>ensure_counters</b>([{Cnt, Val}|DefCounters], Counters, Acc) -&gt;
<a name="ensure_counters-last_expr"/><a name="39771"/>39771: <b>    case lists:keysearch</b>(Cnt, 1, Counters) of
<a name="39772"/>39772:         {value, {Cnt, _} = T} -&gt;
<a name="39773"/>39773:             Counters2 = lists:keydelete(Cnt, 1, Counters),
<a name="39774"/>39774:             ensure_counters(DefCounters, Counters2, [T|Acc]);
<a name="39775"/>39775:         false -&gt;
<a name="39776"/>39776:             ensure_counters(DefCounters, Counters, [{Cnt, Val}|Acc])
<a name="39777"/>39777:     end.
<a name="39778"/>39778: 
<a name="traffic_sar_counters_validation-1"/><a name="39779"/>39779: <b>traffic_sar_counters_validation</b>(Counters) -&gt;
<a name="39780"/>39780:     %% ?SEV_IPRINT(&quot;traffic_sar_counters_validation -&gt; entry with&quot;
<a name="39781"/>39781:     %%             &quot;~n   Counters: ~p&quot;, [Counters]),
<a name="traffic_sar_counters_validation-last_expr"/><a name="39782"/>39782: <b>    traffic_sar_counters_validation2</b>(maps:to_list(Counters),
<a name="39783"/>39783:                                      zero_counters()).
<a name="39784"/>39784: 
<a name="traffic_sar_counters_validation-2"/><a name="39785"/>39785: <b>traffic_sar_counters_validation</b>(Counters, ValidateCounters) -&gt;
<a name="39786"/>39786:     %% ?SEV_IPRINT(&quot;traffic_sar_counters_validation -&gt; entry with&quot;
<a name="39787"/>39787:     %%             &quot;~n   Counters:          ~p&quot;
<a name="39788"/>39788:     %%             &quot;~n   Validate Counters: ~p&quot;, [Counters, ValidateCounters]),
<a name="traffic_sar_counters_validation-last_expr"/><a name="39789"/>39789: <b>    traffic_sar_counters_validation2</b>(maps:to_list(Counters),
<a name="39790"/>39790:                                      ensure_counters(ValidateCounters)).
<a name="39791"/>39791: 
<a name="traffic_sar_counters_validation2-2"/><a name="39792"/>39792: <b>traffic_sar_counters_validation2</b>(Counters, []) -&gt;
<a name="39793"/>39793:     %% ?SEV_IPRINT(&quot;traffic_sar_counters_validation2 -&gt; Remaining Counters: &quot;
<a name="39794"/>39794:     %%             &quot;~n   ~p&quot;, [Counters]),
<a name="39795"/>39795:     (catch lists:foreach(
<a name="39796"/>39796:              fun({_Cnt, 0})   -&gt; ok;
<a name="39797"/>39797:                 ({Cnt,  Val}) -&gt;
<a name="39798"/>39798:                      throw({error, {invalid_counter, Cnt, Val}})
<a name="39799"/>39799:              end,
<a name="39800"/>39800:              Counters));
<a name="39801"/>39801: <b>traffic_sar_counters_validation2</b>(Counters, [{Cnt, Val}|ValidateCounters]) -&gt;
<a name="39802"/>39802:     %% ?SEV_IPRINT(&quot;traffic_sar_counters_validation2 -&gt; try validate ~w when&quot;
<a name="39803"/>39803:     %%             &quot;~n   Counters:         ~p&quot;
<a name="39804"/>39804:     %%             &quot;~n   ValidateCounters: ~p&quot;, [Cnt, Counters, ValidateCounters]),
<a name="traffic_sar_counters_validation2-last_expr"/><a name="39805"/>39805: <b>    case lists:keysearch</b>(Cnt, 1, Counters) of
<a name="39806"/>39806:         {value, {Cnt, Val}} -&gt;
<a name="39807"/>39807:             %% ?SEV_IPRINT(&quot;traffic_sar_counters_validation2 -&gt; ~w validated&quot;, [Cnt]),
<a name="39808"/>39808:             Counters2 = lists:keydelete(Cnt, 1, Counters),
<a name="39809"/>39809:             traffic_sar_counters_validation2(Counters2, ValidateCounters);
<a name="39810"/>39810:         {value, {Cnt, _Val}} when (Val =:= any) -&gt;
<a name="39811"/>39811:             %% ?SEV_IPRINT(&quot;traffic_sar_counters_validation2 -&gt; &quot;
<a name="39812"/>39812:             %%             &quot;~w validated (any) when&quot;
<a name="39813"/>39813:             %%             &quot;~n   Counters: ~p&quot;, [Cnt, Counters]),
<a name="39814"/>39814:             Counters2 = lists:keydelete(Cnt, 1, Counters),
<a name="39815"/>39815:             traffic_sar_counters_validation2(Counters2, ValidateCounters);
<a name="39816"/>39816:         {value, {Cnt, InvVal}} -&gt;
<a name="39817"/>39817:             ?SEV_EPRINT(&quot;traffic_sar_counters_validation2 -&gt; &quot;
<a name="39818"/>39818:                         &quot;~w validation failed: &quot;
<a name="39819"/>39819:                         &quot;~n   Expected Value: ~p&quot;
<a name="39820"/>39820:                         &quot;~n   Actual Value:   ~p&quot;, [Cnt, Val, InvVal]),
<a name="39821"/>39821:             {error, {invalid_counter, Cnt, InvVal, Val}};
<a name="39822"/>39822:         false -&gt;
<a name="39823"/>39823:             ?SEV_EPRINT(&quot;traffic_sar_counters_validation2 -&gt; &quot;
<a name="39824"/>39824:                         &quot;~w validation failed: Unknown&quot;, [Cnt]),
<a name="39825"/>39825:             {error, {unknown_counter, Cnt, Counters}}
<a name="39826"/>39826:     end.
<a name="39827"/>39827: 
<a name="39828"/>39828:                           
<a name="39829"/>39829: 
<a name="39830"/>39830: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="39831"/>39831: <i>%% This test case is intended to (simply) test the counters</i>
<a name="39832"/>39832: <i>%% for both read and write.</i>
<a name="39833"/>39833: <i>%% So that its easy to extend, we use fun's for read and write.</i>
<a name="39834"/>39834: <i>%% We use UDP on IPv4.</i>
<a name="39835"/>39835: 
<a name="traffic_sendto_and_recvfrom_counters_udp4-1"/><a name="39836"/>39836: <b>traffic_sendto_and_recvfrom_counters_udp4</b>(_Config) when is_list(_Config) -&gt;
<a name="39837"/>39837:     ?TT(?SECS(15)),
<a name="traffic_sendto_and_recvfrom_counters_udp4-last_expr"/><a name="39838"/>39838: <b>    tc_try</b>(traffic_sendto_and_recvfrom_counters_udp4,
<a name="39839"/>39839:            fun() -&gt; has_support_ipv4() end,
<a name="39840"/>39840:            fun() -&gt;
<a name="39841"/>39841:                    InitState = #{domain =&gt; inet,
<a name="39842"/>39842:                                  proto  =&gt; udp,
<a name="39843"/>39843:                                  recv   =&gt; fun(S) -&gt;
<a name="39844"/>39844:                                                    socket:recvfrom(S)
<a name="39845"/>39845:                                            end,
<a name="39846"/>39846:                                  send   =&gt; fun(S, Data, Dest) -&gt;
<a name="39847"/>39847:                                                    socket:sendto(S, Data, Dest)
<a name="39848"/>39848:                                            end},
<a name="39849"/>39849:                    ok = traffic_send_and_recv_udp(InitState)
<a name="39850"/>39850:            end).
<a name="39851"/>39851: 
<a name="39852"/>39852: 
<a name="39853"/>39853: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="39854"/>39854: <i>%% This test case is intended to (simply) test the counters</i>
<a name="39855"/>39855: <i>%% for both read and write.</i>
<a name="39856"/>39856: <i>%% So that its easy to extend, we use fun's for read and write.</i>
<a name="39857"/>39857: <i>%% We use UDP on IPv6.</i>
<a name="39858"/>39858: 
<a name="traffic_sendto_and_recvfrom_counters_udp6-1"/><a name="39859"/>39859: <b>traffic_sendto_and_recvfrom_counters_udp6</b>(_Config) when is_list(_Config) -&gt;
<a name="39860"/>39860:     ?TT(?SECS(15)),
<a name="traffic_sendto_and_recvfrom_counters_udp6-last_expr"/><a name="39861"/>39861: <b>    tc_try</b>(traffic_sendto_and_recvfrom_counters_udp6,
<a name="39862"/>39862:            fun() -&gt; has_support_ipv6() end,
<a name="39863"/>39863:            fun() -&gt;
<a name="39864"/>39864:                    InitState = #{domain =&gt; inet6,
<a name="39865"/>39865:                                  proto  =&gt; udp,
<a name="39866"/>39866:                                  recv   =&gt; fun(S) -&gt;
<a name="39867"/>39867:                                                    socket:recvfrom(S)
<a name="39868"/>39868:                                            end,
<a name="39869"/>39869:                                  send   =&gt; fun(S, Data, Dest) -&gt;
<a name="39870"/>39870:                                                    socket:sendto(S, Data, Dest)
<a name="39871"/>39871:                                            end},
<a name="39872"/>39872:                    ok = traffic_send_and_recv_udp(InitState)
<a name="39873"/>39873:            end).
<a name="39874"/>39874: 
<a name="39875"/>39875: 
<a name="39876"/>39876: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="39877"/>39877: <i>%% This test case is intended to (simply) test the counters</i>
<a name="39878"/>39878: <i>%% for both read and write.</i>
<a name="39879"/>39879: <i>%% So that its easy to extend, we use fun's for read and write.</i>
<a name="39880"/>39880: <i>%% We use default (UDP) on local.</i>
<a name="39881"/>39881: 
<a name="traffic_sendto_and_recvfrom_counters_udpL-1"/><a name="39882"/>39882: <b>traffic_sendto_and_recvfrom_counters_udpL</b>(_Config) when is_list(_Config) -&gt;
<a name="39883"/>39883:     ?TT(?SECS(15)),
<a name="traffic_sendto_and_recvfrom_counters_udpL-last_expr"/><a name="39884"/>39884: <b>    tc_try</b>(traffic_sendto_and_recvfrom_counters_udp4,
<a name="39885"/>39885:            fun() -&gt;
<a name="39886"/>39886: 		   has_support_unix_domain_socket(),
<a name="39887"/>39887: 		   is_not_windows()
<a name="39888"/>39888: 	   end,
<a name="39889"/>39889:            fun() -&gt;
<a name="39890"/>39890:                    InitState = #{domain =&gt; local,
<a name="39891"/>39891:                                  proto  =&gt; default,
<a name="39892"/>39892:                                  recv   =&gt; fun(S) -&gt;
<a name="39893"/>39893:                                                    socket:recvfrom(S)
<a name="39894"/>39894:                                            end,
<a name="39895"/>39895:                                  send   =&gt; fun(S, Data, Dest) -&gt;
<a name="39896"/>39896:                                                    socket:sendto(S, Data, Dest)
<a name="39897"/>39897:                                            end},
<a name="39898"/>39898:                    ok = traffic_send_and_recv_udp(InitState)
<a name="39899"/>39899:            end).
<a name="39900"/>39900: 
<a name="39901"/>39901: 
<a name="39902"/>39902: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="39903"/>39903: <i>%% This test case is intended to (simply) test the counters</i>
<a name="39904"/>39904: <i>%% for both read and write.</i>
<a name="39905"/>39905: <i>%% So that its easy to extend, we use fun's for read and write.</i>
<a name="39906"/>39906: <i>%% We use UDP on IPv4.</i>
<a name="39907"/>39907: 
<a name="traffic_sendmsg_and_recvmsg_counters_udp4-1"/><a name="39908"/>39908: <b>traffic_sendmsg_and_recvmsg_counters_udp4</b>(_Config) when is_list(_Config) -&gt;
<a name="39909"/>39909:     ?TT(?SECS(15)),
<a name="traffic_sendmsg_and_recvmsg_counters_udp4-last_expr"/><a name="39910"/>39910: <b>    tc_try</b>(traffic_sendmsg_and_recvmsg_counters_udp4,
<a name="39911"/>39911:            fun() -&gt; has_support_ipv4() end,
<a name="39912"/>39912:            fun() -&gt;
<a name="39913"/>39913:                    InitState = #{domain =&gt; inet,
<a name="39914"/>39914:                                  proto  =&gt; udp,
<a name="39915"/>39915:                                  recv   =&gt; fun(S) -&gt;
<a name="39916"/>39916:                                                    case socket:recvmsg(S) of
<a name="39917"/>39917:                                                        {ok, #{addr  := Source,
<a name="39918"/>39918:                                                               iov   := [Data]}} -&gt;
<a name="39919"/>39919:                                                            {ok, {Source, Data}};
<a name="39920"/>39920:                                                        {error, _} = ERROR -&gt;
<a name="39921"/>39921:                                                            ERROR
<a name="39922"/>39922:                                                    end
<a name="39923"/>39923:                                            end,
<a name="39924"/>39924:                                  send   =&gt; fun(S, Data, Dest) -&gt;
<a name="39925"/>39925:                                                    Msg = #{addr =&gt; Dest,
<a name="39926"/>39926:                                                               iov  =&gt; [Data]},
<a name="39927"/>39927:                                                    socket:sendmsg(S, Msg)
<a name="39928"/>39928:                                            end},
<a name="39929"/>39929:                    ok = traffic_send_and_recv_udp(InitState)
<a name="39930"/>39930:            end).
<a name="39931"/>39931: 
<a name="39932"/>39932: 
<a name="39933"/>39933: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="39934"/>39934: <i>%% This test case is intended to (simply) test the counters</i>
<a name="39935"/>39935: <i>%% for both read and write.</i>
<a name="39936"/>39936: <i>%% So that its easy to extend, we use fun's for read and write.</i>
<a name="39937"/>39937: <i>%% We use UDP on IPv6.</i>
<a name="39938"/>39938: 
<a name="traffic_sendmsg_and_recvmsg_counters_udp6-1"/><a name="39939"/>39939: <b>traffic_sendmsg_and_recvmsg_counters_udp6</b>(_Config) when is_list(_Config) -&gt;
<a name="39940"/>39940:     ?TT(?SECS(15)),
<a name="traffic_sendmsg_and_recvmsg_counters_udp6-last_expr"/><a name="39941"/>39941: <b>    tc_try</b>(traffic_sendmsg_and_recvmsg_counters_udp6,
<a name="39942"/>39942:            fun() -&gt; has_support_ipv6() end,
<a name="39943"/>39943:            fun() -&gt;
<a name="39944"/>39944:                    InitState = #{domain =&gt; inet6,
<a name="39945"/>39945:                                  proto  =&gt; udp,
<a name="39946"/>39946:                                  recv   =&gt; fun(S) -&gt;
<a name="39947"/>39947:                                                    case socket:recvmsg(S) of
<a name="39948"/>39948:                                                        {ok, #{addr  := Source,
<a name="39949"/>39949:                                                               iov   := [Data]}} -&gt;
<a name="39950"/>39950:                                                            {ok, {Source, Data}};
<a name="39951"/>39951:                                                        {error, _} = ERROR -&gt;
<a name="39952"/>39952:                                                            ERROR
<a name="39953"/>39953:                                                    end
<a name="39954"/>39954:                                            end,
<a name="39955"/>39955:                                  send   =&gt; fun(S, Data, Dest) -&gt;
<a name="39956"/>39956:                                                    Msg = #{addr =&gt; Dest,
<a name="39957"/>39957:                                                               iov  =&gt; [Data]},
<a name="39958"/>39958:                                                    socket:sendmsg(S, Msg)
<a name="39959"/>39959:                                            end},
<a name="39960"/>39960:                    ok = traffic_send_and_recv_udp(InitState)
<a name="39961"/>39961:            end).
<a name="39962"/>39962: 
<a name="39963"/>39963: 
<a name="39964"/>39964: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="39965"/>39965: <i>%% This test case is intended to (simply) test the counters</i>
<a name="39966"/>39966: <i>%% for both read and write.</i>
<a name="39967"/>39967: <i>%% So that its easy to extend, we use fun's for read and write.</i>
<a name="39968"/>39968: <i>%% We use default (UDP) on local.</i>
<a name="39969"/>39969: 
<a name="traffic_sendmsg_and_recvmsg_counters_udpL-1"/><a name="39970"/>39970: <b>traffic_sendmsg_and_recvmsg_counters_udpL</b>(_Config) when is_list(_Config) -&gt;
<a name="39971"/>39971:     ?TT(?SECS(15)),
<a name="traffic_sendmsg_and_recvmsg_counters_udpL-last_expr"/><a name="39972"/>39972: <b>    tc_try</b>(traffic_sendmsg_and_recvmsg_counters_udpL,
<a name="39973"/>39973:            fun() -&gt;
<a name="39974"/>39974: 		   has_support_unix_domain_socket(),
<a name="39975"/>39975: 		   is_not_windows()
<a name="39976"/>39976: 	   end,
<a name="39977"/>39977:            fun() -&gt;
<a name="39978"/>39978:                    InitState = #{domain =&gt; local,
<a name="39979"/>39979:                                  proto  =&gt; default,
<a name="39980"/>39980:                                  recv   =&gt; fun(S) -&gt;
<a name="39981"/>39981:                                                    case socket:recvmsg(S) of
<a name="39982"/>39982:                                                        {ok, #{addr  := Source,
<a name="39983"/>39983:                                                               iov   := [Data]}} -&gt;
<a name="39984"/>39984:                                                            {ok, {Source, Data}};
<a name="39985"/>39985:                                                        {error, _} = ERROR -&gt;
<a name="39986"/>39986:                                                            ERROR
<a name="39987"/>39987:                                                    end
<a name="39988"/>39988:                                            end,
<a name="39989"/>39989:                                  send   =&gt; fun(S, Data, Dest) -&gt;
<a name="39990"/>39990:                                                    Msg = #{addr =&gt; Dest,
<a name="39991"/>39991:                                                               iov  =&gt; [Data]},
<a name="39992"/>39992:                                                    socket:sendmsg(S, Msg)
<a name="39993"/>39993:                                            end},
<a name="39994"/>39994:                    ok = traffic_send_and_recv_udp(InitState)
<a name="39995"/>39995:            end).
<a name="39996"/>39996: 
<a name="39997"/>39997: 
<a name="39998"/>39998: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="39999"/>39999: 
<a name="traffic_send_and_recv_udp-1"/><a name="40000"/>40000: <b>traffic_send_and_recv_udp</b>(InitState) -&gt;
<a name="40001"/>40001:     ServerSeq =
<a name="40002"/>40002:         [
<a name="40003"/>40003:          %% *** Wait for start order part ***
<a name="40004"/>40004:          #{desc =&gt; &quot;await start&quot;,
<a name="40005"/>40005:            cmd  =&gt; fun(State) -&gt;
<a name="40006"/>40006:                            Tester = ?SEV_AWAIT_START(),
<a name="40007"/>40007:                            {ok, State#{tester =&gt; Tester}}
<a name="40008"/>40008:                    end},
<a name="40009"/>40009:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="40010"/>40010:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="40011"/>40011:                            _MRef = erlang:monitor(process, Tester),
<a name="40012"/>40012:                            ok
<a name="40013"/>40013:                    end},
<a name="40014"/>40014: 
<a name="40015"/>40015:          %% *** Init part ***
<a name="40016"/>40016:          #{desc =&gt; &quot;which local address&quot;,
<a name="40017"/>40017:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="40018"/>40018:                            LSA = which_local_socket_addr(Domain),
<a name="40019"/>40019:                            {ok, State#{local_sa =&gt; LSA}}
<a name="40020"/>40020:                    end},
<a name="40021"/>40021:          #{desc =&gt; &quot;create socket&quot;,
<a name="40022"/>40022:            cmd  =&gt; fun(#{domain := Domain, proto := Proto} = State) -&gt;
<a name="40023"/>40023:                            case socket:open(Domain, dgram, Proto) of
<a name="40024"/>40024:                                {ok, Sock} -&gt;
<a name="40025"/>40025:                                    {ok, State#{sock =&gt; Sock}};
<a name="40026"/>40026:                                {error, _} = ERROR -&gt;
<a name="40027"/>40027:                                    ERROR
<a name="40028"/>40028:                            end
<a name="40029"/>40029:                    end},
<a name="40030"/>40030:          #{desc =&gt; &quot;bind to local address&quot;,
<a name="40031"/>40031:            cmd  =&gt; fun(#{domain   := local,
<a name="40032"/>40032:                          sock     := Sock,
<a name="40033"/>40033:                          local_sa := LSA} = _State) -&gt;
<a name="40034"/>40034:                            case socket:bind(Sock, LSA) of
<a name="40035"/>40035:                                ok -&gt;
<a name="40036"/>40036:                                    ok; % We do not care about the port for local
<a name="40037"/>40037:                                {error, _} = ERROR -&gt;
<a name="40038"/>40038:                                    ERROR
<a name="40039"/>40039:                            end;
<a name="40040"/>40040:                       (#{sock     := LSock,
<a name="40041"/>40041:                          local_sa := LSA} = State) -&gt;
<a name="40042"/>40042:                            case sock_bind(LSock, LSA) of
<a name="40043"/>40043:                                ok -&gt;
<a name="40044"/>40044:                                    Port = sock_port(LSock),
<a name="40045"/>40045:                                    {ok, State#{lport =&gt; Port}};
<a name="40046"/>40046:                                {error, _} = ERROR -&gt;
<a name="40047"/>40047:                                    ERROR
<a name="40048"/>40048:                            end
<a name="40049"/>40049:                    end},
<a name="40050"/>40050:          #{desc =&gt; &quot;initial counter validation (=zero)&quot;,
<a name="40051"/>40051:            cmd  =&gt; fun(#{sock := Sock} = _State) -&gt;
<a name="40052"/>40052:                            try socket:info(Sock) of
<a name="40053"/>40053:                                #{counters := Counters} -&gt;
<a name="40054"/>40054:                                    ?SEV_IPRINT(&quot;Validate initial counters: &quot;
<a name="40055"/>40055:                                                &quot;~s&quot;, [format_counters(Counters)]),
<a name="40056"/>40056:                                    traffic_sar_counters_validation(Counters)
<a name="40057"/>40057:                            catch
<a name="40058"/>40058:                                C:E:S -&gt;
<a name="40059"/>40059:                                    ?SEV_EPRINT(&quot;Failed get socket info: &quot;
<a name="40060"/>40060:                                                &quot;~n   Class: ~p&quot;
<a name="40061"/>40061:                                                &quot;~n   Error: ~p&quot;
<a name="40062"/>40062:                                                &quot;~n   Stack: ~p&quot;, [C, E, S]),
<a name="40063"/>40063:                                    {error, {socket_info_failed, {C, E, S}}}
<a name="40064"/>40064:                            end
<a name="40065"/>40065:                    end},
<a name="40066"/>40066:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="40067"/>40067:            cmd  =&gt; fun(#{domain   := local,
<a name="40068"/>40068:                          tester   := Tester,
<a name="40069"/>40069:                          local_sa := #{path := Path}}) -&gt;
<a name="40070"/>40070:                            ?SEV_ANNOUNCE_READY(Tester, init, Path),
<a name="40071"/>40071:                            ok;
<a name="40072"/>40072:                       (#{tester   := Tester,
<a name="40073"/>40073:                          lport    := Port}) -&gt;
<a name="40074"/>40074:                            ?SEV_ANNOUNCE_READY(Tester, init, Port),
<a name="40075"/>40075:                            ok
<a name="40076"/>40076:                    end},
<a name="40077"/>40077: 
<a name="40078"/>40078:          %% The actual test
<a name="40079"/>40079:          #{desc =&gt; &quot;await continue (recv_and_validate 1)&quot;,
<a name="40080"/>40080:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="40081"/>40081:                            ?SEV_AWAIT_CONTINUE(Tester, tester, recv_and_validate)
<a name="40082"/>40082:                    end},
<a name="40083"/>40083:          #{desc =&gt; &quot;recv (1)&quot;,
<a name="40084"/>40084:            cmd  =&gt; fun(#{sock := Sock,
<a name="40085"/>40085:                          recv := Recv} = State) -&gt;
<a name="40086"/>40086:                            case Recv(Sock) of
<a name="40087"/>40087:                                {ok, {ClientSA, Data}} -&gt;
<a name="40088"/>40088:                                    ?SEV_IPRINT(&quot;recv ~p bytes&quot;, [size(Data)]),
<a name="40089"/>40089:                                    {ok, State#{client_sa =&gt; ClientSA,
<a name="40090"/>40090:                                                read_pkg  =&gt; 1,
<a name="40091"/>40091:                                                read_byte =&gt; size(Data)}};
<a name="40092"/>40092:                                {error, _} = ERROR -&gt;
<a name="40093"/>40093:                                    ERROR
<a name="40094"/>40094:                            end
<a name="40095"/>40095:                    end},
<a name="40096"/>40096:          #{desc =&gt; &quot;validate (recv 1)&quot;,
<a name="40097"/>40097:            cmd  =&gt; fun(#{sock      := Sock,
<a name="40098"/>40098:                          read_pkg  := Pkg,
<a name="40099"/>40099:                          read_byte := Byte} = _State) -&gt;
<a name="40100"/>40100:                            try socket:info(Sock) of
<a name="40101"/>40101:                                #{counters := Counters} -&gt;
<a name="40102"/>40102:                                    ?SEV_IPRINT(&quot;validate counters: &quot;
<a name="40103"/>40103:                                                &quot;~s&quot;, [format_counters(Counters)]),
<a name="40104"/>40104:                                    traffic_sar_counters_validation(
<a name="40105"/>40105:                                      Counters,
<a name="40106"/>40106:                                      [{read_pkg,   Pkg},
<a name="40107"/>40107:                                       {read_byte,  Byte},
<a name="40108"/>40108:                                       {read_tries, any}])
<a name="40109"/>40109:                            catch
<a name="40110"/>40110:                                C:E:S -&gt;
<a name="40111"/>40111:                                    ?SEV_EPRINT(&quot;Failed get socket info: &quot;
<a name="40112"/>40112:                                                &quot;~n   Class: ~p&quot;
<a name="40113"/>40113:                                                &quot;~n   Error: ~p&quot;
<a name="40114"/>40114:                                                &quot;~n   Stack: ~p&quot;, [C, E, S]),
<a name="40115"/>40115:                                    {error, {socket_info_failed, {C, E, S}}}
<a name="40116"/>40116:                            end
<a name="40117"/>40117:                    end},
<a name="40118"/>40118:          #{desc =&gt; &quot;announce ready (recv_and_validate 1)&quot;,
<a name="40119"/>40119:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="40120"/>40120:                            ?SEV_ANNOUNCE_READY(Tester, recv_and_validate),
<a name="40121"/>40121:                            ok
<a name="40122"/>40122:                    end},
<a name="40123"/>40123: 
<a name="40124"/>40124:          #{desc =&gt; &quot;await continue (send_and_validate 1)&quot;,
<a name="40125"/>40125:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="40126"/>40126:                            ?SEV_AWAIT_CONTINUE(Tester, tester, send_and_validate)
<a name="40127"/>40127:                    end},
<a name="40128"/>40128:          #{desc =&gt; &quot;send (1)&quot;,
<a name="40129"/>40129:            cmd  =&gt; fun(#{sock      := Sock,
<a name="40130"/>40130:                          send      := Send,
<a name="40131"/>40131:                          client_sa := ClientSA} = State) -&gt;
<a name="40132"/>40132:                            Data = ?DATA,
<a name="40133"/>40133:                            case Send(Sock, Data, ClientSA) of
<a name="40134"/>40134:                                ok -&gt;
<a name="40135"/>40135:                                    ?SEV_IPRINT(&quot;sent ~p bytes&quot;, [size(Data)]),
<a name="40136"/>40136:                                    {ok, State#{write_pkg  =&gt; 1,
<a name="40137"/>40137:                                                write_byte =&gt; size(Data)}};
<a name="40138"/>40138:                                {error, _} = ERROR -&gt;
<a name="40139"/>40139:                                    ERROR
<a name="40140"/>40140:                            end
<a name="40141"/>40141:                    end},
<a name="40142"/>40142:          #{desc =&gt; &quot;validate (send 1)&quot;,
<a name="40143"/>40143:            cmd  =&gt; fun(#{sock       := Sock,
<a name="40144"/>40144:                          read_pkg   := RPkg,
<a name="40145"/>40145:                          read_byte  := RByte,
<a name="40146"/>40146:                          write_pkg  := SPkg,
<a name="40147"/>40147:                          write_byte := SByte} = _State) -&gt;
<a name="40148"/>40148:                            try socket:info(Sock) of
<a name="40149"/>40149:                                #{counters := Counters} -&gt;
<a name="40150"/>40150:                                    ?SEV_IPRINT(&quot;validate counters: &quot;
<a name="40151"/>40151:                                                &quot;~s&quot;, [format_counters(Counters)]),
<a name="40152"/>40152:                                    traffic_sar_counters_validation(
<a name="40153"/>40153:                                      Counters,
<a name="40154"/>40154:                                      [{read_pkg,    RPkg},
<a name="40155"/>40155:                                       {read_byte,   RByte},
<a name="40156"/>40156:                                       {write_pkg,   SPkg},
<a name="40157"/>40157:                                       {write_byte,  SByte},
<a name="40158"/>40158:                                       {read_tries,  any},
<a name="40159"/>40159:                                       {write_tries, any}])
<a name="40160"/>40160:                            catch
<a name="40161"/>40161:                                C:E:S -&gt;
<a name="40162"/>40162:                                    ?SEV_EPRINT(&quot;Failed get socket info: &quot;
<a name="40163"/>40163:                                                &quot;~n   Class: ~p&quot;
<a name="40164"/>40164:                                                &quot;~n   Error: ~p&quot;
<a name="40165"/>40165:                                                &quot;~n   Stack: ~p&quot;, [C, E, S]),
<a name="40166"/>40166:                                    {error, {socket_info_failed, {C, E, S}}}
<a name="40167"/>40167:                            end
<a name="40168"/>40168:                    end},
<a name="40169"/>40169:          #{desc =&gt; &quot;announce ready (send_and_validate 1)&quot;,
<a name="40170"/>40170:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="40171"/>40171:                            ?SEV_ANNOUNCE_READY(Tester, send_and_validate),
<a name="40172"/>40172:                            ok
<a name="40173"/>40173:                    end},
<a name="40174"/>40174: 
<a name="40175"/>40175:          #{desc =&gt; &quot;await continue (recv_and_validate 2)&quot;,
<a name="40176"/>40176:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="40177"/>40177:                            ?SEV_AWAIT_CONTINUE(Tester, tester, recv_and_validate)
<a name="40178"/>40178:                    end},
<a name="40179"/>40179:          #{desc =&gt; &quot;recv (2)&quot;,
<a name="40180"/>40180:            cmd  =&gt; fun(#{sock      := Sock,
<a name="40181"/>40181:                          recv      := Recv,
<a name="40182"/>40182:                          read_pkg  := Pkg,
<a name="40183"/>40183:                          read_byte := Byte} = State) -&gt;
<a name="40184"/>40184:                            case Recv(Sock) of
<a name="40185"/>40185:                                {ok, {Source, Data}} -&gt;
<a name="40186"/>40186:                                    ?SEV_IPRINT(&quot;recv ~p bytes&quot;, [size(Data)]),
<a name="40187"/>40187:                                    {ok, State#{client_sa =&gt; Source,
<a name="40188"/>40188:                                                read_pkg  =&gt; Pkg + 1,
<a name="40189"/>40189:                                                read_byte =&gt; Byte + size(Data)}};
<a name="40190"/>40190:                                {error, _} = ERROR -&gt;
<a name="40191"/>40191:                                    ERROR
<a name="40192"/>40192:                            end
<a name="40193"/>40193:                    end},
<a name="40194"/>40194:          #{desc =&gt; &quot;validate (recv 2)&quot;,
<a name="40195"/>40195:            cmd  =&gt; fun(#{sock       := Sock,
<a name="40196"/>40196:                          read_pkg   := RPkg,
<a name="40197"/>40197:                          read_byte  := RByte,
<a name="40198"/>40198:                          write_pkg  := SPkg,
<a name="40199"/>40199:                          write_byte := SByte} = _State) -&gt;
<a name="40200"/>40200:                            try socket:info(Sock) of
<a name="40201"/>40201:                                #{counters := Counters} -&gt;
<a name="40202"/>40202:                                    ?SEV_IPRINT(&quot;validate counters: &quot;
<a name="40203"/>40203:                                                &quot;~s&quot;, [format_counters(Counters)]),
<a name="40204"/>40204:                                    traffic_sar_counters_validation(
<a name="40205"/>40205:                                      Counters,
<a name="40206"/>40206:                                      [{read_pkg,    RPkg},
<a name="40207"/>40207:                                       {read_byte,   RByte},
<a name="40208"/>40208:                                       {write_pkg,   SPkg},
<a name="40209"/>40209:                                       {write_byte,  SByte},
<a name="40210"/>40210:                                       {read_tries,  any},
<a name="40211"/>40211:                                       {write_tries, any}])
<a name="40212"/>40212:                            catch
<a name="40213"/>40213:                                C:E:S -&gt;
<a name="40214"/>40214:                                    ?SEV_EPRINT(&quot;Failed get socket info: &quot;
<a name="40215"/>40215:                                                &quot;~n   Class: ~p&quot;
<a name="40216"/>40216:                                                &quot;~n   Error: ~p&quot;
<a name="40217"/>40217:                                                &quot;~n   Stack: ~p&quot;, [C, E, S]),
<a name="40218"/>40218:                                    {error, {socket_info_failed, {C, E, S}}}
<a name="40219"/>40219:                            end
<a name="40220"/>40220:                    end},
<a name="40221"/>40221:          #{desc =&gt; &quot;announce ready (recv_and_validate 2)&quot;,
<a name="40222"/>40222:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="40223"/>40223:                            ?SEV_ANNOUNCE_READY(Tester, recv_and_validate),
<a name="40224"/>40224:                            ok
<a name="40225"/>40225:                    end},
<a name="40226"/>40226: 
<a name="40227"/>40227:          #{desc =&gt; &quot;await continue (send_and_validate 2)&quot;,
<a name="40228"/>40228:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="40229"/>40229:                            ?SEV_AWAIT_CONTINUE(Tester, tester, send_and_validate)
<a name="40230"/>40230:                    end},
<a name="40231"/>40231:          #{desc =&gt; &quot;send (2)&quot;,
<a name="40232"/>40232:            cmd  =&gt; fun(#{sock       := Sock,
<a name="40233"/>40233:                          client_sa  := ClientSA,
<a name="40234"/>40234:                          send       := Send,
<a name="40235"/>40235:                          write_pkg  := Pkg,
<a name="40236"/>40236:                          write_byte := Byte} = State) -&gt;
<a name="40237"/>40237:                            Data = ?DATA,
<a name="40238"/>40238:                            case Send(Sock, Data, ClientSA) of
<a name="40239"/>40239:                                ok -&gt;
<a name="40240"/>40240:                                    ?SEV_IPRINT(&quot;sent ~p bytes&quot;, [size(Data)]),
<a name="40241"/>40241:                                    {ok, State#{write_pkg  =&gt; Pkg + 1,
<a name="40242"/>40242:                                                write_byte =&gt; Byte + size(Data)}};
<a name="40243"/>40243:                                {error, _} = ERROR -&gt;
<a name="40244"/>40244:                                    ERROR
<a name="40245"/>40245:                            end
<a name="40246"/>40246:                    end},
<a name="40247"/>40247:          #{desc =&gt; &quot;validate (send 2)&quot;,
<a name="40248"/>40248:            cmd  =&gt; fun(#{sock       := Sock,
<a name="40249"/>40249:                          read_pkg   := RPkg,
<a name="40250"/>40250:                          read_byte  := RByte,
<a name="40251"/>40251:                          write_pkg  := SPkg,
<a name="40252"/>40252:                          write_byte := SByte} = _State) -&gt;
<a name="40253"/>40253:                            try socket:info(Sock) of
<a name="40254"/>40254:                                #{counters := Counters} -&gt;
<a name="40255"/>40255:                                    ?SEV_IPRINT(&quot;validate counters: &quot;
<a name="40256"/>40256:                                                &quot;~s&quot;, [format_counters(Counters)]),
<a name="40257"/>40257:                                    traffic_sar_counters_validation(
<a name="40258"/>40258:                                      Counters,
<a name="40259"/>40259:                                      [{read_pkg,    RPkg},
<a name="40260"/>40260:                                       {read_byte,   RByte},
<a name="40261"/>40261:                                       {write_pkg,   SPkg},
<a name="40262"/>40262:                                       {write_byte,  SByte},
<a name="40263"/>40263:                                       {read_tries,  any},
<a name="40264"/>40264:                                       {write_tries, any}])
<a name="40265"/>40265:                            catch
<a name="40266"/>40266:                                C:E:S -&gt;
<a name="40267"/>40267:                                    ?SEV_EPRINT(&quot;Failed get socket info: &quot;
<a name="40268"/>40268:                                                &quot;~n   Class: ~p&quot;
<a name="40269"/>40269:                                                &quot;~n   Error: ~p&quot;
<a name="40270"/>40270:                                                &quot;~n   Stack: ~p&quot;, [C, E, S]),
<a name="40271"/>40271:                                    {error, {socket_info_failed, {C, E, S}}}
<a name="40272"/>40272:                            end
<a name="40273"/>40273:                    end},
<a name="40274"/>40274:          #{desc =&gt; &quot;announce ready (send_and_validate 2)&quot;,
<a name="40275"/>40275:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="40276"/>40276:                            ?SEV_ANNOUNCE_READY(Tester, send_and_validate),
<a name="40277"/>40277:                            ok
<a name="40278"/>40278:                    end},
<a name="40279"/>40279: 
<a name="40280"/>40280: 
<a name="40281"/>40281:          %% Termination
<a name="40282"/>40282:          #{desc =&gt; &quot;await terminate (from tester)&quot;,
<a name="40283"/>40283:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="40284"/>40284:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="40285"/>40285:                                ok -&gt;
<a name="40286"/>40286:                                    {ok, maps:remove(tester, State)};
<a name="40287"/>40287:                                {error, _} = ERROR -&gt;
<a name="40288"/>40288:                                    ERROR
<a name="40289"/>40289:                            end
<a name="40290"/>40290:                    end},
<a name="40291"/>40291:          #{desc =&gt; &quot;close socket (just in case)&quot;,
<a name="40292"/>40292:            cmd  =&gt; fun(#{domain   := local,
<a name="40293"/>40293:                          sock     := Sock,
<a name="40294"/>40294:                          local_sa := #{path := Path}} = State) -&gt;
<a name="40295"/>40295:                            ok = socket:close(Sock),
<a name="40296"/>40296:                            State1 =
<a name="40297"/>40297:                                unlink_path(Path,
<a name="40298"/>40298:                                            fun() -&gt;
<a name="40299"/>40299:                                                    maps:remove(local_sa, State)
<a name="40300"/>40300:                                            end,
<a name="40301"/>40301:                                            fun() -&gt; State end),
<a name="40302"/>40302:                            {ok, maps:remove(lsock, State1)};
<a name="40303"/>40303:                       (#{sock := Sock} = State) -&gt;
<a name="40304"/>40304:                            (catch socket:close(Sock)),
<a name="40305"/>40305:                            {ok, maps:remove(sock, State)}
<a name="40306"/>40306:                    end},
<a name="40307"/>40307: 
<a name="40308"/>40308:          %% *** We are done ***
<a name="40309"/>40309:          ?SEV_FINISH_NORMAL
<a name="40310"/>40310:         ],
<a name="40311"/>40311: 
<a name="40312"/>40312:     ClientSeq =
<a name="40313"/>40313:         [
<a name="40314"/>40314:          %% *** Wait for start order part ***
<a name="40315"/>40315:          #{desc =&gt; &quot;await start (from tester)&quot;,
<a name="40316"/>40316:            cmd  =&gt; fun(#{domain := local} = State) -&gt;
<a name="40317"/>40317:                            {Tester, Path} = ?SEV_AWAIT_START(),
<a name="40318"/>40318:                            {ok, State#{tester =&gt; Tester, server_path =&gt; Path}};
<a name="40319"/>40319:                       (State) -&gt;
<a name="40320"/>40320:                            {Tester, Port} = ?SEV_AWAIT_START(),
<a name="40321"/>40321:                            {ok, State#{tester =&gt; Tester, server_port =&gt; Port}}
<a name="40322"/>40322:                    end},
<a name="40323"/>40323:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="40324"/>40324:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="40325"/>40325:                            _MRef = erlang:monitor(process, Tester),
<a name="40326"/>40326:                            ok
<a name="40327"/>40327:                    end},
<a name="40328"/>40328: 
<a name="40329"/>40329:          %% *** Init part ***
<a name="40330"/>40330:          #{desc =&gt; &quot;which server (local) address&quot;,
<a name="40331"/>40331:            cmd  =&gt; fun(#{domain      := local = Domain,
<a name="40332"/>40332:                          server_path := Path} = State) -&gt;
<a name="40333"/>40333:                            LSA = which_local_socket_addr(Domain),
<a name="40334"/>40334:                            SSA = #{family =&gt; Domain, path =&gt; Path},
<a name="40335"/>40335:                            {ok, State#{local_sa =&gt; LSA, server_sa =&gt; SSA}};
<a name="40336"/>40336:                       (#{domain := Domain, server_port := Port} = State) -&gt;
<a name="40337"/>40337:                            LSA = which_local_socket_addr(Domain),
<a name="40338"/>40338:                            SSA = LSA#{port =&gt; Port},
<a name="40339"/>40339:                            {ok, State#{local_sa =&gt; LSA, server_sa =&gt; SSA}}
<a name="40340"/>40340:                    end},
<a name="40341"/>40341:          #{desc =&gt; &quot;create socket&quot;,
<a name="40342"/>40342:            cmd  =&gt; fun(#{domain := Domain,
<a name="40343"/>40343:                          proto  := Proto} = State) -&gt;
<a name="40344"/>40344:                            case socket:open(Domain, dgram, Proto) of
<a name="40345"/>40345:                                {ok, Sock} -&gt;
<a name="40346"/>40346:                                    {ok, State#{sock =&gt; Sock}};
<a name="40347"/>40347:                                {error, _} = ERROR -&gt;
<a name="40348"/>40348:                                    ERROR
<a name="40349"/>40349:                            end
<a name="40350"/>40350:                    end},
<a name="40351"/>40351:          #{desc =&gt; &quot;bind to local address&quot;,
<a name="40352"/>40352:            cmd  =&gt; fun(#{sock := Sock, local_sa := LSA} = _State) -&gt;
<a name="40353"/>40353:                            case sock_bind(Sock, LSA) of
<a name="40354"/>40354:                                ok -&gt;
<a name="40355"/>40355:                                    ok;
<a name="40356"/>40356:                                {error, _} = ERROR -&gt;
<a name="40357"/>40357:                                    ERROR
<a name="40358"/>40358:                            end
<a name="40359"/>40359:                    end},
<a name="40360"/>40360:          #{desc =&gt; &quot;initial counter validation (=zero)&quot;,
<a name="40361"/>40361:            cmd  =&gt; fun(#{sock := Sock} = _State) -&gt;
<a name="40362"/>40362:                            try socket:info(Sock) of
<a name="40363"/>40363:                                #{counters := Counters} -&gt;
<a name="40364"/>40364:                                    ?SEV_IPRINT(&quot;Validate initial counters: &quot;
<a name="40365"/>40365:                                                &quot;~s&quot;, [format_counters(Counters)]),
<a name="40366"/>40366:                                    traffic_sar_counters_validation(Counters)
<a name="40367"/>40367:                            catch
<a name="40368"/>40368:                                C:E:S -&gt;
<a name="40369"/>40369:                                    ?SEV_EPRINT(&quot;Failed get socket info: &quot;
<a name="40370"/>40370:                                                &quot;~n   Class: ~p&quot;
<a name="40371"/>40371:                                                &quot;~n   Error: ~p&quot;
<a name="40372"/>40372:                                                &quot;~n   Stack: ~p&quot;, [C, E, S]),
<a name="40373"/>40373:                                    {error, {socket_info_failed, {C, E, S}}}
<a name="40374"/>40374:                            end
<a name="40375"/>40375:                    end},
<a name="40376"/>40376:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="40377"/>40377:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="40378"/>40378:                            ?SEV_ANNOUNCE_READY(Tester, init),
<a name="40379"/>40379:                            ok
<a name="40380"/>40380:                    end},
<a name="40381"/>40381: 
<a name="40382"/>40382:          %% The actual test
<a name="40383"/>40383:          #{desc =&gt; &quot;await continue (send_and_validate 1)&quot;,
<a name="40384"/>40384:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="40385"/>40385:                            ?SEV_AWAIT_CONTINUE(Tester, tester, send_and_validate)
<a name="40386"/>40386:                    end},
<a name="40387"/>40387:          #{desc =&gt; &quot;send (1)&quot;,
<a name="40388"/>40388:            cmd  =&gt; fun(#{sock      := Sock,
<a name="40389"/>40389:                          send      := Send,
<a name="40390"/>40390:                          server_sa := ServerSA} = State) -&gt;
<a name="40391"/>40391:                            Data = ?DATA,
<a name="40392"/>40392:                            case Send(Sock, Data, ServerSA) of
<a name="40393"/>40393:                                ok -&gt;
<a name="40394"/>40394:                                    ?SEV_IPRINT(&quot;sent ~p bytes&quot;, [size(Data)]),
<a name="40395"/>40395:                                    {ok, State#{write_pkg  =&gt; 1,
<a name="40396"/>40396:                                                write_byte =&gt; size(Data)}};
<a name="40397"/>40397:                                {error, _} = ERROR -&gt;
<a name="40398"/>40398:                                    ERROR
<a name="40399"/>40399:                            end
<a name="40400"/>40400:                    end},
<a name="40401"/>40401:          #{desc =&gt; &quot;validate (send 1)&quot;,
<a name="40402"/>40402:            cmd  =&gt; fun(#{sock       := Sock,
<a name="40403"/>40403:                          write_pkg  := SPkg,
<a name="40404"/>40404:                          write_byte := SByte} = _State) -&gt;
<a name="40405"/>40405:                            try socket:info(Sock) of
<a name="40406"/>40406:                                #{counters := Counters} -&gt;
<a name="40407"/>40407:                                    ?SEV_IPRINT(&quot;validate counters: &quot;
<a name="40408"/>40408:                                                &quot;~s&quot;, [format_counters(Counters)]),
<a name="40409"/>40409:                                    traffic_sar_counters_validation(
<a name="40410"/>40410:                                      Counters,
<a name="40411"/>40411:                                      [{write_pkg,     SPkg},
<a name="40412"/>40412:                                       {write_byte,    SByte},
<a name="40413"/>40413:                                       {write_tries,   any},
<a name="40414"/>40414:                                       {write_pkg_max, any}])
<a name="40415"/>40415:                            catch
<a name="40416"/>40416:                                C:E:S -&gt;
<a name="40417"/>40417:                                    ?SEV_EPRINT(&quot;Failed get socket info: &quot;
<a name="40418"/>40418:                                                &quot;~n   Class: ~p&quot;
<a name="40419"/>40419:                                                &quot;~n   Error: ~p&quot;
<a name="40420"/>40420:                                                &quot;~n   Stack: ~p&quot;, [C, E, S]),
<a name="40421"/>40421:                                    {error, {socket_info_failed, {C, E, S}}}
<a name="40422"/>40422:                            end
<a name="40423"/>40423:                    end},
<a name="40424"/>40424:          #{desc =&gt; &quot;announce ready (send_and_validate 1)&quot;,
<a name="40425"/>40425:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="40426"/>40426:                            ?SEV_ANNOUNCE_READY(Tester, send_and_validate),
<a name="40427"/>40427:                            ok
<a name="40428"/>40428:                    end},
<a name="40429"/>40429: 
<a name="40430"/>40430:          #{desc =&gt; &quot;await continue (recv_and_validate 1)&quot;,
<a name="40431"/>40431:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="40432"/>40432:                            ?SEV_AWAIT_CONTINUE(Tester, tester, recv_and_validate)
<a name="40433"/>40433:                    end},
<a name="40434"/>40434:          #{desc =&gt; &quot;recv (1)&quot;,
<a name="40435"/>40435:            cmd  =&gt; fun(#{sock      := Sock,
<a name="40436"/>40436:                          recv      := Recv,
<a name="40437"/>40437:                          server_sa := #{family := local} = ServerSA} = State) -&gt;
<a name="40438"/>40438:                            case Recv(Sock) of
<a name="40439"/>40439:                                {ok, {ServerSA, Data}} -&gt;
<a name="40440"/>40440:                                    ?SEV_IPRINT(&quot;recv ~p bytes&quot;, [size(Data)]),
<a name="40441"/>40441:                                    {ok, State#{read_pkg  =&gt; 1,
<a name="40442"/>40442:                                                read_byte =&gt; size(Data)}};
<a name="40443"/>40443:                                {error, _} = ERROR -&gt;
<a name="40444"/>40444:                                    ERROR
<a name="40445"/>40445:                            end;
<a name="40446"/>40446:                       (#{sock      := Sock,
<a name="40447"/>40447:                          recv      := Recv,
<a name="40448"/>40448:                          server_sa := #{addr := Addr, port := Port}} = State) -&gt;
<a name="40449"/>40449:                            case Recv(Sock) of
<a name="40450"/>40450:                                {ok, {#{addr := Addr, port := Port}, Data}} -&gt;
<a name="40451"/>40451:                                    ?SEV_IPRINT(&quot;recv ~p bytes&quot;, [size(Data)]),
<a name="40452"/>40452:                                    {ok, State#{read_pkg  =&gt; 1,
<a name="40453"/>40453:                                                read_byte =&gt; size(Data)}};
<a name="40454"/>40454:                                {error, _} = ERROR -&gt;
<a name="40455"/>40455:                                    ERROR
<a name="40456"/>40456:                            end
<a name="40457"/>40457:                    end},
<a name="40458"/>40458:          #{desc =&gt; &quot;validate (recv 1)&quot;,
<a name="40459"/>40459:            cmd  =&gt; fun(#{sock      := Sock,
<a name="40460"/>40460:                          read_pkg  := RPkg,
<a name="40461"/>40461:                          read_byte := RByte,
<a name="40462"/>40462:                          write_pkg  := SPkg,
<a name="40463"/>40463:                          write_byte := SByte} = _State) -&gt;
<a name="40464"/>40464:                            try socket:info(Sock) of
<a name="40465"/>40465:                                #{counters := Counters} -&gt;
<a name="40466"/>40466:                                    ?SEV_IPRINT(&quot;validate counters: &quot;
<a name="40467"/>40467:                                                &quot;~s&quot;, [format_counters(Counters)]),
<a name="40468"/>40468:                                    traffic_sar_counters_validation(
<a name="40469"/>40469:                                      Counters,
<a name="40470"/>40470:                                      [{read_pkg,      RPkg},
<a name="40471"/>40471:                                       {read_byte,     RByte},
<a name="40472"/>40472:                                       {write_pkg,     SPkg},
<a name="40473"/>40473:                                       {write_byte,    SByte},
<a name="40474"/>40474:                                       {read_tries,    any},
<a name="40475"/>40475:                                       {write_tries,   any},
<a name="40476"/>40476:                                       {read_pkg_max,  any},
<a name="40477"/>40477:                                       {write_pkg_max, any}])
<a name="40478"/>40478:                            catch
<a name="40479"/>40479:                                C:E:S -&gt;
<a name="40480"/>40480:                                    ?SEV_EPRINT(&quot;Failed get socket info: &quot;
<a name="40481"/>40481:                                                &quot;~n   Class: ~p&quot;
<a name="40482"/>40482:                                                &quot;~n   Error: ~p&quot;
<a name="40483"/>40483:                                                &quot;~n   Stack: ~p&quot;, [C, E, S]),
<a name="40484"/>40484:                                    {error, {socket_info_failed, {C, E, S}}}
<a name="40485"/>40485:                            end
<a name="40486"/>40486:                    end},
<a name="40487"/>40487:          #{desc =&gt; &quot;announce ready (recv_and_validate 1)&quot;,
<a name="40488"/>40488:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="40489"/>40489:                            ?SEV_ANNOUNCE_READY(Tester, recv_and_validate),
<a name="40490"/>40490:                            ok
<a name="40491"/>40491:                    end},
<a name="40492"/>40492: 
<a name="40493"/>40493:          #{desc =&gt; &quot;await continue (send_and_validate 2)&quot;,
<a name="40494"/>40494:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="40495"/>40495:                            ?SEV_AWAIT_CONTINUE(Tester, tester, send_and_validate)
<a name="40496"/>40496:                    end},
<a name="40497"/>40497:          #{desc =&gt; &quot;send (2)&quot;,
<a name="40498"/>40498:            cmd  =&gt; fun(#{sock       := Sock,
<a name="40499"/>40499:                          send       := Send,
<a name="40500"/>40500:                          server_sa  := ServerSA,
<a name="40501"/>40501:                          write_pkg  := SPkg,
<a name="40502"/>40502:                          write_byte := SByte} = State) -&gt;
<a name="40503"/>40503:                            Data = ?DATA,
<a name="40504"/>40504:                            case Send(Sock, Data, ServerSA) of
<a name="40505"/>40505:                                ok -&gt;
<a name="40506"/>40506:                                    ?SEV_IPRINT(&quot;sent ~p bytes&quot;, [size(Data)]),
<a name="40507"/>40507:                                    {ok, State#{write_pkg  =&gt; SPkg + 1,
<a name="40508"/>40508:                                                write_byte =&gt; SByte + size(Data)}};
<a name="40509"/>40509:                                {error, _} = ERROR -&gt;
<a name="40510"/>40510:                                    ERROR
<a name="40511"/>40511:                            end
<a name="40512"/>40512:                    end},
<a name="40513"/>40513:          #{desc =&gt; &quot;validate (send 2)&quot;,
<a name="40514"/>40514:            cmd  =&gt; fun(#{sock       := Sock,
<a name="40515"/>40515:                          read_pkg   := RPkg,
<a name="40516"/>40516:                          read_byte  := RByte,
<a name="40517"/>40517:                          write_pkg  := SPkg,
<a name="40518"/>40518:                          write_byte := SByte} = _State) -&gt;
<a name="40519"/>40519:                            try socket:info(Sock) of
<a name="40520"/>40520:                                #{counters := Counters} -&gt;
<a name="40521"/>40521:                                    ?SEV_IPRINT(&quot;validate counters: &quot;
<a name="40522"/>40522:                                                &quot;~s&quot;, [format_counters(Counters)]),
<a name="40523"/>40523:                                    traffic_sar_counters_validation(
<a name="40524"/>40524:                                      Counters,
<a name="40525"/>40525:                                      [{read_pkg,      RPkg},
<a name="40526"/>40526:                                       {read_byte,     RByte},
<a name="40527"/>40527:                                       {write_pkg,     SPkg},
<a name="40528"/>40528:                                       {write_byte,    SByte},
<a name="40529"/>40529:                                       {read_tries,    any},
<a name="40530"/>40530:                                       {write_tries,   any},
<a name="40531"/>40531:                                       {read_pkg_max,  any},
<a name="40532"/>40532:                                       {write_pkg_max, any}])
<a name="40533"/>40533:                            catch
<a name="40534"/>40534:                                C:E:S -&gt;
<a name="40535"/>40535:                                    ?SEV_EPRINT(&quot;Failed get socket info: &quot;
<a name="40536"/>40536:                                                &quot;~n   Class: ~p&quot;
<a name="40537"/>40537:                                                &quot;~n   Error: ~p&quot;
<a name="40538"/>40538:                                                &quot;~n   Stack: ~p&quot;, [C, E, S]),
<a name="40539"/>40539:                                    {error, {socket_info_failed, {C, E, S}}}
<a name="40540"/>40540:                            end
<a name="40541"/>40541:                    end},
<a name="40542"/>40542:          #{desc =&gt; &quot;announce ready (send_and_validate 2)&quot;,
<a name="40543"/>40543:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="40544"/>40544:                            ?SEV_ANNOUNCE_READY(Tester, send_and_validate),
<a name="40545"/>40545:                            ok
<a name="40546"/>40546:                    end},
<a name="40547"/>40547: 
<a name="40548"/>40548:          #{desc =&gt; &quot;await continue (recv_and_validate 2)&quot;,
<a name="40549"/>40549:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="40550"/>40550:                            ?SEV_AWAIT_CONTINUE(Tester, tester, recv_and_validate)
<a name="40551"/>40551:                    end},
<a name="40552"/>40552:          #{desc =&gt; &quot;recv (2)&quot;,
<a name="40553"/>40553:            cmd  =&gt; fun(#{sock      := Sock,
<a name="40554"/>40554:                          server_sa := #{family := local} = ServerSA,
<a name="40555"/>40555:                          recv      := Recv,
<a name="40556"/>40556:                          read_pkg  := RPkg,
<a name="40557"/>40557:                          read_byte := RByte} = State) -&gt;
<a name="40558"/>40558:                            case Recv(Sock) of
<a name="40559"/>40559:                                {ok, {ServerSA, Data}} -&gt;
<a name="40560"/>40560:                                    ?SEV_IPRINT(&quot;recv ~p bytes&quot;, [size(Data)]),
<a name="40561"/>40561:                                    {ok, State#{read_pkg  =&gt; RPkg + 1,
<a name="40562"/>40562:                                                read_byte =&gt; RByte + size(Data)}};
<a name="40563"/>40563:                                {error, _} = ERROR -&gt;
<a name="40564"/>40564:                                    ERROR
<a name="40565"/>40565:                            end;
<a name="40566"/>40566: 		      (#{sock      := Sock,
<a name="40567"/>40567:                          server_sa := #{addr := Addr, port := Port},
<a name="40568"/>40568:                          recv      := Recv,
<a name="40569"/>40569:                          read_pkg  := RPkg,
<a name="40570"/>40570:                          read_byte := RByte} = State) -&gt;
<a name="40571"/>40571:                            case Recv(Sock) of
<a name="40572"/>40572:                                {ok, {#{addr := Addr, port := Port}, Data}} -&gt;
<a name="40573"/>40573:                                    ?SEV_IPRINT(&quot;recv ~p bytes&quot;, [size(Data)]),
<a name="40574"/>40574:                                    {ok, State#{read_pkg  =&gt; RPkg + 1,
<a name="40575"/>40575:                                                read_byte =&gt; RByte + size(Data)}};
<a name="40576"/>40576:                                {error, _} = ERROR -&gt;
<a name="40577"/>40577:                                    ERROR
<a name="40578"/>40578:                            end
<a name="40579"/>40579:                    end},
<a name="40580"/>40580:          #{desc =&gt; &quot;validate (recv 2)&quot;,
<a name="40581"/>40581:            cmd  =&gt; fun(#{sock      := Sock,
<a name="40582"/>40582:                          read_pkg  := RPkg,
<a name="40583"/>40583:                          read_byte := RByte,
<a name="40584"/>40584:                          write_pkg  := SPkg,
<a name="40585"/>40585:                          write_byte := SByte} = _State) -&gt;
<a name="40586"/>40586:                            try socket:info(Sock) of
<a name="40587"/>40587:                                #{counters := Counters} -&gt;
<a name="40588"/>40588:                                    ?SEV_IPRINT(&quot;validate counters: &quot;
<a name="40589"/>40589:                                                &quot;~s&quot;, [format_counters(Counters)]),
<a name="40590"/>40590:                                    traffic_sar_counters_validation(
<a name="40591"/>40591:                                      Counters,
<a name="40592"/>40592:                                      [{read_pkg,      RPkg},
<a name="40593"/>40593:                                       {read_byte,     RByte},
<a name="40594"/>40594:                                       {write_pkg,     SPkg},
<a name="40595"/>40595:                                       {write_byte,    SByte},
<a name="40596"/>40596:                                       {read_tries,    any},
<a name="40597"/>40597:                                       {write_tries,   any},
<a name="40598"/>40598:                                       {read_pkg_max,  any},
<a name="40599"/>40599:                                       {write_pkg_max, any}])
<a name="40600"/>40600:                            catch
<a name="40601"/>40601:                                C:E:S -&gt;
<a name="40602"/>40602:                                    ?SEV_EPRINT(&quot;Failed get socket info: &quot;
<a name="40603"/>40603:                                                &quot;~n   Class: ~p&quot;
<a name="40604"/>40604:                                                &quot;~n   Error: ~p&quot;
<a name="40605"/>40605:                                                &quot;~n   Stack: ~p&quot;, [C, E, S]),
<a name="40606"/>40606:                                    {error, {socket_info_failed, {C, E, S}}}
<a name="40607"/>40607:                            end
<a name="40608"/>40608:                    end},
<a name="40609"/>40609:          #{desc =&gt; &quot;announce ready (recv_and_validate 2)&quot;,
<a name="40610"/>40610:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="40611"/>40611:                            ?SEV_ANNOUNCE_READY(Tester, recv_and_validate),
<a name="40612"/>40612:                            ok
<a name="40613"/>40613:                    end},
<a name="40614"/>40614: 
<a name="40615"/>40615:          %% Termination
<a name="40616"/>40616:          #{desc =&gt; &quot;await terminate (from tester)&quot;,
<a name="40617"/>40617:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="40618"/>40618:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="40619"/>40619:                                ok -&gt;
<a name="40620"/>40620:                                    {ok, maps:remove(tester, State)};
<a name="40621"/>40621:                                {error, _} = ERROR -&gt;
<a name="40622"/>40622:                                    ERROR
<a name="40623"/>40623:                            end
<a name="40624"/>40624:                    end},
<a name="40625"/>40625:          #{desc =&gt; &quot;close connection socket&quot;,
<a name="40626"/>40626:            cmd  =&gt; fun(#{domain   := local,
<a name="40627"/>40627:                          sock     := Sock,
<a name="40628"/>40628:                          local_sa := #{path := Path}} = State) -&gt;
<a name="40629"/>40629:                            ok = socket:close(Sock),
<a name="40630"/>40630:                            State1 =
<a name="40631"/>40631:                                unlink_path(Path,
<a name="40632"/>40632:                                            fun() -&gt;
<a name="40633"/>40633:                                                    maps:remove(local_sa, State)
<a name="40634"/>40634:                                            end,
<a name="40635"/>40635:                                            fun() -&gt; State end),
<a name="40636"/>40636:                            {ok, maps:remove(sock, State1)};
<a name="40637"/>40637:                       (#{sock := Sock} = State) -&gt;
<a name="40638"/>40638:                            socket:close(Sock),
<a name="40639"/>40639:                            {ok, maps:remove(sock, State)}
<a name="40640"/>40640:                    end},
<a name="40641"/>40641: 
<a name="40642"/>40642:          %% *** We are done ***
<a name="40643"/>40643:          ?SEV_FINISH_NORMAL
<a name="40644"/>40644:         ],
<a name="40645"/>40645: 
<a name="40646"/>40646: 
<a name="40647"/>40647:     TesterSeq =
<a name="40648"/>40648:         [
<a name="40649"/>40649:          %% *** Init part ***
<a name="40650"/>40650:          #{desc =&gt; &quot;monitor server&quot;,
<a name="40651"/>40651:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="40652"/>40652:                            _MRef = erlang:monitor(process, Pid),
<a name="40653"/>40653:                            ok
<a name="40654"/>40654:                    end},
<a name="40655"/>40655:          #{desc =&gt; &quot;monitor client&quot;,
<a name="40656"/>40656:            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;
<a name="40657"/>40657:                            _MRef = erlang:monitor(process, Pid),
<a name="40658"/>40658:                            ok
<a name="40659"/>40659:                    end},
<a name="40660"/>40660: 
<a name="40661"/>40661:          %% Start the server
<a name="40662"/>40662:          #{desc =&gt; &quot;order server start&quot;,
<a name="40663"/>40663:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="40664"/>40664:                            ?SEV_ANNOUNCE_START(Pid),
<a name="40665"/>40665:                            ok
<a name="40666"/>40666:                    end},
<a name="40667"/>40667:          #{desc =&gt; &quot;await server ready (init)&quot;,
<a name="40668"/>40668:            cmd  =&gt; fun(#{domain := local,
<a name="40669"/>40669:                          server := Pid} = State) -&gt;
<a name="40670"/>40670:                            {ok, Path} = ?SEV_AWAIT_READY(Pid, server, init),
<a name="40671"/>40671:                            {ok, State#{path =&gt; Path}};
<a name="40672"/>40672:                       (#{server := Pid} = State) -&gt;
<a name="40673"/>40673:                            {ok, Port} = ?SEV_AWAIT_READY(Pid, server, init),
<a name="40674"/>40674:                            {ok, State#{port =&gt; Port}}
<a name="40675"/>40675:                    end},
<a name="40676"/>40676: 
<a name="40677"/>40677:          %% Start the client
<a name="40678"/>40678:          #{desc =&gt; &quot;order client start&quot;,
<a name="40679"/>40679:            cmd  =&gt; fun(#{domain := local,
<a name="40680"/>40680:                          client := Pid,
<a name="40681"/>40681:                          path   := Path} = _State) -&gt;
<a name="40682"/>40682:                            ?SEV_ANNOUNCE_START(Pid, Path),
<a name="40683"/>40683:                            ok;
<a name="40684"/>40684:                       (#{client := Pid,
<a name="40685"/>40685:                          port   := Port} = _State) -&gt;
<a name="40686"/>40686:                            ?SEV_ANNOUNCE_START(Pid, Port),
<a name="40687"/>40687:                            ok
<a name="40688"/>40688:                    end},
<a name="40689"/>40689:          #{desc =&gt; &quot;await client ready (init)&quot;,
<a name="40690"/>40690:            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;
<a name="40691"/>40691:                            ok = ?SEV_AWAIT_READY(Pid, client, init)
<a name="40692"/>40692:                    end},
<a name="40693"/>40693: 
<a name="40694"/>40694:          %% *** The actual test ***
<a name="40695"/>40695: 
<a name="40696"/>40696:          #{desc =&gt; &quot;order server to continue (recv_and_validate 1)&quot;,
<a name="40697"/>40697:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="40698"/>40698:                            ?SEV_ANNOUNCE_CONTINUE(Server, recv_and_validate),
<a name="40699"/>40699:                            ok
<a name="40700"/>40700:                    end},
<a name="40701"/>40701:          #{desc =&gt; &quot;order client to continue (send_and_validate 1)&quot;,
<a name="40702"/>40702:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="40703"/>40703:                            ?SEV_ANNOUNCE_CONTINUE(Client, send_and_validate),
<a name="40704"/>40704:                            ok
<a name="40705"/>40705:                    end},
<a name="40706"/>40706:          #{desc =&gt; &quot;await client ready (send_and_validate 1)&quot;,
<a name="40707"/>40707:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="40708"/>40708:                            ?SEV_AWAIT_READY(Client, client, send_and_validate)
<a name="40709"/>40709:                    end},
<a name="40710"/>40710:          #{desc =&gt; &quot;await server ready (recv_and_validate 1)&quot;,
<a name="40711"/>40711:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="40712"/>40712:                            ?SEV_AWAIT_READY(Server, server, recv_and_validate)
<a name="40713"/>40713:                    end},
<a name="40714"/>40714: 
<a name="40715"/>40715:          ?SEV_SLEEP(?SECS(1)),
<a name="40716"/>40716: 
<a name="40717"/>40717:          #{desc =&gt; &quot;order client to continue (recv_and_validate 1)&quot;,
<a name="40718"/>40718:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="40719"/>40719:                            ?SEV_ANNOUNCE_CONTINUE(Client, recv_and_validate),
<a name="40720"/>40720:                            ok
<a name="40721"/>40721:                    end},
<a name="40722"/>40722:          #{desc =&gt; &quot;order server to continue (send_and_validate 1)&quot;,
<a name="40723"/>40723:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="40724"/>40724:                            ?SEV_ANNOUNCE_CONTINUE(Server, send_and_validate),
<a name="40725"/>40725:                            ok
<a name="40726"/>40726:                    end},
<a name="40727"/>40727:          #{desc =&gt; &quot;await server ready (send_and_validate 1)&quot;,
<a name="40728"/>40728:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="40729"/>40729:                            ?SEV_AWAIT_READY(Server, server, send_and_validate)
<a name="40730"/>40730:                    end},
<a name="40731"/>40731:          #{desc =&gt; &quot;await client ready (recv_and_validate 1)&quot;,
<a name="40732"/>40732:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="40733"/>40733:                            ?SEV_AWAIT_READY(Client, client, recv_and_validate)
<a name="40734"/>40734:                    end},
<a name="40735"/>40735: 
<a name="40736"/>40736:          ?SEV_SLEEP(?SECS(1)),
<a name="40737"/>40737: 
<a name="40738"/>40738:          #{desc =&gt; &quot;order server to continue (recv_and_validate 2)&quot;,
<a name="40739"/>40739:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="40740"/>40740:                            ?SEV_ANNOUNCE_CONTINUE(Server, recv_and_validate),
<a name="40741"/>40741:                            ok
<a name="40742"/>40742:                    end},
<a name="40743"/>40743:          #{desc =&gt; &quot;order client to continue (send_and_validate 2)&quot;,
<a name="40744"/>40744:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="40745"/>40745:                            ?SEV_ANNOUNCE_CONTINUE(Client, send_and_validate),
<a name="40746"/>40746:                            ok
<a name="40747"/>40747:                    end},
<a name="40748"/>40748:          #{desc =&gt; &quot;await client ready (send_and_validate 2)&quot;,
<a name="40749"/>40749:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="40750"/>40750:                            ?SEV_AWAIT_READY(Client, client, send_and_validate)
<a name="40751"/>40751:                    end},
<a name="40752"/>40752:          #{desc =&gt; &quot;await server ready (recv_and_validate 2)&quot;,
<a name="40753"/>40753:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="40754"/>40754:                            ?SEV_AWAIT_READY(Server, server, recv_and_validate)
<a name="40755"/>40755:                    end},
<a name="40756"/>40756: 
<a name="40757"/>40757:          ?SEV_SLEEP(?SECS(1)),
<a name="40758"/>40758: 
<a name="40759"/>40759:          #{desc =&gt; &quot;order client to continue (recv_and_validate 2)&quot;,
<a name="40760"/>40760:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="40761"/>40761:                            ?SEV_ANNOUNCE_CONTINUE(Client, recv_and_validate),
<a name="40762"/>40762:                            ok
<a name="40763"/>40763:                    end},
<a name="40764"/>40764:          #{desc =&gt; &quot;order server to continue (send_and_validate 2)&quot;,
<a name="40765"/>40765:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="40766"/>40766:                            ?SEV_ANNOUNCE_CONTINUE(Server, send_and_validate),
<a name="40767"/>40767:                            ok
<a name="40768"/>40768:                    end},
<a name="40769"/>40769:          #{desc =&gt; &quot;await server ready (send_and_validate 2)&quot;,
<a name="40770"/>40770:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="40771"/>40771:                            ?SEV_AWAIT_READY(Server, server, send_and_validate)
<a name="40772"/>40772:                    end},
<a name="40773"/>40773:          #{desc =&gt; &quot;await client ready (recv_and_validate 2)&quot;,
<a name="40774"/>40774:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="40775"/>40775:                            ?SEV_AWAIT_READY(Client, client, recv_and_validate)
<a name="40776"/>40776:                    end},
<a name="40777"/>40777: 
<a name="40778"/>40778:          %% *** Termination ***
<a name="40779"/>40779:          #{desc =&gt; &quot;order client to terminate&quot;,
<a name="40780"/>40780:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="40781"/>40781:                            ?SEV_ANNOUNCE_TERMINATE(Client),
<a name="40782"/>40782:                            ok
<a name="40783"/>40783:                    end},
<a name="40784"/>40784:          #{desc =&gt; &quot;await client termination&quot;,
<a name="40785"/>40785:            cmd  =&gt; fun(#{client := Client} = State) -&gt;
<a name="40786"/>40786:                            ?SEV_AWAIT_TERMINATION(Client),
<a name="40787"/>40787:                            State1 = maps:remove(client, State),
<a name="40788"/>40788:                            {ok, State1}
<a name="40789"/>40789:                    end},
<a name="40790"/>40790:          #{desc =&gt; &quot;order server to terminate&quot;,
<a name="40791"/>40791:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="40792"/>40792:                            ?SEV_ANNOUNCE_TERMINATE(Server),
<a name="40793"/>40793:                            ok
<a name="40794"/>40794:                    end},
<a name="40795"/>40795:          #{desc =&gt; &quot;await server termination&quot;,
<a name="40796"/>40796:            cmd  =&gt; fun(#{server := Server} = State) -&gt;
<a name="40797"/>40797:                            ?SEV_AWAIT_TERMINATION(Server),
<a name="40798"/>40798:                            State1 = maps:remove(server, State),
<a name="40799"/>40799:                            {ok, State1}
<a name="40800"/>40800:                    end},
<a name="40801"/>40801: 
<a name="40802"/>40802:          %% *** We are done ***
<a name="40803"/>40803:          ?SEV_FINISH_NORMAL
<a name="40804"/>40804:         ],
<a name="40805"/>40805: 
<a name="40806"/>40806:     i(&quot;start server evaluator&quot;),
<a name="40807"/>40807:     ServerInitState = InitState#{host =&gt; local_host()},
<a name="40808"/>40808:     Server = ?SEV_START(&quot;server&quot;, ServerSeq, ServerInitState),
<a name="40809"/>40809: 
<a name="40810"/>40810:     i(&quot;start client evaluator(s)&quot;),
<a name="40811"/>40811:     ClientInitState = InitState#{host =&gt; local_host()},
<a name="40812"/>40812:     Client = ?SEV_START(&quot;client&quot;, ClientSeq, ClientInitState),
<a name="40813"/>40813: 
<a name="40814"/>40814:     i(&quot;start 'tester' evaluator&quot;),
<a name="40815"/>40815:     TesterInitState = #{server =&gt; Server#ev.pid,
<a name="40816"/>40816:                         client =&gt; Client#ev.pid},
<a name="40817"/>40817:     Tester = ?SEV_START(&quot;tester&quot;, TesterSeq, TesterInitState),
<a name="40818"/>40818: 
<a name="40819"/>40819:     i(&quot;await evaluator&quot;),
<a name="traffic_send_and_recv_udp-last_expr"/><a name="40820"/>40820: <b>    ok = ?SEV_AWAIT_FINISH</b>([Server, Client, Tester]).
<a name="40821"/>40821: 
<a name="40822"/>40822: 
<a name="40823"/>40823: 
<a name="40824"/>40824: 
<a name="40825"/>40825: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="40826"/>40826: <i>%% This test case is intended to test that the send and recv functions</i>
<a name="40827"/>40827: <i>%% behave as expected when sending and/or reading chunks.</i>
<a name="40828"/>40828: <i>%% First send data in one &quot;big&quot; chunk, and read it in &quot;small&quot; chunks.</i>
<a name="40829"/>40829: <i>%% Second, send in a bunch of &quot;small&quot; chunks, and read in one &quot;big&quot; chunk.</i>
<a name="40830"/>40830: <i>%% Socket is IPv4.</i>
<a name="40831"/>40831: 
<a name="traffic_send_and_recv_chunks_tcp4-1"/><a name="40832"/>40832: <b>traffic_send_and_recv_chunks_tcp4</b>(_Config) when is_list(_Config) -&gt;
<a name="40833"/>40833:     ?TT(?SECS(30)),
<a name="traffic_send_and_recv_chunks_tcp4-last_expr"/><a name="40834"/>40834: <b>    tc_try</b>(traffic_send_and_recv_chunks_tcp4,
<a name="40835"/>40835:            fun() -&gt; has_support_ipv4() end,
<a name="40836"/>40836:            fun() -&gt;
<a name="40837"/>40837:                    InitState = #{domain =&gt; inet,
<a name="40838"/>40838:                                  proto  =&gt; tcp},
<a name="40839"/>40839:                    ok = traffic_send_and_recv_chunks_tcp(InitState)
<a name="40840"/>40840:            end).
<a name="40841"/>40841: 
<a name="40842"/>40842: 
<a name="40843"/>40843: 
<a name="40844"/>40844: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="40845"/>40845: <i>%% This test case is intended to test that the send and recv functions</i>
<a name="40846"/>40846: <i>%% behave as expected when sending and/or reading chunks.</i>
<a name="40847"/>40847: <i>%% First send data in one &quot;big&quot; chunk, and read it in &quot;small&quot; chunks.</i>
<a name="40848"/>40848: <i>%% Second, send in a bunch of &quot;small&quot; chunks, and read in one &quot;big&quot; chunk.</i>
<a name="40849"/>40849: <i>%% Socket is IPv6.</i>
<a name="40850"/>40850: 
<a name="traffic_send_and_recv_chunks_tcp6-1"/><a name="40851"/>40851: <b>traffic_send_and_recv_chunks_tcp6</b>(_Config) when is_list(_Config) -&gt;
<a name="40852"/>40852:     ?TT(?SECS(30)),
<a name="traffic_send_and_recv_chunks_tcp6-last_expr"/><a name="40853"/>40853: <b>    tc_try</b>(traffic_send_and_recv_chunks_tcp6,
<a name="40854"/>40854:            fun() -&gt; has_support_ipv6() end,
<a name="40855"/>40855:            fun() -&gt;
<a name="40856"/>40856:                    InitState = #{domain =&gt; inet6,
<a name="40857"/>40857:                                  proto  =&gt; tcp},
<a name="40858"/>40858:                    ok = traffic_send_and_recv_chunks_tcp(InitState)
<a name="40859"/>40859:            end).
<a name="40860"/>40860: 
<a name="40861"/>40861: 
<a name="40862"/>40862: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="40863"/>40863: <i>%% This test case is intended to test that the send and recv functions</i>
<a name="40864"/>40864: <i>%% behave as expected when sending and/or reading chunks.</i>
<a name="40865"/>40865: <i>%% First send data in one &quot;big&quot; chunk, and read it in &quot;small&quot; chunks.</i>
<a name="40866"/>40866: <i>%% Second, send in a bunch of &quot;small&quot; chunks, and read in one &quot;big&quot; chunk.</i>
<a name="40867"/>40867: <i>%% Socket is UNix Domain (Stream) socket.</i>
<a name="40868"/>40868: 
<a name="traffic_send_and_recv_chunks_tcpL-1"/><a name="40869"/>40869: <b>traffic_send_and_recv_chunks_tcpL</b>(_Config) when is_list(_Config) -&gt;
<a name="40870"/>40870:     ?TT(?SECS(30)),
<a name="traffic_send_and_recv_chunks_tcpL-last_expr"/><a name="40871"/>40871: <b>    tc_try</b>(traffic_send_and_recv_chunks_tcp6,
<a name="40872"/>40872:            fun() -&gt; has_support_unix_domain_socket() end,
<a name="40873"/>40873:            fun() -&gt;
<a name="40874"/>40874:                    InitState = #{domain =&gt; local,
<a name="40875"/>40875:                                  proto  =&gt; default},
<a name="40876"/>40876:                    ok = traffic_send_and_recv_chunks_tcp(InitState)
<a name="40877"/>40877:            end).
<a name="40878"/>40878: 
<a name="40879"/>40879: 
<a name="40880"/>40880: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="40881"/>40881: 
<a name="traffic_send_and_recv_chunks_tcp-1"/><a name="40882"/>40882: <b>traffic_send_and_recv_chunks_tcp</b>(InitState) -&gt;
<a name="40883"/>40883:     ServerSeq =
<a name="40884"/>40884:         [
<a name="40885"/>40885:          %% *** Wait for start order part ***
<a name="40886"/>40886:          #{desc =&gt; &quot;await start&quot;,
<a name="40887"/>40887:            cmd  =&gt; fun(State) -&gt;
<a name="40888"/>40888:                            Tester = ?SEV_AWAIT_START(),
<a name="40889"/>40889:                            {ok, State#{tester =&gt; Tester}}
<a name="40890"/>40890:                    end},
<a name="40891"/>40891:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="40892"/>40892:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="40893"/>40893:                            _MRef = erlang:monitor(process, Tester),
<a name="40894"/>40894:                            ok
<a name="40895"/>40895:                    end},
<a name="40896"/>40896: 
<a name="40897"/>40897:          %% *** Init part ***
<a name="40898"/>40898:          #{desc =&gt; &quot;which local address&quot;,
<a name="40899"/>40899:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="40900"/>40900:                            LSA = which_local_socket_addr(Domain),
<a name="40901"/>40901:                            {ok, State#{local_sa =&gt; LSA}}
<a name="40902"/>40902:                    end},
<a name="40903"/>40903:          #{desc =&gt; &quot;create listen socket&quot;,
<a name="40904"/>40904:            cmd  =&gt; fun(#{domain := Domain, proto := Proto} = State) -&gt;
<a name="40905"/>40905:                            case socket:open(Domain, stream, Proto) of
<a name="40906"/>40906:                                {ok, Sock} -&gt;
<a name="40907"/>40907:                                    {ok, State#{lsock =&gt; Sock}};
<a name="40908"/>40908:                                {error, _} = ERROR -&gt;
<a name="40909"/>40909:                                    ERROR
<a name="40910"/>40910:                            end
<a name="40911"/>40911:                    end},
<a name="40912"/>40912:          #{desc =&gt; &quot;bind to local address&quot;,
<a name="40913"/>40913:            cmd  =&gt; fun(#{domain   := local,
<a name="40914"/>40914:                          lsock    := LSock,
<a name="40915"/>40915:                          local_sa := LSA} = _State) -&gt;
<a name="40916"/>40916:                            case socket:bind(LSock, LSA) of
<a name="40917"/>40917:                                ok -&gt;
<a name="40918"/>40918:                                    ok; % We do not care about the port for local
<a name="40919"/>40919:                                {error, _} = ERROR -&gt;
<a name="40920"/>40920:                                    ERROR
<a name="40921"/>40921:                            end;
<a name="40922"/>40922:                       (#{lsock    := LSock,
<a name="40923"/>40923:                          local_sa := LSA} = State) -&gt;
<a name="40924"/>40924:                            case sock_bind(LSock, LSA) of
<a name="40925"/>40925:                                ok -&gt;
<a name="40926"/>40926:                                    Port = sock_port(LSock),
<a name="40927"/>40927:                                    {ok, State#{lport =&gt; Port}};
<a name="40928"/>40928:                                {error, _} = ERROR -&gt;
<a name="40929"/>40929:                                    ERROR
<a name="40930"/>40930:                            end
<a name="40931"/>40931:                    end},
<a name="40932"/>40932:          #{desc =&gt; &quot;make listen socket&quot;,
<a name="40933"/>40933:            cmd  =&gt; fun(#{lsock := LSock}) -&gt;
<a name="40934"/>40934:                            socket:listen(LSock)
<a name="40935"/>40935:                    end},
<a name="40936"/>40936:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="40937"/>40937:            cmd  =&gt; fun(#{domain   := local,
<a name="40938"/>40938:                          tester   := Tester,
<a name="40939"/>40939:                          local_sa := LSA}) -&gt;
<a name="40940"/>40940:                            ?SEV_ANNOUNCE_READY(Tester, init, LSA),
<a name="40941"/>40941:                            ok;
<a name="40942"/>40942:                       (#{tester   := Tester,
<a name="40943"/>40943:                          local_sa := LSA,
<a name="40944"/>40944:                          lport    := Port}) -&gt;
<a name="40945"/>40945:                            ServerSA = LSA#{port =&gt; Port},
<a name="40946"/>40946:                            ?SEV_ANNOUNCE_READY(Tester, init, ServerSA),
<a name="40947"/>40947:                            ok
<a name="40948"/>40948:                    end},
<a name="40949"/>40949: 
<a name="40950"/>40950:          %% The actual test
<a name="40951"/>40951:          #{desc =&gt; &quot;await continue (accept)&quot;,
<a name="40952"/>40952:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="40953"/>40953:                            ?SEV_AWAIT_CONTINUE(Tester, tester, accept)
<a name="40954"/>40954:                    end},
<a name="40955"/>40955:          #{desc =&gt; &quot;accept&quot;,
<a name="40956"/>40956:            cmd  =&gt; fun(#{lsock := LSock} = State) -&gt;
<a name="40957"/>40957:                            case socket:accept(LSock) of
<a name="40958"/>40958:                                {ok, Sock} -&gt;
<a name="40959"/>40959:                                    {ok, State#{csock =&gt; Sock}};
<a name="40960"/>40960:                                {error, _} = ERROR -&gt;
<a name="40961"/>40961:                                    ERROR
<a name="40962"/>40962:                            end
<a name="40963"/>40963:                    end},
<a name="40964"/>40964:          #{desc =&gt; &quot;announce ready (accept)&quot;,
<a name="40965"/>40965:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="40966"/>40966:                            ?SEV_ANNOUNCE_READY(Tester, accept),
<a name="40967"/>40967:                            ok
<a name="40968"/>40968:                    end},
<a name="40969"/>40969: 
<a name="40970"/>40970:          #{desc =&gt; &quot;await continue (recv-many-small)&quot;,
<a name="40971"/>40971:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="40972"/>40972:                            ?SEV_AWAIT_CONTINUE(Tester, tester, recv_many_small)
<a name="40973"/>40973:                    end},
<a name="40974"/>40974:          #{desc =&gt; &quot;recv chunk 1&quot;,
<a name="40975"/>40975:            cmd  =&gt; fun(#{csock := Sock} = State) -&gt;
<a name="40976"/>40976:                            case socket:recv(Sock, 100) of
<a name="40977"/>40977:                                {ok, Chunk} -&gt;
<a name="40978"/>40978:                                    ?SEV_IPRINT(&quot;recv of chunk 1 of ~p bytes&quot;,
<a name="40979"/>40979:                                                [size(Chunk)]),
<a name="40980"/>40980:                                    {ok, State#{chunks =&gt; [b2l(Chunk)]}};
<a name="40981"/>40981:                                {error, _} = ERROR -&gt;
<a name="40982"/>40982:                                    ERROR
<a name="40983"/>40983:                            end
<a name="40984"/>40984:                    end},
<a name="40985"/>40985:          #{desc =&gt; &quot;recv chunk 2&quot;,
<a name="40986"/>40986:            cmd  =&gt; fun(#{csock  := Sock,
<a name="40987"/>40987:                          chunks := Chunks} = State) -&gt;
<a name="40988"/>40988:                            case socket:recv(Sock, 100) of
<a name="40989"/>40989:                                {ok, Chunk} -&gt;
<a name="40990"/>40990:                                    ?SEV_IPRINT(&quot;recv of chunk 2 of ~p bytes&quot;,
<a name="40991"/>40991:                                                [size(Chunk)]),
<a name="40992"/>40992:                                    {ok, State#{chunks =&gt; [b2l(Chunk)|Chunks]}};
<a name="40993"/>40993:                                {error, _} = ERROR -&gt;
<a name="40994"/>40994:                                    ERROR
<a name="40995"/>40995:                            end
<a name="40996"/>40996:                    end},
<a name="40997"/>40997:          #{desc =&gt; &quot;recv chunk 3&quot;,
<a name="40998"/>40998:            cmd  =&gt; fun(#{csock  := Sock,
<a name="40999"/>40999:                          chunks := Chunks} = State) -&gt;
<a name="41000"/>41000:                            case socket:recv(Sock, 100) of
<a name="41001"/>41001:                                {ok, Chunk} -&gt;
<a name="41002"/>41002:                                    ?SEV_IPRINT(&quot;recv of chunk 3 of ~p bytes&quot;,
<a name="41003"/>41003:                                                [size(Chunk)]),
<a name="41004"/>41004:                                    {ok, State#{chunks =&gt; [b2l(Chunk)|Chunks]}};
<a name="41005"/>41005:                                {error, _} = ERROR -&gt;
<a name="41006"/>41006:                                    ERROR
<a name="41007"/>41007:                            end
<a name="41008"/>41008:                    end},
<a name="41009"/>41009:          #{desc =&gt; &quot;recv chunk 4&quot;,
<a name="41010"/>41010:            cmd  =&gt; fun(#{csock  := Sock,
<a name="41011"/>41011:                          chunks := Chunks} = State) -&gt;
<a name="41012"/>41012:                            case socket:recv(Sock, 100) of
<a name="41013"/>41013:                                {ok, Chunk} -&gt;
<a name="41014"/>41014:                                    ?SEV_IPRINT(&quot;recv of chunk 4 of ~p bytes&quot;,
<a name="41015"/>41015:                                                [size(Chunk)]),
<a name="41016"/>41016:                                    {ok, State#{chunks =&gt; [b2l(Chunk)|Chunks]}};
<a name="41017"/>41017:                                {error, _} = ERROR -&gt;
<a name="41018"/>41018:                                    ERROR
<a name="41019"/>41019:                            end
<a name="41020"/>41020:                    end},
<a name="41021"/>41021:          #{desc =&gt; &quot;recv chunk 5&quot;,
<a name="41022"/>41022:            cmd  =&gt; fun(#{csock  := Sock,
<a name="41023"/>41023:                          chunks := Chunks} = State) -&gt;
<a name="41024"/>41024:                            case socket:recv(Sock, 100) of
<a name="41025"/>41025:                                {ok, Chunk} -&gt;
<a name="41026"/>41026:                                    ?SEV_IPRINT(&quot;recv of chunk 5 of ~p bytes&quot;,
<a name="41027"/>41027:                                                [size(Chunk)]),
<a name="41028"/>41028:                                    {ok, State#{chunks =&gt; [b2l(Chunk)|Chunks]}};
<a name="41029"/>41029:                                {error, _} = ERROR -&gt;
<a name="41030"/>41030:                                    ERROR
<a name="41031"/>41031:                            end
<a name="41032"/>41032:                    end},
<a name="41033"/>41033:          #{desc =&gt; &quot;recv chunk 6&quot;,
<a name="41034"/>41034:            cmd  =&gt; fun(#{csock  := Sock,
<a name="41035"/>41035:                          chunks := Chunks} = State) -&gt;
<a name="41036"/>41036:                            case socket:recv(Sock, 100) of
<a name="41037"/>41037:                                {ok, Chunk} -&gt;
<a name="41038"/>41038:                                    ?SEV_IPRINT(&quot;recv of chunk 6 of ~p bytes&quot;,
<a name="41039"/>41039:                                                [size(Chunk)]),
<a name="41040"/>41040:                                    {ok, State#{chunks =&gt; [b2l(Chunk)|Chunks]}};
<a name="41041"/>41041:                                {error, _} = ERROR -&gt;
<a name="41042"/>41042:                                    ERROR
<a name="41043"/>41043:                            end
<a name="41044"/>41044:                    end},
<a name="41045"/>41045:          #{desc =&gt; &quot;recv chunk 7&quot;,
<a name="41046"/>41046:            cmd  =&gt; fun(#{csock  := Sock,
<a name="41047"/>41047:                          chunks := Chunks} = State) -&gt;
<a name="41048"/>41048:                            case socket:recv(Sock, 100) of
<a name="41049"/>41049:                                {ok, Chunk} -&gt;
<a name="41050"/>41050:                                    ?SEV_IPRINT(&quot;recv of chunk 7 of ~p bytes&quot;,
<a name="41051"/>41051:                                                [size(Chunk)]),
<a name="41052"/>41052:                                    {ok, State#{chunks =&gt; [b2l(Chunk)|Chunks]}};
<a name="41053"/>41053:                                {error, _} = ERROR -&gt;
<a name="41054"/>41054:                                    ERROR
<a name="41055"/>41055:                            end
<a name="41056"/>41056:                    end},
<a name="41057"/>41057:          #{desc =&gt; &quot;recv chunk 8&quot;,
<a name="41058"/>41058:            cmd  =&gt; fun(#{csock  := Sock,
<a name="41059"/>41059:                          chunks := Chunks} = State) -&gt;
<a name="41060"/>41060:                            case socket:recv(Sock, 100) of
<a name="41061"/>41061:                                {ok, Chunk} -&gt;
<a name="41062"/>41062:                                    ?SEV_IPRINT(&quot;recv of chunk 8 of ~p bytes&quot;,
<a name="41063"/>41063:                                                [size(Chunk)]),
<a name="41064"/>41064:                                    {ok, State#{chunks =&gt; [b2l(Chunk)|Chunks]}};
<a name="41065"/>41065:                                {error, _} = ERROR -&gt;
<a name="41066"/>41066:                                    ERROR
<a name="41067"/>41067:                            end
<a name="41068"/>41068:                    end},
<a name="41069"/>41069:          #{desc =&gt; &quot;recv chunk 9&quot;,
<a name="41070"/>41070:            cmd  =&gt; fun(#{csock  := Sock,
<a name="41071"/>41071:                          chunks := Chunks} = State) -&gt;
<a name="41072"/>41072:                            case socket:recv(Sock, 100) of
<a name="41073"/>41073:                                {ok, Chunk} -&gt;
<a name="41074"/>41074:                                    ?SEV_IPRINT(&quot;recv of chunk 9 of ~p bytes&quot;,
<a name="41075"/>41075:                                                [size(Chunk)]),
<a name="41076"/>41076:                                    {ok, State#{chunks =&gt; [b2l(Chunk)|Chunks]}};
<a name="41077"/>41077:                                {error, _} = ERROR -&gt;
<a name="41078"/>41078:                                    ERROR
<a name="41079"/>41079:                            end
<a name="41080"/>41080:                    end},
<a name="41081"/>41081:          #{desc =&gt; &quot;recv chunk 10&quot;,
<a name="41082"/>41082:            cmd  =&gt; fun(#{csock  := Sock,
<a name="41083"/>41083:                          chunks := Chunks} = State) -&gt;
<a name="41084"/>41084:                            case socket:recv(Sock, 100) of
<a name="41085"/>41085:                                {ok, Chunk} -&gt;
<a name="41086"/>41086:                                    ?SEV_IPRINT(&quot;recv of chunk 10 of ~p bytes&quot;,
<a name="41087"/>41087:                                                [size(Chunk)]),
<a name="41088"/>41088:                                    {ok, State#{chunks =&gt; [b2l(Chunk)|Chunks]}};
<a name="41089"/>41089:                                {error, _} = ERROR -&gt;
<a name="41090"/>41090:                                    ERROR
<a name="41091"/>41091:                            end
<a name="41092"/>41092:                    end},
<a name="41093"/>41093:          #{desc =&gt; &quot;announce ready (recv-many-small)&quot;,
<a name="41094"/>41094:            cmd  =&gt; fun(#{tester := Tester,
<a name="41095"/>41095:                          chunks := Chunks} = State) -&gt;
<a name="41096"/>41096:                            Data = lists:flatten(lists:reverse(Chunks)),
<a name="41097"/>41097:                            ?SEV_ANNOUNCE_READY(Tester, recv_many_small, Data),
<a name="41098"/>41098:                            {ok, maps:remove(chunks, State)}
<a name="41099"/>41099:                    end},
<a name="41100"/>41100: 
<a name="41101"/>41101:          #{desc =&gt; &quot;await continue (recv-one-big)&quot;,
<a name="41102"/>41102:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="41103"/>41103:                            case ?SEV_AWAIT_CONTINUE(Tester, tester, recv_one_big) of
<a name="41104"/>41104:                                {ok, Size} -&gt;
<a name="41105"/>41105:                                    {ok, State#{size =&gt; Size}};
<a name="41106"/>41106:                                {error, _} = ERROR -&gt;
<a name="41107"/>41107:                                    ERROR
<a name="41108"/>41108:                            end
<a name="41109"/>41109:                    end},
<a name="41110"/>41110:          #{desc =&gt; &quot;recv (one big)&quot;,
<a name="41111"/>41111:            cmd  =&gt; fun(#{tester := Tester, csock := Sock, size := Size} = _State) -&gt;
<a name="41112"/>41112:                            %% socket:setopt(Sock, otp, debug, true),
<a name="41113"/>41113:                            case socket:recv(Sock, Size) of
<a name="41114"/>41114:                                {ok, Data} -&gt;
<a name="41115"/>41115:                                    ?SEV_ANNOUNCE_READY(Tester,
<a name="41116"/>41116:                                                        recv_one_big,
<a name="41117"/>41117:                                                        b2l(Data)),
<a name="41118"/>41118:                                    ok;
<a name="41119"/>41119:                                {error, _} = ERROR -&gt;
<a name="41120"/>41120:                                    ERROR
<a name="41121"/>41121:                            end
<a name="41122"/>41122:                    end},
<a name="41123"/>41123: 
<a name="41124"/>41124:          #{desc =&gt; &quot;await terminate (from tester)&quot;,
<a name="41125"/>41125:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="41126"/>41126:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="41127"/>41127:                                ok -&gt;
<a name="41128"/>41128:                                    {ok, maps:remove(tester, State)};
<a name="41129"/>41129:                                {error, _} = ERROR -&gt;
<a name="41130"/>41130:                                    ERROR
<a name="41131"/>41131:                            end
<a name="41132"/>41132:                    end},
<a name="41133"/>41133:          #{desc =&gt; &quot;close connection socket (just in case)&quot;,
<a name="41134"/>41134:            cmd  =&gt; fun(#{csock := Sock} = State) -&gt;
<a name="41135"/>41135:                            (catch socket:close(Sock)),
<a name="41136"/>41136:                            {ok, maps:remove(csock, State)}
<a name="41137"/>41137:                    end},
<a name="41138"/>41138:          #{desc =&gt; &quot;close listen socket&quot;,
<a name="41139"/>41139:            cmd  =&gt; fun(#{domain   := local,
<a name="41140"/>41140:                          lsock    := Sock,
<a name="41141"/>41141:                          local_sa := #{path := Path}} = State) -&gt;
<a name="41142"/>41142:                            ok = socket:close(Sock),
<a name="41143"/>41143:                            State1 =
<a name="41144"/>41144:                                unlink_path(Path,
<a name="41145"/>41145:                                            fun() -&gt;
<a name="41146"/>41146:                                                    maps:remove(local_sa, State)
<a name="41147"/>41147:                                            end,
<a name="41148"/>41148:                                            fun() -&gt; State end),
<a name="41149"/>41149:                            {ok, maps:remove(lsock, State1)};
<a name="41150"/>41150:                       (#{lsock := Sock} = State) -&gt;
<a name="41151"/>41151:                            (catch socket:close(Sock)),
<a name="41152"/>41152:                            {ok, maps:remove(lsock, State)}
<a name="41153"/>41153:                    end},
<a name="41154"/>41154: 
<a name="41155"/>41155:          %% *** We are done ***
<a name="41156"/>41156:          ?SEV_FINISH_NORMAL
<a name="41157"/>41157:         ],
<a name="41158"/>41158: 
<a name="41159"/>41159:     ClientSeq =
<a name="41160"/>41160:         [
<a name="41161"/>41161:          %% *** Wait for start order part ***
<a name="41162"/>41162:          #{desc =&gt; &quot;await start&quot;,
<a name="41163"/>41163:            cmd  =&gt; fun(State) -&gt;
<a name="41164"/>41164:                            {Tester, ServerSA} = ?SEV_AWAIT_START(),
<a name="41165"/>41165:                            {ok, State#{tester    =&gt; Tester,
<a name="41166"/>41166:                                        server_sa =&gt; ServerSA}}
<a name="41167"/>41167:                    end},
<a name="41168"/>41168:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="41169"/>41169:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="41170"/>41170:                            _MRef = erlang:monitor(process, Tester),
<a name="41171"/>41171:                            ok
<a name="41172"/>41172:                    end},
<a name="41173"/>41173: 
<a name="41174"/>41174:          %% *** Init part ***
<a name="41175"/>41175:          #{desc =&gt; &quot;create node&quot;,
<a name="41176"/>41176:            cmd  =&gt; fun(State) -&gt;
<a name="41177"/>41177:                            {Peer, Node} = ?START_NODE(&quot;client&quot;),
<a name="41178"/>41178:                            {ok, State#{peer =&gt; Peer, node =&gt; Node}}
<a name="41179"/>41179:                    end},
<a name="41180"/>41180:          #{desc =&gt; &quot;monitor client node&quot;,
<a name="41181"/>41181:            cmd  =&gt; fun(#{node := Node} = _State) -&gt;
<a name="41182"/>41182:                            true = erlang:monitor_node(Node, true),
<a name="41183"/>41183:                            ok
<a name="41184"/>41184:                    end},
<a name="41185"/>41185:          #{desc =&gt; &quot;start remote client&quot;,
<a name="41186"/>41186:            cmd  =&gt; fun(#{node := Node} = State) -&gt;
<a name="41187"/>41187:                            Pid = traffic_snr_tcp_client_start(Node),
<a name="41188"/>41188:                            ?SEV_IPRINT(&quot;client ~p started&quot;, [Pid]),
<a name="41189"/>41189:                            {ok, State#{rclient =&gt; Pid}}
<a name="41190"/>41190:                    end},
<a name="41191"/>41191:          #{desc =&gt; &quot;monitor remote client&quot;,
<a name="41192"/>41192:            cmd  =&gt; fun(#{rclient := Pid}) -&gt;
<a name="41193"/>41193:                            _MRef = erlang:monitor(process, Pid),
<a name="41194"/>41194:                            ok
<a name="41195"/>41195:                    end},
<a name="41196"/>41196:          #{desc =&gt; &quot;order remote client to start&quot;,
<a name="41197"/>41197:            cmd  =&gt; fun(#{rclient   := Client,
<a name="41198"/>41198:                          server_sa := ServerSA,
<a name="41199"/>41199:                          proto     := Proto}) -&gt;
<a name="41200"/>41200:                            ?SEV_ANNOUNCE_START(Client, {ServerSA, Proto}),
<a name="41201"/>41201:                            ok
<a name="41202"/>41202:                    end},
<a name="41203"/>41203:          #{desc =&gt; &quot;await remote client ready&quot;,
<a name="41204"/>41204:            cmd  =&gt; fun(#{tester  := Tester,
<a name="41205"/>41205:                          rclient := Client} = _State) -&gt;
<a name="41206"/>41206:                            ?SEV_AWAIT_READY(Client, rclient, init,
<a name="41207"/>41207:                                             [{tester, Tester}])
<a name="41208"/>41208:                    end},
<a name="41209"/>41209:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="41210"/>41210:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="41211"/>41211:                            ?SEV_ANNOUNCE_READY(Tester, init),
<a name="41212"/>41212:                            ok
<a name="41213"/>41213:                    end},
<a name="41214"/>41214: 
<a name="41215"/>41215:          %% The actual test
<a name="41216"/>41216:          #{desc =&gt; &quot;await continue (connect)&quot;,
<a name="41217"/>41217:            cmd  =&gt; fun(#{tester  := Tester,
<a name="41218"/>41218:                          rclient := Client} = _State) -&gt;
<a name="41219"/>41219:                            ?SEV_AWAIT_CONTINUE(Tester, tester, connect,
<a name="41220"/>41220:                                                [{rclient, Client}]),
<a name="41221"/>41221:                            ok
<a name="41222"/>41222:                    end},
<a name="41223"/>41223:          #{desc =&gt; &quot;order remote client to continue (connect)&quot;,
<a name="41224"/>41224:            cmd  =&gt; fun(#{rclient := Client}) -&gt;
<a name="41225"/>41225:                            ?SEV_ANNOUNCE_CONTINUE(Client, connect),
<a name="41226"/>41226:                            ok
<a name="41227"/>41227:                    end},
<a name="41228"/>41228:          #{desc =&gt; &quot;await client process ready (connect)&quot;,
<a name="41229"/>41229:            cmd  =&gt; fun(#{tester  := Tester,
<a name="41230"/>41230:                          rclient := Client} = _State) -&gt;
<a name="41231"/>41231:                            ?SEV_AWAIT_READY(Client, rclient, connect,
<a name="41232"/>41232:                                             [{tester, Tester}])
<a name="41233"/>41233:                    end},
<a name="41234"/>41234:          #{desc =&gt; &quot;announce ready (connect)&quot;,
<a name="41235"/>41235:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="41236"/>41236:                            ?SEV_ANNOUNCE_READY(Tester, connect),
<a name="41237"/>41237:                            ok
<a name="41238"/>41238:                    end},
<a name="41239"/>41239: 
<a name="41240"/>41240:          #{desc =&gt; &quot;await continue (send-one-big)&quot;,
<a name="41241"/>41241:            cmd  =&gt; fun(#{tester  := Tester,
<a name="41242"/>41242:                          rclient := Client} = State) -&gt;
<a name="41243"/>41243:                            case ?SEV_AWAIT_CONTINUE(Tester, tester,
<a name="41244"/>41244:                                                     send_one_big,
<a name="41245"/>41245:                                                     [{rclient, Client}]) of
<a name="41246"/>41246:                                {ok, Data} -&gt;
<a name="41247"/>41247:                                    {ok, State#{data =&gt; Data}};
<a name="41248"/>41248:                                {error, _} = ERROR -&gt;
<a name="41249"/>41249:                                    ERROR
<a name="41250"/>41250:                            end
<a name="41251"/>41251:                    end},
<a name="41252"/>41252:          #{desc =&gt; &quot;order remote client to continue (send)&quot;,
<a name="41253"/>41253:            cmd  =&gt; fun(#{rclient := Client, data := Data}) -&gt;
<a name="41254"/>41254:                            ?SEV_ANNOUNCE_CONTINUE(Client, send, Data),
<a name="41255"/>41255:                            ok
<a name="41256"/>41256:                    end},
<a name="41257"/>41257:          #{desc =&gt; &quot;await client process ready (send)&quot;,
<a name="41258"/>41258:            cmd  =&gt; fun(#{tester  := Tester,
<a name="41259"/>41259:                          rclient := Client} = _State) -&gt;
<a name="41260"/>41260:                            case ?SEV_AWAIT_READY(Client, rclient, send,
<a name="41261"/>41261:                                                  [{tester, Tester}]) of
<a name="41262"/>41262:                                {ok, Result} -&gt;
<a name="41263"/>41263:                                    Result;
<a name="41264"/>41264:                                {error, _} = ERROR -&gt;
<a name="41265"/>41265:                                    ERROR
<a name="41266"/>41266:                            end
<a name="41267"/>41267:                    end},
<a name="41268"/>41268:          #{desc =&gt; &quot;announce ready (send-one-big)&quot;,
<a name="41269"/>41269:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="41270"/>41270:                            ?SEV_ANNOUNCE_READY(Tester, send_one_big),
<a name="41271"/>41271:                            ok
<a name="41272"/>41272:                    end},
<a name="41273"/>41273: 
<a name="41274"/>41274:          #{desc =&gt; &quot;await continue (send-many-small)&quot;,
<a name="41275"/>41275:            cmd  =&gt; fun(#{tester  := Tester,
<a name="41276"/>41276:                          rclient := Client} = State) -&gt;
<a name="41277"/>41277:                            case ?SEV_AWAIT_CONTINUE(Tester, tester,
<a name="41278"/>41278:                                                     send_many_small,
<a name="41279"/>41279:                                                     [{rclient, Client}]) of
<a name="41280"/>41280:                                {ok, Data} -&gt;
<a name="41281"/>41281:                                    {ok, State#{data =&gt; Data}};
<a name="41282"/>41282:                                {error, _} = ERROR -&gt;
<a name="41283"/>41283:                                    ERROR
<a name="41284"/>41284:                            end
<a name="41285"/>41285:                    end},
<a name="41286"/>41286:          #{desc =&gt; &quot;order remote client to continue (send chunk 1)&quot;,
<a name="41287"/>41287:            cmd  =&gt; fun(#{rclient := Client,
<a name="41288"/>41288:                          data    := Data} = State) -&gt;
<a name="41289"/>41289:                            {Chunk, RestData} = lists:split(100, Data),
<a name="41290"/>41290:                            %% ?SEV_IPRINT(&quot;order send of chunk 1: &quot;
<a name="41291"/>41291:                            %%             &quot;~n   Size: ~p&quot;
<a name="41292"/>41292:                            %%             &quot;~n   ~p&quot;, [length(Chunk), Chunk]),
<a name="41293"/>41293:                            ?SEV_ANNOUNCE_CONTINUE(Client, send, Chunk),
<a name="41294"/>41294:                            {ok, State#{data =&gt; RestData}}
<a name="41295"/>41295:                    end},
<a name="41296"/>41296:          #{desc =&gt; &quot;await client process ready (send chunk 1)&quot;,
<a name="41297"/>41297:            cmd  =&gt; fun(#{tester  := Tester,
<a name="41298"/>41298:                          rclient := Client} = _State) -&gt;
<a name="41299"/>41299:                            case ?SEV_AWAIT_READY(Client, rclient, send, 
<a name="41300"/>41300:                                                  [{tester, Tester}]) of
<a name="41301"/>41301:                                {ok, Result} -&gt;
<a name="41302"/>41302:                                    Result;
<a name="41303"/>41303:                                {error, _} = ERROR -&gt;
<a name="41304"/>41304:                                    ERROR
<a name="41305"/>41305:                            end
<a name="41306"/>41306:                    end},
<a name="41307"/>41307:          #{desc =&gt; &quot;order remote client to continue (send chunk 2)&quot;,
<a name="41308"/>41308:            cmd  =&gt; fun(#{rclient := Client,
<a name="41309"/>41309:                          data    := Data} = State) -&gt;
<a name="41310"/>41310:                            {Chunk, RestData} = lists:split(100, Data),
<a name="41311"/>41311:                            %% ?SEV_IPRINT(&quot;order send of chunk 2: &quot;
<a name="41312"/>41312:                            %%             &quot;~n   Size: ~p&quot;
<a name="41313"/>41313:                            %%             &quot;~n   ~p&quot;, [length(Chunk), Chunk]),
<a name="41314"/>41314:                            ?SEV_ANNOUNCE_CONTINUE(Client, send, Chunk),
<a name="41315"/>41315:                            {ok, State#{data =&gt; RestData}}
<a name="41316"/>41316:                    end},
<a name="41317"/>41317:          #{desc =&gt; &quot;await client process ready (send chunk 2)&quot;,
<a name="41318"/>41318:            cmd  =&gt; fun(#{tester  := Tester,
<a name="41319"/>41319:                          rclient := Client} = _State) -&gt;
<a name="41320"/>41320:                            case ?SEV_AWAIT_READY(Client, rclient, send, 
<a name="41321"/>41321:                                                  [{tester, Tester}]) of
<a name="41322"/>41322:                                {ok, Result} -&gt;
<a name="41323"/>41323:                                    Result;
<a name="41324"/>41324:                                {error, _} = ERROR -&gt;
<a name="41325"/>41325:                                    ERROR
<a name="41326"/>41326:                            end
<a name="41327"/>41327:                    end},
<a name="41328"/>41328:          #{desc =&gt; &quot;order remote client to continue (send chunk 3)&quot;,
<a name="41329"/>41329:            cmd  =&gt; fun(#{rclient := Client,
<a name="41330"/>41330:                          data    := Data} = State) -&gt;
<a name="41331"/>41331:                            {Chunk, RestData} = lists:split(100, Data),
<a name="41332"/>41332:                            %% ?SEV_IPRINT(&quot;order send of chunk 3: &quot;
<a name="41333"/>41333:                            %%             &quot;~n   Size: ~p&quot;
<a name="41334"/>41334:                            %%             &quot;~n   ~p&quot;, [length(Chunk), Chunk]),
<a name="41335"/>41335:                            ?SEV_ANNOUNCE_CONTINUE(Client, send, Chunk),
<a name="41336"/>41336:                            {ok, State#{data =&gt; RestData}}
<a name="41337"/>41337:                    end},
<a name="41338"/>41338:          #{desc =&gt; &quot;await client process ready (send chunk 3)&quot;,
<a name="41339"/>41339:            cmd  =&gt; fun(#{tester  := Tester,
<a name="41340"/>41340:                          rclient := Client} = _State) -&gt;
<a name="41341"/>41341:                            case ?SEV_AWAIT_READY(Client, rclient, send, 
<a name="41342"/>41342:                                                  [{tester, Tester}]) of
<a name="41343"/>41343:                                {ok, Result} -&gt;
<a name="41344"/>41344:                                    Result;
<a name="41345"/>41345:                                {error, _} = ERROR -&gt;
<a name="41346"/>41346:                                    ERROR
<a name="41347"/>41347:                            end
<a name="41348"/>41348:                    end},
<a name="41349"/>41349:          #{desc =&gt; &quot;order remote client to continue (send chunk 4)&quot;,
<a name="41350"/>41350:            cmd  =&gt; fun(#{rclient := Client,
<a name="41351"/>41351:                          data    := Data} = State) -&gt;
<a name="41352"/>41352:                            {Chunk, RestData} = lists:split(100, Data),
<a name="41353"/>41353:                            %% ?SEV_IPRINT(&quot;order send of chunk 4: &quot;
<a name="41354"/>41354:                            %%             &quot;~n   Size: ~p&quot;
<a name="41355"/>41355:                            %%             &quot;~n   ~p&quot;, [length(Chunk), Chunk]),
<a name="41356"/>41356:                            ?SEV_ANNOUNCE_CONTINUE(Client, send, Chunk),
<a name="41357"/>41357:                            {ok, State#{data =&gt; RestData}}
<a name="41358"/>41358:                    end},
<a name="41359"/>41359:          #{desc =&gt; &quot;await client process ready (send chunk 4)&quot;,
<a name="41360"/>41360:            cmd  =&gt; fun(#{tester  := Tester,
<a name="41361"/>41361:                          rclient := Client} = _State) -&gt;
<a name="41362"/>41362:                            case ?SEV_AWAIT_READY(Client, rclient, send, 
<a name="41363"/>41363:                                                  [{tester, Tester}]) of
<a name="41364"/>41364:                                {ok, Result} -&gt;
<a name="41365"/>41365:                                    Result;
<a name="41366"/>41366:                                {error, _} = ERROR -&gt;
<a name="41367"/>41367:                                    ERROR
<a name="41368"/>41368:                            end
<a name="41369"/>41369:                    end},
<a name="41370"/>41370:          #{desc =&gt; &quot;order remote client to continue (send chunk 5)&quot;,
<a name="41371"/>41371:            cmd  =&gt; fun(#{rclient := Client,
<a name="41372"/>41372:                          data    := Data} = State) -&gt;
<a name="41373"/>41373:                            {Chunk, RestData} = lists:split(100, Data),
<a name="41374"/>41374:                            %% ?SEV_IPRINT(&quot;order send of chunk 5: &quot;
<a name="41375"/>41375:                            %%             &quot;~n   Size: ~p&quot;
<a name="41376"/>41376:                            %%             &quot;~n   ~p&quot;, [length(Chunk), Chunk]),
<a name="41377"/>41377:                            ?SEV_ANNOUNCE_CONTINUE(Client, send, Chunk),
<a name="41378"/>41378:                            {ok, State#{data =&gt; RestData}}
<a name="41379"/>41379:                    end},
<a name="41380"/>41380:          #{desc =&gt; &quot;await client process ready (send chunk 5)&quot;,
<a name="41381"/>41381:            cmd  =&gt; fun(#{tester  := Tester,
<a name="41382"/>41382:                          rclient := Client} = _State) -&gt;
<a name="41383"/>41383:                            case ?SEV_AWAIT_READY(Client, rclient, send, 
<a name="41384"/>41384:                                                  [{tester, Tester}]) of
<a name="41385"/>41385:                                {ok, Result} -&gt;
<a name="41386"/>41386:                                    Result;
<a name="41387"/>41387:                                {error, _} = ERROR -&gt;
<a name="41388"/>41388:                                    ERROR
<a name="41389"/>41389:                            end
<a name="41390"/>41390:                    end},
<a name="41391"/>41391:          #{desc =&gt; &quot;order remote client to continue (send chunk 6)&quot;,
<a name="41392"/>41392:            cmd  =&gt; fun(#{rclient := Client,
<a name="41393"/>41393:                          data    := Data} = State) -&gt;
<a name="41394"/>41394:                            {Chunk, RestData} = lists:split(100, Data),
<a name="41395"/>41395:                            %% ?SEV_IPRINT(&quot;order send of chunk 6: &quot;
<a name="41396"/>41396:                            %%             &quot;~n   Size: ~p&quot;
<a name="41397"/>41397:                            %%             &quot;~n   ~p&quot;, [length(Chunk), Chunk]),
<a name="41398"/>41398:                            ?SEV_ANNOUNCE_CONTINUE(Client, send, Chunk),
<a name="41399"/>41399:                            {ok, State#{data =&gt; RestData}}
<a name="41400"/>41400:                    end},
<a name="41401"/>41401:          #{desc =&gt; &quot;await client process ready (send chunk 6)&quot;,
<a name="41402"/>41402:            cmd  =&gt; fun(#{tester  := Tester,
<a name="41403"/>41403:                          rclient := Client} = _State) -&gt;
<a name="41404"/>41404:                            case ?SEV_AWAIT_READY(Client, rclient, send, 
<a name="41405"/>41405:                                                  [{tester, Tester}]) of
<a name="41406"/>41406:                                {ok, Result} -&gt;
<a name="41407"/>41407:                                    Result;
<a name="41408"/>41408:                                {error, _} = ERROR -&gt;
<a name="41409"/>41409:                                    ERROR
<a name="41410"/>41410:                            end
<a name="41411"/>41411:                    end},
<a name="41412"/>41412:          #{desc =&gt; &quot;order remote client to continue (send chunk 7)&quot;,
<a name="41413"/>41413:            cmd  =&gt; fun(#{rclient := Client,
<a name="41414"/>41414:                          data    := Data} = State) -&gt;
<a name="41415"/>41415:                            {Chunk, RestData} = lists:split(100, Data),
<a name="41416"/>41416:                            %% ?SEV_IPRINT(&quot;order send of chunk 7: &quot;
<a name="41417"/>41417:                            %%             &quot;~n   Size: ~p&quot;
<a name="41418"/>41418:                            %%             &quot;~n   ~p&quot;, [length(Chunk), Chunk]),
<a name="41419"/>41419:                            ?SEV_ANNOUNCE_CONTINUE(Client, send, Chunk),
<a name="41420"/>41420:                            {ok, State#{data =&gt; RestData}}
<a name="41421"/>41421:                    end},
<a name="41422"/>41422:          #{desc =&gt; &quot;await client process ready (send chunk 7)&quot;,
<a name="41423"/>41423:            cmd  =&gt; fun(#{tester  := Tester,
<a name="41424"/>41424:                          rclient := Client} = _State) -&gt;
<a name="41425"/>41425:                            case ?SEV_AWAIT_READY(Client, rclient, send, 
<a name="41426"/>41426:                                                  [{tester, Tester}]) of
<a name="41427"/>41427:                                {ok, Result} -&gt;
<a name="41428"/>41428:                                    Result;
<a name="41429"/>41429:                                {error, _} = ERROR -&gt;
<a name="41430"/>41430:                                    ERROR
<a name="41431"/>41431:                            end
<a name="41432"/>41432:                    end},
<a name="41433"/>41433:          #{desc =&gt; &quot;order remote client to continue (send chunk 8)&quot;,
<a name="41434"/>41434:            cmd  =&gt; fun(#{rclient := Client,
<a name="41435"/>41435:                          data    := Data} = State) -&gt;
<a name="41436"/>41436:                            {Chunk, RestData} = lists:split(100, Data),
<a name="41437"/>41437:                            %% ?SEV_IPRINT(&quot;order send of chunk 8: &quot;
<a name="41438"/>41438:                            %%             &quot;~n   Size: ~p&quot;
<a name="41439"/>41439:                            %%             &quot;~n   ~p&quot;, [length(Chunk), Chunk]),
<a name="41440"/>41440:                            ?SEV_ANNOUNCE_CONTINUE(Client, send, Chunk),
<a name="41441"/>41441:                            {ok, State#{data =&gt; RestData}}
<a name="41442"/>41442:                    end},
<a name="41443"/>41443:          #{desc =&gt; &quot;await client process ready (send chunk 8)&quot;,
<a name="41444"/>41444:            cmd  =&gt; fun(#{tester  := Tester,
<a name="41445"/>41445:                          rclient := Client} = _State) -&gt;
<a name="41446"/>41446:                            case ?SEV_AWAIT_READY(Client, rclient, send, 
<a name="41447"/>41447:                                                  [{tester, Tester}]) of
<a name="41448"/>41448:                                {ok, Result} -&gt;
<a name="41449"/>41449:                                    Result;
<a name="41450"/>41450:                                {error, _} = ERROR -&gt;
<a name="41451"/>41451:                                    ERROR
<a name="41452"/>41452:                            end
<a name="41453"/>41453:                    end},
<a name="41454"/>41454:          #{desc =&gt; &quot;order remote client to continue (send chunk 9)&quot;,
<a name="41455"/>41455:            cmd  =&gt; fun(#{rclient := Client,
<a name="41456"/>41456:                          data    := Data} = State) -&gt;
<a name="41457"/>41457:                            {Chunk, RestData} = lists:split(100, Data),
<a name="41458"/>41458:                            %% ?SEV_IPRINT(&quot;order send of chunk 9: &quot;
<a name="41459"/>41459:                            %%             &quot;~n   Size: ~p&quot;
<a name="41460"/>41460:                            %%             &quot;~n   ~p&quot;, [length(Chunk), Chunk]),
<a name="41461"/>41461:                            ?SEV_ANNOUNCE_CONTINUE(Client, send, Chunk),
<a name="41462"/>41462:                            {ok, State#{data =&gt; RestData}}
<a name="41463"/>41463:                    end},
<a name="41464"/>41464:          #{desc =&gt; &quot;await client process ready (send chunk 9)&quot;,
<a name="41465"/>41465:            cmd  =&gt; fun(#{tester  := Tester,
<a name="41466"/>41466:                          rclient := Client} = _State) -&gt;
<a name="41467"/>41467:                            case ?SEV_AWAIT_READY(Client, rclient, send, 
<a name="41468"/>41468:                                                  [{tester, Tester}]) of
<a name="41469"/>41469:                                {ok, Result} -&gt;
<a name="41470"/>41470:                                    Result;
<a name="41471"/>41471:                                {error, _} = ERROR -&gt;
<a name="41472"/>41472:                                    ERROR
<a name="41473"/>41473:                            end
<a name="41474"/>41474:                    end},
<a name="41475"/>41475:          #{desc =&gt; &quot;order remote client to continue (send chunk 10)&quot;,
<a name="41476"/>41476:            cmd  =&gt; fun(#{rclient := Client,
<a name="41477"/>41477:                          data    := Data} = State) -&gt;
<a name="41478"/>41478:                            {Chunk, []} = lists:split(100, Data),
<a name="41479"/>41479:                            %% ?SEV_IPRINT(&quot;order send of chunk 10: &quot;
<a name="41480"/>41480:                            %%             &quot;~n   Size: ~p&quot;
<a name="41481"/>41481:                            %%             &quot;~n   ~p&quot;, [length(Chunk), Chunk]),
<a name="41482"/>41482:                            ?SEV_ANNOUNCE_CONTINUE(Client, send, Chunk),
<a name="41483"/>41483:                            {ok, maps:remove(data, State)}
<a name="41484"/>41484:                    end},
<a name="41485"/>41485:          #{desc =&gt; &quot;await client process ready (send chunk 10)&quot;,
<a name="41486"/>41486:            cmd  =&gt; fun(#{tester  := Tester,
<a name="41487"/>41487:                          rclient := Client} = _State) -&gt;
<a name="41488"/>41488:                            case ?SEV_AWAIT_READY(Client, rclient, send, 
<a name="41489"/>41489:                                                  [{tester, Tester}]) of
<a name="41490"/>41490:                                {ok, Result} -&gt;
<a name="41491"/>41491:                                    Result;
<a name="41492"/>41492:                                {error, _} = ERROR -&gt;
<a name="41493"/>41493:                                    ERROR
<a name="41494"/>41494:                            end
<a name="41495"/>41495:                    end},
<a name="41496"/>41496:          #{desc =&gt; &quot;order remote client to continue (send stop)&quot;,
<a name="41497"/>41497:            cmd  =&gt; fun(#{rclient := Client} = State) -&gt;
<a name="41498"/>41498:                            ?SEV_ANNOUNCE_CONTINUE(Client, send, stop),
<a name="41499"/>41499:                            {ok, maps:remove(data, State)}
<a name="41500"/>41500:                    end},
<a name="41501"/>41501:          #{desc =&gt; &quot;await client process ready (send stop)&quot;,
<a name="41502"/>41502:            cmd  =&gt; fun(#{tester  := Tester,
<a name="41503"/>41503:                          rclient := Client} = _State) -&gt;
<a name="41504"/>41504:                            case ?SEV_AWAIT_READY(Client, rclient, send, 
<a name="41505"/>41505:                                                  [{tester, Tester}]) of
<a name="41506"/>41506:                                {ok, Result} -&gt;
<a name="41507"/>41507:                                    Result;
<a name="41508"/>41508:                                {error, _} = ERROR -&gt;
<a name="41509"/>41509:                                    ERROR
<a name="41510"/>41510:                            end
<a name="41511"/>41511:                    end},
<a name="41512"/>41512:          #{desc =&gt; &quot;announce ready (send-many-small)&quot;,
<a name="41513"/>41513:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="41514"/>41514:                            ?SEV_ANNOUNCE_READY(Tester, send_many_small),
<a name="41515"/>41515:                            ok
<a name="41516"/>41516:                    end},
<a name="41517"/>41517: 
<a name="41518"/>41518:          %% Termination
<a name="41519"/>41519:          #{desc =&gt; &quot;await terminate (from tester)&quot;,
<a name="41520"/>41520:            cmd  =&gt; fun(#{tester  := Tester, 
<a name="41521"/>41521:                          rclient := Client} = State) -&gt;
<a name="41522"/>41522:                            case ?SEV_AWAIT_TERMINATE(Tester, tester,
<a name="41523"/>41523:                                                      [{rclient, Client}]) of
<a name="41524"/>41524:                                ok -&gt;
<a name="41525"/>41525:                                    {ok, maps:remove(tester, State)};
<a name="41526"/>41526:                                {error, _} = ERROR -&gt;
<a name="41527"/>41527:                                    ERROR
<a name="41528"/>41528:                            end
<a name="41529"/>41529:                    end},
<a name="41530"/>41530:          #{desc =&gt; &quot;kill remote client&quot;,
<a name="41531"/>41531:            cmd  =&gt; fun(#{rclient := Client}) -&gt;
<a name="41532"/>41532:                            ?SEV_ANNOUNCE_TERMINATE(Client),
<a name="41533"/>41533:                            ok
<a name="41534"/>41534:                    end},
<a name="41535"/>41535:          #{desc =&gt; &quot;await remote client termination&quot;,
<a name="41536"/>41536:            cmd  =&gt; fun(#{rclient := Client} = State) -&gt;
<a name="41537"/>41537:                            ?SEV_AWAIT_TERMINATION(Client),
<a name="41538"/>41538:                            State1 = maps:remove(rclient, State),
<a name="41539"/>41539:                            {ok, State1}
<a name="41540"/>41540:                    end},
<a name="41541"/>41541:          #{desc =&gt; &quot;stop client node&quot;,
<a name="41542"/>41542:            cmd  =&gt; fun(#{peer := Peer} = State) -&gt;
<a name="41543"/>41543:                            {ok,
<a name="41544"/>41544:                             try peer:stop(Peer) of
<a name="41545"/>41545:                                 ok -&gt;
<a name="41546"/>41546:                                     State#{node_stop =&gt; ok};
<a name="41547"/>41547:                                 {error, Reason} -&gt;
<a name="41548"/>41548:                                     ?SEV_EPRINT(&quot;Unexpected node stop result: &quot;
<a name="41549"/>41549:                                                 &quot;~n   ~p&quot;, [Reason]),
<a name="41550"/>41550:                                     State#{node_stop =&gt; error}
<a name="41551"/>41551:                             catch
<a name="41552"/>41552:                                 C:E:S -&gt;
<a name="41553"/>41553:                                     ?SEV_EPRINT(&quot;Unexpected node stop result: &quot;
<a name="41554"/>41554:                                                 &quot;~n   Class: ~p&quot;
<a name="41555"/>41555:                                                 &quot;~n   Error: ~p&quot;
<a name="41556"/>41556:                                                 &quot;~n   Stack: ~p&quot;,[C, E, S]),
<a name="41557"/>41557:                                     State#{node_stop =&gt; error}
<a name="41558"/>41558:                             end}
<a name="41559"/>41559:                    end},
<a name="41560"/>41560:          #{desc =&gt; &quot;await client node termination&quot;,
<a name="41561"/>41561:            cmd  =&gt; fun(#{node := Node, node_stop := ok} = State) -&gt;
<a name="41562"/>41562:                            ?SEV_IPRINT(&quot;Success node stop - await nodedown&quot;),
<a name="41563"/>41563:                            receive
<a name="41564"/>41564:                                {nodedown, Node} -&gt;
<a name="41565"/>41565:                                    ?SEV_IPRINT(&quot;nodedown received - cleanup&quot;),
<a name="41566"/>41566:                                    State1 = maps:remove(node, State),
<a name="41567"/>41567:                                    {ok, State1}
<a name="41568"/>41568:                            end;
<a name="41569"/>41569:                       (#{node_stop := error} = State) -&gt;
<a name="41570"/>41570:                            ?SEV_IPRINT(&quot;Failed node stop - cleanup&quot;),
<a name="41571"/>41571:                            State1 = maps:remove(node, State),
<a name="41572"/>41572:                            {ok, State1}
<a name="41573"/>41573:                    end},
<a name="41574"/>41574: 
<a name="41575"/>41575:          %% *** We are done ***
<a name="41576"/>41576:          ?SEV_FINISH_NORMAL
<a name="41577"/>41577:         ],
<a name="41578"/>41578: 
<a name="41579"/>41579:     TesterSeq =
<a name="41580"/>41580:         [
<a name="41581"/>41581:          %% *** Init part ***
<a name="41582"/>41582:          #{desc =&gt; &quot;monitor server&quot;,
<a name="41583"/>41583:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="41584"/>41584:                            _MRef = erlang:monitor(process, Pid),
<a name="41585"/>41585:                            ok
<a name="41586"/>41586:                    end},
<a name="41587"/>41587:          #{desc =&gt; &quot;monitor client&quot;,
<a name="41588"/>41588:            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;
<a name="41589"/>41589:                            _MRef = erlang:monitor(process, Pid),
<a name="41590"/>41590:                            ok
<a name="41591"/>41591:                    end},
<a name="41592"/>41592: 
<a name="41593"/>41593:          %% Start the server
<a name="41594"/>41594:          #{desc =&gt; &quot;order server start&quot;,
<a name="41595"/>41595:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="41596"/>41596:                            ?SEV_ANNOUNCE_START(Pid),
<a name="41597"/>41597:                            ok
<a name="41598"/>41598:                    end},
<a name="41599"/>41599:          #{desc =&gt; &quot;await server ready (init)&quot;,
<a name="41600"/>41600:            cmd  =&gt; fun(#{server := Pid} = State) -&gt;
<a name="41601"/>41601:                            {ok, ServerSA} = ?SEV_AWAIT_READY(Pid, server, init),
<a name="41602"/>41602:                            {ok, State#{server_sa =&gt; ServerSA}}
<a name="41603"/>41603:                    end},
<a name="41604"/>41604: 
<a name="41605"/>41605:          %% Start the client
<a name="41606"/>41606:          #{desc =&gt; &quot;order client start&quot;,
<a name="41607"/>41607:            cmd  =&gt; fun(#{client    := Pid, 
<a name="41608"/>41608:                          server_sa := ServerSA} = _State) -&gt;
<a name="41609"/>41609:                            ?SEV_ANNOUNCE_START(Pid, ServerSA),
<a name="41610"/>41610:                            ok
<a name="41611"/>41611:                    end},
<a name="41612"/>41612:          #{desc =&gt; &quot;await client ready (init)&quot;,
<a name="41613"/>41613:            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;
<a name="41614"/>41614:                            ok = ?SEV_AWAIT_READY(Pid, client, init)
<a name="41615"/>41615:                    end},
<a name="41616"/>41616:  
<a name="41617"/>41617:          %% The actual test
<a name="41618"/>41618:          #{desc =&gt; &quot;order server continue (accept)&quot;,
<a name="41619"/>41619:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="41620"/>41620:                            ?SEV_ANNOUNCE_CONTINUE(Pid, accept),
<a name="41621"/>41621:                            ok
<a name="41622"/>41622:                    end},
<a name="41623"/>41623:          ?SEV_SLEEP(?SECS(1)),
<a name="41624"/>41624:          #{desc =&gt; &quot;order client continue (connect)&quot;,
<a name="41625"/>41625:            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;
<a name="41626"/>41626:                            ?SEV_ANNOUNCE_CONTINUE(Pid, connect),
<a name="41627"/>41627:                            ok
<a name="41628"/>41628:                    end},
<a name="41629"/>41629:          #{desc =&gt; &quot;await server ready (accept)&quot;,
<a name="41630"/>41630:            cmd  =&gt; fun(#{server := Server,
<a name="41631"/>41631:                          client := Client} = _State) -&gt;
<a name="41632"/>41632:                            ?SEV_AWAIT_READY(Server, server, accept,
<a name="41633"/>41633:                                             [{client, Client}]),
<a name="41634"/>41634:                            ok
<a name="41635"/>41635:                    end},
<a name="41636"/>41636:          #{desc =&gt; &quot;await client ready (connect)&quot;,
<a name="41637"/>41637:            cmd  =&gt; fun(#{server := Server,
<a name="41638"/>41638:                          client := Client} = _State) -&gt;
<a name="41639"/>41639:                            ?SEV_AWAIT_READY(Client, client, connect, 
<a name="41640"/>41640:                                             [{server, Server}])
<a name="41641"/>41641:                    end},
<a name="41642"/>41642: 
<a name="41643"/>41643:          #{desc =&gt; &quot;generate data&quot;,
<a name="41644"/>41644:            cmd  =&gt; fun(State) -&gt;
<a name="41645"/>41645:                            D1 = lists:seq(1,250),
<a name="41646"/>41646:                            D2 = lists:duplicate(4, D1),
<a name="41647"/>41647:                            D3 = lists:flatten(D2),
<a name="41648"/>41648:                            {ok, State#{data =&gt; D3}}
<a name="41649"/>41649:                    end},
<a name="41650"/>41650: 
<a name="41651"/>41651:          %% (client) Send one big and (server) recv may small
<a name="41652"/>41652:          #{desc =&gt; &quot;order server continue (recv-many-small)&quot;,
<a name="41653"/>41653:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="41654"/>41654:                            ?SEV_ANNOUNCE_CONTINUE(Pid, recv_many_small),
<a name="41655"/>41655:                            ok
<a name="41656"/>41656:                    end},
<a name="41657"/>41657:          ?SEV_SLEEP(?SECS(1)),
<a name="41658"/>41658:          #{desc =&gt; &quot;order client continue (send-one-big)&quot;,
<a name="41659"/>41659:            cmd  =&gt; fun(#{client := Pid, data := Data} = _State) -&gt;
<a name="41660"/>41660:                            ?SEV_ANNOUNCE_CONTINUE(Pid, send_one_big, Data),
<a name="41661"/>41661:                            ok
<a name="41662"/>41662:                    end},
<a name="41663"/>41663:          #{desc =&gt; &quot;await client ready (send-one-big)&quot;,
<a name="41664"/>41664:            cmd  =&gt; fun(#{server := Server,
<a name="41665"/>41665:                          client := Client} = _State) -&gt;
<a name="41666"/>41666:                            ok = ?SEV_AWAIT_READY(Client, client, send_one_big, 
<a name="41667"/>41667:                                                  [{server, Server}])
<a name="41668"/>41668:                    end},
<a name="41669"/>41669:          #{desc =&gt; &quot;await server ready (recv-many-small)&quot;,
<a name="41670"/>41670:            cmd  =&gt; fun(#{server := Server,
<a name="41671"/>41671:                          client := Client, 
<a name="41672"/>41672:                          data   := Data} = _State) -&gt;
<a name="41673"/>41673:                            case ?SEV_AWAIT_READY(Server, server, recv_many_small,
<a name="41674"/>41674:                                                  [{client, Client}]) of
<a name="41675"/>41675:                                {ok, Data} -&gt;
<a name="41676"/>41676:                                    ok;
<a name="41677"/>41677:                                {ok, OtherData} -&gt;
<a name="41678"/>41678:                                    {error, {mismatched_data, Data, OtherData}};
<a name="41679"/>41679:                                {error, _} = ERROR -&gt;
<a name="41680"/>41680:                                    ERROR
<a name="41681"/>41681:                            end
<a name="41682"/>41682:                    end},
<a name="41683"/>41683: 
<a name="41684"/>41684:          #{desc =&gt; &quot;order server continue (recv-one-big)&quot;,
<a name="41685"/>41685:            cmd  =&gt; fun(#{server := Pid, data := Data} = _State) -&gt;
<a name="41686"/>41686:                            ?SEV_ANNOUNCE_CONTINUE(Pid, recv_one_big, length(Data)),
<a name="41687"/>41687:                            ok
<a name="41688"/>41688:                    end},
<a name="41689"/>41689:          ?SEV_SLEEP(?SECS(1)),
<a name="41690"/>41690:          #{desc =&gt; &quot;order client continue (send-many-small)&quot;,
<a name="41691"/>41691:            cmd  =&gt; fun(#{client := Pid, data := Data} = _State) -&gt;
<a name="41692"/>41692:                            ?SEV_ANNOUNCE_CONTINUE(Pid, send_many_small, Data),
<a name="41693"/>41693:                            ok
<a name="41694"/>41694:                    end},
<a name="41695"/>41695:          #{desc =&gt; &quot;await client ready (send-many-small)&quot;,
<a name="41696"/>41696:            cmd  =&gt; fun(#{server := Server,
<a name="41697"/>41697:                          client := Client} = _State) -&gt;
<a name="41698"/>41698:                            ok = ?SEV_AWAIT_READY(Client, client, send_many_small, 
<a name="41699"/>41699:                                                  [{server, Server}])
<a name="41700"/>41700:                    end},
<a name="41701"/>41701:          #{desc =&gt; &quot;await server ready (recv-one-big)&quot;,
<a name="41702"/>41702:            cmd  =&gt; fun(#{server := Server,
<a name="41703"/>41703:                          client := Client, 
<a name="41704"/>41704:                          data   := Data} = State) -&gt;
<a name="41705"/>41705:                            case ?SEV_AWAIT_READY(Server, server, recv_one_big,
<a name="41706"/>41706:                                                  [{client, Client}]) of
<a name="41707"/>41707:                                {ok, Data} -&gt;
<a name="41708"/>41708:                                    {ok, maps:remove(data, State)};
<a name="41709"/>41709:                                {ok, OtherData} -&gt;
<a name="41710"/>41710:                                    {error, {mismatched_data, Data, OtherData}};
<a name="41711"/>41711:                                {error, _} = ERROR -&gt;
<a name="41712"/>41712:                                    ERROR
<a name="41713"/>41713:                            end
<a name="41714"/>41714:                    end},
<a name="41715"/>41715: 
<a name="41716"/>41716:          %% Terminations
<a name="41717"/>41717:          #{desc =&gt; &quot;order client to terminate&quot;,
<a name="41718"/>41718:            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;
<a name="41719"/>41719:                            ?SEV_ANNOUNCE_TERMINATE(Pid),
<a name="41720"/>41720:                            ok
<a name="41721"/>41721:                    end},
<a name="41722"/>41722:          #{desc =&gt; &quot;await client termination&quot;,
<a name="41723"/>41723:            cmd  =&gt; fun(#{client := Pid} = State) -&gt;
<a name="41724"/>41724:                            case ?SEV_AWAIT_TERMINATION(Pid) of
<a name="41725"/>41725:                                ok -&gt;
<a name="41726"/>41726:                                    State1 = maps:remove(client, State),
<a name="41727"/>41727:                                    {ok, State1};
<a name="41728"/>41728:                                {error, _} = ERROR -&gt;
<a name="41729"/>41729:                                    ERROR
<a name="41730"/>41730:                            end
<a name="41731"/>41731:                    end},
<a name="41732"/>41732:          #{desc =&gt; &quot;order server to terminate&quot;,
<a name="41733"/>41733:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="41734"/>41734:                            ?SEV_ANNOUNCE_TERMINATE(Pid),
<a name="41735"/>41735:                            ok
<a name="41736"/>41736:                    end},
<a name="41737"/>41737:          #{desc =&gt; &quot;await server termination&quot;,
<a name="41738"/>41738:            cmd  =&gt; fun(#{server := Pid} = State) -&gt;
<a name="41739"/>41739:                            case ?SEV_AWAIT_TERMINATION(Pid) of
<a name="41740"/>41740:                                ok -&gt;
<a name="41741"/>41741:                                    State1 = maps:remove(server, State),
<a name="41742"/>41742:                                    {ok, State1};
<a name="41743"/>41743:                                {error, _} = ERROR -&gt;
<a name="41744"/>41744:                                    ERROR
<a name="41745"/>41745:                            end
<a name="41746"/>41746:                    end},
<a name="41747"/>41747: 
<a name="41748"/>41748: 
<a name="41749"/>41749:          %% *** We are done ***
<a name="41750"/>41750:          ?SEV_FINISH_NORMAL
<a name="41751"/>41751:         ],
<a name="41752"/>41752: 
<a name="41753"/>41753:     i(&quot;start server evaluator&quot;),
<a name="41754"/>41754:     ServerInitState = InitState,
<a name="41755"/>41755:     Server = ?SEV_START(&quot;server&quot;, ServerSeq, ServerInitState),
<a name="41756"/>41756: 
<a name="41757"/>41757:     i(&quot;start client evaluator(s)&quot;),
<a name="41758"/>41758:     ClientInitState = InitState#{host =&gt; local_host()},
<a name="41759"/>41759:     Client = ?SEV_START(&quot;client&quot;, ClientSeq, ClientInitState),
<a name="41760"/>41760: 
<a name="41761"/>41761:     i(&quot;start 'tester' evaluator&quot;),
<a name="41762"/>41762:     TesterInitState = #{server =&gt; Server#ev.pid,
<a name="41763"/>41763:                         client =&gt; Client#ev.pid},
<a name="41764"/>41764:     Tester = ?SEV_START(&quot;tester&quot;, TesterSeq, TesterInitState),
<a name="41765"/>41765: 
<a name="41766"/>41766:     i(&quot;await evaluator&quot;),
<a name="traffic_send_and_recv_chunks_tcp-last_expr"/><a name="41767"/>41767: <b>    ok = ?SEV_AWAIT_FINISH</b>([Server, Client, Tester]).
<a name="41768"/>41768:     
<a name="41769"/>41769: 
<a name="41770"/>41770: 
<a name="traffic_snr_tcp_client_start-1"/><a name="41771"/>41771: <b>traffic_snr_tcp_client_start</b>(Node) -&gt;
<a name="41772"/>41772:     Self = self(),
<a name="41773"/>41773:     Fun  = fun() -&gt; traffic_snr_tcp_client(Self) end,
<a name="traffic_snr_tcp_client_start-last_expr"/><a name="41774"/>41774: <b>    erlang:spawn</b>(Node, Fun).
<a name="41775"/>41775: 
<a name="traffic_snr_tcp_client-1"/><a name="41776"/>41776: <b>traffic_snr_tcp_client</b>(Parent) -&gt;
<a name="41777"/>41777:     {Sock, ServerSA, Path} = traffic_snr_tcp_client_init(Parent),
<a name="41778"/>41778:     traffic_snr_tcp_client_announce_ready(Parent, init),
<a name="41779"/>41779:     traffic_snr_tcp_client_await_continue(Parent, connect),
<a name="41780"/>41780:     traffic_snr_tcp_client_connect(Sock, ServerSA),
<a name="41781"/>41781:     traffic_snr_tcp_client_announce_ready(Parent, connect),
<a name="41782"/>41782:     traffic_snr_tcp_client_send_loop(Parent, Sock),
<a name="41783"/>41783:     Reason = traffic_snr_tcp_client_await_terminate(Parent),
<a name="41784"/>41784:     traffic_snr_tcp_client_close(Sock, Path),
<a name="traffic_snr_tcp_client-last_expr"/><a name="41785"/>41785: <b>    exit</b>(Reason).
<a name="41786"/>41786: 
<a name="41787"/>41787: 
<a name="traffic_snr_tcp_client_send_loop-2"/><a name="41788"/>41788: <b>traffic_snr_tcp_client_send_loop</b>(Parent, Sock) -&gt;
<a name="traffic_snr_tcp_client_send_loop-last_expr"/><a name="41789"/>41789: <b>    case ?SEV_AWAIT_CONTINUE</b>(Parent, parent, send) of
<a name="41790"/>41790:         {ok, stop} -&gt; % Breaks the loop
<a name="41791"/>41791:             ?SEV_ANNOUNCE_READY(Parent, send, ok),
<a name="41792"/>41792:             ok;
<a name="41793"/>41793:         {ok, Data} -&gt;
<a name="41794"/>41794:             case socket:send(Sock, Data) of
<a name="41795"/>41795:                 ok -&gt;
<a name="41796"/>41796:                     ?SEV_ANNOUNCE_READY(Parent, send, ok),
<a name="41797"/>41797:                     traffic_snr_tcp_client_send_loop(Parent, Sock);
<a name="41798"/>41798:                 {error, Reason} = ERROR -&gt;
<a name="41799"/>41799:                     ?SEV_ANNOUNCE_READY(Parent, send, ERROR),
<a name="41800"/>41800:                     exit({send, Reason})
<a name="41801"/>41801:             end;
<a name="41802"/>41802:         {error, Reason} -&gt;
<a name="41803"/>41803:             exit({await_continue, Reason})
<a name="41804"/>41804:     end.
<a name="41805"/>41805: 
<a name="traffic_snr_tcp_client_init-1"/><a name="41806"/>41806: <b>traffic_snr_tcp_client_init</b>(Parent) -&gt;
<a name="41807"/>41807:     put(sname, &quot;rclient&quot;),
<a name="41808"/>41808:     ?SEV_IPRINT(&quot;init&quot;),
<a name="41809"/>41809:     _MRef = erlang:monitor(process, Parent),
<a name="41810"/>41810:     {ServerSA, Proto} = traffic_snr_tcp_client_await_start(Parent),
<a name="41811"/>41811:     Domain   = maps:get(family, ServerSA),
<a name="41812"/>41812:     Sock     = traffic_snr_tcp_client_create(Domain, Proto),
<a name="41813"/>41813:     Path     = traffic_snr_tcp_client_bind(Sock, Domain),
<a name="traffic_snr_tcp_client_init-last_expr"/><a name="41814"/>41814:     {Sock, ServerSA, Path}.
<a name="41815"/>41815: 
<a name="traffic_snr_tcp_client_await_start-1"/><a name="41816"/>41816: <b>traffic_snr_tcp_client_await_start</b>(Parent) -&gt;
<a name="41817"/>41817:     i(&quot;traffic_snr_tcp_client_await_start -&gt; entry&quot;),
<a name="traffic_snr_tcp_client_await_start-last_expr"/><a name="41818"/>41818: <b>    ?SEV_AWAIT_START</b>(Parent).
<a name="41819"/>41819: 
<a name="traffic_snr_tcp_client_create-2"/><a name="41820"/>41820: <b>traffic_snr_tcp_client_create</b>(Domain, Proto) -&gt;
<a name="41821"/>41821:     i(&quot;traffic_snr_tcp_client_create -&gt; entry&quot;),
<a name="traffic_snr_tcp_client_create-last_expr"/><a name="41822"/>41822: <b>    case socket:open</b>(Domain, stream, Proto) of
<a name="41823"/>41823:         {ok, Sock} -&gt;
<a name="41824"/>41824:             Sock;
<a name="41825"/>41825:         {error, Reason} -&gt;
<a name="41826"/>41826:             exit({open_failed, Reason})
<a name="41827"/>41827:     end.
<a name="41828"/>41828: 
<a name="traffic_snr_tcp_client_bind-2"/><a name="41829"/>41829: <b>traffic_snr_tcp_client_bind</b>(Sock, Domain) -&gt;
<a name="41830"/>41830:     i(&quot;traffic_snr_tcp_client_bind -&gt; entry&quot;),
<a name="41831"/>41831:     LSA = which_local_socket_addr(Domain),
<a name="traffic_snr_tcp_client_bind-last_expr"/><a name="41832"/>41832: <b>    case socket:bind</b>(Sock, LSA) of
<a name="41833"/>41833:         ok -&gt;
<a name="41834"/>41834:             case socket:sockname(Sock) of
<a name="41835"/>41835:                 {ok, #{family := local, path := Path}} -&gt;
<a name="41836"/>41836:                     Path;
<a name="41837"/>41837:                 {ok, _} -&gt;
<a name="41838"/>41838:                     undefined;
<a name="41839"/>41839:                 {error, Reason1} -&gt;
<a name="41840"/>41840:                     exit({sockname, Reason1})
<a name="41841"/>41841:             end;
<a name="41842"/>41842:         {error, Reason} -&gt;
<a name="41843"/>41843:             exit({bind, Reason})
<a name="41844"/>41844:     end.
<a name="41845"/>41845: 
<a name="traffic_snr_tcp_client_announce_ready-2"/><a name="41846"/>41846: <b>traffic_snr_tcp_client_announce_ready</b>(Parent, Slogan) -&gt;
<a name="traffic_snr_tcp_client_announce_ready-last_expr"/><a name="41847"/>41847: <b>    ?SEV_ANNOUNCE_READY</b>(Parent, Slogan).
<a name="41848"/>41848: 
<a name="traffic_snr_tcp_client_await_continue-2"/><a name="41849"/>41849: <b>traffic_snr_tcp_client_await_continue</b>(Parent, Slogan) -&gt;
<a name="41850"/>41850:     i(&quot;traffic_snr_tcp_client_await_continue -&gt; entry&quot;),
<a name="traffic_snr_tcp_client_await_continue-last_expr"/><a name="41851"/>41851: <b>    ?SEV_AWAIT_CONTINUE</b>(Parent, parent, Slogan).
<a name="41852"/>41852: 
<a name="traffic_snr_tcp_client_connect-2"/><a name="41853"/>41853: <b>traffic_snr_tcp_client_connect</b>(Sock, ServerSA) -&gt;
<a name="41854"/>41854:     i(&quot;traffic_snr_tcp_client_connect -&gt; entry&quot;),
<a name="traffic_snr_tcp_client_connect-last_expr"/><a name="41855"/>41855: <b>    case socket:connect</b>(Sock, ServerSA) of
<a name="41856"/>41856:         ok -&gt;
<a name="41857"/>41857:             ok;
<a name="41858"/>41858:         {error, Reason} -&gt;
<a name="41859"/>41859:             exit({connect, Reason})
<a name="41860"/>41860:     end.
<a name="41861"/>41861: 
<a name="traffic_snr_tcp_client_close-2"/><a name="41862"/>41862: <b>traffic_snr_tcp_client_close</b>(Sock, Path) -&gt;
<a name="41863"/>41863:     i(&quot;traffic_snr_tcp_client_close -&gt; entry&quot;),
<a name="traffic_snr_tcp_client_close-last_expr"/><a name="41864"/>41864: <b>    case socket:close</b>(Sock) of
<a name="41865"/>41865:         ok -&gt;
<a name="41866"/>41866:             unlink_path(Path),
<a name="41867"/>41867:             ok;
<a name="41868"/>41868:         {error, Reason} -&gt;
<a name="41869"/>41869:             ?SEV_EPRINT(&quot;failed closing: &quot;
<a name="41870"/>41870:                         &quot;~n   Reason: ~p&quot;, [Reason]),
<a name="41871"/>41871:             unlink_path(Path),
<a name="41872"/>41872:             {error, {close, Reason}}
<a name="41873"/>41873:     end.
<a name="41874"/>41874: 
<a name="traffic_snr_tcp_client_await_terminate-1"/><a name="41875"/>41875: <b>traffic_snr_tcp_client_await_terminate</b>(Parent) -&gt;
<a name="41876"/>41876:     i(&quot;traffic_snr_tcp_client_await_terminate -&gt; entry&quot;),
<a name="traffic_snr_tcp_client_await_terminate-last_expr"/><a name="41877"/>41877: <b>    case ?SEV_AWAIT_TERMINATE</b>(Parent, parent) of
<a name="41878"/>41878:         ok -&gt;
<a name="41879"/>41879:             ok;
<a name="41880"/>41880:         {error, Reason} -&gt;
<a name="41881"/>41881:             Reason
<a name="41882"/>41882:     end.
<a name="41883"/>41883: 
<a name="41884"/>41884: 
<a name="41885"/>41885: 
<a name="41886"/>41886: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="41887"/>41887: <i>%% This test case is intended to test that the send and recv functions</i>
<a name="41888"/>41888: <i>%% by repeatedly sending a meassage between two entities.</i>
<a name="41889"/>41889: <i>%% The same basic test case is used for three different message sizes; </i>
<a name="41890"/>41890: <i>%% small (8 bytes), medium (8K) and large (8M).</i>
<a name="41891"/>41891: <i>%% The message is sent from A to B and then back again. This is </i>
<a name="41892"/>41892: <i>%% repeated a set number of times (more times the small the message).</i>
<a name="41893"/>41893: <i>%% This is the 'small' message test case, for IPv4.</i>
<a name="41894"/>41894: 
<a name="traffic_ping_pong_small_send_and_recv_tcp4-1"/><a name="41895"/>41895: <b>traffic_ping_pong_small_send_and_recv_tcp4</b>(Config) when is_list(Config) -&gt;
<a name="41896"/>41896:     ?TT(?SECS(15)),
<a name="41897"/>41897:     Msg = l2b(?TPP_SMALL),
<a name="41898"/>41898:     Num = ?TPP_NUM(Config, ?TPP_SMALL_NUM),
<a name="traffic_ping_pong_small_send_and_recv_tcp4-last_expr"/><a name="41899"/>41899: <b>    tc_try</b>(traffic_ping_pong_small_send_and_recv_tcp4,
<a name="41900"/>41900:            fun() -&gt; has_support_ipv4() end,
<a name="41901"/>41901:            fun() -&gt;
<a name="41902"/>41902:                    InitState = #{domain =&gt; inet,
<a name="41903"/>41903:                                  proto  =&gt; tcp,
<a name="41904"/>41904:                                  msg    =&gt; Msg,
<a name="41905"/>41905:                                  num    =&gt; Num},
<a name="41906"/>41906:                    ok = traffic_ping_pong_send_and_recv_tcp(InitState)
<a name="41907"/>41907:            end).
<a name="41908"/>41908: 
<a name="41909"/>41909: 
<a name="41910"/>41910: 
<a name="41911"/>41911: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="41912"/>41912: <i>%% This test case is intended to test that the send and recv functions</i>
<a name="41913"/>41913: <i>%% by repeatedly sending a meassage between two entities.</i>
<a name="41914"/>41914: <i>%% The same basic test case is used for three different message sizes; </i>
<a name="41915"/>41915: <i>%% small (8 bytes), medium (8K) and large (8M).</i>
<a name="41916"/>41916: <i>%% The message is sent from A to B and then back again. This is </i>
<a name="41917"/>41917: <i>%% repeated a set number of times (more times the small the message).</i>
<a name="41918"/>41918: <i>%% This is the 'small' message test case, for IPv6.</i>
<a name="41919"/>41919: 
<a name="traffic_ping_pong_small_send_and_recv_tcp6-1"/><a name="41920"/>41920: <b>traffic_ping_pong_small_send_and_recv_tcp6</b>(Config) when is_list(Config) -&gt;
<a name="41921"/>41921:     ?TT(?SECS(15)),
<a name="41922"/>41922:     Msg = l2b(?TPP_SMALL),
<a name="41923"/>41923:     Num = ?TPP_NUM(Config, ?TPP_SMALL_NUM),
<a name="traffic_ping_pong_small_send_and_recv_tcp6-last_expr"/><a name="41924"/>41924: <b>    tc_try</b>(traffic_ping_pong_small_send_and_recv_tcp6,
<a name="41925"/>41925:            fun() -&gt; has_support_ipv6() end,
<a name="41926"/>41926:            fun() -&gt;
<a name="41927"/>41927:                    InitState = #{domain =&gt; inet6,
<a name="41928"/>41928:                                  proto  =&gt; tcp,
<a name="41929"/>41929:                                  msg    =&gt; Msg,
<a name="41930"/>41930:                                  num    =&gt; Num},
<a name="41931"/>41931:                    ok = traffic_ping_pong_send_and_recv_tcp(InitState)
<a name="41932"/>41932:            end).
<a name="41933"/>41933: 
<a name="41934"/>41934: 
<a name="41935"/>41935: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="41936"/>41936: <i>%% This test case is intended to test that the send and recv functions</i>
<a name="41937"/>41937: <i>%% by repeatedly sending a meassage between two entities.</i>
<a name="41938"/>41938: <i>%% The same basic test case is used for three different message sizes; </i>
<a name="41939"/>41939: <i>%% small (8 bytes), medium (8K) and large (8M).</i>
<a name="41940"/>41940: <i>%% The message is sent from A to B and then back again. This is </i>
<a name="41941"/>41941: <i>%% repeated a set number of times (more times the small the message).</i>
<a name="41942"/>41942: <i>%% This is the 'small' message test case, for Unix Domain (stream) socket.</i>
<a name="41943"/>41943: 
<a name="traffic_ping_pong_small_send_and_recv_tcpL-1"/><a name="41944"/>41944: <b>traffic_ping_pong_small_send_and_recv_tcpL</b>(Config) when is_list(Config) -&gt;
<a name="41945"/>41945:     ?TT(?SECS(15)),
<a name="41946"/>41946:     Msg = l2b(?TPP_SMALL),
<a name="41947"/>41947:     Num = ?TPP_NUM(Config, ?TPP_SMALL_NUM),
<a name="traffic_ping_pong_small_send_and_recv_tcpL-last_expr"/><a name="41948"/>41948: <b>    tc_try</b>(traffic_ping_pong_small_send_and_recv_tcpL,
<a name="41949"/>41949:            fun() -&gt; has_support_unix_domain_socket() end,
<a name="41950"/>41950:            fun() -&gt;
<a name="41951"/>41951:                    InitState = #{domain =&gt; local,
<a name="41952"/>41952:                                  proto  =&gt; default,
<a name="41953"/>41953:                                  msg    =&gt; Msg,
<a name="41954"/>41954:                                  num    =&gt; Num},
<a name="41955"/>41955:                    ok = traffic_ping_pong_send_and_recv_tcp(InitState)
<a name="41956"/>41956:            end).
<a name="41957"/>41957: 
<a name="41958"/>41958: 
<a name="41959"/>41959: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="41960"/>41960: <i>%% This test case is intended to test that the send and recv functions</i>
<a name="41961"/>41961: <i>%% by repeatedly sending a meassage between two entities.</i>
<a name="41962"/>41962: <i>%% The same basic test case is used for three different message sizes; </i>
<a name="41963"/>41963: <i>%% small (8 bytes), medium (8K) and large (8M).</i>
<a name="41964"/>41964: <i>%% The message is sent from A to B and then back again. This is </i>
<a name="41965"/>41965: <i>%% repeated a set number of times (more times the small the message).</i>
<a name="41966"/>41966: <i>%% This is the 'medium' message test case, for IPv4.</i>
<a name="41967"/>41967: 
<a name="traffic_ping_pong_medium_send_and_recv_tcp4-1"/><a name="41968"/>41968: <b>traffic_ping_pong_medium_send_and_recv_tcp4</b>(Config) when is_list(Config) -&gt;
<a name="41969"/>41969:     Msg = l2b(?TPP_MEDIUM),
<a name="41970"/>41970:     Num = ?TPP_NUM(Config, ?TPP_MEDIUM_NUM),
<a name="traffic_ping_pong_medium_send_and_recv_tcp4-last_expr"/><a name="41971"/>41971: <b>    tc_try</b>(traffic_ping_pong_medium_send_and_recv_tcp4,
<a name="41972"/>41972:            fun() -&gt; has_support_ipv4() end,
<a name="41973"/>41973:            fun() -&gt;
<a name="41974"/>41974:                    ?TT(?SECS(30)),
<a name="41975"/>41975:                    InitState = #{domain =&gt; inet,
<a name="41976"/>41976:                                  proto  =&gt; tcp,
<a name="41977"/>41977:                                  msg    =&gt; Msg,
<a name="41978"/>41978:                                  num    =&gt; Num},
<a name="41979"/>41979:                    ok = traffic_ping_pong_send_and_recv_tcp(InitState)
<a name="41980"/>41980:            end).
<a name="41981"/>41981: 
<a name="41982"/>41982: 
<a name="41983"/>41983: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="41984"/>41984: <i>%% This test case is intended to test that the send and recv functions</i>
<a name="41985"/>41985: <i>%% by repeatedly sending a meassage between two entities.</i>
<a name="41986"/>41986: <i>%% The same basic test case is used for three different message sizes; </i>
<a name="41987"/>41987: <i>%% small (8 bytes), medium (8K) and large (8M).</i>
<a name="41988"/>41988: <i>%% The message is sent from A to B and then back again. This is </i>
<a name="41989"/>41989: <i>%% repeated a set number of times (more times the small the message).</i>
<a name="41990"/>41990: <i>%% This is the 'medium' message test case, for IPv6.</i>
<a name="41991"/>41991: 
<a name="traffic_ping_pong_medium_send_and_recv_tcp6-1"/><a name="41992"/>41992: <b>traffic_ping_pong_medium_send_and_recv_tcp6</b>(Config) when is_list(Config) -&gt;
<a name="41993"/>41993:     Msg = l2b(?TPP_MEDIUM),
<a name="41994"/>41994:     Num = ?TPP_NUM(Config, ?TPP_MEDIUM_NUM),
<a name="traffic_ping_pong_medium_send_and_recv_tcp6-last_expr"/><a name="41995"/>41995: <b>    tc_try</b>(traffic_ping_pong_medium_send_and_recv_tcp6,
<a name="41996"/>41996:            fun() -&gt; has_support_ipv6() end,
<a name="41997"/>41997:            fun() -&gt;
<a name="41998"/>41998:                    ?TT(?SECS(30)),
<a name="41999"/>41999:                    InitState = #{domain =&gt; inet6,
<a name="42000"/>42000:                                  proto  =&gt; tcp,
<a name="42001"/>42001:                                  msg    =&gt; Msg,
<a name="42002"/>42002:                                  num    =&gt; Num},
<a name="42003"/>42003:                    ok = traffic_ping_pong_send_and_recv_tcp(InitState)
<a name="42004"/>42004:            end).
<a name="42005"/>42005: 
<a name="42006"/>42006: 
<a name="42007"/>42007: 
<a name="42008"/>42008: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="42009"/>42009: <i>%% This test case is intended to test that the send and recv functions</i>
<a name="42010"/>42010: <i>%% by repeatedly sending a meassage between two entities.</i>
<a name="42011"/>42011: <i>%% The same basic test case is used for three different message sizes; </i>
<a name="42012"/>42012: <i>%% small (8 bytes), medium (8K) and large (8M).</i>
<a name="42013"/>42013: <i>%% The message is sent from A to B and then back again. This is </i>
<a name="42014"/>42014: <i>%% repeated a set number of times (more times the small the message).</i>
<a name="42015"/>42015: <i>%% This is the 'medium' message test case, for Unix Domain (stream) socket.</i>
<a name="42016"/>42016: 
<a name="traffic_ping_pong_medium_send_and_recv_tcpL-1"/><a name="42017"/>42017: <b>traffic_ping_pong_medium_send_and_recv_tcpL</b>(Config) when is_list(Config) -&gt;
<a name="42018"/>42018:     ?TT(?SECS(30)),
<a name="42019"/>42019:     Msg = l2b(?TPP_MEDIUM),
<a name="42020"/>42020:     Num = ?TPP_NUM(Config, ?TPP_MEDIUM_NUM),
<a name="traffic_ping_pong_medium_send_and_recv_tcpL-last_expr"/><a name="42021"/>42021: <b>    tc_try</b>(traffic_ping_pong_medium_send_and_recv_tcpL,
<a name="42022"/>42022:            fun() -&gt; has_support_unix_domain_socket() end,
<a name="42023"/>42023:            fun() -&gt;
<a name="42024"/>42024:                    InitState = #{domain =&gt; local,
<a name="42025"/>42025:                                  proto  =&gt; default,
<a name="42026"/>42026:                                  msg    =&gt; Msg,
<a name="42027"/>42027:                                  num    =&gt; Num},
<a name="42028"/>42028:                    ok = traffic_ping_pong_send_and_recv_tcp(InitState)
<a name="42029"/>42029:            end).
<a name="42030"/>42030: 
<a name="42031"/>42031: 
<a name="42032"/>42032: 
<a name="42033"/>42033: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="42034"/>42034: <i>%% This test case is intended to test that the send and recv functions</i>
<a name="42035"/>42035: <i>%% by repeatedly sending a meassage between two entities.</i>
<a name="42036"/>42036: <i>%% The same basic test case is used for three different message sizes; </i>
<a name="42037"/>42037: <i>%% small (8 bytes), medium (8K) and large (8M).</i>
<a name="42038"/>42038: <i>%% The message is sent from A to B and then back again. This is </i>
<a name="42039"/>42039: <i>%% repeated a set number of times (more times the small the message).</i>
<a name="42040"/>42040: <i>%% This is the 'large' message test case, for IPv4.</i>
<a name="42041"/>42041: 
<a name="traffic_ping_pong_large_send_and_recv_tcp4-1"/><a name="42042"/>42042: <b>traffic_ping_pong_large_send_and_recv_tcp4</b>(Config) when is_list(Config) -&gt;
<a name="42043"/>42043:     ?TT(?SECS(60)),
<a name="42044"/>42044:     Msg = l2b(?TPP_LARGE),
<a name="42045"/>42045:     Num = ?TPP_NUM(Config, ?TPP_LARGE_NUM),
<a name="traffic_ping_pong_large_send_and_recv_tcp4-last_expr"/><a name="42046"/>42046: <b>    tc_try</b>(traffic_ping_pong_large_send_and_recv_tcp4,
<a name="42047"/>42047:            fun() -&gt; has_support_ipv4(),
<a name="42048"/>42048:                     is_old_fedora16(),
<a name="42049"/>42049: 		    is_slow_ubuntu(Config) end,
<a name="42050"/>42050:            fun() -&gt;
<a name="42051"/>42051:                    InitState = #{domain =&gt; inet,
<a name="42052"/>42052:                                  proto  =&gt; tcp,
<a name="42053"/>42053:                                  msg    =&gt; Msg,
<a name="42054"/>42054:                                  num    =&gt; Num},
<a name="42055"/>42055:                    ok = traffic_ping_pong_send_and_recv_tcp(InitState)
<a name="42056"/>42056:            end).
<a name="42057"/>42057: 
<a name="42058"/>42058: 
<a name="42059"/>42059: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="42060"/>42060: <i>%% This test case is intended to test that the send and recv functions</i>
<a name="42061"/>42061: <i>%% by repeatedly sending a meassage between two entities.</i>
<a name="42062"/>42062: <i>%% The same basic test case is used for three different message sizes; </i>
<a name="42063"/>42063: <i>%% small (8 bytes), medium (8K) and large (8M).</i>
<a name="42064"/>42064: <i>%% The message is sent from A to B and then back again. This is </i>
<a name="42065"/>42065: <i>%% repeated a set number of times (more times the small the message).</i>
<a name="42066"/>42066: <i>%% This is the 'large' message test case, for IPv6.</i>
<a name="42067"/>42067: 
<a name="traffic_ping_pong_large_send_and_recv_tcp6-1"/><a name="42068"/>42068: <b>traffic_ping_pong_large_send_and_recv_tcp6</b>(Config) when is_list(Config) -&gt;
<a name="42069"/>42069:     ?TT(?SECS(60)),
<a name="42070"/>42070:     Msg = l2b(?TPP_LARGE),
<a name="42071"/>42071:     Num = ?TPP_NUM(Config, ?TPP_LARGE_NUM),
<a name="traffic_ping_pong_large_send_and_recv_tcp6-last_expr"/><a name="42072"/>42072: <b>    tc_try</b>(traffic_ping_pong_large_send_and_recv_tcp6,
<a name="42073"/>42073:            fun() -&gt; is_old_fedora16(),
<a name="42074"/>42074:                     has_support_ipv6(),
<a name="42075"/>42075: 		    is_slow_ubuntu(Config) end,
<a name="42076"/>42076:            fun() -&gt;
<a name="42077"/>42077:                    InitState = #{domain =&gt; inet6,
<a name="42078"/>42078:                                  proto  =&gt; tcp,
<a name="42079"/>42079:                                  msg    =&gt; Msg,
<a name="42080"/>42080:                                  num    =&gt; Num},
<a name="42081"/>42081:                    ok = traffic_ping_pong_send_and_recv_tcp(InitState)
<a name="42082"/>42082:            end).
<a name="42083"/>42083: 
<a name="42084"/>42084: 
<a name="42085"/>42085: 
<a name="42086"/>42086: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="42087"/>42087: <i>%% This test case is intended to test that the send and recv functions</i>
<a name="42088"/>42088: <i>%% by repeatedly sending a meassage between two entities.</i>
<a name="42089"/>42089: <i>%% The same basic test case is used for three different message sizes; </i>
<a name="42090"/>42090: <i>%% small (8 bytes), medium (8K) and large (8M).</i>
<a name="42091"/>42091: <i>%% The message is sent from A to B and then back again. This is </i>
<a name="42092"/>42092: <i>%% repeated a set number of times (more times the small the message).</i>
<a name="42093"/>42093: <i>%% This is the 'large' message test case, for UNix Domain (stream) socket.</i>
<a name="42094"/>42094: 
<a name="traffic_ping_pong_large_send_and_recv_tcpL-1"/><a name="42095"/>42095: <b>traffic_ping_pong_large_send_and_recv_tcpL</b>(Config) when is_list(Config) -&gt;
<a name="42096"/>42096:     ?TT(?SECS(60)),
<a name="42097"/>42097:     Msg = l2b(?TPP_LARGE),
<a name="42098"/>42098:     Num = ?TPP_NUM(Config, ?TPP_LARGE_NUM),
<a name="traffic_ping_pong_large_send_and_recv_tcpL-last_expr"/><a name="42099"/>42099: <b>    tc_try</b>(traffic_ping_pong_large_send_and_recv_tcpL,
<a name="42100"/>42100:            fun() -&gt;
<a name="42101"/>42101:                    has_support_unix_domain_socket(),
<a name="42102"/>42102:                    traffic_ping_pong_large_host_cond()
<a name="42103"/>42103:            end,
<a name="42104"/>42104:            fun() -&gt;
<a name="42105"/>42105:                    InitState = #{domain =&gt; local,
<a name="42106"/>42106:                                  proto  =&gt; default,
<a name="42107"/>42107:                                  msg    =&gt; Msg,
<a name="42108"/>42108:                                  num    =&gt; Num},
<a name="42109"/>42109:                    ok = traffic_ping_pong_send_and_recv_tcp(InitState)
<a name="42110"/>42110:            end).
<a name="42111"/>42111: 
<a name="42112"/>42112: <i>%% This test case is a bit extreme and fails on some hosts</i>
<a name="42113"/>42113: <i>%% (e.g. OpenIndiana Hipster), so exclude them.</i>
<a name="traffic_ping_pong_large_host_cond-0"/><a name="42114"/>42114: <b>traffic_ping_pong_large_host_cond</b>() -&gt;
<a name="traffic_ping_pong_large_host_cond-last_expr"/><a name="42115"/>42115: <b>    traffic_ping_pong_large_host_cond</b>(os:type(), os:version()).
<a name="42116"/>42116: 
<a name="traffic_ping_pong_large_host_cond-2"/><a name="42117"/>42117: <b>traffic_ping_pong_large_host_cond</b>({unix, sunos}, _) -&gt;
<a name="42118"/>42118:     skip(&quot;TC does not work on platform&quot;);
<a name="42119"/>42119: <b>traffic_ping_pong_large_host_cond</b>({unix, linux}, _) -&gt;
<a name="42120"/>42120:     traffic_ping_pong_large_host_cond2(string:trim(os:cmd(&quot;cat /etc/issue&quot;)));
<a name="42121"/>42121: <b>traffic_ping_pong_large_host_cond</b>(_, _) -&gt;
<a name="traffic_ping_pong_large_host_cond-last_expr"/><a name="42122"/>42122:     ok.
<a name="42123"/>42123: 
<a name="traffic_ping_pong_large_host_cond2-1"/><a name="42124"/>42124: <b>traffic_ping_pong_large_host_cond2</b>(&quot;Welcome to SUSE Linux Enterprise Server 10 SP1 (i586)&quot; ++ _) -&gt;
<a name="42125"/>42125:     skip(&quot;TC does not work on platform&quot;);
<a name="42126"/>42126: <b>traffic_ping_pong_large_host_cond2</b>(&quot;Fedora release 16 &quot; ++ _) -&gt;
<a name="42127"/>42127:     skip(&quot;Very slow VM&quot;);
<a name="42128"/>42128: <b>traffic_ping_pong_large_host_cond2</b>(_) -&gt;
<a name="traffic_ping_pong_large_host_cond2-last_expr"/><a name="42129"/>42129:     ok.
<a name="42130"/>42130: 
<a name="42131"/>42131: 
<a name="etc_issue-0"/><a name="42132"/>42132: <b>etc_issue</b>() -&gt;
<a name="etc_issue-last_expr"/><a name="42133"/>42133: <b>    string:trim</b>(os:cmd(&quot;cat /etc/issue&quot;)).
<a name="42134"/>42134: 
<a name="is_old_fedora16-0"/><a name="42135"/>42135: <b>is_old_fedora16</b>() -&gt;
<a name="is_old_fedora16-last_expr"/><a name="42136"/>42136: <b>    is_old_fedora16</b>( etc_issue() ).
<a name="42137"/>42137: 
<a name="42138"/>42138: <i>%% We actually only have one host running this, a slow VM.</i>
<a name="is_old_fedora16-1"/><a name="42139"/>42139: <b>is_old_fedora16</b>(&quot;Fedora release 16 &quot; ++ _) -&gt;
<a name="42140"/>42140:     skip(&quot;Very slow VM&quot;);
<a name="42141"/>42141: <b>is_old_fedora16</b>(_) -&gt;
<a name="is_old_fedora16-last_expr"/><a name="42142"/>42142:     ok.
<a name="42143"/>42143: 
<a name="42144"/>42144: 
<a name="42145"/>42145: <i>%% This is a bit subjective, but...</i>
<a name="42146"/>42146: <i>%% ..we have some WMs that is not &quot;fast enough&quot;, but the only</i>
<a name="42147"/>42147: <i>%% thing we can test on is 'esock factor' (other than host name).</i>
<a name="42148"/>42148: <i>%% This means we actually skip this on platforms where its</i>
<a name="42149"/>42149: <i>%% not actually needed.</i>
<a name="42150"/>42150: <i>%% The host in question is a Ubuntu 20.04...</i>
<a name="is_slow_ubuntu-1"/><a name="42151"/>42151: <b>is_slow_ubuntu</b>(Config) -&gt;
<a name="is_slow_ubuntu-last_expr"/><a name="42152"/>42152: <b>    case lookup</b>(kernel_factor, 1, Config) of
<a name="42153"/>42153: 	F when is_integer(F) andalso (F &gt; 1) -&gt;
<a name="42154"/>42154: 	    case os:type() of
<a name="42155"/>42155: 		{unix, linux} -&gt;
<a name="42156"/>42156: 		    case etc_issue() of
<a name="42157"/>42157: 			&quot;Ubuntu 20.04&quot; ++ _ -&gt;
<a name="42158"/>42158: 			    skip(&quot;Slow Ubuntu host&quot;);
<a name="42159"/>42159: 			_ -&gt;
<a name="42160"/>42160: 			    ok
<a name="42161"/>42161: 		    end;
<a name="42162"/>42162: 		_ -&gt;
<a name="42163"/>42163: 		    ok
<a name="42164"/>42164: 	    end;
<a name="42165"/>42165: 	_ -&gt;
<a name="42166"/>42166: 	    ok
<a name="42167"/>42167:     end.
<a name="42168"/>42168: 
<a name="42169"/>42169: 
<a name="42170"/>42170: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="42171"/>42171: <i>%% This test case is intended to test that the sendto and recvfrom </i>
<a name="42172"/>42172: <i>%% functions by repeatedly sending a meassage between two entities.</i>
<a name="42173"/>42173: <i>%% The same basic test case is used for two different message sizes; </i>
<a name="42174"/>42174: <i>%% small (8 bytes) and medium (8K).</i>
<a name="42175"/>42175: <i>%% The message is sent from A to B and then back again. This is </i>
<a name="42176"/>42176: <i>%% repeated a set number of times (more times the small the message).</i>
<a name="42177"/>42177: <i>%% This is the 'small' message test case, for IPv4.</i>
<a name="42178"/>42178: 
<a name="traffic_ping_pong_small_sendto_and_recvfrom_udp4-1"/><a name="42179"/>42179: <b>traffic_ping_pong_small_sendto_and_recvfrom_udp4</b>(Config) when is_list(Config) -&gt;
<a name="42180"/>42180:     Msg = l2b(?TPP_SMALL),
<a name="42181"/>42181:     Num = ?TPP_NUM(Config, ?TPP_SMALL_NUM),
<a name="traffic_ping_pong_small_sendto_and_recvfrom_udp4-last_expr"/><a name="42182"/>42182: <b>    tc_try</b>(traffic_ping_pong_small_sendto_and_recvfrom_udp4,
<a name="42183"/>42183:            fun() -&gt; has_support_ipv4() end,
<a name="42184"/>42184:            fun() -&gt;
<a name="42185"/>42185:                    ?TT(?SECS(45)),
<a name="42186"/>42186:                    InitState = #{domain =&gt; inet,
<a name="42187"/>42187:                                  proto  =&gt; udp,
<a name="42188"/>42188:                                  msg    =&gt; Msg,
<a name="42189"/>42189:                                  num    =&gt; Num},
<a name="42190"/>42190:                    ok = traffic_ping_pong_sendto_and_recvfrom_udp(InitState)
<a name="42191"/>42191:            end).
<a name="42192"/>42192: 
<a name="42193"/>42193: 
<a name="42194"/>42194: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="42195"/>42195: <i>%% This test case is intended to test that the sendto and recvfrom </i>
<a name="42196"/>42196: <i>%% functions by repeatedly sending a meassage between two entities.</i>
<a name="42197"/>42197: <i>%% The same basic test case is used for two different message sizes; </i>
<a name="42198"/>42198: <i>%% small (8 bytes) and medium (8K).</i>
<a name="42199"/>42199: <i>%% The message is sent from A to B and then back again. This is </i>
<a name="42200"/>42200: <i>%% repeated a set number of times (more times the small the message).</i>
<a name="42201"/>42201: <i>%% This is the 'small' message test case, for IPv6.</i>
<a name="42202"/>42202: 
<a name="traffic_ping_pong_small_sendto_and_recvfrom_udp6-1"/><a name="42203"/>42203: <b>traffic_ping_pong_small_sendto_and_recvfrom_udp6</b>(Config) when is_list(Config) -&gt;
<a name="42204"/>42204:     Msg = l2b(?TPP_SMALL),
<a name="42205"/>42205:     Num = ?TPP_NUM(Config, ?TPP_SMALL_NUM),
<a name="traffic_ping_pong_small_sendto_and_recvfrom_udp6-last_expr"/><a name="42206"/>42206: <b>    tc_try</b>(traffic_ping_pong_small_sendto_and_recvfrom_udp6,
<a name="42207"/>42207:            fun() -&gt; has_support_ipv6() end,
<a name="42208"/>42208:            fun() -&gt;
<a name="42209"/>42209:                    ?TT(?SECS(45)),
<a name="42210"/>42210:                    InitState = #{domain =&gt; inet6,
<a name="42211"/>42211:                                  proto  =&gt; udp,
<a name="42212"/>42212:                                  msg    =&gt; Msg,
<a name="42213"/>42213:                                  num    =&gt; Num},
<a name="42214"/>42214:                    ok = traffic_ping_pong_sendto_and_recvfrom_udp(InitState)
<a name="42215"/>42215:            end).
<a name="42216"/>42216: 
<a name="42217"/>42217: 
<a name="42218"/>42218: 
<a name="42219"/>42219: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="42220"/>42220: <i>%% This test case is intended to test that the sendto and recvfrom </i>
<a name="42221"/>42221: <i>%% functions by repeatedly sending a meassage between two entities.</i>
<a name="42222"/>42222: <i>%% The same basic test case is used for two different message sizes; </i>
<a name="42223"/>42223: <i>%% small (8 bytes) and medium (8K).</i>
<a name="42224"/>42224: <i>%% The message is sent from A to B and then back again. This is </i>
<a name="42225"/>42225: <i>%% repeated a set number of times (more times the small the message).</i>
<a name="42226"/>42226: <i>%% This is the 'small' message test case, for Unix Domain (dgram) socket.</i>
<a name="42227"/>42227: 
<a name="traffic_ping_pong_small_sendto_and_recvfrom_udpL-1"/><a name="42228"/>42228: <b>traffic_ping_pong_small_sendto_and_recvfrom_udpL</b>(Config) when is_list(Config) -&gt;
<a name="42229"/>42229:     Msg = l2b(?TPP_SMALL),
<a name="42230"/>42230:     Num = ?TPP_NUM(Config, ?TPP_SMALL_NUM),
<a name="traffic_ping_pong_small_sendto_and_recvfrom_udpL-last_expr"/><a name="42231"/>42231: <b>    tc_try</b>(traffic_ping_pong_small_sendto_and_recvfrom_udpL,
<a name="42232"/>42232:            fun() -&gt;
<a name="42233"/>42233: 		   has_support_unix_domain_socket(),
<a name="42234"/>42234: 		   is_not_windows()
<a name="42235"/>42235: 	   end,
<a name="42236"/>42236:            fun() -&gt;
<a name="42237"/>42237:                    ?TT(?SECS(45)),
<a name="42238"/>42238:                    InitState = #{domain =&gt; local,
<a name="42239"/>42239:                                  proto  =&gt; default,
<a name="42240"/>42240:                                  msg    =&gt; Msg,
<a name="42241"/>42241:                                  num    =&gt; Num},
<a name="42242"/>42242:                    ok = traffic_ping_pong_sendto_and_recvfrom_udp(InitState)
<a name="42243"/>42243:            end).
<a name="42244"/>42244: 
<a name="42245"/>42245: 
<a name="42246"/>42246: 
<a name="42247"/>42247: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="42248"/>42248: <i>%% This test case is intended to test that the sendto and recvfrom </i>
<a name="42249"/>42249: <i>%% functions by repeatedly sending a meassage between two entities.</i>
<a name="42250"/>42250: <i>%% The same basic test case is used for two different message sizes; </i>
<a name="42251"/>42251: <i>%% small (8 bytes) and medium (8K).</i>
<a name="42252"/>42252: <i>%% The message is sent from A to B and then back again. This is </i>
<a name="42253"/>42253: <i>%% repeated a set number of times (more times the small the message).</i>
<a name="42254"/>42254: <i>%% This is the 'medium' message test case, for IPv4.</i>
<a name="42255"/>42255: 
<a name="traffic_ping_pong_medium_sendto_and_recvfrom_udp4-1"/><a name="42256"/>42256: <b>traffic_ping_pong_medium_sendto_and_recvfrom_udp4</b>(Config) when is_list(Config) -&gt;
<a name="42257"/>42257:     Msg = l2b(?TPP_MEDIUM),
<a name="42258"/>42258:     Num = ?TPP_NUM(Config, ?TPP_MEDIUM_NUM),
<a name="traffic_ping_pong_medium_sendto_and_recvfrom_udp4-last_expr"/><a name="42259"/>42259: <b>    tc_try</b>(traffic_ping_pong_medium_sendto_and_recvfrom_udp4,
<a name="42260"/>42260:            fun() -&gt; has_support_ipv4() end,
<a name="42261"/>42261:            fun() -&gt;
<a name="42262"/>42262:                    ?TT(?SECS(45)),
<a name="42263"/>42263:                    InitState = #{domain =&gt; inet,
<a name="42264"/>42264:                                  proto  =&gt; udp,
<a name="42265"/>42265:                                  msg    =&gt; Msg,
<a name="42266"/>42266:                                  num    =&gt; Num},
<a name="42267"/>42267:                    ok = traffic_ping_pong_sendto_and_recvfrom_udp(InitState)
<a name="42268"/>42268:            end).
<a name="42269"/>42269: 
<a name="42270"/>42270: 
<a name="42271"/>42271: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="42272"/>42272: <i>%% This test case is intended to test that the sendto and recvfrom </i>
<a name="42273"/>42273: <i>%% functions by repeatedly sending a meassage between two entities.</i>
<a name="42274"/>42274: <i>%% The same basic test case is used for two different message sizes; </i>
<a name="42275"/>42275: <i>%% small (8 bytes) and medium (8K).</i>
<a name="42276"/>42276: <i>%% The message is sent from A to B and then back again. This is </i>
<a name="42277"/>42277: <i>%% repeated a set number of times (more times the small the message).</i>
<a name="42278"/>42278: <i>%% This is the 'medium' message test case, for IPv6.</i>
<a name="42279"/>42279: 
<a name="traffic_ping_pong_medium_sendto_and_recvfrom_udp6-1"/><a name="42280"/>42280: <b>traffic_ping_pong_medium_sendto_and_recvfrom_udp6</b>(Config) when is_list(Config) -&gt;
<a name="42281"/>42281:     Msg = l2b(?TPP_MEDIUM),
<a name="42282"/>42282:     Num = ?TPP_NUM(Config, ?TPP_MEDIUM_NUM),
<a name="traffic_ping_pong_medium_sendto_and_recvfrom_udp6-last_expr"/><a name="42283"/>42283: <b>    tc_try</b>(traffic_ping_pong_medium_sendto_and_recvfrom_udp6,
<a name="42284"/>42284:            fun() -&gt; has_support_ipv6() end,
<a name="42285"/>42285:            fun() -&gt;
<a name="42286"/>42286:                    ?TT(?SECS(45)),
<a name="42287"/>42287:                    InitState = #{domain =&gt; inet6,
<a name="42288"/>42288:                                  proto  =&gt; udp,
<a name="42289"/>42289:                                  msg    =&gt; Msg,
<a name="42290"/>42290:                                  num    =&gt; Num},
<a name="42291"/>42291:                    ok = traffic_ping_pong_sendto_and_recvfrom_udp(InitState)
<a name="42292"/>42292:            end).
<a name="42293"/>42293: 
<a name="42294"/>42294: 
<a name="42295"/>42295: 
<a name="42296"/>42296: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="42297"/>42297: <i>%% This test case is intended to test that the sendto and recvfrom </i>
<a name="42298"/>42298: <i>%% functions by repeatedly sending a meassage between two entities.</i>
<a name="42299"/>42299: <i>%% The same basic test case is used for two different message sizes; </i>
<a name="42300"/>42300: <i>%% small (8 bytes) and medium (8K).</i>
<a name="42301"/>42301: <i>%% The message is sent from A to B and then back again. This is </i>
<a name="42302"/>42302: <i>%% repeated a set number of times (more times the small the message).</i>
<a name="42303"/>42303: <i>%% This is the 'medium' message test case, for Unix Domain (dgram) socket.</i>
<a name="42304"/>42304: 
<a name="traffic_ping_pong_medium_sendto_and_recvfrom_udpL-1"/><a name="42305"/>42305: <b>traffic_ping_pong_medium_sendto_and_recvfrom_udpL</b>(Config) when is_list(Config) -&gt;
<a name="42306"/>42306:     Msg = l2b(?TPP_MEDIUM),
<a name="42307"/>42307:     Num = ?TPP_NUM(Config, ?TPP_MEDIUM_NUM),
<a name="traffic_ping_pong_medium_sendto_and_recvfrom_udpL-last_expr"/><a name="42308"/>42308: <b>    tc_try</b>(traffic_ping_pong_medium_sendto_and_recvfrom_udpL,
<a name="42309"/>42309:            fun() -&gt;
<a name="42310"/>42310: 		   has_support_unix_domain_socket(),
<a name="42311"/>42311: 		   is_not_windows()
<a name="42312"/>42312: 	   end,
<a name="42313"/>42313:            fun() -&gt;
<a name="42314"/>42314:                    ?TT(?SECS(45)),
<a name="42315"/>42315:                    InitState = #{domain =&gt; local,
<a name="42316"/>42316:                                  proto  =&gt; default,
<a name="42317"/>42317:                                  msg    =&gt; Msg,
<a name="42318"/>42318:                                  num    =&gt; Num},
<a name="42319"/>42319:                    ok = traffic_ping_pong_sendto_and_recvfrom_udp(InitState)
<a name="42320"/>42320:            end).
<a name="42321"/>42321: 
<a name="42322"/>42322: 
<a name="42323"/>42323: 
<a name="42324"/>42324: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="42325"/>42325: <i>%% This test case is intended to test that the sendmsg and recvmsg </i>
<a name="42326"/>42326: <i>%% functions by repeatedly sending a meassage between two entities.</i>
<a name="42327"/>42327: <i>%% The same basic test case is used for three different message sizes; </i>
<a name="42328"/>42328: <i>%% small (8 bytes), medium (8K) and large (8M).</i>
<a name="42329"/>42329: <i>%% The message is sent from A to B and then back again. This is </i>
<a name="42330"/>42330: <i>%% repeated a set number of times (more times the small the message).</i>
<a name="42331"/>42331: <i>%% This is the 'small' message test case, for IPv4.</i>
<a name="42332"/>42332: 
<a name="traffic_ping_pong_small_sendmsg_and_recvmsg_tcp4-1"/><a name="42333"/>42333: <b>traffic_ping_pong_small_sendmsg_and_recvmsg_tcp4</b>(Config) when is_list(Config) -&gt;
<a name="42334"/>42334:     Msg = l2b(?TPP_SMALL),
<a name="42335"/>42335:     Num = ?TPP_NUM(Config, ?TPP_SMALL_NUM),
<a name="traffic_ping_pong_small_sendmsg_and_recvmsg_tcp4-last_expr"/><a name="42336"/>42336: <b>    tc_try</b>(traffic_ping_pong_small_sendmsg_and_recvmsg_tcp4,
<a name="42337"/>42337:            fun() -&gt;
<a name="42338"/>42338:                    is_not_windows(),
<a name="42339"/>42339:                    has_support_ipv4()
<a name="42340"/>42340:            end,
<a name="42341"/>42341:            fun() -&gt;
<a name="42342"/>42342:                    ?TT(?SECS(20)),
<a name="42343"/>42343:                    InitState = #{domain =&gt; inet,
<a name="42344"/>42344:                                  proto  =&gt; tcp,
<a name="42345"/>42345:                                  msg    =&gt; Msg,
<a name="42346"/>42346:                                  num    =&gt; Num},
<a name="42347"/>42347:                    ok = traffic_ping_pong_sendmsg_and_recvmsg_tcp(InitState)
<a name="42348"/>42348:            end).
<a name="42349"/>42349: 
<a name="42350"/>42350: 
<a name="42351"/>42351: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="42352"/>42352: <i>%% This test case is intended to test that the sendmsg and recvmsg functions</i>
<a name="42353"/>42353: <i>%% by repeatedly sending a meassage between two entities.</i>
<a name="42354"/>42354: <i>%% The same basic test case is used for three different message sizes; </i>
<a name="42355"/>42355: <i>%% small (8 bytes), medium (8K) and large (8M).</i>
<a name="42356"/>42356: <i>%% The message is sent from A to B and then back again. This is </i>
<a name="42357"/>42357: <i>%% repeated a set number of times (more times the small the message).</i>
<a name="42358"/>42358: <i>%% This is the 'small' message test case, for IPv6.</i>
<a name="42359"/>42359: 
<a name="traffic_ping_pong_small_sendmsg_and_recvmsg_tcp6-1"/><a name="42360"/>42360: <b>traffic_ping_pong_small_sendmsg_and_recvmsg_tcp6</b>(Config) when is_list(Config) -&gt;
<a name="42361"/>42361:     Msg = l2b(?TPP_SMALL),
<a name="42362"/>42362:     Num = ?TPP_NUM(Config, ?TPP_SMALL_NUM),
<a name="traffic_ping_pong_small_sendmsg_and_recvmsg_tcp6-last_expr"/><a name="42363"/>42363: <b>    tc_try</b>(traffic_ping_pong_small_sendmsg_and_recvmsg_tcp6,
<a name="42364"/>42364:            fun() -&gt;
<a name="42365"/>42365:                    is_not_windows(),
<a name="42366"/>42366:                    has_support_ipv6()
<a name="42367"/>42367:            end,
<a name="42368"/>42368:            fun() -&gt;
<a name="42369"/>42369:                    ?TT(?SECS(20)),
<a name="42370"/>42370:                    InitState = #{domain =&gt; inet6,
<a name="42371"/>42371:                                  proto  =&gt; tcp,
<a name="42372"/>42372:                                  msg    =&gt; Msg,
<a name="42373"/>42373:                                  num    =&gt; Num},
<a name="42374"/>42374:                    ok = traffic_ping_pong_sendmsg_and_recvmsg_tcp(InitState)
<a name="42375"/>42375:            end).
<a name="42376"/>42376: 
<a name="42377"/>42377: 
<a name="42378"/>42378: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="42379"/>42379: <i>%% This test case is intended to test that the sendmsg and recvmsg functions</i>
<a name="42380"/>42380: <i>%% by repeatedly sending a meassage between two entities.</i>
<a name="42381"/>42381: <i>%% The same basic test case is used for three different message sizes; </i>
<a name="42382"/>42382: <i>%% small (8 bytes), medium (8K) and large (8M).</i>
<a name="42383"/>42383: <i>%% The message is sent from A to B and then back again. This is </i>
<a name="42384"/>42384: <i>%% repeated a set number of times (more times the small the message).</i>
<a name="42385"/>42385: <i>%% This is the 'small' message test case, for Unix Domain (stream) socket.</i>
<a name="42386"/>42386: 
<a name="traffic_ping_pong_small_sendmsg_and_recvmsg_tcpL-1"/><a name="42387"/>42387: <b>traffic_ping_pong_small_sendmsg_and_recvmsg_tcpL</b>(Config) when is_list(Config) -&gt;
<a name="42388"/>42388:     Msg = l2b(?TPP_SMALL),
<a name="42389"/>42389:     Num = ?TPP_NUM(Config, ?TPP_SMALL_NUM),
<a name="traffic_ping_pong_small_sendmsg_and_recvmsg_tcpL-last_expr"/><a name="42390"/>42390: <b>    tc_try</b>(traffic_ping_pong_small_sendmsg_and_recvmsg_tcpL,
<a name="42391"/>42391:            fun() -&gt;
<a name="42392"/>42392:                    is_not_windows(),
<a name="42393"/>42393: 		   has_support_unix_domain_socket()
<a name="42394"/>42394: 	   end,
<a name="42395"/>42395:            fun() -&gt;
<a name="42396"/>42396:                    ?TT(?SECS(20)),
<a name="42397"/>42397:                    InitState = #{domain =&gt; local,
<a name="42398"/>42398:                                  proto  =&gt; default,
<a name="42399"/>42399:                                  msg    =&gt; Msg,
<a name="42400"/>42400:                                  num    =&gt; Num},
<a name="42401"/>42401:                    ok = traffic_ping_pong_sendmsg_and_recvmsg_tcp(InitState)
<a name="42402"/>42402:            end).
<a name="42403"/>42403: 
<a name="42404"/>42404: 
<a name="42405"/>42405: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="42406"/>42406: <i>%% This test case is intended to test that the sendmsg and recvmsg </i>
<a name="42407"/>42407: <i>%% functions by repeatedly sending a meassage between two entities.</i>
<a name="42408"/>42408: <i>%% The same basic test case is used for three different message sizes; </i>
<a name="42409"/>42409: <i>%% small (8 bytes), medium (8K) and large (8M).</i>
<a name="42410"/>42410: <i>%% The message is sent from A to B and then back again. This is </i>
<a name="42411"/>42411: <i>%% repeated a set number of times (more times the small the message).</i>
<a name="42412"/>42412: <i>%% This is the 'medium' message test case, for IPv4.</i>
<a name="42413"/>42413: 
<a name="traffic_ping_pong_medium_sendmsg_and_recvmsg_tcp4-1"/><a name="42414"/>42414: <b>traffic_ping_pong_medium_sendmsg_and_recvmsg_tcp4</b>(Config) when is_list(Config) -&gt;
<a name="42415"/>42415:     Msg = l2b(?TPP_MEDIUM),
<a name="42416"/>42416:     Num = ?TPP_NUM(Config, ?TPP_MEDIUM_NUM),
<a name="traffic_ping_pong_medium_sendmsg_and_recvmsg_tcp4-last_expr"/><a name="42417"/>42417: <b>    tc_try</b>(traffic_ping_pong_medium_sendmsg_and_recvmsg_tcp4,
<a name="42418"/>42418:            fun() -&gt;
<a name="42419"/>42419:                    is_not_windows(),
<a name="42420"/>42420:                    has_support_ipv4()
<a name="42421"/>42421:            end,
<a name="42422"/>42422:            fun() -&gt;
<a name="42423"/>42423:                    ?TT(?SECS(30)),
<a name="42424"/>42424:                    InitState = #{domain =&gt; inet,
<a name="42425"/>42425:                                  proto  =&gt; tcp,
<a name="42426"/>42426:                                  msg    =&gt; Msg,
<a name="42427"/>42427:                                  num    =&gt; Num},
<a name="42428"/>42428:                    ok = traffic_ping_pong_sendmsg_and_recvmsg_tcp(InitState)
<a name="42429"/>42429:            end).
<a name="42430"/>42430: 
<a name="42431"/>42431: 
<a name="42432"/>42432: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="42433"/>42433: <i>%% This test case is intended to test that the sendmsg and recvmsg functions</i>
<a name="42434"/>42434: <i>%% by repeatedly sending a meassage between two entities.</i>
<a name="42435"/>42435: <i>%% The same basic test case is used for three different message sizes; </i>
<a name="42436"/>42436: <i>%% small (8 bytes), medium (8K) and large (8M).</i>
<a name="42437"/>42437: <i>%% The message is sent from A to B and then back again. This is </i>
<a name="42438"/>42438: <i>%% repeated a set number of times (more times the small the message).</i>
<a name="42439"/>42439: <i>%% This is the 'medium' message test case, for IPv6.</i>
<a name="42440"/>42440: 
<a name="traffic_ping_pong_medium_sendmsg_and_recvmsg_tcp6-1"/><a name="42441"/>42441: <b>traffic_ping_pong_medium_sendmsg_and_recvmsg_tcp6</b>(Config) when is_list(Config) -&gt;
<a name="42442"/>42442:     Msg = l2b(?TPP_MEDIUM),
<a name="42443"/>42443:     Num = ?TPP_NUM(Config, ?TPP_MEDIUM_NUM),
<a name="traffic_ping_pong_medium_sendmsg_and_recvmsg_tcp6-last_expr"/><a name="42444"/>42444: <b>    tc_try</b>(traffic_ping_pong_medium_sendmsg_and_recvmsg_tcp6,
<a name="42445"/>42445:            fun() -&gt;
<a name="42446"/>42446:                    is_not_windows(),
<a name="42447"/>42447:                    has_support_ipv6()
<a name="42448"/>42448:            end,
<a name="42449"/>42449:            fun() -&gt;
<a name="42450"/>42450:                    ?TT(?SECS(30)),
<a name="42451"/>42451:                    InitState = #{domain =&gt; inet6,
<a name="42452"/>42452:                                  proto  =&gt; tcp,
<a name="42453"/>42453:                                  msg    =&gt; Msg,
<a name="42454"/>42454:                                  num    =&gt; Num},
<a name="42455"/>42455:                    ok = traffic_ping_pong_sendmsg_and_recvmsg_tcp(InitState)
<a name="42456"/>42456:            end).
<a name="42457"/>42457: 
<a name="42458"/>42458: 
<a name="42459"/>42459: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="42460"/>42460: <i>%% This test case is intended to test that the sendmsg and recvmsg functions</i>
<a name="42461"/>42461: <i>%% by repeatedly sending a meassage between two entities.</i>
<a name="42462"/>42462: <i>%% The same basic test case is used for three different message sizes; </i>
<a name="42463"/>42463: <i>%% small (8 bytes), medium (8K) and large (8M).</i>
<a name="42464"/>42464: <i>%% The message is sent from A to B and then back again. This is </i>
<a name="42465"/>42465: <i>%% repeated a set number of times (more times the small the message).</i>
<a name="42466"/>42466: <i>%% This is the 'medium' message test case, for Unix Domain (stream) socket.</i>
<a name="42467"/>42467: 
<a name="traffic_ping_pong_medium_sendmsg_and_recvmsg_tcpL-1"/><a name="42468"/>42468: <b>traffic_ping_pong_medium_sendmsg_and_recvmsg_tcpL</b>(Config) when is_list(Config) -&gt;
<a name="42469"/>42469:     Msg = l2b(?TPP_MEDIUM),
<a name="42470"/>42470:     Num = ?TPP_NUM(Config, ?TPP_MEDIUM_NUM),
<a name="traffic_ping_pong_medium_sendmsg_and_recvmsg_tcpL-last_expr"/><a name="42471"/>42471: <b>    tc_try</b>(traffic_ping_pong_medium_sendmsg_and_recvmsg_tcpL,
<a name="42472"/>42472:            fun() -&gt;
<a name="42473"/>42473:                    is_not_windows(),
<a name="42474"/>42474: 		   has_support_unix_domain_socket()
<a name="42475"/>42475: 	   end,
<a name="42476"/>42476:            fun() -&gt;
<a name="42477"/>42477:                    ?TT(?SECS(30)),
<a name="42478"/>42478:                    InitState = #{domain =&gt; local,
<a name="42479"/>42479:                                  proto  =&gt; default,
<a name="42480"/>42480:                                  msg    =&gt; Msg,
<a name="42481"/>42481:                                  num    =&gt; Num},
<a name="42482"/>42482:                    ok = traffic_ping_pong_sendmsg_and_recvmsg_tcp(InitState)
<a name="42483"/>42483:            end).
<a name="42484"/>42484: 
<a name="42485"/>42485: 
<a name="42486"/>42486: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="42487"/>42487: <i>%% This test case is intended to test that the sendmsg and recvmsg </i>
<a name="42488"/>42488: <i>%% functions by repeatedly sending a meassage between two entities.</i>
<a name="42489"/>42489: <i>%% The same basic test case is used for three different message sizes; </i>
<a name="42490"/>42490: <i>%% small (8 bytes), medium (8K) and large (8M).</i>
<a name="42491"/>42491: <i>%% The message is sent from A to B and then back again. This is </i>
<a name="42492"/>42492: <i>%% repeated a set number of times (more times the small the message).</i>
<a name="42493"/>42493: <i>%% This is the 'large' message test case, for IPv4.</i>
<a name="42494"/>42494: 
<a name="traffic_ping_pong_large_sendmsg_and_recvmsg_tcp4-1"/><a name="42495"/>42495: <b>traffic_ping_pong_large_sendmsg_and_recvmsg_tcp4</b>(Config) when is_list(Config) -&gt;
<a name="42496"/>42496:     Msg = l2b(?TPP_LARGE),
<a name="42497"/>42497:     Num = ?TPP_NUM(Config, ?TPP_LARGE_NUM),
<a name="traffic_ping_pong_large_sendmsg_and_recvmsg_tcp4-last_expr"/><a name="42498"/>42498: <b>    tc_try</b>(traffic_ping_pong_large_sendmsg_and_recvmsg_tcp4,
<a name="42499"/>42499:            fun() -&gt;
<a name="42500"/>42500:                    is_not_windows(),
<a name="42501"/>42501:                    has_support_ipv4(),
<a name="42502"/>42502:                    traffic_ping_pong_large_sendmsg_and_recvmsg_cond()
<a name="42503"/>42503:            end,
<a name="42504"/>42504:            fun() -&gt;
<a name="42505"/>42505:                    ?TT(?SECS(60)),
<a name="42506"/>42506:                    InitState = #{domain =&gt; inet,
<a name="42507"/>42507:                                  proto  =&gt; tcp,
<a name="42508"/>42508:                                  msg    =&gt; Msg,
<a name="42509"/>42509:                                  num    =&gt; Num},
<a name="42510"/>42510:                    ok = traffic_ping_pong_sendmsg_and_recvmsg_tcp(InitState)
<a name="42511"/>42511:            end).
<a name="42512"/>42512: 
<a name="42513"/>42513: 
<a name="traffic_ping_pong_large_sendmsg_and_recvmsg_cond-0"/><a name="42514"/>42514: <b>traffic_ping_pong_large_sendmsg_and_recvmsg_cond</b>() -&gt;
<a name="traffic_ping_pong_large_sendmsg_and_recvmsg_cond-last_expr"/><a name="42515"/>42515: <b>    traffic_ping_pong_large_sendmsg_and_recvmsg_cond</b>(os:type(), os:version()).
<a name="42516"/>42516: 
<a name="traffic_ping_pong_large_sendmsg_and_recvmsg_cond-2"/><a name="42517"/>42517: <b>traffic_ping_pong_large_sendmsg_and_recvmsg_cond</b>({unix, linux}, {M, _, _})
<a name="42518"/>42518:   when (M &lt; 3) -&gt;
<a name="42519"/>42519:     skip(&quot;TC may not work on this version&quot;);
<a name="42520"/>42520: <b>traffic_ping_pong_large_sendmsg_and_recvmsg_cond</b>(_, _) -&gt;
<a name="traffic_ping_pong_large_sendmsg_and_recvmsg_cond-last_expr"/><a name="42521"/>42521:     ok.
<a name="42522"/>42522: 
<a name="42523"/>42523: 
<a name="42524"/>42524: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="42525"/>42525: <i>%% This test case is intended to test that the sendmsg and recvmsg functions</i>
<a name="42526"/>42526: <i>%% by repeatedly sending a meassage between two entities.</i>
<a name="42527"/>42527: <i>%% The same basic test case is used for three different message sizes; </i>
<a name="42528"/>42528: <i>%% small (8 bytes), medium (8K) and large (8M).</i>
<a name="42529"/>42529: <i>%% The message is sent from A to B and then back again. This is </i>
<a name="42530"/>42530: <i>%% repeated a set number of times (more times the small the message).</i>
<a name="42531"/>42531: <i>%% This is the 'large' message test case, for IPv6.</i>
<a name="42532"/>42532: 
<a name="traffic_ping_pong_large_sendmsg_and_recvmsg_tcp6-1"/><a name="42533"/>42533: <b>traffic_ping_pong_large_sendmsg_and_recvmsg_tcp6</b>(Config) when is_list(Config) -&gt;
<a name="42534"/>42534:     Msg = l2b(?TPP_LARGE),
<a name="42535"/>42535:     Num = ?TPP_NUM(Config, ?TPP_LARGE_NUM),
<a name="traffic_ping_pong_large_sendmsg_and_recvmsg_tcp6-last_expr"/><a name="42536"/>42536: <b>    tc_try</b>(traffic_ping_pong_large_sendmsg_and_recvmsg_tcp6,
<a name="42537"/>42537:            fun() -&gt;
<a name="42538"/>42538:                    is_not_windows(),
<a name="42539"/>42539:                    has_support_ipv6(),
<a name="42540"/>42540:                    traffic_ping_pong_large_sendmsg_and_recvmsg_cond()
<a name="42541"/>42541:            end,
<a name="42542"/>42542:            fun() -&gt;
<a name="42543"/>42543:                    ?TT(?SECS(60)),
<a name="42544"/>42544:                    InitState = #{domain =&gt; inet6,
<a name="42545"/>42545:                                  proto  =&gt; tcp,
<a name="42546"/>42546:                                  msg    =&gt; Msg,
<a name="42547"/>42547:                                  num    =&gt; Num},
<a name="42548"/>42548:                    ok = traffic_ping_pong_sendmsg_and_recvmsg_tcp(InitState)
<a name="42549"/>42549:            end).
<a name="42550"/>42550: 
<a name="42551"/>42551: 
<a name="42552"/>42552: 
<a name="42553"/>42553: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="42554"/>42554: <i>%% This test case is intended to test that the sendmsg and recvmsg functions</i>
<a name="42555"/>42555: <i>%% by repeatedly sending a meassage between two entities.</i>
<a name="42556"/>42556: <i>%% The same basic test case is used for three different message sizes; </i>
<a name="42557"/>42557: <i>%% small (8 bytes), medium (8K) and large (8M).</i>
<a name="42558"/>42558: <i>%% The message is sent from A to B and then back again. This is </i>
<a name="42559"/>42559: <i>%% repeated a set number of times (more times the small the message).</i>
<a name="42560"/>42560: <i>%% This is the 'large' message test case, for Unix Domain (stream) socket.</i>
<a name="42561"/>42561: 
<a name="traffic_ping_pong_large_sendmsg_and_recvmsg_tcpL-1"/><a name="42562"/>42562: <b>traffic_ping_pong_large_sendmsg_and_recvmsg_tcpL</b>(Config) when is_list(Config) -&gt;
<a name="42563"/>42563:     Msg = l2b(?TPP_LARGE),
<a name="42564"/>42564:     Num = ?TPP_NUM(Config, ?TPP_LARGE_NUM),
<a name="traffic_ping_pong_large_sendmsg_and_recvmsg_tcpL-last_expr"/><a name="42565"/>42565: <b>    tc_try</b>(traffic_ping_pong_large_sendmsg_and_recvmsg_tcpL,
<a name="42566"/>42566:            fun() -&gt;
<a name="42567"/>42567:                    is_not_windows(),
<a name="42568"/>42568: 		   has_support_unix_domain_socket()
<a name="42569"/>42569: 	   end,
<a name="42570"/>42570:            fun() -&gt;
<a name="42571"/>42571:                    ?TT(?SECS(60)),
<a name="42572"/>42572:                    InitState = #{domain =&gt; local,
<a name="42573"/>42573:                                  proto  =&gt; default,
<a name="42574"/>42574:                                  msg    =&gt; Msg,
<a name="42575"/>42575:                                  num    =&gt; Num},
<a name="42576"/>42576:                    ok = traffic_ping_pong_sendmsg_and_recvmsg_tcp(InitState)
<a name="42577"/>42577:            end).
<a name="42578"/>42578: 
<a name="42579"/>42579: 
<a name="42580"/>42580: 
<a name="42581"/>42581: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="42582"/>42582: <i>%% This test case is intended to test that the sendmsg and recvmsg </i>
<a name="42583"/>42583: <i>%% functions by repeatedly sending a meassage between two entities.</i>
<a name="42584"/>42584: <i>%% The same basic test case is used for three different message sizes; </i>
<a name="42585"/>42585: <i>%% small (8 bytes) and medium (8K).</i>
<a name="42586"/>42586: <i>%% The message is sent from A to B and then back again. This is </i>
<a name="42587"/>42587: <i>%% repeated a set number of times (more times the small the message).</i>
<a name="42588"/>42588: <i>%% This is the 'small' message test case, for IPv4.</i>
<a name="42589"/>42589: 
<a name="traffic_ping_pong_small_sendmsg_and_recvmsg_udp4-1"/><a name="42590"/>42590: <b>traffic_ping_pong_small_sendmsg_and_recvmsg_udp4</b>(Config) when is_list(Config) -&gt;
<a name="42591"/>42591:     Msg = l2b(?TPP_SMALL),
<a name="42592"/>42592:     Num = ?TPP_NUM(Config, ?TPP_SMALL_NUM),
<a name="traffic_ping_pong_small_sendmsg_and_recvmsg_udp4-last_expr"/><a name="42593"/>42593: <b>    tc_try</b>(traffic_ping_pong_small_sendmsg_and_recvmsg_udp4,
<a name="42594"/>42594:            fun() -&gt; has_support_ipv4() end,
<a name="42595"/>42595:            fun() -&gt;
<a name="42596"/>42596:                    ?TT(?SECS(60)),
<a name="42597"/>42597:                    InitState = #{domain =&gt; inet,
<a name="42598"/>42598:                                  proto  =&gt; udp,
<a name="42599"/>42599:                                  msg    =&gt; Msg,
<a name="42600"/>42600:                                  num    =&gt; Num},
<a name="42601"/>42601:                    ok = traffic_ping_pong_sendmsg_and_recvmsg_udp(InitState)
<a name="42602"/>42602:            end).
<a name="42603"/>42603: 
<a name="42604"/>42604: 
<a name="42605"/>42605: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="42606"/>42606: <i>%% This test case is intended to test that the sendmsg and recvmsg functions</i>
<a name="42607"/>42607: <i>%% by repeatedly sending a meassage between two entities.</i>
<a name="42608"/>42608: <i>%% The same basic test case is used for three different message sizes; </i>
<a name="42609"/>42609: <i>%% small (8 bytes) and medium (8K).</i>
<a name="42610"/>42610: <i>%% The message is sent from A to B and then back again. This is </i>
<a name="42611"/>42611: <i>%% repeated a set number of times (more times the small the message).</i>
<a name="42612"/>42612: <i>%% This is the 'small' message test case, for IPv6.</i>
<a name="42613"/>42613: 
<a name="traffic_ping_pong_small_sendmsg_and_recvmsg_udp6-1"/><a name="42614"/>42614: <b>traffic_ping_pong_small_sendmsg_and_recvmsg_udp6</b>(Config) when is_list(Config) -&gt;
<a name="42615"/>42615:     Msg = l2b(?TPP_SMALL),
<a name="42616"/>42616:     Num = ?TPP_NUM(Config, ?TPP_SMALL_NUM),
<a name="traffic_ping_pong_small_sendmsg_and_recvmsg_udp6-last_expr"/><a name="42617"/>42617: <b>    tc_try</b>(traffic_ping_pong_small_sendmsg_and_recvmsg_udp6,
<a name="42618"/>42618:            fun() -&gt; has_support_ipv6() end,
<a name="42619"/>42619:            fun() -&gt;
<a name="42620"/>42620:                    ?TT(?SECS(60)),
<a name="42621"/>42621:                    InitState = #{domain =&gt; inet6,
<a name="42622"/>42622:                                  proto  =&gt; udp,
<a name="42623"/>42623:                                  msg    =&gt; Msg,
<a name="42624"/>42624:                                  num    =&gt; Num},
<a name="42625"/>42625:                    ok = traffic_ping_pong_sendmsg_and_recvmsg_udp(InitState)
<a name="42626"/>42626:            end).
<a name="42627"/>42627: 
<a name="42628"/>42628: 
<a name="42629"/>42629: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="42630"/>42630: <i>%% This test case is intended to test that the sendmsg and recvmsg functions</i>
<a name="42631"/>42631: <i>%% by repeatedly sending a meassage between two entities.</i>
<a name="42632"/>42632: <i>%% The same basic test case is used for three different message sizes; </i>
<a name="42633"/>42633: <i>%% small (8 bytes) and medium (8K).</i>
<a name="42634"/>42634: <i>%% The message is sent from A to B and then back again. This is </i>
<a name="42635"/>42635: <i>%% repeated a set number of times (more times the small the message).</i>
<a name="42636"/>42636: <i>%% This is the 'small' message test case, for Unix Domain (dgram) socket.</i>
<a name="42637"/>42637: 
<a name="traffic_ping_pong_small_sendmsg_and_recvmsg_udpL-1"/><a name="42638"/>42638: <b>traffic_ping_pong_small_sendmsg_and_recvmsg_udpL</b>(Config) when is_list(Config) -&gt;
<a name="42639"/>42639:     Msg = l2b(?TPP_SMALL),
<a name="42640"/>42640:     Num = ?TPP_NUM(Config, ?TPP_SMALL_NUM),
<a name="traffic_ping_pong_small_sendmsg_and_recvmsg_udpL-last_expr"/><a name="42641"/>42641: <b>    tc_try</b>(traffic_ping_pong_small_sendmsg_and_recvmsg_udpL,
<a name="42642"/>42642:            fun() -&gt;
<a name="42643"/>42643: 		   has_support_unix_domain_socket(),
<a name="42644"/>42644: 		   is_not_windows()
<a name="42645"/>42645: 	   end,
<a name="42646"/>42646:            fun() -&gt;
<a name="42647"/>42647:                    ?TT(?SECS(60)),
<a name="42648"/>42648:                    InitState = #{domain =&gt; local,
<a name="42649"/>42649:                                  proto  =&gt; default,
<a name="42650"/>42650:                                  msg    =&gt; Msg,
<a name="42651"/>42651:                                  num    =&gt; Num},
<a name="42652"/>42652:                    ok = traffic_ping_pong_sendmsg_and_recvmsg_udp(InitState)
<a name="42653"/>42653:            end).
<a name="42654"/>42654: 
<a name="42655"/>42655: 
<a name="42656"/>42656: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="42657"/>42657: <i>%% This test case is intended to test that the sendmsg and recvmsg </i>
<a name="42658"/>42658: <i>%% functions by repeatedly sending a meassage between two entities.</i>
<a name="42659"/>42659: <i>%% The same basic test case is used for three different message sizes; </i>
<a name="42660"/>42660: <i>%% small (8 bytes) and medium (8K).</i>
<a name="42661"/>42661: <i>%% The message is sent from A to B and then back again. This is </i>
<a name="42662"/>42662: <i>%% repeated a set number of times (more times the small the message).</i>
<a name="42663"/>42663: <i>%% This is the 'medium' message test case, for IPv4.</i>
<a name="42664"/>42664: 
<a name="traffic_ping_pong_medium_sendmsg_and_recvmsg_udp4-1"/><a name="42665"/>42665: <b>traffic_ping_pong_medium_sendmsg_and_recvmsg_udp4</b>(Config) when is_list(Config) -&gt;
<a name="42666"/>42666:     Msg = l2b(?TPP_MEDIUM),
<a name="42667"/>42667:     Num = ?TPP_NUM(Config, ?TPP_MEDIUM_NUM),
<a name="traffic_ping_pong_medium_sendmsg_and_recvmsg_udp4-last_expr"/><a name="42668"/>42668: <b>    tc_try</b>(traffic_ping_pong_medium_sendmsg_and_recvmsg_udp4,
<a name="42669"/>42669:            fun() -&gt; has_support_ipv4() end,
<a name="42670"/>42670:            fun() -&gt;
<a name="42671"/>42671:                    ?TT(?SECS(60)),
<a name="42672"/>42672:                    InitState = #{domain =&gt; inet,
<a name="42673"/>42673:                                  proto  =&gt; udp,
<a name="42674"/>42674:                                  msg    =&gt; Msg,
<a name="42675"/>42675:                                  num    =&gt; Num},
<a name="42676"/>42676:                    ok = traffic_ping_pong_sendmsg_and_recvmsg_udp(InitState)
<a name="42677"/>42677:            end).
<a name="42678"/>42678: 
<a name="42679"/>42679: 
<a name="42680"/>42680: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="42681"/>42681: <i>%% This test case is intended to test that the sendmsg and recvmsg </i>
<a name="42682"/>42682: <i>%% functions by repeatedly sending a meassage between two entities.</i>
<a name="42683"/>42683: <i>%% The same basic test case is used for three different message sizes; </i>
<a name="42684"/>42684: <i>%% small (8 bytes) and medium (8K).</i>
<a name="42685"/>42685: <i>%% The message is sent from A to B and then back again. This is </i>
<a name="42686"/>42686: <i>%% repeated a set number of times (more times the small the message).</i>
<a name="42687"/>42687: <i>%% This is the 'medium' message test case, for IPv6.</i>
<a name="42688"/>42688: 
<a name="traffic_ping_pong_medium_sendmsg_and_recvmsg_udp6-1"/><a name="42689"/>42689: <b>traffic_ping_pong_medium_sendmsg_and_recvmsg_udp6</b>(Config) when is_list(Config) -&gt;
<a name="42690"/>42690:     Msg = l2b(?TPP_MEDIUM),
<a name="42691"/>42691:     Num = ?TPP_NUM(Config, ?TPP_MEDIUM_NUM),
<a name="traffic_ping_pong_medium_sendmsg_and_recvmsg_udp6-last_expr"/><a name="42692"/>42692: <b>    tc_try</b>(traffic_ping_pong_medium_sendmsg_and_recvmsg_udp6,
<a name="42693"/>42693:            fun() -&gt; has_support_ipv6() end,
<a name="42694"/>42694:            fun() -&gt;
<a name="42695"/>42695:                    ?TT(?SECS(60)),
<a name="42696"/>42696:                    InitState = #{domain =&gt; inet6,
<a name="42697"/>42697:                                  proto  =&gt; udp,
<a name="42698"/>42698:                                  msg    =&gt; Msg,
<a name="42699"/>42699:                                  num    =&gt; Num},
<a name="42700"/>42700:                    ok = traffic_ping_pong_sendmsg_and_recvmsg_udp(InitState)
<a name="42701"/>42701:            end).
<a name="42702"/>42702: 
<a name="42703"/>42703: 
<a name="42704"/>42704: 
<a name="42705"/>42705: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="42706"/>42706: <i>%% This test case is intended to test that the sendmsg and recvmsg </i>
<a name="42707"/>42707: <i>%% functions by repeatedly sending a meassage between two entities.</i>
<a name="42708"/>42708: <i>%% The same basic test case is used for three different message sizes; </i>
<a name="42709"/>42709: <i>%% small (8 bytes) and medium (8K).</i>
<a name="42710"/>42710: <i>%% The message is sent from A to B and then back again. This is </i>
<a name="42711"/>42711: <i>%% repeated a set number of times (more times the small the message).</i>
<a name="42712"/>42712: <i>%% This is the 'medium' message test case, for Unix Domain (dgram) socket.</i>
<a name="42713"/>42713: 
<a name="traffic_ping_pong_medium_sendmsg_and_recvmsg_udpL-1"/><a name="42714"/>42714: <b>traffic_ping_pong_medium_sendmsg_and_recvmsg_udpL</b>(Config) when is_list(Config) -&gt;
<a name="42715"/>42715:     Msg = l2b(?TPP_MEDIUM),
<a name="42716"/>42716:     Num = ?TPP_NUM(Config, ?TPP_MEDIUM_NUM),
<a name="traffic_ping_pong_medium_sendmsg_and_recvmsg_udpL-last_expr"/><a name="42717"/>42717: <b>    tc_try</b>(traffic_ping_pong_medium_sendmsg_and_recvmsg_udpL,
<a name="42718"/>42718:            fun() -&gt;
<a name="42719"/>42719: 		   has_support_unix_domain_socket(),
<a name="42720"/>42720: 		   is_not_windows()
<a name="42721"/>42721: 	   end,
<a name="42722"/>42722:            fun() -&gt;
<a name="42723"/>42723:                    ?TT(?SECS(60)),
<a name="42724"/>42724:                    InitState = #{domain =&gt; local,
<a name="42725"/>42725:                                  proto  =&gt; default,
<a name="42726"/>42726:                                  msg    =&gt; Msg,
<a name="42727"/>42727:                                  num    =&gt; Num},
<a name="42728"/>42728:                    ok = traffic_ping_pong_sendmsg_and_recvmsg_udp(InitState)
<a name="42729"/>42729:            end).
<a name="42730"/>42730: 
<a name="42731"/>42731: 
<a name="42732"/>42732: 
<a name="42733"/>42733: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="42734"/>42734: 
<a name="42735"/>42735: <i>%% Ping-Pong for TCP</i>
<a name="42736"/>42736: 
<a name="traffic_ping_pong_send_and_recv_tcp-1"/><a name="42737"/>42737: <b>traffic_ping_pong_send_and_recv_tcp</b>(InitState) -&gt;
<a name="42738"/>42738:     Send = fun(Sock, Data) -&gt; socket:send(Sock, Data) end,
<a name="42739"/>42739:     Recv = fun(Sock, Sz)   -&gt; socket:recv(Sock, Sz) end,
<a name="42740"/>42740:     InitState2 = InitState#{send =&gt; Send, % Send function
<a name="42741"/>42741:                             recv =&gt; Recv  % Receive function
<a name="42742"/>42742:                            },
<a name="traffic_ping_pong_send_and_recv_tcp-last_expr"/><a name="42743"/>42743: <b>    traffic_ping_pong_send_and_receive_tcp</b>(InitState2).
<a name="42744"/>42744: 
<a name="traffic_ping_pong_sendmsg_and_recvmsg_tcp-1"/><a name="42745"/>42745: <b>traffic_ping_pong_sendmsg_and_recvmsg_tcp</b>(#{domain := local} = InitState) -&gt;
<a name="42746"/>42746:     Recv = fun(Sock, Sz)   -&gt; 
<a name="42747"/>42747:                    case socket:recvmsg(Sock, Sz, 0) of
<a name="42748"/>42748:                        %% On some platforms, the address
<a name="42749"/>42749:                        %% *is* provided (e.g. linux)
<a name="42750"/>42750:                        {ok, #{addr  := #{family := local},
<a name="42751"/>42751:                               iov   := [Data]}} -&gt;
<a name="42752"/>42752:                            {ok, Data};
<a name="42753"/>42753:                        {ok, #{addr := _} = Msg} -&gt;
<a name="42754"/>42754:                            {error, {msg, Msg}};
<a name="42755"/>42755:                        %% On some platforms, the address
<a name="42756"/>42756:                        %% is *not* provided (e.g. FreeBSD)
<a name="42757"/>42757:                        {ok, #{iov   := [Data]}} -&gt;
<a name="42758"/>42758:                            {ok, Data};
<a name="42759"/>42759:                        {ok, Msg} -&gt;
<a name="42760"/>42760:                            {error, {msg, Msg}};
<a name="42761"/>42761:                        {error, _} = ERROR -&gt;
<a name="42762"/>42762:                            ERROR
<a name="42763"/>42763:                    end
<a name="42764"/>42764:            end,
<a name="42765"/>42765:     InitState2 = InitState#{recv =&gt; Recv},  % Receive function
<a name="42766"/>42766:     traffic_ping_pong_sendmsg_and_recvmsg_tcp2(InitState2);
<a name="42767"/>42767: <b>traffic_ping_pong_sendmsg_and_recvmsg_tcp</b>(InitState) -&gt;
<a name="42768"/>42768:     Recv = fun(Sock, Sz)   -&gt; 
<a name="42769"/>42769:                    case socket:recvmsg(Sock, Sz, 0) of
<a name="42770"/>42770:                        {ok, #{iov   := [Data]}} -&gt;
<a name="42771"/>42771:                            {ok, Data};
<a name="42772"/>42772:                        {ok, Msg} -&gt;
<a name="42773"/>42773:                            {error, {msg, Msg}};
<a name="42774"/>42774:                        {error, _} = ERROR -&gt;
<a name="42775"/>42775:                            ERROR
<a name="42776"/>42776:                    end
<a name="42777"/>42777:            end,
<a name="42778"/>42778:     InitState2 = InitState#{recv =&gt; Recv},  % Receive function
<a name="traffic_ping_pong_sendmsg_and_recvmsg_tcp-last_expr"/><a name="42779"/>42779: <b>    traffic_ping_pong_sendmsg_and_recvmsg_tcp2</b>(InitState2).
<a name="42780"/>42780: 
<a name="traffic_ping_pong_sendmsg_and_recvmsg_tcp2-1"/><a name="42781"/>42781: <b>traffic_ping_pong_sendmsg_and_recvmsg_tcp2</b>(InitState) -&gt;
<a name="42782"/>42782:     Send = fun(Sock, Data) when is_binary(Data) -&gt;
<a name="42783"/>42783:                    Msg = #{iov =&gt; [Data]},
<a name="42784"/>42784:                    socket:sendmsg(Sock, Msg);
<a name="42785"/>42785:               (Sock, Data) when is_list(Data) -&gt; %% We assume iovec...
<a name="42786"/>42786:                    Msg = #{iov =&gt; Data},
<a name="42787"/>42787:                    socket:sendmsg(Sock, Msg)
<a name="42788"/>42788:            end,
<a name="42789"/>42789:     InitState2 = InitState#{send =&gt; Send}, % Send function
<a name="traffic_ping_pong_sendmsg_and_recvmsg_tcp2-last_expr"/><a name="42790"/>42790: <b>    traffic_ping_pong_send_and_receive_tcp</b>(InitState2).
<a name="42791"/>42791: 
<a name="42792"/>42792: 
<a name="traffic_ping_pong_send_and_receive_tcp-1"/><a name="42793"/>42793: <b>traffic_ping_pong_send_and_receive_tcp</b>(#{msg := Msg} = InitState) -&gt;
<a name="42794"/>42794:     Fun = fun(Sock) -&gt; 
<a name="42795"/>42795:                   {ok, RcvSz} = socket:getopt(Sock, socket, rcvbuf),
<a name="42796"/>42796: 		  ?SEV_IPRINT(&quot;RcvBuf is ~p (needs at least ~p)&quot;, 
<a name="42797"/>42797: 			      [RcvSz, 16+size(Msg)]),
<a name="42798"/>42798:                   if (RcvSz &lt; size(Msg)) -&gt;
<a name="42799"/>42799:                           NewRcvSz = 1024+size(Msg),
<a name="42800"/>42800:                           case socket:setopt(Sock, socket, rcvbuf, NewRcvSz) of
<a name="42801"/>42801: 			      ok -&gt;
<a name="42802"/>42802: 				  ok;
<a name="42803"/>42803: 			      {error, enobufs} -&gt;
<a name="42804"/>42804: 				  skip(?F(&quot;Change ~w buffer size (to ~w) &quot;
<a name="42805"/>42805:                                           &quot;not allowed&quot;, 
<a name="42806"/>42806:                                           [rcvbuf, NewRcvSz]));
<a name="42807"/>42807: 			      {error, Reason1} -&gt;
<a name="42808"/>42808: 				  ?FAIL({rcvbuf, Reason1})
<a name="42809"/>42809: 			  end;
<a name="42810"/>42810:                      true -&gt;
<a name="42811"/>42811:                           ok
<a name="42812"/>42812:                   end,
<a name="42813"/>42813:                   {ok, SndSz} = socket:getopt(Sock, socket, sndbuf),
<a name="42814"/>42814: 		  ?SEV_IPRINT(&quot;SndBuf is ~p (needs at least ~p)&quot;, 
<a name="42815"/>42815: 			      [SndSz, 16+size(Msg)]),
<a name="42816"/>42816:                   if (SndSz &lt; size(Msg)) -&gt;
<a name="42817"/>42817:                           NewSndSz = 1024+size(Msg),
<a name="42818"/>42818:                           case socket:setopt(Sock, socket, sndbuf, NewSndSz) of
<a name="42819"/>42819: 			      ok -&gt;
<a name="42820"/>42820: 				  ok;
<a name="42821"/>42821: 			      {error, enobufs} -&gt;
<a name="42822"/>42822: 				  skip(?F(&quot;Change ~w buffer size (to ~w) &quot;
<a name="42823"/>42823:                                           &quot;not allowed&quot;, 
<a name="42824"/>42824:                                           [sndbuf, NewSndSz]));
<a name="42825"/>42825: 			      {error, Reason2} -&gt;
<a name="42826"/>42826: 				  ?FAIL({sndbuf, Reason2})
<a name="42827"/>42827: 			  end;
<a name="42828"/>42828:                      true -&gt;
<a name="42829"/>42829:                           ok
<a name="42830"/>42830:                   end,
<a name="42831"/>42831:                   case os:type() of
<a name="42832"/>42832:                       {win32, nt} -&gt;
<a name="42833"/>42833:                           ok = socket:setopt(Sock, otp, rcvbuf, 12*1024);
<a name="42834"/>42834:                       _ -&gt;
<a name="42835"/>42835:                           ok = socket:setopt(Sock, otp, rcvbuf, {12, 1024})
<a name="42836"/>42836:                   end
<a name="42837"/>42837:           end,
<a name="traffic_ping_pong_send_and_receive_tcp-last_expr"/><a name="42838"/>42838: <b>    traffic_ping_pong_send_and_receive_tcp2</b>(InitState#{buf_init =&gt; Fun}).
<a name="42839"/>42839: 
<a name="traffic_ping_pong_send_and_receive_tcp2-1"/><a name="42840"/>42840: <b>traffic_ping_pong_send_and_receive_tcp2</b>(InitState) -&gt;
<a name="42841"/>42841:     ServerSeq =
<a name="42842"/>42842:         [
<a name="42843"/>42843:          %% *** Wait for start order part ***
<a name="42844"/>42844:          #{desc =&gt; &quot;await start&quot;,
<a name="42845"/>42845:            cmd  =&gt; fun(State) -&gt;
<a name="42846"/>42846:                            Tester = ?SEV_AWAIT_START(),
<a name="42847"/>42847:                            {ok, State#{tester =&gt; Tester}}
<a name="42848"/>42848:                    end},
<a name="42849"/>42849:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="42850"/>42850:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="42851"/>42851:                            _MRef = erlang:monitor(process, Tester),
<a name="42852"/>42852:                            ok
<a name="42853"/>42853:                    end},
<a name="42854"/>42854: 
<a name="42855"/>42855:          %% *** Init part ***
<a name="42856"/>42856:          #{desc =&gt; &quot;which local address&quot;,
<a name="42857"/>42857:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="42858"/>42858:                            LSA = which_local_socket_addr(Domain),
<a name="42859"/>42859:                            {ok, State#{local_sa =&gt; LSA}}
<a name="42860"/>42860:                    end},
<a name="42861"/>42861:          #{desc =&gt; &quot;create listen socket&quot;,
<a name="42862"/>42862:            cmd  =&gt; fun(#{domain := Domain, proto := Proto} = State) -&gt;
<a name="42863"/>42863:                            case socket:open(Domain, stream, Proto) of
<a name="42864"/>42864:                                {ok, Sock} -&gt;
<a name="42865"/>42865:                                    {ok, State#{lsock =&gt; Sock}};
<a name="42866"/>42866:                                {error, _} = ERROR -&gt;
<a name="42867"/>42867:                                    ERROR
<a name="42868"/>42868:                            end
<a name="42869"/>42869:                    end},
<a name="42870"/>42870:          #{desc =&gt; &quot;bind to local address&quot;,
<a name="42871"/>42871:            cmd  =&gt; fun(#{domain := local,
<a name="42872"/>42872:                          lsock  := LSock,
<a name="42873"/>42873:                          lsa    := LSA} = _State) -&gt;
<a name="42874"/>42874:                            case socket:bind(LSock, LSA) of
<a name="42875"/>42875:                                ok -&gt;
<a name="42876"/>42876:                                    ok; % We do not care about the port for local
<a name="42877"/>42877:                                {error, _} = ERROR -&gt;
<a name="42878"/>42878:                                    ERROR
<a name="42879"/>42879:                            end;
<a name="42880"/>42880:                       (#{lsock := LSock, local_sa := LSA} = State) -&gt;
<a name="42881"/>42881:                            case sock_bind(LSock, LSA) of
<a name="42882"/>42882:                                ok -&gt;
<a name="42883"/>42883:                                    Port = sock_port(LSock),
<a name="42884"/>42884:                                    ?SEV_IPRINT(&quot;bound to port: ~w&quot;, [Port]),
<a name="42885"/>42885:                                    {ok, State#{lport =&gt; Port}};
<a name="42886"/>42886:                                {error, _} = ERROR -&gt;
<a name="42887"/>42887:                                    ERROR
<a name="42888"/>42888:                            end
<a name="42889"/>42889:                    end},
<a name="42890"/>42890:          #{desc =&gt; &quot;maybe init buffers&quot;,
<a name="42891"/>42891:            cmd  =&gt; fun(#{lsock := LSock, buf_init := BufInit} = _State) -&gt;
<a name="42892"/>42892:                            BufInit(LSock)
<a name="42893"/>42893:                    end},
<a name="42894"/>42894:          #{desc =&gt; &quot;make listen socket&quot;,
<a name="42895"/>42895:            cmd  =&gt; fun(#{lsock := LSock}) -&gt;
<a name="42896"/>42896:                            socket:listen(LSock)
<a name="42897"/>42897:                    end},
<a name="42898"/>42898:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="42899"/>42899:            cmd  =&gt; fun(#{domain := local,
<a name="42900"/>42900:                          tester := Tester, local_sa := LSA}) -&gt;
<a name="42901"/>42901:                            ?SEV_ANNOUNCE_READY(Tester, init, LSA),
<a name="42902"/>42902:                            ok;
<a name="42903"/>42903:                       (#{tester := Tester, local_sa := LSA, lport := Port}) -&gt;
<a name="42904"/>42904:                            ServerSA = LSA#{port =&gt; Port},
<a name="42905"/>42905:                            ?SEV_ANNOUNCE_READY(Tester, init, ServerSA),
<a name="42906"/>42906:                            ok
<a name="42907"/>42907:                    end},
<a name="42908"/>42908: 
<a name="42909"/>42909:          %% The actual test
<a name="42910"/>42910:          #{desc =&gt; &quot;await continue (accept)&quot;,
<a name="42911"/>42911:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="42912"/>42912:                            ?SEV_AWAIT_CONTINUE(Tester, tester, accept)
<a name="42913"/>42913:                    end},
<a name="42914"/>42914:          #{desc =&gt; &quot;accept&quot;,
<a name="42915"/>42915:            cmd  =&gt; fun(#{lsock := LSock} = State) -&gt;
<a name="42916"/>42916:                            case socket:accept(LSock) of
<a name="42917"/>42917:                                {ok, Sock} -&gt;
<a name="42918"/>42918:                                    {ok, State#{csock =&gt; Sock}};
<a name="42919"/>42919:                                {error, _} = ERROR -&gt;
<a name="42920"/>42920:                                    ERROR
<a name="42921"/>42921:                            end
<a name="42922"/>42922:                    end},
<a name="42923"/>42923:          #{desc =&gt; &quot;create handler&quot;,
<a name="42924"/>42924:            cmd  =&gt; fun(State) -&gt;
<a name="42925"/>42925:                            Handler = tpp_tcp_handler_create(),
<a name="42926"/>42926:                            ?SEV_IPRINT(&quot;handler created: ~p&quot;, [Handler]),
<a name="42927"/>42927:                            {ok, State#{handler =&gt; Handler}}
<a name="42928"/>42928:                    end},
<a name="42929"/>42929:          #{desc =&gt; &quot;monitor handler&quot;,
<a name="42930"/>42930:            cmd  =&gt; fun(#{handler := Handler} = _State) -&gt;
<a name="42931"/>42931:                            _MRef = erlang:monitor(process, Handler),
<a name="42932"/>42932:                            ok
<a name="42933"/>42933:                    end},
<a name="42934"/>42934:          #{desc =&gt; &quot;transfer connection socket ownership to handler&quot;,
<a name="42935"/>42935:            cmd  =&gt; fun(#{handler := Handler, csock := Sock} = _State) -&gt;
<a name="42936"/>42936:                            socket:setopt(Sock, otp, controlling_process, Handler)
<a name="42937"/>42937:                    end},
<a name="42938"/>42938:          #{desc =&gt; &quot;start handler&quot;,
<a name="42939"/>42939:            cmd  =&gt; fun(#{handler  := Handler,
<a name="42940"/>42940:                          csock    := Sock,
<a name="42941"/>42941:                          send     := Send,
<a name="42942"/>42942:                          recv     := Recv} = _State) -&gt;
<a name="42943"/>42943:                            ?SEV_ANNOUNCE_START(Handler, {Sock, Send, Recv}),
<a name="42944"/>42944:                            ok
<a name="42945"/>42945:                    end},
<a name="42946"/>42946:          #{desc =&gt; &quot;await handler ready (init)&quot;,
<a name="42947"/>42947:            cmd  =&gt; fun(#{tester  := Tester,
<a name="42948"/>42948:                          handler := Handler} = State) -&gt;
<a name="42949"/>42949:                            case ?SEV_AWAIT_READY(Handler, handler, init, 
<a name="42950"/>42950:                                                  [{tester, Tester}]) of
<a name="42951"/>42951:                                ok -&gt;
<a name="42952"/>42952:                                    {ok, maps:remove(csock, State)};
<a name="42953"/>42953:                                {error, _} = ERROR -&gt;
<a name="42954"/>42954:                                    ERROR
<a name="42955"/>42955:                            end
<a name="42956"/>42956:                    end},
<a name="42957"/>42957:          #{desc =&gt; &quot;announce ready (accept)&quot;,
<a name="42958"/>42958:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="42959"/>42959:                            ?SEV_ANNOUNCE_READY(Tester, accept),
<a name="42960"/>42960:                            ok
<a name="42961"/>42961:                    end},
<a name="42962"/>42962:          #{desc =&gt; &quot;await continue (recv)&quot;,
<a name="42963"/>42963:            cmd  =&gt; fun(#{tester  := Tester,
<a name="42964"/>42964:                          handler := Handler} = _State) -&gt;
<a name="42965"/>42965:                            ?SEV_AWAIT_CONTINUE(Tester, tester, recv, 
<a name="42966"/>42966:                                                [{handler, Handler}])
<a name="42967"/>42967:                    end},
<a name="42968"/>42968:          #{desc =&gt; &quot;order handler to recv&quot;,
<a name="42969"/>42969:            cmd  =&gt; fun(#{handler := Handler} = _State) -&gt;
<a name="42970"/>42970:                            ?SEV_ANNOUNCE_CONTINUE(Handler, recv),
<a name="42971"/>42971:                            ok
<a name="42972"/>42972:                    end},
<a name="42973"/>42973:          #{desc =&gt; &quot;await handler ready (recv)&quot;,
<a name="42974"/>42974:            cmd  =&gt; fun(#{tester  := Tester,
<a name="42975"/>42975:                          handler := Handler} = State) -&gt;
<a name="42976"/>42976:                            case ?SEV_AWAIT_READY(Handler, handler, recv, 
<a name="42977"/>42977:                                                  [{tester, Tester}]) of
<a name="42978"/>42978:                                {ok, Result} -&gt;
<a name="42979"/>42979:                                    %% ?SEV_IPRINT(&quot;Result: ~p&quot;, [Result]),
<a name="42980"/>42980:                                    {ok, State#{result =&gt; Result}};
<a name="42981"/>42981:                                {error, _} = ERROR -&gt;
<a name="42982"/>42982:                                    ERROR
<a name="42983"/>42983:                            end
<a name="42984"/>42984:                    end},
<a name="42985"/>42985:          #{desc =&gt; &quot;announce ready (recv)&quot;,
<a name="42986"/>42986:            cmd  =&gt; fun(#{tester := Tester, 
<a name="42987"/>42987:                          result := Result} = State) -&gt;
<a name="42988"/>42988:                            ?SEV_ANNOUNCE_READY(Tester, recv, Result),
<a name="42989"/>42989:                            {ok, maps:remove(result, State)}
<a name="42990"/>42990:                    end},
<a name="42991"/>42991: 
<a name="42992"/>42992:          %% Termination
<a name="42993"/>42993:          #{desc =&gt; &quot;await terminate (from tester)&quot;,
<a name="42994"/>42994:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="42995"/>42995:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="42996"/>42996:                                ok -&gt;
<a name="42997"/>42997:                                    {ok, maps:remove(tester, State)};
<a name="42998"/>42998:                                {error, _} = ERROR -&gt;
<a name="42999"/>42999:                                    ERROR
<a name="43000"/>43000:                            end
<a name="43001"/>43001:                    end},
<a name="43002"/>43002:          #{desc =&gt; &quot;stop handler&quot;,
<a name="43003"/>43003:            cmd  =&gt; fun(#{handler := Handler}) -&gt;
<a name="43004"/>43004:                            ?SEV_ANNOUNCE_TERMINATE(Handler),
<a name="43005"/>43005:                            ok
<a name="43006"/>43006:                    end},
<a name="43007"/>43007:          #{desc =&gt; &quot;await handler termination&quot;,
<a name="43008"/>43008:            cmd  =&gt; fun(#{handler := Handler} = State) -&gt;
<a name="43009"/>43009:                            ?SEV_AWAIT_TERMINATION(Handler),
<a name="43010"/>43010:                            State1 = maps:remove(handler, State),
<a name="43011"/>43011:                            {ok, State1}
<a name="43012"/>43012:                    end},
<a name="43013"/>43013:          #{desc =&gt; &quot;close listen socket&quot;,
<a name="43014"/>43014:            cmd  =&gt; fun(#{domain   := local,
<a name="43015"/>43015:                          lsock    := Sock,
<a name="43016"/>43016:                          local_sa := #{path := Path}} = State) -&gt;
<a name="43017"/>43017:                            (catch socket:close(Sock)),
<a name="43018"/>43018:                            State1 =
<a name="43019"/>43019:                                unlink_path(Path,
<a name="43020"/>43020:                                            fun() -&gt; 
<a name="43021"/>43021:                                                    maps:remove(local_sa, State)
<a name="43022"/>43022:                                            end,
<a name="43023"/>43023:                                            fun() -&gt; State end),
<a name="43024"/>43024:                            {ok, maps:remove(lsock, State1)};
<a name="43025"/>43025:                       (#{lsock := Sock} = State) -&gt;
<a name="43026"/>43026:                            (catch socket:close(Sock)),
<a name="43027"/>43027:                            {ok, maps:remove(lsock, State)}
<a name="43028"/>43028:                    end},
<a name="43029"/>43029: 
<a name="43030"/>43030:          %% *** We are done ***
<a name="43031"/>43031:          ?SEV_FINISH_NORMAL
<a name="43032"/>43032:         ],
<a name="43033"/>43033: 
<a name="43034"/>43034:     ClientSeq =
<a name="43035"/>43035:         [
<a name="43036"/>43036:          %% *** Wait for start order part ***
<a name="43037"/>43037:          #{desc =&gt; &quot;await start&quot;,
<a name="43038"/>43038:            cmd  =&gt; fun(State) -&gt;
<a name="43039"/>43039:                            {Tester, ServerSA} = ?SEV_AWAIT_START(),
<a name="43040"/>43040:                            {ok, State#{tester    =&gt; Tester, 
<a name="43041"/>43041:                                        server_sa =&gt; ServerSA}}
<a name="43042"/>43042:                    end},
<a name="43043"/>43043:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="43044"/>43044:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="43045"/>43045:                            _MRef = erlang:monitor(process, Tester),
<a name="43046"/>43046:                            ok
<a name="43047"/>43047:                    end},
<a name="43048"/>43048: 
<a name="43049"/>43049:          %% *** Init part ***
<a name="43050"/>43050:          #{desc =&gt; &quot;create node&quot;,
<a name="43051"/>43051:            cmd  =&gt; fun(State) -&gt;
<a name="43052"/>43052:                            {Peer, Node} = ?START_NODE(&quot;client&quot;),
<a name="43053"/>43053:                            {ok, State#{peer =&gt; Peer, node =&gt; Node}}
<a name="43054"/>43054:                    end},
<a name="43055"/>43055:          #{desc =&gt; &quot;monitor client node&quot;,
<a name="43056"/>43056:            cmd  =&gt; fun(#{node := Node} = _State) -&gt;
<a name="43057"/>43057:                            true = erlang:monitor_node(Node, true),
<a name="43058"/>43058:                            ok
<a name="43059"/>43059:                    end},
<a name="43060"/>43060:          #{desc =&gt; &quot;create remote client&quot;,
<a name="43061"/>43061:            cmd  =&gt; fun(#{node := Node} = State) -&gt;
<a name="43062"/>43062:                            Pid = tpp_tcp_client_create(Node),
<a name="43063"/>43063:                            ?SEV_IPRINT(&quot;remote client created: ~p&quot;, [Pid]),
<a name="43064"/>43064:                            {ok, State#{rclient =&gt; Pid}}
<a name="43065"/>43065:                    end},
<a name="43066"/>43066:          #{desc =&gt; &quot;monitor remote client&quot;,
<a name="43067"/>43067:            cmd  =&gt; fun(#{rclient := Pid}) -&gt;
<a name="43068"/>43068:                            _MRef = erlang:monitor(process, Pid),
<a name="43069"/>43069:                            ok
<a name="43070"/>43070:                    end},
<a name="43071"/>43071:          #{desc =&gt; &quot;order remote client to start&quot;,
<a name="43072"/>43072:            cmd  =&gt; fun(#{rclient   := RClient,
<a name="43073"/>43073:                          proto     := Proto,
<a name="43074"/>43074:                          server_sa := ServerSA,
<a name="43075"/>43075:                          buf_init  := BufInit,
<a name="43076"/>43076:                          send      := Send,
<a name="43077"/>43077:                          recv      := Recv}) -&gt;
<a name="43078"/>43078:                            ?SEV_ANNOUNCE_START(RClient, 
<a name="43079"/>43079:                                                {ServerSA, Proto, BufInit,
<a name="43080"/>43080:                                                 Send, Recv}),
<a name="43081"/>43081:                            ok
<a name="43082"/>43082:                    end},
<a name="43083"/>43083:          #{desc =&gt; &quot;await remote client ready&quot;,
<a name="43084"/>43084:            cmd  =&gt; fun(#{tester  := Tester,
<a name="43085"/>43085:                          rclient := RClient} = _State) -&gt;
<a name="43086"/>43086:                            case ?SEV_AWAIT_READY(RClient, rclient, init, 
<a name="43087"/>43087:                                                  [{tester, Tester}]) of
<a name="43088"/>43088:                                ok -&gt;
<a name="43089"/>43089:                                    ?SEV_IPRINT(&quot;remote client started&quot;),
<a name="43090"/>43090:                                    ok;
<a name="43091"/>43091:                                {error, {unexpected_exit, _, {bind, eaddrnotavail = Reason}}} -&gt;
<a name="43092"/>43092:                                    ?SEV_IPRINT(&quot;remote client bind failure:&quot;
<a name="43093"/>43093:                                                &quot;~n   ~p&quot;, [Reason]),
<a name="43094"/>43094:                                    {skip, Reason};
<a name="43095"/>43095:                                {error, Reason} = ERROR -&gt;
<a name="43096"/>43096:                                    ?SEV_EPRINT(&quot;remote client failure:&quot;
<a name="43097"/>43097:                                                &quot;~n   ~p&quot;, [Reason]),
<a name="43098"/>43098:                                    ERROR
<a name="43099"/>43099:                            end
<a name="43100"/>43100:                    end},
<a name="43101"/>43101:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="43102"/>43102:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="43103"/>43103:                            ?SEV_ANNOUNCE_READY(Tester, init),
<a name="43104"/>43104:                            ok
<a name="43105"/>43105:                    end},
<a name="43106"/>43106: 
<a name="43107"/>43107:          %% The actual test
<a name="43108"/>43108:          #{desc =&gt; &quot;await continue (connect)&quot;,
<a name="43109"/>43109:            cmd  =&gt; fun(#{tester  := Tester,
<a name="43110"/>43110:                          rclient := RClient} = _State) -&gt;
<a name="43111"/>43111:                            ?SEV_AWAIT_CONTINUE(Tester, tester, connect, 
<a name="43112"/>43112:                                                [{rclient, RClient}]),
<a name="43113"/>43113:                            ok
<a name="43114"/>43114:                    end},
<a name="43115"/>43115:          #{desc =&gt; &quot;order remote client to continue (connect)&quot;,
<a name="43116"/>43116:            cmd  =&gt; fun(#{rclient := RClient}) -&gt;
<a name="43117"/>43117:                            ?SEV_ANNOUNCE_CONTINUE(RClient, connect),
<a name="43118"/>43118:                            ok
<a name="43119"/>43119:                    end},
<a name="43120"/>43120:          #{desc =&gt; &quot;await remote client ready (connect)&quot;,
<a name="43121"/>43121:            cmd  =&gt; fun(#{tester  := Tester,
<a name="43122"/>43122:                          rclient := RClient} = _State) -&gt;
<a name="43123"/>43123:                            ?SEV_AWAIT_READY(RClient, rclient, connect, 
<a name="43124"/>43124:                                             [{tester, Tester}])
<a name="43125"/>43125:                    end},
<a name="43126"/>43126:          #{desc =&gt; &quot;announce ready (connect)&quot;,
<a name="43127"/>43127:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="43128"/>43128:                            ?SEV_ANNOUNCE_READY(Tester, connect),
<a name="43129"/>43129:                            ok
<a name="43130"/>43130:                    end},
<a name="43131"/>43131:          #{desc =&gt; &quot;await continue (send)&quot;,
<a name="43132"/>43132:            cmd  =&gt; fun(#{tester  := Tester,
<a name="43133"/>43133:                          rclient := RClient} = _State) -&gt;
<a name="43134"/>43134:                            ?SEV_AWAIT_CONTINUE(Tester, tester, 
<a name="43135"/>43135:                                                send, 
<a name="43136"/>43136:                                                [{rclient, RClient}])
<a name="43137"/>43137:                    end},
<a name="43138"/>43138:          #{desc =&gt; &quot;order remote client to continue (send)&quot;,
<a name="43139"/>43139:            cmd  =&gt; fun(#{rclient := RClient,
<a name="43140"/>43140:                          msg     := Msg,
<a name="43141"/>43141:                          num     := Num} = State) -&gt;
<a name="43142"/>43142:                            Data = {Msg, Num},
<a name="43143"/>43143:                            ?SEV_ANNOUNCE_CONTINUE(RClient, send, Data),
<a name="43144"/>43144:                            {ok, maps:remove(data, State)}
<a name="43145"/>43145:                    end},
<a name="43146"/>43146:          #{desc =&gt; &quot;await remote client ready (send)&quot;,
<a name="43147"/>43147:            cmd  =&gt; fun(#{tester  := Tester,
<a name="43148"/>43148:                          rclient := RClient} = State) -&gt;
<a name="43149"/>43149:                            case ?SEV_AWAIT_READY(RClient, rclient, send, 
<a name="43150"/>43150:                                                  [{tester, Tester}]) of
<a name="43151"/>43151:                                {ok, Result} -&gt;
<a name="43152"/>43152:                                    {ok, State#{result =&gt; Result}};
<a name="43153"/>43153:                                {error,
<a name="43154"/>43154:                                 {unexpected_exit, rclient, noconnection}} -&gt;
<a name="43155"/>43155:                                    %% One guess is that the message is so
<a name="43156"/>43156:                                    %% &quot;large&quot; that the client node died on us.
<a name="43157"/>43157:                                    %% Or so &quot;large&quot; that the connection (to
<a name="43158"/>43158:                                    %% the node) fails/dies.
<a name="43159"/>43159:                                    %% Either way, we assume this is not actually
<a name="43160"/>43160:                                    %% related to what we are testing =&gt; skip
<a name="43161"/>43161:                                    ?SEV_IPRINT(&quot;lost connection &quot;
<a name="43162"/>43162:                                                &quot;to remote client node =&gt; SKIP&quot;),
<a name="43163"/>43163:                                    {skip, {rclient, noconnection}};
<a name="43164"/>43164:                                {error, _} = ERROR -&gt;
<a name="43165"/>43165:                                    ERROR
<a name="43166"/>43166:                            end
<a name="43167"/>43167:                    end},
<a name="43168"/>43168:          #{desc =&gt; &quot;announce ready (send)&quot;,
<a name="43169"/>43169:            cmd  =&gt; fun(#{tester := Tester, result := Result} = State) -&gt;
<a name="43170"/>43170:                            ?SEV_ANNOUNCE_READY(Tester, send, Result),
<a name="43171"/>43171:                            {ok, maps:remove(result, State)}
<a name="43172"/>43172:                    end},
<a name="43173"/>43173: 
<a name="43174"/>43174:          %% Termination
<a name="43175"/>43175:          #{desc =&gt; &quot;await terminate (from tester)&quot;,
<a name="43176"/>43176:            cmd  =&gt; fun(#{tester  := Tester, 
<a name="43177"/>43177:                          rclient := RClient} = State) -&gt;
<a name="43178"/>43178:                            case ?SEV_AWAIT_TERMINATE(Tester, tester,
<a name="43179"/>43179:                                                      [{rclient, RClient}]) of
<a name="43180"/>43180:                                ok -&gt;
<a name="43181"/>43181:                                    {ok, maps:remove(tester, State)};
<a name="43182"/>43182:                                {error, _} = ERROR -&gt;
<a name="43183"/>43183:                                    ERROR
<a name="43184"/>43184:                            end
<a name="43185"/>43185:                    end},
<a name="43186"/>43186:          #{desc =&gt; &quot;stop remote client&quot;,
<a name="43187"/>43187:            cmd  =&gt; fun(#{rclient := RClient}) -&gt;
<a name="43188"/>43188:                            ?SEV_ANNOUNCE_TERMINATE(RClient),
<a name="43189"/>43189:                            ok
<a name="43190"/>43190:                    end},
<a name="43191"/>43191:          #{desc =&gt; &quot;await remote client termination&quot;,
<a name="43192"/>43192:            cmd  =&gt; fun(#{rclient := RClient} = State) -&gt;
<a name="43193"/>43193:                            ?SEV_AWAIT_TERMINATION(RClient),
<a name="43194"/>43194:                            State1 = maps:remove(rclient, State),
<a name="43195"/>43195:                            {ok, State1}
<a name="43196"/>43196:                    end},
<a name="43197"/>43197:          #{desc =&gt; &quot;stop client node&quot;,
<a name="43198"/>43198:            cmd  =&gt; fun(#{peer := Peer} = State) -&gt;
<a name="43199"/>43199:                            {ok,
<a name="43200"/>43200:                             try peer:stop(Peer) of
<a name="43201"/>43201:                                 ok -&gt;
<a name="43202"/>43202:                                     State#{node_stop =&gt; ok};
<a name="43203"/>43203:                                 {error, Reason} -&gt;
<a name="43204"/>43204:                                     ?SEV_EPRINT(&quot;Unexpected node stop result: &quot;
<a name="43205"/>43205:                                                 &quot;~n   ~p&quot;, [Reason]),
<a name="43206"/>43206:                                     State#{node_stop =&gt; error}
<a name="43207"/>43207:                             catch
<a name="43208"/>43208:                                 C:E:S -&gt;
<a name="43209"/>43209:                                     ?SEV_EPRINT(&quot;Unexpected node stop result: &quot;
<a name="43210"/>43210:                                                 &quot;~n   Class: ~p&quot;
<a name="43211"/>43211:                                                 &quot;~n   Error: ~p&quot;
<a name="43212"/>43212:                                                 &quot;~n   Stack: ~p&quot;,[C, E, S]),
<a name="43213"/>43213:                                     State#{node_stop =&gt; error}
<a name="43214"/>43214:                             end}
<a name="43215"/>43215:                    end},
<a name="43216"/>43216:          #{desc =&gt; &quot;await client node termination&quot;,
<a name="43217"/>43217:            cmd  =&gt; fun(#{node := Node, node_stop := ok} = State) -&gt;
<a name="43218"/>43218:                            ?SEV_IPRINT(&quot;Success node stop - await nodedown&quot;),
<a name="43219"/>43219:                            receive
<a name="43220"/>43220:                                {nodedown, Node} -&gt;
<a name="43221"/>43221:                                    ?SEV_IPRINT(&quot;nodedown received - cleanup&quot;),
<a name="43222"/>43222:                                    State1 = maps:remove(node, State),
<a name="43223"/>43223:                                    {ok, State1}
<a name="43224"/>43224:                            end;
<a name="43225"/>43225:                       (#{node_stop := error} = State) -&gt;
<a name="43226"/>43226:                            ?SEV_IPRINT(&quot;Failed node stop - cleanup&quot;),
<a name="43227"/>43227:                            State1 = maps:remove(node, State),
<a name="43228"/>43228:                            {ok, State1}
<a name="43229"/>43229:                    end},
<a name="43230"/>43230: 
<a name="43231"/>43231:          %% *** We are done ***
<a name="43232"/>43232:          ?SEV_FINISH_NORMAL
<a name="43233"/>43233:         ],
<a name="43234"/>43234: 
<a name="43235"/>43235:     TesterSeq =
<a name="43236"/>43236:         [
<a name="43237"/>43237:          %% *** Init part ***
<a name="43238"/>43238:          #{desc =&gt; &quot;monitor server&quot;,
<a name="43239"/>43239:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="43240"/>43240:                            _MRef = erlang:monitor(process, Pid),
<a name="43241"/>43241:                            ok
<a name="43242"/>43242:                    end},
<a name="43243"/>43243:          #{desc =&gt; &quot;monitor client&quot;,
<a name="43244"/>43244:            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;
<a name="43245"/>43245:                            _MRef = erlang:monitor(process, Pid),
<a name="43246"/>43246:                            ok
<a name="43247"/>43247:                    end},
<a name="43248"/>43248: 
<a name="43249"/>43249:          %% Start the server
<a name="43250"/>43250:          #{desc =&gt; &quot;order server start&quot;,
<a name="43251"/>43251:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="43252"/>43252:                            ?SEV_ANNOUNCE_START(Pid),
<a name="43253"/>43253:                            ok
<a name="43254"/>43254:                    end},
<a name="43255"/>43255:          #{desc =&gt; &quot;await server ready (init)&quot;,
<a name="43256"/>43256:            cmd  =&gt; fun(#{server := Pid} = State) -&gt;
<a name="43257"/>43257:                            {ok, ServerSA} = ?SEV_AWAIT_READY(Pid, server, init),
<a name="43258"/>43258:                            {ok, State#{server_sa =&gt; ServerSA}}
<a name="43259"/>43259:                    end},
<a name="43260"/>43260: 
<a name="43261"/>43261:          %% Start the client
<a name="43262"/>43262:          #{desc =&gt; &quot;order client start&quot;,
<a name="43263"/>43263:            cmd  =&gt; fun(#{client    := Pid, 
<a name="43264"/>43264:                          server_sa := ServerSA} = _State) -&gt;
<a name="43265"/>43265:                            ?SEV_ANNOUNCE_START(Pid, ServerSA),
<a name="43266"/>43266:                            ok
<a name="43267"/>43267:                    end},
<a name="43268"/>43268:          #{desc =&gt; &quot;await client ready (init)&quot;,
<a name="43269"/>43269:            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;
<a name="43270"/>43270:                            ok = ?SEV_AWAIT_READY(Pid, client, init)
<a name="43271"/>43271:                    end},
<a name="43272"/>43272:  
<a name="43273"/>43273:          %% The actual test
<a name="43274"/>43274:          #{desc =&gt; &quot;order server continue (accept)&quot;,
<a name="43275"/>43275:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="43276"/>43276:                            ?SEV_ANNOUNCE_CONTINUE(Pid, accept),
<a name="43277"/>43277:                            ok
<a name="43278"/>43278:                    end},
<a name="43279"/>43279:          ?SEV_SLEEP(?SECS(1)),
<a name="43280"/>43280:          #{desc =&gt; &quot;order client continue (connect)&quot;,
<a name="43281"/>43281:            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;
<a name="43282"/>43282:                            ?SEV_ANNOUNCE_CONTINUE(Pid, connect),
<a name="43283"/>43283:                            ok
<a name="43284"/>43284:                    end},
<a name="43285"/>43285:          #{desc =&gt; &quot;await server ready (accept)&quot;,
<a name="43286"/>43286:            cmd  =&gt; fun(#{server := Server,
<a name="43287"/>43287:                          client := Client} = _State) -&gt;
<a name="43288"/>43288:                            ?SEV_AWAIT_READY(Server, server, accept,
<a name="43289"/>43289:                                             [{client, Client}]),
<a name="43290"/>43290:                            ok
<a name="43291"/>43291:                    end},
<a name="43292"/>43292:          #{desc =&gt; &quot;await client ready (connect)&quot;,
<a name="43293"/>43293:            cmd  =&gt; fun(#{server := Server,
<a name="43294"/>43294:                          client := Client} = _State) -&gt;
<a name="43295"/>43295:                            ?SEV_AWAIT_READY(Client, client, connect, 
<a name="43296"/>43296:                                             [{server, Server}])
<a name="43297"/>43297:                    end},
<a name="43298"/>43298:          #{desc =&gt; &quot;order server continue (recv)&quot;,
<a name="43299"/>43299:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="43300"/>43300:                            ?SEV_ANNOUNCE_CONTINUE(Pid, recv),
<a name="43301"/>43301:                            ok
<a name="43302"/>43302:                    end},
<a name="43303"/>43303:          ?SEV_SLEEP(?SECS(1)),
<a name="43304"/>43304:          #{desc =&gt; &quot;order client continue (send)&quot;,
<a name="43305"/>43305:            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;
<a name="43306"/>43306:                            ?SEV_ANNOUNCE_CONTINUE(Pid, send),
<a name="43307"/>43307:                            ok
<a name="43308"/>43308:                    end},
<a name="43309"/>43309:          #{desc =&gt; &quot;await client ready (send)&quot;,
<a name="43310"/>43310:            cmd  =&gt; fun(#{server := Server,
<a name="43311"/>43311:                          client := Client} = State) -&gt;
<a name="43312"/>43312:                            case ?SEV_AWAIT_READY(Client, client, send, 
<a name="43313"/>43313:                                                  [{server, Server}]) of
<a name="43314"/>43314:                                {ok, {_, _, _, _, _} = Result} -&gt;
<a name="43315"/>43315:                                    ?SEV_IPRINT(&quot;client result: &quot;
<a name="43316"/>43316:                                                &quot;~n   ~p&quot;, [Result]),
<a name="43317"/>43317:                                    {ok, State#{client_result =&gt; Result}};
<a name="43318"/>43318:                                {ok, BadResult} -&gt;
<a name="43319"/>43319:                                    ?SEV_EPRINT(&quot;client result: &quot;
<a name="43320"/>43320:                                                &quot;~n   ~p&quot;, [BadResult]),
<a name="43321"/>43321:                                    {error, {invalid_client_result, BadResult}};
<a name="43322"/>43322:                                {error, _} = ERROR -&gt;
<a name="43323"/>43323:                                    ERROR
<a name="43324"/>43324:                            end
<a name="43325"/>43325:                    end},
<a name="43326"/>43326:          #{desc =&gt; &quot;await server ready (recv)&quot;,
<a name="43327"/>43327:            cmd  =&gt; fun(#{server := Server,
<a name="43328"/>43328:                          client := Client,
<a name="43329"/>43329:                          num    := Num} = State) -&gt;
<a name="43330"/>43330:                            case ?SEV_AWAIT_READY(Server, server, recv,
<a name="43331"/>43331:                                                  [{client, Client}]) of
<a name="43332"/>43332:                                {ok, {Num, _, _, _, _} = Result} -&gt;
<a name="43333"/>43333:                                    ?SEV_IPRINT(&quot;server result: &quot;
<a name="43334"/>43334:                                                &quot;~n   ~p&quot;, [Result]),
<a name="43335"/>43335:                                    Result2 = erlang:delete_element(1, Result),
<a name="43336"/>43336:                                    {ok, State#{server_result =&gt; Result2}};
<a name="43337"/>43337:                                {ok, BadResult} -&gt;
<a name="43338"/>43338:                                    ?SEV_EPRINT(&quot;bad server result: &quot;
<a name="43339"/>43339:                                                &quot;~n   ~p&quot;, [BadResult]),
<a name="43340"/>43340:                                    {error, {invalid_server_result, BadResult}};
<a name="43341"/>43341:                                {error, _} = ERROR -&gt;
<a name="43342"/>43342:                                    ERROR
<a name="43343"/>43343:                            end
<a name="43344"/>43344:                    end},
<a name="43345"/>43345:          #{desc =&gt; &quot;present result&quot;,
<a name="43346"/>43346:            cmd  =&gt; fun(#{server_result := SRes,
<a name="43347"/>43347:                          client_result := CRes,
<a name="43348"/>43348:                          num           := Num} = State) -&gt;
<a name="43349"/>43349:                            {SSent, SReceived, SStart, SStop} = SRes,
<a name="43350"/>43350:                            {CSent, CReceived, _, CStart, CStop} = CRes,
<a name="43351"/>43351:                            STime = tdiff(SStart, SStop),
<a name="43352"/>43352:                            CTime = tdiff(CStart, CStop),
<a name="43353"/>43353:                            ?SEV_IPRINT(&quot;process result data:&quot;
<a name="43354"/>43354:                                        &quot;~n   Num:          ~p&quot;
<a name="43355"/>43355:                                        &quot;~n   Server Sent:  ~p&quot;
<a name="43356"/>43356:                                        &quot;~n   Server Recv:  ~p&quot;
<a name="43357"/>43357:                                        &quot;~n   Server Start: ~p&quot;
<a name="43358"/>43358:                                        &quot;~n   Server Stop:  ~p&quot;
<a name="43359"/>43359:                                        &quot;~n   Server Time:  ~p&quot;
<a name="43360"/>43360:                                        &quot;~n   Client Sent:  ~p&quot;
<a name="43361"/>43361:                                        &quot;~n   Client Recv:  ~p&quot;
<a name="43362"/>43362:                                        &quot;~n   Client Start: ~p&quot;
<a name="43363"/>43363:                                        &quot;~n   Client Stop:  ~p&quot;
<a name="43364"/>43364:                                        &quot;~n   Client Time:  ~p&quot;,
<a name="43365"/>43365:                                        [Num,
<a name="43366"/>43366:                                         SSent, SReceived, SStart, SStop,
<a name="43367"/>43367:                                         STime,
<a name="43368"/>43368:                                         CSent, CReceived, CStart, CStop,
<a name="43369"/>43369:                                         CTime]),
<a name="43370"/>43370:                            if
<a name="43371"/>43371:                                (STime =:= 0) orelse
<a name="43372"/>43372:                                (CTime =:= 0) -&gt;
<a name="43373"/>43373:                                    {skip,
<a name="43374"/>43374:                                     ?F(&quot;Invalid exec time(s): ~w , ~w&quot;,
<a name="43375"/>43375:                                        [STime, CTime])};
<a name="43376"/>43376:                                true -&gt;
<a name="43377"/>43377:                                    %% Note that the sizes we are counting is 
<a name="43378"/>43378:                                    %% only the &quot;data&quot; part of the messages.
<a name="43379"/>43379:                                    %% There is also fixed header for each
<a name="43380"/>43380:                                    %% message, which of course is small for
<a name="43381"/>43381:                                    %% the large messages, but comparatively
<a name="43382"/>43382:                                    %% big for the small messages!
<a name="43383"/>43383:                                    ?SEV_IPRINT(
<a name="43384"/>43384:                                       &quot;Results: ~w messages exchanged&quot;
<a name="43385"/>43385:                                       &quot;~n   Server: ~w msec&quot;
<a name="43386"/>43386:                                       &quot;~n      ~.2f msec/message (roundtrip)&quot;
<a name="43387"/>43387:                                       &quot;~n      ~.2f messages/msec (roundtrip)&quot;
<a name="43388"/>43388:                                       &quot;~n      ~w bytes/msec sent&quot;
<a name="43389"/>43389:                                       &quot;~n      ~w bytes/msec received&quot;
<a name="43390"/>43390:                                       &quot;~n   Client: ~w msec&quot;
<a name="43391"/>43391:                                       &quot;~n      ~.2f msec/message (roundtrip)&quot;
<a name="43392"/>43392:                                       &quot;~n      ~.2f messages/msec (roundtrip)&quot;
<a name="43393"/>43393:                                       &quot;~n      ~w bytes/msec sent&quot;
<a name="43394"/>43394:                                       &quot;~n      ~w bytes/msec received&quot;,
<a name="43395"/>43395:                                       [Num,
<a name="43396"/>43396:                                        STime,
<a name="43397"/>43397:                                        STime / Num,
<a name="43398"/>43398:                                        Num / STime,
<a name="43399"/>43399:                                        SSent div STime,
<a name="43400"/>43400:                                        SReceived div STime,
<a name="43401"/>43401:                                        CTime,
<a name="43402"/>43402:                                        CTime / Num,
<a name="43403"/>43403:                                        Num / CTime,
<a name="43404"/>43404:                                        CSent div CTime,
<a name="43405"/>43405:                                        CReceived div CTime]),
<a name="43406"/>43406:                                    State1 = maps:remove(server_result, State),
<a name="43407"/>43407:                                    State2 = maps:remove(client_result, State1),
<a name="43408"/>43408:                                    {ok, State2}
<a name="43409"/>43409:                            end
<a name="43410"/>43410:                    end},
<a name="43411"/>43411: 
<a name="43412"/>43412:          %% Terminations
<a name="43413"/>43413:          #{desc =&gt; &quot;order client to terminate&quot;,
<a name="43414"/>43414:            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;
<a name="43415"/>43415:                            ?SEV_ANNOUNCE_TERMINATE(Pid),
<a name="43416"/>43416:                            ok
<a name="43417"/>43417:                    end},
<a name="43418"/>43418:          #{desc =&gt; &quot;await client termination&quot;,
<a name="43419"/>43419:            cmd  =&gt; fun(#{client := Pid} = State) -&gt;
<a name="43420"/>43420:                            case ?SEV_AWAIT_TERMINATION(Pid) of
<a name="43421"/>43421:                                ok -&gt;
<a name="43422"/>43422:                                    State1 = maps:remove(client, State),
<a name="43423"/>43423:                                    {ok, State1};
<a name="43424"/>43424:                                {error, _} = ERROR -&gt;
<a name="43425"/>43425:                                    ERROR
<a name="43426"/>43426:                            end
<a name="43427"/>43427:                    end},
<a name="43428"/>43428:          #{desc =&gt; &quot;order server to terminate&quot;,
<a name="43429"/>43429:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="43430"/>43430:                            ?SEV_ANNOUNCE_TERMINATE(Pid),
<a name="43431"/>43431:                            ok
<a name="43432"/>43432:                    end},
<a name="43433"/>43433:          #{desc =&gt; &quot;await server termination&quot;,
<a name="43434"/>43434:            cmd  =&gt; fun(#{server := Pid} = State) -&gt;
<a name="43435"/>43435:                            case ?SEV_AWAIT_TERMINATION(Pid) of
<a name="43436"/>43436:                                ok -&gt;
<a name="43437"/>43437:                                    State1 = maps:remove(server, State),
<a name="43438"/>43438:                                    {ok, State1};
<a name="43439"/>43439:                                {error, _} = ERROR -&gt;
<a name="43440"/>43440:                                    ERROR
<a name="43441"/>43441:                            end
<a name="43442"/>43442:                    end},
<a name="43443"/>43443: 
<a name="43444"/>43444: 
<a name="43445"/>43445:          %% *** We are done ***
<a name="43446"/>43446:          ?SEV_FINISH_NORMAL
<a name="43447"/>43447:         ],
<a name="43448"/>43448: 
<a name="43449"/>43449:     i(&quot;start server evaluator&quot;),
<a name="43450"/>43450:     ServerInitState = #{domain   =&gt; maps:get(domain,   InitState),
<a name="43451"/>43451:                         proto    =&gt; maps:get(proto,    InitState),
<a name="43452"/>43452:                         recv     =&gt; maps:get(recv,     InitState),
<a name="43453"/>43453:                         send     =&gt; maps:get(send,     InitState),
<a name="43454"/>43454:                         buf_init =&gt; maps:get(buf_init, InitState)},
<a name="43455"/>43455:     Server = ?SEV_START(&quot;server&quot;, ServerSeq, ServerInitState),
<a name="43456"/>43456: 
<a name="43457"/>43457:     i(&quot;start client evaluator(s)&quot;),
<a name="43458"/>43458:     ClientInitState = InitState#{host =&gt; local_host()},
<a name="43459"/>43459:     Client = ?SEV_START(&quot;client&quot;, ClientSeq, ClientInitState),
<a name="43460"/>43460: 
<a name="43461"/>43461:     i(&quot;start 'tester' evaluator&quot;),
<a name="43462"/>43462:     TesterInitState = #{server =&gt; Server#ev.pid,
<a name="43463"/>43463:                         client =&gt; Client#ev.pid,
<a name="43464"/>43464:                         num    =&gt; maps:get(num, InitState)},
<a name="43465"/>43465:     Tester = ?SEV_START(&quot;tester&quot;, TesterSeq, TesterInitState),
<a name="43466"/>43466: 
<a name="43467"/>43467:     i(&quot;await evaluator&quot;),
<a name="traffic_ping_pong_send_and_receive_tcp2-last_expr"/><a name="43468"/>43468: <b>    ok = ?SEV_AWAIT_FINISH</b>([Server, Client, Tester]).
<a name="43469"/>43469:     
<a name="43470"/>43470: 
<a name="tpp_tcp_handler_create-0"/><a name="43471"/>43471: <b>tpp_tcp_handler_create</b>() -&gt;
<a name="43472"/>43472:     Self = self(),
<a name="tpp_tcp_handler_create-last_expr"/><a name="43473"/>43473: <b>    erlang:spawn</b>(fun() -&gt; tpp_tcp_handler(Self) end).
<a name="43474"/>43474: 
<a name="tpp_tcp_handler-1"/><a name="43475"/>43475: <b>tpp_tcp_handler</b>(Parent) -&gt;
<a name="43476"/>43476:     tpp_tcp_handler_init(Parent),
<a name="43477"/>43477:     {Sock, Send, Recv} = tpp_tcp_handler_await_start(Parent),
<a name="43478"/>43478:     tpp_tcp_handler_announce_ready(Parent, init),
<a name="43479"/>43479:     tpp_tcp_handler_await_continue(Parent, recv),
<a name="43480"/>43480:     Result = tpp_tcp_handler_msg_exchange(Sock, Send, Recv),
<a name="43481"/>43481:     tpp_tcp_handler_announce_ready(Parent, recv, Result),
<a name="43482"/>43482:     Reason = tpp_tcp_handler_await_terminate(Parent),
<a name="43483"/>43483:     ?SEV_IPRINT(&quot;terminating&quot;),
<a name="tpp_tcp_handler-last_expr"/><a name="43484"/>43484: <b>    exit</b>(Reason).
<a name="43485"/>43485: 
<a name="tpp_tcp_handler_init-1"/><a name="43486"/>43486: <b>tpp_tcp_handler_init</b>(Parent) -&gt;
<a name="43487"/>43487:     put(sname, &quot;handler&quot;),
<a name="43488"/>43488:     ?SEV_IPRINT(&quot;init&quot;),
<a name="43489"/>43489:     _MRef = erlang:monitor(process, Parent),
<a name="tpp_tcp_handler_init-last_expr"/><a name="43490"/>43490:     ok.
<a name="43491"/>43491: 
<a name="tpp_tcp_handler_await_start-1"/><a name="43492"/>43492: <b>tpp_tcp_handler_await_start</b>(Parent) -&gt;
<a name="43493"/>43493:     ?SEV_IPRINT(&quot;await start&quot;),
<a name="tpp_tcp_handler_await_start-last_expr"/><a name="43494"/>43494: <b>    ?SEV_AWAIT_START</b>(Parent).
<a name="43495"/>43495: 
<a name="tpp_tcp_handler_announce_ready-2"/><a name="43496"/>43496: <b>tpp_tcp_handler_announce_ready</b>(Parent, Slogan) -&gt;
<a name="43497"/>43497:     ?SEV_IPRINT(&quot;announce ready (~p)&quot;, [Slogan]),
<a name="tpp_tcp_handler_announce_ready-last_expr"/><a name="43498"/>43498: <b>    ?SEV_ANNOUNCE_READY</b>(Parent, Slogan).
<a name="tpp_tcp_handler_announce_ready-3"/><a name="43499"/>43499: <b>tpp_tcp_handler_announce_ready</b>(Parent, Slogan, Extra) -&gt;
<a name="43500"/>43500:     ?SEV_IPRINT(&quot;announce ready (~p)&quot;, [Slogan]),
<a name="tpp_tcp_handler_announce_ready-last_expr"/><a name="43501"/>43501: <b>    ?SEV_ANNOUNCE_READY</b>(Parent, Slogan, Extra).
<a name="43502"/>43502: 
<a name="tpp_tcp_handler_await_continue-2"/><a name="43503"/>43503: <b>tpp_tcp_handler_await_continue</b>(Parent, Slogan) -&gt;
<a name="43504"/>43504:     ?SEV_IPRINT(&quot;await continue (~p)&quot;, [Slogan]),
<a name="tpp_tcp_handler_await_continue-last_expr"/><a name="43505"/>43505: <b>    case ?SEV_AWAIT_CONTINUE</b>(Parent, parent, Slogan) of
<a name="43506"/>43506:         ok -&gt;
<a name="43507"/>43507:             %% ?SEV_IPRINT(&quot;continue (~p): ok&quot;, [Slogan]),
<a name="43508"/>43508:             ok;
<a name="43509"/>43509:         {error, Reason} -&gt;
<a name="43510"/>43510:             ?SEV_EPRINT(&quot;continue (~p): error&quot;
<a name="43511"/>43511:                         &quot;~n   ~p&quot;, [Slogan, Reason]),
<a name="43512"/>43512:             exit({continue, Slogan, Reason})
<a name="43513"/>43513:     end.
<a name="43514"/>43514: 
<a name="tpp_tcp_handler_await_terminate-1"/><a name="43515"/>43515: <b>tpp_tcp_handler_await_terminate</b>(Parent) -&gt;
<a name="43516"/>43516:     ?SEV_IPRINT(&quot;await terminate&quot;),
<a name="tpp_tcp_handler_await_terminate-last_expr"/><a name="43517"/>43517: <b>    case ?SEV_AWAIT_TERMINATE</b>(Parent, parent) of
<a name="43518"/>43518:         ok -&gt;
<a name="43519"/>43519:             ok;
<a name="43520"/>43520:         {error, Reason} -&gt;
<a name="43521"/>43521:             Reason
<a name="43522"/>43522:     end.
<a name="43523"/>43523: 
<a name="tpp_tcp_handler_msg_exchange-3"/><a name="43524"/>43524: <b>tpp_tcp_handler_msg_exchange</b>(Sock, Send, Recv) -&gt;
<a name="tpp_tcp_handler_msg_exchange-last_expr"/><a name="43525"/>43525: <b>    tpp_tcp_handler_msg_exchange_loop</b>(Sock, Send, Recv, 0, 0, 0, undefined).
<a name="43526"/>43526: 
<a name="tpp_tcp_handler_msg_exchange_loop-7"/><a name="43527"/>43527: <b>tpp_tcp_handler_msg_exchange_loop</b>(Sock, Send, Recv, N, Sent, Received, Start) -&gt;
<a name="43528"/>43528:     %% ?SEV_IPRINT(&quot;[~w] try receive&quot;, [N]),
<a name="tpp_tcp_handler_msg_exchange_loop-last_expr"/><a name="43529"/>43529: <b>    case tpp_tcp_recv_req</b>(Sock, Recv) of
<a name="43530"/>43530:         {ok, Msg, RecvSz} -&gt;
<a name="43531"/>43531:             NewStart = if (Start =:= undefined) -&gt; ?LIB:timestamp(); 
<a name="43532"/>43532:                           true -&gt; Start end,
<a name="43533"/>43533:             %% ?SEV_IPRINT(&quot;[~w] received - now try send&quot;, [N]),
<a name="43534"/>43534:             case tpp_tcp_send_rep(Sock, Send, Msg) of
<a name="43535"/>43535:                 {ok, SendSz} -&gt;
<a name="43536"/>43536:                     tpp_tcp_handler_msg_exchange_loop(Sock, Send, Recv,
<a name="43537"/>43537:                                                       N+1,
<a name="43538"/>43538:                                                       Sent+SendSz,
<a name="43539"/>43539:                                                       Received+RecvSz,
<a name="43540"/>43540:                                                       NewStart);
<a name="43541"/>43541:                 {error, SReason} -&gt;
<a name="43542"/>43542:                     ?SEV_EPRINT(&quot;send (~w): ~p&quot;, [N, SReason]),
<a name="43543"/>43543:                     exit({send, SReason, N})
<a name="43544"/>43544:             end;
<a name="43545"/>43545:         {error, closed} -&gt;
<a name="43546"/>43546:             ?SEV_IPRINT(&quot;closed - we are done: ~w, ~w, ~w&quot;, [N, Sent, Received]),
<a name="43547"/>43547:             Stop = ?LIB:timestamp(),
<a name="43548"/>43548:             {N, Sent, Received, Start, Stop};
<a name="43549"/>43549:         {error, RReason} -&gt;
<a name="43550"/>43550:             ?SEV_EPRINT(&quot;recv (~w): ~p&quot;, [N, RReason]),
<a name="43551"/>43551:             exit({recv, RReason, N})
<a name="43552"/>43552:     end.
<a name="43553"/>43553:             
<a name="43554"/>43554: <i>%% The (remote) client process</i>
<a name="43555"/>43555: 
<a name="tpp_tcp_client_create-1"/><a name="43556"/>43556: <b>tpp_tcp_client_create</b>(Node) -&gt;
<a name="43557"/>43557:     Self = self(),
<a name="43558"/>43558:     Fun  = fun() -&gt; tpp_tcp_client(Self) end,
<a name="tpp_tcp_client_create-last_expr"/><a name="43559"/>43559: <b>    erlang:spawn</b>(Node, Fun).
<a name="43560"/>43560: 
<a name="tpp_tcp_client-1"/><a name="43561"/>43561: <b>tpp_tcp_client</b>(Parent) -&gt;
<a name="43562"/>43562:     tpp_tcp_client_init(Parent),
<a name="43563"/>43563:     {ServerSA, Proto, BufInit, Send, Recv} = tpp_tcp_client_await_start(Parent),
<a name="43564"/>43564:     Domain   = maps:get(family, ServerSA),
<a name="43565"/>43565:     Sock     = tpp_tcp_client_sock_open(Domain, Proto, BufInit),
<a name="43566"/>43566:     Path     = tpp_tcp_client_sock_bind(Sock, Domain),
<a name="43567"/>43567:     tpp_tcp_client_announce_ready(Parent, init),
<a name="43568"/>43568:     tpp_tcp_client_await_continue(Parent, connect),
<a name="43569"/>43569:     tpp_tcp_client_sock_connect(Sock, ServerSA),
<a name="43570"/>43570:     tpp_tcp_client_announce_ready(Parent, connect),
<a name="43571"/>43571:     {InitMsg, Num} = tpp_tcp_client_await_continue(Parent, send),
<a name="43572"/>43572:     Result = tpp_tcp_client_msg_exchange(Sock, Send, Recv, InitMsg, Num),
<a name="43573"/>43573:     tpp_tcp_client_announce_ready(Parent, send, Result),
<a name="43574"/>43574:     Reason = tpp_tcp_client_await_terminate(Parent),
<a name="43575"/>43575:     tpp_tcp_client_sock_close(Sock, Path),
<a name="43576"/>43576:     ?SEV_IPRINT(&quot;terminating&quot;),
<a name="tpp_tcp_client-last_expr"/><a name="43577"/>43577: <b>    exit</b>(Reason).
<a name="43578"/>43578: 
<a name="tpp_tcp_client_init-1"/><a name="43579"/>43579: <b>tpp_tcp_client_init</b>(Parent) -&gt;
<a name="43580"/>43580:     put(sname, &quot;rclient&quot;),
<a name="43581"/>43581:     ?SEV_IPRINT(&quot;init&quot;),
<a name="43582"/>43582:     _MRef = erlang:monitor(process, Parent),
<a name="tpp_tcp_client_init-last_expr"/><a name="43583"/>43583:     ok.
<a name="43584"/>43584: 
<a name="tpp_tcp_client_await_start-1"/><a name="43585"/>43585: <b>tpp_tcp_client_await_start</b>(Parent) -&gt;
<a name="43586"/>43586:     ?SEV_IPRINT(&quot;await start&quot;),
<a name="tpp_tcp_client_await_start-last_expr"/><a name="43587"/>43587: <b>    ?SEV_AWAIT_START</b>(Parent).
<a name="43588"/>43588: 
<a name="tpp_tcp_client_announce_ready-2"/><a name="43589"/>43589: <b>tpp_tcp_client_announce_ready</b>(Parent, Slogan) -&gt;
<a name="43590"/>43590:     ?SEV_IPRINT(&quot;announce ready (~p)&quot;, [Slogan]),
<a name="tpp_tcp_client_announce_ready-last_expr"/><a name="43591"/>43591: <b>    ?SEV_ANNOUNCE_READY</b>(Parent, Slogan).
<a name="tpp_tcp_client_announce_ready-3"/><a name="43592"/>43592: <b>tpp_tcp_client_announce_ready</b>(Parent, Slogan, Extra) -&gt;
<a name="43593"/>43593:     ?SEV_IPRINT(&quot;announce ready (~p): ~p&quot;, [Slogan, Extra]),
<a name="tpp_tcp_client_announce_ready-last_expr"/><a name="43594"/>43594: <b>    ?SEV_ANNOUNCE_READY</b>(Parent, Slogan, Extra).
<a name="43595"/>43595: 
<a name="tpp_tcp_client_await_continue-2"/><a name="43596"/>43596: <b>tpp_tcp_client_await_continue</b>(Parent, Slogan) -&gt;
<a name="43597"/>43597:     ?SEV_IPRINT(&quot;await continue (~p)&quot;, [Slogan]),
<a name="tpp_tcp_client_await_continue-last_expr"/><a name="43598"/>43598: <b>    case ?SEV_AWAIT_CONTINUE</b>(Parent, parent, Slogan) of
<a name="43599"/>43599:         ok -&gt;
<a name="43600"/>43600:             ?SEV_IPRINT(&quot;continue (~p): ok&quot;, [Slogan]),
<a name="43601"/>43601:             ok;
<a name="43602"/>43602:         {ok, Data} -&gt;
<a name="43603"/>43603:             ?SEV_IPRINT(&quot;continue (~p): ok with data&quot;, [Slogan]),
<a name="43604"/>43604:             Data;
<a name="43605"/>43605:         {error, Reason} -&gt;
<a name="43606"/>43606:             ?SEV_EPRINT(&quot;continue (~p): error&quot;
<a name="43607"/>43607:                         &quot;~n   ~p&quot;, [Slogan, Reason]),
<a name="43608"/>43608:             exit({continue, Slogan, Reason})
<a name="43609"/>43609:     end.
<a name="43610"/>43610: 
<a name="tpp_tcp_client_await_terminate-1"/><a name="43611"/>43611: <b>tpp_tcp_client_await_terminate</b>(Parent) -&gt;
<a name="43612"/>43612:     ?SEV_IPRINT(&quot;await terminate&quot;),
<a name="tpp_tcp_client_await_terminate-last_expr"/><a name="43613"/>43613: <b>    case ?SEV_AWAIT_TERMINATE</b>(Parent, parent) of
<a name="43614"/>43614:         ok -&gt;
<a name="43615"/>43615:             ?SEV_IPRINT(&quot;termination received: normal&quot;),
<a name="43616"/>43616:             normal;
<a name="43617"/>43617:         {error, Reason} -&gt;
<a name="43618"/>43618:             ?SEV_IPRINT(&quot;termination received: ~w&quot;, [Reason]),
<a name="43619"/>43619:             Reason
<a name="43620"/>43620:     end.
<a name="43621"/>43621: 
<a name="tpp_tcp_client_msg_exchange-5"/><a name="43622"/>43622: <b>tpp_tcp_client_msg_exchange</b>(Sock, Send, Recv, InitMsg, Num) -&gt;
<a name="43623"/>43623:     Start = ?LIB:timestamp(),
<a name="tpp_tcp_client_msg_exchange-last_expr"/><a name="43624"/>43624: <b>    tpp_tcp_client_msg_exchange_loop</b>(Sock, Send, Recv, InitMsg, 
<a name="43625"/>43625:                                      Num, 0, 0, 0, Start).
<a name="43626"/>43626: 
<a name="tpp_tcp_client_msg_exchange_loop-9"/><a name="43627"/>43627: <b>tpp_tcp_client_msg_exchange_loop</b>(Sock, _Send, _Recv, _Msg,
<a name="43628"/>43628:                                  Num, Num, Sent, Received,
<a name="43629"/>43629:                                  Start) -&gt;
<a name="43630"/>43630:     Stop = ?LIB:timestamp(),
<a name="43631"/>43631:     Info = socket:info(Sock),
<a name="43632"/>43632:     case socket:close(Sock) of
<a name="43633"/>43633:         ok -&gt;
<a name="43634"/>43634:             {Sent, Received, Info, Start, Stop};
<a name="43635"/>43635:         {error, Reason} -&gt;
<a name="43636"/>43636:             exit({failed_closing, Reason})
<a name="43637"/>43637:     end;
<a name="43638"/>43638: <b>tpp_tcp_client_msg_exchange_loop</b>(Sock, Send, Recv, Data, 
<a name="43639"/>43639:                                  Num, N, Sent, Received, Start) -&gt;
<a name="43640"/>43640:     %% d(&quot;tpp_tcp_client_msg_exchange_loop(~w,~w) try send ~w&quot;, [Num,N,size(Data)]),
<a name="tpp_tcp_client_msg_exchange_loop-last_expr"/><a name="43641"/>43641: <b>    case tpp_tcp_send_req</b>(Sock, Send, Data) of
<a name="43642"/>43642:         {ok, SendSz} -&gt;
<a name="43643"/>43643:             %% d(&quot;tpp_tcp_client_msg_exchange_loop(~w,~w) sent - &quot;
<a name="43644"/>43644:             %%   &quot;now try recv&quot;, [Num,N]),
<a name="43645"/>43645:             case tpp_tcp_recv_rep(Sock, Recv) of
<a name="43646"/>43646:                 {ok, NewData, RecvSz} -&gt;
<a name="43647"/>43647:                     tpp_tcp_client_msg_exchange_loop(Sock, Send, Recv,
<a name="43648"/>43648:                                                      NewData, Num, N+1,
<a name="43649"/>43649:                                                      Sent+SendSz, 
<a name="43650"/>43650:                                                      Received+RecvSz, 
<a name="43651"/>43651:                                                      Start);
<a name="43652"/>43652:                 {error, RReason} -&gt;
<a name="43653"/>43653:                     ?SEV_EPRINT(&quot;recv (~w of ~w): ~p: &quot;
<a name="43654"/>43654:                                 &quot;~n   ~p&quot;, [N, Num, RReason, mq()]),
<a name="43655"/>43655:                     exit({recv, RReason, N})
<a name="43656"/>43656:             end;
<a name="43657"/>43657:         {error, SReason} -&gt;
<a name="43658"/>43658:             ?SEV_EPRINT(&quot;send (~w of ~w): ~p&quot;
<a name="43659"/>43659:                         &quot;~n   ~p&quot;, [N, Num, SReason, mq()]),
<a name="43660"/>43660:             exit({send, SReason, N})
<a name="43661"/>43661:     end.
<a name="43662"/>43662: 
<a name="tpp_tcp_client_sock_open-3"/><a name="43663"/>43663: <b>tpp_tcp_client_sock_open</b>(Domain, Proto, BufInit) -&gt;
<a name="tpp_tcp_client_sock_open-last_expr"/><a name="43664"/>43664: <b>    case socket:open</b>(Domain, stream, Proto) of
<a name="43665"/>43665:         {ok, Sock} -&gt;
<a name="43666"/>43666:             ok = BufInit(Sock),
<a name="43667"/>43667:             Sock;
<a name="43668"/>43668:         {error, Reason} -&gt;
<a name="43669"/>43669:             exit({open_failed, Reason})
<a name="43670"/>43670:     end.
<a name="43671"/>43671: 
<a name="tpp_tcp_client_sock_bind-2"/><a name="43672"/>43672: <b>tpp_tcp_client_sock_bind</b>(Sock, Domain) -&gt;
<a name="43673"/>43673:     LSA = which_local_socket_addr(Domain),
<a name="tpp_tcp_client_sock_bind-last_expr"/><a name="43674"/>43674: <b>    case socket:bind</b>(Sock, LSA) of
<a name="43675"/>43675:         ok -&gt;
<a name="43676"/>43676:             case socket:sockname(Sock) of
<a name="43677"/>43677:                 {ok, #{family := local, path := Path}} -&gt;
<a name="43678"/>43678:                     Path;
<a name="43679"/>43679:                 {ok, _} -&gt;
<a name="43680"/>43680:                     undefined;
<a name="43681"/>43681:                 {error, Reason1} -&gt;
<a name="43682"/>43682:                     exit({sockname, Reason1})
<a name="43683"/>43683:             end;
<a name="43684"/>43684:         {error, Reason2} -&gt;
<a name="43685"/>43685:             exit({bind, Reason2})
<a name="43686"/>43686:     end.
<a name="43687"/>43687: 
<a name="tpp_tcp_client_sock_connect-2"/><a name="43688"/>43688: <b>tpp_tcp_client_sock_connect</b>(Sock, ServerSA) -&gt;
<a name="tpp_tcp_client_sock_connect-last_expr"/><a name="43689"/>43689: <b>    case socket:connect</b>(Sock, ServerSA) of
<a name="43690"/>43690:         ok -&gt;
<a name="43691"/>43691:             ok;
<a name="43692"/>43692:         {error, Reason} -&gt;
<a name="43693"/>43693:             exit({connect, Reason})
<a name="43694"/>43694:     end.
<a name="43695"/>43695: 
<a name="tpp_tcp_client_sock_close-2"/><a name="43696"/>43696: <b>tpp_tcp_client_sock_close</b>(Sock, Path) -&gt;
<a name="tpp_tcp_client_sock_close-last_expr"/><a name="43697"/>43697: <b>    case socket:close</b>(Sock) of
<a name="43698"/>43698:         ok -&gt;
<a name="43699"/>43699:             unlink_path(Path),
<a name="43700"/>43700:             ok;
<a name="43701"/>43701:         {error, closed} -&gt;
<a name="43702"/>43702:             ok;
<a name="43703"/>43703:         {error, Reason} -&gt;
<a name="43704"/>43704:             ?SEV_EPRINT(&quot;failed closing: &quot;
<a name="43705"/>43705:                         &quot;~n   Reason: ~p&quot;, [Reason]),
<a name="43706"/>43706:             unlink_path(Path),
<a name="43707"/>43707:             {error, {close, Reason}}
<a name="43708"/>43708:     end.
<a name="43709"/>43709: 
<a name="43710"/>43710:     
<a name="43711"/>43711:     
<a name="43712"/>43712: <b>-define</b>(TPP_REQUEST, 1).
<a name="43713"/>43713: <b>-define</b>(TPP_REPLY,   2).
<a name="43714"/>43714: 
<a name="tpp_tcp_recv_req-2"/><a name="43715"/>43715: <b>tpp_tcp_recv_req</b>(Sock, Recv) -&gt;
<a name="tpp_tcp_recv_req-last_expr"/><a name="43716"/>43716: <b>    tpp_tcp_recv</b>(Sock, Recv, ?TPP_REQUEST).
<a name="43717"/>43717: 
<a name="tpp_tcp_recv_rep-2"/><a name="43718"/>43718: <b>tpp_tcp_recv_rep</b>(Sock, Recv) -&gt;
<a name="tpp_tcp_recv_rep-last_expr"/><a name="43719"/>43719: <b>    tpp_tcp_recv</b>(Sock, Recv, ?TPP_REPLY).
<a name="43720"/>43720: 
<a name="tpp_tcp_recv-3"/><a name="43721"/>43721: <b>tpp_tcp_recv</b>(Sock, Recv, Tag) -&gt;
<a name="tpp_tcp_recv-last_expr"/><a name="43722"/>43722: <b>    case Recv</b>(Sock, 0) of
<a name="43723"/>43723:         {ok, &lt;&lt;Tag:32/integer, Sz:32/integer, Data/binary&gt;&gt; = Msg} 
<a name="43724"/>43724:           when (Sz =:= size(Data)) -&gt;
<a name="43725"/>43725:             %% We got it all
<a name="43726"/>43726:             {ok, Data, size(Msg)};
<a name="43727"/>43727:         {ok, &lt;&lt;Tag:32/integer, Sz:32/integer, Data/binary&gt;&gt; = Msg} -&gt;
<a name="43728"/>43728:             Remains = Sz - size(Data),
<a name="43729"/>43729:             tpp_tcp_recv(Sock, Recv, Tag, Remains, size(Msg), [Data]);
<a name="43730"/>43730:         {ok, &lt;&lt;Tag:32/integer, _/binary&gt;&gt;} -&gt;
<a name="43731"/>43731:             {error, {invalid_msg_tag, Tag}};
<a name="43732"/>43732:         {error, _R} = ERROR -&gt;
<a name="43733"/>43733:             ERROR
<a name="43734"/>43734:     end.
<a name="43735"/>43735: 
<a name="tpp_tcp_recv-6"/><a name="43736"/>43736: <b>tpp_tcp_recv</b>(Sock, Recv, Tag, Remaining, AccSz, Acc) -&gt;
<a name="tpp_tcp_recv-last_expr"/><a name="43737"/>43737: <b>    case Recv</b>(Sock, Remaining) of
<a name="43738"/>43738:         {ok, Data} when (Remaining =:= size(Data)) -&gt;
<a name="43739"/>43739:             %% We got the rest
<a name="43740"/>43740:             TotSz = AccSz + size(Data),
<a name="43741"/>43741:             {ok, erlang:iolist_to_binary(lists:reverse([Data | Acc])), TotSz};
<a name="43742"/>43742:         {ok, Data} when (Remaining &gt; size(Data)) -&gt;
<a name="43743"/>43743:             tpp_tcp_recv(Sock, Recv, Tag, 
<a name="43744"/>43744:                          Remaining - size(Data), AccSz + size(Data),     
<a name="43745"/>43745:                          [Data | Acc]);
<a name="43746"/>43746:         {error, _R} = ERROR -&gt;
<a name="43747"/>43747:             ERROR
<a name="43748"/>43748:     end.
<a name="43749"/>43749:                                                          
<a name="43750"/>43750:             
<a name="tpp_tcp_send_req-3"/><a name="43751"/>43751: <b>tpp_tcp_send_req</b>(Sock, Send, Data) -&gt;
<a name="tpp_tcp_send_req-last_expr"/><a name="43752"/>43752: <b>    tpp_tcp_send</b>(Sock, Send, ?TPP_REQUEST, Data).
<a name="43753"/>43753: 
<a name="tpp_tcp_send_rep-3"/><a name="43754"/>43754: <b>tpp_tcp_send_rep</b>(Sock, Send, Data) -&gt;
<a name="tpp_tcp_send_rep-last_expr"/><a name="43755"/>43755: <b>    tpp_tcp_send</b>(Sock, Send, ?TPP_REPLY, Data).
<a name="43756"/>43756: 
<a name="tpp_tcp_send-4"/><a name="43757"/>43757: <b>tpp_tcp_send</b>(Sock, Send, Tag, Data) -&gt;
<a name="43758"/>43758:     DataSz = size(Data),
<a name="43759"/>43759:     Msg    = &lt;&lt;Tag:32/integer, DataSz:32/integer, Data/binary&gt;&gt;,
<a name="tpp_tcp_send-last_expr"/><a name="43760"/>43760: <b>    tpp_tcp_send_msg</b>(Sock, Send, Msg, 0).
<a name="43761"/>43761: 
<a name="tpp_tcp_send_msg-4"/><a name="43762"/>43762: <b>tpp_tcp_send_msg</b>(Sock, Send, Msg, AccSz) when is_binary(Msg) -&gt;
<a name="tpp_tcp_send_msg-last_expr"/><a name="43763"/>43763: <b>    case Send</b>(Sock, Msg) of
<a name="43764"/>43764:         ok -&gt;
<a name="43765"/>43765:             {ok, AccSz+size(Msg)};
<a name="43766"/>43766:         {ok, Rest} -&gt; % This is an IOVec
<a name="43767"/>43767:             RestBin = list_to_binary(Rest),
<a name="43768"/>43768:             tpp_tcp_send_msg(Sock, Send, RestBin, AccSz+(size(Msg)-size(RestBin)));
<a name="43769"/>43769:         {error, _} = ERROR -&gt;
<a name="43770"/>43770:             ERROR
<a name="43771"/>43771:     end.
<a name="43772"/>43772:     
<a name="43773"/>43773: 
<a name="43774"/>43774: <i>%% size_of_data(Data) when is_binary(Data) -&gt;</i>
<a name="43775"/>43775: <i>%%     size(Data);</i>
<a name="43776"/>43776: <i>%% size_of_data(Data) when is_list(Data) -&gt;</i>
<a name="43777"/>43777: <i>%%     size_of_iovec(Data, 0).</i>
<a name="43778"/>43778: 
<a name="43779"/>43779: <i>%% size_of_iovec([], Sz) -&gt;</i>
<a name="43780"/>43780: <i>%%     Sz;</i>
<a name="43781"/>43781: <i>%% size_of_iovec([B|IOVec], Sz) -&gt;</i>
<a name="43782"/>43782: <i>%%     size_of_iovec(IOVec, Sz+size(B)).</i>
<a name="43783"/>43783: 
<a name="43784"/>43784: 
<a name="43785"/>43785: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="43786"/>43786: 
<a name="43787"/>43787: <i>%% Ping-Pong for UDP</i>
<a name="43788"/>43788: 
<a name="traffic_ping_pong_sendto_and_recvfrom_udp-1"/><a name="43789"/>43789: <b>traffic_ping_pong_sendto_and_recvfrom_udp</b>(InitState) -&gt;
<a name="43790"/>43790:     Send = fun(Sock, Data, Dest) -&gt;
<a name="43791"/>43791:                    socket:sendto(Sock, Data, Dest)
<a name="43792"/>43792:            end,
<a name="43793"/>43793:     Recv = fun(Sock, Sz)         -&gt;
<a name="43794"/>43794:                    socket:recvfrom(Sock, Sz)
<a name="43795"/>43795:            end,
<a name="43796"/>43796:     InitState2 = InitState#{send =&gt; Send, % Send function
<a name="43797"/>43797:                             recv =&gt; Recv  % Receive function
<a name="43798"/>43798:                            },
<a name="traffic_ping_pong_sendto_and_recvfrom_udp-last_expr"/><a name="43799"/>43799: <b>    traffic_ping_pong_send_and_receive_udp</b>(InitState2).
<a name="43800"/>43800: 
<a name="traffic_ping_pong_sendmsg_and_recvmsg_udp-1"/><a name="43801"/>43801: <b>traffic_ping_pong_sendmsg_and_recvmsg_udp</b>(InitState) -&gt;
<a name="43802"/>43802:     Send = fun(Sock, Data, Dest) when is_binary(Data) -&gt;
<a name="43803"/>43803:                    Msg = #{addr =&gt; Dest, iov =&gt; [Data]},
<a name="43804"/>43804:                    socket:sendmsg(Sock, Msg);
<a name="43805"/>43805:               (Sock, Data, Dest) when is_list(Data) -&gt; %% We assume iovec...
<a name="43806"/>43806:                    Msg = #{addr =&gt; Dest, iov =&gt; Data},
<a name="43807"/>43807:                    socket:sendmsg(Sock, Msg)
<a name="43808"/>43808:            end,
<a name="43809"/>43809:     Recv = fun(Sock, Sz)   -&gt;
<a name="43810"/>43810:                    case socket:recvmsg(Sock, Sz, 0) of
<a name="43811"/>43811:                        {ok, #{addr  := Source,
<a name="43812"/>43812:                               iov   := [Data]}} -&gt;
<a name="43813"/>43813:                            {ok, {Source, Data}};
<a name="43814"/>43814:                        {error, _} = ERROR -&gt;
<a name="43815"/>43815:                            ERROR
<a name="43816"/>43816:                    end
<a name="43817"/>43817:            end,
<a name="43818"/>43818:     InitState2 = InitState#{send =&gt; Send, % Send function
<a name="43819"/>43819:                             recv =&gt; Recv  % Receive function
<a name="43820"/>43820:                            },
<a name="traffic_ping_pong_sendmsg_and_recvmsg_udp-last_expr"/><a name="43821"/>43821: <b>    traffic_ping_pong_send_and_receive_udp</b>(InitState2).
<a name="43822"/>43822: 
<a name="43823"/>43823: 
<a name="traffic_ping_pong_send_and_receive_udp-1"/><a name="43824"/>43824: <b>traffic_ping_pong_send_and_receive_udp</b>(#{msg := Msg} = InitState) -&gt;
<a name="43825"/>43825:     Fun = fun(Sock) -&gt; 
<a name="43826"/>43826:                   {ok, RcvSz} = socket:getopt(Sock, socket, rcvbuf),
<a name="43827"/>43827:                   if (RcvSz =&lt; (8+size(Msg))) -&gt;
<a name="43828"/>43828:                           i(&quot;adjust socket rcvbuf buffer size&quot;),
<a name="43829"/>43829:                           ok = socket:setopt(Sock, socket, rcvbuf, 1024+size(Msg));
<a name="43830"/>43830:                      true -&gt;
<a name="43831"/>43831:                           ok
<a name="43832"/>43832:                   end,
<a name="43833"/>43833:                   {ok, SndSz} = socket:getopt(Sock, socket, sndbuf),
<a name="43834"/>43834:                   if (SndSz =&lt; (8+size(Msg))) -&gt;
<a name="43835"/>43835:                           i(&quot;adjust socket sndbuf buffer size&quot;),
<a name="43836"/>43836:                           ok = socket:setopt(Sock, socket, sndbuf, 1024+size(Msg));
<a name="43837"/>43837:                      true -&gt;
<a name="43838"/>43838:                           ok
<a name="43839"/>43839:                   end,
<a name="43840"/>43840:                   {ok, OtpRcvBuf} = socket:getopt(Sock, otp, rcvbuf),
<a name="43841"/>43841:                   if
<a name="43842"/>43842:                       (OtpRcvBuf =&lt; (8+size(Msg))) -&gt;
<a name="43843"/>43843:                           i(&quot;adjust otp rcvbuf buffer size&quot;),
<a name="43844"/>43844:                           ok = socket:setopt(Sock, otp, rcvbuf, 1024+size(Msg));
<a name="43845"/>43845:                       true -&gt;
<a name="43846"/>43846:                           ok
<a name="43847"/>43847:                   end
<a name="43848"/>43848:           end,
<a name="traffic_ping_pong_send_and_receive_udp-last_expr"/><a name="43849"/>43849: <b>    traffic_ping_pong_send_and_receive_udp2</b>(InitState#{buf_init =&gt; Fun}).
<a name="43850"/>43850: 
<a name="traffic_ping_pong_send_and_receive_udp2-1"/><a name="43851"/>43851: <b>traffic_ping_pong_send_and_receive_udp2</b>(InitState) -&gt;
<a name="43852"/>43852:     ServerSeq =
<a name="43853"/>43853:         [
<a name="43854"/>43854:          %% *** Wait for start order part ***
<a name="43855"/>43855:          #{desc =&gt; &quot;await start&quot;,
<a name="43856"/>43856:            cmd  =&gt; fun(State) -&gt;
<a name="43857"/>43857:                            Tester = ?SEV_AWAIT_START(),
<a name="43858"/>43858:                            {ok, State#{tester =&gt; Tester}}
<a name="43859"/>43859:                    end},
<a name="43860"/>43860:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="43861"/>43861:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="43862"/>43862:                            _MRef = erlang:monitor(process, Tester),
<a name="43863"/>43863:                            ok
<a name="43864"/>43864:                    end},
<a name="43865"/>43865: 
<a name="43866"/>43866:          %% *** Init part ***
<a name="43867"/>43867:          #{desc =&gt; &quot;which local address&quot;,
<a name="43868"/>43868:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="43869"/>43869:                            LSA = which_local_socket_addr(Domain),
<a name="43870"/>43870:                            {ok, State#{local_sa =&gt; LSA}}
<a name="43871"/>43871:                    end},
<a name="43872"/>43872:          #{desc =&gt; &quot;create socket&quot;,
<a name="43873"/>43873:            cmd  =&gt; fun(#{domain := Domain, proto := Proto} = State) -&gt;
<a name="43874"/>43874:                            case socket:open(Domain, dgram, Proto) of
<a name="43875"/>43875:                                {ok, Sock} -&gt;
<a name="43876"/>43876:                                    {ok, State#{sock =&gt; Sock}};
<a name="43877"/>43877:                                {error, _} = ERROR -&gt;
<a name="43878"/>43878:                                    ERROR
<a name="43879"/>43879:                            end
<a name="43880"/>43880:                    end},
<a name="43881"/>43881:          #{desc =&gt; &quot;bind to local address&quot;,
<a name="43882"/>43882:            cmd  =&gt; fun(#{domain := local,
<a name="43883"/>43883:                          sock := Sock, local_sa := LSA} = _State) -&gt;
<a name="43884"/>43884:                            case socket:bind(Sock, LSA) of
<a name="43885"/>43885:                                ok -&gt;
<a name="43886"/>43886:                                    ok;
<a name="43887"/>43887:                                {error, _} = ERROR -&gt;
<a name="43888"/>43888:                                    ERROR
<a name="43889"/>43889:                            end;
<a name="43890"/>43890:                       (#{sock := Sock, local_sa := LSA} = State) -&gt;
<a name="43891"/>43891:                            case sock_bind(Sock, LSA) of
<a name="43892"/>43892:                                ok -&gt;
<a name="43893"/>43893:                                    Port = sock_port(Sock),
<a name="43894"/>43894:                                    {ok, State#{port =&gt; Port}};
<a name="43895"/>43895:                                {error, _} = ERROR -&gt;
<a name="43896"/>43896:                                    ERROR
<a name="43897"/>43897:                            end
<a name="43898"/>43898:                    end},
<a name="43899"/>43899:          #{desc =&gt; &quot;maybe init buffers&quot;,
<a name="43900"/>43900:            cmd  =&gt; fun(#{sock := Sock, buf_init := BufInit} = _State) -&gt;
<a name="43901"/>43901:                            BufInit(Sock)
<a name="43902"/>43902:                    end},
<a name="43903"/>43903:          #{desc =&gt; &quot;create handler&quot;,
<a name="43904"/>43904:            cmd  =&gt; fun(State) -&gt;
<a name="43905"/>43905:                            Handler = tpp_udp_server_handler_create(),
<a name="43906"/>43906:                            ?SEV_IPRINT(&quot;handler created: ~p&quot;, [Handler]),
<a name="43907"/>43907:                            {ok, State#{handler =&gt; Handler}}
<a name="43908"/>43908:                    end},
<a name="43909"/>43909:          #{desc =&gt; &quot;monitor handler&quot;,
<a name="43910"/>43910:            cmd  =&gt; fun(#{handler := Handler} = _State) -&gt;
<a name="43911"/>43911:                            _MRef = erlang:monitor(process, Handler),
<a name="43912"/>43912:                            ok
<a name="43913"/>43913:                    end},
<a name="43914"/>43914:          #{desc =&gt; &quot;start handler&quot;,
<a name="43915"/>43915:            cmd  =&gt; fun(#{handler := Handler,
<a name="43916"/>43916:                          sock    := Sock,
<a name="43917"/>43917:                          send    := Send,
<a name="43918"/>43918:                          recv    := Recv} = _State) -&gt;
<a name="43919"/>43919:                            ?SEV_ANNOUNCE_START(Handler, {Sock, Send, Recv}),
<a name="43920"/>43920:                            ok
<a name="43921"/>43921:                    end},
<a name="43922"/>43922:          #{desc =&gt; &quot;await handler ready (init)&quot;,
<a name="43923"/>43923:            cmd  =&gt; fun(#{tester  := Tester,
<a name="43924"/>43924:                          handler := Handler} = State) -&gt;
<a name="43925"/>43925:                            case ?SEV_AWAIT_READY(Handler, handler, init, 
<a name="43926"/>43926:                                                  [{tester, Tester}]) of
<a name="43927"/>43927:                                ok -&gt;
<a name="43928"/>43928:                                    {ok, maps:remove(csock, State)};
<a name="43929"/>43929:                                {error, _} = ERROR -&gt;
<a name="43930"/>43930:                                    ERROR
<a name="43931"/>43931:                            end
<a name="43932"/>43932:                    end},
<a name="43933"/>43933:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="43934"/>43934:            cmd  =&gt; fun(#{domain := local,
<a name="43935"/>43935:                          tester := Tester, local_sa := LSA}) -&gt;
<a name="43936"/>43936:                            ?SEV_ANNOUNCE_READY(Tester, init, LSA),
<a name="43937"/>43937:                            ok;
<a name="43938"/>43938:                       (#{tester := Tester, local_sa := LSA, port := Port}) -&gt;
<a name="43939"/>43939:                            ServerSA = LSA#{port =&gt; Port},
<a name="43940"/>43940:                            ?SEV_ANNOUNCE_READY(Tester, init, ServerSA),
<a name="43941"/>43941:                            ok
<a name="43942"/>43942:                    end},
<a name="43943"/>43943: 
<a name="43944"/>43944:          %% The actual test
<a name="43945"/>43945:          #{desc =&gt; &quot;await continue (recv)&quot;,
<a name="43946"/>43946:            cmd  =&gt; fun(#{tester  := Tester,
<a name="43947"/>43947:                          handler := Handler} = _State) -&gt;
<a name="43948"/>43948:                            ?SEV_AWAIT_CONTINUE(Tester, tester, recv, 
<a name="43949"/>43949:                                                [{handler, Handler}])
<a name="43950"/>43950:                    end},
<a name="43951"/>43951:          #{desc =&gt; &quot;order handler to recv&quot;,
<a name="43952"/>43952:            cmd  =&gt; fun(#{handler := Handler,
<a name="43953"/>43953:                          sock    := _Sock} = _State) -&gt;
<a name="43954"/>43954:                            %% socket:setopt(Sock, otp, debug, true),
<a name="43955"/>43955:                            ?SEV_ANNOUNCE_CONTINUE(Handler, recv),
<a name="43956"/>43956:                            ok
<a name="43957"/>43957:                    end},
<a name="43958"/>43958:          #{desc =&gt; &quot;await continue (close)&quot;,
<a name="43959"/>43959:            cmd  =&gt; fun(#{tester  := Tester,
<a name="43960"/>43960:                          handler := Handler} = _State) -&gt;
<a name="43961"/>43961:                            ?SEV_AWAIT_CONTINUE(Tester, tester, close, 
<a name="43962"/>43962:                                                [{handler, Handler}])
<a name="43963"/>43963:                    end},
<a name="43964"/>43964: 
<a name="43965"/>43965:          ?SEV_SLEEP(?SECS(1)),
<a name="43966"/>43966: 
<a name="43967"/>43967:          #{desc =&gt; &quot;close socket&quot;,
<a name="43968"/>43968:            cmd  =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="43969"/>43969:                            %% socket:setopt(Sock, otp, debug, true),
<a name="43970"/>43970:                            case socket:close(Sock) of
<a name="43971"/>43971:                                ok -&gt;
<a name="43972"/>43972:                                    {ok, maps:remove(sock, State)};
<a name="43973"/>43973:                                {error, _} = ERROR -&gt;
<a name="43974"/>43974:                                    ERROR
<a name="43975"/>43975:                            end
<a name="43976"/>43976:                    end},
<a name="43977"/>43977:          #{desc =&gt; &quot;(maybe) unlink socket&quot;,
<a name="43978"/>43978:            cmd  =&gt; fun(#{domain   := local,
<a name="43979"/>43979:                          local_sa := #{path := Path}} = State) -&gt;
<a name="43980"/>43980:                            unlink_path(Path,
<a name="43981"/>43981:                                        fun() -&gt;
<a name="43982"/>43982:                                                {ok, maps:remove(local_sa, State)}
<a name="43983"/>43983:                                        end,
<a name="43984"/>43984:                                        fun() -&gt;
<a name="43985"/>43985:                                                ok
<a name="43986"/>43986:                                        end);
<a name="43987"/>43987:                       (_) -&gt;
<a name="43988"/>43988:                            ok
<a name="43989"/>43989:                    end},
<a name="43990"/>43990:          #{desc =&gt; &quot;announce ready (close)&quot;,
<a name="43991"/>43991:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="43992"/>43992:                            ?SEV_ANNOUNCE_READY(Tester, close),
<a name="43993"/>43993:                            ok
<a name="43994"/>43994:                    end},
<a name="43995"/>43995:          #{desc =&gt; &quot;await handler ready (recv)&quot;,
<a name="43996"/>43996:            cmd  =&gt; fun(#{tester  := Tester,
<a name="43997"/>43997:                          handler := Handler} = State) -&gt;
<a name="43998"/>43998:                            case ?SEV_AWAIT_READY(Handler, handler, recv, 
<a name="43999"/>43999:                                                  [{tester, Tester}]) of
<a name="44000"/>44000:                                {ok, Result} -&gt;
<a name="44001"/>44001:                                    %% ?SEV_IPRINT(&quot;Result: ~p&quot;, [Result]),
<a name="44002"/>44002:                                    {ok, State#{result =&gt; Result}};
<a name="44003"/>44003:                                {error, _} = ERROR -&gt;
<a name="44004"/>44004:                                    ERROR
<a name="44005"/>44005:                            end
<a name="44006"/>44006:                    end},
<a name="44007"/>44007:          #{desc =&gt; &quot;announce ready (recv)&quot;,
<a name="44008"/>44008:            cmd  =&gt; fun(#{tester := Tester, 
<a name="44009"/>44009:                          result := Result} = State) -&gt;
<a name="44010"/>44010:                            ?SEV_ANNOUNCE_READY(Tester, recv, Result),
<a name="44011"/>44011:                            {ok, maps:remove(result, State)}
<a name="44012"/>44012:                    end},
<a name="44013"/>44013: 
<a name="44014"/>44014:          %% Termination
<a name="44015"/>44015:          #{desc =&gt; &quot;await terminate (from tester)&quot;,
<a name="44016"/>44016:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="44017"/>44017:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="44018"/>44018:                                ok -&gt;
<a name="44019"/>44019:                                    {ok, maps:remove(tester, State)};
<a name="44020"/>44020:                                {error, _} = ERROR -&gt;
<a name="44021"/>44021:                                    ERROR
<a name="44022"/>44022:                            end
<a name="44023"/>44023:                    end},
<a name="44024"/>44024:          #{desc =&gt; &quot;stop handler&quot;,
<a name="44025"/>44025:            cmd  =&gt; fun(#{handler := Handler}) -&gt;
<a name="44026"/>44026:                            ?SEV_ANNOUNCE_TERMINATE(Handler),
<a name="44027"/>44027:                            ok
<a name="44028"/>44028:                    end},
<a name="44029"/>44029:          #{desc =&gt; &quot;await handler termination&quot;,
<a name="44030"/>44030:            cmd  =&gt; fun(#{handler := Handler} = State) -&gt;
<a name="44031"/>44031:                            ?SEV_AWAIT_TERMINATION(Handler),
<a name="44032"/>44032:                            State1 = maps:remove(handler, State),
<a name="44033"/>44033:                            {ok, State1}
<a name="44034"/>44034:                    end},
<a name="44035"/>44035: 
<a name="44036"/>44036:          %% *** We are done ***
<a name="44037"/>44037:          ?SEV_FINISH_NORMAL
<a name="44038"/>44038:         ],
<a name="44039"/>44039: 
<a name="44040"/>44040:     ClientSeq =
<a name="44041"/>44041:         [
<a name="44042"/>44042:          %% *** Wait for start order part ***
<a name="44043"/>44043:          #{desc =&gt; &quot;await start&quot;,
<a name="44044"/>44044:            cmd  =&gt; fun(State) -&gt;
<a name="44045"/>44045:                            {Tester, ServerSA} = ?SEV_AWAIT_START(),
<a name="44046"/>44046:                            {ok, State#{tester    =&gt; Tester, 
<a name="44047"/>44047:                                        server_sa =&gt; ServerSA}}
<a name="44048"/>44048:                    end},
<a name="44049"/>44049:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="44050"/>44050:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="44051"/>44051:                            _MRef = erlang:monitor(process, Tester),
<a name="44052"/>44052:                            ok
<a name="44053"/>44053:                    end},
<a name="44054"/>44054: 
<a name="44055"/>44055:          %% *** Init part ***
<a name="44056"/>44056:          #{desc =&gt; &quot;create node&quot;,
<a name="44057"/>44057:            cmd  =&gt; fun(State) -&gt;
<a name="44058"/>44058:                            {Peer, Node} = ?START_NODE(&quot;client&quot;),
<a name="44059"/>44059:                            {ok, State#{peer =&gt; Peer, node =&gt; Node}}
<a name="44060"/>44060:                    end},
<a name="44061"/>44061:          #{desc =&gt; &quot;monitor client node&quot;,
<a name="44062"/>44062:            cmd  =&gt; fun(#{node := Node} = _State) -&gt;
<a name="44063"/>44063:                            true = erlang:monitor_node(Node, true),
<a name="44064"/>44064:                            ok
<a name="44065"/>44065:                    end},
<a name="44066"/>44066:          #{desc =&gt; &quot;create (remote) handler&quot;,
<a name="44067"/>44067:            cmd  =&gt; fun(#{node := Node} = State) -&gt;
<a name="44068"/>44068:                            Pid = tpp_udp_client_handler_create(Node),
<a name="44069"/>44069:                            ?SEV_IPRINT(&quot;handler created: ~p&quot;, [Pid]),
<a name="44070"/>44070:                            {ok, State#{handler =&gt; Pid}}
<a name="44071"/>44071:                    end},
<a name="44072"/>44072:          #{desc =&gt; &quot;monitor remote handler&quot;,
<a name="44073"/>44073:            cmd  =&gt; fun(#{handler := Pid}) -&gt;
<a name="44074"/>44074:                            _MRef = erlang:monitor(process, Pid),
<a name="44075"/>44075:                            ok
<a name="44076"/>44076:                    end},
<a name="44077"/>44077:          #{desc =&gt; &quot;order remote handler to start&quot;,
<a name="44078"/>44078:            cmd  =&gt; fun(#{handler   := Handler,
<a name="44079"/>44079:                          server_sa := ServerSA,
<a name="44080"/>44080:                          proto     := Proto,
<a name="44081"/>44081:                          buf_init  := BufInit,
<a name="44082"/>44082:                          send      := Send,
<a name="44083"/>44083:                          recv      := Recv}) -&gt;
<a name="44084"/>44084:                            ?SEV_ANNOUNCE_START(Handler, 
<a name="44085"/>44085:                                                {ServerSA, Proto, BufInit,
<a name="44086"/>44086:                                                 Send, Recv}),
<a name="44087"/>44087:                            ok
<a name="44088"/>44088:                    end},
<a name="44089"/>44089:          #{desc =&gt; &quot;await (remote) handler ready&quot;,
<a name="44090"/>44090:            cmd  =&gt; fun(#{tester  := Tester,
<a name="44091"/>44091:                          handler := Handler} = _State) -&gt;
<a name="44092"/>44092:                            ?SEV_AWAIT_READY(Handler, handler, init, 
<a name="44093"/>44093:                                             [{tester, Tester}])
<a name="44094"/>44094:                    end},
<a name="44095"/>44095:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="44096"/>44096:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="44097"/>44097:                            ?SEV_ANNOUNCE_READY(Tester, init),
<a name="44098"/>44098:                            ok
<a name="44099"/>44099:                    end},
<a name="44100"/>44100: 
<a name="44101"/>44101:          %% The actual test
<a name="44102"/>44102:          #{desc =&gt; &quot;await continue (send)&quot;,
<a name="44103"/>44103:            cmd  =&gt; fun(#{tester  := Tester,
<a name="44104"/>44104:                          handler := Handler} = _State) -&gt;
<a name="44105"/>44105:                            ?SEV_AWAIT_CONTINUE(Tester, tester, 
<a name="44106"/>44106:                                                send, 
<a name="44107"/>44107:                                                [{handler, Handler}])
<a name="44108"/>44108:                    end},
<a name="44109"/>44109:          #{desc =&gt; &quot;order handler to continue (send)&quot;,
<a name="44110"/>44110:            cmd  =&gt; fun(#{handler := Handler,
<a name="44111"/>44111:                          msg     := Msg,
<a name="44112"/>44112:                          num     := Num} = State) -&gt;
<a name="44113"/>44113:                            Data = {Msg, Num},
<a name="44114"/>44114:                            ?SEV_ANNOUNCE_CONTINUE(Handler, send, Data),
<a name="44115"/>44115:                            {ok, maps:remove(data, State)}
<a name="44116"/>44116:                    end},
<a name="44117"/>44117:          #{desc =&gt; &quot;await remote handler ready (send)&quot;,
<a name="44118"/>44118:            cmd  =&gt; fun(#{tester  := Tester,
<a name="44119"/>44119:                          handler := Handler} = State) -&gt;
<a name="44120"/>44120:                            case ?SEV_AWAIT_READY(Handler, handler, send, 
<a name="44121"/>44121:                                                  [{tester, Tester}]) of
<a name="44122"/>44122:                                {ok, Result} -&gt;
<a name="44123"/>44123:                                    %% ?SEV_IPRINT(&quot;remote client result: &quot;
<a name="44124"/>44124:                                    %%             &quot;~n   ~p&quot;, [Result]),
<a name="44125"/>44125:                                    {ok, State#{result =&gt; Result}};
<a name="44126"/>44126:                                {error, _} = ERROR -&gt;
<a name="44127"/>44127:                                    ERROR
<a name="44128"/>44128:                            end
<a name="44129"/>44129:                    end},
<a name="44130"/>44130:          #{desc =&gt; &quot;announce ready (send)&quot;,
<a name="44131"/>44131:            cmd  =&gt; fun(#{tester := Tester, result := Result} = State) -&gt;
<a name="44132"/>44132:                            ?SEV_ANNOUNCE_READY(Tester, send, Result),
<a name="44133"/>44133:                            {ok, maps:remove(result, State)}
<a name="44134"/>44134:                    end},
<a name="44135"/>44135: 
<a name="44136"/>44136:          %% Termination
<a name="44137"/>44137:          #{desc =&gt; &quot;await terminate (from tester)&quot;,
<a name="44138"/>44138:            cmd  =&gt; fun(#{tester  := Tester, 
<a name="44139"/>44139:                          handler := Handler} = State) -&gt;
<a name="44140"/>44140:                            case ?SEV_AWAIT_TERMINATE(Tester, tester,
<a name="44141"/>44141:                                                      [{handler, Handler}]) of
<a name="44142"/>44142:                                ok -&gt;
<a name="44143"/>44143:                                    {ok, maps:remove(tester, State)};
<a name="44144"/>44144:                                {error, _} = ERROR -&gt;
<a name="44145"/>44145:                                    ERROR
<a name="44146"/>44146:                            end
<a name="44147"/>44147:                    end},
<a name="44148"/>44148:          #{desc =&gt; &quot;stop (remote) handler&quot;,
<a name="44149"/>44149:            cmd  =&gt; fun(#{handler := Handler}) -&gt;
<a name="44150"/>44150:                            ?SEV_ANNOUNCE_TERMINATE(Handler),
<a name="44151"/>44151:                            ok
<a name="44152"/>44152:                    end},
<a name="44153"/>44153:          #{desc =&gt; &quot;await (remote) handler termination&quot;,
<a name="44154"/>44154:            cmd  =&gt; fun(#{handler := Handler} = State) -&gt;
<a name="44155"/>44155:                            ?SEV_AWAIT_TERMINATION(Handler),
<a name="44156"/>44156:                            State1 = maps:remove(handler, State),
<a name="44157"/>44157:                            {ok, State1}
<a name="44158"/>44158:                    end},
<a name="44159"/>44159:          #{desc =&gt; &quot;stop client node&quot;,
<a name="44160"/>44160:            cmd  =&gt; fun(#{peer := Peer} = State) -&gt;
<a name="44161"/>44161:                            {ok,
<a name="44162"/>44162:                             try peer:stop(Peer) of
<a name="44163"/>44163:                                 ok -&gt;
<a name="44164"/>44164:                                     State#{node_stop =&gt; ok};
<a name="44165"/>44165:                                 {error, Reason} -&gt;
<a name="44166"/>44166:                                     ?SEV_EPRINT(&quot;Unexpected node stop result: &quot;
<a name="44167"/>44167:                                                 &quot;~n   ~p&quot;, [Reason]),
<a name="44168"/>44168:                                     State#{node_stop =&gt; error}
<a name="44169"/>44169:                             catch
<a name="44170"/>44170:                                 C:E:S -&gt;
<a name="44171"/>44171:                                     ?SEV_EPRINT(&quot;Unexpected node stop result: &quot;
<a name="44172"/>44172:                                                 &quot;~n   Class: ~p&quot;
<a name="44173"/>44173:                                                 &quot;~n   Error: ~p&quot;
<a name="44174"/>44174:                                                 &quot;~n   Stack: ~p&quot;,[C, E, S]),
<a name="44175"/>44175:                                     State#{node_stop =&gt; error}
<a name="44176"/>44176:                             end}
<a name="44177"/>44177:                    end},
<a name="44178"/>44178:          #{desc =&gt; &quot;await client node termination&quot;,
<a name="44179"/>44179:            cmd  =&gt; fun(#{node := Node} = State) -&gt;
<a name="44180"/>44180:                            ?SEV_IPRINT(&quot;Success node stop - await nodedown&quot;),
<a name="44181"/>44181:                            receive
<a name="44182"/>44182:                                {nodedown, Node} -&gt;
<a name="44183"/>44183:                                    ?SEV_IPRINT(&quot;nodedown received - cleanup&quot;),
<a name="44184"/>44184:                                    State1 = maps:remove(node, State),
<a name="44185"/>44185:                                    {ok, State1}
<a name="44186"/>44186:                            end;
<a name="44187"/>44187:                       (#{node_stop := error} = State) -&gt;
<a name="44188"/>44188:                            ?SEV_IPRINT(&quot;Failed node stop - cleanup&quot;),
<a name="44189"/>44189:                            State1 = maps:remove(node, State),
<a name="44190"/>44190:                            {ok, State1}
<a name="44191"/>44191:                    end},
<a name="44192"/>44192: 
<a name="44193"/>44193:          %% *** We are done ***
<a name="44194"/>44194:          ?SEV_FINISH_NORMAL
<a name="44195"/>44195:         ],
<a name="44196"/>44196: 
<a name="44197"/>44197:     TesterSeq =
<a name="44198"/>44198:         [
<a name="44199"/>44199:          %% *** Init part ***
<a name="44200"/>44200:          #{desc =&gt; &quot;monitor server&quot;,
<a name="44201"/>44201:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="44202"/>44202:                            _MRef = erlang:monitor(process, Pid),
<a name="44203"/>44203:                            ok
<a name="44204"/>44204:                    end},
<a name="44205"/>44205:          #{desc =&gt; &quot;monitor client&quot;,
<a name="44206"/>44206:            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;
<a name="44207"/>44207:                            _MRef = erlang:monitor(process, Pid),
<a name="44208"/>44208:                            ok
<a name="44209"/>44209:                    end},
<a name="44210"/>44210: 
<a name="44211"/>44211:          %% Start the server
<a name="44212"/>44212:          #{desc =&gt; &quot;order server start&quot;,
<a name="44213"/>44213:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="44214"/>44214:                            ?SEV_ANNOUNCE_START(Pid),
<a name="44215"/>44215:                            ok
<a name="44216"/>44216:                    end},
<a name="44217"/>44217:          #{desc =&gt; &quot;await server ready (init)&quot;,
<a name="44218"/>44218:            cmd  =&gt; fun(#{server := Pid} = State) -&gt;
<a name="44219"/>44219:                            {ok, ServerSA} = ?SEV_AWAIT_READY(Pid, server, init),
<a name="44220"/>44220:                            {ok, State#{server_sa =&gt; ServerSA}}
<a name="44221"/>44221:                    end},
<a name="44222"/>44222: 
<a name="44223"/>44223:          %% Start the client
<a name="44224"/>44224:          #{desc =&gt; &quot;order client start&quot;,
<a name="44225"/>44225:            cmd  =&gt; fun(#{client    := Pid, 
<a name="44226"/>44226:                          server_sa := ServerSA} = _State) -&gt;
<a name="44227"/>44227:                            ?SEV_ANNOUNCE_START(Pid, ServerSA),
<a name="44228"/>44228:                            ok
<a name="44229"/>44229:                    end},
<a name="44230"/>44230:          #{desc =&gt; &quot;await client ready (init)&quot;,
<a name="44231"/>44231:            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;
<a name="44232"/>44232:                            ok = ?SEV_AWAIT_READY(Pid, client, init)
<a name="44233"/>44233:                    end},
<a name="44234"/>44234:  
<a name="44235"/>44235:          %% The actual test
<a name="44236"/>44236:          #{desc =&gt; &quot;order server continue (recv)&quot;,
<a name="44237"/>44237:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="44238"/>44238:                            ?SEV_ANNOUNCE_CONTINUE(Pid, recv),
<a name="44239"/>44239:                            ok
<a name="44240"/>44240:                    end},
<a name="44241"/>44241:          ?SEV_SLEEP(?SECS(1)),
<a name="44242"/>44242:          #{desc =&gt; &quot;order client continue (send)&quot;,
<a name="44243"/>44243:            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;
<a name="44244"/>44244:                            ?SEV_ANNOUNCE_CONTINUE(Pid, send),
<a name="44245"/>44245:                            ok
<a name="44246"/>44246:                    end},
<a name="44247"/>44247:          #{desc =&gt; &quot;await client ready (send)&quot;,
<a name="44248"/>44248:            cmd  =&gt; fun(#{server := Server,
<a name="44249"/>44249:                          client := Client} = State) -&gt;
<a name="44250"/>44250:                            case ?SEV_AWAIT_READY(Client, client, send, 
<a name="44251"/>44251:                                                  [{server, Server}]) of
<a name="44252"/>44252:                                {ok, {_, _, _, _} = Result} -&gt;
<a name="44253"/>44253:                                    ?SEV_IPRINT(&quot;client result: &quot;
<a name="44254"/>44254:                                                &quot;~n   ~p&quot;, [Result]),
<a name="44255"/>44255:                                    {ok, State#{client_result =&gt; Result}};
<a name="44256"/>44256:                                {ok, BadResult} -&gt;
<a name="44257"/>44257:                                    ?SEV_EPRINT(&quot;client result: &quot;
<a name="44258"/>44258:                                                &quot;~n   ~p&quot;, [BadResult]),
<a name="44259"/>44259:                                    {error, {invalid_client_result, BadResult}};
<a name="44260"/>44260:                                {error, _} = ERROR -&gt;
<a name="44261"/>44261:                                    ERROR
<a name="44262"/>44262:                            end
<a name="44263"/>44263:                    end},
<a name="44264"/>44264:          #{desc =&gt; &quot;order server continue (close)&quot;,
<a name="44265"/>44265:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="44266"/>44266:                            ?SEV_ANNOUNCE_CONTINUE(Pid, close),
<a name="44267"/>44267:                            ok
<a name="44268"/>44268:                    end},
<a name="44269"/>44269:          #{desc =&gt; &quot;await server ready (close)&quot;,
<a name="44270"/>44270:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="44271"/>44271:                            ok = ?SEV_AWAIT_READY(Pid, server, close)
<a name="44272"/>44272:                    end},
<a name="44273"/>44273:          %% Because of the way we control the server, there is no real 
<a name="44274"/>44274:          %% point in collecting statistics from it (the time will include
<a name="44275"/>44275:          %% our communication with it).
<a name="44276"/>44276:          #{desc =&gt; &quot;await server ready (recv)&quot;,
<a name="44277"/>44277:            cmd  =&gt; fun(#{server := Server,
<a name="44278"/>44278:                          client := Client} = _State) -&gt;
<a name="44279"/>44279:                            case ?SEV_AWAIT_READY(Server, server, recv,
<a name="44280"/>44280:                                                  [{client, Client}]) of
<a name="44281"/>44281:                                {ok, _Result} -&gt;
<a name="44282"/>44282:                                    ok;
<a name="44283"/>44283:                                {error, _} = ERROR -&gt;
<a name="44284"/>44284:                                    ERROR
<a name="44285"/>44285:                            end
<a name="44286"/>44286:                    end},
<a name="44287"/>44287:          #{desc =&gt; &quot;present result&quot;,
<a name="44288"/>44288:            cmd  =&gt; fun(#{client_result := CRes,
<a name="44289"/>44289:                          num           := Num} = State) -&gt;
<a name="44290"/>44290:                            {CSent, CReceived, CStart, CStop} = CRes,
<a name="44291"/>44291:                            CTime = tdiff(CStart, CStop),
<a name="44292"/>44292:                            if
<a name="44293"/>44293:                                (CTime =:= 0) -&gt;
<a name="44294"/>44294:                                    {skip,
<a name="44295"/>44295:                                     ?F(&quot;Invalid exec time: ~w &quot;, [CTime])};
<a name="44296"/>44296:                                true -&gt;
<a name="44297"/>44297:                                    %% Note that the sizes we are counting is
<a name="44298"/>44298:                                    %% only the &quot;data&quot; part of the messages.
<a name="44299"/>44299:                                    %% There is also fixed header for each
<a name="44300"/>44300:                                    %% message, which of course is small for
<a name="44301"/>44301:                                    %% the large messages, but comparatively
<a name="44302"/>44302:                                    %% big for the small messages!
<a name="44303"/>44303:                                    ?SEV_IPRINT(
<a name="44304"/>44304:                                       &quot;Results: ~w messages exchanged&quot;
<a name="44305"/>44305:                                       &quot;~n   Client: ~w msec&quot;
<a name="44306"/>44306:                                       &quot;~n      ~.2f msec/message (roundtrip)&quot;
<a name="44307"/>44307:                                       &quot;~n      ~.2f messages/msec (roundtrip)&quot;
<a name="44308"/>44308:                                       &quot;~n      ~w bytes/msec sent&quot;
<a name="44309"/>44309:                                       &quot;~n      ~w bytes/msec received&quot;,
<a name="44310"/>44310:                                       [Num,
<a name="44311"/>44311:                                        CTime,
<a name="44312"/>44312:                                        CTime / Num,
<a name="44313"/>44313:                                        Num / CTime,
<a name="44314"/>44314:                                        CSent div CTime,
<a name="44315"/>44315:                                        CReceived div CTime]),
<a name="44316"/>44316:                                    State1 = maps:remove(client_result, State),
<a name="44317"/>44317:                                    {ok, State1}
<a name="44318"/>44318:                            end
<a name="44319"/>44319:                    end},
<a name="44320"/>44320: 
<a name="44321"/>44321:          %% Terminations
<a name="44322"/>44322:          #{desc =&gt; &quot;order client to terminate&quot;,
<a name="44323"/>44323:            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;
<a name="44324"/>44324:                            ?SEV_ANNOUNCE_TERMINATE(Pid),
<a name="44325"/>44325:                            ok
<a name="44326"/>44326:                    end},
<a name="44327"/>44327:          #{desc =&gt; &quot;await client termination&quot;,
<a name="44328"/>44328:            cmd  =&gt; fun(#{client := Pid} = State) -&gt;
<a name="44329"/>44329:                            case ?SEV_AWAIT_TERMINATION(Pid) of
<a name="44330"/>44330:                                ok -&gt;
<a name="44331"/>44331:                                    State1 = maps:remove(client, State),
<a name="44332"/>44332:                                    {ok, State1};
<a name="44333"/>44333:                                {error, _} = ERROR -&gt;
<a name="44334"/>44334:                                    ERROR
<a name="44335"/>44335:                            end
<a name="44336"/>44336:                    end},
<a name="44337"/>44337:          #{desc =&gt; &quot;order server to terminate&quot;,
<a name="44338"/>44338:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="44339"/>44339:                            ?SEV_ANNOUNCE_TERMINATE(Pid),
<a name="44340"/>44340:                            ok
<a name="44341"/>44341:                    end},
<a name="44342"/>44342:          #{desc =&gt; &quot;await server termination&quot;,
<a name="44343"/>44343:            cmd  =&gt; fun(#{server := Pid} = State) -&gt;
<a name="44344"/>44344:                            case ?SEV_AWAIT_TERMINATION(Pid) of
<a name="44345"/>44345:                                ok -&gt;
<a name="44346"/>44346:                                    State1 = maps:remove(server, State),
<a name="44347"/>44347:                                    {ok, State1};
<a name="44348"/>44348:                                {error, _} = ERROR -&gt;
<a name="44349"/>44349:                                    ERROR
<a name="44350"/>44350:                            end
<a name="44351"/>44351:                    end},
<a name="44352"/>44352: 
<a name="44353"/>44353: 
<a name="44354"/>44354:          %% *** We are done ***
<a name="44355"/>44355:          ?SEV_FINISH_NORMAL
<a name="44356"/>44356:         ],
<a name="44357"/>44357: 
<a name="44358"/>44358: 
<a name="44359"/>44359:     i(&quot;start server evaluator&quot;),
<a name="44360"/>44360:     ServerInitState = #{domain   =&gt; maps:get(domain,   InitState),
<a name="44361"/>44361:                         proto    =&gt; maps:get(proto,    InitState),
<a name="44362"/>44362:                         recv     =&gt; maps:get(recv,     InitState),
<a name="44363"/>44363:                         send     =&gt; maps:get(send,     InitState),
<a name="44364"/>44364:                         buf_init =&gt; maps:get(buf_init, InitState)},
<a name="44365"/>44365:     Server = ?SEV_START(&quot;server&quot;, ServerSeq, ServerInitState),
<a name="44366"/>44366: 
<a name="44367"/>44367:     i(&quot;start client evaluator(s)&quot;),
<a name="44368"/>44368:     ClientInitState = InitState#{host =&gt; local_host()},
<a name="44369"/>44369:     Client = ?SEV_START(&quot;client&quot;, ClientSeq, ClientInitState),
<a name="44370"/>44370: 
<a name="44371"/>44371:     i(&quot;start 'tester' evaluator&quot;),
<a name="44372"/>44372:     TesterInitState = #{server =&gt; Server#ev.pid,
<a name="44373"/>44373:                         client =&gt; Client#ev.pid,
<a name="44374"/>44374:                         num    =&gt; maps:get(num, InitState)},
<a name="44375"/>44375:     Tester = ?SEV_START(&quot;tester&quot;, TesterSeq, TesterInitState),
<a name="44376"/>44376: 
<a name="44377"/>44377:     i(&quot;await evaluator&quot;),
<a name="traffic_ping_pong_send_and_receive_udp2-last_expr"/><a name="44378"/>44378: <b>    ok = ?SEV_AWAIT_FINISH</b>([Server, Client, Tester]).
<a name="44379"/>44379: 
<a name="44380"/>44380: 
<a name="44381"/>44381: 
<a name="44382"/>44382: <i>%% Server side handler process</i>
<a name="44383"/>44383: <i>%% We don't actually need a separate process for this socket, </i>
<a name="44384"/>44384: <i>%% but we do it anyway to simplify the sequence.</i>
<a name="tpp_udp_server_handler_create-0"/><a name="44385"/>44385: <b>tpp_udp_server_handler_create</b>() -&gt;
<a name="44386"/>44386:     Self = self(),
<a name="tpp_udp_server_handler_create-last_expr"/><a name="44387"/>44387: <b>    erlang:spawn</b>(fun() -&gt; tpp_udp_server_handler(Self) end).
<a name="44388"/>44388: 
<a name="tpp_udp_server_handler-1"/><a name="44389"/>44389: <b>tpp_udp_server_handler</b>(Parent) -&gt;
<a name="44390"/>44390:     tpp_udp_server_handler_init(Parent),
<a name="44391"/>44391:     {Sock, Send, Recv} = tpp_udp_handler_await_start(Parent),
<a name="44392"/>44392:     tpp_udp_handler_announce_ready(Parent, init),
<a name="44393"/>44393:     tpp_udp_handler_await_continue(Parent, recv),
<a name="44394"/>44394:     Result = tpp_udp_server_handler_msg_exchange(Sock, Send, Recv),
<a name="44395"/>44395:     tpp_udp_handler_announce_ready(Parent, recv, Result),
<a name="44396"/>44396:     Reason = tpp_udp_handler_await_terminate(Parent),
<a name="44397"/>44397:     ?SEV_IPRINT(&quot;terminating&quot;),
<a name="tpp_udp_server_handler-last_expr"/><a name="44398"/>44398: <b>    exit</b>(Reason).
<a name="44399"/>44399: 
<a name="tpp_udp_server_handler_init-1"/><a name="44400"/>44400: <b>tpp_udp_server_handler_init</b>(Parent) -&gt;
<a name="44401"/>44401:     put(sname, &quot;shandler&quot;),
<a name="44402"/>44402:     ?SEV_IPRINT(&quot;init&quot;),
<a name="44403"/>44403:     _MRef = erlang:monitor(process, Parent),
<a name="tpp_udp_server_handler_init-last_expr"/><a name="44404"/>44404:     ok.
<a name="44405"/>44405: 
<a name="tpp_udp_server_handler_msg_exchange-3"/><a name="44406"/>44406: <b>tpp_udp_server_handler_msg_exchange</b>(Sock, Send, Recv) -&gt;
<a name="tpp_udp_server_handler_msg_exchange-last_expr"/><a name="44407"/>44407: <b>    tpp_udp_server_handler_msg_exchange_loop</b>(Sock, Send, Recv,
<a name="44408"/>44408:                                              0, 0, 0, undefined).
<a name="44409"/>44409: 
<a name="tpp_udp_server_handler_msg_exchange_loop-7"/><a name="44410"/>44410: <b>tpp_udp_server_handler_msg_exchange_loop</b>(Sock, Send, Recv, 
<a name="44411"/>44411:                                          N, Sent, Received, Start) -&gt;
<a name="44412"/>44412:     %% ?SEV_IPRINT(&quot;[~w] try receive&quot;, [N]),
<a name="44413"/>44413:     %% if 
<a name="44414"/>44414:     %%     (N =:= (?TPP_SMALL_NUM-2)) -&gt; 
<a name="44415"/>44415:     %%         ?SEV_IPRINT(&quot;[~w] try receive&quot;, [N]),
<a name="44416"/>44416:     %%         socket:setopt(Sock, otp, debug, true); 
<a name="44417"/>44417:     %%     true -&gt; ok
<a name="44418"/>44418:     %% end,
<a name="tpp_udp_server_handler_msg_exchange_loop-last_expr"/><a name="44419"/>44419: <b>    try tpp_udp_recv_req</b>(Sock, Recv) of
<a name="44420"/>44420:         {ok, Msg, RecvSz, From} -&gt;
<a name="44421"/>44421:             NewStart = if (Start =:= undefined) -&gt; ?LIB:timestamp(); 
<a name="44422"/>44422:                           true -&gt; Start end,
<a name="44423"/>44423:             %% ?SEV_IPRINT(&quot;[~w] received - now try send&quot;, [N]),
<a name="44424"/>44424:             try tpp_udp_send_rep(Sock, Send, Msg, From) of
<a name="44425"/>44425:                 {ok, SendSz} -&gt;
<a name="44426"/>44426:                     tpp_udp_server_handler_msg_exchange_loop(Sock, Send, Recv,
<a name="44427"/>44427:                                                              N+1,
<a name="44428"/>44428:                                                              Sent+SendSz,
<a name="44429"/>44429:                                                              Received+RecvSz,
<a name="44430"/>44430:                                                              NewStart);
<a name="44431"/>44431:                 {error, SReason} -&gt;
<a name="44432"/>44432:                     ?SEV_EPRINT(&quot;send (~w): ~p&quot;, [N, SReason]),
<a name="44433"/>44433:                     exit({send, SReason, N})
<a name="44434"/>44434: 	    catch
<a name="44435"/>44435: 		SC:SE:SS -&gt;
<a name="44436"/>44436: 		    exit({send, {SC, SE, SS}, N})
<a name="44437"/>44437:             end;
<a name="44438"/>44438:         {error, closed} -&gt;
<a name="44439"/>44439:             ?SEV_IPRINT(&quot;closed - we are done: ~w, ~w, ~w&quot;,
<a name="44440"/>44440:                         [N, Sent, Received]),
<a name="44441"/>44441:             Stop = ?LIB:timestamp(),
<a name="44442"/>44442:             {N, Sent, Received, Start, Stop};
<a name="44443"/>44443:         {error, RReason} -&gt;
<a name="44444"/>44444:             ?SEV_EPRINT(&quot;recv (~w): ~p&quot;, [N, RReason]),
<a name="44445"/>44445:             exit({recv, RReason, N})
<a name="44446"/>44446:     catch
<a name="44447"/>44447: 	RC:RE:RS -&gt;
<a name="44448"/>44448: 	    exit({recv, {RC, RE, RS}, N})	
<a name="44449"/>44449:     end.
<a name="44450"/>44450:   
<a name="44451"/>44451: 
<a name="44452"/>44452: <i>%% The (remote) client side handler process</i>
<a name="44453"/>44453: 
<a name="tpp_udp_client_handler_create-1"/><a name="44454"/>44454: <b>tpp_udp_client_handler_create</b>(Node) -&gt;
<a name="44455"/>44455:     Self = self(),
<a name="44456"/>44456:     Fun  = fun() -&gt; put(sname, &quot;chandler&quot;), tpp_udp_client_handler(Self) end,
<a name="tpp_udp_client_handler_create-last_expr"/><a name="44457"/>44457: <b>    erlang:spawn</b>(Node, Fun).
<a name="44458"/>44458: 
<a name="tpp_udp_client_handler-1"/><a name="44459"/>44459: <b>tpp_udp_client_handler</b>(Parent) -&gt;
<a name="44460"/>44460:     tpp_udp_client_handler_init(Parent),
<a name="44461"/>44461:     ?SEV_IPRINT(&quot;await start command&quot;),
<a name="44462"/>44462:     {ServerSA, Proto, BufInit, Send, Recv} = tpp_udp_handler_await_start(Parent),
<a name="44463"/>44463:     ?SEV_IPRINT(&quot;start command with&quot;
<a name="44464"/>44464:                 &quot;~n   ServerSA: ~p&quot;, [ServerSA]),
<a name="44465"/>44465:     Domain   = maps:get(family, ServerSA),
<a name="44466"/>44466:     Sock     = tpp_udp_sock_open(Domain, Proto, BufInit),
<a name="44467"/>44467:     Path     = tpp_udp_sock_bind(Sock, Domain),
<a name="44468"/>44468:     ?SEV_IPRINT(&quot;announce ready&quot;, []),
<a name="44469"/>44469:     tpp_udp_handler_announce_ready(Parent, init),
<a name="44470"/>44470:     {InitMsg, Num} = tpp_udp_handler_await_continue(Parent, send),
<a name="44471"/>44471:     ?SEV_IPRINT(&quot;received continue with&quot;
<a name="44472"/>44472:                 &quot;~n   Num: ~p&quot;, [Num]),
<a name="44473"/>44473:     Result = tpp_udp_client_handler_msg_exchange(Sock, ServerSA, 
<a name="44474"/>44474:                                                  Send, Recv, InitMsg, Num),
<a name="44475"/>44475:     ?SEV_IPRINT(&quot;ready&quot;),
<a name="44476"/>44476:     tpp_udp_handler_announce_ready(Parent, send, Result),
<a name="44477"/>44477:     ?SEV_IPRINT(&quot;await terminate&quot;),
<a name="44478"/>44478:     Reason = tpp_udp_handler_await_terminate(Parent),
<a name="44479"/>44479:     ?SEV_IPRINT(&quot;terminate with ~p&quot;, [Reason]),
<a name="44480"/>44480:     tpp_udp_sock_close(Sock, Path),
<a name="44481"/>44481:     ?SEV_IPRINT(&quot;terminating&quot;),
<a name="tpp_udp_client_handler-last_expr"/><a name="44482"/>44482: <b>    exit</b>(Reason).
<a name="44483"/>44483: 
<a name="tpp_udp_client_handler_init-1"/><a name="44484"/>44484: <b>tpp_udp_client_handler_init</b>(Parent) -&gt;
<a name="44485"/>44485:     put(sname, &quot;chandler&quot;),
<a name="44486"/>44486:     ?SEV_IPRINT(&quot;init&quot;),
<a name="44487"/>44487:     _MRef = erlang:monitor(process, Parent),
<a name="tpp_udp_client_handler_init-last_expr"/><a name="44488"/>44488:     ok.
<a name="44489"/>44489: 
<a name="tpp_udp_client_handler_msg_exchange-6"/><a name="44490"/>44490: <b>tpp_udp_client_handler_msg_exchange</b>(Sock, ServerSA,
<a name="44491"/>44491:                                     Send, Recv, InitMsg, Num) -&gt;
<a name="44492"/>44492:     Start = ?LIB:timestamp(),
<a name="tpp_udp_client_handler_msg_exchange-last_expr"/><a name="44493"/>44493: <b>    tpp_udp_client_handler_msg_exchange_loop</b>(Sock, ServerSA,
<a name="44494"/>44494:                                              Send, Recv, InitMsg,
<a name="44495"/>44495:                                              Num, 0, 0, 0, Start).
<a name="44496"/>44496: 
<a name="tpp_udp_client_handler_msg_exchange_loop-10"/><a name="44497"/>44497: <b>tpp_udp_client_handler_msg_exchange_loop</b>(_Sock, _Dest, _Send, _Recv, _Msg,
<a name="44498"/>44498:                                          Num, Num, Sent, Received,
<a name="44499"/>44499:                                          Start) -&gt;
<a name="44500"/>44500:     Stop = ?LIB:timestamp(),
<a name="44501"/>44501:     {Sent, Received, Start, Stop};
<a name="44502"/>44502: <b>tpp_udp_client_handler_msg_exchange_loop</b>(Sock,
<a name="44503"/>44503: 					 #{family := local} = Dest,
<a name="44504"/>44504: 					 Send, Recv, Data,
<a name="44505"/>44505:                                          Num, N, Sent, Received, Start) -&gt;
<a name="44506"/>44506:     case tpp_udp_send_req(Sock, Send, Data, Dest) of
<a name="44507"/>44507:         {ok, SendSz} -&gt;
<a name="44508"/>44508:             case tpp_udp_recv_rep(Sock, Recv) of
<a name="44509"/>44509:                 {ok, NewData, RecvSz, Dest} -&gt;
<a name="44510"/>44510:                     tpp_udp_client_handler_msg_exchange_loop(Sock, Dest,
<a name="44511"/>44511:                                                              Send, Recv,
<a name="44512"/>44512:                                                              NewData, Num, N+1,
<a name="44513"/>44513:                                                              Sent+SendSz, 
<a name="44514"/>44514:                                                              Received+RecvSz, 
<a name="44515"/>44515:                                                              Start);
<a name="44516"/>44516:                 {error, RReason} -&gt;
<a name="44517"/>44517:                     ?SEV_EPRINT(&quot;recv (~w of ~w): ~p&quot;, [N, Num, RReason]),
<a name="44518"/>44518:                     exit({recv, RReason, N})
<a name="44519"/>44519:             end;
<a name="44520"/>44520:         {error, SReason} -&gt;
<a name="44521"/>44521:             ?SEV_EPRINT(&quot;send (~w of ~w): ~p&quot;, [N, Num, SReason]),
<a name="44522"/>44522:             exit({send, SReason, N})
<a name="44523"/>44523:     end;
<a name="44524"/>44524: <b>tpp_udp_client_handler_msg_exchange_loop</b>(Sock,
<a name="44525"/>44525: 					 #{addr := Addr, port := Port} = Dest0,
<a name="44526"/>44526: 					 Send, Recv, Data,
<a name="44527"/>44527:                                          Num, N, Sent, Received, Start) -&gt;
<a name="tpp_udp_client_handler_msg_exchange_loop-last_expr"/><a name="44528"/>44528: <b>    case tpp_udp_send_req</b>(Sock, Send, Data, Dest0) of
<a name="44529"/>44529:         {ok, SendSz} -&gt;
<a name="44530"/>44530:             case tpp_udp_recv_rep(Sock, Recv) of
<a name="44531"/>44531:                 {ok, NewData, RecvSz, #{addr := Addr, port := Port} = Dest1} -&gt;
<a name="44532"/>44532:                     tpp_udp_client_handler_msg_exchange_loop(Sock, Dest1,
<a name="44533"/>44533:                                                              Send, Recv,
<a name="44534"/>44534:                                                              NewData, Num, N+1,
<a name="44535"/>44535:                                                              Sent+SendSz, 
<a name="44536"/>44536:                                                              Received+RecvSz, 
<a name="44537"/>44537:                                                              Start);
<a name="44538"/>44538:                 {error, RReason} -&gt;
<a name="44539"/>44539:                     ?SEV_EPRINT(&quot;recv (~w of ~w): ~p&quot;, [N, Num, RReason]),
<a name="44540"/>44540:                     exit({recv, RReason, N})
<a name="44541"/>44541:             end;
<a name="44542"/>44542:         {error, SReason} -&gt;
<a name="44543"/>44543:             ?SEV_EPRINT(&quot;send (~w of ~w): ~p&quot;, [N, Num, SReason]),
<a name="44544"/>44544:             exit({send, SReason, N})
<a name="44545"/>44545:     end.
<a name="44546"/>44546: 
<a name="44547"/>44547: 
<a name="tpp_udp_recv_req-2"/><a name="44548"/>44548: <b>tpp_udp_recv_req</b>(Sock, Recv) -&gt;
<a name="tpp_udp_recv_req-last_expr"/><a name="44549"/>44549: <b>    tpp_udp_recv</b>(Sock, Recv, ?TPP_REQUEST).
<a name="44550"/>44550: 
<a name="tpp_udp_recv_rep-2"/><a name="44551"/>44551: <b>tpp_udp_recv_rep</b>(Sock, Recv) -&gt;
<a name="tpp_udp_recv_rep-last_expr"/><a name="44552"/>44552: <b>    tpp_udp_recv</b>(Sock, Recv, ?TPP_REPLY).
<a name="44553"/>44553: 
<a name="tpp_udp_recv-3"/><a name="44554"/>44554: <b>tpp_udp_recv</b>(Sock, Recv, Tag) -&gt;
<a name="44555"/>44555:     %% ok = socket:setopt(Sock, otp, debug, true),
<a name="tpp_udp_recv-last_expr"/><a name="44556"/>44556: <b>    try Recv</b>(Sock, 0) of
<a name="44557"/>44557:         {ok, {Source, &lt;&lt;Tag:32/integer, Sz:32/integer, Data/binary&gt;&gt; = Msg}} 
<a name="44558"/>44558:           when (Sz =:= size(Data)) -&gt;
<a name="44559"/>44559: 	    %% ok = socket:setopt(Sock, otp, debug, false),
<a name="44560"/>44560:             %% We got it all
<a name="44561"/>44561:             %% ?SEV_IPRINT(&quot;tpp_udp_recv -&gt; got all: &quot;
<a name="44562"/>44562:             %%             &quot;~n   Source:     ~p&quot;
<a name="44563"/>44563:             %%             &quot;~n   Tag:        ~p&quot;
<a name="44564"/>44564:             %%             &quot;~n   Sz:         ~p&quot;
<a name="44565"/>44565:             %%             &quot;~n   size(Data): ~p&quot;,
<a name="44566"/>44566:             %%             [Source, Tag, Sz, size(Data)]),
<a name="44567"/>44567:             {ok, Data, size(Msg), Source};
<a name="44568"/>44568:         {ok, {_Source, &lt;&lt;Tag:32/integer, Sz:32/integer, Data/binary&gt;&gt;}} -&gt;
<a name="44569"/>44569: 	    %% ok = socket:setopt(Sock, otp, debug, false),
<a name="44570"/>44570:             {error, {invalid_msg, Sz, size(Data)}};
<a name="44571"/>44571:         {ok, {_, &lt;&lt;Tag:32/integer, _/binary&gt;&gt;}} -&gt;
<a name="44572"/>44572: 	    %% ok = socket:setopt(Sock, otp, debug, false),
<a name="44573"/>44573:             {error, {invalid_msg_tag, Tag}};
<a name="44574"/>44574:         {error, _} = ERROR -&gt;
<a name="44575"/>44575: 	    %% ok = socket:setopt(Sock, otp, debug, false),
<a name="44576"/>44576:             ERROR
<a name="44577"/>44577:     catch
<a name="44578"/>44578: 	C:E:S -&gt;
<a name="44579"/>44579: 	    {error, {caught, C, E, S}}
<a name="44580"/>44580:     end.
<a name="44581"/>44581: 
<a name="tpp_udp_send_req-4"/><a name="44582"/>44582: <b>tpp_udp_send_req</b>(Sock, Send, Data, Dest) -&gt;
<a name="tpp_udp_send_req-last_expr"/><a name="44583"/>44583: <b>    tpp_udp_send</b>(Sock, Send, ?TPP_REQUEST, Data, Dest).
<a name="44584"/>44584: 
<a name="tpp_udp_send_rep-4"/><a name="44585"/>44585: <b>tpp_udp_send_rep</b>(Sock, Send, Data, Dest) -&gt;
<a name="tpp_udp_send_rep-last_expr"/><a name="44586"/>44586: <b>    tpp_udp_send</b>(Sock, Send, ?TPP_REPLY, Data, Dest).
<a name="44587"/>44587: 
<a name="tpp_udp_send-5"/><a name="44588"/>44588: <b>tpp_udp_send</b>(Sock, Send, Tag, Data, Dest) -&gt;
<a name="44589"/>44589:     DataSz = size(Data),
<a name="44590"/>44590:     Msg    = &lt;&lt;Tag:32/integer, DataSz:32/integer, Data/binary&gt;&gt;,
<a name="tpp_udp_send-last_expr"/><a name="44591"/>44591: <b>    tpp_udp_send_msg</b>(Sock, Send, Msg, Dest, 0).
<a name="44592"/>44592: 
<a name="tpp_udp_send_msg-5"/><a name="44593"/>44593: <b>tpp_udp_send_msg</b>(Sock, Send, Msg, Dest, AccSz) when is_binary(Msg) -&gt;
<a name="tpp_udp_send_msg-last_expr"/><a name="44594"/>44594: <b>    case Send</b>(Sock, Msg, Dest) of
<a name="44595"/>44595:         ok -&gt;
<a name="44596"/>44596:             {ok, AccSz+size(Msg)};
<a name="44597"/>44597:         {ok, Rest} -&gt; % This is an IOVec
<a name="44598"/>44598:             RestBin = list_to_binary(Rest),
<a name="44599"/>44599:             tpp_udp_send_msg(Sock, Send, RestBin, Dest,
<a name="44600"/>44600:                              AccSz+(size(Msg)-size(RestBin)));
<a name="44601"/>44601:         {error, _} = ERROR -&gt;
<a name="44602"/>44602:             ERROR
<a name="44603"/>44603:     end.
<a name="44604"/>44604:     
<a name="44605"/>44605: 
<a name="tpp_udp_handler_await_start-1"/><a name="44606"/>44606: <b>tpp_udp_handler_await_start</b>(Parent) -&gt;
<a name="44607"/>44607:     ?SEV_IPRINT(&quot;await start&quot;),
<a name="tpp_udp_handler_await_start-last_expr"/><a name="44608"/>44608: <b>    ?SEV_AWAIT_START</b>(Parent).
<a name="44609"/>44609: 
<a name="tpp_udp_handler_announce_ready-2"/><a name="44610"/>44610: <b>tpp_udp_handler_announce_ready</b>(Parent, Slogan) -&gt;
<a name="44611"/>44611:     ?SEV_IPRINT(&quot;announce ready (~p)&quot;, [Slogan]),
<a name="tpp_udp_handler_announce_ready-last_expr"/><a name="44612"/>44612: <b>    ?SEV_ANNOUNCE_READY</b>(Parent, Slogan).
<a name="tpp_udp_handler_announce_ready-3"/><a name="44613"/>44613: <b>tpp_udp_handler_announce_ready</b>(Parent, Slogan, Extra) -&gt;
<a name="44614"/>44614:     ?SEV_IPRINT(&quot;announce ready (~p)&quot;, [Slogan]),
<a name="tpp_udp_handler_announce_ready-last_expr"/><a name="44615"/>44615: <b>    ?SEV_ANNOUNCE_READY</b>(Parent, Slogan, Extra).
<a name="44616"/>44616: 
<a name="tpp_udp_handler_await_continue-2"/><a name="44617"/>44617: <b>tpp_udp_handler_await_continue</b>(Parent, Slogan) -&gt;
<a name="44618"/>44618:     ?SEV_IPRINT(&quot;await continue (~p)&quot;, [Slogan]),
<a name="tpp_udp_handler_await_continue-last_expr"/><a name="44619"/>44619: <b>    case ?SEV_AWAIT_CONTINUE</b>(Parent, parent, Slogan) of
<a name="44620"/>44620:         ok -&gt;
<a name="44621"/>44621:             ?SEV_IPRINT(&quot;continue (~p): ok&quot;, [Slogan]),
<a name="44622"/>44622:             ok;
<a name="44623"/>44623:         {ok, Data} -&gt;
<a name="44624"/>44624:             ?SEV_IPRINT(&quot;continue (~p): ok with data&quot;, [Slogan]),
<a name="44625"/>44625:             Data;
<a name="44626"/>44626:         {error, Reason} -&gt;
<a name="44627"/>44627:             ?SEV_EPRINT(&quot;continue (~p): error&quot;
<a name="44628"/>44628:                         &quot;~n   ~p&quot;, [Slogan, Reason]),
<a name="44629"/>44629:             exit({continue, Slogan, Reason})
<a name="44630"/>44630:     end.
<a name="44631"/>44631: 
<a name="tpp_udp_handler_await_terminate-1"/><a name="44632"/>44632: <b>tpp_udp_handler_await_terminate</b>(Parent) -&gt;
<a name="44633"/>44633:     ?SEV_IPRINT(&quot;await terminate&quot;),
<a name="tpp_udp_handler_await_terminate-last_expr"/><a name="44634"/>44634: <b>    case ?SEV_AWAIT_TERMINATE</b>(Parent, parent) of
<a name="44635"/>44635:         ok -&gt;
<a name="44636"/>44636:             ok;
<a name="44637"/>44637:         {error, Reason} -&gt;
<a name="44638"/>44638:             Reason
<a name="44639"/>44639:     end.
<a name="44640"/>44640: 
<a name="44641"/>44641: 
<a name="tpp_udp_sock_open-3"/><a name="44642"/>44642: <b>tpp_udp_sock_open</b>(Domain, Proto, BufInit) -&gt;
<a name="tpp_udp_sock_open-last_expr"/><a name="44643"/>44643: <b>    case socket:open</b>(Domain, dgram, Proto) of
<a name="44644"/>44644:         {ok, Sock} -&gt;
<a name="44645"/>44645:             ok = BufInit(Sock),
<a name="44646"/>44646:             Sock;
<a name="44647"/>44647:         {error, Reason} -&gt;
<a name="44648"/>44648:             exit({open_failed, Reason})
<a name="44649"/>44649:     end.
<a name="44650"/>44650: 
<a name="tpp_udp_sock_bind-2"/><a name="44651"/>44651: <b>tpp_udp_sock_bind</b>(Sock, Domain) -&gt;
<a name="44652"/>44652:     LSA = which_local_socket_addr(Domain),
<a name="tpp_udp_sock_bind-last_expr"/><a name="44653"/>44653: <b>    case socket:bind</b>(Sock, LSA) of
<a name="44654"/>44654:         ok -&gt;
<a name="44655"/>44655:             ok;
<a name="44656"/>44656:         {error, Reason} -&gt;
<a name="44657"/>44657:             exit({bind, Reason})
<a name="44658"/>44658:     end.
<a name="44659"/>44659: 
<a name="tpp_udp_sock_close-2"/><a name="44660"/>44660: <b>tpp_udp_sock_close</b>(Sock, Path) -&gt;
<a name="tpp_udp_sock_close-last_expr"/><a name="44661"/>44661: <b>    case socket:close</b>(Sock) of
<a name="44662"/>44662:         ok -&gt;
<a name="44663"/>44663:             unlink_path(Path),
<a name="44664"/>44664:             ok;
<a name="44665"/>44665:         {error, Reason} -&gt;
<a name="44666"/>44666:             ?SEV_EPRINT(&quot;Failed closing socket: &quot;
<a name="44667"/>44667:                         &quot;~n   ~p&quot;, [Reason]),
<a name="44668"/>44668:             unlink_path(Path),
<a name="44669"/>44669:             {error, {close, Reason}}
<a name="44670"/>44670:     end.
<a name="44671"/>44671: 
<a name="44672"/>44672: 
<a name="44673"/>44673: 
<a name="44674"/>44674: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="44675"/>44675: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="44676"/>44676: <i>%%                                                                     %%</i>
<a name="44677"/>44677: <i>%%                           TIME TEST                                 %%</i>
<a name="44678"/>44678: <i>%%                                                                     %%</i>
<a name="44679"/>44679: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="44680"/>44680: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="44681"/>44681: 
<a name="44682"/>44682: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="44683"/>44683: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="44684"/>44684: <i>%% ping-pong like test case.</i>
<a name="44685"/>44685: <i>%% Server:       Transport = gen_tcp, Active = false</i>
<a name="44686"/>44686: <i>%% Client:       Transport = gen_tcp, Active = false</i>
<a name="44687"/>44687: <i>%% Message Size: small (=1)</i>
<a name="44688"/>44688: <i>%% Domain:       inet</i>
<a name="44689"/>44689: <i>%%</i>
<a name="44690"/>44690: 
<a name="ttest_sgenf_cgenf_small_tcp4-1"/><a name="44691"/>44691: <b>ttest_sgenf_cgenf_small_tcp4</b>(Config) when is_list(Config) -&gt;
<a name="44692"/>44692:     Runtime        = which_ttest_runtime(Config),
<a name="ttest_sgenf_cgenf_small_tcp4-last_expr"/><a name="44693"/>44693: <b>    ttest_tcp</b>(ttest_sgenf_cgenf_small_tcp4,
<a name="44694"/>44694:               Runtime,
<a name="44695"/>44695:               inet,
<a name="44696"/>44696:               gen, false,
<a name="44697"/>44697:               gen, false,
<a name="44698"/>44698:               1, ttest_small_max_outstanding(Config)).
<a name="44699"/>44699: 
<a name="44700"/>44700: 
<a name="44701"/>44701: 
<a name="44702"/>44702: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="44703"/>44703: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="44704"/>44704: <i>%% ping-pong like test case.</i>
<a name="44705"/>44705: <i>%% Server:       Transport = gen_tcp, Active = false</i>
<a name="44706"/>44706: <i>%% Client:       Transport = gen_tcp, Active = false</i>
<a name="44707"/>44707: <i>%% Message Size: small (=1)</i>
<a name="44708"/>44708: <i>%% Domain:       inet6</i>
<a name="44709"/>44709: <i>%% </i>
<a name="44710"/>44710: 
<a name="ttest_sgenf_cgenf_small_tcp6-1"/><a name="44711"/>44711: <b>ttest_sgenf_cgenf_small_tcp6</b>(Config) when is_list(Config) -&gt;
<a name="44712"/>44712:     Runtime = which_ttest_runtime(Config),
<a name="ttest_sgenf_cgenf_small_tcp6-last_expr"/><a name="44713"/>44713: <b>    ttest_tcp</b>(ttest_sgenf_cgenf_small_tcp6,
<a name="44714"/>44714:               Runtime,
<a name="44715"/>44715:               inet6,
<a name="44716"/>44716:               gen, false,
<a name="44717"/>44717:               gen, false,
<a name="44718"/>44718:               1, ttest_small_max_outstanding(Config)).
<a name="44719"/>44719: 
<a name="44720"/>44720: 
<a name="44721"/>44721: 
<a name="44722"/>44722: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="44723"/>44723: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="44724"/>44724: <i>%% ping-pong like test case.</i>
<a name="44725"/>44725: <i>%% Server:       Transport = gen_tcp, Active = false</i>
<a name="44726"/>44726: <i>%% Client:       Transport = gen_tcp, Active = false</i>
<a name="44727"/>44727: <i>%% Message Size: medium (=2)</i>
<a name="44728"/>44728: <i>%% Domain:       inet</i>
<a name="44729"/>44729: <i>%%</i>
<a name="44730"/>44730: 
<a name="ttest_sgenf_cgenf_medium_tcp4-1"/><a name="44731"/>44731: <b>ttest_sgenf_cgenf_medium_tcp4</b>(Config) when is_list(Config) -&gt;
<a name="44732"/>44732:     Runtime = which_ttest_runtime(Config),
<a name="ttest_sgenf_cgenf_medium_tcp4-last_expr"/><a name="44733"/>44733: <b>    ttest_tcp</b>(ttest_sgenf_cgenf_medium_tcp4,
<a name="44734"/>44734:               Runtime,
<a name="44735"/>44735:               inet,
<a name="44736"/>44736:               gen, false,
<a name="44737"/>44737:               gen, false,
<a name="44738"/>44738:               2, ttest_medium_max_outstanding(Config)).
<a name="44739"/>44739: 
<a name="44740"/>44740: 
<a name="44741"/>44741: 
<a name="44742"/>44742: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="44743"/>44743: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="44744"/>44744: <i>%% ping-pong like test case.</i>
<a name="44745"/>44745: <i>%% Server:       Transport = gen_tcp, Active = false</i>
<a name="44746"/>44746: <i>%% Client:       Transport = gen_tcp, Active = false</i>
<a name="44747"/>44747: <i>%% Message Size: medium (=2)</i>
<a name="44748"/>44748: <i>%% Domain:       inet6</i>
<a name="44749"/>44749: <i>%% </i>
<a name="44750"/>44750: 
<a name="ttest_sgenf_cgenf_medium_tcp6-1"/><a name="44751"/>44751: <b>ttest_sgenf_cgenf_medium_tcp6</b>(Config) when is_list(Config) -&gt;
<a name="44752"/>44752:     Runtime = which_ttest_runtime(Config),
<a name="ttest_sgenf_cgenf_medium_tcp6-last_expr"/><a name="44753"/>44753: <b>    ttest_tcp</b>(ttest_sgenf_cgenf_medium_tcp6,
<a name="44754"/>44754:               Runtime,
<a name="44755"/>44755:               inet6,
<a name="44756"/>44756:               gen, false,
<a name="44757"/>44757:               gen, false,
<a name="44758"/>44758:               2, ttest_medium_max_outstanding(Config)).
<a name="44759"/>44759: 
<a name="44760"/>44760: 
<a name="44761"/>44761: 
<a name="44762"/>44762: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="44763"/>44763: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="44764"/>44764: <i>%% ping-pong like test case.</i>
<a name="44765"/>44765: <i>%% Server:       Transport = gen_tcp, Active = false</i>
<a name="44766"/>44766: <i>%% Client:       Transport = gen_tcp, Active = false</i>
<a name="44767"/>44767: <i>%% Message Size: large (=3)</i>
<a name="44768"/>44768: <i>%% Domain:       inet</i>
<a name="44769"/>44769: <i>%%</i>
<a name="44770"/>44770: 
<a name="ttest_sgenf_cgenf_large_tcp4-1"/><a name="44771"/>44771: <b>ttest_sgenf_cgenf_large_tcp4</b>(Config) when is_list(Config) -&gt;
<a name="44772"/>44772:     Runtime = which_ttest_runtime(Config),
<a name="ttest_sgenf_cgenf_large_tcp4-last_expr"/><a name="44773"/>44773: <b>    ttest_tcp</b>(ttest_sgenf_cgenf_large_tcp4,
<a name="44774"/>44774:               Runtime,
<a name="44775"/>44775:               inet,
<a name="44776"/>44776:               gen, false,
<a name="44777"/>44777:               gen, false,
<a name="44778"/>44778:               3, ttest_large_max_outstanding(Config)).
<a name="44779"/>44779: 
<a name="44780"/>44780: 
<a name="44781"/>44781: 
<a name="44782"/>44782: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="44783"/>44783: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="44784"/>44784: <i>%% ping-pong like test case.</i>
<a name="44785"/>44785: <i>%% Server:       Transport = gen_tcp, Active = false</i>
<a name="44786"/>44786: <i>%% Client:       Transport = gen_tcp, Active = false</i>
<a name="44787"/>44787: <i>%% Message Size: large (=3)</i>
<a name="44788"/>44788: <i>%% Domain:       inet6</i>
<a name="44789"/>44789: <i>%% </i>
<a name="44790"/>44790: 
<a name="ttest_sgenf_cgenf_large_tcp6-1"/><a name="44791"/>44791: <b>ttest_sgenf_cgenf_large_tcp6</b>(Config) when is_list(Config) -&gt;
<a name="44792"/>44792:     Runtime = which_ttest_runtime(Config),
<a name="ttest_sgenf_cgenf_large_tcp6-last_expr"/><a name="44793"/>44793: <b>    ttest_tcp</b>(ttest_sgenf_cgenf_large_tcp6,
<a name="44794"/>44794:               Runtime,
<a name="44795"/>44795:               inet6,
<a name="44796"/>44796:               gen, false,
<a name="44797"/>44797:               gen, false,
<a name="44798"/>44798:               3, ttest_large_max_outstanding(Config)).
<a name="44799"/>44799: 
<a name="44800"/>44800: 
<a name="44801"/>44801: 
<a name="44802"/>44802: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="44803"/>44803: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="44804"/>44804: <i>%% ping-pong like test case.</i>
<a name="44805"/>44805: <i>%% Server:       Transport = gen_tcp, Active = false</i>
<a name="44806"/>44806: <i>%% Client:       Transport = gen_tcp, Active = once</i>
<a name="44807"/>44807: <i>%% Message Size: small (=1)</i>
<a name="44808"/>44808: <i>%% Domain:       inet</i>
<a name="44809"/>44809: <i>%%</i>
<a name="44810"/>44810: 
<a name="ttest_sgenf_cgeno_small_tcp4-1"/><a name="44811"/>44811: <b>ttest_sgenf_cgeno_small_tcp4</b>(Config) when is_list(Config) -&gt;
<a name="44812"/>44812:     Runtime = which_ttest_runtime(Config),
<a name="ttest_sgenf_cgeno_small_tcp4-last_expr"/><a name="44813"/>44813: <b>    ttest_tcp</b>(ttest_sgenf_cgeno_small_tcp4,
<a name="44814"/>44814:               Runtime,
<a name="44815"/>44815:               inet,
<a name="44816"/>44816:               gen, false,
<a name="44817"/>44817:               gen, once,
<a name="44818"/>44818:               1, ttest_small_max_outstanding(Config)).
<a name="44819"/>44819: 
<a name="44820"/>44820: 
<a name="44821"/>44821: 
<a name="44822"/>44822: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="44823"/>44823: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="44824"/>44824: <i>%% ping-pong like test case.</i>
<a name="44825"/>44825: <i>%% Server:       Transport = gen_tcp, Active = false</i>
<a name="44826"/>44826: <i>%% Client:       Transport = gen_tcp, Active = once</i>
<a name="44827"/>44827: <i>%% Message Size: small (=1)</i>
<a name="44828"/>44828: <i>%% Domain:       inet6</i>
<a name="44829"/>44829: <i>%% </i>
<a name="44830"/>44830: 
<a name="ttest_sgenf_cgeno_small_tcp6-1"/><a name="44831"/>44831: <b>ttest_sgenf_cgeno_small_tcp6</b>(Config) when is_list(Config) -&gt;
<a name="44832"/>44832:     Runtime = which_ttest_runtime(Config),
<a name="ttest_sgenf_cgeno_small_tcp6-last_expr"/><a name="44833"/>44833: <b>    ttest_tcp</b>(ttest_sgenf_cgeno_small_tcp6,
<a name="44834"/>44834:               Runtime,
<a name="44835"/>44835:               inet6,
<a name="44836"/>44836:               gen, false,
<a name="44837"/>44837:               gen, once,
<a name="44838"/>44838:               1, ttest_small_max_outstanding(Config)).
<a name="44839"/>44839: 
<a name="44840"/>44840: 
<a name="44841"/>44841: 
<a name="44842"/>44842: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="44843"/>44843: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="44844"/>44844: <i>%% ping-pong like test case.</i>
<a name="44845"/>44845: <i>%% Server:       Transport = gen_tcp, Active = false</i>
<a name="44846"/>44846: <i>%% Client:       Transport = gen_tcp, Active = once</i>
<a name="44847"/>44847: <i>%% Message Size: medium (=2)</i>
<a name="44848"/>44848: <i>%% Domain:       inet</i>
<a name="44849"/>44849: <i>%%</i>
<a name="44850"/>44850: 
<a name="ttest_sgenf_cgeno_medium_tcp4-1"/><a name="44851"/>44851: <b>ttest_sgenf_cgeno_medium_tcp4</b>(Config) when is_list(Config) -&gt;
<a name="44852"/>44852:     Runtime = which_ttest_runtime(Config),
<a name="ttest_sgenf_cgeno_medium_tcp4-last_expr"/><a name="44853"/>44853: <b>    ttest_tcp</b>(ttest_sgenf_cgeno_medium_tcp4,
<a name="44854"/>44854:               Runtime,
<a name="44855"/>44855:               inet,
<a name="44856"/>44856:               gen, false,
<a name="44857"/>44857:               gen, once,
<a name="44858"/>44858:               2, ttest_medium_max_outstanding(Config)).
<a name="44859"/>44859: 
<a name="44860"/>44860: 
<a name="44861"/>44861: 
<a name="44862"/>44862: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="44863"/>44863: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="44864"/>44864: <i>%% ping-pong like test case.</i>
<a name="44865"/>44865: <i>%% Server:       Transport = gen_tcp, Active = false</i>
<a name="44866"/>44866: <i>%% Client:       Transport = gen_tcp, Active = once</i>
<a name="44867"/>44867: <i>%% Message Size: medium (=2)</i>
<a name="44868"/>44868: <i>%% Domain:       inet6</i>
<a name="44869"/>44869: <i>%% </i>
<a name="44870"/>44870: 
<a name="ttest_sgenf_cgeno_medium_tcp6-1"/><a name="44871"/>44871: <b>ttest_sgenf_cgeno_medium_tcp6</b>(Config) when is_list(Config) -&gt;
<a name="44872"/>44872:     Runtime = which_ttest_runtime(Config),
<a name="ttest_sgenf_cgeno_medium_tcp6-last_expr"/><a name="44873"/>44873: <b>    ttest_tcp</b>(ttest_sgenf_cgeno_medium_tcp6,
<a name="44874"/>44874:               Runtime,
<a name="44875"/>44875:               inet6,
<a name="44876"/>44876:               gen, false,
<a name="44877"/>44877:               gen, once,
<a name="44878"/>44878:               2, ttest_medium_max_outstanding(Config)).
<a name="44879"/>44879: 
<a name="44880"/>44880: 
<a name="44881"/>44881: 
<a name="44882"/>44882: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="44883"/>44883: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="44884"/>44884: <i>%% ping-pong like test case.</i>
<a name="44885"/>44885: <i>%% Server:       Transport = gen_tcp, Active = false</i>
<a name="44886"/>44886: <i>%% Client:       Transport = gen_tcp, Active = once</i>
<a name="44887"/>44887: <i>%% Message Size: large (=3)</i>
<a name="44888"/>44888: <i>%% Domain:       inet</i>
<a name="44889"/>44889: <i>%%</i>
<a name="44890"/>44890: 
<a name="ttest_sgenf_cgeno_large_tcp4-1"/><a name="44891"/>44891: <b>ttest_sgenf_cgeno_large_tcp4</b>(Config) when is_list(Config) -&gt;
<a name="44892"/>44892:     Runtime = which_ttest_runtime(Config),
<a name="ttest_sgenf_cgeno_large_tcp4-last_expr"/><a name="44893"/>44893: <b>    ttest_tcp</b>(ttest_sgenf_cgeno_large_tcp4,
<a name="44894"/>44894:               Runtime,
<a name="44895"/>44895:               inet,
<a name="44896"/>44896:               gen, false,
<a name="44897"/>44897:               gen, once,
<a name="44898"/>44898:               3, ttest_large_max_outstanding(Config)).
<a name="44899"/>44899: 
<a name="44900"/>44900: 
<a name="44901"/>44901: 
<a name="44902"/>44902: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="44903"/>44903: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="44904"/>44904: <i>%% ping-pong like test case.</i>
<a name="44905"/>44905: <i>%% Server:       Transport = gen_tcp, Active = false</i>
<a name="44906"/>44906: <i>%% Client:       Transport = gen_tcp, Active = once</i>
<a name="44907"/>44907: <i>%% Message Size: large (=3)</i>
<a name="44908"/>44908: <i>%% Domain:       inet6</i>
<a name="44909"/>44909: <i>%% </i>
<a name="44910"/>44910: 
<a name="ttest_sgenf_cgeno_large_tcp6-1"/><a name="44911"/>44911: <b>ttest_sgenf_cgeno_large_tcp6</b>(Config) when is_list(Config) -&gt;
<a name="44912"/>44912:     Runtime = which_ttest_runtime(Config),
<a name="ttest_sgenf_cgeno_large_tcp6-last_expr"/><a name="44913"/>44913: <b>    ttest_tcp</b>(ttest_sgenf_cgeno_large_tcp6,
<a name="44914"/>44914:               Runtime,
<a name="44915"/>44915:               inet6,
<a name="44916"/>44916:               gen, false,
<a name="44917"/>44917:               gen, once,
<a name="44918"/>44918:               3, ttest_large_max_outstanding(Config)).
<a name="44919"/>44919: 
<a name="44920"/>44920: 
<a name="44921"/>44921: 
<a name="44922"/>44922: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="44923"/>44923: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="44924"/>44924: <i>%% ping-pong like test case.</i>
<a name="44925"/>44925: <i>%% Server:       Transport = gen_tcp, Active = false</i>
<a name="44926"/>44926: <i>%% Client:       Transport = gen_tcp, Active = true</i>
<a name="44927"/>44927: <i>%% Message Size: small (=1)</i>
<a name="44928"/>44928: <i>%% Domain:       inet</i>
<a name="44929"/>44929: <i>%%</i>
<a name="44930"/>44930: 
<a name="ttest_sgenf_cgent_small_tcp4-1"/><a name="44931"/>44931: <b>ttest_sgenf_cgent_small_tcp4</b>(Config) when is_list(Config) -&gt;
<a name="44932"/>44932:     Runtime = which_ttest_runtime(Config),
<a name="ttest_sgenf_cgent_small_tcp4-last_expr"/><a name="44933"/>44933: <b>    ttest_tcp</b>(ttest_sgenf_cgent_small_tcp4,
<a name="44934"/>44934:               Runtime,
<a name="44935"/>44935:               inet,
<a name="44936"/>44936:               gen, false,
<a name="44937"/>44937:               gen, true,
<a name="44938"/>44938:               1, ttest_small_max_outstanding(Config)).
<a name="44939"/>44939: 
<a name="44940"/>44940: 
<a name="44941"/>44941: 
<a name="44942"/>44942: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="44943"/>44943: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="44944"/>44944: <i>%% ping-pong like test case.</i>
<a name="44945"/>44945: <i>%% Server:       Transport = gen_tcp, Active = false</i>
<a name="44946"/>44946: <i>%% Client:       Transport = gen_tcp, Active = true</i>
<a name="44947"/>44947: <i>%% Message Size: small (=1)</i>
<a name="44948"/>44948: <i>%% Domain:       inet6</i>
<a name="44949"/>44949: <i>%% </i>
<a name="44950"/>44950: 
<a name="ttest_sgenf_cgent_small_tcp6-1"/><a name="44951"/>44951: <b>ttest_sgenf_cgent_small_tcp6</b>(Config) when is_list(Config) -&gt;
<a name="44952"/>44952:     Runtime = which_ttest_runtime(Config),
<a name="ttest_sgenf_cgent_small_tcp6-last_expr"/><a name="44953"/>44953: <b>    ttest_tcp</b>(ttest_sgenf_cgeno_small_tcp6,
<a name="44954"/>44954:               Runtime,
<a name="44955"/>44955:               inet6,
<a name="44956"/>44956:               gen, false,
<a name="44957"/>44957:               gen, true,
<a name="44958"/>44958:               1, ttest_small_max_outstanding(Config)).
<a name="44959"/>44959: 
<a name="44960"/>44960: 
<a name="44961"/>44961: 
<a name="44962"/>44962: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="44963"/>44963: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="44964"/>44964: <i>%% ping-pong like test case.</i>
<a name="44965"/>44965: <i>%% Server:       Transport = gen_tcp, Active = false</i>
<a name="44966"/>44966: <i>%% Client:       Transport = gen_tcp, Active = true</i>
<a name="44967"/>44967: <i>%% Message Size: medium (=2)</i>
<a name="44968"/>44968: <i>%% Domain:       inet</i>
<a name="44969"/>44969: <i>%%</i>
<a name="44970"/>44970: 
<a name="ttest_sgenf_cgent_medium_tcp4-1"/><a name="44971"/>44971: <b>ttest_sgenf_cgent_medium_tcp4</b>(Config) when is_list(Config) -&gt;
<a name="44972"/>44972:     Runtime = which_ttest_runtime(Config),
<a name="ttest_sgenf_cgent_medium_tcp4-last_expr"/><a name="44973"/>44973: <b>    ttest_tcp</b>(ttest_sgenf_cgent_medium_tcp4,
<a name="44974"/>44974:               Runtime,
<a name="44975"/>44975:               inet,
<a name="44976"/>44976:               gen, false,
<a name="44977"/>44977:               gen, true,
<a name="44978"/>44978:               2, ttest_medium_max_outstanding(Config)).
<a name="44979"/>44979: 
<a name="44980"/>44980: 
<a name="44981"/>44981: 
<a name="44982"/>44982: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="44983"/>44983: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="44984"/>44984: <i>%% ping-pong like test case.</i>
<a name="44985"/>44985: <i>%% Server:       Transport = gen_tcp, Active = false</i>
<a name="44986"/>44986: <i>%% Client:       Transport = gen_tcp, Active = true</i>
<a name="44987"/>44987: <i>%% Message Size: medium (=2)</i>
<a name="44988"/>44988: <i>%% Domain:       inet6</i>
<a name="44989"/>44989: <i>%% </i>
<a name="44990"/>44990: 
<a name="ttest_sgenf_cgent_medium_tcp6-1"/><a name="44991"/>44991: <b>ttest_sgenf_cgent_medium_tcp6</b>(Config) when is_list(Config) -&gt;
<a name="44992"/>44992:     Runtime = which_ttest_runtime(Config),
<a name="ttest_sgenf_cgent_medium_tcp6-last_expr"/><a name="44993"/>44993: <b>    ttest_tcp</b>(ttest_sgenf_cgent_medium_tcp6,
<a name="44994"/>44994:               Runtime,
<a name="44995"/>44995:               inet6,
<a name="44996"/>44996:               gen, false,
<a name="44997"/>44997:               gen, true,
<a name="44998"/>44998:               2, ttest_medium_max_outstanding(Config)).
<a name="44999"/>44999: 
<a name="45000"/>45000: 
<a name="45001"/>45001: 
<a name="45002"/>45002: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="45003"/>45003: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="45004"/>45004: <i>%% ping-pong like test case.</i>
<a name="45005"/>45005: <i>%% Server:       Transport = gen_tcp, Active = false</i>
<a name="45006"/>45006: <i>%% Client:       Transport = gen_tcp, Active = true</i>
<a name="45007"/>45007: <i>%% Message Size: large (=3)</i>
<a name="45008"/>45008: <i>%% Domain:       inet</i>
<a name="45009"/>45009: <i>%%</i>
<a name="45010"/>45010: 
<a name="ttest_sgenf_cgent_large_tcp4-1"/><a name="45011"/>45011: <b>ttest_sgenf_cgent_large_tcp4</b>(Config) when is_list(Config) -&gt;
<a name="45012"/>45012:     Runtime = which_ttest_runtime(Config),
<a name="ttest_sgenf_cgent_large_tcp4-last_expr"/><a name="45013"/>45013: <b>    ttest_tcp</b>(ttest_sgenf_cgent_large_tcp4,
<a name="45014"/>45014:               Runtime,
<a name="45015"/>45015:               inet,
<a name="45016"/>45016:               gen, false,
<a name="45017"/>45017:               gen, true,
<a name="45018"/>45018:               3, ttest_large_max_outstanding(Config)).
<a name="45019"/>45019: 
<a name="45020"/>45020: 
<a name="45021"/>45021: 
<a name="45022"/>45022: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="45023"/>45023: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="45024"/>45024: <i>%% ping-pong like test case.</i>
<a name="45025"/>45025: <i>%% Server:       Transport = gen_tcp, Active = false</i>
<a name="45026"/>45026: <i>%% Client:       Transport = gen_tcp, Active = true</i>
<a name="45027"/>45027: <i>%% Message Size: large (=3)</i>
<a name="45028"/>45028: <i>%% Domain:       inet6</i>
<a name="45029"/>45029: <i>%% </i>
<a name="45030"/>45030: 
<a name="ttest_sgenf_cgent_large_tcp6-1"/><a name="45031"/>45031: <b>ttest_sgenf_cgent_large_tcp6</b>(Config) when is_list(Config) -&gt;
<a name="45032"/>45032:     Runtime = which_ttest_runtime(Config),
<a name="ttest_sgenf_cgent_large_tcp6-last_expr"/><a name="45033"/>45033: <b>    ttest_tcp</b>(ttest_sgenf_cgent_large_tcp6,
<a name="45034"/>45034:               Runtime,
<a name="45035"/>45035:               inet6,
<a name="45036"/>45036:               gen, false,
<a name="45037"/>45037:               gen, true,
<a name="45038"/>45038:               3, ttest_large_max_outstanding(Config)).
<a name="45039"/>45039: 
<a name="45040"/>45040: 
<a name="45041"/>45041: 
<a name="45042"/>45042: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="45043"/>45043: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="45044"/>45044: <i>%% ping-pong like test case.</i>
<a name="45045"/>45045: <i>%% Server:       Transport = gen_tcp, Active = false</i>
<a name="45046"/>45046: <i>%% Client:       Transport = socket(tcp), Active = false</i>
<a name="45047"/>45047: <i>%% Message Size: small (=1)</i>
<a name="45048"/>45048: <i>%% Domain:       inet</i>
<a name="45049"/>45049: <i>%%</i>
<a name="45050"/>45050: 
<a name="ttest_sgenf_csockf_small_tcp4-1"/><a name="45051"/>45051: <b>ttest_sgenf_csockf_small_tcp4</b>(Config) when is_list(Config) -&gt;
<a name="45052"/>45052:     Runtime = which_ttest_runtime(Config),
<a name="ttest_sgenf_csockf_small_tcp4-last_expr"/><a name="45053"/>45053: <b>    ttest_tcp</b>(ttest_sgenf_csockf_small_tcp4,
<a name="45054"/>45054:               Runtime,
<a name="45055"/>45055:               inet,
<a name="45056"/>45056:               gen, false,
<a name="45057"/>45057:               sock, false,
<a name="45058"/>45058:               1, ttest_small_max_outstanding(Config)).
<a name="45059"/>45059: 
<a name="45060"/>45060: 
<a name="45061"/>45061: 
<a name="45062"/>45062: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="45063"/>45063: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="45064"/>45064: <i>%% ping-pong like test case.</i>
<a name="45065"/>45065: <i>%% Server:       Transport = gen_tcp, Active = false</i>
<a name="45066"/>45066: <i>%% Client:       Transport = socket(tcp), Active = false</i>
<a name="45067"/>45067: <i>%% Message Size: small (=1)</i>
<a name="45068"/>45068: <i>%% Domain:       inet6</i>
<a name="45069"/>45069: <i>%% </i>
<a name="45070"/>45070: 
<a name="ttest_sgenf_csockf_small_tcp6-1"/><a name="45071"/>45071: <b>ttest_sgenf_csockf_small_tcp6</b>(Config) when is_list(Config) -&gt;
<a name="45072"/>45072:     Runtime = which_ttest_runtime(Config),
<a name="ttest_sgenf_csockf_small_tcp6-last_expr"/><a name="45073"/>45073: <b>    ttest_tcp</b>(ttest_sgenf_csockf_small_tcp6,
<a name="45074"/>45074:               Runtime,
<a name="45075"/>45075:               inet6,
<a name="45076"/>45076:               gen, false,
<a name="45077"/>45077:               sock, false,
<a name="45078"/>45078:               1, ttest_small_max_outstanding(Config)).
<a name="45079"/>45079: 
<a name="45080"/>45080: 
<a name="45081"/>45081: 
<a name="45082"/>45082: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="45083"/>45083: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="45084"/>45084: <i>%% ping-pong like test case.</i>
<a name="45085"/>45085: <i>%% Server:       Transport = gen_tcp, Active = false</i>
<a name="45086"/>45086: <i>%% Client:       Transport = socket(tcp), Active = false</i>
<a name="45087"/>45087: <i>%% Message Size: medium (=2)</i>
<a name="45088"/>45088: <i>%% Domain:       inet</i>
<a name="45089"/>45089: <i>%%</i>
<a name="45090"/>45090: 
<a name="ttest_sgenf_csockf_medium_tcp4-1"/><a name="45091"/>45091: <b>ttest_sgenf_csockf_medium_tcp4</b>(Config) when is_list(Config) -&gt;
<a name="45092"/>45092:     Runtime = which_ttest_runtime(Config),
<a name="ttest_sgenf_csockf_medium_tcp4-last_expr"/><a name="45093"/>45093: <b>    ttest_tcp</b>(ttest_sgenf_csockf_medium_tcp4,
<a name="45094"/>45094:               Runtime,
<a name="45095"/>45095:               inet,
<a name="45096"/>45096:               gen, false,
<a name="45097"/>45097:               sock, false,
<a name="45098"/>45098:               2, ttest_medium_max_outstanding(Config)).
<a name="45099"/>45099: 
<a name="45100"/>45100: 
<a name="45101"/>45101: 
<a name="45102"/>45102: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="45103"/>45103: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="45104"/>45104: <i>%% ping-pong like test case.</i>
<a name="45105"/>45105: <i>%% Server:       Transport = gen_tcp, Active = false</i>
<a name="45106"/>45106: <i>%% Client:       Transport = socket(tcp), Active = false</i>
<a name="45107"/>45107: <i>%% Message Size: medium (=2)</i>
<a name="45108"/>45108: <i>%% Domain:       inet6</i>
<a name="45109"/>45109: <i>%% </i>
<a name="45110"/>45110: 
<a name="ttest_sgenf_csockf_medium_tcp6-1"/><a name="45111"/>45111: <b>ttest_sgenf_csockf_medium_tcp6</b>(Config) when is_list(Config) -&gt;
<a name="45112"/>45112:     Runtime = which_ttest_runtime(Config),
<a name="ttest_sgenf_csockf_medium_tcp6-last_expr"/><a name="45113"/>45113: <b>    ttest_tcp</b>(ttest_sgenf_csockf_medium_tcp6,
<a name="45114"/>45114:               Runtime,
<a name="45115"/>45115:               inet6,
<a name="45116"/>45116:               gen, false,
<a name="45117"/>45117:               sock, false,
<a name="45118"/>45118:               2, ttest_medium_max_outstanding(Config)).
<a name="45119"/>45119: 
<a name="45120"/>45120: 
<a name="45121"/>45121: 
<a name="45122"/>45122: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="45123"/>45123: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="45124"/>45124: <i>%% ping-pong like test case.</i>
<a name="45125"/>45125: <i>%% Server:       Transport = gen_tcp, Active = false</i>
<a name="45126"/>45126: <i>%% Client:       Transport = socket(tcp), Active = false</i>
<a name="45127"/>45127: <i>%% Message Size: large (=3)</i>
<a name="45128"/>45128: <i>%% Domain:       inet</i>
<a name="45129"/>45129: <i>%%</i>
<a name="45130"/>45130: 
<a name="ttest_sgenf_csockf_large_tcp4-1"/><a name="45131"/>45131: <b>ttest_sgenf_csockf_large_tcp4</b>(Config) when is_list(Config) -&gt;
<a name="45132"/>45132:     Runtime = which_ttest_runtime(Config),
<a name="ttest_sgenf_csockf_large_tcp4-last_expr"/><a name="45133"/>45133: <b>    ttest_tcp</b>(ttest_sgenf_csockf_large_tcp4,
<a name="45134"/>45134:               Runtime,
<a name="45135"/>45135:               inet,
<a name="45136"/>45136:               gen, false,
<a name="45137"/>45137:               sock, false,
<a name="45138"/>45138:               3, ttest_large_max_outstanding(Config)).
<a name="45139"/>45139: 
<a name="45140"/>45140: 
<a name="45141"/>45141: 
<a name="45142"/>45142: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="45143"/>45143: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="45144"/>45144: <i>%% ping-pong like test case.</i>
<a name="45145"/>45145: <i>%% Server:       Transport = gen_tcp, Active = false</i>
<a name="45146"/>45146: <i>%% Client:       Transport = socket(tcp), Active = false</i>
<a name="45147"/>45147: <i>%% Message Size: large (=3)</i>
<a name="45148"/>45148: <i>%% Domain:       inet6</i>
<a name="45149"/>45149: <i>%% </i>
<a name="45150"/>45150: 
<a name="ttest_sgenf_csockf_large_tcp6-1"/><a name="45151"/>45151: <b>ttest_sgenf_csockf_large_tcp6</b>(Config) when is_list(Config) -&gt;
<a name="45152"/>45152:     Runtime = which_ttest_runtime(Config),
<a name="ttest_sgenf_csockf_large_tcp6-last_expr"/><a name="45153"/>45153: <b>    ttest_tcp</b>(ttest_sgenf_csockf_large_tcp6,
<a name="45154"/>45154:               Runtime,
<a name="45155"/>45155:               inet6,
<a name="45156"/>45156:               gen, false,
<a name="45157"/>45157:               sock, false,
<a name="45158"/>45158:               3, ttest_large_max_outstanding(Config)).
<a name="45159"/>45159: 
<a name="45160"/>45160: 
<a name="45161"/>45161: 
<a name="45162"/>45162: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="45163"/>45163: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="45164"/>45164: <i>%% ping-pong like test case.</i>
<a name="45165"/>45165: <i>%% Server:       Transport = gen_tcp(socket), Active = false</i>
<a name="45166"/>45166: <i>%% Client:       Transport = socket(tcp), Active = false</i>
<a name="45167"/>45167: <i>%% Message Size: small (=1)</i>
<a name="45168"/>45168: <i>%% Domain:       inet</i>
<a name="45169"/>45169: <i>%%</i>
<a name="45170"/>45170: 
<a name="ttest_sgsf_csockf_small_tcp4-1"/><a name="45171"/>45171: <b>ttest_sgsf_csockf_small_tcp4</b>(Config) when is_list(Config) -&gt;
<a name="45172"/>45172:     Runtime = which_ttest_runtime(Config),
<a name="ttest_sgsf_csockf_small_tcp4-last_expr"/><a name="45173"/>45173: <b>    ttest_tcp</b>(?FUNCTION_NAME,
<a name="45174"/>45174:               Runtime,
<a name="45175"/>45175:               inet,
<a name="45176"/>45176:               gs, false,
<a name="45177"/>45177:               sock, false,
<a name="45178"/>45178:               1, ttest_small_max_outstanding(Config)).
<a name="45179"/>45179: 
<a name="45180"/>45180: 
<a name="45181"/>45181: 
<a name="45182"/>45182: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="45183"/>45183: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="45184"/>45184: <i>%% ping-pong like test case.</i>
<a name="45185"/>45185: <i>%% Server:       Transport = gen_tcp(socket), Active = false</i>
<a name="45186"/>45186: <i>%% Client:       Transport = socket(tcp), Active = false</i>
<a name="45187"/>45187: <i>%% Message Size: small (=1)</i>
<a name="45188"/>45188: <i>%% Domain:       inet6</i>
<a name="45189"/>45189: <i>%% </i>
<a name="45190"/>45190: 
<a name="ttest_sgsf_csockf_small_tcp6-1"/><a name="45191"/>45191: <b>ttest_sgsf_csockf_small_tcp6</b>(Config) when is_list(Config) -&gt;
<a name="45192"/>45192:     Runtime = which_ttest_runtime(Config),
<a name="ttest_sgsf_csockf_small_tcp6-last_expr"/><a name="45193"/>45193: <b>    ttest_tcp</b>(?FUNCTION_NAME,
<a name="45194"/>45194:               Runtime,
<a name="45195"/>45195:               inet6,
<a name="45196"/>45196:               gs, false,
<a name="45197"/>45197:               sock, false,
<a name="45198"/>45198:               1, ttest_small_max_outstanding(Config)).
<a name="45199"/>45199: 
<a name="45200"/>45200: 
<a name="45201"/>45201: 
<a name="45202"/>45202: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="45203"/>45203: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="45204"/>45204: <i>%% ping-pong like test case.</i>
<a name="45205"/>45205: <i>%% Server:       Transport = gen_tcp(socket), Active = false</i>
<a name="45206"/>45206: <i>%% Client:       Transport = socket(tcp), Active = false</i>
<a name="45207"/>45207: <i>%% Message Size: medium (=2)</i>
<a name="45208"/>45208: <i>%% Domain:       inet</i>
<a name="45209"/>45209: <i>%%</i>
<a name="45210"/>45210: 
<a name="ttest_sgsf_csockf_medium_tcp4-1"/><a name="45211"/>45211: <b>ttest_sgsf_csockf_medium_tcp4</b>(Config) when is_list(Config) -&gt;
<a name="45212"/>45212:     Runtime = which_ttest_runtime(Config),
<a name="ttest_sgsf_csockf_medium_tcp4-last_expr"/><a name="45213"/>45213: <b>    ttest_tcp</b>(?FUNCTION_NAME,
<a name="45214"/>45214:               Runtime,
<a name="45215"/>45215:               inet,
<a name="45216"/>45216:               gs, false,
<a name="45217"/>45217:               sock, false,
<a name="45218"/>45218:               2, ttest_medium_max_outstanding(Config)).
<a name="45219"/>45219: 
<a name="45220"/>45220: 
<a name="45221"/>45221: 
<a name="45222"/>45222: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="45223"/>45223: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="45224"/>45224: <i>%% ping-pong like test case.</i>
<a name="45225"/>45225: <i>%% Server:       Transport = gen_tcp(socket), Active = false</i>
<a name="45226"/>45226: <i>%% Client:       Transport = socket(tcp), Active = false</i>
<a name="45227"/>45227: <i>%% Message Size: medium (=2)</i>
<a name="45228"/>45228: <i>%% Domain:       inet6</i>
<a name="45229"/>45229: <i>%% </i>
<a name="45230"/>45230: 
<a name="ttest_sgsf_csockf_medium_tcp6-1"/><a name="45231"/>45231: <b>ttest_sgsf_csockf_medium_tcp6</b>(Config) when is_list(Config) -&gt;
<a name="45232"/>45232:     Runtime = which_ttest_runtime(Config),
<a name="ttest_sgsf_csockf_medium_tcp6-last_expr"/><a name="45233"/>45233: <b>    ttest_tcp</b>(?FUNCTION_NAME,
<a name="45234"/>45234:               Runtime,
<a name="45235"/>45235:               inet6,
<a name="45236"/>45236:               gs, false,
<a name="45237"/>45237:               sock, false,
<a name="45238"/>45238:               2, ttest_medium_max_outstanding(Config)).
<a name="45239"/>45239: 
<a name="45240"/>45240: 
<a name="45241"/>45241: 
<a name="45242"/>45242: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="45243"/>45243: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="45244"/>45244: <i>%% ping-pong like test case.</i>
<a name="45245"/>45245: <i>%% Server:       Transport = gen_tcp(socket), Active = false</i>
<a name="45246"/>45246: <i>%% Client:       Transport = socket(tcp), Active = false</i>
<a name="45247"/>45247: <i>%% Message Size: large (=3)</i>
<a name="45248"/>45248: <i>%% Domain:       inet</i>
<a name="45249"/>45249: <i>%%</i>
<a name="45250"/>45250: 
<a name="ttest_sgsf_csockf_large_tcp4-1"/><a name="45251"/>45251: <b>ttest_sgsf_csockf_large_tcp4</b>(Config) when is_list(Config) -&gt;
<a name="45252"/>45252:     Runtime = which_ttest_runtime(Config),
<a name="ttest_sgsf_csockf_large_tcp4-last_expr"/><a name="45253"/>45253: <b>    ttest_tcp</b>(?FUNCTION_NAME,
<a name="45254"/>45254:               Runtime,
<a name="45255"/>45255:               inet,
<a name="45256"/>45256:               gs, false,
<a name="45257"/>45257:               sock, false,
<a name="45258"/>45258:               3, ttest_large_max_outstanding(Config)).
<a name="45259"/>45259: 
<a name="45260"/>45260: 
<a name="45261"/>45261: 
<a name="45262"/>45262: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="45263"/>45263: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="45264"/>45264: <i>%% ping-pong like test case.</i>
<a name="45265"/>45265: <i>%% Server:       Transport = gen_tcp(socket), Active = false</i>
<a name="45266"/>45266: <i>%% Client:       Transport = socket(tcp), Active = false</i>
<a name="45267"/>45267: <i>%% Message Size: large (=3)</i>
<a name="45268"/>45268: <i>%% Domain:       inet6</i>
<a name="45269"/>45269: <i>%% </i>
<a name="45270"/>45270: 
<a name="ttest_sgsf_csockf_large_tcp6-1"/><a name="45271"/>45271: <b>ttest_sgsf_csockf_large_tcp6</b>(Config) when is_list(Config) -&gt;
<a name="45272"/>45272:     Runtime = which_ttest_runtime(Config),
<a name="ttest_sgsf_csockf_large_tcp6-last_expr"/><a name="45273"/>45273: <b>    ttest_tcp</b>(?FUNCTION_NAME,
<a name="45274"/>45274:               Runtime,
<a name="45275"/>45275:               inet6,
<a name="45276"/>45276:               gs, false,
<a name="45277"/>45277:               sock, false,
<a name="45278"/>45278:               3, ttest_large_max_outstanding(Config)).
<a name="45279"/>45279: 
<a name="45280"/>45280: 
<a name="45281"/>45281: 
<a name="45282"/>45282: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="45283"/>45283: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="45284"/>45284: <i>%% ping-pong like test case.</i>
<a name="45285"/>45285: <i>%% Server:       Transport = gen_tcp, Active = false</i>
<a name="45286"/>45286: <i>%% Client:       Transport = socket(tcp), Active = once</i>
<a name="45287"/>45287: <i>%% Message Size: small (=1)</i>
<a name="45288"/>45288: <i>%% Domain:       inet</i>
<a name="45289"/>45289: <i>%%</i>
<a name="45290"/>45290: 
<a name="ttest_sgenf_csocko_small_tcp4-1"/><a name="45291"/>45291: <b>ttest_sgenf_csocko_small_tcp4</b>(Config) when is_list(Config) -&gt;
<a name="45292"/>45292:     Runtime = which_ttest_runtime(Config),
<a name="ttest_sgenf_csocko_small_tcp4-last_expr"/><a name="45293"/>45293: <b>    ttest_tcp</b>(ttest_sgenf_csocko_small_tcp4,
<a name="45294"/>45294:               Runtime,
<a name="45295"/>45295:               inet,
<a name="45296"/>45296:               gen, false,
<a name="45297"/>45297:               sock, once,
<a name="45298"/>45298:               1, ttest_small_max_outstanding(Config)).
<a name="45299"/>45299: 
<a name="45300"/>45300: 
<a name="45301"/>45301: 
<a name="45302"/>45302: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="45303"/>45303: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="45304"/>45304: <i>%% ping-pong like test case.</i>
<a name="45305"/>45305: <i>%% Server:       Transport = gen_tcp, Active = false</i>
<a name="45306"/>45306: <i>%% Client:       Transport = socket(tcp), Active = once</i>
<a name="45307"/>45307: <i>%% Message Size: small (=1)</i>
<a name="45308"/>45308: <i>%% Domain:       inet6</i>
<a name="45309"/>45309: <i>%% </i>
<a name="45310"/>45310: 
<a name="ttest_sgenf_csocko_small_tcp6-1"/><a name="45311"/>45311: <b>ttest_sgenf_csocko_small_tcp6</b>(Config) when is_list(Config) -&gt;
<a name="45312"/>45312:     Runtime = which_ttest_runtime(Config),
<a name="ttest_sgenf_csocko_small_tcp6-last_expr"/><a name="45313"/>45313: <b>    ttest_tcp</b>(ttest_sgenf_csocko_small_tcp6,
<a name="45314"/>45314:               Runtime,
<a name="45315"/>45315:               inet6,
<a name="45316"/>45316:               gen, false,
<a name="45317"/>45317:               sock, once,
<a name="45318"/>45318:               1, ttest_small_max_outstanding(Config)).
<a name="45319"/>45319: 
<a name="45320"/>45320: 
<a name="45321"/>45321: 
<a name="45322"/>45322: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="45323"/>45323: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="45324"/>45324: <i>%% ping-pong like test case.</i>
<a name="45325"/>45325: <i>%% Server:       Transport = gen_tcp, Active = false</i>
<a name="45326"/>45326: <i>%% Client:       Transport = socket(tcp), Active = once</i>
<a name="45327"/>45327: <i>%% Message Size: medium (=2)</i>
<a name="45328"/>45328: <i>%% Domain:       inet</i>
<a name="45329"/>45329: <i>%%</i>
<a name="45330"/>45330: 
<a name="ttest_sgenf_csocko_medium_tcp4-1"/><a name="45331"/>45331: <b>ttest_sgenf_csocko_medium_tcp4</b>(Config) when is_list(Config) -&gt;
<a name="45332"/>45332:     Runtime = which_ttest_runtime(Config),
<a name="ttest_sgenf_csocko_medium_tcp4-last_expr"/><a name="45333"/>45333: <b>    ttest_tcp</b>(ttest_sgenf_csocko_medium_tcp4,
<a name="45334"/>45334:               Runtime,
<a name="45335"/>45335:               inet,
<a name="45336"/>45336:               gen, false,
<a name="45337"/>45337:               sock, once,
<a name="45338"/>45338:               2, ttest_medium_max_outstanding(Config)).
<a name="45339"/>45339: 
<a name="45340"/>45340: 
<a name="45341"/>45341: 
<a name="45342"/>45342: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="45343"/>45343: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="45344"/>45344: <i>%% ping-pong like test case.</i>
<a name="45345"/>45345: <i>%% Server:       Transport = gen_tcp, Active = false</i>
<a name="45346"/>45346: <i>%% Client:       Transport = socket(tcp), Active = once</i>
<a name="45347"/>45347: <i>%% Message Size: medium (=2)</i>
<a name="45348"/>45348: <i>%% Domain:       inet6</i>
<a name="45349"/>45349: <i>%% </i>
<a name="45350"/>45350: 
<a name="ttest_sgenf_csocko_medium_tcp6-1"/><a name="45351"/>45351: <b>ttest_sgenf_csocko_medium_tcp6</b>(Config) when is_list(Config) -&gt;
<a name="45352"/>45352:     Runtime = which_ttest_runtime(Config),
<a name="ttest_sgenf_csocko_medium_tcp6-last_expr"/><a name="45353"/>45353: <b>    ttest_tcp</b>(ttest_sgenf_csocko_medium_tcp6,
<a name="45354"/>45354:               Runtime,
<a name="45355"/>45355:               inet6,
<a name="45356"/>45356:               gen, false,
<a name="45357"/>45357:               sock, once,
<a name="45358"/>45358:               2, ttest_medium_max_outstanding(Config)).
<a name="45359"/>45359: 
<a name="45360"/>45360: 
<a name="45361"/>45361: 
<a name="45362"/>45362: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="45363"/>45363: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="45364"/>45364: <i>%% ping-pong like test case.</i>
<a name="45365"/>45365: <i>%% Server:       Transport = gen_tcp, Active = false</i>
<a name="45366"/>45366: <i>%% Client:       Transport = socket(tcp), Active = once</i>
<a name="45367"/>45367: <i>%% Message Size: large (=3)</i>
<a name="45368"/>45368: <i>%% Domain:       inet</i>
<a name="45369"/>45369: <i>%%</i>
<a name="45370"/>45370: 
<a name="ttest_sgenf_csocko_large_tcp4-1"/><a name="45371"/>45371: <b>ttest_sgenf_csocko_large_tcp4</b>(Config) when is_list(Config) -&gt;
<a name="45372"/>45372:     Runtime = which_ttest_runtime(Config),
<a name="ttest_sgenf_csocko_large_tcp4-last_expr"/><a name="45373"/>45373: <b>    ttest_tcp</b>(ttest_sgenf_csocko_large_tcp4,
<a name="45374"/>45374:               Runtime,
<a name="45375"/>45375:               inet,
<a name="45376"/>45376:               gen, false,
<a name="45377"/>45377:               sock, once,
<a name="45378"/>45378:               3, ttest_large_max_outstanding(Config)).
<a name="45379"/>45379: 
<a name="45380"/>45380: 
<a name="45381"/>45381: 
<a name="45382"/>45382: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="45383"/>45383: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="45384"/>45384: <i>%% ping-pong like test case.</i>
<a name="45385"/>45385: <i>%% Server:       Transport = gen_tcp, Active = false</i>
<a name="45386"/>45386: <i>%% Client:       Transport = socket(tcp), Active = once</i>
<a name="45387"/>45387: <i>%% Message Size: large (=3)</i>
<a name="45388"/>45388: <i>%% Domain:       inet6</i>
<a name="45389"/>45389: <i>%% </i>
<a name="45390"/>45390: 
<a name="ttest_sgenf_csocko_large_tcp6-1"/><a name="45391"/>45391: <b>ttest_sgenf_csocko_large_tcp6</b>(Config) when is_list(Config) -&gt;
<a name="45392"/>45392:     Runtime = which_ttest_runtime(Config),
<a name="ttest_sgenf_csocko_large_tcp6-last_expr"/><a name="45393"/>45393: <b>    ttest_tcp</b>(ttest_sgenf_csocko_large_tcp6,
<a name="45394"/>45394:               Runtime,
<a name="45395"/>45395:               inet6,
<a name="45396"/>45396:               gen, false,
<a name="45397"/>45397:               sock, once,
<a name="45398"/>45398:               3, ttest_large_max_outstanding(Config)).
<a name="45399"/>45399: 
<a name="45400"/>45400: 
<a name="45401"/>45401: 
<a name="45402"/>45402: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="45403"/>45403: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="45404"/>45404: <i>%% ping-pong like test case.</i>
<a name="45405"/>45405: <i>%% Server:       Transport = gen_tcp, Active = false</i>
<a name="45406"/>45406: <i>%% Client:       Transport = socket(tcp), Active = true</i>
<a name="45407"/>45407: <i>%% Message Size: small (=1)</i>
<a name="45408"/>45408: <i>%% Domain:       inet</i>
<a name="45409"/>45409: <i>%%</i>
<a name="45410"/>45410: 
<a name="ttest_sgenf_csockt_small_tcp4-1"/><a name="45411"/>45411: <b>ttest_sgenf_csockt_small_tcp4</b>(Config) when is_list(Config) -&gt;
<a name="45412"/>45412:     Runtime = which_ttest_runtime(Config),
<a name="ttest_sgenf_csockt_small_tcp4-last_expr"/><a name="45413"/>45413: <b>    ttest_tcp</b>(ttest_sgenf_csockt_small_tcp4,
<a name="45414"/>45414:               Runtime,
<a name="45415"/>45415:               inet,
<a name="45416"/>45416:               gen, false,
<a name="45417"/>45417:               sock, true,
<a name="45418"/>45418:               1, ttest_small_max_outstanding(Config)).
<a name="45419"/>45419: 
<a name="45420"/>45420: 
<a name="45421"/>45421: 
<a name="45422"/>45422: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="45423"/>45423: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="45424"/>45424: <i>%% ping-pong like test case.</i>
<a name="45425"/>45425: <i>%% Server:       Transport = gen_tcp, Active = false</i>
<a name="45426"/>45426: <i>%% Client:       Transport = socket(tcp), Active = true</i>
<a name="45427"/>45427: <i>%% Message Size: small (=1)</i>
<a name="45428"/>45428: <i>%% Domain:       inet6</i>
<a name="45429"/>45429: <i>%% </i>
<a name="45430"/>45430: 
<a name="ttest_sgenf_csockt_small_tcp6-1"/><a name="45431"/>45431: <b>ttest_sgenf_csockt_small_tcp6</b>(Config) when is_list(Config) -&gt;
<a name="45432"/>45432:     Runtime = which_ttest_runtime(Config),
<a name="ttest_sgenf_csockt_small_tcp6-last_expr"/><a name="45433"/>45433: <b>    ttest_tcp</b>(ttest_sgenf_csocko_small_tcp6,
<a name="45434"/>45434:               Runtime,
<a name="45435"/>45435:               inet6,
<a name="45436"/>45436:               gen, false,
<a name="45437"/>45437:               sock, true,
<a name="45438"/>45438:               1, ttest_small_max_outstanding(Config)).
<a name="45439"/>45439: 
<a name="45440"/>45440: 
<a name="45441"/>45441: 
<a name="45442"/>45442: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="45443"/>45443: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="45444"/>45444: <i>%% ping-pong like test case.</i>
<a name="45445"/>45445: <i>%% Server:       Transport = gen_tcp, Active = false</i>
<a name="45446"/>45446: <i>%% Client:       Transport = socket(tcp), Active = true</i>
<a name="45447"/>45447: <i>%% Message Size: medium (=2)</i>
<a name="45448"/>45448: <i>%% Domain:       inet</i>
<a name="45449"/>45449: <i>%%</i>
<a name="45450"/>45450: 
<a name="ttest_sgenf_csockt_medium_tcp4-1"/><a name="45451"/>45451: <b>ttest_sgenf_csockt_medium_tcp4</b>(Config) when is_list(Config) -&gt;
<a name="45452"/>45452:     Runtime = which_ttest_runtime(Config),
<a name="ttest_sgenf_csockt_medium_tcp4-last_expr"/><a name="45453"/>45453: <b>    ttest_tcp</b>(ttest_sgenf_csockt_medium_tcp4,
<a name="45454"/>45454:               Runtime,
<a name="45455"/>45455:               inet,
<a name="45456"/>45456:               gen, false,
<a name="45457"/>45457:               sock, true,
<a name="45458"/>45458:               2, ttest_medium_max_outstanding(Config)).
<a name="45459"/>45459: 
<a name="45460"/>45460: 
<a name="45461"/>45461: 
<a name="45462"/>45462: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="45463"/>45463: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="45464"/>45464: <i>%% ping-pong like test case.</i>
<a name="45465"/>45465: <i>%% Server:       Transport = gen_tcp, Active = false</i>
<a name="45466"/>45466: <i>%% Client:       Transport = socket(tcp), Active = true</i>
<a name="45467"/>45467: <i>%% Message Size: medium (=2)</i>
<a name="45468"/>45468: <i>%% Domain:       inet6</i>
<a name="45469"/>45469: <i>%% </i>
<a name="45470"/>45470: 
<a name="ttest_sgenf_csockt_medium_tcp6-1"/><a name="45471"/>45471: <b>ttest_sgenf_csockt_medium_tcp6</b>(Config) when is_list(Config) -&gt;
<a name="45472"/>45472:     Runtime = which_ttest_runtime(Config),
<a name="ttest_sgenf_csockt_medium_tcp6-last_expr"/><a name="45473"/>45473: <b>    ttest_tcp</b>(ttest_sgenf_csockt_medium_tcp6,
<a name="45474"/>45474:               Runtime,
<a name="45475"/>45475:               inet6,
<a name="45476"/>45476:               gen, false,
<a name="45477"/>45477:               sock, true,
<a name="45478"/>45478:               2, ttest_medium_max_outstanding(Config)).
<a name="45479"/>45479: 
<a name="45480"/>45480: 
<a name="45481"/>45481: 
<a name="45482"/>45482: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="45483"/>45483: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="45484"/>45484: <i>%% ping-pong like test case.</i>
<a name="45485"/>45485: <i>%% Server:       Transport = gen_tcp, Active = false</i>
<a name="45486"/>45486: <i>%% Client:       Transport = socket(tcp), Active = true</i>
<a name="45487"/>45487: <i>%% Message Size: large (=3)</i>
<a name="45488"/>45488: <i>%% Domain:       inet</i>
<a name="45489"/>45489: <i>%%</i>
<a name="45490"/>45490: 
<a name="ttest_sgenf_csockt_large_tcp4-1"/><a name="45491"/>45491: <b>ttest_sgenf_csockt_large_tcp4</b>(Config) when is_list(Config) -&gt;
<a name="45492"/>45492:     Runtime = which_ttest_runtime(Config),
<a name="ttest_sgenf_csockt_large_tcp4-last_expr"/><a name="45493"/>45493: <b>    ttest_tcp</b>(ttest_sgenf_csockt_large_tcp4,
<a name="45494"/>45494:               Runtime,
<a name="45495"/>45495:               inet,
<a name="45496"/>45496:               gen, false,
<a name="45497"/>45497:               sock, true,
<a name="45498"/>45498:               3, ttest_large_max_outstanding(Config)).
<a name="45499"/>45499: 
<a name="45500"/>45500: 
<a name="45501"/>45501: 
<a name="45502"/>45502: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="45503"/>45503: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="45504"/>45504: <i>%% ping-pong like test case.</i>
<a name="45505"/>45505: <i>%% Server:       Transport = gen_tcp, Active = false</i>
<a name="45506"/>45506: <i>%% Client:       Transport = socket(tcp), Active = true</i>
<a name="45507"/>45507: <i>%% Message Size: large (=3)</i>
<a name="45508"/>45508: <i>%% Domain:       inet6</i>
<a name="45509"/>45509: <i>%% </i>
<a name="45510"/>45510: 
<a name="ttest_sgenf_csockt_large_tcp6-1"/><a name="45511"/>45511: <b>ttest_sgenf_csockt_large_tcp6</b>(Config) when is_list(Config) -&gt;
<a name="45512"/>45512:     Runtime = which_ttest_runtime(Config),
<a name="ttest_sgenf_csockt_large_tcp6-last_expr"/><a name="45513"/>45513: <b>    ttest_tcp</b>(ttest_sgenf_csockt_large_tcp6,
<a name="45514"/>45514:               Runtime,
<a name="45515"/>45515:               inet6,
<a name="45516"/>45516:               gen, false,
<a name="45517"/>45517:               sock, true,
<a name="45518"/>45518:               3, ttest_large_max_outstanding(Config)).
<a name="45519"/>45519: 
<a name="45520"/>45520: 
<a name="45521"/>45521: 
<a name="45522"/>45522: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="45523"/>45523: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="45524"/>45524: <i>%% ping-pong like test case.</i>
<a name="45525"/>45525: <i>%% Server:       Transport = gen_tcp, Active = once</i>
<a name="45526"/>45526: <i>%% Client:       Transport = gen_tcp, Active = false</i>
<a name="45527"/>45527: <i>%% Message Size: small (=1)</i>
<a name="45528"/>45528: <i>%% Domain:       inet</i>
<a name="45529"/>45529: <i>%%</i>
<a name="45530"/>45530: 
<a name="ttest_sgeno_cgenf_small_tcp4-1"/><a name="45531"/>45531: <b>ttest_sgeno_cgenf_small_tcp4</b>(Config) when is_list(Config) -&gt;
<a name="45532"/>45532:     Runtime = which_ttest_runtime(Config),
<a name="ttest_sgeno_cgenf_small_tcp4-last_expr"/><a name="45533"/>45533: <b>    ttest_tcp</b>(ttest_sgeno_cgenf_small_tcp4,
<a name="45534"/>45534:               Runtime,
<a name="45535"/>45535:               inet,
<a name="45536"/>45536:               gen, once,
<a name="45537"/>45537:               gen, false,
<a name="45538"/>45538:               1, ttest_small_max_outstanding(Config)).
<a name="45539"/>45539: 
<a name="45540"/>45540: 
<a name="45541"/>45541: 
<a name="45542"/>45542: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="45543"/>45543: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="45544"/>45544: <i>%% ping-pong like test case.</i>
<a name="45545"/>45545: <i>%% Server:       Transport = gen_tcp, Active = once</i>
<a name="45546"/>45546: <i>%% Client:       Transport = gen_tcp, Active = false</i>
<a name="45547"/>45547: <i>%% Message Size: small (=1)</i>
<a name="45548"/>45548: <i>%% Domain:       inet6</i>
<a name="45549"/>45549: <i>%% </i>
<a name="45550"/>45550: 
<a name="ttest_sgeno_cgenf_small_tcp6-1"/><a name="45551"/>45551: <b>ttest_sgeno_cgenf_small_tcp6</b>(Config) when is_list(Config) -&gt;
<a name="45552"/>45552:     Runtime = which_ttest_runtime(Config),
<a name="ttest_sgeno_cgenf_small_tcp6-last_expr"/><a name="45553"/>45553: <b>    ttest_tcp</b>(ttest_sgeno_cgenf_small_tcp6,
<a name="45554"/>45554:               Runtime,
<a name="45555"/>45555:               inet6,
<a name="45556"/>45556:               gen, once,
<a name="45557"/>45557:               gen, false,
<a name="45558"/>45558:               1, ttest_small_max_outstanding(Config)).
<a name="45559"/>45559: 
<a name="45560"/>45560: 
<a name="45561"/>45561: 
<a name="45562"/>45562: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="45563"/>45563: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="45564"/>45564: <i>%% ping-pong like test case.</i>
<a name="45565"/>45565: <i>%% Server:       Transport = gen_tcp, Active = once</i>
<a name="45566"/>45566: <i>%% Client:       Transport = gen_tcp, Active = false</i>
<a name="45567"/>45567: <i>%% Message Size: medium (=2)</i>
<a name="45568"/>45568: <i>%% Domain:       inet</i>
<a name="45569"/>45569: <i>%%</i>
<a name="45570"/>45570: 
<a name="ttest_sgeno_cgenf_medium_tcp4-1"/><a name="45571"/>45571: <b>ttest_sgeno_cgenf_medium_tcp4</b>(Config) when is_list(Config) -&gt;
<a name="45572"/>45572:     Runtime = which_ttest_runtime(Config),
<a name="ttest_sgeno_cgenf_medium_tcp4-last_expr"/><a name="45573"/>45573: <b>    ttest_tcp</b>(ttest_sgeno_cgenf_medium_tcp4,
<a name="45574"/>45574:               Runtime,
<a name="45575"/>45575:               inet,
<a name="45576"/>45576:               gen, once,
<a name="45577"/>45577:               gen, false,
<a name="45578"/>45578:               2, ttest_medium_max_outstanding(Config)).
<a name="45579"/>45579: 
<a name="45580"/>45580: 
<a name="45581"/>45581: 
<a name="45582"/>45582: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="45583"/>45583: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="45584"/>45584: <i>%% ping-pong like test case.</i>
<a name="45585"/>45585: <i>%% Server:       Transport = gen_tcp, Active = once</i>
<a name="45586"/>45586: <i>%% Client:       Transport = gen_tcp, Active = false</i>
<a name="45587"/>45587: <i>%% Message Size: medium (=2)</i>
<a name="45588"/>45588: <i>%% Domain:       inet6</i>
<a name="45589"/>45589: <i>%% </i>
<a name="45590"/>45590: 
<a name="ttest_sgeno_cgenf_medium_tcp6-1"/><a name="45591"/>45591: <b>ttest_sgeno_cgenf_medium_tcp6</b>(Config) when is_list(Config) -&gt;
<a name="45592"/>45592:     Runtime = which_ttest_runtime(Config),
<a name="ttest_sgeno_cgenf_medium_tcp6-last_expr"/><a name="45593"/>45593: <b>    ttest_tcp</b>(ttest_sgeno_cgenf_medium_tcp6,
<a name="45594"/>45594:               Runtime,
<a name="45595"/>45595:               inet6,
<a name="45596"/>45596:               gen, once,
<a name="45597"/>45597:               gen, false,
<a name="45598"/>45598:               2, ttest_medium_max_outstanding(Config)).
<a name="45599"/>45599: 
<a name="45600"/>45600: 
<a name="45601"/>45601: 
<a name="45602"/>45602: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="45603"/>45603: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="45604"/>45604: <i>%% ping-pong like test case.</i>
<a name="45605"/>45605: <i>%% Server:       Transport = gen_tcp, Active = once</i>
<a name="45606"/>45606: <i>%% Client:       Transport = gen_tcp, Active = false</i>
<a name="45607"/>45607: <i>%% Message Size: large (=3)</i>
<a name="45608"/>45608: <i>%% Domain:       inet</i>
<a name="45609"/>45609: <i>%%</i>
<a name="45610"/>45610: 
<a name="ttest_sgeno_cgenf_large_tcp4-1"/><a name="45611"/>45611: <b>ttest_sgeno_cgenf_large_tcp4</b>(Config) when is_list(Config) -&gt;
<a name="45612"/>45612:     Runtime = which_ttest_runtime(Config),
<a name="ttest_sgeno_cgenf_large_tcp4-last_expr"/><a name="45613"/>45613: <b>    ttest_tcp</b>(ttest_sgeno_cgenf_large_tcp4,
<a name="45614"/>45614:               Runtime,
<a name="45615"/>45615:               inet,
<a name="45616"/>45616:               gen, once,
<a name="45617"/>45617:               gen, false,
<a name="45618"/>45618:               3, ttest_large_max_outstanding(Config)).
<a name="45619"/>45619: 
<a name="45620"/>45620: 
<a name="45621"/>45621: 
<a name="45622"/>45622: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="45623"/>45623: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="45624"/>45624: <i>%% ping-pong like test case.</i>
<a name="45625"/>45625: <i>%% Server:       Transport = gen_tcp, Active = once</i>
<a name="45626"/>45626: <i>%% Client:       Transport = gen_tcp, Active = false</i>
<a name="45627"/>45627: <i>%% Message Size: large (=3)</i>
<a name="45628"/>45628: <i>%% Domain:       inet6</i>
<a name="45629"/>45629: <i>%% </i>
<a name="45630"/>45630: 
<a name="ttest_sgeno_cgenf_large_tcp6-1"/><a name="45631"/>45631: <b>ttest_sgeno_cgenf_large_tcp6</b>(Config) when is_list(Config) -&gt;
<a name="45632"/>45632:     Runtime = which_ttest_runtime(Config),
<a name="ttest_sgeno_cgenf_large_tcp6-last_expr"/><a name="45633"/>45633: <b>    ttest_tcp</b>(ttest_sgeno_cgenf_large_tcp6,
<a name="45634"/>45634:               Runtime,
<a name="45635"/>45635:               inet6,
<a name="45636"/>45636:               gen, once,
<a name="45637"/>45637:               gen, false,
<a name="45638"/>45638:               3, ttest_large_max_outstanding(Config)).
<a name="45639"/>45639: 
<a name="45640"/>45640: 
<a name="45641"/>45641: 
<a name="45642"/>45642: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="45643"/>45643: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="45644"/>45644: <i>%% ping-pong like test case.</i>
<a name="45645"/>45645: <i>%% Server:       Transport = gen_tcp, Active = once</i>
<a name="45646"/>45646: <i>%% Client:       Transport = gen_tcp, Active = once</i>
<a name="45647"/>45647: <i>%% Message Size: small (=1)</i>
<a name="45648"/>45648: <i>%% Domain:       inet</i>
<a name="45649"/>45649: <i>%%</i>
<a name="45650"/>45650: 
<a name="ttest_sgeno_cgeno_small_tcp4-1"/><a name="45651"/>45651: <b>ttest_sgeno_cgeno_small_tcp4</b>(Config) when is_list(Config) -&gt;
<a name="45652"/>45652:     Runtime = which_ttest_runtime(Config),
<a name="ttest_sgeno_cgeno_small_tcp4-last_expr"/><a name="45653"/>45653: <b>    ttest_tcp</b>(ttest_sgeno_cgeno_small_tcp4,
<a name="45654"/>45654:               Runtime,
<a name="45655"/>45655:               inet,
<a name="45656"/>45656:               gen, once,
<a name="45657"/>45657:               gen, once,
<a name="45658"/>45658:               1, ttest_small_max_outstanding(Config)).
<a name="45659"/>45659: 
<a name="45660"/>45660: 
<a name="45661"/>45661: 
<a name="45662"/>45662: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="45663"/>45663: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="45664"/>45664: <i>%% ping-pong like test case.</i>
<a name="45665"/>45665: <i>%% Server:       Transport = gen_tcp, Active = once</i>
<a name="45666"/>45666: <i>%% Client:       Transport = gen_tcp, Active = once</i>
<a name="45667"/>45667: <i>%% Message Size: small (=1)</i>
<a name="45668"/>45668: <i>%% Domain:       inet6</i>
<a name="45669"/>45669: <i>%% </i>
<a name="45670"/>45670: 
<a name="ttest_sgeno_cgeno_small_tcp6-1"/><a name="45671"/>45671: <b>ttest_sgeno_cgeno_small_tcp6</b>(Config) when is_list(Config) -&gt;
<a name="45672"/>45672:     Runtime = which_ttest_runtime(Config),
<a name="ttest_sgeno_cgeno_small_tcp6-last_expr"/><a name="45673"/>45673: <b>    ttest_tcp</b>(ttest_sgeno_cgeno_small_tcp6,
<a name="45674"/>45674:               Runtime,
<a name="45675"/>45675:               inet6,
<a name="45676"/>45676:               gen, once,
<a name="45677"/>45677:               gen, once,
<a name="45678"/>45678:               1, ttest_small_max_outstanding(Config)).
<a name="45679"/>45679: 
<a name="45680"/>45680: 
<a name="45681"/>45681: 
<a name="45682"/>45682: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="45683"/>45683: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="45684"/>45684: <i>%% ping-pong like test case.</i>
<a name="45685"/>45685: <i>%% Server:       Transport = gen_tcp, Active = once</i>
<a name="45686"/>45686: <i>%% Client:       Transport = gen_tcp, Active = once</i>
<a name="45687"/>45687: <i>%% Message Size: medium (=2)</i>
<a name="45688"/>45688: <i>%% Domain:       inet</i>
<a name="45689"/>45689: <i>%%</i>
<a name="45690"/>45690: 
<a name="ttest_sgeno_cgeno_medium_tcp4-1"/><a name="45691"/>45691: <b>ttest_sgeno_cgeno_medium_tcp4</b>(Config) when is_list(Config) -&gt;
<a name="45692"/>45692:     Runtime = which_ttest_runtime(Config),
<a name="ttest_sgeno_cgeno_medium_tcp4-last_expr"/><a name="45693"/>45693: <b>    ttest_tcp</b>(ttest_sgeno_cgeno_medium_tcp4,
<a name="45694"/>45694:               Runtime,
<a name="45695"/>45695:               inet,
<a name="45696"/>45696:               gen, once,
<a name="45697"/>45697:               gen, once,
<a name="45698"/>45698:               2, ttest_medium_max_outstanding(Config)).
<a name="45699"/>45699: 
<a name="45700"/>45700: 
<a name="45701"/>45701: 
<a name="45702"/>45702: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="45703"/>45703: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="45704"/>45704: <i>%% ping-pong like test case.</i>
<a name="45705"/>45705: <i>%% Server:       Transport = gen_tcp, Active = once</i>
<a name="45706"/>45706: <i>%% Client:       Transport = gen_tcp, Active = once</i>
<a name="45707"/>45707: <i>%% Message Size: medium (=2)</i>
<a name="45708"/>45708: <i>%% Domain:       inet6</i>
<a name="45709"/>45709: <i>%% </i>
<a name="45710"/>45710: 
<a name="ttest_sgeno_cgeno_medium_tcp6-1"/><a name="45711"/>45711: <b>ttest_sgeno_cgeno_medium_tcp6</b>(Config) when is_list(Config) -&gt;
<a name="45712"/>45712:     Runtime = which_ttest_runtime(Config),
<a name="ttest_sgeno_cgeno_medium_tcp6-last_expr"/><a name="45713"/>45713: <b>    ttest_tcp</b>(ttest_sgeno_cgeno_medium_tcp6,
<a name="45714"/>45714:               Runtime,
<a name="45715"/>45715:               inet6,
<a name="45716"/>45716:               gen, once,
<a name="45717"/>45717:               gen, once,
<a name="45718"/>45718:               2, ttest_medium_max_outstanding(Config)).
<a name="45719"/>45719: 
<a name="45720"/>45720: 
<a name="45721"/>45721: 
<a name="45722"/>45722: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="45723"/>45723: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="45724"/>45724: <i>%% ping-pong like test case.</i>
<a name="45725"/>45725: <i>%% Server:       Transport = gen_tcp, Active = once</i>
<a name="45726"/>45726: <i>%% Client:       Transport = gen_tcp, Active = once</i>
<a name="45727"/>45727: <i>%% Message Size: large (=3)</i>
<a name="45728"/>45728: <i>%% Domain:       inet</i>
<a name="45729"/>45729: <i>%%</i>
<a name="45730"/>45730: 
<a name="ttest_sgeno_cgeno_large_tcp4-1"/><a name="45731"/>45731: <b>ttest_sgeno_cgeno_large_tcp4</b>(Config) when is_list(Config) -&gt;
<a name="45732"/>45732:     Runtime = which_ttest_runtime(Config),
<a name="ttest_sgeno_cgeno_large_tcp4-last_expr"/><a name="45733"/>45733: <b>    ttest_tcp</b>(ttest_sgeno_cgeno_large_tcp4,
<a name="45734"/>45734:               Runtime,
<a name="45735"/>45735:               inet,
<a name="45736"/>45736:               gen, once,
<a name="45737"/>45737:               gen, once,
<a name="45738"/>45738:               3, ttest_large_max_outstanding(Config)).
<a name="45739"/>45739: 
<a name="45740"/>45740: 
<a name="45741"/>45741: 
<a name="45742"/>45742: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="45743"/>45743: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="45744"/>45744: <i>%% ping-pong like test case.</i>
<a name="45745"/>45745: <i>%% Server:       Transport = gen_tcp, Active = once</i>
<a name="45746"/>45746: <i>%% Client:       Transport = gen_tcp, Active = once</i>
<a name="45747"/>45747: <i>%% Message Size: large (=3)</i>
<a name="45748"/>45748: <i>%% Domain:       inet6</i>
<a name="45749"/>45749: <i>%% </i>
<a name="45750"/>45750: 
<a name="ttest_sgeno_cgeno_large_tcp6-1"/><a name="45751"/>45751: <b>ttest_sgeno_cgeno_large_tcp6</b>(Config) when is_list(Config) -&gt;
<a name="45752"/>45752:     Runtime = which_ttest_runtime(Config),
<a name="ttest_sgeno_cgeno_large_tcp6-last_expr"/><a name="45753"/>45753: <b>    ttest_tcp</b>(ttest_sgeno_cgeno_large_tcp6,
<a name="45754"/>45754:               Runtime,
<a name="45755"/>45755:               inet6,
<a name="45756"/>45756:               gen, once,
<a name="45757"/>45757:               gen, once,
<a name="45758"/>45758:               3, ttest_large_max_outstanding(Config)).
<a name="45759"/>45759: 
<a name="45760"/>45760: 
<a name="45761"/>45761: 
<a name="45762"/>45762: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="45763"/>45763: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="45764"/>45764: <i>%% ping-pong like test case.</i>
<a name="45765"/>45765: <i>%% Server:       Transport = gen_tcp, Active = once</i>
<a name="45766"/>45766: <i>%% Client:       Transport = gen_tcp, Active = true</i>
<a name="45767"/>45767: <i>%% Message Size: small (=1)</i>
<a name="45768"/>45768: <i>%% Domain:       inet</i>
<a name="45769"/>45769: <i>%%</i>
<a name="45770"/>45770: 
<a name="ttest_sgeno_cgent_small_tcp4-1"/><a name="45771"/>45771: <b>ttest_sgeno_cgent_small_tcp4</b>(Config) when is_list(Config) -&gt;
<a name="45772"/>45772:     Runtime = which_ttest_runtime(Config),
<a name="ttest_sgeno_cgent_small_tcp4-last_expr"/><a name="45773"/>45773: <b>    ttest_tcp</b>(ttest_sgeno_cgent_small_tcp4,
<a name="45774"/>45774:               Runtime,
<a name="45775"/>45775:               inet,
<a name="45776"/>45776:               gen, once,
<a name="45777"/>45777:               gen, true,
<a name="45778"/>45778:               1, ttest_small_max_outstanding(Config)).
<a name="45779"/>45779: 
<a name="45780"/>45780: 
<a name="45781"/>45781: 
<a name="45782"/>45782: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="45783"/>45783: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="45784"/>45784: <i>%% ping-pong like test case.</i>
<a name="45785"/>45785: <i>%% Server:       Transport = gen_tcp, Active = once</i>
<a name="45786"/>45786: <i>%% Client:       Transport = gen_tcp, Active = true</i>
<a name="45787"/>45787: <i>%% Message Size: small (=1)</i>
<a name="45788"/>45788: <i>%% Domain:       inet6</i>
<a name="45789"/>45789: <i>%% </i>
<a name="45790"/>45790: 
<a name="ttest_sgeno_cgent_small_tcp6-1"/><a name="45791"/>45791: <b>ttest_sgeno_cgent_small_tcp6</b>(Config) when is_list(Config) -&gt;
<a name="45792"/>45792:     Runtime = which_ttest_runtime(Config),
<a name="ttest_sgeno_cgent_small_tcp6-last_expr"/><a name="45793"/>45793: <b>    ttest_tcp</b>(ttest_sgeno_cgeno_small_tcp6,
<a name="45794"/>45794:               Runtime,
<a name="45795"/>45795:               inet6,
<a name="45796"/>45796:               gen, once,
<a name="45797"/>45797:               gen, true,
<a name="45798"/>45798:               1, ttest_small_max_outstanding(Config)).
<a name="45799"/>45799: 
<a name="45800"/>45800: 
<a name="45801"/>45801: 
<a name="45802"/>45802: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="45803"/>45803: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="45804"/>45804: <i>%% ping-pong like test case.</i>
<a name="45805"/>45805: <i>%% Server:       Transport = gen_tcp, Active = once</i>
<a name="45806"/>45806: <i>%% Client:       Transport = gen_tcp, Active = true</i>
<a name="45807"/>45807: <i>%% Message Size: medium (=2)</i>
<a name="45808"/>45808: <i>%% Domain:       inet</i>
<a name="45809"/>45809: <i>%%</i>
<a name="45810"/>45810: 
<a name="ttest_sgeno_cgent_medium_tcp4-1"/><a name="45811"/>45811: <b>ttest_sgeno_cgent_medium_tcp4</b>(Config) when is_list(Config) -&gt;
<a name="45812"/>45812:     Runtime = which_ttest_runtime(Config),
<a name="ttest_sgeno_cgent_medium_tcp4-last_expr"/><a name="45813"/>45813: <b>    ttest_tcp</b>(ttest_sgeno_cgent_medium_tcp4,
<a name="45814"/>45814:               Runtime,
<a name="45815"/>45815:               inet,
<a name="45816"/>45816:               gen, once,
<a name="45817"/>45817:               gen, true,
<a name="45818"/>45818:               2, ttest_medium_max_outstanding(Config)).
<a name="45819"/>45819: 
<a name="45820"/>45820: 
<a name="45821"/>45821: 
<a name="45822"/>45822: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="45823"/>45823: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="45824"/>45824: <i>%% ping-pong like test case.</i>
<a name="45825"/>45825: <i>%% Server:       Transport = gen_tcp, Active = once</i>
<a name="45826"/>45826: <i>%% Client:       Transport = gen_tcp, Active = true</i>
<a name="45827"/>45827: <i>%% Message Size: medium (=2)</i>
<a name="45828"/>45828: <i>%% Domain:       inet6</i>
<a name="45829"/>45829: <i>%% </i>
<a name="45830"/>45830: 
<a name="ttest_sgeno_cgent_medium_tcp6-1"/><a name="45831"/>45831: <b>ttest_sgeno_cgent_medium_tcp6</b>(Config) when is_list(Config) -&gt;
<a name="45832"/>45832:     Runtime = which_ttest_runtime(Config),
<a name="ttest_sgeno_cgent_medium_tcp6-last_expr"/><a name="45833"/>45833: <b>    ttest_tcp</b>(ttest_sgeno_cgent_medium_tcp6,
<a name="45834"/>45834:               Runtime,
<a name="45835"/>45835:               inet6,
<a name="45836"/>45836:               gen, once,
<a name="45837"/>45837:               gen, true,
<a name="45838"/>45838:               2, ttest_medium_max_outstanding(Config)).
<a name="45839"/>45839: 
<a name="45840"/>45840: 
<a name="45841"/>45841: 
<a name="45842"/>45842: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="45843"/>45843: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="45844"/>45844: <i>%% ping-pong like test case.</i>
<a name="45845"/>45845: <i>%% Server:       Transport = gen_tcp, Active = once</i>
<a name="45846"/>45846: <i>%% Client:       Transport = gen_tcp, Active = true</i>
<a name="45847"/>45847: <i>%% Message Size: large (=3)</i>
<a name="45848"/>45848: <i>%% Domain:       inet</i>
<a name="45849"/>45849: <i>%%</i>
<a name="45850"/>45850: 
<a name="ttest_sgeno_cgent_large_tcp4-1"/><a name="45851"/>45851: <b>ttest_sgeno_cgent_large_tcp4</b>(Config) when is_list(Config) -&gt;
<a name="45852"/>45852:     Runtime = which_ttest_runtime(Config),
<a name="ttest_sgeno_cgent_large_tcp4-last_expr"/><a name="45853"/>45853: <b>    ttest_tcp</b>(ttest_sgeno_cgent_large_tcp4,
<a name="45854"/>45854:               Runtime,
<a name="45855"/>45855:               inet,
<a name="45856"/>45856:               gen, once,
<a name="45857"/>45857:               gen, true,
<a name="45858"/>45858:               3, ttest_large_max_outstanding(Config)).
<a name="45859"/>45859: 
<a name="45860"/>45860: 
<a name="45861"/>45861: 
<a name="45862"/>45862: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="45863"/>45863: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="45864"/>45864: <i>%% ping-pong like test case.</i>
<a name="45865"/>45865: <i>%% Server:       Transport = gen_tcp, Active = once</i>
<a name="45866"/>45866: <i>%% Client:       Transport = gen_tcp, Active = true</i>
<a name="45867"/>45867: <i>%% Message Size: large (=3)</i>
<a name="45868"/>45868: <i>%% Domain:       inet6</i>
<a name="45869"/>45869: <i>%% </i>
<a name="45870"/>45870: 
<a name="ttest_sgeno_cgent_large_tcp6-1"/><a name="45871"/>45871: <b>ttest_sgeno_cgent_large_tcp6</b>(Config) when is_list(Config) -&gt;
<a name="45872"/>45872:     Runtime = which_ttest_runtime(Config),
<a name="ttest_sgeno_cgent_large_tcp6-last_expr"/><a name="45873"/>45873: <b>    ttest_tcp</b>(ttest_sgeno_cgent_large_tcp6,
<a name="45874"/>45874:               Runtime,
<a name="45875"/>45875:               inet6,
<a name="45876"/>45876:               gen, once,
<a name="45877"/>45877:               gen, true,
<a name="45878"/>45878:               3, ttest_large_max_outstanding(Config)).
<a name="45879"/>45879: 
<a name="45880"/>45880: 
<a name="45881"/>45881: 
<a name="45882"/>45882: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="45883"/>45883: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="45884"/>45884: <i>%% ping-pong like test case.</i>
<a name="45885"/>45885: <i>%% Server:       Transport = gen_tcp, Active = once</i>
<a name="45886"/>45886: <i>%% Client:       Transport = socket(tcp), Active = false</i>
<a name="45887"/>45887: <i>%% Message Size: small (=1)</i>
<a name="45888"/>45888: <i>%% Domain:       inet</i>
<a name="45889"/>45889: <i>%%</i>
<a name="45890"/>45890: 
<a name="ttest_sgeno_csockf_small_tcp4-1"/><a name="45891"/>45891: <b>ttest_sgeno_csockf_small_tcp4</b>(Config) when is_list(Config) -&gt;
<a name="45892"/>45892:     Runtime = which_ttest_runtime(Config),
<a name="ttest_sgeno_csockf_small_tcp4-last_expr"/><a name="45893"/>45893: <b>    ttest_tcp</b>(ttest_sgeno_csockf_small_tcp4,
<a name="45894"/>45894:               Runtime,
<a name="45895"/>45895:               inet,
<a name="45896"/>45896:               gen, once,
<a name="45897"/>45897:               sock, false,
<a name="45898"/>45898:               1, ttest_small_max_outstanding(Config)).
<a name="45899"/>45899: 
<a name="45900"/>45900: 
<a name="45901"/>45901: 
<a name="45902"/>45902: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="45903"/>45903: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="45904"/>45904: <i>%% ping-pong like test case.</i>
<a name="45905"/>45905: <i>%% Server:       Transport = gen_tcp, Active = once</i>
<a name="45906"/>45906: <i>%% Client:       Transport = socket(tcp), Active = false</i>
<a name="45907"/>45907: <i>%% Message Size: small (=1)</i>
<a name="45908"/>45908: <i>%% Domain:       inet6</i>
<a name="45909"/>45909: <i>%% </i>
<a name="45910"/>45910: 
<a name="ttest_sgeno_csockf_small_tcp6-1"/><a name="45911"/>45911: <b>ttest_sgeno_csockf_small_tcp6</b>(Config) when is_list(Config) -&gt;
<a name="45912"/>45912:     Runtime = which_ttest_runtime(Config),
<a name="ttest_sgeno_csockf_small_tcp6-last_expr"/><a name="45913"/>45913: <b>    ttest_tcp</b>(ttest_sgeno_csockf_small_tcp6,
<a name="45914"/>45914:               Runtime,
<a name="45915"/>45915:               inet6,
<a name="45916"/>45916:               gen, once,
<a name="45917"/>45917:               sock, false,
<a name="45918"/>45918:               1, ttest_small_max_outstanding(Config)).
<a name="45919"/>45919: 
<a name="45920"/>45920: 
<a name="45921"/>45921: 
<a name="45922"/>45922: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="45923"/>45923: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="45924"/>45924: <i>%% ping-pong like test case.</i>
<a name="45925"/>45925: <i>%% Server:       Transport = gen_tcp, Active = once</i>
<a name="45926"/>45926: <i>%% Client:       Transport = socket(tcp), Active = false</i>
<a name="45927"/>45927: <i>%% Message Size: medium (=2)</i>
<a name="45928"/>45928: <i>%% Domain:       inet</i>
<a name="45929"/>45929: <i>%%</i>
<a name="45930"/>45930: 
<a name="ttest_sgeno_csockf_medium_tcp4-1"/><a name="45931"/>45931: <b>ttest_sgeno_csockf_medium_tcp4</b>(Config) when is_list(Config) -&gt;
<a name="45932"/>45932:     Runtime = which_ttest_runtime(Config),
<a name="ttest_sgeno_csockf_medium_tcp4-last_expr"/><a name="45933"/>45933: <b>    ttest_tcp</b>(ttest_sgeno_csockf_medium_tcp4,
<a name="45934"/>45934:               Runtime,
<a name="45935"/>45935:               inet,
<a name="45936"/>45936:               gen, once,
<a name="45937"/>45937:               sock, false,
<a name="45938"/>45938:               2, ttest_medium_max_outstanding(Config)).
<a name="45939"/>45939: 
<a name="45940"/>45940: 
<a name="45941"/>45941: 
<a name="45942"/>45942: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="45943"/>45943: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="45944"/>45944: <i>%% ping-pong like test case.</i>
<a name="45945"/>45945: <i>%% Server:       Transport = gen_tcp, Active = once</i>
<a name="45946"/>45946: <i>%% Client:       Transport = socket(tcp), Active = false</i>
<a name="45947"/>45947: <i>%% Message Size: medium (=2)</i>
<a name="45948"/>45948: <i>%% Domain:       inet6</i>
<a name="45949"/>45949: <i>%% </i>
<a name="45950"/>45950: 
<a name="ttest_sgeno_csockf_medium_tcp6-1"/><a name="45951"/>45951: <b>ttest_sgeno_csockf_medium_tcp6</b>(Config) when is_list(Config) -&gt;
<a name="45952"/>45952:     Runtime = which_ttest_runtime(Config),
<a name="ttest_sgeno_csockf_medium_tcp6-last_expr"/><a name="45953"/>45953: <b>    ttest_tcp</b>(ttest_sgeno_csockf_medium_tcp6,
<a name="45954"/>45954:               Runtime,
<a name="45955"/>45955:               inet6,
<a name="45956"/>45956:               gen, once,
<a name="45957"/>45957:               sock, false,
<a name="45958"/>45958:               2, ttest_medium_max_outstanding(Config)).
<a name="45959"/>45959: 
<a name="45960"/>45960: 
<a name="45961"/>45961: 
<a name="45962"/>45962: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="45963"/>45963: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="45964"/>45964: <i>%% ping-pong like test case.</i>
<a name="45965"/>45965: <i>%% Server:       Transport = gen_tcp, Active = once</i>
<a name="45966"/>45966: <i>%% Client:       Transport = socket(tcp), Active = false</i>
<a name="45967"/>45967: <i>%% Message Size: large (=3)</i>
<a name="45968"/>45968: <i>%% Domain:       inet</i>
<a name="45969"/>45969: <i>%%</i>
<a name="45970"/>45970: 
<a name="ttest_sgeno_csockf_large_tcp4-1"/><a name="45971"/>45971: <b>ttest_sgeno_csockf_large_tcp4</b>(Config) when is_list(Config) -&gt;
<a name="45972"/>45972:     Runtime = which_ttest_runtime(Config),
<a name="ttest_sgeno_csockf_large_tcp4-last_expr"/><a name="45973"/>45973: <b>    ttest_tcp</b>(ttest_sgeno_csockf_large_tcp4,
<a name="45974"/>45974:               Runtime,
<a name="45975"/>45975:               inet,
<a name="45976"/>45976:               gen, once,
<a name="45977"/>45977:               sock, false,
<a name="45978"/>45978:               3, ttest_large_max_outstanding(Config)).
<a name="45979"/>45979: 
<a name="45980"/>45980: 
<a name="45981"/>45981: 
<a name="45982"/>45982: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="45983"/>45983: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="45984"/>45984: <i>%% ping-pong like test case.</i>
<a name="45985"/>45985: <i>%% Server:       Transport = gen_tcp, Active = once</i>
<a name="45986"/>45986: <i>%% Client:       Transport = socket(tcp), Active = false</i>
<a name="45987"/>45987: <i>%% Message Size: large (=3)</i>
<a name="45988"/>45988: <i>%% Domain:       inet6</i>
<a name="45989"/>45989: <i>%% </i>
<a name="45990"/>45990: 
<a name="ttest_sgeno_csockf_large_tcp6-1"/><a name="45991"/>45991: <b>ttest_sgeno_csockf_large_tcp6</b>(Config) when is_list(Config) -&gt;
<a name="45992"/>45992:     Runtime = which_ttest_runtime(Config),
<a name="ttest_sgeno_csockf_large_tcp6-last_expr"/><a name="45993"/>45993: <b>    ttest_tcp</b>(ttest_sgeno_csockf_large_tcp6,
<a name="45994"/>45994:               Runtime,
<a name="45995"/>45995:               inet6,
<a name="45996"/>45996:               gen, once,
<a name="45997"/>45997:               sock, false,
<a name="45998"/>45998:               3, ttest_large_max_outstanding(Config)).
<a name="45999"/>45999: 
<a name="46000"/>46000: 
<a name="46001"/>46001: 
<a name="46002"/>46002: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="46003"/>46003: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="46004"/>46004: <i>%% ping-pong like test case.</i>
<a name="46005"/>46005: <i>%% Server:       Transport = gen_tcp, Active = once</i>
<a name="46006"/>46006: <i>%% Client:       Transport = socket(tcp), Active = once</i>
<a name="46007"/>46007: <i>%% Message Size: small (=1)</i>
<a name="46008"/>46008: <i>%% Domain:       inet</i>
<a name="46009"/>46009: <i>%%</i>
<a name="46010"/>46010: 
<a name="ttest_sgeno_csocko_small_tcp4-1"/><a name="46011"/>46011: <b>ttest_sgeno_csocko_small_tcp4</b>(Config) when is_list(Config) -&gt;
<a name="46012"/>46012:     Runtime = which_ttest_runtime(Config),
<a name="ttest_sgeno_csocko_small_tcp4-last_expr"/><a name="46013"/>46013: <b>    ttest_tcp</b>(ttest_sgeno_csocko_small_tcp4,
<a name="46014"/>46014:               Runtime,
<a name="46015"/>46015:               inet,
<a name="46016"/>46016:               gen, once,
<a name="46017"/>46017:               sock, once,
<a name="46018"/>46018:               1, ttest_small_max_outstanding(Config)).
<a name="46019"/>46019: 
<a name="46020"/>46020: 
<a name="46021"/>46021: 
<a name="46022"/>46022: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="46023"/>46023: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="46024"/>46024: <i>%% ping-pong like test case.</i>
<a name="46025"/>46025: <i>%% Server:       Transport = gen_tcp, Active = once</i>
<a name="46026"/>46026: <i>%% Client:       Transport = socket(tcp), Active = once</i>
<a name="46027"/>46027: <i>%% Message Size: small (=1)</i>
<a name="46028"/>46028: <i>%% Domain:       inet6</i>
<a name="46029"/>46029: <i>%% </i>
<a name="46030"/>46030: 
<a name="ttest_sgeno_csocko_small_tcp6-1"/><a name="46031"/>46031: <b>ttest_sgeno_csocko_small_tcp6</b>(Config) when is_list(Config) -&gt;
<a name="46032"/>46032:     Runtime = which_ttest_runtime(Config),
<a name="ttest_sgeno_csocko_small_tcp6-last_expr"/><a name="46033"/>46033: <b>    ttest_tcp</b>(ttest_sgeno_csocko_small_tcp6,
<a name="46034"/>46034:               Runtime,
<a name="46035"/>46035:               inet6,
<a name="46036"/>46036:               gen, once,
<a name="46037"/>46037:               sock, once,
<a name="46038"/>46038:               1, ttest_small_max_outstanding(Config)).
<a name="46039"/>46039: 
<a name="46040"/>46040: 
<a name="46041"/>46041: 
<a name="46042"/>46042: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="46043"/>46043: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="46044"/>46044: <i>%% ping-pong like test case.</i>
<a name="46045"/>46045: <i>%% Server:       Transport = gen_tcp, Active = once</i>
<a name="46046"/>46046: <i>%% Client:       Transport = socket(tcp), Active = once</i>
<a name="46047"/>46047: <i>%% Message Size: medium (=2)</i>
<a name="46048"/>46048: <i>%% Domain:       inet</i>
<a name="46049"/>46049: <i>%%</i>
<a name="46050"/>46050: 
<a name="ttest_sgeno_csocko_medium_tcp4-1"/><a name="46051"/>46051: <b>ttest_sgeno_csocko_medium_tcp4</b>(Config) when is_list(Config) -&gt;
<a name="46052"/>46052:     Runtime = which_ttest_runtime(Config),
<a name="ttest_sgeno_csocko_medium_tcp4-last_expr"/><a name="46053"/>46053: <b>    ttest_tcp</b>(ttest_sgeno_csocko_medium_tcp4,
<a name="46054"/>46054:               Runtime,
<a name="46055"/>46055:               inet,
<a name="46056"/>46056:               gen, once,
<a name="46057"/>46057:               sock, once,
<a name="46058"/>46058:               2, ttest_medium_max_outstanding(Config)).
<a name="46059"/>46059: 
<a name="46060"/>46060: 
<a name="46061"/>46061: 
<a name="46062"/>46062: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="46063"/>46063: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="46064"/>46064: <i>%% ping-pong like test case.</i>
<a name="46065"/>46065: <i>%% Server:       Transport = gen_tcp, Active = once</i>
<a name="46066"/>46066: <i>%% Client:       Transport = socket(tcp), Active = once</i>
<a name="46067"/>46067: <i>%% Message Size: medium (=2)</i>
<a name="46068"/>46068: <i>%% Domain:       inet6</i>
<a name="46069"/>46069: <i>%% </i>
<a name="46070"/>46070: 
<a name="ttest_sgeno_csocko_medium_tcp6-1"/><a name="46071"/>46071: <b>ttest_sgeno_csocko_medium_tcp6</b>(Config) when is_list(Config) -&gt;
<a name="46072"/>46072:     Runtime = which_ttest_runtime(Config),
<a name="ttest_sgeno_csocko_medium_tcp6-last_expr"/><a name="46073"/>46073: <b>    ttest_tcp</b>(ttest_sgeno_csocko_medium_tcp6,
<a name="46074"/>46074:               Runtime,
<a name="46075"/>46075:               inet6,
<a name="46076"/>46076:               gen, once,
<a name="46077"/>46077:               sock, once,
<a name="46078"/>46078:               2, ttest_medium_max_outstanding(Config)).
<a name="46079"/>46079: 
<a name="46080"/>46080: 
<a name="46081"/>46081: 
<a name="46082"/>46082: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="46083"/>46083: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="46084"/>46084: <i>%% ping-pong like test case.</i>
<a name="46085"/>46085: <i>%% Server:       Transport = gen_tcp, Active = once</i>
<a name="46086"/>46086: <i>%% Client:       Transport = socket(tcp), Active = once</i>
<a name="46087"/>46087: <i>%% Message Size: large (=3)</i>
<a name="46088"/>46088: <i>%% Domain:       inet</i>
<a name="46089"/>46089: <i>%%</i>
<a name="46090"/>46090: 
<a name="ttest_sgeno_csocko_large_tcp4-1"/><a name="46091"/>46091: <b>ttest_sgeno_csocko_large_tcp4</b>(Config) when is_list(Config) -&gt;
<a name="46092"/>46092:     Runtime = which_ttest_runtime(Config),
<a name="ttest_sgeno_csocko_large_tcp4-last_expr"/><a name="46093"/>46093: <b>    ttest_tcp</b>(ttest_sgeno_csocko_large_tcp4,
<a name="46094"/>46094:               Runtime,
<a name="46095"/>46095:               inet,
<a name="46096"/>46096:               gen, once,
<a name="46097"/>46097:               sock, once,
<a name="46098"/>46098:               3, ttest_large_max_outstanding(Config)).
<a name="46099"/>46099: 
<a name="46100"/>46100: 
<a name="46101"/>46101: 
<a name="46102"/>46102: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="46103"/>46103: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="46104"/>46104: <i>%% ping-pong like test case.</i>
<a name="46105"/>46105: <i>%% Server:       Transport = gen_tcp, Active = once</i>
<a name="46106"/>46106: <i>%% Client:       Transport = socket(tcp), Active = once</i>
<a name="46107"/>46107: <i>%% Message Size: large (=3)</i>
<a name="46108"/>46108: <i>%% Domain:       inet6</i>
<a name="46109"/>46109: <i>%% </i>
<a name="46110"/>46110: 
<a name="ttest_sgeno_csocko_large_tcp6-1"/><a name="46111"/>46111: <b>ttest_sgeno_csocko_large_tcp6</b>(Config) when is_list(Config) -&gt;
<a name="46112"/>46112:     Runtime = which_ttest_runtime(Config),
<a name="ttest_sgeno_csocko_large_tcp6-last_expr"/><a name="46113"/>46113: <b>    ttest_tcp</b>(ttest_sgeno_csocko_large_tcp6,
<a name="46114"/>46114:               Runtime,
<a name="46115"/>46115:               inet6,
<a name="46116"/>46116:               gen, once,
<a name="46117"/>46117:               sock, once,
<a name="46118"/>46118:               3, ttest_large_max_outstanding(Config)).
<a name="46119"/>46119: 
<a name="46120"/>46120: 
<a name="46121"/>46121: 
<a name="46122"/>46122: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="46123"/>46123: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="46124"/>46124: <i>%% ping-pong like test case.</i>
<a name="46125"/>46125: <i>%% Server:       Transport = gen_tcp, Active = once</i>
<a name="46126"/>46126: <i>%% Client:       Transport = socket(tcp), Active = true</i>
<a name="46127"/>46127: <i>%% Message Size: small (=1)</i>
<a name="46128"/>46128: <i>%% Domain:       inet</i>
<a name="46129"/>46129: <i>%%</i>
<a name="46130"/>46130: 
<a name="ttest_sgeno_csockt_small_tcp4-1"/><a name="46131"/>46131: <b>ttest_sgeno_csockt_small_tcp4</b>(Config) when is_list(Config) -&gt;
<a name="46132"/>46132:     Runtime = which_ttest_runtime(Config),
<a name="ttest_sgeno_csockt_small_tcp4-last_expr"/><a name="46133"/>46133: <b>    ttest_tcp</b>(ttest_sgeno_csockt_small_tcp4,
<a name="46134"/>46134:               Runtime,
<a name="46135"/>46135:               inet,
<a name="46136"/>46136:               gen, once,
<a name="46137"/>46137:               sock, true,
<a name="46138"/>46138:               1, ttest_small_max_outstanding(Config)).
<a name="46139"/>46139: 
<a name="46140"/>46140: 
<a name="46141"/>46141: 
<a name="46142"/>46142: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="46143"/>46143: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="46144"/>46144: <i>%% ping-pong like test case.</i>
<a name="46145"/>46145: <i>%% Server:       Transport = gen_tcp, Active = once</i>
<a name="46146"/>46146: <i>%% Client:       Transport = socket(tcp), Active = true</i>
<a name="46147"/>46147: <i>%% Message Size: small (=1)</i>
<a name="46148"/>46148: <i>%% Domain:       inet6</i>
<a name="46149"/>46149: <i>%% </i>
<a name="46150"/>46150: 
<a name="ttest_sgeno_csockt_small_tcp6-1"/><a name="46151"/>46151: <b>ttest_sgeno_csockt_small_tcp6</b>(Config) when is_list(Config) -&gt;
<a name="46152"/>46152:     Runtime = which_ttest_runtime(Config),
<a name="ttest_sgeno_csockt_small_tcp6-last_expr"/><a name="46153"/>46153: <b>    ttest_tcp</b>(ttest_sgeno_csocko_small_tcp6,
<a name="46154"/>46154:               Runtime,
<a name="46155"/>46155:               inet6,
<a name="46156"/>46156:               gen, once,
<a name="46157"/>46157:               sock, true,
<a name="46158"/>46158:               1, ttest_small_max_outstanding(Config)).
<a name="46159"/>46159: 
<a name="46160"/>46160: 
<a name="46161"/>46161: 
<a name="46162"/>46162: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="46163"/>46163: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="46164"/>46164: <i>%% ping-pong like test case.</i>
<a name="46165"/>46165: <i>%% Server:       Transport = gen_tcp, Active = once</i>
<a name="46166"/>46166: <i>%% Client:       Transport = socket(tcp), Active = true</i>
<a name="46167"/>46167: <i>%% Message Size: medium (=2)</i>
<a name="46168"/>46168: <i>%% Domain:       inet</i>
<a name="46169"/>46169: <i>%%</i>
<a name="46170"/>46170: 
<a name="ttest_sgeno_csockt_medium_tcp4-1"/><a name="46171"/>46171: <b>ttest_sgeno_csockt_medium_tcp4</b>(Config) when is_list(Config) -&gt;
<a name="46172"/>46172:     Runtime = which_ttest_runtime(Config),
<a name="ttest_sgeno_csockt_medium_tcp4-last_expr"/><a name="46173"/>46173: <b>    ttest_tcp</b>(ttest_sgeno_csockt_medium_tcp4,
<a name="46174"/>46174:               Runtime,
<a name="46175"/>46175:               inet,
<a name="46176"/>46176:               gen, once,
<a name="46177"/>46177:               sock, true,
<a name="46178"/>46178:               2, ttest_medium_max_outstanding(Config)).
<a name="46179"/>46179: 
<a name="46180"/>46180: 
<a name="46181"/>46181: 
<a name="46182"/>46182: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="46183"/>46183: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="46184"/>46184: <i>%% ping-pong like test case.</i>
<a name="46185"/>46185: <i>%% Server:       Transport = gen_tcp, Active = once</i>
<a name="46186"/>46186: <i>%% Client:       Transport = socket(tcp), Active = true</i>
<a name="46187"/>46187: <i>%% Message Size: medium (=2)</i>
<a name="46188"/>46188: <i>%% Domain:       inet6</i>
<a name="46189"/>46189: <i>%% </i>
<a name="46190"/>46190: 
<a name="ttest_sgeno_csockt_medium_tcp6-1"/><a name="46191"/>46191: <b>ttest_sgeno_csockt_medium_tcp6</b>(Config) when is_list(Config) -&gt;
<a name="46192"/>46192:     Runtime = which_ttest_runtime(Config),
<a name="ttest_sgeno_csockt_medium_tcp6-last_expr"/><a name="46193"/>46193: <b>    ttest_tcp</b>(ttest_sgeno_csockt_medium_tcp6,
<a name="46194"/>46194:               Runtime,
<a name="46195"/>46195:               inet6,
<a name="46196"/>46196:               gen, once,
<a name="46197"/>46197:               sock, true,
<a name="46198"/>46198:               2, ttest_medium_max_outstanding(Config)).
<a name="46199"/>46199: 
<a name="46200"/>46200: 
<a name="46201"/>46201: 
<a name="46202"/>46202: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="46203"/>46203: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="46204"/>46204: <i>%% ping-pong like test case.</i>
<a name="46205"/>46205: <i>%% Server:       Transport = gen_tcp, Active = once</i>
<a name="46206"/>46206: <i>%% Client:       Transport = socket(tcp), Active = true</i>
<a name="46207"/>46207: <i>%% Message Size: large (=3)</i>
<a name="46208"/>46208: <i>%% Domain:       inet</i>
<a name="46209"/>46209: <i>%%</i>
<a name="46210"/>46210: 
<a name="ttest_sgeno_csockt_large_tcp4-1"/><a name="46211"/>46211: <b>ttest_sgeno_csockt_large_tcp4</b>(Config) when is_list(Config) -&gt;
<a name="46212"/>46212:     Runtime = which_ttest_runtime(Config),
<a name="ttest_sgeno_csockt_large_tcp4-last_expr"/><a name="46213"/>46213: <b>    ttest_tcp</b>(ttest_sgeno_csockt_large_tcp4,
<a name="46214"/>46214:               Runtime,
<a name="46215"/>46215:               inet,
<a name="46216"/>46216:               gen, once,
<a name="46217"/>46217:               sock, true,
<a name="46218"/>46218:               3, ttest_large_max_outstanding(Config)).
<a name="46219"/>46219: 
<a name="46220"/>46220: 
<a name="46221"/>46221: 
<a name="46222"/>46222: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="46223"/>46223: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="46224"/>46224: <i>%% ping-pong like test case.</i>
<a name="46225"/>46225: <i>%% Server:       Transport = gen_tcp, Active = once</i>
<a name="46226"/>46226: <i>%% Client:       Transport = socket(tcp), Active = true</i>
<a name="46227"/>46227: <i>%% Message Size: large (=3)</i>
<a name="46228"/>46228: <i>%% Domain:       inet6</i>
<a name="46229"/>46229: <i>%% </i>
<a name="46230"/>46230: 
<a name="ttest_sgeno_csockt_large_tcp6-1"/><a name="46231"/>46231: <b>ttest_sgeno_csockt_large_tcp6</b>(Config) when is_list(Config) -&gt;
<a name="46232"/>46232:     Runtime = which_ttest_runtime(Config),
<a name="ttest_sgeno_csockt_large_tcp6-last_expr"/><a name="46233"/>46233: <b>    ttest_tcp</b>(ttest_sgeno_csockt_large_tcp6,
<a name="46234"/>46234:               Runtime,
<a name="46235"/>46235:               inet6,
<a name="46236"/>46236:               gen, once,
<a name="46237"/>46237:               sock, true,
<a name="46238"/>46238:               3, ttest_large_max_outstanding(Config)).
<a name="46239"/>46239: 
<a name="46240"/>46240: 
<a name="46241"/>46241: 
<a name="46242"/>46242: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="46243"/>46243: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="46244"/>46244: <i>%% ping-pong like test case.</i>
<a name="46245"/>46245: <i>%% Server:       Transport = gen_tcp, Active = true</i>
<a name="46246"/>46246: <i>%% Client:       Transport = gen_tcp, Active = false</i>
<a name="46247"/>46247: <i>%% Message Size: small (=1)</i>
<a name="46248"/>46248: <i>%% Domain:       inet</i>
<a name="46249"/>46249: <i>%%</i>
<a name="46250"/>46250: 
<a name="ttest_sgent_cgenf_small_tcp4-1"/><a name="46251"/>46251: <b>ttest_sgent_cgenf_small_tcp4</b>(Config) when is_list(Config) -&gt;
<a name="46252"/>46252:     Runtime = which_ttest_runtime(Config),
<a name="ttest_sgent_cgenf_small_tcp4-last_expr"/><a name="46253"/>46253: <b>    ttest_tcp</b>(ttest_sgent_cgenf_small_tcp4,
<a name="46254"/>46254:               Runtime,
<a name="46255"/>46255:               inet,
<a name="46256"/>46256:               gen, true,
<a name="46257"/>46257:               gen, false,
<a name="46258"/>46258:               1, ttest_small_max_outstanding(Config)).
<a name="46259"/>46259: 
<a name="46260"/>46260: 
<a name="46261"/>46261: 
<a name="46262"/>46262: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="46263"/>46263: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="46264"/>46264: <i>%% ping-pong like test case.</i>
<a name="46265"/>46265: <i>%% Server:       Transport = gen_tcp, Active = true</i>
<a name="46266"/>46266: <i>%% Client:       Transport = gen_tcp, Active = false</i>
<a name="46267"/>46267: <i>%% Message Size: small (=1)</i>
<a name="46268"/>46268: <i>%% Domain:       inet6</i>
<a name="46269"/>46269: <i>%% </i>
<a name="46270"/>46270: 
<a name="ttest_sgent_cgenf_small_tcp6-1"/><a name="46271"/>46271: <b>ttest_sgent_cgenf_small_tcp6</b>(Config) when is_list(Config) -&gt;
<a name="46272"/>46272:     Runtime = which_ttest_runtime(Config),
<a name="ttest_sgent_cgenf_small_tcp6-last_expr"/><a name="46273"/>46273: <b>    ttest_tcp</b>(ttest_sgent_cgenf_small_tcp6,
<a name="46274"/>46274:               Runtime,
<a name="46275"/>46275:               inet6,
<a name="46276"/>46276:               gen, true,
<a name="46277"/>46277:               gen, false,
<a name="46278"/>46278:               1, ttest_small_max_outstanding(Config)).
<a name="46279"/>46279: 
<a name="46280"/>46280: 
<a name="46281"/>46281: 
<a name="46282"/>46282: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="46283"/>46283: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="46284"/>46284: <i>%% ping-pong like test case.</i>
<a name="46285"/>46285: <i>%% Server:       Transport = gen_tcp, Active = true</i>
<a name="46286"/>46286: <i>%% Client:       Transport = gen_tcp, Active = false</i>
<a name="46287"/>46287: <i>%% Message Size: medium (=2)</i>
<a name="46288"/>46288: <i>%% Domain:       inet</i>
<a name="46289"/>46289: <i>%%</i>
<a name="46290"/>46290: 
<a name="ttest_sgent_cgenf_medium_tcp4-1"/><a name="46291"/>46291: <b>ttest_sgent_cgenf_medium_tcp4</b>(Config) when is_list(Config) -&gt;
<a name="46292"/>46292:     Runtime = which_ttest_runtime(Config),
<a name="ttest_sgent_cgenf_medium_tcp4-last_expr"/><a name="46293"/>46293: <b>    ttest_tcp</b>(ttest_sgent_cgenf_medium_tcp4,
<a name="46294"/>46294:               Runtime,
<a name="46295"/>46295:               inet,
<a name="46296"/>46296:               gen, true,
<a name="46297"/>46297:               gen, false,
<a name="46298"/>46298:               2, ttest_medium_max_outstanding(Config)).
<a name="46299"/>46299: 
<a name="46300"/>46300: 
<a name="46301"/>46301: 
<a name="46302"/>46302: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="46303"/>46303: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="46304"/>46304: <i>%% ping-pong like test case.</i>
<a name="46305"/>46305: <i>%% Server:       Transport = gen_tcp, Active = true</i>
<a name="46306"/>46306: <i>%% Client:       Transport = gen_tcp, Active = false</i>
<a name="46307"/>46307: <i>%% Message Size: medium (=2)</i>
<a name="46308"/>46308: <i>%% Domain:       inet6</i>
<a name="46309"/>46309: <i>%% </i>
<a name="46310"/>46310: 
<a name="ttest_sgent_cgenf_medium_tcp6-1"/><a name="46311"/>46311: <b>ttest_sgent_cgenf_medium_tcp6</b>(Config) when is_list(Config) -&gt;
<a name="46312"/>46312:     Runtime = which_ttest_runtime(Config),
<a name="ttest_sgent_cgenf_medium_tcp6-last_expr"/><a name="46313"/>46313: <b>    ttest_tcp</b>(ttest_sgent_cgenf_medium_tcp6,
<a name="46314"/>46314:               Runtime,
<a name="46315"/>46315:               inet6,
<a name="46316"/>46316:               gen, true,
<a name="46317"/>46317:               gen, false,
<a name="46318"/>46318:               2, ttest_medium_max_outstanding(Config)).
<a name="46319"/>46319: 
<a name="46320"/>46320: 
<a name="46321"/>46321: 
<a name="46322"/>46322: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="46323"/>46323: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="46324"/>46324: <i>%% ping-pong like test case.</i>
<a name="46325"/>46325: <i>%% Server:       Transport = gen_tcp, Active = true</i>
<a name="46326"/>46326: <i>%% Client:       Transport = gen_tcp, Active = false</i>
<a name="46327"/>46327: <i>%% Message Size: large (=3)</i>
<a name="46328"/>46328: <i>%% Domain:       inet</i>
<a name="46329"/>46329: <i>%%</i>
<a name="46330"/>46330: 
<a name="ttest_sgent_cgenf_large_tcp4-1"/><a name="46331"/>46331: <b>ttest_sgent_cgenf_large_tcp4</b>(Config) when is_list(Config) -&gt;
<a name="46332"/>46332:     Runtime = which_ttest_runtime(Config),
<a name="ttest_sgent_cgenf_large_tcp4-last_expr"/><a name="46333"/>46333: <b>    ttest_tcp</b>(ttest_sgent_cgenf_large_tcp4,
<a name="46334"/>46334:               Runtime,
<a name="46335"/>46335:               inet,
<a name="46336"/>46336:               gen, true,
<a name="46337"/>46337:               gen, false,
<a name="46338"/>46338:               3, ttest_large_max_outstanding(Config)).
<a name="46339"/>46339: 
<a name="46340"/>46340: 
<a name="46341"/>46341: 
<a name="46342"/>46342: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="46343"/>46343: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="46344"/>46344: <i>%% ping-pong like test case.</i>
<a name="46345"/>46345: <i>%% Server:       Transport = gen_tcp, Active = true</i>
<a name="46346"/>46346: <i>%% Client:       Transport = gen_tcp, Active = false</i>
<a name="46347"/>46347: <i>%% Message Size: large (=3)</i>
<a name="46348"/>46348: <i>%% Domain:       inet6</i>
<a name="46349"/>46349: <i>%% </i>
<a name="46350"/>46350: 
<a name="ttest_sgent_cgenf_large_tcp6-1"/><a name="46351"/>46351: <b>ttest_sgent_cgenf_large_tcp6</b>(Config) when is_list(Config) -&gt;
<a name="46352"/>46352:     Runtime = which_ttest_runtime(Config),
<a name="ttest_sgent_cgenf_large_tcp6-last_expr"/><a name="46353"/>46353: <b>    ttest_tcp</b>(ttest_sgent_cgenf_large_tcp6,
<a name="46354"/>46354:               Runtime,
<a name="46355"/>46355:               inet6,
<a name="46356"/>46356:               gen, true,
<a name="46357"/>46357:               gen, false,
<a name="46358"/>46358:               3, ttest_large_max_outstanding(Config)).
<a name="46359"/>46359: 
<a name="46360"/>46360: 
<a name="46361"/>46361: 
<a name="46362"/>46362: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="46363"/>46363: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="46364"/>46364: <i>%% ping-pong like test case.</i>
<a name="46365"/>46365: <i>%% Server:       Transport = gen_tcp, Active = true</i>
<a name="46366"/>46366: <i>%% Client:       Transport = gen_tcp, Active = once</i>
<a name="46367"/>46367: <i>%% Message Size: small (=1)</i>
<a name="46368"/>46368: <i>%% Domain:       inet</i>
<a name="46369"/>46369: <i>%%</i>
<a name="46370"/>46370: 
<a name="ttest_sgent_cgeno_small_tcp4-1"/><a name="46371"/>46371: <b>ttest_sgent_cgeno_small_tcp4</b>(Config) when is_list(Config) -&gt;
<a name="46372"/>46372:     Runtime = which_ttest_runtime(Config),
<a name="ttest_sgent_cgeno_small_tcp4-last_expr"/><a name="46373"/>46373: <b>    ttest_tcp</b>(ttest_sgent_cgeno_small_tcp4,
<a name="46374"/>46374:               Runtime,
<a name="46375"/>46375:               inet,
<a name="46376"/>46376:               gen, true,
<a name="46377"/>46377:               gen, once,
<a name="46378"/>46378:               1, ttest_small_max_outstanding(Config)).
<a name="46379"/>46379: 
<a name="46380"/>46380: 
<a name="46381"/>46381: 
<a name="46382"/>46382: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="46383"/>46383: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="46384"/>46384: <i>%% ping-pong like test case.</i>
<a name="46385"/>46385: <i>%% Server:       Transport = gen_tcp, Active = true</i>
<a name="46386"/>46386: <i>%% Client:       Transport = gen_tcp, Active = once</i>
<a name="46387"/>46387: <i>%% Message Size: small (=1)</i>
<a name="46388"/>46388: <i>%% Domain:       inet6</i>
<a name="46389"/>46389: <i>%% </i>
<a name="46390"/>46390: 
<a name="ttest_sgent_cgeno_small_tcp6-1"/><a name="46391"/>46391: <b>ttest_sgent_cgeno_small_tcp6</b>(Config) when is_list(Config) -&gt;
<a name="46392"/>46392:     Runtime = which_ttest_runtime(Config),
<a name="ttest_sgent_cgeno_small_tcp6-last_expr"/><a name="46393"/>46393: <b>    ttest_tcp</b>(ttest_sgent_cgeno_small_tcp6,
<a name="46394"/>46394:               Runtime,
<a name="46395"/>46395:               inet6,
<a name="46396"/>46396:               gen, true,
<a name="46397"/>46397:               gen, once,
<a name="46398"/>46398:               1, ttest_small_max_outstanding(Config)).
<a name="46399"/>46399: 
<a name="46400"/>46400: 
<a name="46401"/>46401: 
<a name="46402"/>46402: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="46403"/>46403: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="46404"/>46404: <i>%% ping-pong like test case.</i>
<a name="46405"/>46405: <i>%% Server:       Transport = gen_tcp, Active = true</i>
<a name="46406"/>46406: <i>%% Client:       Transport = gen_tcp, Active = once</i>
<a name="46407"/>46407: <i>%% Message Size: medium (=2)</i>
<a name="46408"/>46408: <i>%% Domain:       inet</i>
<a name="46409"/>46409: <i>%%</i>
<a name="46410"/>46410: 
<a name="ttest_sgent_cgeno_medium_tcp4-1"/><a name="46411"/>46411: <b>ttest_sgent_cgeno_medium_tcp4</b>(Config) when is_list(Config) -&gt;
<a name="46412"/>46412:     Runtime = which_ttest_runtime(Config),
<a name="ttest_sgent_cgeno_medium_tcp4-last_expr"/><a name="46413"/>46413: <b>    ttest_tcp</b>(ttest_sgent_cgeno_medium_tcp4,
<a name="46414"/>46414:               Runtime,
<a name="46415"/>46415:               inet,
<a name="46416"/>46416:               gen, true,
<a name="46417"/>46417:               gen, once,
<a name="46418"/>46418:               2, ttest_medium_max_outstanding(Config)).
<a name="46419"/>46419: 
<a name="46420"/>46420: 
<a name="46421"/>46421: 
<a name="46422"/>46422: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="46423"/>46423: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="46424"/>46424: <i>%% ping-pong like test case.</i>
<a name="46425"/>46425: <i>%% Server:       Transport = gen_tcp, Active = true</i>
<a name="46426"/>46426: <i>%% Client:       Transport = gen_tcp, Active = once</i>
<a name="46427"/>46427: <i>%% Message Size: medium (=2)</i>
<a name="46428"/>46428: <i>%% Domain:       inet6</i>
<a name="46429"/>46429: <i>%% </i>
<a name="46430"/>46430: 
<a name="ttest_sgent_cgeno_medium_tcp6-1"/><a name="46431"/>46431: <b>ttest_sgent_cgeno_medium_tcp6</b>(Config) when is_list(Config) -&gt;
<a name="46432"/>46432:     Runtime = which_ttest_runtime(Config),
<a name="ttest_sgent_cgeno_medium_tcp6-last_expr"/><a name="46433"/>46433: <b>    ttest_tcp</b>(ttest_sgent_cgeno_medium_tcp6,
<a name="46434"/>46434:               Runtime,
<a name="46435"/>46435:               inet6,
<a name="46436"/>46436:               gen, true,
<a name="46437"/>46437:               gen, once,
<a name="46438"/>46438:               2, ttest_medium_max_outstanding(Config)).
<a name="46439"/>46439: 
<a name="46440"/>46440: 
<a name="46441"/>46441: 
<a name="46442"/>46442: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="46443"/>46443: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="46444"/>46444: <i>%% ping-pong like test case.</i>
<a name="46445"/>46445: <i>%% Server:       Transport = gen_tcp, Active = true</i>
<a name="46446"/>46446: <i>%% Client:       Transport = gen_tcp, Active = once</i>
<a name="46447"/>46447: <i>%% Message Size: large (=3)</i>
<a name="46448"/>46448: <i>%% Domain:       inet</i>
<a name="46449"/>46449: <i>%%</i>
<a name="46450"/>46450: 
<a name="ttest_sgent_cgeno_large_tcp4-1"/><a name="46451"/>46451: <b>ttest_sgent_cgeno_large_tcp4</b>(Config) when is_list(Config) -&gt;
<a name="46452"/>46452:     Runtime = which_ttest_runtime(Config),
<a name="ttest_sgent_cgeno_large_tcp4-last_expr"/><a name="46453"/>46453: <b>    ttest_tcp</b>(ttest_sgent_cgeno_large_tcp4,
<a name="46454"/>46454:               Runtime,
<a name="46455"/>46455:               inet,
<a name="46456"/>46456:               gen, true,
<a name="46457"/>46457:               gen, once,
<a name="46458"/>46458:               3, ttest_large_max_outstanding(Config)).
<a name="46459"/>46459: 
<a name="46460"/>46460: 
<a name="46461"/>46461: 
<a name="46462"/>46462: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="46463"/>46463: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="46464"/>46464: <i>%% ping-pong like test case.</i>
<a name="46465"/>46465: <i>%% Server:       Transport = gen_tcp, Active = true</i>
<a name="46466"/>46466: <i>%% Client:       Transport = gen_tcp, Active = once</i>
<a name="46467"/>46467: <i>%% Message Size: large (=3)</i>
<a name="46468"/>46468: <i>%% Domain:       inet6</i>
<a name="46469"/>46469: <i>%% </i>
<a name="46470"/>46470: 
<a name="ttest_sgent_cgeno_large_tcp6-1"/><a name="46471"/>46471: <b>ttest_sgent_cgeno_large_tcp6</b>(Config) when is_list(Config) -&gt;
<a name="46472"/>46472:     Runtime = which_ttest_runtime(Config),
<a name="ttest_sgent_cgeno_large_tcp6-last_expr"/><a name="46473"/>46473: <b>    ttest_tcp</b>(ttest_sgent_cgeno_large_tcp6,
<a name="46474"/>46474:               Runtime,
<a name="46475"/>46475:               inet6,
<a name="46476"/>46476:               gen, true,
<a name="46477"/>46477:               gen, once,
<a name="46478"/>46478:               3, ttest_large_max_outstanding(Config)).
<a name="46479"/>46479: 
<a name="46480"/>46480: 
<a name="46481"/>46481: 
<a name="46482"/>46482: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="46483"/>46483: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="46484"/>46484: <i>%% ping-pong like test case.</i>
<a name="46485"/>46485: <i>%% Server:       Transport = gen_tcp, Active = true</i>
<a name="46486"/>46486: <i>%% Client:       Transport = gen_tcp, Active = true</i>
<a name="46487"/>46487: <i>%% Message Size: small (=1)</i>
<a name="46488"/>46488: <i>%% Domain:       inet</i>
<a name="46489"/>46489: <i>%%</i>
<a name="46490"/>46490: 
<a name="ttest_sgent_cgent_small_tcp4-1"/><a name="46491"/>46491: <b>ttest_sgent_cgent_small_tcp4</b>(Config) when is_list(Config) -&gt;
<a name="46492"/>46492:     Runtime = which_ttest_runtime(Config),
<a name="ttest_sgent_cgent_small_tcp4-last_expr"/><a name="46493"/>46493: <b>    ttest_tcp</b>(ttest_sgent_cgent_small_tcp4,
<a name="46494"/>46494:               Runtime,
<a name="46495"/>46495:               inet,
<a name="46496"/>46496:               gen, true,
<a name="46497"/>46497:               gen, true,
<a name="46498"/>46498:               1, ttest_small_max_outstanding(Config)).
<a name="46499"/>46499: 
<a name="46500"/>46500: 
<a name="46501"/>46501: 
<a name="46502"/>46502: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="46503"/>46503: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="46504"/>46504: <i>%% ping-pong like test case.</i>
<a name="46505"/>46505: <i>%% Server:       Transport = gen_tcp, Active = true</i>
<a name="46506"/>46506: <i>%% Client:       Transport = gen_tcp, Active = true</i>
<a name="46507"/>46507: <i>%% Message Size: small (=1)</i>
<a name="46508"/>46508: <i>%% Domain:       inet6</i>
<a name="46509"/>46509: <i>%% </i>
<a name="46510"/>46510: 
<a name="ttest_sgent_cgent_small_tcp6-1"/><a name="46511"/>46511: <b>ttest_sgent_cgent_small_tcp6</b>(Config) when is_list(Config) -&gt;
<a name="46512"/>46512:     Runtime = which_ttest_runtime(Config),
<a name="ttest_sgent_cgent_small_tcp6-last_expr"/><a name="46513"/>46513: <b>    ttest_tcp</b>(ttest_sgent_cgeno_small_tcp6,
<a name="46514"/>46514:               Runtime,
<a name="46515"/>46515:               inet6,
<a name="46516"/>46516:               gen, true,
<a name="46517"/>46517:               gen, true,
<a name="46518"/>46518:               1, ttest_small_max_outstanding(Config)).
<a name="46519"/>46519: 
<a name="46520"/>46520: 
<a name="46521"/>46521: 
<a name="46522"/>46522: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="46523"/>46523: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="46524"/>46524: <i>%% ping-pong like test case.</i>
<a name="46525"/>46525: <i>%% Server:       Transport = gen_tcp, Active = true</i>
<a name="46526"/>46526: <i>%% Client:       Transport = gen_tcp, Active = true</i>
<a name="46527"/>46527: <i>%% Message Size: medium (=2)</i>
<a name="46528"/>46528: <i>%% Domain:       inet</i>
<a name="46529"/>46529: <i>%%</i>
<a name="46530"/>46530: 
<a name="ttest_sgent_cgent_medium_tcp4-0"/><a name="46531"/>46531: <b>ttest_sgent_cgent_medium_tcp4</b>() -&gt;
<a name="ttest_sgent_cgent_medium_tcp4-last_expr"/><a name="46532"/>46532: <b>    [{doc, &quot;Server</b>(gen,true), Client(gen,true), Domain=inet, msg=medium&quot;}].
<a name="46533"/>46533: 
<a name="ttest_sgent_cgent_medium_tcp4-1"/><a name="46534"/>46534: <b>ttest_sgent_cgent_medium_tcp4</b>(Config) when is_list(Config) -&gt;
<a name="46535"/>46535:     Runtime = which_ttest_runtime(Config),
<a name="ttest_sgent_cgent_medium_tcp4-last_expr"/><a name="46536"/>46536: <b>    ttest_tcp</b>(ttest_sgent_cgent_medium_tcp4,
<a name="46537"/>46537:               Runtime,
<a name="46538"/>46538:               inet,
<a name="46539"/>46539:               gen, true,
<a name="46540"/>46540:               gen, true,
<a name="46541"/>46541:               2, ttest_medium_max_outstanding(Config)).
<a name="46542"/>46542: 
<a name="46543"/>46543: 
<a name="46544"/>46544: 
<a name="46545"/>46545: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="46546"/>46546: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="46547"/>46547: <i>%% ping-pong like test case.</i>
<a name="46548"/>46548: <i>%% Server:       Transport = gen_tcp, Active = true</i>
<a name="46549"/>46549: <i>%% Client:       Transport = gen_tcp, Active = true</i>
<a name="46550"/>46550: <i>%% Message Size: medium (=2)</i>
<a name="46551"/>46551: <i>%% Domain:       inet6</i>
<a name="46552"/>46552: <i>%% </i>
<a name="ttest_sgent_cgent_medium_tcp6-0"/><a name="46553"/>46553: <b>ttest_sgent_cgent_medium_tcp6</b>() -&gt;
<a name="ttest_sgent_cgent_medium_tcp6-last_expr"/><a name="46554"/>46554: <b>    [{doc, &quot;Server</b>(gen,true), Client(gen,true), Domain=inet6, msg=medium&quot;}].
<a name="46555"/>46555: 
<a name="ttest_sgent_cgent_medium_tcp6-1"/><a name="46556"/>46556: <b>ttest_sgent_cgent_medium_tcp6</b>(Config) when is_list(Config) -&gt;
<a name="46557"/>46557:     Runtime = which_ttest_runtime(Config),
<a name="ttest_sgent_cgent_medium_tcp6-last_expr"/><a name="46558"/>46558: <b>    ttest_tcp</b>(ttest_sgent_cgent_medium_tcp6,
<a name="46559"/>46559:               Runtime,
<a name="46560"/>46560:               inet6,
<a name="46561"/>46561:               gen, true,
<a name="46562"/>46562:               gen, true,
<a name="46563"/>46563:               2, ttest_medium_max_outstanding(Config)).
<a name="46564"/>46564: 
<a name="46565"/>46565: 
<a name="46566"/>46566: 
<a name="46567"/>46567: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="46568"/>46568: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="46569"/>46569: <i>%% ping-pong like test case.</i>
<a name="46570"/>46570: <i>%% Server:       Transport = gen_tcp, Active = true</i>
<a name="46571"/>46571: <i>%% Client:       Transport = gen_tcp, Active = true</i>
<a name="46572"/>46572: <i>%% Message Size: large (=3)</i>
<a name="46573"/>46573: <i>%% Domain:       inet</i>
<a name="46574"/>46574: <i>%%</i>
<a name="46575"/>46575: 
<a name="ttest_sgent_cgent_large_tcp4-0"/><a name="46576"/>46576: <b>ttest_sgent_cgent_large_tcp4</b>() -&gt;
<a name="ttest_sgent_cgent_large_tcp4-last_expr"/><a name="46577"/>46577: <b>    [{doc, &quot;Server</b>(gen,true), Client(gen,true), Domain=inet, msg=large&quot;}].
<a name="46578"/>46578: 
<a name="ttest_sgent_cgent_large_tcp4-1"/><a name="46579"/>46579: <b>ttest_sgent_cgent_large_tcp4</b>(Config) when is_list(Config) -&gt;
<a name="46580"/>46580:     Runtime = which_ttest_runtime(Config),
<a name="ttest_sgent_cgent_large_tcp4-last_expr"/><a name="46581"/>46581: <b>    ttest_tcp</b>(ttest_sgent_cgent_large_tcp4,
<a name="46582"/>46582:               Runtime,
<a name="46583"/>46583:               inet,
<a name="46584"/>46584:               gen, true,
<a name="46585"/>46585:               gen, true,
<a name="46586"/>46586:               3, ttest_large_max_outstanding(Config)).
<a name="46587"/>46587: 
<a name="46588"/>46588: 
<a name="46589"/>46589: 
<a name="46590"/>46590: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="46591"/>46591: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="46592"/>46592: <i>%% ping-pong like test case.</i>
<a name="46593"/>46593: <i>%% Server:       Transport = gen_tcp, Active = true</i>
<a name="46594"/>46594: <i>%% Client:       Transport = gen_tcp, Active = true</i>
<a name="46595"/>46595: <i>%% Message Size: large (=3)</i>
<a name="46596"/>46596: <i>%% Domain:       inet6</i>
<a name="46597"/>46597: <i>%% </i>
<a name="46598"/>46598: 
<a name="ttest_sgent_cgent_large_tcp6-0"/><a name="46599"/>46599: <b>ttest_sgent_cgent_large_tcp6</b>() -&gt;
<a name="ttest_sgent_cgent_large_tcp6-last_expr"/><a name="46600"/>46600: <b>    [{doc, &quot;Server</b>(gen,true), Client(gen,true), Domain=inet6, msg=large&quot;}].
<a name="46601"/>46601: 
<a name="ttest_sgent_cgent_large_tcp6-1"/><a name="46602"/>46602: <b>ttest_sgent_cgent_large_tcp6</b>(Config) when is_list(Config) -&gt;
<a name="46603"/>46603:     Runtime = which_ttest_runtime(Config),
<a name="ttest_sgent_cgent_large_tcp6-last_expr"/><a name="46604"/>46604: <b>    ttest_tcp</b>(ttest_sgent_cgent_large_tcp6,
<a name="46605"/>46605:               Runtime,
<a name="46606"/>46606:               inet6,
<a name="46607"/>46607:               gen, true,
<a name="46608"/>46608:               gen, true,
<a name="46609"/>46609:               3, ttest_large_max_outstanding(Config)).
<a name="46610"/>46610: 
<a name="46611"/>46611: 
<a name="46612"/>46612: 
<a name="46613"/>46613: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="46614"/>46614: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="46615"/>46615: <i>%% ping-pong like test case.</i>
<a name="46616"/>46616: <i>%% Server:       Transport = gen_tcp, Active = true</i>
<a name="46617"/>46617: <i>%% Client:       Transport = socket(tcp), Active = false</i>
<a name="46618"/>46618: <i>%% Message Size: small (=1)</i>
<a name="46619"/>46619: <i>%% Domain:       inet</i>
<a name="46620"/>46620: <i>%%</i>
<a name="46621"/>46621: 
<a name="46622"/>46622: 
<a name="ttest_sgent_csockf_small_tcp4-1"/><a name="46623"/>46623: <b>ttest_sgent_csockf_small_tcp4</b>(Config) when is_list(Config) -&gt;
<a name="46624"/>46624:     Runtime = which_ttest_runtime(Config),
<a name="ttest_sgent_csockf_small_tcp4-last_expr"/><a name="46625"/>46625: <b>    ttest_tcp</b>(ttest_sgent_csockf_small_tcp4,
<a name="46626"/>46626:               Runtime,
<a name="46627"/>46627:               inet,
<a name="46628"/>46628:               gen, true,
<a name="46629"/>46629:               sock, false,
<a name="46630"/>46630:               1, ttest_small_max_outstanding(Config)).
<a name="46631"/>46631: 
<a name="46632"/>46632: 
<a name="46633"/>46633: 
<a name="46634"/>46634: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="46635"/>46635: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="46636"/>46636: <i>%% ping-pong like test case.</i>
<a name="46637"/>46637: <i>%% Server:       Transport = gen_tcp, Active = true</i>
<a name="46638"/>46638: <i>%% Client:       Transport = socket(tcp), Active = false</i>
<a name="46639"/>46639: <i>%% Message Size: small (=1)</i>
<a name="46640"/>46640: <i>%% Domain:       inet6</i>
<a name="46641"/>46641: <i>%% </i>
<a name="46642"/>46642: 
<a name="ttest_sgent_csockf_small_tcp6-1"/><a name="46643"/>46643: <b>ttest_sgent_csockf_small_tcp6</b>(Config) when is_list(Config) -&gt;
<a name="46644"/>46644:     Runtime = which_ttest_runtime(Config),
<a name="ttest_sgent_csockf_small_tcp6-last_expr"/><a name="46645"/>46645: <b>    ttest_tcp</b>(ttest_sgent_csockf_small_tcp6,
<a name="46646"/>46646:               Runtime,
<a name="46647"/>46647:               inet6,
<a name="46648"/>46648:               gen, true,
<a name="46649"/>46649:               sock, false,
<a name="46650"/>46650:               1, ttest_small_max_outstanding(Config)).
<a name="46651"/>46651: 
<a name="46652"/>46652: 
<a name="46653"/>46653: 
<a name="46654"/>46654: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="46655"/>46655: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="46656"/>46656: <i>%% ping-pong like test case.</i>
<a name="46657"/>46657: <i>%% Server:       Transport = gen_tcp, Active = true</i>
<a name="46658"/>46658: <i>%% Client:       Transport = socket(tcp), Active = false</i>
<a name="46659"/>46659: <i>%% Message Size: medium (=2)</i>
<a name="46660"/>46660: <i>%% Domain:       inet</i>
<a name="46661"/>46661: <i>%%</i>
<a name="46662"/>46662: 
<a name="ttest_sgent_csockf_medium_tcp4-1"/><a name="46663"/>46663: <b>ttest_sgent_csockf_medium_tcp4</b>(Config) when is_list(Config) -&gt;
<a name="46664"/>46664:     Runtime = which_ttest_runtime(Config),
<a name="ttest_sgent_csockf_medium_tcp4-last_expr"/><a name="46665"/>46665: <b>    ttest_tcp</b>(ttest_sgent_csockf_medium_tcp4,
<a name="46666"/>46666:               Runtime,
<a name="46667"/>46667:               inet,
<a name="46668"/>46668:               gen, true,
<a name="46669"/>46669:               sock, false,
<a name="46670"/>46670:               2, ttest_medium_max_outstanding(Config)).
<a name="46671"/>46671: 
<a name="46672"/>46672: 
<a name="46673"/>46673: 
<a name="46674"/>46674: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="46675"/>46675: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="46676"/>46676: <i>%% ping-pong like test case.</i>
<a name="46677"/>46677: <i>%% Server:       Transport = gen_tcp, Active = true</i>
<a name="46678"/>46678: <i>%% Client:       Transport = socket(tcp), Active = false</i>
<a name="46679"/>46679: <i>%% Message Size: medium (=2)</i>
<a name="46680"/>46680: <i>%% Domain:       inet6</i>
<a name="46681"/>46681: <i>%% </i>
<a name="46682"/>46682: 
<a name="ttest_sgent_csockf_medium_tcp6-1"/><a name="46683"/>46683: <b>ttest_sgent_csockf_medium_tcp6</b>(Config) when is_list(Config) -&gt;
<a name="46684"/>46684:     Runtime = which_ttest_runtime(Config),
<a name="ttest_sgent_csockf_medium_tcp6-last_expr"/><a name="46685"/>46685: <b>    ttest_tcp</b>(ttest_sgent_csockf_medium_tcp6,
<a name="46686"/>46686:               Runtime,
<a name="46687"/>46687:               inet6,
<a name="46688"/>46688:               gen, true,
<a name="46689"/>46689:               sock, false,
<a name="46690"/>46690:               2, ttest_medium_max_outstanding(Config)).
<a name="46691"/>46691: 
<a name="46692"/>46692: 
<a name="46693"/>46693: 
<a name="46694"/>46694: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="46695"/>46695: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="46696"/>46696: <i>%% ping-pong like test case.</i>
<a name="46697"/>46697: <i>%% Server:       Transport = gen_tcp, Active = true</i>
<a name="46698"/>46698: <i>%% Client:       Transport = socket(tcp), Active = false</i>
<a name="46699"/>46699: <i>%% Message Size: large (=3)</i>
<a name="46700"/>46700: <i>%% Domain:       inet</i>
<a name="46701"/>46701: <i>%%</i>
<a name="46702"/>46702: 
<a name="ttest_sgent_csockf_large_tcp4-1"/><a name="46703"/>46703: <b>ttest_sgent_csockf_large_tcp4</b>(Config) when is_list(Config) -&gt;
<a name="46704"/>46704:     Runtime = which_ttest_runtime(Config),
<a name="ttest_sgent_csockf_large_tcp4-last_expr"/><a name="46705"/>46705: <b>    ttest_tcp</b>(ttest_sgent_csockf_large_tcp4,
<a name="46706"/>46706:               Runtime,
<a name="46707"/>46707:               inet,
<a name="46708"/>46708:               gen, true,
<a name="46709"/>46709:               sock, false,
<a name="46710"/>46710:               3, ttest_large_max_outstanding(Config)).
<a name="46711"/>46711: 
<a name="46712"/>46712: 
<a name="46713"/>46713: 
<a name="46714"/>46714: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="46715"/>46715: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="46716"/>46716: <i>%% ping-pong like test case.</i>
<a name="46717"/>46717: <i>%% Server:       Transport = gen_tcp, Active = true</i>
<a name="46718"/>46718: <i>%% Client:       Transport = socket(tcp), Active = false</i>
<a name="46719"/>46719: <i>%% Message Size: large (=3)</i>
<a name="46720"/>46720: <i>%% Domain:       inet6</i>
<a name="46721"/>46721: <i>%% </i>
<a name="46722"/>46722: 
<a name="ttest_sgent_csockf_large_tcp6-1"/><a name="46723"/>46723: <b>ttest_sgent_csockf_large_tcp6</b>(Config) when is_list(Config) -&gt;
<a name="46724"/>46724:     Runtime = which_ttest_runtime(Config),
<a name="ttest_sgent_csockf_large_tcp6-last_expr"/><a name="46725"/>46725: <b>    ttest_tcp</b>(ttest_sgent_csockf_large_tcp6,
<a name="46726"/>46726:               Runtime,
<a name="46727"/>46727:               inet6,
<a name="46728"/>46728:               gen, true,
<a name="46729"/>46729:               sock, false,
<a name="46730"/>46730:               3, ttest_large_max_outstanding(Config)).
<a name="46731"/>46731: 
<a name="46732"/>46732: 
<a name="46733"/>46733: 
<a name="46734"/>46734: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="46735"/>46735: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="46736"/>46736: <i>%% ping-pong like test case.</i>
<a name="46737"/>46737: <i>%% Server:       Transport = gen_tcp, Active = true</i>
<a name="46738"/>46738: <i>%% Client:       Transport = socket(tcp), Active = once</i>
<a name="46739"/>46739: <i>%% Message Size: small (=1)</i>
<a name="46740"/>46740: <i>%% Domain:       inet</i>
<a name="46741"/>46741: <i>%%</i>
<a name="46742"/>46742: 
<a name="ttest_sgent_csocko_small_tcp4-1"/><a name="46743"/>46743: <b>ttest_sgent_csocko_small_tcp4</b>(Config) when is_list(Config) -&gt;
<a name="46744"/>46744:     Runtime = which_ttest_runtime(Config),
<a name="ttest_sgent_csocko_small_tcp4-last_expr"/><a name="46745"/>46745: <b>    ttest_tcp</b>(ttest_sgent_csocko_small_tcp4,
<a name="46746"/>46746:               Runtime,
<a name="46747"/>46747:               inet,
<a name="46748"/>46748:               gen, true,
<a name="46749"/>46749:               sock, once,
<a name="46750"/>46750:               1, ttest_small_max_outstanding(Config)).
<a name="46751"/>46751: 
<a name="46752"/>46752: 
<a name="46753"/>46753: 
<a name="46754"/>46754: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="46755"/>46755: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="46756"/>46756: <i>%% ping-pong like test case.</i>
<a name="46757"/>46757: <i>%% Server:       Transport = gen_tcp, Active = true</i>
<a name="46758"/>46758: <i>%% Client:       Transport = socket(tcp), Active = once</i>
<a name="46759"/>46759: <i>%% Message Size: small (=1)</i>
<a name="46760"/>46760: <i>%% Domain:       inet6</i>
<a name="46761"/>46761: <i>%% </i>
<a name="46762"/>46762: 
<a name="ttest_sgent_csocko_small_tcp6-1"/><a name="46763"/>46763: <b>ttest_sgent_csocko_small_tcp6</b>(Config) when is_list(Config) -&gt;
<a name="46764"/>46764:     Runtime = which_ttest_runtime(Config),
<a name="ttest_sgent_csocko_small_tcp6-last_expr"/><a name="46765"/>46765: <b>    ttest_tcp</b>(ttest_sgent_csocko_small_tcp6,
<a name="46766"/>46766:               Runtime,
<a name="46767"/>46767:               inet6,
<a name="46768"/>46768:               gen, true,
<a name="46769"/>46769:               sock, once,
<a name="46770"/>46770:               1, ttest_small_max_outstanding(Config)).
<a name="46771"/>46771: 
<a name="46772"/>46772: 
<a name="46773"/>46773: 
<a name="46774"/>46774: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="46775"/>46775: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="46776"/>46776: <i>%% ping-pong like test case.</i>
<a name="46777"/>46777: <i>%% Server:       Transport = gen_tcp, Active = true</i>
<a name="46778"/>46778: <i>%% Client:       Transport = socket(tcp), Active = once</i>
<a name="46779"/>46779: <i>%% Message Size: medium (=2)</i>
<a name="46780"/>46780: <i>%% Domain:       inet</i>
<a name="46781"/>46781: <i>%%</i>
<a name="46782"/>46782: 
<a name="ttest_sgent_csocko_medium_tcp4-1"/><a name="46783"/>46783: <b>ttest_sgent_csocko_medium_tcp4</b>(Config) when is_list(Config) -&gt;
<a name="46784"/>46784:     Runtime = which_ttest_runtime(Config),
<a name="ttest_sgent_csocko_medium_tcp4-last_expr"/><a name="46785"/>46785: <b>    ttest_tcp</b>(ttest_sgent_csocko_medium_tcp4,
<a name="46786"/>46786:               Runtime,
<a name="46787"/>46787:               inet,
<a name="46788"/>46788:               gen, true,
<a name="46789"/>46789:               sock, once,
<a name="46790"/>46790:               2, ttest_medium_max_outstanding(Config)).
<a name="46791"/>46791: 
<a name="46792"/>46792: 
<a name="46793"/>46793: 
<a name="46794"/>46794: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="46795"/>46795: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="46796"/>46796: <i>%% ping-pong like test case.</i>
<a name="46797"/>46797: <i>%% Server:       Transport = gen_tcp, Active = true</i>
<a name="46798"/>46798: <i>%% Client:       Transport = socket(tcp), Active = once</i>
<a name="46799"/>46799: <i>%% Message Size: medium (=2)</i>
<a name="46800"/>46800: <i>%% Domain:       inet6</i>
<a name="46801"/>46801: <i>%% </i>
<a name="46802"/>46802: 
<a name="ttest_sgent_csocko_medium_tcp6-1"/><a name="46803"/>46803: <b>ttest_sgent_csocko_medium_tcp6</b>(Config) when is_list(Config) -&gt;
<a name="46804"/>46804:     Runtime = which_ttest_runtime(Config),
<a name="ttest_sgent_csocko_medium_tcp6-last_expr"/><a name="46805"/>46805: <b>    ttest_tcp</b>(ttest_sgent_csocko_medium_tcp6,
<a name="46806"/>46806:               Runtime,
<a name="46807"/>46807:               inet6,
<a name="46808"/>46808:               gen, true,
<a name="46809"/>46809:               sock, once,
<a name="46810"/>46810:               2, ttest_medium_max_outstanding(Config)).
<a name="46811"/>46811: 
<a name="46812"/>46812: 
<a name="46813"/>46813: 
<a name="46814"/>46814: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="46815"/>46815: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="46816"/>46816: <i>%% ping-pong like test case.</i>
<a name="46817"/>46817: <i>%% Server:       Transport = gen_tcp, Active = true</i>
<a name="46818"/>46818: <i>%% Client:       Transport = socket(tcp), Active = once</i>
<a name="46819"/>46819: <i>%% Message Size: large (=3)</i>
<a name="46820"/>46820: <i>%% Domain:       inet</i>
<a name="46821"/>46821: <i>%%</i>
<a name="46822"/>46822: 
<a name="ttest_sgent_csocko_large_tcp4-1"/><a name="46823"/>46823: <b>ttest_sgent_csocko_large_tcp4</b>(Config) when is_list(Config) -&gt;
<a name="46824"/>46824:     Runtime = which_ttest_runtime(Config),
<a name="ttest_sgent_csocko_large_tcp4-last_expr"/><a name="46825"/>46825: <b>    ttest_tcp</b>(ttest_sgent_csocko_large_tcp4,
<a name="46826"/>46826:               Runtime,
<a name="46827"/>46827:               inet,
<a name="46828"/>46828:               gen, true,
<a name="46829"/>46829:               sock, once,
<a name="46830"/>46830:               3, ttest_large_max_outstanding(Config)).
<a name="46831"/>46831: 
<a name="46832"/>46832: 
<a name="46833"/>46833: 
<a name="46834"/>46834: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="46835"/>46835: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="46836"/>46836: <i>%% ping-pong like test case.</i>
<a name="46837"/>46837: <i>%% Server:       Transport = gen_tcp, Active = true</i>
<a name="46838"/>46838: <i>%% Client:       Transport = socket(tcp), Active = once</i>
<a name="46839"/>46839: <i>%% Message Size: large (=3)</i>
<a name="46840"/>46840: <i>%% Domain:       inet6</i>
<a name="46841"/>46841: <i>%% </i>
<a name="46842"/>46842: 
<a name="ttest_sgent_csocko_large_tcp6-1"/><a name="46843"/>46843: <b>ttest_sgent_csocko_large_tcp6</b>(Config) when is_list(Config) -&gt;
<a name="46844"/>46844:     Runtime = which_ttest_runtime(Config),
<a name="ttest_sgent_csocko_large_tcp6-last_expr"/><a name="46845"/>46845: <b>    ttest_tcp</b>(ttest_sgent_csocko_large_tcp6,
<a name="46846"/>46846:               Runtime,
<a name="46847"/>46847:               inet6,
<a name="46848"/>46848:               gen, true,
<a name="46849"/>46849:               sock, once,
<a name="46850"/>46850:               3, ttest_large_max_outstanding(Config)).
<a name="46851"/>46851: 
<a name="46852"/>46852: 
<a name="46853"/>46853: 
<a name="46854"/>46854: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="46855"/>46855: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="46856"/>46856: <i>%% ping-pong like test case.</i>
<a name="46857"/>46857: <i>%% Server:       Transport = gen_tcp, Active = true</i>
<a name="46858"/>46858: <i>%% Client:       Transport = socket(tcp), Active = true</i>
<a name="46859"/>46859: <i>%% Message Size: small (=1)</i>
<a name="46860"/>46860: <i>%% Domain:       inet</i>
<a name="46861"/>46861: <i>%%</i>
<a name="46862"/>46862: 
<a name="ttest_sgent_csockt_small_tcp4-1"/><a name="46863"/>46863: <b>ttest_sgent_csockt_small_tcp4</b>(Config) when is_list(Config) -&gt;
<a name="46864"/>46864:     Runtime = which_ttest_runtime(Config),
<a name="ttest_sgent_csockt_small_tcp4-last_expr"/><a name="46865"/>46865: <b>    ttest_tcp</b>(ttest_sgent_csockt_small_tcp4,
<a name="46866"/>46866:               Runtime,
<a name="46867"/>46867:               inet,
<a name="46868"/>46868:               gen, true,
<a name="46869"/>46869:               sock, true,
<a name="46870"/>46870:               1, ttest_small_max_outstanding(Config)).
<a name="46871"/>46871: 
<a name="46872"/>46872: 
<a name="46873"/>46873: 
<a name="46874"/>46874: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="46875"/>46875: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="46876"/>46876: <i>%% ping-pong like test case.</i>
<a name="46877"/>46877: <i>%% Server:       Transport = gen_tcp, Active = true</i>
<a name="46878"/>46878: <i>%% Client:       Transport = socket(tcp), Active = true</i>
<a name="46879"/>46879: <i>%% Message Size: small (=1)</i>
<a name="46880"/>46880: <i>%% Domain:       inet6</i>
<a name="46881"/>46881: <i>%% </i>
<a name="46882"/>46882: 
<a name="ttest_sgent_csockt_small_tcp6-1"/><a name="46883"/>46883: <b>ttest_sgent_csockt_small_tcp6</b>(Config) when is_list(Config) -&gt;
<a name="46884"/>46884:     Runtime = which_ttest_runtime(Config),
<a name="ttest_sgent_csockt_small_tcp6-last_expr"/><a name="46885"/>46885: <b>    ttest_tcp</b>(ttest_sgent_csocko_small_tcp6,
<a name="46886"/>46886:               Runtime,
<a name="46887"/>46887:               inet6,
<a name="46888"/>46888:               gen, true,
<a name="46889"/>46889:               sock, true,
<a name="46890"/>46890:               1, ttest_small_max_outstanding(Config)).
<a name="46891"/>46891: 
<a name="46892"/>46892: 
<a name="46893"/>46893: 
<a name="46894"/>46894: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="46895"/>46895: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="46896"/>46896: <i>%% ping-pong like test case.</i>
<a name="46897"/>46897: <i>%% Server:       Transport = gen_tcp, Active = true</i>
<a name="46898"/>46898: <i>%% Client:       Transport = socket(tcp), Active = true</i>
<a name="46899"/>46899: <i>%% Message Size: medium (=2)</i>
<a name="46900"/>46900: <i>%% Domain:       inet</i>
<a name="46901"/>46901: <i>%%</i>
<a name="46902"/>46902: 
<a name="ttest_sgent_csockt_medium_tcp4-1"/><a name="46903"/>46903: <b>ttest_sgent_csockt_medium_tcp4</b>(Config) when is_list(Config) -&gt;
<a name="46904"/>46904:     Runtime = which_ttest_runtime(Config),
<a name="ttest_sgent_csockt_medium_tcp4-last_expr"/><a name="46905"/>46905: <b>    ttest_tcp</b>(ttest_sgent_csockt_medium_tcp4,
<a name="46906"/>46906:               Runtime,
<a name="46907"/>46907:               inet,
<a name="46908"/>46908:               gen, true,
<a name="46909"/>46909:               sock, true,
<a name="46910"/>46910:               2, ttest_medium_max_outstanding(Config)).
<a name="46911"/>46911: 
<a name="46912"/>46912: 
<a name="46913"/>46913: 
<a name="46914"/>46914: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="46915"/>46915: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="46916"/>46916: <i>%% ping-pong like test case.</i>
<a name="46917"/>46917: <i>%% Server:       Transport = gen_tcp, Active = true</i>
<a name="46918"/>46918: <i>%% Client:       Transport = socket(tcp), Active = true</i>
<a name="46919"/>46919: <i>%% Message Size: medium (=2)</i>
<a name="46920"/>46920: <i>%% Domain:       inet6</i>
<a name="46921"/>46921: <i>%% </i>
<a name="46922"/>46922: 
<a name="ttest_sgent_csockt_medium_tcp6-1"/><a name="46923"/>46923: <b>ttest_sgent_csockt_medium_tcp6</b>(Config) when is_list(Config) -&gt;
<a name="46924"/>46924:     Runtime = which_ttest_runtime(Config),
<a name="ttest_sgent_csockt_medium_tcp6-last_expr"/><a name="46925"/>46925: <b>    ttest_tcp</b>(ttest_sgent_csockt_medium_tcp6,
<a name="46926"/>46926:               Runtime,
<a name="46927"/>46927:               inet6,
<a name="46928"/>46928:               gen, true,
<a name="46929"/>46929:               sock, true,
<a name="46930"/>46930:               2, ttest_medium_max_outstanding(Config)).
<a name="46931"/>46931: 
<a name="46932"/>46932: 
<a name="46933"/>46933: 
<a name="46934"/>46934: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="46935"/>46935: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="46936"/>46936: <i>%% ping-pong like test case.</i>
<a name="46937"/>46937: <i>%% Server:       Transport = gen_tcp, Active = true</i>
<a name="46938"/>46938: <i>%% Client:       Transport = socket(tcp), Active = true</i>
<a name="46939"/>46939: <i>%% Message Size: large (=3)</i>
<a name="46940"/>46940: <i>%% Domain:       inet</i>
<a name="46941"/>46941: <i>%%</i>
<a name="46942"/>46942: 
<a name="ttest_sgent_csockt_large_tcp4-1"/><a name="46943"/>46943: <b>ttest_sgent_csockt_large_tcp4</b>(Config) when is_list(Config) -&gt;
<a name="46944"/>46944:     Runtime = which_ttest_runtime(Config),
<a name="ttest_sgent_csockt_large_tcp4-last_expr"/><a name="46945"/>46945: <b>    ttest_tcp</b>(ttest_sgent_csockt_large_tcp4,
<a name="46946"/>46946:               Runtime,
<a name="46947"/>46947:               inet,
<a name="46948"/>46948:               gen, true,
<a name="46949"/>46949:               sock, true,
<a name="46950"/>46950:               3, ttest_large_max_outstanding(Config)).
<a name="46951"/>46951: 
<a name="46952"/>46952: 
<a name="46953"/>46953: 
<a name="46954"/>46954: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="46955"/>46955: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="46956"/>46956: <i>%% ping-pong like test case.</i>
<a name="46957"/>46957: <i>%% Server:       Transport = gen_tcp, Active = true</i>
<a name="46958"/>46958: <i>%% Client:       Transport = socket(tcp), Active = true</i>
<a name="46959"/>46959: <i>%% Message Size: large (=3)</i>
<a name="46960"/>46960: <i>%% Domain:       inet6</i>
<a name="46961"/>46961: <i>%% </i>
<a name="46962"/>46962: 
<a name="ttest_sgent_csockt_large_tcp6-1"/><a name="46963"/>46963: <b>ttest_sgent_csockt_large_tcp6</b>(Config) when is_list(Config) -&gt;
<a name="46964"/>46964:     Runtime = which_ttest_runtime(Config),
<a name="ttest_sgent_csockt_large_tcp6-last_expr"/><a name="46965"/>46965: <b>    ttest_tcp</b>(ttest_sgent_csockt_large_tcp6,
<a name="46966"/>46966:               Runtime,
<a name="46967"/>46967:               inet6,
<a name="46968"/>46968:               gen, true,
<a name="46969"/>46969:               sock, true,
<a name="46970"/>46970:               3, ttest_large_max_outstanding(Config)).
<a name="46971"/>46971: 
<a name="46972"/>46972: 
<a name="46973"/>46973: 
<a name="46974"/>46974: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="46975"/>46975: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="46976"/>46976: <i>%% ping-pong like test case.</i>
<a name="46977"/>46977: <i>%% Server:       Transport = socket(tcp), Active = false</i>
<a name="46978"/>46978: <i>%% Client:       Transport = gen_tcp, Active = false</i>
<a name="46979"/>46979: <i>%% Message Size: small (=1)</i>
<a name="46980"/>46980: <i>%% Domain:       inet</i>
<a name="46981"/>46981: <i>%%</i>
<a name="46982"/>46982: 
<a name="ttest_ssockf_cgenf_small_tcp4-1"/><a name="46983"/>46983: <b>ttest_ssockf_cgenf_small_tcp4</b>(Config) when is_list(Config) -&gt;
<a name="46984"/>46984:     Runtime = which_ttest_runtime(Config),
<a name="ttest_ssockf_cgenf_small_tcp4-last_expr"/><a name="46985"/>46985: <b>    ttest_tcp</b>(ttest_ssockf_cgenf_small_tcp4,
<a name="46986"/>46986:               Runtime,
<a name="46987"/>46987:               inet,
<a name="46988"/>46988:               sock, false,
<a name="46989"/>46989:               gen, false,
<a name="46990"/>46990:               1, ttest_small_max_outstanding(Config)).
<a name="46991"/>46991: 
<a name="46992"/>46992: 
<a name="46993"/>46993: 
<a name="46994"/>46994: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="46995"/>46995: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="46996"/>46996: <i>%% ping-pong like test case.</i>
<a name="46997"/>46997: <i>%% Server:       Transport = socket(tcp), Active = false</i>
<a name="46998"/>46998: <i>%% Client:       Transport = gen_tcp, Active = false</i>
<a name="46999"/>46999: <i>%% Message Size: small (=1)</i>
<a name="47000"/>47000: <i>%% Domain:       inet6</i>
<a name="47001"/>47001: <i>%% </i>
<a name="47002"/>47002: 
<a name="ttest_ssockf_cgenf_small_tcp6-1"/><a name="47003"/>47003: <b>ttest_ssockf_cgenf_small_tcp6</b>(Config) when is_list(Config) -&gt;
<a name="47004"/>47004:     Runtime = which_ttest_runtime(Config),
<a name="ttest_ssockf_cgenf_small_tcp6-last_expr"/><a name="47005"/>47005: <b>    ttest_tcp</b>(ttest_ssockf_cgenf_small_tcp6,
<a name="47006"/>47006:               Runtime,
<a name="47007"/>47007:               inet6,
<a name="47008"/>47008:               sock, false,
<a name="47009"/>47009:               gen, false,
<a name="47010"/>47010:               1, ttest_small_max_outstanding(Config)).
<a name="47011"/>47011: 
<a name="47012"/>47012: 
<a name="47013"/>47013: 
<a name="47014"/>47014: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="47015"/>47015: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="47016"/>47016: <i>%% ping-pong like test case.</i>
<a name="47017"/>47017: <i>%% Server:       Transport = socket(tcp), Active = false</i>
<a name="47018"/>47018: <i>%% Client:       Transport = gen_tcp, Active = false</i>
<a name="47019"/>47019: <i>%% Message Size: medium (=2)</i>
<a name="47020"/>47020: <i>%% Domain:       inet</i>
<a name="47021"/>47021: <i>%%</i>
<a name="47022"/>47022: 
<a name="ttest_ssockf_cgenf_medium_tcp4-1"/><a name="47023"/>47023: <b>ttest_ssockf_cgenf_medium_tcp4</b>(Config) when is_list(Config) -&gt;
<a name="47024"/>47024:     Runtime = which_ttest_runtime(Config),
<a name="ttest_ssockf_cgenf_medium_tcp4-last_expr"/><a name="47025"/>47025: <b>    ttest_tcp</b>(ttest_ssockf_cgenf_medium_tcp4,
<a name="47026"/>47026:               Runtime,
<a name="47027"/>47027:               inet,
<a name="47028"/>47028:               sock, false,
<a name="47029"/>47029:               gen, false,
<a name="47030"/>47030:               2, ttest_medium_max_outstanding(Config)).
<a name="47031"/>47031: 
<a name="47032"/>47032: 
<a name="47033"/>47033: 
<a name="47034"/>47034: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="47035"/>47035: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="47036"/>47036: <i>%% ping-pong like test case.</i>
<a name="47037"/>47037: <i>%% Server:       Transport = socket(tcp), Active = false</i>
<a name="47038"/>47038: <i>%% Client:       Transport = gen_tcp, Active = false</i>
<a name="47039"/>47039: <i>%% Message Size: medium (=2)</i>
<a name="47040"/>47040: <i>%% Domain:       inet6</i>
<a name="47041"/>47041: <i>%% </i>
<a name="47042"/>47042: 
<a name="ttest_ssockf_cgenf_medium_tcp6-1"/><a name="47043"/>47043: <b>ttest_ssockf_cgenf_medium_tcp6</b>(Config) when is_list(Config) -&gt;
<a name="47044"/>47044:     Runtime = which_ttest_runtime(Config),
<a name="ttest_ssockf_cgenf_medium_tcp6-last_expr"/><a name="47045"/>47045: <b>    ttest_tcp</b>(ttest_ssockf_cgenf_medium_tcp6,
<a name="47046"/>47046:               Runtime,
<a name="47047"/>47047:               inet6,
<a name="47048"/>47048:               sock, false,
<a name="47049"/>47049:               gen, false,
<a name="47050"/>47050:               2, ttest_medium_max_outstanding(Config)).
<a name="47051"/>47051: 
<a name="47052"/>47052: 
<a name="47053"/>47053: 
<a name="47054"/>47054: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="47055"/>47055: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="47056"/>47056: <i>%% ping-pong like test case.</i>
<a name="47057"/>47057: <i>%% Server:       Transport = socket(tcp), Active = false</i>
<a name="47058"/>47058: <i>%% Client:       Transport = gen_tcp, Active = false</i>
<a name="47059"/>47059: <i>%% Message Size: large (=3)</i>
<a name="47060"/>47060: <i>%% Domain:       inet</i>
<a name="47061"/>47061: <i>%%</i>
<a name="47062"/>47062: 
<a name="ttest_ssockf_cgenf_large_tcp4-1"/><a name="47063"/>47063: <b>ttest_ssockf_cgenf_large_tcp4</b>(Config) when is_list(Config) -&gt;
<a name="47064"/>47064:     Runtime = which_ttest_runtime(Config),
<a name="ttest_ssockf_cgenf_large_tcp4-last_expr"/><a name="47065"/>47065: <b>    ttest_tcp</b>(ttest_ssockf_cgenf_large_tcp4,
<a name="47066"/>47066:               Runtime,
<a name="47067"/>47067:               inet,
<a name="47068"/>47068:               sock, false,
<a name="47069"/>47069:               gen, false,
<a name="47070"/>47070:               3, ttest_large_max_outstanding(Config)).
<a name="47071"/>47071: 
<a name="47072"/>47072: 
<a name="47073"/>47073: 
<a name="47074"/>47074: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="47075"/>47075: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="47076"/>47076: <i>%% ping-pong like test case.</i>
<a name="47077"/>47077: <i>%% Server:       Transport = socket(tcp), Active = false</i>
<a name="47078"/>47078: <i>%% Client:       Transport = gen_tcp, Active = false</i>
<a name="47079"/>47079: <i>%% Message Size: large (=3)</i>
<a name="47080"/>47080: <i>%% Domain:       inet6</i>
<a name="47081"/>47081: <i>%% </i>
<a name="47082"/>47082: 
<a name="ttest_ssockf_cgenf_large_tcp6-1"/><a name="47083"/>47083: <b>ttest_ssockf_cgenf_large_tcp6</b>(Config) when is_list(Config) -&gt;
<a name="47084"/>47084:     Runtime = which_ttest_runtime(Config),
<a name="ttest_ssockf_cgenf_large_tcp6-last_expr"/><a name="47085"/>47085: <b>    ttest_tcp</b>(ttest_ssockf_cgenf_large_tcp6,
<a name="47086"/>47086:               Runtime,
<a name="47087"/>47087:               inet6,
<a name="47088"/>47088:               sock, false,
<a name="47089"/>47089:               gen, false,
<a name="47090"/>47090:               3, ttest_large_max_outstanding(Config)).
<a name="47091"/>47091: 
<a name="47092"/>47092: 
<a name="47093"/>47093: 
<a name="47094"/>47094: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="47095"/>47095: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="47096"/>47096: <i>%% ping-pong like test case.</i>
<a name="47097"/>47097: <i>%% Server:       Transport = socket(tcp), Active = false</i>
<a name="47098"/>47098: <i>%% Client:       Transport = gen_tcp, Active = once</i>
<a name="47099"/>47099: <i>%% Message Size: small (=1)</i>
<a name="47100"/>47100: <i>%% Domain:       inet</i>
<a name="47101"/>47101: <i>%%</i>
<a name="47102"/>47102: 
<a name="ttest_ssockf_cgeno_small_tcp4-1"/><a name="47103"/>47103: <b>ttest_ssockf_cgeno_small_tcp4</b>(Config) when is_list(Config) -&gt;
<a name="47104"/>47104:     Runtime = which_ttest_runtime(Config),
<a name="ttest_ssockf_cgeno_small_tcp4-last_expr"/><a name="47105"/>47105: <b>    ttest_tcp</b>(ttest_ssockf_cgeno_small_tcp4,
<a name="47106"/>47106:               Runtime,
<a name="47107"/>47107:               inet,
<a name="47108"/>47108:               sock, false,
<a name="47109"/>47109:               gen, once,
<a name="47110"/>47110:               1, ttest_small_max_outstanding(Config)).
<a name="47111"/>47111: 
<a name="47112"/>47112: 
<a name="47113"/>47113: 
<a name="47114"/>47114: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="47115"/>47115: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="47116"/>47116: <i>%% ping-pong like test case.</i>
<a name="47117"/>47117: <i>%% Server:       Transport = socket(tcp), Active = false</i>
<a name="47118"/>47118: <i>%% Client:       Transport = gen_tcp, Active = once</i>
<a name="47119"/>47119: <i>%% Message Size: small (=1)</i>
<a name="47120"/>47120: <i>%% Domain:       inet6</i>
<a name="47121"/>47121: <i>%% </i>
<a name="47122"/>47122: 
<a name="ttest_ssockf_cgeno_small_tcp6-1"/><a name="47123"/>47123: <b>ttest_ssockf_cgeno_small_tcp6</b>(Config) when is_list(Config) -&gt;
<a name="47124"/>47124:     Runtime = which_ttest_runtime(Config),
<a name="ttest_ssockf_cgeno_small_tcp6-last_expr"/><a name="47125"/>47125: <b>    ttest_tcp</b>(ttest_ssockf_cgeno_small_tcp6,
<a name="47126"/>47126:               Runtime,
<a name="47127"/>47127:               inet6,
<a name="47128"/>47128:               sock, false,
<a name="47129"/>47129:               gen, once,
<a name="47130"/>47130:               1, ttest_small_max_outstanding(Config)).
<a name="47131"/>47131: 
<a name="47132"/>47132: 
<a name="47133"/>47133: 
<a name="47134"/>47134: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="47135"/>47135: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="47136"/>47136: <i>%% ping-pong like test case.</i>
<a name="47137"/>47137: <i>%% Server:       Transport = socket(tcp), Active = false</i>
<a name="47138"/>47138: <i>%% Client:       Transport = gen_tcp, Active = once</i>
<a name="47139"/>47139: <i>%% Message Size: medium (=2)</i>
<a name="47140"/>47140: <i>%% Domain:       inet</i>
<a name="47141"/>47141: <i>%%</i>
<a name="47142"/>47142: 
<a name="ttest_ssockf_cgeno_medium_tcp4-1"/><a name="47143"/>47143: <b>ttest_ssockf_cgeno_medium_tcp4</b>(Config) when is_list(Config) -&gt;
<a name="47144"/>47144:     Runtime = which_ttest_runtime(Config),
<a name="ttest_ssockf_cgeno_medium_tcp4-last_expr"/><a name="47145"/>47145: <b>    ttest_tcp</b>(ttest_ssockf_cgeno_medium_tcp4,
<a name="47146"/>47146:               Runtime,
<a name="47147"/>47147:               inet,
<a name="47148"/>47148:               sock, false,
<a name="47149"/>47149:               gen, once,
<a name="47150"/>47150:               2, ttest_medium_max_outstanding(Config)).
<a name="47151"/>47151: 
<a name="47152"/>47152: 
<a name="47153"/>47153: 
<a name="47154"/>47154: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="47155"/>47155: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="47156"/>47156: <i>%% ping-pong like test case.</i>
<a name="47157"/>47157: <i>%% Server:       Transport = socket(tcp), Active = false</i>
<a name="47158"/>47158: <i>%% Client:       Transport = gen_tcp, Active = once</i>
<a name="47159"/>47159: <i>%% Message Size: medium (=2)</i>
<a name="47160"/>47160: <i>%% Domain:       inet6</i>
<a name="47161"/>47161: <i>%% </i>
<a name="47162"/>47162: 
<a name="ttest_ssockf_cgeno_medium_tcp6-1"/><a name="47163"/>47163: <b>ttest_ssockf_cgeno_medium_tcp6</b>(Config) when is_list(Config) -&gt;
<a name="47164"/>47164:     Runtime = which_ttest_runtime(Config),
<a name="ttest_ssockf_cgeno_medium_tcp6-last_expr"/><a name="47165"/>47165: <b>    ttest_tcp</b>(ttest_ssockf_cgeno_medium_tcp6,
<a name="47166"/>47166:               Runtime,
<a name="47167"/>47167:               inet6,
<a name="47168"/>47168:               sock, false,
<a name="47169"/>47169:               gen, once,
<a name="47170"/>47170:               2, ttest_medium_max_outstanding(Config)).
<a name="47171"/>47171: 
<a name="47172"/>47172: 
<a name="47173"/>47173: 
<a name="47174"/>47174: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="47175"/>47175: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="47176"/>47176: <i>%% ping-pong like test case.</i>
<a name="47177"/>47177: <i>%% Server:       Transport = socket(tcp), Active = false</i>
<a name="47178"/>47178: <i>%% Client:       Transport = gen_tcp, Active = once</i>
<a name="47179"/>47179: <i>%% Message Size: large (=3)</i>
<a name="47180"/>47180: <i>%% Domain:       inet</i>
<a name="47181"/>47181: <i>%%</i>
<a name="47182"/>47182: 
<a name="ttest_ssockf_cgeno_large_tcp4-1"/><a name="47183"/>47183: <b>ttest_ssockf_cgeno_large_tcp4</b>(Config) when is_list(Config) -&gt;
<a name="47184"/>47184:     Runtime = which_ttest_runtime(Config),
<a name="ttest_ssockf_cgeno_large_tcp4-last_expr"/><a name="47185"/>47185: <b>    ttest_tcp</b>(ttest_ssockf_cgeno_large_tcp4,
<a name="47186"/>47186:               Runtime,
<a name="47187"/>47187:               inet,
<a name="47188"/>47188:               sock, false,
<a name="47189"/>47189:               gen, once,
<a name="47190"/>47190:               3, ttest_large_max_outstanding(Config)).
<a name="47191"/>47191: 
<a name="47192"/>47192: 
<a name="47193"/>47193: 
<a name="47194"/>47194: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="47195"/>47195: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="47196"/>47196: <i>%% ping-pong like test case.</i>
<a name="47197"/>47197: <i>%% Server:       Transport = socket(tcp), Active = false</i>
<a name="47198"/>47198: <i>%% Client:       Transport = gen_tcp, Active = once</i>
<a name="47199"/>47199: <i>%% Message Size: large (=3)</i>
<a name="47200"/>47200: <i>%% Domain:       inet6</i>
<a name="47201"/>47201: <i>%% </i>
<a name="47202"/>47202: 
<a name="ttest_ssockf_cgeno_large_tcp6-1"/><a name="47203"/>47203: <b>ttest_ssockf_cgeno_large_tcp6</b>(Config) when is_list(Config) -&gt;
<a name="47204"/>47204:     Runtime = which_ttest_runtime(Config),
<a name="ttest_ssockf_cgeno_large_tcp6-last_expr"/><a name="47205"/>47205: <b>    ttest_tcp</b>(ttest_ssockf_cgeno_large_tcp6,
<a name="47206"/>47206:               Runtime,
<a name="47207"/>47207:               inet6,
<a name="47208"/>47208:               sock, false,
<a name="47209"/>47209:               gen, once,
<a name="47210"/>47210:               3, ttest_large_max_outstanding(Config)).
<a name="47211"/>47211: 
<a name="47212"/>47212: 
<a name="47213"/>47213: 
<a name="47214"/>47214: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="47215"/>47215: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="47216"/>47216: <i>%% ping-pong like test case.</i>
<a name="47217"/>47217: <i>%% Server:       Transport = socket(tcp), Active = false</i>
<a name="47218"/>47218: <i>%% Client:       Transport = gen_tcp, Active = true</i>
<a name="47219"/>47219: <i>%% Message Size: small (=1)</i>
<a name="47220"/>47220: <i>%% Domain:       inet</i>
<a name="47221"/>47221: <i>%%</i>
<a name="47222"/>47222: 
<a name="ttest_ssockf_cgent_small_tcp4-1"/><a name="47223"/>47223: <b>ttest_ssockf_cgent_small_tcp4</b>(Config) when is_list(Config) -&gt;
<a name="47224"/>47224:     Runtime = which_ttest_runtime(Config),
<a name="ttest_ssockf_cgent_small_tcp4-last_expr"/><a name="47225"/>47225: <b>    ttest_tcp</b>(ttest_ssockf_cgent_small_tcp4,
<a name="47226"/>47226:               Runtime,
<a name="47227"/>47227:               inet,
<a name="47228"/>47228:               sock, false,
<a name="47229"/>47229:               gen, true,
<a name="47230"/>47230:               1, ttest_small_max_outstanding(Config)).
<a name="47231"/>47231: 
<a name="47232"/>47232: 
<a name="47233"/>47233: 
<a name="47234"/>47234: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="47235"/>47235: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="47236"/>47236: <i>%% ping-pong like test case.</i>
<a name="47237"/>47237: <i>%% Server:       Transport =  socket(tcp), Active = false</i>
<a name="47238"/>47238: <i>%% Client:       Transport = gen_tcp, Active = true</i>
<a name="47239"/>47239: <i>%% Message Size: small (=1)</i>
<a name="47240"/>47240: <i>%% Domain:       inet6</i>
<a name="47241"/>47241: <i>%% </i>
<a name="47242"/>47242: 
<a name="ttest_ssockf_cgent_small_tcp6-1"/><a name="47243"/>47243: <b>ttest_ssockf_cgent_small_tcp6</b>(Config) when is_list(Config) -&gt;
<a name="47244"/>47244:     Runtime = which_ttest_runtime(Config),
<a name="ttest_ssockf_cgent_small_tcp6-last_expr"/><a name="47245"/>47245: <b>    ttest_tcp</b>(ttest_ssockf_cgeno_small_tcp6,
<a name="47246"/>47246:               Runtime,
<a name="47247"/>47247:               inet6,
<a name="47248"/>47248:               sock, false,
<a name="47249"/>47249:               gen, true,
<a name="47250"/>47250:               1, ttest_small_max_outstanding(Config)).
<a name="47251"/>47251: 
<a name="47252"/>47252: 
<a name="47253"/>47253: 
<a name="47254"/>47254: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="47255"/>47255: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="47256"/>47256: <i>%% ping-pong like test case.</i>
<a name="47257"/>47257: <i>%% Server:       Transport = socket(tcp), Active = false</i>
<a name="47258"/>47258: <i>%% Client:       Transport = gen_tcp, Active = true</i>
<a name="47259"/>47259: <i>%% Message Size: medium (=2)</i>
<a name="47260"/>47260: <i>%% Domain:       inet</i>
<a name="47261"/>47261: <i>%%</i>
<a name="47262"/>47262: 
<a name="ttest_ssockf_cgent_medium_tcp4-1"/><a name="47263"/>47263: <b>ttest_ssockf_cgent_medium_tcp4</b>(Config) when is_list(Config) -&gt;
<a name="47264"/>47264:     Runtime = which_ttest_runtime(Config),
<a name="ttest_ssockf_cgent_medium_tcp4-last_expr"/><a name="47265"/>47265: <b>    ttest_tcp</b>(ttest_ssockf_cgent_medium_tcp4,
<a name="47266"/>47266:               Runtime,
<a name="47267"/>47267:               inet,
<a name="47268"/>47268:               sock, false,
<a name="47269"/>47269:               gen, true,
<a name="47270"/>47270:               2, ttest_medium_max_outstanding(Config)).
<a name="47271"/>47271: 
<a name="47272"/>47272: 
<a name="47273"/>47273: 
<a name="47274"/>47274: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="47275"/>47275: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="47276"/>47276: <i>%% ping-pong like test case.</i>
<a name="47277"/>47277: <i>%% Server:       Transport = socket(tcp), Active = false</i>
<a name="47278"/>47278: <i>%% Client:       Transport = gen_tcp, Active = true</i>
<a name="47279"/>47279: <i>%% Message Size: medium (=2)</i>
<a name="47280"/>47280: <i>%% Domain:       inet6</i>
<a name="47281"/>47281: <i>%% </i>
<a name="47282"/>47282: 
<a name="ttest_ssockf_cgent_medium_tcp6-1"/><a name="47283"/>47283: <b>ttest_ssockf_cgent_medium_tcp6</b>(Config) when is_list(Config) -&gt;
<a name="47284"/>47284:     Runtime = which_ttest_runtime(Config),
<a name="ttest_ssockf_cgent_medium_tcp6-last_expr"/><a name="47285"/>47285: <b>    ttest_tcp</b>(ttest_ssockf_cgent_medium_tcp6,
<a name="47286"/>47286:               Runtime,
<a name="47287"/>47287:               inet6,
<a name="47288"/>47288:               sock, false,
<a name="47289"/>47289:               gen, true,
<a name="47290"/>47290:               2, ttest_medium_max_outstanding(Config)).
<a name="47291"/>47291: 
<a name="47292"/>47292: 
<a name="47293"/>47293: 
<a name="47294"/>47294: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="47295"/>47295: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="47296"/>47296: <i>%% ping-pong like test case.</i>
<a name="47297"/>47297: <i>%% Server:       Transport = socket(tcp), Active = false</i>
<a name="47298"/>47298: <i>%% Client:       Transport = gen_tcp, Active = true</i>
<a name="47299"/>47299: <i>%% Message Size: large (=3)</i>
<a name="47300"/>47300: <i>%% Domain:       inet</i>
<a name="47301"/>47301: <i>%%</i>
<a name="47302"/>47302: 
<a name="ttest_ssockf_cgent_large_tcp4-1"/><a name="47303"/>47303: <b>ttest_ssockf_cgent_large_tcp4</b>(Config) when is_list(Config) -&gt;
<a name="47304"/>47304:     Runtime = which_ttest_runtime(Config),
<a name="ttest_ssockf_cgent_large_tcp4-last_expr"/><a name="47305"/>47305: <b>    ttest_tcp</b>(ttest_ssockf_cgent_large_tcp4,
<a name="47306"/>47306:               Runtime,
<a name="47307"/>47307:               inet,
<a name="47308"/>47308:               sock, false,
<a name="47309"/>47309:               gen, true,
<a name="47310"/>47310:               3, ttest_large_max_outstanding(Config)).
<a name="47311"/>47311: 
<a name="47312"/>47312: 
<a name="47313"/>47313: 
<a name="47314"/>47314: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="47315"/>47315: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="47316"/>47316: <i>%% ping-pong like test case.</i>
<a name="47317"/>47317: <i>%% Server:       Transport = socket(tcp), Active = false</i>
<a name="47318"/>47318: <i>%% Client:       Transport = gen_tcp, Active = true</i>
<a name="47319"/>47319: <i>%% Message Size: large (=3)</i>
<a name="47320"/>47320: <i>%% Domain:       inet6</i>
<a name="47321"/>47321: <i>%% </i>
<a name="47322"/>47322: 
<a name="ttest_ssockf_cgent_large_tcp6-1"/><a name="47323"/>47323: <b>ttest_ssockf_cgent_large_tcp6</b>(Config) when is_list(Config) -&gt;
<a name="47324"/>47324:     Runtime = which_ttest_runtime(Config),
<a name="ttest_ssockf_cgent_large_tcp6-last_expr"/><a name="47325"/>47325: <b>    ttest_tcp</b>(ttest_ssockf_cgent_large_tcp6,
<a name="47326"/>47326:               Runtime,
<a name="47327"/>47327:               inet6,
<a name="47328"/>47328:               sock, false,
<a name="47329"/>47329:               gen, true,
<a name="47330"/>47330:               3, ttest_large_max_outstanding(Config)).
<a name="47331"/>47331: 
<a name="47332"/>47332: 
<a name="47333"/>47333: 
<a name="47334"/>47334: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="47335"/>47335: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="47336"/>47336: <i>%% ping-pong like test case.</i>
<a name="47337"/>47337: <i>%% Server:       Transport = socket(tcp), Active = false</i>
<a name="47338"/>47338: <i>%% Client:       Transport = gen_tcp(socket), Active = false</i>
<a name="47339"/>47339: <i>%% Message Size: small (=1)</i>
<a name="47340"/>47340: <i>%% Domain:       inet</i>
<a name="47341"/>47341: <i>%%</i>
<a name="47342"/>47342: 
<a name="ttest_ssockf_cgsf_small_tcp4-1"/><a name="47343"/>47343: <b>ttest_ssockf_cgsf_small_tcp4</b>(Config) when is_list(Config) -&gt;
<a name="47344"/>47344:     Runtime = which_ttest_runtime(Config),
<a name="ttest_ssockf_cgsf_small_tcp4-last_expr"/><a name="47345"/>47345: <b>    ttest_tcp</b>(?FUNCTION_NAME,
<a name="47346"/>47346:               Runtime,
<a name="47347"/>47347:               inet,
<a name="47348"/>47348:               sock, false,
<a name="47349"/>47349:               gs, false,
<a name="47350"/>47350:               1, ttest_small_max_outstanding(Config)).
<a name="47351"/>47351: 
<a name="47352"/>47352: 
<a name="47353"/>47353: 
<a name="47354"/>47354: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="47355"/>47355: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="47356"/>47356: <i>%% ping-pong like test case.</i>
<a name="47357"/>47357: <i>%% Server:       Transport = socket(tcp), Active = false</i>
<a name="47358"/>47358: <i>%% Client:       Transport = gen_tcp(socket), Active = false</i>
<a name="47359"/>47359: <i>%% Message Size: small (=1)</i>
<a name="47360"/>47360: <i>%% Domain:       inet6</i>
<a name="47361"/>47361: <i>%% </i>
<a name="47362"/>47362: 
<a name="ttest_ssockf_cgsf_small_tcp6-1"/><a name="47363"/>47363: <b>ttest_ssockf_cgsf_small_tcp6</b>(Config) when is_list(Config) -&gt;
<a name="47364"/>47364:     Runtime = which_ttest_runtime(Config),
<a name="ttest_ssockf_cgsf_small_tcp6-last_expr"/><a name="47365"/>47365: <b>    ttest_tcp</b>(?FUNCTION_NAME,
<a name="47366"/>47366:               Runtime,
<a name="47367"/>47367:               inet6,
<a name="47368"/>47368:               sock, false,
<a name="47369"/>47369:               gs, false,
<a name="47370"/>47370:               1, ttest_small_max_outstanding(Config)).
<a name="47371"/>47371: 
<a name="47372"/>47372: 
<a name="47373"/>47373: 
<a name="47374"/>47374: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="47375"/>47375: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="47376"/>47376: <i>%% ping-pong like test case.</i>
<a name="47377"/>47377: <i>%% Server:       Transport = socket(tcp), Active = false</i>
<a name="47378"/>47378: <i>%% Client:       Transport = gen_tcp(socket), Active = false</i>
<a name="47379"/>47379: <i>%% Message Size: medium (=2)</i>
<a name="47380"/>47380: <i>%% Domain:       inet</i>
<a name="47381"/>47381: <i>%%</i>
<a name="47382"/>47382: 
<a name="ttest_ssockf_cgsf_medium_tcp4-1"/><a name="47383"/>47383: <b>ttest_ssockf_cgsf_medium_tcp4</b>(Config) when is_list(Config) -&gt;
<a name="47384"/>47384:     Runtime = which_ttest_runtime(Config),
<a name="ttest_ssockf_cgsf_medium_tcp4-last_expr"/><a name="47385"/>47385: <b>    ttest_tcp</b>(?FUNCTION_NAME,
<a name="47386"/>47386:               Runtime,
<a name="47387"/>47387:               inet,
<a name="47388"/>47388:               sock, false,
<a name="47389"/>47389:               gs, false,
<a name="47390"/>47390:               2, ttest_medium_max_outstanding(Config)).
<a name="47391"/>47391: 
<a name="47392"/>47392: 
<a name="47393"/>47393: 
<a name="47394"/>47394: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="47395"/>47395: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="47396"/>47396: <i>%% ping-pong like test case.</i>
<a name="47397"/>47397: <i>%% Server:       Transport = socket(tcp), Active = false</i>
<a name="47398"/>47398: <i>%% Client:       Transport = gen_tcp(socket), Active = false</i>
<a name="47399"/>47399: <i>%% Message Size: medium (=2)</i>
<a name="47400"/>47400: <i>%% Domain:       inet6</i>
<a name="47401"/>47401: <i>%% </i>
<a name="47402"/>47402: 
<a name="ttest_ssockf_cgsf_medium_tcp6-1"/><a name="47403"/>47403: <b>ttest_ssockf_cgsf_medium_tcp6</b>(Config) when is_list(Config) -&gt;
<a name="47404"/>47404:     Runtime = which_ttest_runtime(Config),
<a name="ttest_ssockf_cgsf_medium_tcp6-last_expr"/><a name="47405"/>47405: <b>    ttest_tcp</b>(?FUNCTION_NAME,
<a name="47406"/>47406:               Runtime,
<a name="47407"/>47407:               inet6,
<a name="47408"/>47408:               sock, false,
<a name="47409"/>47409:               gs, false,
<a name="47410"/>47410:               2, ttest_medium_max_outstanding(Config)).
<a name="47411"/>47411: 
<a name="47412"/>47412: 
<a name="47413"/>47413: 
<a name="47414"/>47414: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="47415"/>47415: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="47416"/>47416: <i>%% ping-pong like test case.</i>
<a name="47417"/>47417: <i>%% Server:       Transport = socket(tcp), Active = false</i>
<a name="47418"/>47418: <i>%% Client:       Transport = gen_tcp(socket), Active = false</i>
<a name="47419"/>47419: <i>%% Message Size: large (=3)</i>
<a name="47420"/>47420: <i>%% Domain:       inet</i>
<a name="47421"/>47421: <i>%%</i>
<a name="47422"/>47422: 
<a name="ttest_ssockf_cgsf_large_tcp4-1"/><a name="47423"/>47423: <b>ttest_ssockf_cgsf_large_tcp4</b>(Config) when is_list(Config) -&gt;
<a name="47424"/>47424:     Runtime = which_ttest_runtime(Config),
<a name="ttest_ssockf_cgsf_large_tcp4-last_expr"/><a name="47425"/>47425: <b>    ttest_tcp</b>(?FUNCTION_NAME,
<a name="47426"/>47426:               Runtime,
<a name="47427"/>47427:               inet,
<a name="47428"/>47428:               sock, false,
<a name="47429"/>47429:               gs, false,
<a name="47430"/>47430:               3, ttest_large_max_outstanding(Config)).
<a name="47431"/>47431: 
<a name="47432"/>47432: 
<a name="47433"/>47433: 
<a name="47434"/>47434: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="47435"/>47435: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="47436"/>47436: <i>%% ping-pong like test case.</i>
<a name="47437"/>47437: <i>%% Server:       Transport = socket(tcp), Active = false</i>
<a name="47438"/>47438: <i>%% Client:       Transport = gen_tcp(socket), Active = false</i>
<a name="47439"/>47439: <i>%% Message Size: large (=3)</i>
<a name="47440"/>47440: <i>%% Domain:       inet6</i>
<a name="47441"/>47441: <i>%% </i>
<a name="47442"/>47442: 
<a name="ttest_ssockf_cgsf_large_tcp6-1"/><a name="47443"/>47443: <b>ttest_ssockf_cgsf_large_tcp6</b>(Config) when is_list(Config) -&gt;
<a name="47444"/>47444:     Runtime = which_ttest_runtime(Config),
<a name="ttest_ssockf_cgsf_large_tcp6-last_expr"/><a name="47445"/>47445: <b>    ttest_tcp</b>(?FUNCTION_NAME,
<a name="47446"/>47446:               Runtime,
<a name="47447"/>47447:               inet6,
<a name="47448"/>47448:               sock, false,
<a name="47449"/>47449:               gs, false,
<a name="47450"/>47450:               3, ttest_large_max_outstanding(Config)).
<a name="47451"/>47451: 
<a name="47452"/>47452: 
<a name="47453"/>47453: 
<a name="47454"/>47454: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="47455"/>47455: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="47456"/>47456: <i>%% ping-pong like test case.</i>
<a name="47457"/>47457: <i>%% Server:       Transport = socket(tcp), Active = false</i>
<a name="47458"/>47458: <i>%% Client:       Transport = socket(tcp), Active = false</i>
<a name="47459"/>47459: <i>%% Message Size: small (=1)</i>
<a name="47460"/>47460: <i>%% Domain:       inet</i>
<a name="47461"/>47461: <i>%%</i>
<a name="47462"/>47462: 
<a name="ttest_ssockf_csockf_small_tcp4-1"/><a name="47463"/>47463: <b>ttest_ssockf_csockf_small_tcp4</b>(Config) when is_list(Config) -&gt;
<a name="47464"/>47464:     Runtime = which_ttest_runtime(Config),
<a name="ttest_ssockf_csockf_small_tcp4-last_expr"/><a name="47465"/>47465: <b>    ttest_tcp</b>(ttest_ssockf_csockf_small_tcp4,
<a name="47466"/>47466:               Runtime,
<a name="47467"/>47467:               inet,
<a name="47468"/>47468:               sock, false,
<a name="47469"/>47469:               sock, false,
<a name="47470"/>47470:               1, ttest_small_max_outstanding(Config)).
<a name="47471"/>47471: 
<a name="47472"/>47472: 
<a name="47473"/>47473: 
<a name="47474"/>47474: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="47475"/>47475: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="47476"/>47476: <i>%% ping-pong like test case.</i>
<a name="47477"/>47477: <i>%% Server:       Transport = socket(tcp), Active = false</i>
<a name="47478"/>47478: <i>%% Client:       Transport = socket(tcp), Active = false</i>
<a name="47479"/>47479: <i>%% Message Size: small (=1)</i>
<a name="47480"/>47480: <i>%% Domain:       inet6</i>
<a name="47481"/>47481: <i>%% </i>
<a name="47482"/>47482: 
<a name="ttest_ssockf_csockf_small_tcp6-1"/><a name="47483"/>47483: <b>ttest_ssockf_csockf_small_tcp6</b>(Config) when is_list(Config) -&gt;
<a name="47484"/>47484:     Runtime = which_ttest_runtime(Config),
<a name="ttest_ssockf_csockf_small_tcp6-last_expr"/><a name="47485"/>47485: <b>    ttest_tcp</b>(ttest_ssockf_csockf_small_tcp6,
<a name="47486"/>47486:               Runtime,
<a name="47487"/>47487:               inet6,
<a name="47488"/>47488:               sock, false,
<a name="47489"/>47489:               sock, false,
<a name="47490"/>47490:               1, ttest_small_max_outstanding(Config)).
<a name="47491"/>47491: 
<a name="47492"/>47492: 
<a name="47493"/>47493: 
<a name="47494"/>47494: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="47495"/>47495: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="47496"/>47496: <i>%% ping-pong like test case.</i>
<a name="47497"/>47497: <i>%% Server:       Transport = socket(tcp), Active = false</i>
<a name="47498"/>47498: <i>%% Client:       Transport = socket(tcp), Active = false</i>
<a name="47499"/>47499: <i>%% Message Size: small (=1)</i>
<a name="47500"/>47500: <i>%% Domain:       local</i>
<a name="47501"/>47501: <i>%% </i>
<a name="47502"/>47502: 
<a name="ttest_ssockf_csockf_small_tcpL-1"/><a name="47503"/>47503: <b>ttest_ssockf_csockf_small_tcpL</b>(Config) when is_list(Config) -&gt;
<a name="47504"/>47504:     Runtime = which_ttest_runtime(Config),
<a name="ttest_ssockf_csockf_small_tcpL-last_expr"/><a name="47505"/>47505: <b>    ttest_tcp</b>(ttest_ssockf_csockf_small_tcpL,
<a name="47506"/>47506:               Runtime,
<a name="47507"/>47507:               local,
<a name="47508"/>47508:               sock, false,
<a name="47509"/>47509:               sock, false,
<a name="47510"/>47510:               1, ttest_small_max_outstanding(Config)).
<a name="47511"/>47511: 
<a name="47512"/>47512: 
<a name="47513"/>47513: 
<a name="47514"/>47514: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="47515"/>47515: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="47516"/>47516: <i>%% ping-pong like test case.</i>
<a name="47517"/>47517: <i>%% Server:       Transport = socket(tcp), Active = false</i>
<a name="47518"/>47518: <i>%% Client:       Transport = socket(tcp), Active = false</i>
<a name="47519"/>47519: <i>%% Message Size: medium (=2)</i>
<a name="47520"/>47520: <i>%% Domain:       inet</i>
<a name="47521"/>47521: <i>%%</i>
<a name="47522"/>47522: 
<a name="ttest_ssockf_csockf_medium_tcp4-1"/><a name="47523"/>47523: <b>ttest_ssockf_csockf_medium_tcp4</b>(Config) when is_list(Config) -&gt;
<a name="47524"/>47524:     Runtime = which_ttest_runtime(Config),
<a name="ttest_ssockf_csockf_medium_tcp4-last_expr"/><a name="47525"/>47525: <b>    ttest_tcp</b>(ttest_ssockf_csockf_medium_tcp4,
<a name="47526"/>47526:               Runtime,
<a name="47527"/>47527:               inet,
<a name="47528"/>47528:               sock, false,
<a name="47529"/>47529:               sock, false,
<a name="47530"/>47530:               2, ttest_medium_max_outstanding(Config)).
<a name="47531"/>47531: 
<a name="47532"/>47532: 
<a name="47533"/>47533: 
<a name="47534"/>47534: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="47535"/>47535: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="47536"/>47536: <i>%% ping-pong like test case.</i>
<a name="47537"/>47537: <i>%% Server:       Transport = socket(tcp), Active = false</i>
<a name="47538"/>47538: <i>%% Client:       Transport = socket(tcp), Active = false</i>
<a name="47539"/>47539: <i>%% Message Size: medium (=2)</i>
<a name="47540"/>47540: <i>%% Domain:       inet6</i>
<a name="47541"/>47541: <i>%% </i>
<a name="47542"/>47542: 
<a name="ttest_ssockf_csockf_medium_tcp6-1"/><a name="47543"/>47543: <b>ttest_ssockf_csockf_medium_tcp6</b>(Config) when is_list(Config) -&gt;
<a name="47544"/>47544:     Runtime = which_ttest_runtime(Config),
<a name="ttest_ssockf_csockf_medium_tcp6-last_expr"/><a name="47545"/>47545: <b>    ttest_tcp</b>(ttest_ssockf_csockf_medium_tcp6,
<a name="47546"/>47546:               Runtime,
<a name="47547"/>47547:               inet6,
<a name="47548"/>47548:               sock, false,
<a name="47549"/>47549:               sock, false,
<a name="47550"/>47550:               2, ttest_medium_max_outstanding(Config)).
<a name="47551"/>47551: 
<a name="47552"/>47552: 
<a name="47553"/>47553: 
<a name="47554"/>47554: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="47555"/>47555: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="47556"/>47556: <i>%% ping-pong like test case.</i>
<a name="47557"/>47557: <i>%% Server:       Transport = socket(tcp), Active = false</i>
<a name="47558"/>47558: <i>%% Client:       Transport = socket(tcp), Active = false</i>
<a name="47559"/>47559: <i>%% Message Size: medium (=2)</i>
<a name="47560"/>47560: <i>%% Domain:       local</i>
<a name="47561"/>47561: <i>%% </i>
<a name="47562"/>47562: 
<a name="ttest_ssockf_csockf_medium_tcpL-1"/><a name="47563"/>47563: <b>ttest_ssockf_csockf_medium_tcpL</b>(Config) when is_list(Config) -&gt;
<a name="47564"/>47564:     Runtime = which_ttest_runtime(Config),
<a name="ttest_ssockf_csockf_medium_tcpL-last_expr"/><a name="47565"/>47565: <b>    ttest_tcp</b>(ttest_ssockf_csockf_medium_tcpL,
<a name="47566"/>47566:               Runtime,
<a name="47567"/>47567:               local,
<a name="47568"/>47568:               sock, false,
<a name="47569"/>47569:               sock, false,
<a name="47570"/>47570:               2, ttest_medium_max_outstanding(Config)).
<a name="47571"/>47571: 
<a name="47572"/>47572: 
<a name="47573"/>47573: 
<a name="47574"/>47574: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="47575"/>47575: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="47576"/>47576: <i>%% ping-pong like test case.</i>
<a name="47577"/>47577: <i>%% Server:       Transport = socket(tcp), Active = false</i>
<a name="47578"/>47578: <i>%% Client:       Transport = socket(tcp), Active = false</i>
<a name="47579"/>47579: <i>%% Message Size: large (=3)</i>
<a name="47580"/>47580: <i>%% Domain:       inet</i>
<a name="47581"/>47581: <i>%%</i>
<a name="47582"/>47582: 
<a name="ttest_ssockf_csockf_large_tcp4-1"/><a name="47583"/>47583: <b>ttest_ssockf_csockf_large_tcp4</b>(Config) when is_list(Config) -&gt;
<a name="47584"/>47584:     Runtime = which_ttest_runtime(Config),
<a name="ttest_ssockf_csockf_large_tcp4-last_expr"/><a name="47585"/>47585: <b>    ttest_tcp</b>(ttest_ssockf_csockf_large_tcp4,
<a name="47586"/>47586:               Runtime,
<a name="47587"/>47587:               inet,
<a name="47588"/>47588:               sock, false,
<a name="47589"/>47589:               sock, false,
<a name="47590"/>47590:               3, ttest_large_max_outstanding(Config)).
<a name="47591"/>47591: 
<a name="47592"/>47592: 
<a name="47593"/>47593: 
<a name="47594"/>47594: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="47595"/>47595: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="47596"/>47596: <i>%% ping-pong like test case.</i>
<a name="47597"/>47597: <i>%% Server:       Transport = socket(tcp), Active = false</i>
<a name="47598"/>47598: <i>%% Client:       Transport = socket(tcp), Active = false</i>
<a name="47599"/>47599: <i>%% Message Size: large (=3)</i>
<a name="47600"/>47600: <i>%% Domain:       inet6</i>
<a name="47601"/>47601: <i>%% </i>
<a name="47602"/>47602: 
<a name="ttest_ssockf_csockf_large_tcp6-1"/><a name="47603"/>47603: <b>ttest_ssockf_csockf_large_tcp6</b>(Config) when is_list(Config) -&gt;
<a name="47604"/>47604:     Runtime = which_ttest_runtime(Config),
<a name="ttest_ssockf_csockf_large_tcp6-last_expr"/><a name="47605"/>47605: <b>    ttest_tcp</b>(ttest_ssockf_csockf_large_tcp6,
<a name="47606"/>47606:               Runtime,
<a name="47607"/>47607:               inet6,
<a name="47608"/>47608:               sock, false,
<a name="47609"/>47609:               sock, false,
<a name="47610"/>47610:               3, ttest_large_max_outstanding(Config)).
<a name="47611"/>47611: 
<a name="47612"/>47612: 
<a name="47613"/>47613: 
<a name="47614"/>47614: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="47615"/>47615: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="47616"/>47616: <i>%% ping-pong like test case.</i>
<a name="47617"/>47617: <i>%% Server:       Transport = socket(tcp), Active = false</i>
<a name="47618"/>47618: <i>%% Client:       Transport = socket(tcp), Active = false</i>
<a name="47619"/>47619: <i>%% Message Size: large (=3)</i>
<a name="47620"/>47620: <i>%% Domain:       local</i>
<a name="47621"/>47621: <i>%% </i>
<a name="47622"/>47622: 
<a name="ttest_ssockf_csockf_large_tcpL-1"/><a name="47623"/>47623: <b>ttest_ssockf_csockf_large_tcpL</b>(Config) when is_list(Config) -&gt;
<a name="47624"/>47624:     Runtime = which_ttest_runtime(Config),
<a name="ttest_ssockf_csockf_large_tcpL-last_expr"/><a name="47625"/>47625: <b>    ttest_tcp</b>(ttest_ssockf_csockf_large_tcpL,
<a name="47626"/>47626:               Runtime,
<a name="47627"/>47627:               local,
<a name="47628"/>47628:               sock, false,
<a name="47629"/>47629:               sock, false,
<a name="47630"/>47630:               3, ttest_large_max_outstanding(Config)).
<a name="47631"/>47631: 
<a name="47632"/>47632: 
<a name="47633"/>47633: 
<a name="47634"/>47634: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="47635"/>47635: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="47636"/>47636: <i>%% ping-pong like test case.</i>
<a name="47637"/>47637: <i>%% Server:       Transport = socket(tcp), Active = false</i>
<a name="47638"/>47638: <i>%% Client:       Transport = socket(tcp), Active = once</i>
<a name="47639"/>47639: <i>%% Message Size: small (=1)</i>
<a name="47640"/>47640: <i>%% Domain:       inet</i>
<a name="47641"/>47641: <i>%%</i>
<a name="47642"/>47642: 
<a name="ttest_ssockf_csocko_small_tcp4-1"/><a name="47643"/>47643: <b>ttest_ssockf_csocko_small_tcp4</b>(Config) when is_list(Config) -&gt;
<a name="47644"/>47644:     Runtime = which_ttest_runtime(Config),
<a name="ttest_ssockf_csocko_small_tcp4-last_expr"/><a name="47645"/>47645: <b>    ttest_tcp</b>(ttest_ssockf_csocko_small_tcp4,
<a name="47646"/>47646:               Runtime,
<a name="47647"/>47647:               inet,
<a name="47648"/>47648:               sock, false,
<a name="47649"/>47649:               sock, once,
<a name="47650"/>47650:               1, ttest_small_max_outstanding(Config)).
<a name="47651"/>47651: 
<a name="47652"/>47652: 
<a name="47653"/>47653: 
<a name="47654"/>47654: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="47655"/>47655: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="47656"/>47656: <i>%% ping-pong like test case.</i>
<a name="47657"/>47657: <i>%% Server:       Transport = socket(tcp), Active = false</i>
<a name="47658"/>47658: <i>%% Client:       Transport = socket(tcp), Active = once</i>
<a name="47659"/>47659: <i>%% Message Size: small (=1)</i>
<a name="47660"/>47660: <i>%% Domain:       inet6</i>
<a name="47661"/>47661: <i>%% </i>
<a name="47662"/>47662: 
<a name="ttest_ssockf_csocko_small_tcp6-1"/><a name="47663"/>47663: <b>ttest_ssockf_csocko_small_tcp6</b>(Config) when is_list(Config) -&gt;
<a name="47664"/>47664:     Runtime = which_ttest_runtime(Config),
<a name="ttest_ssockf_csocko_small_tcp6-last_expr"/><a name="47665"/>47665: <b>    ttest_tcp</b>(ttest_ssockf_csocko_small_tcp6,
<a name="47666"/>47666:               Runtime,
<a name="47667"/>47667:               inet6,
<a name="47668"/>47668:               sock, false,
<a name="47669"/>47669:               sock, once,
<a name="47670"/>47670:               1, ttest_small_max_outstanding(Config)).
<a name="47671"/>47671: 
<a name="47672"/>47672: 
<a name="47673"/>47673: 
<a name="47674"/>47674: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="47675"/>47675: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="47676"/>47676: <i>%% ping-pong like test case.</i>
<a name="47677"/>47677: <i>%% Server:       Transport = socket(tcp), Active = false</i>
<a name="47678"/>47678: <i>%% Client:       Transport = socket(tcp), Active = once</i>
<a name="47679"/>47679: <i>%% Message Size: small (=1)</i>
<a name="47680"/>47680: <i>%% Domain:       local</i>
<a name="47681"/>47681: <i>%% </i>
<a name="47682"/>47682: 
<a name="ttest_ssockf_csocko_small_tcpL-1"/><a name="47683"/>47683: <b>ttest_ssockf_csocko_small_tcpL</b>(Config) when is_list(Config) -&gt;
<a name="47684"/>47684:     Runtime = which_ttest_runtime(Config),
<a name="ttest_ssockf_csocko_small_tcpL-last_expr"/><a name="47685"/>47685: <b>    ttest_tcp</b>(ttest_ssockf_csocko_small_tcpL,
<a name="47686"/>47686:               Runtime,
<a name="47687"/>47687:               local,
<a name="47688"/>47688:               sock, false,
<a name="47689"/>47689:               sock, once,
<a name="47690"/>47690:               1, ttest_small_max_outstanding(Config)).
<a name="47691"/>47691: 
<a name="47692"/>47692: 
<a name="47693"/>47693: 
<a name="47694"/>47694: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="47695"/>47695: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="47696"/>47696: <i>%% ping-pong like test case.</i>
<a name="47697"/>47697: <i>%% Server:       Transport = socket(tcp), Active = false</i>
<a name="47698"/>47698: <i>%% Client:       Transport = socket(tcp), Active = once</i>
<a name="47699"/>47699: <i>%% Message Size: medium (=2)</i>
<a name="47700"/>47700: <i>%% Domain:       inet</i>
<a name="47701"/>47701: <i>%%</i>
<a name="47702"/>47702: 
<a name="ttest_ssockf_csocko_medium_tcp4-1"/><a name="47703"/>47703: <b>ttest_ssockf_csocko_medium_tcp4</b>(Config) when is_list(Config) -&gt;
<a name="47704"/>47704:     Runtime = which_ttest_runtime(Config),
<a name="ttest_ssockf_csocko_medium_tcp4-last_expr"/><a name="47705"/>47705: <b>    ttest_tcp</b>(ttest_ssockf_csocko_medium_tcp4,
<a name="47706"/>47706:               Runtime,
<a name="47707"/>47707:               inet,
<a name="47708"/>47708:               sock, false,
<a name="47709"/>47709:               sock, once,
<a name="47710"/>47710:               2, ttest_medium_max_outstanding(Config)).
<a name="47711"/>47711: 
<a name="47712"/>47712: 
<a name="47713"/>47713: 
<a name="47714"/>47714: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="47715"/>47715: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="47716"/>47716: <i>%% ping-pong like test case.</i>
<a name="47717"/>47717: <i>%% Server:       Transport = socket(tcp), Active = false</i>
<a name="47718"/>47718: <i>%% Client:       Transport = socket(tcp), Active = once</i>
<a name="47719"/>47719: <i>%% Message Size: medium (=2)</i>
<a name="47720"/>47720: <i>%% Domain:       inet6</i>
<a name="47721"/>47721: <i>%% </i>
<a name="47722"/>47722: 
<a name="ttest_ssockf_csocko_medium_tcp6-1"/><a name="47723"/>47723: <b>ttest_ssockf_csocko_medium_tcp6</b>(Config) when is_list(Config) -&gt;
<a name="47724"/>47724:     Runtime = which_ttest_runtime(Config),
<a name="ttest_ssockf_csocko_medium_tcp6-last_expr"/><a name="47725"/>47725: <b>    ttest_tcp</b>(ttest_ssockf_csocko_medium_tcp6,
<a name="47726"/>47726:               Runtime,
<a name="47727"/>47727:               inet6,
<a name="47728"/>47728:               sock, false,
<a name="47729"/>47729:               sock, once,
<a name="47730"/>47730:               2, ttest_medium_max_outstanding(Config)).
<a name="47731"/>47731: 
<a name="47732"/>47732: 
<a name="47733"/>47733: 
<a name="47734"/>47734: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="47735"/>47735: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="47736"/>47736: <i>%% ping-pong like test case.</i>
<a name="47737"/>47737: <i>%% Server:       Transport = socket(tcp), Active = false</i>
<a name="47738"/>47738: <i>%% Client:       Transport = socket(tcp), Active = once</i>
<a name="47739"/>47739: <i>%% Message Size: medium (=2)</i>
<a name="47740"/>47740: <i>%% Domain:       local</i>
<a name="47741"/>47741: <i>%% </i>
<a name="47742"/>47742: 
<a name="ttest_ssockf_csocko_medium_tcpL-1"/><a name="47743"/>47743: <b>ttest_ssockf_csocko_medium_tcpL</b>(Config) when is_list(Config) -&gt;
<a name="47744"/>47744:     Runtime = which_ttest_runtime(Config),
<a name="ttest_ssockf_csocko_medium_tcpL-last_expr"/><a name="47745"/>47745: <b>    ttest_tcp</b>(ttest_ssockf_csocko_medium_tcpL,
<a name="47746"/>47746:               Runtime,
<a name="47747"/>47747:               local,
<a name="47748"/>47748:               sock, false,
<a name="47749"/>47749:               sock, once,
<a name="47750"/>47750:               2, ttest_medium_max_outstanding(Config)).
<a name="47751"/>47751: 
<a name="47752"/>47752: 
<a name="47753"/>47753: 
<a name="47754"/>47754: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="47755"/>47755: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="47756"/>47756: <i>%% ping-pong like test case.</i>
<a name="47757"/>47757: <i>%% Server:       Transport = socket(tcp), Active = false</i>
<a name="47758"/>47758: <i>%% Client:       Transport = socket(tcp), Active = once</i>
<a name="47759"/>47759: <i>%% Message Size: large (=3)</i>
<a name="47760"/>47760: <i>%% Domain:       inet</i>
<a name="47761"/>47761: <i>%%</i>
<a name="47762"/>47762: 
<a name="ttest_ssockf_csocko_large_tcp4-1"/><a name="47763"/>47763: <b>ttest_ssockf_csocko_large_tcp4</b>(Config) when is_list(Config) -&gt;
<a name="47764"/>47764:     Runtime = which_ttest_runtime(Config),
<a name="ttest_ssockf_csocko_large_tcp4-last_expr"/><a name="47765"/>47765: <b>    ttest_tcp</b>(ttest_ssockf_csocko_large_tcp4,
<a name="47766"/>47766:               Runtime,
<a name="47767"/>47767:               inet,
<a name="47768"/>47768:               sock, false,
<a name="47769"/>47769:               sock, once,
<a name="47770"/>47770:               3, ttest_large_max_outstanding(Config)).
<a name="47771"/>47771: 
<a name="47772"/>47772: 
<a name="47773"/>47773: 
<a name="47774"/>47774: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="47775"/>47775: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="47776"/>47776: <i>%% ping-pong like test case.</i>
<a name="47777"/>47777: <i>%% Server:       Transport = socket(tcp), Active = false</i>
<a name="47778"/>47778: <i>%% Client:       Transport = socket(tcp), Active = once</i>
<a name="47779"/>47779: <i>%% Message Size: large (=3)</i>
<a name="47780"/>47780: <i>%% Domain:       inet6</i>
<a name="47781"/>47781: <i>%% </i>
<a name="47782"/>47782: 
<a name="ttest_ssockf_csocko_large_tcp6-1"/><a name="47783"/>47783: <b>ttest_ssockf_csocko_large_tcp6</b>(Config) when is_list(Config) -&gt;
<a name="47784"/>47784:     Runtime = which_ttest_runtime(Config),
<a name="ttest_ssockf_csocko_large_tcp6-last_expr"/><a name="47785"/>47785: <b>    ttest_tcp</b>(ttest_ssockf_csocko_large_tcp6,
<a name="47786"/>47786:               Runtime,
<a name="47787"/>47787:               inet6,
<a name="47788"/>47788:               sock, false,
<a name="47789"/>47789:               sock, once,
<a name="47790"/>47790:               3, ttest_large_max_outstanding(Config)).
<a name="47791"/>47791: 
<a name="47792"/>47792: 
<a name="47793"/>47793: 
<a name="47794"/>47794: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="47795"/>47795: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="47796"/>47796: <i>%% ping-pong like test case.</i>
<a name="47797"/>47797: <i>%% Server:       Transport = socket(tcp), Active = false</i>
<a name="47798"/>47798: <i>%% Client:       Transport = socket(tcp), Active = once</i>
<a name="47799"/>47799: <i>%% Message Size: large (=3)</i>
<a name="47800"/>47800: <i>%% Domain:       local</i>
<a name="47801"/>47801: <i>%% </i>
<a name="47802"/>47802: 
<a name="ttest_ssockf_csocko_large_tcpL-1"/><a name="47803"/>47803: <b>ttest_ssockf_csocko_large_tcpL</b>(Config) when is_list(Config) -&gt;
<a name="47804"/>47804:     Runtime = which_ttest_runtime(Config),
<a name="ttest_ssockf_csocko_large_tcpL-last_expr"/><a name="47805"/>47805: <b>    ttest_tcp</b>(ttest_ssockf_csocko_large_tcpL,
<a name="47806"/>47806:               Runtime,
<a name="47807"/>47807:               local,
<a name="47808"/>47808:               sock, false,
<a name="47809"/>47809:               sock, once,
<a name="47810"/>47810:               3, ttest_large_max_outstanding(Config)).
<a name="47811"/>47811: 
<a name="47812"/>47812: 
<a name="47813"/>47813: 
<a name="47814"/>47814: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="47815"/>47815: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="47816"/>47816: <i>%% ping-pong like test case.</i>
<a name="47817"/>47817: <i>%% Server:       Transport = socket(tcp), Active = false</i>
<a name="47818"/>47818: <i>%% Client:       Transport = socket(tcp), Active = true</i>
<a name="47819"/>47819: <i>%% Message Size: small (=1)</i>
<a name="47820"/>47820: <i>%% Domain:       inet</i>
<a name="47821"/>47821: <i>%%</i>
<a name="47822"/>47822: 
<a name="ttest_ssockf_csockt_small_tcp4-1"/><a name="47823"/>47823: <b>ttest_ssockf_csockt_small_tcp4</b>(Config) when is_list(Config) -&gt;
<a name="47824"/>47824:     Runtime = which_ttest_runtime(Config),
<a name="ttest_ssockf_csockt_small_tcp4-last_expr"/><a name="47825"/>47825: <b>    ttest_tcp</b>(ttest_ssockf_csockt_small_tcp4,
<a name="47826"/>47826:               Runtime,
<a name="47827"/>47827:               inet,
<a name="47828"/>47828:               sock, false,
<a name="47829"/>47829:               sock, true,
<a name="47830"/>47830:               1, ttest_small_max_outstanding(Config)).
<a name="47831"/>47831: 
<a name="47832"/>47832: 
<a name="47833"/>47833: 
<a name="47834"/>47834: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="47835"/>47835: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="47836"/>47836: <i>%% ping-pong like test case.</i>
<a name="47837"/>47837: <i>%% Server:       Transport =  socket(tcp), Active = false</i>
<a name="47838"/>47838: <i>%% Client:       Transport = socket(tcp), Active = true</i>
<a name="47839"/>47839: <i>%% Message Size: small (=1)</i>
<a name="47840"/>47840: <i>%% Domain:       inet6</i>
<a name="47841"/>47841: <i>%% </i>
<a name="47842"/>47842: 
<a name="ttest_ssockf_csockt_small_tcp6-1"/><a name="47843"/>47843: <b>ttest_ssockf_csockt_small_tcp6</b>(Config) when is_list(Config) -&gt;
<a name="47844"/>47844:     Runtime = which_ttest_runtime(Config),
<a name="ttest_ssockf_csockt_small_tcp6-last_expr"/><a name="47845"/>47845: <b>    ttest_tcp</b>(ttest_ssockf_csocko_small_tcp6,
<a name="47846"/>47846:               Runtime,
<a name="47847"/>47847:               inet6,
<a name="47848"/>47848:               sock, false,
<a name="47849"/>47849:               sock, true,
<a name="47850"/>47850:               1, ttest_small_max_outstanding(Config)).
<a name="47851"/>47851: 
<a name="47852"/>47852: 
<a name="47853"/>47853: 
<a name="47854"/>47854: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="47855"/>47855: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="47856"/>47856: <i>%% ping-pong like test case.</i>
<a name="47857"/>47857: <i>%% Server:       Transport =  socket(tcp), Active = false</i>
<a name="47858"/>47858: <i>%% Client:       Transport = socket(tcp), Active = true</i>
<a name="47859"/>47859: <i>%% Message Size: small (=1)</i>
<a name="47860"/>47860: <i>%% Domain:       local</i>
<a name="47861"/>47861: <i>%% </i>
<a name="47862"/>47862: 
<a name="ttest_ssockf_csockt_small_tcpL-1"/><a name="47863"/>47863: <b>ttest_ssockf_csockt_small_tcpL</b>(Config) when is_list(Config) -&gt;
<a name="47864"/>47864:     Runtime = which_ttest_runtime(Config),
<a name="ttest_ssockf_csockt_small_tcpL-last_expr"/><a name="47865"/>47865: <b>    ttest_tcp</b>(ttest_ssockf_csocko_small_tcpL,
<a name="47866"/>47866:               Runtime,
<a name="47867"/>47867:               local,
<a name="47868"/>47868:               sock, false,
<a name="47869"/>47869:               sock, true,
<a name="47870"/>47870:               1, ttest_small_max_outstanding(Config)).
<a name="47871"/>47871: 
<a name="47872"/>47872: 
<a name="47873"/>47873: 
<a name="47874"/>47874: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="47875"/>47875: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="47876"/>47876: <i>%% ping-pong like test case.</i>
<a name="47877"/>47877: <i>%% Server:       Transport = socket(tcp), Active = false</i>
<a name="47878"/>47878: <i>%% Client:       Transport = socket(tcp), Active = true</i>
<a name="47879"/>47879: <i>%% Message Size: medium (=2)</i>
<a name="47880"/>47880: <i>%% Domain:       inet</i>
<a name="47881"/>47881: <i>%%</i>
<a name="47882"/>47882: 
<a name="ttest_ssockf_csockt_medium_tcp4-1"/><a name="47883"/>47883: <b>ttest_ssockf_csockt_medium_tcp4</b>(Config) when is_list(Config) -&gt;
<a name="47884"/>47884:     Runtime = which_ttest_runtime(Config),
<a name="ttest_ssockf_csockt_medium_tcp4-last_expr"/><a name="47885"/>47885: <b>    ttest_tcp</b>(ttest_ssockf_csockt_medium_tcp4,
<a name="47886"/>47886:               Runtime,
<a name="47887"/>47887:               inet,
<a name="47888"/>47888:               sock, false,
<a name="47889"/>47889:               sock, true,
<a name="47890"/>47890:               2, ttest_medium_max_outstanding(Config)).
<a name="47891"/>47891: 
<a name="47892"/>47892: 
<a name="47893"/>47893: 
<a name="47894"/>47894: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="47895"/>47895: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="47896"/>47896: <i>%% ping-pong like test case.</i>
<a name="47897"/>47897: <i>%% Server:       Transport = socket(tcp), Active = false</i>
<a name="47898"/>47898: <i>%% Client:       Transport = socket(tcp), Active = true</i>
<a name="47899"/>47899: <i>%% Message Size: medium (=2)</i>
<a name="47900"/>47900: <i>%% Domain:       inet6</i>
<a name="47901"/>47901: <i>%% </i>
<a name="47902"/>47902: 
<a name="ttest_ssockf_csockt_medium_tcp6-1"/><a name="47903"/>47903: <b>ttest_ssockf_csockt_medium_tcp6</b>(Config) when is_list(Config) -&gt;
<a name="47904"/>47904:     Runtime = which_ttest_runtime(Config),
<a name="ttest_ssockf_csockt_medium_tcp6-last_expr"/><a name="47905"/>47905: <b>    ttest_tcp</b>(ttest_ssockf_csockt_medium_tcp6,
<a name="47906"/>47906:               Runtime,
<a name="47907"/>47907:               inet6,
<a name="47908"/>47908:               sock, false,
<a name="47909"/>47909:               sock, true,
<a name="47910"/>47910:               2, ttest_medium_max_outstanding(Config)).
<a name="47911"/>47911: 
<a name="47912"/>47912: 
<a name="47913"/>47913: 
<a name="47914"/>47914: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="47915"/>47915: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="47916"/>47916: <i>%% ping-pong like test case.</i>
<a name="47917"/>47917: <i>%% Server:       Transport = socket(tcp), Active = false</i>
<a name="47918"/>47918: <i>%% Client:       Transport = socket(tcp), Active = true</i>
<a name="47919"/>47919: <i>%% Message Size: medium (=2)</i>
<a name="47920"/>47920: <i>%% Domain:       local</i>
<a name="47921"/>47921: <i>%% </i>
<a name="47922"/>47922: 
<a name="ttest_ssockf_csockt_medium_tcpL-1"/><a name="47923"/>47923: <b>ttest_ssockf_csockt_medium_tcpL</b>(Config) when is_list(Config) -&gt;
<a name="47924"/>47924:     Runtime = which_ttest_runtime(Config),
<a name="ttest_ssockf_csockt_medium_tcpL-last_expr"/><a name="47925"/>47925: <b>    ttest_tcp</b>(ttest_ssockf_csockt_medium_tcpL,
<a name="47926"/>47926:               Runtime,
<a name="47927"/>47927:               local,
<a name="47928"/>47928:               sock, false,
<a name="47929"/>47929:               sock, true,
<a name="47930"/>47930:               2, ttest_medium_max_outstanding(Config)).
<a name="47931"/>47931: 
<a name="47932"/>47932: 
<a name="47933"/>47933: 
<a name="47934"/>47934: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="47935"/>47935: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="47936"/>47936: <i>%% ping-pong like test case.</i>
<a name="47937"/>47937: <i>%% Server:       Transport = socket(tcp), Active = false</i>
<a name="47938"/>47938: <i>%% Client:       Transport = socket(tcp), Active = true</i>
<a name="47939"/>47939: <i>%% Message Size: large (=3)</i>
<a name="47940"/>47940: <i>%% Domain:       inet</i>
<a name="47941"/>47941: <i>%%</i>
<a name="47942"/>47942: 
<a name="ttest_ssockf_csockt_large_tcp4-1"/><a name="47943"/>47943: <b>ttest_ssockf_csockt_large_tcp4</b>(Config) when is_list(Config) -&gt;
<a name="47944"/>47944:     Runtime = which_ttest_runtime(Config),
<a name="ttest_ssockf_csockt_large_tcp4-last_expr"/><a name="47945"/>47945: <b>    ttest_tcp</b>(ttest_ssockf_csockt_large_tcp4,
<a name="47946"/>47946:               Runtime,
<a name="47947"/>47947:               inet,
<a name="47948"/>47948:               sock, false,
<a name="47949"/>47949:               sock, true,
<a name="47950"/>47950:               3, ttest_large_max_outstanding(Config)).
<a name="47951"/>47951: 
<a name="47952"/>47952: 
<a name="47953"/>47953: 
<a name="47954"/>47954: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="47955"/>47955: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="47956"/>47956: <i>%% ping-pong like test case.</i>
<a name="47957"/>47957: <i>%% Server:       Transport = socket(tcp), Active = false</i>
<a name="47958"/>47958: <i>%% Client:       Transport = socket(tcp), Active = true</i>
<a name="47959"/>47959: <i>%% Message Size: large (=3)</i>
<a name="47960"/>47960: <i>%% Domain:       inet6</i>
<a name="47961"/>47961: <i>%% </i>
<a name="47962"/>47962: 
<a name="ttest_ssockf_csockt_large_tcp6-1"/><a name="47963"/>47963: <b>ttest_ssockf_csockt_large_tcp6</b>(Config) when is_list(Config) -&gt;
<a name="47964"/>47964:     Runtime = which_ttest_runtime(Config),
<a name="ttest_ssockf_csockt_large_tcp6-last_expr"/><a name="47965"/>47965: <b>    ttest_tcp</b>(ttest_ssockf_csockt_large_tcp6,
<a name="47966"/>47966:               Runtime,
<a name="47967"/>47967:               inet6,
<a name="47968"/>47968:               sock, false,
<a name="47969"/>47969:               sock, true,
<a name="47970"/>47970:               3, ttest_large_max_outstanding(Config)).
<a name="47971"/>47971: 
<a name="47972"/>47972: 
<a name="47973"/>47973: 
<a name="47974"/>47974: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="47975"/>47975: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="47976"/>47976: <i>%% ping-pong like test case.</i>
<a name="47977"/>47977: <i>%% Server:       Transport = socket(tcp), Active = false</i>
<a name="47978"/>47978: <i>%% Client:       Transport = socket(tcp), Active = true</i>
<a name="47979"/>47979: <i>%% Message Size: large (=3)</i>
<a name="47980"/>47980: <i>%% Domain:       local</i>
<a name="47981"/>47981: <i>%% </i>
<a name="47982"/>47982: 
<a name="ttest_ssockf_csockt_large_tcpL-1"/><a name="47983"/>47983: <b>ttest_ssockf_csockt_large_tcpL</b>(Config) when is_list(Config) -&gt;
<a name="47984"/>47984:     Runtime = which_ttest_runtime(Config),
<a name="ttest_ssockf_csockt_large_tcpL-last_expr"/><a name="47985"/>47985: <b>    ttest_tcp</b>(ttest_ssockf_csockt_large_tcpL,
<a name="47986"/>47986:               Runtime,
<a name="47987"/>47987:               local,
<a name="47988"/>47988:               sock, false,
<a name="47989"/>47989:               sock, true,
<a name="47990"/>47990:               3, ttest_large_max_outstanding(Config)).
<a name="47991"/>47991: 
<a name="47992"/>47992: 
<a name="47993"/>47993: 
<a name="47994"/>47994: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="47995"/>47995: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="47996"/>47996: <i>%% ping-pong like test case.</i>
<a name="47997"/>47997: <i>%% Server:       Transport = socket(tcp), Active = once</i>
<a name="47998"/>47998: <i>%% Client:       Transport = gen_tcp, Active = false</i>
<a name="47999"/>47999: <i>%% Message Size: small (=1)</i>
<a name="48000"/>48000: <i>%% Domain:       inet</i>
<a name="48001"/>48001: <i>%%</i>
<a name="48002"/>48002: 
<a name="ttest_ssocko_cgenf_small_tcp4-1"/><a name="48003"/>48003: <b>ttest_ssocko_cgenf_small_tcp4</b>(Config) when is_list(Config) -&gt;
<a name="48004"/>48004:     Runtime = which_ttest_runtime(Config),
<a name="ttest_ssocko_cgenf_small_tcp4-last_expr"/><a name="48005"/>48005: <b>    ttest_tcp</b>(ttest_ssocko_cgenf_small_tcp4,
<a name="48006"/>48006:               Runtime,
<a name="48007"/>48007:               inet,
<a name="48008"/>48008:               sock, once,
<a name="48009"/>48009:               gen, false,
<a name="48010"/>48010:               1, ttest_small_max_outstanding(Config)).
<a name="48011"/>48011: 
<a name="48012"/>48012: 
<a name="48013"/>48013: 
<a name="48014"/>48014: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="48015"/>48015: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="48016"/>48016: <i>%% ping-pong like test case.</i>
<a name="48017"/>48017: <i>%% Server:       Transport = socket(tcp), Active = once</i>
<a name="48018"/>48018: <i>%% Client:       Transport = gen_tcp, Active = false</i>
<a name="48019"/>48019: <i>%% Message Size: small (=1)</i>
<a name="48020"/>48020: <i>%% Domain:       inet6</i>
<a name="48021"/>48021: <i>%% </i>
<a name="48022"/>48022: 
<a name="ttest_ssocko_cgenf_small_tcp6-1"/><a name="48023"/>48023: <b>ttest_ssocko_cgenf_small_tcp6</b>(Config) when is_list(Config) -&gt;
<a name="48024"/>48024:     Runtime = which_ttest_runtime(Config),
<a name="ttest_ssocko_cgenf_small_tcp6-last_expr"/><a name="48025"/>48025: <b>    ttest_tcp</b>(ttest_ssocko_cgenf_small_tcp6,
<a name="48026"/>48026:               Runtime,
<a name="48027"/>48027:               inet6,
<a name="48028"/>48028:               sock, once,
<a name="48029"/>48029:               gen, false,
<a name="48030"/>48030:               1, ttest_small_max_outstanding(Config)).
<a name="48031"/>48031: 
<a name="48032"/>48032: 
<a name="48033"/>48033: 
<a name="48034"/>48034: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="48035"/>48035: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="48036"/>48036: <i>%% ping-pong like test case.</i>
<a name="48037"/>48037: <i>%% Server:       Transport = socket(tcp), Active = once</i>
<a name="48038"/>48038: <i>%% Client:       Transport = gen_tcp, Active = false</i>
<a name="48039"/>48039: <i>%% Message Size: medium (=2)</i>
<a name="48040"/>48040: <i>%% Domain:       inet</i>
<a name="48041"/>48041: <i>%%</i>
<a name="48042"/>48042: 
<a name="ttest_ssocko_cgenf_medium_tcp4-1"/><a name="48043"/>48043: <b>ttest_ssocko_cgenf_medium_tcp4</b>(Config) when is_list(Config) -&gt;
<a name="48044"/>48044:     Runtime = which_ttest_runtime(Config),
<a name="ttest_ssocko_cgenf_medium_tcp4-last_expr"/><a name="48045"/>48045: <b>    ttest_tcp</b>(ttest_ssocko_cgenf_medium_tcp4,
<a name="48046"/>48046:               Runtime,
<a name="48047"/>48047:               inet,
<a name="48048"/>48048:               sock, once,
<a name="48049"/>48049:               gen, false,
<a name="48050"/>48050:               2, ttest_medium_max_outstanding(Config)).
<a name="48051"/>48051: 
<a name="48052"/>48052: 
<a name="48053"/>48053: 
<a name="48054"/>48054: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="48055"/>48055: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="48056"/>48056: <i>%% ping-pong like test case.</i>
<a name="48057"/>48057: <i>%% Server:       Transport = socket(tcp), Active = once</i>
<a name="48058"/>48058: <i>%% Client:       Transport = gen_tcp, Active = false</i>
<a name="48059"/>48059: <i>%% Message Size: medium (=2)</i>
<a name="48060"/>48060: <i>%% Domain:       inet6</i>
<a name="48061"/>48061: <i>%% </i>
<a name="48062"/>48062: 
<a name="ttest_ssocko_cgenf_medium_tcp6-1"/><a name="48063"/>48063: <b>ttest_ssocko_cgenf_medium_tcp6</b>(Config) when is_list(Config) -&gt;
<a name="48064"/>48064:     Runtime = which_ttest_runtime(Config),
<a name="ttest_ssocko_cgenf_medium_tcp6-last_expr"/><a name="48065"/>48065: <b>    ttest_tcp</b>(ttest_ssocko_cgenf_medium_tcp6,
<a name="48066"/>48066:               Runtime,
<a name="48067"/>48067:               inet6,
<a name="48068"/>48068:               sock, once,
<a name="48069"/>48069:               gen, false,
<a name="48070"/>48070:               2, ttest_medium_max_outstanding(Config)).
<a name="48071"/>48071: 
<a name="48072"/>48072: 
<a name="48073"/>48073: 
<a name="48074"/>48074: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="48075"/>48075: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="48076"/>48076: <i>%% ping-pong like test case.</i>
<a name="48077"/>48077: <i>%% Server:       Transport = socket(tcp), Active = once</i>
<a name="48078"/>48078: <i>%% Client:       Transport = gen_tcp, Active = false</i>
<a name="48079"/>48079: <i>%% Message Size: large (=3)</i>
<a name="48080"/>48080: <i>%% Domain:       inet</i>
<a name="48081"/>48081: <i>%%</i>
<a name="48082"/>48082: 
<a name="ttest_ssocko_cgenf_large_tcp4-1"/><a name="48083"/>48083: <b>ttest_ssocko_cgenf_large_tcp4</b>(Config) when is_list(Config) -&gt;
<a name="48084"/>48084:     Runtime = which_ttest_runtime(Config),
<a name="ttest_ssocko_cgenf_large_tcp4-last_expr"/><a name="48085"/>48085: <b>    ttest_tcp</b>(ttest_ssocko_cgenf_large_tcp4,
<a name="48086"/>48086:               Runtime,
<a name="48087"/>48087:               inet,
<a name="48088"/>48088:               sock, once,
<a name="48089"/>48089:               gen, false,
<a name="48090"/>48090:               3, ttest_large_max_outstanding(Config)).
<a name="48091"/>48091: 
<a name="48092"/>48092: 
<a name="48093"/>48093: 
<a name="48094"/>48094: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="48095"/>48095: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="48096"/>48096: <i>%% ping-pong like test case.</i>
<a name="48097"/>48097: <i>%% Server:       Transport = socket(tcp), Active = once</i>
<a name="48098"/>48098: <i>%% Client:       Transport = gen_tcp, Active = false</i>
<a name="48099"/>48099: <i>%% Message Size: large (=3)</i>
<a name="48100"/>48100: <i>%% Domain:       inet6</i>
<a name="48101"/>48101: <i>%% </i>
<a name="48102"/>48102: 
<a name="ttest_ssocko_cgenf_large_tcp6-1"/><a name="48103"/>48103: <b>ttest_ssocko_cgenf_large_tcp6</b>(Config) when is_list(Config) -&gt;
<a name="48104"/>48104:     Runtime = which_ttest_runtime(Config),
<a name="ttest_ssocko_cgenf_large_tcp6-last_expr"/><a name="48105"/>48105: <b>    ttest_tcp</b>(ttest_ssocko_cgenf_large_tcp6,
<a name="48106"/>48106:               Runtime,
<a name="48107"/>48107:               inet6,
<a name="48108"/>48108:               sock, once,
<a name="48109"/>48109:               gen, false,
<a name="48110"/>48110:               3, ttest_large_max_outstanding(Config)).
<a name="48111"/>48111: 
<a name="48112"/>48112: 
<a name="48113"/>48113: 
<a name="48114"/>48114: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="48115"/>48115: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="48116"/>48116: <i>%% ping-pong like test case.</i>
<a name="48117"/>48117: <i>%% Server:       Transport = socket(tcp), Active = once</i>
<a name="48118"/>48118: <i>%% Client:       Transport = gen_tcp, Active = once</i>
<a name="48119"/>48119: <i>%% Message Size: small (=1)</i>
<a name="48120"/>48120: <i>%% Domain:       inet</i>
<a name="48121"/>48121: <i>%%</i>
<a name="48122"/>48122: 
<a name="ttest_ssocko_cgeno_small_tcp4-1"/><a name="48123"/>48123: <b>ttest_ssocko_cgeno_small_tcp4</b>(Config) when is_list(Config) -&gt;
<a name="48124"/>48124:     Runtime = which_ttest_runtime(Config),
<a name="ttest_ssocko_cgeno_small_tcp4-last_expr"/><a name="48125"/>48125: <b>    ttest_tcp</b>(ttest_ssocko_cgeno_small_tcp4,
<a name="48126"/>48126:               Runtime,
<a name="48127"/>48127:               inet,
<a name="48128"/>48128:               sock, once,
<a name="48129"/>48129:               gen, once,
<a name="48130"/>48130:               1, ttest_small_max_outstanding(Config)).
<a name="48131"/>48131: 
<a name="48132"/>48132: 
<a name="48133"/>48133: 
<a name="48134"/>48134: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="48135"/>48135: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="48136"/>48136: <i>%% ping-pong like test case.</i>
<a name="48137"/>48137: <i>%% Server:       Transport = socket(tcp), Active = once</i>
<a name="48138"/>48138: <i>%% Client:       Transport = gen_tcp, Active = once</i>
<a name="48139"/>48139: <i>%% Message Size: small (=1)</i>
<a name="48140"/>48140: <i>%% Domain:       inet6</i>
<a name="48141"/>48141: <i>%% </i>
<a name="48142"/>48142: 
<a name="ttest_ssocko_cgeno_small_tcp6-1"/><a name="48143"/>48143: <b>ttest_ssocko_cgeno_small_tcp6</b>(Config) when is_list(Config) -&gt;
<a name="48144"/>48144:     Runtime = which_ttest_runtime(Config),
<a name="ttest_ssocko_cgeno_small_tcp6-last_expr"/><a name="48145"/>48145: <b>    ttest_tcp</b>(ttest_ssocko_cgeno_small_tcp6,
<a name="48146"/>48146:               Runtime,
<a name="48147"/>48147:               inet6,
<a name="48148"/>48148:               sock, once,
<a name="48149"/>48149:               gen, once,
<a name="48150"/>48150:               1, ttest_small_max_outstanding(Config)).
<a name="48151"/>48151: 
<a name="48152"/>48152: 
<a name="48153"/>48153: 
<a name="48154"/>48154: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="48155"/>48155: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="48156"/>48156: <i>%% ping-pong like test case.</i>
<a name="48157"/>48157: <i>%% Server:       Transport = socket(tcp), Active = once</i>
<a name="48158"/>48158: <i>%% Client:       Transport = gen_tcp, Active = once</i>
<a name="48159"/>48159: <i>%% Message Size: medium (=2)</i>
<a name="48160"/>48160: <i>%% Domain:       inet</i>
<a name="48161"/>48161: <i>%%</i>
<a name="48162"/>48162: 
<a name="ttest_ssocko_cgeno_medium_tcp4-1"/><a name="48163"/>48163: <b>ttest_ssocko_cgeno_medium_tcp4</b>(Config) when is_list(Config) -&gt;
<a name="48164"/>48164:     Runtime = which_ttest_runtime(Config),
<a name="ttest_ssocko_cgeno_medium_tcp4-last_expr"/><a name="48165"/>48165: <b>    ttest_tcp</b>(ttest_ssocko_cgeno_medium_tcp4,
<a name="48166"/>48166:               Runtime,
<a name="48167"/>48167:               inet,
<a name="48168"/>48168:               sock, once,
<a name="48169"/>48169:               gen, once,
<a name="48170"/>48170:               2, ttest_medium_max_outstanding(Config)).
<a name="48171"/>48171: 
<a name="48172"/>48172: 
<a name="48173"/>48173: 
<a name="48174"/>48174: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="48175"/>48175: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="48176"/>48176: <i>%% ping-pong like test case.</i>
<a name="48177"/>48177: <i>%% Server:       Transport = socket(tcp), Active = false</i>
<a name="48178"/>48178: <i>%% Client:       Transport = gen_tcp, Active = once</i>
<a name="48179"/>48179: <i>%% Message Size: medium (=2)</i>
<a name="48180"/>48180: <i>%% Domain:       inet6</i>
<a name="48181"/>48181: <i>%% </i>
<a name="48182"/>48182: 
<a name="ttest_ssocko_cgeno_medium_tcp6-1"/><a name="48183"/>48183: <b>ttest_ssocko_cgeno_medium_tcp6</b>(Config) when is_list(Config) -&gt;
<a name="48184"/>48184:     Runtime = which_ttest_runtime(Config),
<a name="ttest_ssocko_cgeno_medium_tcp6-last_expr"/><a name="48185"/>48185: <b>    ttest_tcp</b>(ttest_ssocko_cgeno_medium_tcp6,
<a name="48186"/>48186:               Runtime,
<a name="48187"/>48187:               inet6,
<a name="48188"/>48188:               sock, once,
<a name="48189"/>48189:               gen, once,
<a name="48190"/>48190:               2, ttest_medium_max_outstanding(Config)).
<a name="48191"/>48191: 
<a name="48192"/>48192: 
<a name="48193"/>48193: 
<a name="48194"/>48194: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="48195"/>48195: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="48196"/>48196: <i>%% ping-pong like test case.</i>
<a name="48197"/>48197: <i>%% Server:       Transport = socket(tcp), Active = once</i>
<a name="48198"/>48198: <i>%% Client:       Transport = gen_tcp, Active = once</i>
<a name="48199"/>48199: <i>%% Message Size: large (=3)</i>
<a name="48200"/>48200: <i>%% Domain:       inet</i>
<a name="48201"/>48201: <i>%%</i>
<a name="48202"/>48202: 
<a name="ttest_ssocko_cgeno_large_tcp4-1"/><a name="48203"/>48203: <b>ttest_ssocko_cgeno_large_tcp4</b>(Config) when is_list(Config) -&gt;
<a name="48204"/>48204:     Runtime = which_ttest_runtime(Config),
<a name="ttest_ssocko_cgeno_large_tcp4-last_expr"/><a name="48205"/>48205: <b>    ttest_tcp</b>(ttest_ssocko_cgeno_large_tcp4,
<a name="48206"/>48206:               Runtime,
<a name="48207"/>48207:               inet,
<a name="48208"/>48208:               sock, once,
<a name="48209"/>48209:               gen, once,
<a name="48210"/>48210:               3, ttest_large_max_outstanding(Config)).
<a name="48211"/>48211: 
<a name="48212"/>48212: 
<a name="48213"/>48213: 
<a name="48214"/>48214: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="48215"/>48215: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="48216"/>48216: <i>%% ping-pong like test case.</i>
<a name="48217"/>48217: <i>%% Server:       Transport = socket(tcp), Active = false</i>
<a name="48218"/>48218: <i>%% Client:       Transport = gen_tcp, Active = once</i>
<a name="48219"/>48219: <i>%% Message Size: large (=3)</i>
<a name="48220"/>48220: <i>%% Domain:       inet6</i>
<a name="48221"/>48221: <i>%% </i>
<a name="48222"/>48222: 
<a name="ttest_ssocko_cgeno_large_tcp6-1"/><a name="48223"/>48223: <b>ttest_ssocko_cgeno_large_tcp6</b>(Config) when is_list(Config) -&gt;
<a name="48224"/>48224:     Runtime = which_ttest_runtime(Config),
<a name="ttest_ssocko_cgeno_large_tcp6-last_expr"/><a name="48225"/>48225: <b>    ttest_tcp</b>(ttest_ssocko_cgeno_large_tcp6,
<a name="48226"/>48226:               Runtime,
<a name="48227"/>48227:               inet6,
<a name="48228"/>48228:               sock, once,
<a name="48229"/>48229:               gen, once,
<a name="48230"/>48230:               3, ttest_large_max_outstanding(Config)).
<a name="48231"/>48231: 
<a name="48232"/>48232: 
<a name="48233"/>48233: 
<a name="48234"/>48234: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="48235"/>48235: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="48236"/>48236: <i>%% ping-pong like test case.</i>
<a name="48237"/>48237: <i>%% Server:       Transport = socket(tcp), Active = once</i>
<a name="48238"/>48238: <i>%% Client:       Transport = gen_tcp, Active = true</i>
<a name="48239"/>48239: <i>%% Message Size: small (=1)</i>
<a name="48240"/>48240: <i>%% Domain:       inet</i>
<a name="48241"/>48241: <i>%%</i>
<a name="48242"/>48242: 
<a name="ttest_ssocko_cgent_small_tcp4-1"/><a name="48243"/>48243: <b>ttest_ssocko_cgent_small_tcp4</b>(Config) when is_list(Config) -&gt;
<a name="48244"/>48244:     Runtime = which_ttest_runtime(Config),
<a name="ttest_ssocko_cgent_small_tcp4-last_expr"/><a name="48245"/>48245: <b>    ttest_tcp</b>(ttest_ssocko_cgent_small_tcp4,
<a name="48246"/>48246:               Runtime,
<a name="48247"/>48247:               inet,
<a name="48248"/>48248:               sock, once,
<a name="48249"/>48249:               gen, true,
<a name="48250"/>48250:               1, ttest_small_max_outstanding(Config)).
<a name="48251"/>48251: 
<a name="48252"/>48252: 
<a name="48253"/>48253: 
<a name="48254"/>48254: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="48255"/>48255: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="48256"/>48256: <i>%% ping-pong like test case.</i>
<a name="48257"/>48257: <i>%% Server:       Transport =  socket(tcp), Active = false</i>
<a name="48258"/>48258: <i>%% Client:       Transport = gen_tcp, Active = true</i>
<a name="48259"/>48259: <i>%% Message Size: small (=1)</i>
<a name="48260"/>48260: <i>%% Domain:       inet6</i>
<a name="48261"/>48261: <i>%% </i>
<a name="48262"/>48262: 
<a name="ttest_ssocko_cgent_small_tcp6-1"/><a name="48263"/>48263: <b>ttest_ssocko_cgent_small_tcp6</b>(Config) when is_list(Config) -&gt;
<a name="48264"/>48264:     Runtime = which_ttest_runtime(Config),
<a name="ttest_ssocko_cgent_small_tcp6-last_expr"/><a name="48265"/>48265: <b>    ttest_tcp</b>(ttest_ssocko_cgent_small_tcp6,
<a name="48266"/>48266:               Runtime,
<a name="48267"/>48267:               inet6,
<a name="48268"/>48268:               sock, once,
<a name="48269"/>48269:               gen, true,
<a name="48270"/>48270:               1, ttest_small_max_outstanding(Config)).
<a name="48271"/>48271: 
<a name="48272"/>48272: 
<a name="48273"/>48273: 
<a name="48274"/>48274: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="48275"/>48275: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="48276"/>48276: <i>%% ping-pong like test case.</i>
<a name="48277"/>48277: <i>%% Server:       Transport = socket(tcp), Active = once</i>
<a name="48278"/>48278: <i>%% Client:       Transport = gen_tcp, Active = true</i>
<a name="48279"/>48279: <i>%% Message Size: medium (=2)</i>
<a name="48280"/>48280: <i>%% Domain:       inet</i>
<a name="48281"/>48281: <i>%%</i>
<a name="48282"/>48282: 
<a name="ttest_ssocko_cgent_medium_tcp4-1"/><a name="48283"/>48283: <b>ttest_ssocko_cgent_medium_tcp4</b>(Config) when is_list(Config) -&gt;
<a name="48284"/>48284:     Runtime = which_ttest_runtime(Config),
<a name="ttest_ssocko_cgent_medium_tcp4-last_expr"/><a name="48285"/>48285: <b>    ttest_tcp</b>(ttest_ssocko_cgent_medium_tcp4,
<a name="48286"/>48286:               Runtime,
<a name="48287"/>48287:               inet,
<a name="48288"/>48288:               sock, once,
<a name="48289"/>48289:               gen, true,
<a name="48290"/>48290:               2, ttest_medium_max_outstanding(Config)).
<a name="48291"/>48291: 
<a name="48292"/>48292: 
<a name="48293"/>48293: 
<a name="48294"/>48294: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="48295"/>48295: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="48296"/>48296: <i>%% ping-pong like test case.</i>
<a name="48297"/>48297: <i>%% Server:       Transport = socket(tcp), Active = false</i>
<a name="48298"/>48298: <i>%% Client:       Transport = gen_tcp, Active = true</i>
<a name="48299"/>48299: <i>%% Message Size: medium (=2)</i>
<a name="48300"/>48300: <i>%% Domain:       inet6</i>
<a name="48301"/>48301: <i>%% </i>
<a name="48302"/>48302: 
<a name="ttest_ssocko_cgent_medium_tcp6-1"/><a name="48303"/>48303: <b>ttest_ssocko_cgent_medium_tcp6</b>(Config) when is_list(Config) -&gt;
<a name="48304"/>48304:     Runtime = which_ttest_runtime(Config),
<a name="ttest_ssocko_cgent_medium_tcp6-last_expr"/><a name="48305"/>48305: <b>    ttest_tcp</b>(ttest_ssocko_cgent_medium_tcp6,
<a name="48306"/>48306:               Runtime,
<a name="48307"/>48307:               inet6,
<a name="48308"/>48308:               sock, once,
<a name="48309"/>48309:               gen, true,
<a name="48310"/>48310:               2, ttest_medium_max_outstanding(Config)).
<a name="48311"/>48311: 
<a name="48312"/>48312: 
<a name="48313"/>48313: 
<a name="48314"/>48314: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="48315"/>48315: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="48316"/>48316: <i>%% ping-pong like test case.</i>
<a name="48317"/>48317: <i>%% Server:       Transport = socket(tcp), Active = once</i>
<a name="48318"/>48318: <i>%% Client:       Transport = gen_tcp, Active = true</i>
<a name="48319"/>48319: <i>%% Message Size: large (=3)</i>
<a name="48320"/>48320: <i>%% Domain:       inet</i>
<a name="48321"/>48321: <i>%%</i>
<a name="48322"/>48322: 
<a name="ttest_ssocko_cgent_large_tcp4-1"/><a name="48323"/>48323: <b>ttest_ssocko_cgent_large_tcp4</b>(Config) when is_list(Config) -&gt;
<a name="48324"/>48324:     Runtime = which_ttest_runtime(Config),
<a name="ttest_ssocko_cgent_large_tcp4-last_expr"/><a name="48325"/>48325: <b>    ttest_tcp</b>(ttest_ssocko_cgent_large_tcp4,
<a name="48326"/>48326:               Runtime,
<a name="48327"/>48327:               inet,
<a name="48328"/>48328:               sock, once,
<a name="48329"/>48329:               gen, true,
<a name="48330"/>48330:               3, ttest_large_max_outstanding(Config)).
<a name="48331"/>48331: 
<a name="48332"/>48332: 
<a name="48333"/>48333: 
<a name="48334"/>48334: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="48335"/>48335: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="48336"/>48336: <i>%% ping-pong like test case.</i>
<a name="48337"/>48337: <i>%% Server:       Transport = socket(tcp), Active = false</i>
<a name="48338"/>48338: <i>%% Client:       Transport = gen_tcp, Active = true</i>
<a name="48339"/>48339: <i>%% Message Size: large (=3)</i>
<a name="48340"/>48340: <i>%% Domain:       inet6</i>
<a name="48341"/>48341: <i>%% </i>
<a name="48342"/>48342: 
<a name="ttest_ssocko_cgent_large_tcp6-1"/><a name="48343"/>48343: <b>ttest_ssocko_cgent_large_tcp6</b>(Config) when is_list(Config) -&gt;
<a name="48344"/>48344:     Runtime = which_ttest_runtime(Config),
<a name="ttest_ssocko_cgent_large_tcp6-last_expr"/><a name="48345"/>48345: <b>    ttest_tcp</b>(ttest_ssocko_cgent_large_tcp6,
<a name="48346"/>48346:               Runtime,
<a name="48347"/>48347:               inet6,
<a name="48348"/>48348:               sock, once,
<a name="48349"/>48349:               gen, true,
<a name="48350"/>48350:               3, ttest_large_max_outstanding(Config)).
<a name="48351"/>48351: 
<a name="48352"/>48352: 
<a name="48353"/>48353: 
<a name="48354"/>48354: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="48355"/>48355: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="48356"/>48356: <i>%% ping-pong like test case.</i>
<a name="48357"/>48357: <i>%% Server:       Transport = socket(tcp), Active = once</i>
<a name="48358"/>48358: <i>%% Client:       Transport = socket(tcp), Active = false</i>
<a name="48359"/>48359: <i>%% Message Size: small (=1)</i>
<a name="48360"/>48360: <i>%% Domain:       inet</i>
<a name="48361"/>48361: <i>%%</i>
<a name="48362"/>48362: 
<a name="ttest_ssocko_csockf_small_tcp4-1"/><a name="48363"/>48363: <b>ttest_ssocko_csockf_small_tcp4</b>(Config) when is_list(Config) -&gt;
<a name="48364"/>48364:     Runtime = which_ttest_runtime(Config),
<a name="ttest_ssocko_csockf_small_tcp4-last_expr"/><a name="48365"/>48365: <b>    ttest_tcp</b>(ttest_ssocko_csockf_small_tcp4,
<a name="48366"/>48366:               Runtime,
<a name="48367"/>48367:               inet,
<a name="48368"/>48368:               sock, once,
<a name="48369"/>48369:               sock, false,
<a name="48370"/>48370:               1, ttest_small_max_outstanding(Config)).
<a name="48371"/>48371: 
<a name="48372"/>48372: 
<a name="48373"/>48373: 
<a name="48374"/>48374: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="48375"/>48375: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="48376"/>48376: <i>%% ping-pong like test case.</i>
<a name="48377"/>48377: <i>%% Server:       Transport = socket(tcp), Active = once</i>
<a name="48378"/>48378: <i>%% Client:       Transport = socket(tcp), Active = false</i>
<a name="48379"/>48379: <i>%% Message Size: small (=1)</i>
<a name="48380"/>48380: <i>%% Domain:       inet6</i>
<a name="48381"/>48381: <i>%% </i>
<a name="48382"/>48382: 
<a name="ttest_ssocko_csockf_small_tcp6-1"/><a name="48383"/>48383: <b>ttest_ssocko_csockf_small_tcp6</b>(Config) when is_list(Config) -&gt;
<a name="48384"/>48384:     Runtime = which_ttest_runtime(Config),
<a name="ttest_ssocko_csockf_small_tcp6-last_expr"/><a name="48385"/>48385: <b>    ttest_tcp</b>(ttest_ssocko_csockf_small_tcp6,
<a name="48386"/>48386:               Runtime,
<a name="48387"/>48387:               inet6,
<a name="48388"/>48388:               sock, once,
<a name="48389"/>48389:               sock, false,
<a name="48390"/>48390:               1, ttest_small_max_outstanding(Config)).
<a name="48391"/>48391: 
<a name="48392"/>48392: 
<a name="48393"/>48393: 
<a name="48394"/>48394: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="48395"/>48395: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="48396"/>48396: <i>%% ping-pong like test case.</i>
<a name="48397"/>48397: <i>%% Server:       Transport = socket(tcp), Active = once</i>
<a name="48398"/>48398: <i>%% Client:       Transport = socket(tcp), Active = false</i>
<a name="48399"/>48399: <i>%% Message Size: small (=1)</i>
<a name="48400"/>48400: <i>%% Domain:       local</i>
<a name="48401"/>48401: <i>%% </i>
<a name="48402"/>48402: 
<a name="ttest_ssocko_csockf_small_tcpL-1"/><a name="48403"/>48403: <b>ttest_ssocko_csockf_small_tcpL</b>(Config) when is_list(Config) -&gt;
<a name="48404"/>48404:     Runtime = which_ttest_runtime(Config),
<a name="ttest_ssocko_csockf_small_tcpL-last_expr"/><a name="48405"/>48405: <b>    ttest_tcp</b>(ttest_ssocko_csockf_small_tcpL,
<a name="48406"/>48406:               Runtime,
<a name="48407"/>48407:               local,
<a name="48408"/>48408:               sock, once,
<a name="48409"/>48409:               sock, false,
<a name="48410"/>48410:               1, ttest_small_max_outstanding(Config)).
<a name="48411"/>48411: 
<a name="48412"/>48412: 
<a name="48413"/>48413: 
<a name="48414"/>48414: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="48415"/>48415: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="48416"/>48416: <i>%% ping-pong like test case.</i>
<a name="48417"/>48417: <i>%% Server:       Transport = socket(tcp), Active = once</i>
<a name="48418"/>48418: <i>%% Client:       Transport = socket(tcp), Active = false</i>
<a name="48419"/>48419: <i>%% Message Size: medium (=2)</i>
<a name="48420"/>48420: <i>%% Domain:       inet</i>
<a name="48421"/>48421: <i>%%</i>
<a name="48422"/>48422: 
<a name="ttest_ssocko_csockf_medium_tcp4-1"/><a name="48423"/>48423: <b>ttest_ssocko_csockf_medium_tcp4</b>(Config) when is_list(Config) -&gt;
<a name="48424"/>48424:     Runtime = which_ttest_runtime(Config),
<a name="ttest_ssocko_csockf_medium_tcp4-last_expr"/><a name="48425"/>48425: <b>    ttest_tcp</b>(ttest_ssocko_csockf_medium_tcp4,
<a name="48426"/>48426:               Runtime,
<a name="48427"/>48427:               inet,
<a name="48428"/>48428:               sock, once,
<a name="48429"/>48429:               sock, false,
<a name="48430"/>48430:               2, ttest_medium_max_outstanding(Config)).
<a name="48431"/>48431: 
<a name="48432"/>48432: 
<a name="48433"/>48433: 
<a name="48434"/>48434: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="48435"/>48435: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="48436"/>48436: <i>%% ping-pong like test case.</i>
<a name="48437"/>48437: <i>%% Server:       Transport = socket(tcp), Active = once</i>
<a name="48438"/>48438: <i>%% Client:       Transport = socket(tcp), Active = false</i>
<a name="48439"/>48439: <i>%% Message Size: medium (=2)</i>
<a name="48440"/>48440: <i>%% Domain:       inet6</i>
<a name="48441"/>48441: <i>%% </i>
<a name="48442"/>48442: 
<a name="ttest_ssocko_csockf_medium_tcp6-1"/><a name="48443"/>48443: <b>ttest_ssocko_csockf_medium_tcp6</b>(Config) when is_list(Config) -&gt;
<a name="48444"/>48444:     Runtime = which_ttest_runtime(Config),
<a name="ttest_ssocko_csockf_medium_tcp6-last_expr"/><a name="48445"/>48445: <b>    ttest_tcp</b>(ttest_ssocko_csockf_medium_tcp6,
<a name="48446"/>48446:               Runtime,
<a name="48447"/>48447:               inet6,
<a name="48448"/>48448:               sock, once,
<a name="48449"/>48449:               sock, false,
<a name="48450"/>48450:               2, ttest_medium_max_outstanding(Config)).
<a name="48451"/>48451: 
<a name="48452"/>48452: 
<a name="48453"/>48453: 
<a name="48454"/>48454: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="48455"/>48455: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="48456"/>48456: <i>%% ping-pong like test case.</i>
<a name="48457"/>48457: <i>%% Server:       Transport = socket(tcp), Active = once</i>
<a name="48458"/>48458: <i>%% Client:       Transport = socket(tcp), Active = false</i>
<a name="48459"/>48459: <i>%% Message Size: medium (=2)</i>
<a name="48460"/>48460: <i>%% Domain:       local</i>
<a name="48461"/>48461: <i>%% </i>
<a name="48462"/>48462: 
<a name="ttest_ssocko_csockf_medium_tcpL-1"/><a name="48463"/>48463: <b>ttest_ssocko_csockf_medium_tcpL</b>(Config) when is_list(Config) -&gt;
<a name="48464"/>48464:     Runtime = which_ttest_runtime(Config),
<a name="ttest_ssocko_csockf_medium_tcpL-last_expr"/><a name="48465"/>48465: <b>    ttest_tcp</b>(ttest_ssocko_csockf_medium_tcpL,
<a name="48466"/>48466:               Runtime,
<a name="48467"/>48467:               local,
<a name="48468"/>48468:               sock, once,
<a name="48469"/>48469:               sock, false,
<a name="48470"/>48470:               2, ttest_medium_max_outstanding(Config)).
<a name="48471"/>48471: 
<a name="48472"/>48472: 
<a name="48473"/>48473: 
<a name="48474"/>48474: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="48475"/>48475: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="48476"/>48476: <i>%% ping-pong like test case.</i>
<a name="48477"/>48477: <i>%% Server:       Transport = socket(tcp), Active = once</i>
<a name="48478"/>48478: <i>%% Client:       Transport = socket(tcp), Active = false</i>
<a name="48479"/>48479: <i>%% Message Size: large (=3)</i>
<a name="48480"/>48480: <i>%% Domain:       inet</i>
<a name="48481"/>48481: <i>%%</i>
<a name="48482"/>48482: 
<a name="ttest_ssocko_csockf_large_tcp4-1"/><a name="48483"/>48483: <b>ttest_ssocko_csockf_large_tcp4</b>(Config) when is_list(Config) -&gt;
<a name="48484"/>48484:     Runtime = which_ttest_runtime(Config),
<a name="ttest_ssocko_csockf_large_tcp4-last_expr"/><a name="48485"/>48485: <b>    ttest_tcp</b>(ttest_ssocko_csockf_large_tcp4,
<a name="48486"/>48486:               Runtime,
<a name="48487"/>48487:               inet,
<a name="48488"/>48488:               sock, once,
<a name="48489"/>48489:               sock, false,
<a name="48490"/>48490:               3, ttest_large_max_outstanding(Config)).
<a name="48491"/>48491: 
<a name="48492"/>48492: 
<a name="48493"/>48493: 
<a name="48494"/>48494: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="48495"/>48495: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="48496"/>48496: <i>%% ping-pong like test case.</i>
<a name="48497"/>48497: <i>%% Server:       Transport = socket(tcp), Active = once</i>
<a name="48498"/>48498: <i>%% Client:       Transport = socket(tcp), Active = false</i>
<a name="48499"/>48499: <i>%% Message Size: large (=3)</i>
<a name="48500"/>48500: <i>%% Domain:       inet6</i>
<a name="48501"/>48501: <i>%% </i>
<a name="48502"/>48502: 
<a name="ttest_ssocko_csockf_large_tcp6-1"/><a name="48503"/>48503: <b>ttest_ssocko_csockf_large_tcp6</b>(Config) when is_list(Config) -&gt;
<a name="48504"/>48504:     Runtime = which_ttest_runtime(Config),
<a name="ttest_ssocko_csockf_large_tcp6-last_expr"/><a name="48505"/>48505: <b>    ttest_tcp</b>(ttest_ssocko_csockf_large_tcp6,
<a name="48506"/>48506:               Runtime,
<a name="48507"/>48507:               inet6,
<a name="48508"/>48508:               sock, once,
<a name="48509"/>48509:               sock, false,
<a name="48510"/>48510:               3, ttest_large_max_outstanding(Config)).
<a name="48511"/>48511: 
<a name="48512"/>48512: 
<a name="48513"/>48513: 
<a name="48514"/>48514: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="48515"/>48515: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="48516"/>48516: <i>%% ping-pong like test case.</i>
<a name="48517"/>48517: <i>%% Server:       Transport = socket(tcp), Active = once</i>
<a name="48518"/>48518: <i>%% Client:       Transport = socket(tcp), Active = false</i>
<a name="48519"/>48519: <i>%% Message Size: large (=3)</i>
<a name="48520"/>48520: <i>%% Domain:       local</i>
<a name="48521"/>48521: <i>%% </i>
<a name="48522"/>48522: 
<a name="ttest_ssocko_csockf_large_tcpL-1"/><a name="48523"/>48523: <b>ttest_ssocko_csockf_large_tcpL</b>(Config) when is_list(Config) -&gt;
<a name="48524"/>48524:     Runtime = which_ttest_runtime(Config),
<a name="ttest_ssocko_csockf_large_tcpL-last_expr"/><a name="48525"/>48525: <b>    ttest_tcp</b>(ttest_ssocko_csockf_large_tcpL,
<a name="48526"/>48526:               Runtime,
<a name="48527"/>48527:               local,
<a name="48528"/>48528:               sock, once,
<a name="48529"/>48529:               sock, false,
<a name="48530"/>48530:               3, ttest_large_max_outstanding(Config)).
<a name="48531"/>48531: 
<a name="48532"/>48532: 
<a name="48533"/>48533: 
<a name="48534"/>48534: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="48535"/>48535: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="48536"/>48536: <i>%% ping-pong like test case.</i>
<a name="48537"/>48537: <i>%% Server:       Transport = socket(tcp), Active = once</i>
<a name="48538"/>48538: <i>%% Client:       Transport = socket(tcp), Active = once</i>
<a name="48539"/>48539: <i>%% Message Size: small (=1)</i>
<a name="48540"/>48540: <i>%% Domain:       inet</i>
<a name="48541"/>48541: <i>%%</i>
<a name="48542"/>48542: 
<a name="ttest_ssocko_csocko_small_tcp4-1"/><a name="48543"/>48543: <b>ttest_ssocko_csocko_small_tcp4</b>(Config) when is_list(Config) -&gt;
<a name="48544"/>48544:     Runtime = which_ttest_runtime(Config),
<a name="ttest_ssocko_csocko_small_tcp4-last_expr"/><a name="48545"/>48545: <b>    ttest_tcp</b>(ttest_ssocko_csocko_small_tcp4,
<a name="48546"/>48546:               Runtime,
<a name="48547"/>48547:               inet,
<a name="48548"/>48548:               sock, once,
<a name="48549"/>48549:               sock, once,
<a name="48550"/>48550:               1, ttest_small_max_outstanding(Config)).
<a name="48551"/>48551: 
<a name="48552"/>48552: 
<a name="48553"/>48553: 
<a name="48554"/>48554: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="48555"/>48555: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="48556"/>48556: <i>%% ping-pong like test case.</i>
<a name="48557"/>48557: <i>%% Server:       Transport = socket(tcp), Active = once</i>
<a name="48558"/>48558: <i>%% Client:       Transport = socket(tcp), Active = once</i>
<a name="48559"/>48559: <i>%% Message Size: small (=1)</i>
<a name="48560"/>48560: <i>%% Domain:       inet6</i>
<a name="48561"/>48561: <i>%% </i>
<a name="48562"/>48562: 
<a name="ttest_ssocko_csocko_small_tcp6-1"/><a name="48563"/>48563: <b>ttest_ssocko_csocko_small_tcp6</b>(Config) when is_list(Config) -&gt;
<a name="48564"/>48564:     Runtime = which_ttest_runtime(Config),
<a name="ttest_ssocko_csocko_small_tcp6-last_expr"/><a name="48565"/>48565: <b>    ttest_tcp</b>(ttest_ssocko_csocko_small_tcp6,
<a name="48566"/>48566:               Runtime,
<a name="48567"/>48567:               inet6,
<a name="48568"/>48568:               sock, once,
<a name="48569"/>48569:               sock, once,
<a name="48570"/>48570:               1, ttest_small_max_outstanding(Config)).
<a name="48571"/>48571: 
<a name="48572"/>48572: 
<a name="48573"/>48573: 
<a name="48574"/>48574: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="48575"/>48575: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="48576"/>48576: <i>%% ping-pong like test case.</i>
<a name="48577"/>48577: <i>%% Server:       Transport = socket(tcp), Active = once</i>
<a name="48578"/>48578: <i>%% Client:       Transport = socket(tcp), Active = once</i>
<a name="48579"/>48579: <i>%% Message Size: small (=1)</i>
<a name="48580"/>48580: <i>%% Domain:       local</i>
<a name="48581"/>48581: <i>%% </i>
<a name="48582"/>48582: 
<a name="ttest_ssocko_csocko_small_tcpL-1"/><a name="48583"/>48583: <b>ttest_ssocko_csocko_small_tcpL</b>(Config) when is_list(Config) -&gt;
<a name="48584"/>48584:     Runtime = which_ttest_runtime(Config),
<a name="ttest_ssocko_csocko_small_tcpL-last_expr"/><a name="48585"/>48585: <b>    ttest_tcp</b>(ttest_ssocko_csocko_small_tcpL,
<a name="48586"/>48586:               Runtime,
<a name="48587"/>48587:               local,
<a name="48588"/>48588:               sock, once,
<a name="48589"/>48589:               sock, once,
<a name="48590"/>48590:               1, ttest_small_max_outstanding(Config)).
<a name="48591"/>48591: 
<a name="48592"/>48592: 
<a name="48593"/>48593: 
<a name="48594"/>48594: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="48595"/>48595: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="48596"/>48596: <i>%% ping-pong like test case.</i>
<a name="48597"/>48597: <i>%% Server:       Transport = socket(tcp), Active = once</i>
<a name="48598"/>48598: <i>%% Client:       Transport = socket(tcp), Active = once</i>
<a name="48599"/>48599: <i>%% Message Size: medium (=2)</i>
<a name="48600"/>48600: <i>%% Domain:       inet</i>
<a name="48601"/>48601: <i>%%</i>
<a name="48602"/>48602: 
<a name="ttest_ssocko_csocko_medium_tcp4-1"/><a name="48603"/>48603: <b>ttest_ssocko_csocko_medium_tcp4</b>(Config) when is_list(Config) -&gt;
<a name="48604"/>48604:     Runtime = which_ttest_runtime(Config),
<a name="ttest_ssocko_csocko_medium_tcp4-last_expr"/><a name="48605"/>48605: <b>    ttest_tcp</b>(ttest_ssocko_csocko_medium_tcp4,
<a name="48606"/>48606:               Runtime,
<a name="48607"/>48607:               inet,
<a name="48608"/>48608:               sock, once,
<a name="48609"/>48609:               sock, once,
<a name="48610"/>48610:               2, ttest_medium_max_outstanding(Config)).
<a name="48611"/>48611: 
<a name="48612"/>48612: 
<a name="48613"/>48613: 
<a name="48614"/>48614: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="48615"/>48615: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="48616"/>48616: <i>%% ping-pong like test case.</i>
<a name="48617"/>48617: <i>%% Server:       Transport = socket(tcp), Active = once</i>
<a name="48618"/>48618: <i>%% Client:       Transport = socket(tcp), Active = once</i>
<a name="48619"/>48619: <i>%% Message Size: medium (=2)</i>
<a name="48620"/>48620: <i>%% Domain:       inet6</i>
<a name="48621"/>48621: <i>%% </i>
<a name="48622"/>48622: 
<a name="ttest_ssocko_csocko_medium_tcp6-1"/><a name="48623"/>48623: <b>ttest_ssocko_csocko_medium_tcp6</b>(Config) when is_list(Config) -&gt;
<a name="48624"/>48624:     Runtime = which_ttest_runtime(Config),
<a name="ttest_ssocko_csocko_medium_tcp6-last_expr"/><a name="48625"/>48625: <b>    ttest_tcp</b>(ttest_ssocko_csocko_medium_tcp6,
<a name="48626"/>48626:               Runtime,
<a name="48627"/>48627:               inet6,
<a name="48628"/>48628:               sock, once,
<a name="48629"/>48629:               sock, once,
<a name="48630"/>48630:               2, ttest_medium_max_outstanding(Config)).
<a name="48631"/>48631: 
<a name="48632"/>48632: 
<a name="48633"/>48633: 
<a name="48634"/>48634: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="48635"/>48635: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="48636"/>48636: <i>%% ping-pong like test case.</i>
<a name="48637"/>48637: <i>%% Server:       Transport = socket(tcp), Active = once</i>
<a name="48638"/>48638: <i>%% Client:       Transport = socket(tcp), Active = once</i>
<a name="48639"/>48639: <i>%% Message Size: medium (=2)</i>
<a name="48640"/>48640: <i>%% Domain:       local</i>
<a name="48641"/>48641: <i>%% </i>
<a name="48642"/>48642: 
<a name="ttest_ssocko_csocko_medium_tcpL-1"/><a name="48643"/>48643: <b>ttest_ssocko_csocko_medium_tcpL</b>(Config) when is_list(Config) -&gt;
<a name="48644"/>48644:     Runtime = which_ttest_runtime(Config),
<a name="ttest_ssocko_csocko_medium_tcpL-last_expr"/><a name="48645"/>48645: <b>    ttest_tcp</b>(ttest_ssocko_csocko_medium_tcpL,
<a name="48646"/>48646:               Runtime,
<a name="48647"/>48647:               local,
<a name="48648"/>48648:               sock, once,
<a name="48649"/>48649:               sock, once,
<a name="48650"/>48650:               2, ttest_medium_max_outstanding(Config)).
<a name="48651"/>48651: 
<a name="48652"/>48652: 
<a name="48653"/>48653: 
<a name="48654"/>48654: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="48655"/>48655: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="48656"/>48656: <i>%% ping-pong like test case.</i>
<a name="48657"/>48657: <i>%% Server:       Transport = socket(tcp), Active = once</i>
<a name="48658"/>48658: <i>%% Client:       Transport = socket(tcp), Active = once</i>
<a name="48659"/>48659: <i>%% Message Size: large (=3)</i>
<a name="48660"/>48660: <i>%% Domain:       inet</i>
<a name="48661"/>48661: <i>%%</i>
<a name="48662"/>48662: 
<a name="ttest_ssocko_csocko_large_tcp4-1"/><a name="48663"/>48663: <b>ttest_ssocko_csocko_large_tcp4</b>(Config) when is_list(Config) -&gt;
<a name="48664"/>48664:     Runtime = which_ttest_runtime(Config),
<a name="ttest_ssocko_csocko_large_tcp4-last_expr"/><a name="48665"/>48665: <b>    ttest_tcp</b>(ttest_ssocko_csocko_large_tcp4,
<a name="48666"/>48666:               Runtime,
<a name="48667"/>48667:               inet,
<a name="48668"/>48668:               sock, once,
<a name="48669"/>48669:               sock, once,
<a name="48670"/>48670:               3, ttest_large_max_outstanding(Config)).
<a name="48671"/>48671: 
<a name="48672"/>48672: 
<a name="48673"/>48673: 
<a name="48674"/>48674: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="48675"/>48675: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="48676"/>48676: <i>%% ping-pong like test case.</i>
<a name="48677"/>48677: <i>%% Server:       Transport = socket(tcp), Active = once</i>
<a name="48678"/>48678: <i>%% Client:       Transport = socket(tcp), Active = once</i>
<a name="48679"/>48679: <i>%% Message Size: large (=3)</i>
<a name="48680"/>48680: <i>%% Domain:       inet6</i>
<a name="48681"/>48681: <i>%% </i>
<a name="48682"/>48682: 
<a name="ttest_ssocko_csocko_large_tcp6-1"/><a name="48683"/>48683: <b>ttest_ssocko_csocko_large_tcp6</b>(Config) when is_list(Config) -&gt;
<a name="48684"/>48684:     Runtime = which_ttest_runtime(Config),
<a name="ttest_ssocko_csocko_large_tcp6-last_expr"/><a name="48685"/>48685: <b>    ttest_tcp</b>(ttest_ssocko_csocko_large_tcp6,
<a name="48686"/>48686:               Runtime,
<a name="48687"/>48687:               inet6,
<a name="48688"/>48688:               sock, once,
<a name="48689"/>48689:               sock, once,
<a name="48690"/>48690:               3, ttest_large_max_outstanding(Config)).
<a name="48691"/>48691: 
<a name="48692"/>48692: 
<a name="48693"/>48693: 
<a name="48694"/>48694: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="48695"/>48695: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="48696"/>48696: <i>%% ping-pong like test case.</i>
<a name="48697"/>48697: <i>%% Server:       Transport = socket(tcp), Active = once</i>
<a name="48698"/>48698: <i>%% Client:       Transport = socket(tcp), Active = once</i>
<a name="48699"/>48699: <i>%% Message Size: large (=3)</i>
<a name="48700"/>48700: <i>%% Domain:       local</i>
<a name="48701"/>48701: <i>%% </i>
<a name="48702"/>48702: 
<a name="ttest_ssocko_csocko_large_tcpL-1"/><a name="48703"/>48703: <b>ttest_ssocko_csocko_large_tcpL</b>(Config) when is_list(Config) -&gt;
<a name="48704"/>48704:     Runtime = which_ttest_runtime(Config),
<a name="ttest_ssocko_csocko_large_tcpL-last_expr"/><a name="48705"/>48705: <b>    ttest_tcp</b>(ttest_ssocko_csocko_large_tcpL,
<a name="48706"/>48706:               Runtime,
<a name="48707"/>48707:               local,
<a name="48708"/>48708:               sock, once,
<a name="48709"/>48709:               sock, once,
<a name="48710"/>48710:               3, ttest_large_max_outstanding(Config)).
<a name="48711"/>48711: 
<a name="48712"/>48712: 
<a name="48713"/>48713: 
<a name="48714"/>48714: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="48715"/>48715: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="48716"/>48716: <i>%% ping-pong like test case.</i>
<a name="48717"/>48717: <i>%% Server:       Transport = socket(tcp), Active = once</i>
<a name="48718"/>48718: <i>%% Client:       Transport = socket(tcp), Active = true</i>
<a name="48719"/>48719: <i>%% Message Size: small (=1)</i>
<a name="48720"/>48720: <i>%% Domain:       inet</i>
<a name="48721"/>48721: <i>%%</i>
<a name="48722"/>48722: 
<a name="ttest_ssocko_csockt_small_tcp4-1"/><a name="48723"/>48723: <b>ttest_ssocko_csockt_small_tcp4</b>(Config) when is_list(Config) -&gt;
<a name="48724"/>48724:     Runtime = which_ttest_runtime(Config),
<a name="ttest_ssocko_csockt_small_tcp4-last_expr"/><a name="48725"/>48725: <b>    ttest_tcp</b>(ttest_ssocko_csockt_small_tcp4,
<a name="48726"/>48726:               Runtime,
<a name="48727"/>48727:               inet,
<a name="48728"/>48728:               sock, once,
<a name="48729"/>48729:               sock, true,
<a name="48730"/>48730:               1, ttest_small_max_outstanding(Config)).
<a name="48731"/>48731: 
<a name="48732"/>48732: 
<a name="48733"/>48733: 
<a name="48734"/>48734: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="48735"/>48735: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="48736"/>48736: <i>%% ping-pong like test case.</i>
<a name="48737"/>48737: <i>%% Server:       Transport =  socket(tcp), Active = once</i>
<a name="48738"/>48738: <i>%% Client:       Transport = socket(tcp), Active = true</i>
<a name="48739"/>48739: <i>%% Message Size: small (=1)</i>
<a name="48740"/>48740: <i>%% Domain:       inet6</i>
<a name="48741"/>48741: <i>%% </i>
<a name="48742"/>48742: 
<a name="ttest_ssocko_csockt_small_tcp6-1"/><a name="48743"/>48743: <b>ttest_ssocko_csockt_small_tcp6</b>(Config) when is_list(Config) -&gt;
<a name="48744"/>48744:     Runtime = which_ttest_runtime(Config),
<a name="ttest_ssocko_csockt_small_tcp6-last_expr"/><a name="48745"/>48745: <b>    ttest_tcp</b>(ttest_ssocko_csocko_small_tcp6,
<a name="48746"/>48746:               Runtime,
<a name="48747"/>48747:               inet6,
<a name="48748"/>48748:               sock, once,
<a name="48749"/>48749:               sock, true,
<a name="48750"/>48750:               1, ttest_small_max_outstanding(Config)).
<a name="48751"/>48751: 
<a name="48752"/>48752: 
<a name="48753"/>48753: 
<a name="48754"/>48754: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="48755"/>48755: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="48756"/>48756: <i>%% ping-pong like test case.</i>
<a name="48757"/>48757: <i>%% Server:       Transport =  socket(tcp), Active = once</i>
<a name="48758"/>48758: <i>%% Client:       Transport = socket(tcp), Active = true</i>
<a name="48759"/>48759: <i>%% Message Size: small (=1)</i>
<a name="48760"/>48760: <i>%% Domain:       local</i>
<a name="48761"/>48761: <i>%% </i>
<a name="48762"/>48762: 
<a name="ttest_ssocko_csockt_small_tcpL-1"/><a name="48763"/>48763: <b>ttest_ssocko_csockt_small_tcpL</b>(Config) when is_list(Config) -&gt;
<a name="48764"/>48764:     Runtime = which_ttest_runtime(Config),
<a name="ttest_ssocko_csockt_small_tcpL-last_expr"/><a name="48765"/>48765: <b>    ttest_tcp</b>(ttest_ssocko_csocko_small_tcpL,
<a name="48766"/>48766:               Runtime,
<a name="48767"/>48767:               local,
<a name="48768"/>48768:               sock, once,
<a name="48769"/>48769:               sock, true,
<a name="48770"/>48770:               1, ttest_small_max_outstanding(Config)).
<a name="48771"/>48771: 
<a name="48772"/>48772: 
<a name="48773"/>48773: 
<a name="48774"/>48774: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="48775"/>48775: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="48776"/>48776: <i>%% ping-pong like test case.</i>
<a name="48777"/>48777: <i>%% Server:       Transport = socket(tcp), Active = once</i>
<a name="48778"/>48778: <i>%% Client:       Transport = socket(tcp), Active = true</i>
<a name="48779"/>48779: <i>%% Message Size: medium (=2)</i>
<a name="48780"/>48780: <i>%% Domain:       inet</i>
<a name="48781"/>48781: <i>%%</i>
<a name="48782"/>48782: 
<a name="ttest_ssocko_csockt_medium_tcp4-1"/><a name="48783"/>48783: <b>ttest_ssocko_csockt_medium_tcp4</b>(Config) when is_list(Config) -&gt;
<a name="48784"/>48784:     Runtime = which_ttest_runtime(Config),
<a name="ttest_ssocko_csockt_medium_tcp4-last_expr"/><a name="48785"/>48785: <b>    ttest_tcp</b>(ttest_ssocko_csockt_medium_tcp4,
<a name="48786"/>48786:               Runtime,
<a name="48787"/>48787:               inet,
<a name="48788"/>48788:               sock, once,
<a name="48789"/>48789:               sock, true,
<a name="48790"/>48790:               2, ttest_medium_max_outstanding(Config)).
<a name="48791"/>48791: 
<a name="48792"/>48792: 
<a name="48793"/>48793: 
<a name="48794"/>48794: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="48795"/>48795: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="48796"/>48796: <i>%% ping-pong like test case.</i>
<a name="48797"/>48797: <i>%% Server:       Transport = socket(tcp), Active = once</i>
<a name="48798"/>48798: <i>%% Client:       Transport = socket(tcp), Active = true</i>
<a name="48799"/>48799: <i>%% Message Size: medium (=2)</i>
<a name="48800"/>48800: <i>%% Domain:       inet6</i>
<a name="48801"/>48801: <i>%% </i>
<a name="48802"/>48802: 
<a name="ttest_ssocko_csockt_medium_tcp6-1"/><a name="48803"/>48803: <b>ttest_ssocko_csockt_medium_tcp6</b>(Config) when is_list(Config) -&gt;
<a name="48804"/>48804:     Runtime = which_ttest_runtime(Config),
<a name="ttest_ssocko_csockt_medium_tcp6-last_expr"/><a name="48805"/>48805: <b>    ttest_tcp</b>(ttest_ssocko_csockt_medium_tcp6,
<a name="48806"/>48806:               Runtime,
<a name="48807"/>48807:               inet6,
<a name="48808"/>48808:               sock, once,
<a name="48809"/>48809:               sock, true,
<a name="48810"/>48810:               2, ttest_medium_max_outstanding(Config)).
<a name="48811"/>48811: 
<a name="48812"/>48812: 
<a name="48813"/>48813: 
<a name="48814"/>48814: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="48815"/>48815: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="48816"/>48816: <i>%% ping-pong like test case.</i>
<a name="48817"/>48817: <i>%% Server:       Transport = socket(tcp), Active = once</i>
<a name="48818"/>48818: <i>%% Client:       Transport = socket(tcp), Active = true</i>
<a name="48819"/>48819: <i>%% Message Size: medium (=2)</i>
<a name="48820"/>48820: <i>%% Domain:       local</i>
<a name="48821"/>48821: <i>%% </i>
<a name="48822"/>48822: 
<a name="ttest_ssocko_csockt_medium_tcpL-1"/><a name="48823"/>48823: <b>ttest_ssocko_csockt_medium_tcpL</b>(Config) when is_list(Config) -&gt;
<a name="48824"/>48824:     Runtime = which_ttest_runtime(Config),
<a name="ttest_ssocko_csockt_medium_tcpL-last_expr"/><a name="48825"/>48825: <b>    ttest_tcp</b>(ttest_ssocko_csockt_medium_tcpL,
<a name="48826"/>48826:               Runtime,
<a name="48827"/>48827:               local,
<a name="48828"/>48828:               sock, once,
<a name="48829"/>48829:               sock, true,
<a name="48830"/>48830:               2, ttest_medium_max_outstanding(Config)).
<a name="48831"/>48831: 
<a name="48832"/>48832: 
<a name="48833"/>48833: 
<a name="48834"/>48834: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="48835"/>48835: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="48836"/>48836: <i>%% ping-pong like test case.</i>
<a name="48837"/>48837: <i>%% Server:       Transport = socket(tcp), Active = once</i>
<a name="48838"/>48838: <i>%% Client:       Transport = socket(tcp), Active = true</i>
<a name="48839"/>48839: <i>%% Message Size: large (=3)</i>
<a name="48840"/>48840: <i>%% Domain:       inet</i>
<a name="48841"/>48841: <i>%%</i>
<a name="48842"/>48842: 
<a name="ttest_ssocko_csockt_large_tcp4-1"/><a name="48843"/>48843: <b>ttest_ssocko_csockt_large_tcp4</b>(Config) when is_list(Config) -&gt;
<a name="48844"/>48844:     Runtime = which_ttest_runtime(Config),
<a name="ttest_ssocko_csockt_large_tcp4-last_expr"/><a name="48845"/>48845: <b>    ttest_tcp</b>(ttest_ssocko_csockt_large_tcp4,
<a name="48846"/>48846:               Runtime,
<a name="48847"/>48847:               inet,
<a name="48848"/>48848:               sock, once,
<a name="48849"/>48849:               sock, true,
<a name="48850"/>48850:               3, ttest_large_max_outstanding(Config)).
<a name="48851"/>48851: 
<a name="48852"/>48852: 
<a name="48853"/>48853: 
<a name="48854"/>48854: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="48855"/>48855: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="48856"/>48856: <i>%% ping-pong like test case.</i>
<a name="48857"/>48857: <i>%% Server:       Transport = socket(tcp), Active = once</i>
<a name="48858"/>48858: <i>%% Client:       Transport = socket(tcp), Active = true</i>
<a name="48859"/>48859: <i>%% Message Size: large (=3)</i>
<a name="48860"/>48860: <i>%% Domain:       inet6</i>
<a name="48861"/>48861: <i>%% </i>
<a name="48862"/>48862: 
<a name="ttest_ssocko_csockt_large_tcp6-1"/><a name="48863"/>48863: <b>ttest_ssocko_csockt_large_tcp6</b>(Config) when is_list(Config) -&gt;
<a name="48864"/>48864:     Runtime = which_ttest_runtime(Config),
<a name="ttest_ssocko_csockt_large_tcp6-last_expr"/><a name="48865"/>48865: <b>    ttest_tcp</b>(ttest_ssocko_csockt_large_tcp6,
<a name="48866"/>48866:               Runtime,
<a name="48867"/>48867:               inet6,
<a name="48868"/>48868:               sock, once,
<a name="48869"/>48869:               sock, true,
<a name="48870"/>48870:               3, ttest_large_max_outstanding(Config)).
<a name="48871"/>48871: 
<a name="48872"/>48872: 
<a name="48873"/>48873: 
<a name="48874"/>48874: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="48875"/>48875: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="48876"/>48876: <i>%% ping-pong like test case.</i>
<a name="48877"/>48877: <i>%% Server:       Transport = socket(tcp), Active = once</i>
<a name="48878"/>48878: <i>%% Client:       Transport = socket(tcp), Active = true</i>
<a name="48879"/>48879: <i>%% Message Size: large (=3)</i>
<a name="48880"/>48880: <i>%% Domain:       local</i>
<a name="48881"/>48881: <i>%% </i>
<a name="48882"/>48882: 
<a name="ttest_ssocko_csockt_large_tcpL-1"/><a name="48883"/>48883: <b>ttest_ssocko_csockt_large_tcpL</b>(Config) when is_list(Config) -&gt;
<a name="48884"/>48884:     Runtime = which_ttest_runtime(Config),
<a name="ttest_ssocko_csockt_large_tcpL-last_expr"/><a name="48885"/>48885: <b>    ttest_tcp</b>(ttest_ssocko_csockt_large_tcpL,
<a name="48886"/>48886:               Runtime,
<a name="48887"/>48887:               local,
<a name="48888"/>48888:               sock, once,
<a name="48889"/>48889:               sock, true,
<a name="48890"/>48890:               3, ttest_large_max_outstanding(Config)).
<a name="48891"/>48891: 
<a name="48892"/>48892: 
<a name="48893"/>48893: 
<a name="48894"/>48894: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="48895"/>48895: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="48896"/>48896: <i>%% ping-pong like test case.</i>
<a name="48897"/>48897: <i>%% Server:       Transport = socket(tcp), Active = true</i>
<a name="48898"/>48898: <i>%% Client:       Transport = gen_tcp, Active = false</i>
<a name="48899"/>48899: <i>%% Message Size: small (=1)</i>
<a name="48900"/>48900: <i>%% Domain:       inet</i>
<a name="48901"/>48901: <i>%%</i>
<a name="48902"/>48902: 
<a name="ttest_ssockt_cgenf_small_tcp4-1"/><a name="48903"/>48903: <b>ttest_ssockt_cgenf_small_tcp4</b>(Config) when is_list(Config) -&gt;
<a name="48904"/>48904:     Runtime = which_ttest_runtime(Config),
<a name="ttest_ssockt_cgenf_small_tcp4-last_expr"/><a name="48905"/>48905: <b>    ttest_tcp</b>(ttest_ssockt_cgenf_small_tcp4,
<a name="48906"/>48906:               Runtime,
<a name="48907"/>48907:               inet,
<a name="48908"/>48908:               sock, true,
<a name="48909"/>48909:               gen, false,
<a name="48910"/>48910:               1, ttest_small_max_outstanding(Config)).
<a name="48911"/>48911: 
<a name="48912"/>48912: 
<a name="48913"/>48913: 
<a name="48914"/>48914: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="48915"/>48915: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="48916"/>48916: <i>%% ping-pong like test case.</i>
<a name="48917"/>48917: <i>%% Server:       Transport = socket(tcp), Active = true</i>
<a name="48918"/>48918: <i>%% Client:       Transport = gen_tcp, Active = false</i>
<a name="48919"/>48919: <i>%% Message Size: small (=1)</i>
<a name="48920"/>48920: <i>%% Domain:       inet6</i>
<a name="48921"/>48921: <i>%% </i>
<a name="48922"/>48922: 
<a name="ttest_ssockt_cgenf_small_tcp6-1"/><a name="48923"/>48923: <b>ttest_ssockt_cgenf_small_tcp6</b>(Config) when is_list(Config) -&gt;
<a name="48924"/>48924:     Runtime = which_ttest_runtime(Config),
<a name="ttest_ssockt_cgenf_small_tcp6-last_expr"/><a name="48925"/>48925: <b>    ttest_tcp</b>(ttest_ssockt_cgenf_small_tcp6,
<a name="48926"/>48926:               Runtime,
<a name="48927"/>48927:               inet6,
<a name="48928"/>48928:               sock, true,
<a name="48929"/>48929:               gen, false,
<a name="48930"/>48930:               1, ttest_small_max_outstanding(Config)).
<a name="48931"/>48931: 
<a name="48932"/>48932: 
<a name="48933"/>48933: 
<a name="48934"/>48934: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="48935"/>48935: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="48936"/>48936: <i>%% ping-pong like test case.</i>
<a name="48937"/>48937: <i>%% Server:       Transport = socket(tcp), Active = true</i>
<a name="48938"/>48938: <i>%% Client:       Transport = gen_tcp, Active = false</i>
<a name="48939"/>48939: <i>%% Message Size: medium (=2)</i>
<a name="48940"/>48940: <i>%% Domain:       inet</i>
<a name="48941"/>48941: <i>%%</i>
<a name="48942"/>48942: 
<a name="ttest_ssockt_cgenf_medium_tcp4-1"/><a name="48943"/>48943: <b>ttest_ssockt_cgenf_medium_tcp4</b>(Config) when is_list(Config) -&gt;
<a name="48944"/>48944:     Runtime = which_ttest_runtime(Config),
<a name="ttest_ssockt_cgenf_medium_tcp4-last_expr"/><a name="48945"/>48945: <b>    ttest_tcp</b>(ttest_ssockt_cgenf_medium_tcp4,
<a name="48946"/>48946:               Runtime,
<a name="48947"/>48947:               inet,
<a name="48948"/>48948:               sock, true,
<a name="48949"/>48949:               gen, false,
<a name="48950"/>48950:               2, ttest_medium_max_outstanding(Config)).
<a name="48951"/>48951: 
<a name="48952"/>48952: 
<a name="48953"/>48953: 
<a name="48954"/>48954: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="48955"/>48955: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="48956"/>48956: <i>%% ping-pong like test case.</i>
<a name="48957"/>48957: <i>%% Server:       Transport = socket(tcp), Active = true</i>
<a name="48958"/>48958: <i>%% Client:       Transport = gen_tcp, Active = false</i>
<a name="48959"/>48959: <i>%% Message Size: medium (=2)</i>
<a name="48960"/>48960: <i>%% Domain:       inet6</i>
<a name="48961"/>48961: <i>%% </i>
<a name="48962"/>48962: 
<a name="ttest_ssockt_cgenf_medium_tcp6-1"/><a name="48963"/>48963: <b>ttest_ssockt_cgenf_medium_tcp6</b>(Config) when is_list(Config) -&gt;
<a name="48964"/>48964:     Runtime = which_ttest_runtime(Config),
<a name="ttest_ssockt_cgenf_medium_tcp6-last_expr"/><a name="48965"/>48965: <b>    ttest_tcp</b>(ttest_ssockt_cgenf_medium_tcp6,
<a name="48966"/>48966:               Runtime,
<a name="48967"/>48967:               inet6,
<a name="48968"/>48968:               sock, true,
<a name="48969"/>48969:               gen, false,
<a name="48970"/>48970:               2, ttest_medium_max_outstanding(Config)).
<a name="48971"/>48971: 
<a name="48972"/>48972: 
<a name="48973"/>48973: 
<a name="48974"/>48974: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="48975"/>48975: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="48976"/>48976: <i>%% ping-pong like test case.</i>
<a name="48977"/>48977: <i>%% Server:       Transport = socket(tcp), Active = true</i>
<a name="48978"/>48978: <i>%% Client:       Transport = gen_tcp, Active = false</i>
<a name="48979"/>48979: <i>%% Message Size: large (=3)</i>
<a name="48980"/>48980: <i>%% Domain:       inet</i>
<a name="48981"/>48981: <i>%%</i>
<a name="48982"/>48982: 
<a name="ttest_ssockt_cgenf_large_tcp4-1"/><a name="48983"/>48983: <b>ttest_ssockt_cgenf_large_tcp4</b>(Config) when is_list(Config) -&gt;
<a name="48984"/>48984:     Runtime = which_ttest_runtime(Config),
<a name="ttest_ssockt_cgenf_large_tcp4-last_expr"/><a name="48985"/>48985: <b>    ttest_tcp</b>(ttest_ssockt_cgenf_large_tcp4,
<a name="48986"/>48986:               Runtime,
<a name="48987"/>48987:               inet,
<a name="48988"/>48988:               sock, true,
<a name="48989"/>48989:               gen, false,
<a name="48990"/>48990:               3, ttest_large_max_outstanding(Config)).
<a name="48991"/>48991: 
<a name="48992"/>48992: 
<a name="48993"/>48993: 
<a name="48994"/>48994: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="48995"/>48995: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="48996"/>48996: <i>%% ping-pong like test case.</i>
<a name="48997"/>48997: <i>%% Server:       Transport = socket(tcp), Active = true</i>
<a name="48998"/>48998: <i>%% Client:       Transport = gen_tcp, Active = false</i>
<a name="48999"/>48999: <i>%% Message Size: large (=3)</i>
<a name="49000"/>49000: <i>%% Domain:       inet6</i>
<a name="49001"/>49001: <i>%% </i>
<a name="49002"/>49002: 
<a name="ttest_ssockt_cgenf_large_tcp6-1"/><a name="49003"/>49003: <b>ttest_ssockt_cgenf_large_tcp6</b>(Config) when is_list(Config) -&gt;
<a name="49004"/>49004:     Runtime = which_ttest_runtime(Config),
<a name="ttest_ssockt_cgenf_large_tcp6-last_expr"/><a name="49005"/>49005: <b>    ttest_tcp</b>(ttest_ssockt_cgenf_large_tcp6,
<a name="49006"/>49006:               Runtime,
<a name="49007"/>49007:               inet6,
<a name="49008"/>49008:               sock, true,
<a name="49009"/>49009:               gen, false,
<a name="49010"/>49010:               3, ttest_large_max_outstanding(Config)).
<a name="49011"/>49011: 
<a name="49012"/>49012: 
<a name="49013"/>49013: 
<a name="49014"/>49014: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="49015"/>49015: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="49016"/>49016: <i>%% ping-pong like test case.</i>
<a name="49017"/>49017: <i>%% Server:       Transport = socket(tcp), Active = true</i>
<a name="49018"/>49018: <i>%% Client:       Transport = gen_tcp, Active = once</i>
<a name="49019"/>49019: <i>%% Message Size: small (=1)</i>
<a name="49020"/>49020: <i>%% Domain:       inet</i>
<a name="49021"/>49021: <i>%%</i>
<a name="49022"/>49022: 
<a name="ttest_ssockt_cgeno_small_tcp4-1"/><a name="49023"/>49023: <b>ttest_ssockt_cgeno_small_tcp4</b>(Config) when is_list(Config) -&gt;
<a name="49024"/>49024:     Runtime = which_ttest_runtime(Config),
<a name="ttest_ssockt_cgeno_small_tcp4-last_expr"/><a name="49025"/>49025: <b>    ttest_tcp</b>(ttest_ssockt_cgeno_small_tcp4,
<a name="49026"/>49026:               Runtime,
<a name="49027"/>49027:               inet,
<a name="49028"/>49028:               sock, true,
<a name="49029"/>49029:               gen, once,
<a name="49030"/>49030:               1, ttest_small_max_outstanding(Config)).
<a name="49031"/>49031: 
<a name="49032"/>49032: 
<a name="49033"/>49033: 
<a name="49034"/>49034: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="49035"/>49035: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="49036"/>49036: <i>%% ping-pong like test case.</i>
<a name="49037"/>49037: <i>%% Server:       Transport = socket(tcp), Active = true</i>
<a name="49038"/>49038: <i>%% Client:       Transport = gen_tcp, Active = once</i>
<a name="49039"/>49039: <i>%% Message Size: small (=1)</i>
<a name="49040"/>49040: <i>%% Domain:       inet6</i>
<a name="49041"/>49041: <i>%% </i>
<a name="49042"/>49042: 
<a name="ttest_ssockt_cgeno_small_tcp6-1"/><a name="49043"/>49043: <b>ttest_ssockt_cgeno_small_tcp6</b>(Config) when is_list(Config) -&gt;
<a name="49044"/>49044:     Runtime = which_ttest_runtime(Config),
<a name="ttest_ssockt_cgeno_small_tcp6-last_expr"/><a name="49045"/>49045: <b>    ttest_tcp</b>(ttest_ssockt_cgeno_small_tcp6,
<a name="49046"/>49046:               Runtime,
<a name="49047"/>49047:               inet6,
<a name="49048"/>49048:               sock, true,
<a name="49049"/>49049:               gen, once,
<a name="49050"/>49050:               1, ttest_small_max_outstanding(Config)).
<a name="49051"/>49051: 
<a name="49052"/>49052: 
<a name="49053"/>49053: 
<a name="49054"/>49054: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="49055"/>49055: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="49056"/>49056: <i>%% ping-pong like test case.</i>
<a name="49057"/>49057: <i>%% Server:       Transport = socket(tcp), Active = true</i>
<a name="49058"/>49058: <i>%% Client:       Transport = gen_tcp, Active = once</i>
<a name="49059"/>49059: <i>%% Message Size: medium (=2)</i>
<a name="49060"/>49060: <i>%% Domain:       inet</i>
<a name="49061"/>49061: <i>%%</i>
<a name="49062"/>49062: 
<a name="ttest_ssockt_cgeno_medium_tcp4-1"/><a name="49063"/>49063: <b>ttest_ssockt_cgeno_medium_tcp4</b>(Config) when is_list(Config) -&gt;
<a name="49064"/>49064:     Runtime = which_ttest_runtime(Config),
<a name="ttest_ssockt_cgeno_medium_tcp4-last_expr"/><a name="49065"/>49065: <b>    ttest_tcp</b>(ttest_ssockt_cgeno_medium_tcp4,
<a name="49066"/>49066:               Runtime,
<a name="49067"/>49067:               inet,
<a name="49068"/>49068:               sock, true,
<a name="49069"/>49069:               gen, once,
<a name="49070"/>49070:               2, ttest_medium_max_outstanding(Config)).
<a name="49071"/>49071: 
<a name="49072"/>49072: 
<a name="49073"/>49073: 
<a name="49074"/>49074: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="49075"/>49075: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="49076"/>49076: <i>%% ping-pong like test case.</i>
<a name="49077"/>49077: <i>%% Server:       Transport = socket(tcp), Active = true</i>
<a name="49078"/>49078: <i>%% Client:       Transport = gen_tcp, Active = once</i>
<a name="49079"/>49079: <i>%% Message Size: medium (=2)</i>
<a name="49080"/>49080: <i>%% Domain:       inet6</i>
<a name="49081"/>49081: <i>%% </i>
<a name="49082"/>49082: 
<a name="ttest_ssockt_cgeno_medium_tcp6-1"/><a name="49083"/>49083: <b>ttest_ssockt_cgeno_medium_tcp6</b>(Config) when is_list(Config) -&gt;
<a name="49084"/>49084:     Runtime = which_ttest_runtime(Config),
<a name="ttest_ssockt_cgeno_medium_tcp6-last_expr"/><a name="49085"/>49085: <b>    ttest_tcp</b>(ttest_ssockt_cgeno_medium_tcp6,
<a name="49086"/>49086:               Runtime,
<a name="49087"/>49087:               inet6,
<a name="49088"/>49088:               sock, true,
<a name="49089"/>49089:               gen, once,
<a name="49090"/>49090:               2, ttest_medium_max_outstanding(Config)).
<a name="49091"/>49091: 
<a name="49092"/>49092: 
<a name="49093"/>49093: 
<a name="49094"/>49094: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="49095"/>49095: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="49096"/>49096: <i>%% ping-pong like test case.</i>
<a name="49097"/>49097: <i>%% Server:       Transport = socket(tcp), Active = true</i>
<a name="49098"/>49098: <i>%% Client:       Transport = gen_tcp, Active = once</i>
<a name="49099"/>49099: <i>%% Message Size: large (=3)</i>
<a name="49100"/>49100: <i>%% Domain:       inet</i>
<a name="49101"/>49101: <i>%%</i>
<a name="49102"/>49102: 
<a name="ttest_ssockt_cgeno_large_tcp4-1"/><a name="49103"/>49103: <b>ttest_ssockt_cgeno_large_tcp4</b>(Config) when is_list(Config) -&gt;
<a name="49104"/>49104:     Runtime = which_ttest_runtime(Config),
<a name="ttest_ssockt_cgeno_large_tcp4-last_expr"/><a name="49105"/>49105: <b>    ttest_tcp</b>(ttest_ssockt_cgeno_large_tcp4,
<a name="49106"/>49106:               Runtime,
<a name="49107"/>49107:               inet,
<a name="49108"/>49108:               sock, true,
<a name="49109"/>49109:               gen, once,
<a name="49110"/>49110:               3, ttest_large_max_outstanding(Config)).
<a name="49111"/>49111: 
<a name="49112"/>49112: 
<a name="49113"/>49113: 
<a name="49114"/>49114: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="49115"/>49115: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="49116"/>49116: <i>%% ping-pong like test case.</i>
<a name="49117"/>49117: <i>%% Server:       Transport = socket(tcp), Active = true</i>
<a name="49118"/>49118: <i>%% Client:       Transport = gen_tcp, Active = once</i>
<a name="49119"/>49119: <i>%% Message Size: large (=3)</i>
<a name="49120"/>49120: <i>%% Domain:       inet6</i>
<a name="49121"/>49121: <i>%% </i>
<a name="49122"/>49122: 
<a name="ttest_ssockt_cgeno_large_tcp6-1"/><a name="49123"/>49123: <b>ttest_ssockt_cgeno_large_tcp6</b>(Config) when is_list(Config) -&gt;
<a name="49124"/>49124:     Runtime = which_ttest_runtime(Config),
<a name="ttest_ssockt_cgeno_large_tcp6-last_expr"/><a name="49125"/>49125: <b>    ttest_tcp</b>(ttest_ssockt_cgeno_large_tcp6,
<a name="49126"/>49126:               Runtime,
<a name="49127"/>49127:               inet6,
<a name="49128"/>49128:               sock, true,
<a name="49129"/>49129:               gen, once,
<a name="49130"/>49130:               3, ttest_large_max_outstanding(Config)).
<a name="49131"/>49131: 
<a name="49132"/>49132: 
<a name="49133"/>49133: 
<a name="49134"/>49134: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="49135"/>49135: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="49136"/>49136: <i>%% ping-pong like test case.</i>
<a name="49137"/>49137: <i>%% Server:       Transport = socket(tcp), Active = true</i>
<a name="49138"/>49138: <i>%% Client:       Transport = gen_tcp, Active = true</i>
<a name="49139"/>49139: <i>%% Message Size: small (=1)</i>
<a name="49140"/>49140: <i>%% Domain:       inet</i>
<a name="49141"/>49141: <i>%%</i>
<a name="49142"/>49142: 
<a name="ttest_ssockt_cgent_small_tcp4-1"/><a name="49143"/>49143: <b>ttest_ssockt_cgent_small_tcp4</b>(Config) when is_list(Config) -&gt;
<a name="49144"/>49144:     Runtime = which_ttest_runtime(Config),
<a name="ttest_ssockt_cgent_small_tcp4-last_expr"/><a name="49145"/>49145: <b>    ttest_tcp</b>(ttest_ssockt_cgent_small_tcp4,
<a name="49146"/>49146:               Runtime,
<a name="49147"/>49147:               inet,
<a name="49148"/>49148:               sock, true,
<a name="49149"/>49149:               gen, true,
<a name="49150"/>49150:               1, ttest_small_max_outstanding(Config)).
<a name="49151"/>49151: 
<a name="49152"/>49152: 
<a name="49153"/>49153: 
<a name="49154"/>49154: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="49155"/>49155: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="49156"/>49156: <i>%% ping-pong like test case.</i>
<a name="49157"/>49157: <i>%% Server:       Transport =  socket(tcp), Active = true</i>
<a name="49158"/>49158: <i>%% Client:       Transport = gen_tcp, Active = true</i>
<a name="49159"/>49159: <i>%% Message Size: small (=1)</i>
<a name="49160"/>49160: <i>%% Domain:       inet6</i>
<a name="49161"/>49161: <i>%% </i>
<a name="49162"/>49162: 
<a name="ttest_ssockt_cgent_small_tcp6-1"/><a name="49163"/>49163: <b>ttest_ssockt_cgent_small_tcp6</b>(Config) when is_list(Config) -&gt;
<a name="49164"/>49164:     Runtime = which_ttest_runtime(Config),
<a name="ttest_ssockt_cgent_small_tcp6-last_expr"/><a name="49165"/>49165: <b>    ttest_tcp</b>(ttest_ssockt_cgent_small_tcp6,
<a name="49166"/>49166:               Runtime,
<a name="49167"/>49167:               inet6,
<a name="49168"/>49168:               sock, true,
<a name="49169"/>49169:               gen, true,
<a name="49170"/>49170:               1, ttest_small_max_outstanding(Config)).
<a name="49171"/>49171: 
<a name="49172"/>49172: 
<a name="49173"/>49173: 
<a name="49174"/>49174: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="49175"/>49175: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="49176"/>49176: <i>%% ping-pong like test case.</i>
<a name="49177"/>49177: <i>%% Server:       Transport = socket(tcp), Active = true</i>
<a name="49178"/>49178: <i>%% Client:       Transport = gen_tcp, Active = true</i>
<a name="49179"/>49179: <i>%% Message Size: medium (=2)</i>
<a name="49180"/>49180: <i>%% Domain:       inet</i>
<a name="49181"/>49181: <i>%%</i>
<a name="49182"/>49182: 
<a name="ttest_ssockt_cgent_medium_tcp4-1"/><a name="49183"/>49183: <b>ttest_ssockt_cgent_medium_tcp4</b>(Config) when is_list(Config) -&gt;
<a name="49184"/>49184:     Runtime = which_ttest_runtime(Config),
<a name="ttest_ssockt_cgent_medium_tcp4-last_expr"/><a name="49185"/>49185: <b>    ttest_tcp</b>(ttest_ssockt_cgent_medium_tcp4,
<a name="49186"/>49186:               Runtime,
<a name="49187"/>49187:               inet,
<a name="49188"/>49188:               sock, true,
<a name="49189"/>49189:               gen, true,
<a name="49190"/>49190:               2, ttest_medium_max_outstanding(Config)).
<a name="49191"/>49191: 
<a name="49192"/>49192: 
<a name="49193"/>49193: 
<a name="49194"/>49194: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="49195"/>49195: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="49196"/>49196: <i>%% ping-pong like test case.</i>
<a name="49197"/>49197: <i>%% Server:       Transport = socket(tcp), Active = true</i>
<a name="49198"/>49198: <i>%% Client:       Transport = gen_tcp, Active = true</i>
<a name="49199"/>49199: <i>%% Message Size: medium (=2)</i>
<a name="49200"/>49200: <i>%% Domain:       inet6</i>
<a name="49201"/>49201: <i>%% </i>
<a name="49202"/>49202: 
<a name="ttest_ssockt_cgent_medium_tcp6-1"/><a name="49203"/>49203: <b>ttest_ssockt_cgent_medium_tcp6</b>(Config) when is_list(Config) -&gt;
<a name="49204"/>49204:     Runtime = which_ttest_runtime(Config),
<a name="ttest_ssockt_cgent_medium_tcp6-last_expr"/><a name="49205"/>49205: <b>    ttest_tcp</b>(ttest_ssockt_cgent_medium_tcp6,
<a name="49206"/>49206:               Runtime,
<a name="49207"/>49207:               inet6,
<a name="49208"/>49208:               sock, true,
<a name="49209"/>49209:               gen, true,
<a name="49210"/>49210:               2, ttest_medium_max_outstanding(Config)).
<a name="49211"/>49211: 
<a name="49212"/>49212: 
<a name="49213"/>49213: 
<a name="49214"/>49214: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="49215"/>49215: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="49216"/>49216: <i>%% ping-pong like test case.</i>
<a name="49217"/>49217: <i>%% Server:       Transport = socket(tcp), Active = true</i>
<a name="49218"/>49218: <i>%% Client:       Transport = gen_tcp, Active = true</i>
<a name="49219"/>49219: <i>%% Message Size: large (=3)</i>
<a name="49220"/>49220: <i>%% Domain:       inet</i>
<a name="49221"/>49221: <i>%%</i>
<a name="49222"/>49222: 
<a name="ttest_ssockt_cgent_large_tcp4-1"/><a name="49223"/>49223: <b>ttest_ssockt_cgent_large_tcp4</b>(Config) when is_list(Config) -&gt;
<a name="49224"/>49224:     Runtime = which_ttest_runtime(Config),
<a name="ttest_ssockt_cgent_large_tcp4-last_expr"/><a name="49225"/>49225: <b>    ttest_tcp</b>(ttest_ssockt_cgent_large_tcp4,
<a name="49226"/>49226:               Runtime,
<a name="49227"/>49227:               inet,
<a name="49228"/>49228:               sock, true,
<a name="49229"/>49229:               gen, true,
<a name="49230"/>49230:               3, ttest_large_max_outstanding(Config)).
<a name="49231"/>49231: 
<a name="49232"/>49232: 
<a name="49233"/>49233: 
<a name="49234"/>49234: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="49235"/>49235: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="49236"/>49236: <i>%% ping-pong like test case.</i>
<a name="49237"/>49237: <i>%% Server:       Transport = socket(tcp), Active = true</i>
<a name="49238"/>49238: <i>%% Client:       Transport = gen_tcp, Active = true</i>
<a name="49239"/>49239: <i>%% Message Size: large (=3)</i>
<a name="49240"/>49240: <i>%% Domain:       inet6</i>
<a name="49241"/>49241: <i>%% </i>
<a name="49242"/>49242: 
<a name="ttest_ssockt_cgent_large_tcp6-1"/><a name="49243"/>49243: <b>ttest_ssockt_cgent_large_tcp6</b>(Config) when is_list(Config) -&gt;
<a name="49244"/>49244:     Runtime = which_ttest_runtime(Config),
<a name="ttest_ssockt_cgent_large_tcp6-last_expr"/><a name="49245"/>49245: <b>    ttest_tcp</b>(ttest_ssockt_cgent_large_tcp6,
<a name="49246"/>49246:               Runtime,
<a name="49247"/>49247:               inet6,
<a name="49248"/>49248:               sock, true,
<a name="49249"/>49249:               gen, true,
<a name="49250"/>49250:               3, ttest_large_max_outstanding(Config)).
<a name="49251"/>49251: 
<a name="49252"/>49252: 
<a name="49253"/>49253: 
<a name="49254"/>49254: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="49255"/>49255: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="49256"/>49256: <i>%% ping-pong like test case.</i>
<a name="49257"/>49257: <i>%% Server:       Transport = socket(tcp), Active = true</i>
<a name="49258"/>49258: <i>%% Client:       Transport = socket(tcp), Active = false</i>
<a name="49259"/>49259: <i>%% Message Size: small (=1)</i>
<a name="49260"/>49260: <i>%% Domain:       inet</i>
<a name="49261"/>49261: <i>%%</i>
<a name="49262"/>49262: 
<a name="ttest_ssockt_csockf_small_tcp4-1"/><a name="49263"/>49263: <b>ttest_ssockt_csockf_small_tcp4</b>(Config) when is_list(Config) -&gt;
<a name="49264"/>49264:     Runtime = which_ttest_runtime(Config),
<a name="ttest_ssockt_csockf_small_tcp4-last_expr"/><a name="49265"/>49265: <b>    ttest_tcp</b>(ttest_ssockt_csockf_small_tcp4,
<a name="49266"/>49266:               Runtime,
<a name="49267"/>49267:               inet,
<a name="49268"/>49268:               sock, true,
<a name="49269"/>49269:               sock, false,
<a name="49270"/>49270:               1, ttest_small_max_outstanding(Config)).
<a name="49271"/>49271: 
<a name="49272"/>49272: 
<a name="49273"/>49273: 
<a name="49274"/>49274: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="49275"/>49275: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="49276"/>49276: <i>%% ping-pong like test case.</i>
<a name="49277"/>49277: <i>%% Server:       Transport = socket(tcp), Active = true</i>
<a name="49278"/>49278: <i>%% Client:       Transport = socket(tcp), Active = false</i>
<a name="49279"/>49279: <i>%% Message Size: small (=1)</i>
<a name="49280"/>49280: <i>%% Domain:       inet6</i>
<a name="49281"/>49281: <i>%% </i>
<a name="49282"/>49282: 
<a name="ttest_ssockt_csockf_small_tcp6-1"/><a name="49283"/>49283: <b>ttest_ssockt_csockf_small_tcp6</b>(Config) when is_list(Config) -&gt;
<a name="49284"/>49284:     Runtime = which_ttest_runtime(Config),
<a name="ttest_ssockt_csockf_small_tcp6-last_expr"/><a name="49285"/>49285: <b>    ttest_tcp</b>(ttest_ssockt_csockf_small_tcp6,
<a name="49286"/>49286:               Runtime,
<a name="49287"/>49287:               inet6,
<a name="49288"/>49288:               sock, true,
<a name="49289"/>49289:               sock, false,
<a name="49290"/>49290:               1, ttest_small_max_outstanding(Config)).
<a name="49291"/>49291: 
<a name="49292"/>49292: 
<a name="49293"/>49293: 
<a name="49294"/>49294: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="49295"/>49295: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="49296"/>49296: <i>%% ping-pong like test case.</i>
<a name="49297"/>49297: <i>%% Server:       Transport = socket(tcp), Active = true</i>
<a name="49298"/>49298: <i>%% Client:       Transport = socket(tcp), Active = false</i>
<a name="49299"/>49299: <i>%% Message Size: small (=1)</i>
<a name="49300"/>49300: <i>%% Domain:       local</i>
<a name="49301"/>49301: <i>%% </i>
<a name="49302"/>49302: 
<a name="ttest_ssockt_csockf_small_tcpL-1"/><a name="49303"/>49303: <b>ttest_ssockt_csockf_small_tcpL</b>(Config) when is_list(Config) -&gt;
<a name="49304"/>49304:     Runtime = which_ttest_runtime(Config),
<a name="ttest_ssockt_csockf_small_tcpL-last_expr"/><a name="49305"/>49305: <b>    ttest_tcp</b>(ttest_ssockt_csockf_small_tcpL,
<a name="49306"/>49306:               Runtime,
<a name="49307"/>49307:               local,
<a name="49308"/>49308:               sock, true,
<a name="49309"/>49309:               sock, false,
<a name="49310"/>49310:               1, ttest_small_max_outstanding(Config)).
<a name="49311"/>49311: 
<a name="49312"/>49312: 
<a name="49313"/>49313: 
<a name="49314"/>49314: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="49315"/>49315: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="49316"/>49316: <i>%% ping-pong like test case.</i>
<a name="49317"/>49317: <i>%% Server:       Transport = socket(tcp), Active = true</i>
<a name="49318"/>49318: <i>%% Client:       Transport = socket(tcp), Active = false</i>
<a name="49319"/>49319: <i>%% Message Size: medium (=2)</i>
<a name="49320"/>49320: <i>%% Domain:       inet</i>
<a name="49321"/>49321: <i>%%</i>
<a name="49322"/>49322: 
<a name="ttest_ssockt_csockf_medium_tcp4-1"/><a name="49323"/>49323: <b>ttest_ssockt_csockf_medium_tcp4</b>(Config) when is_list(Config) -&gt;
<a name="49324"/>49324:     Runtime = which_ttest_runtime(Config),
<a name="ttest_ssockt_csockf_medium_tcp4-last_expr"/><a name="49325"/>49325: <b>    ttest_tcp</b>(ttest_ssockt_csockf_medium_tcp4,
<a name="49326"/>49326:               Runtime,
<a name="49327"/>49327:               inet,
<a name="49328"/>49328:               sock, true,
<a name="49329"/>49329:               sock, false,
<a name="49330"/>49330:               2, ttest_medium_max_outstanding(Config)).
<a name="49331"/>49331: 
<a name="49332"/>49332: 
<a name="49333"/>49333: 
<a name="49334"/>49334: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="49335"/>49335: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="49336"/>49336: <i>%% ping-pong like test case.</i>
<a name="49337"/>49337: <i>%% Server:       Transport = socket(tcp), Active = true</i>
<a name="49338"/>49338: <i>%% Client:       Transport = socket(tcp), Active = false</i>
<a name="49339"/>49339: <i>%% Message Size: medium (=2)</i>
<a name="49340"/>49340: <i>%% Domain:       inet6</i>
<a name="49341"/>49341: <i>%% </i>
<a name="49342"/>49342: 
<a name="ttest_ssockt_csockf_medium_tcp6-1"/><a name="49343"/>49343: <b>ttest_ssockt_csockf_medium_tcp6</b>(Config) when is_list(Config) -&gt;
<a name="49344"/>49344:     Runtime = which_ttest_runtime(Config),
<a name="ttest_ssockt_csockf_medium_tcp6-last_expr"/><a name="49345"/>49345: <b>    ttest_tcp</b>(ttest_ssockt_csockf_medium_tcp6,
<a name="49346"/>49346:               Runtime,
<a name="49347"/>49347:               inet6,
<a name="49348"/>49348:               sock, true,
<a name="49349"/>49349:               sock, false,
<a name="49350"/>49350:               2, ttest_medium_max_outstanding(Config)).
<a name="49351"/>49351: 
<a name="49352"/>49352: 
<a name="49353"/>49353: 
<a name="49354"/>49354: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="49355"/>49355: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="49356"/>49356: <i>%% ping-pong like test case.</i>
<a name="49357"/>49357: <i>%% Server:       Transport = socket(tcp), Active = true</i>
<a name="49358"/>49358: <i>%% Client:       Transport = socket(tcp), Active = false</i>
<a name="49359"/>49359: <i>%% Message Size: medium (=2)</i>
<a name="49360"/>49360: <i>%% Domain:       local</i>
<a name="49361"/>49361: <i>%% </i>
<a name="49362"/>49362: 
<a name="ttest_ssockt_csockf_medium_tcpL-1"/><a name="49363"/>49363: <b>ttest_ssockt_csockf_medium_tcpL</b>(Config) when is_list(Config) -&gt;
<a name="49364"/>49364:     Runtime = which_ttest_runtime(Config),
<a name="ttest_ssockt_csockf_medium_tcpL-last_expr"/><a name="49365"/>49365: <b>    ttest_tcp</b>(ttest_ssockt_csockf_medium_tcpL,
<a name="49366"/>49366:               Runtime,
<a name="49367"/>49367:               local,
<a name="49368"/>49368:               sock, true,
<a name="49369"/>49369:               sock, false,
<a name="49370"/>49370:               2, ttest_medium_max_outstanding(Config)).
<a name="49371"/>49371: 
<a name="49372"/>49372: 
<a name="49373"/>49373: 
<a name="49374"/>49374: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="49375"/>49375: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="49376"/>49376: <i>%% ping-pong like test case.</i>
<a name="49377"/>49377: <i>%% Server:       Transport = socket(tcp), Active = true</i>
<a name="49378"/>49378: <i>%% Client:       Transport = socket(tcp), Active = false</i>
<a name="49379"/>49379: <i>%% Message Size: large (=3)</i>
<a name="49380"/>49380: <i>%% Domain:       inet</i>
<a name="49381"/>49381: <i>%%</i>
<a name="49382"/>49382: 
<a name="ttest_ssockt_csockf_large_tcp4-1"/><a name="49383"/>49383: <b>ttest_ssockt_csockf_large_tcp4</b>(Config) when is_list(Config) -&gt;
<a name="49384"/>49384:     Runtime = which_ttest_runtime(Config),
<a name="ttest_ssockt_csockf_large_tcp4-last_expr"/><a name="49385"/>49385: <b>    ttest_tcp</b>(ttest_ssockt_csockf_large_tcp4,
<a name="49386"/>49386:               Runtime,
<a name="49387"/>49387:               inet,
<a name="49388"/>49388:               sock, true,
<a name="49389"/>49389:               sock, false,
<a name="49390"/>49390:               3, ttest_large_max_outstanding(Config)).
<a name="49391"/>49391: 
<a name="49392"/>49392: 
<a name="49393"/>49393: 
<a name="49394"/>49394: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="49395"/>49395: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="49396"/>49396: <i>%% ping-pong like test case.</i>
<a name="49397"/>49397: <i>%% Server:       Transport = socket(tcp), Active = true</i>
<a name="49398"/>49398: <i>%% Client:       Transport = socket(tcp), Active = false</i>
<a name="49399"/>49399: <i>%% Message Size: large (=3)</i>
<a name="49400"/>49400: <i>%% Domain:       inet6</i>
<a name="49401"/>49401: <i>%% </i>
<a name="49402"/>49402: 
<a name="ttest_ssockt_csockf_large_tcp6-1"/><a name="49403"/>49403: <b>ttest_ssockt_csockf_large_tcp6</b>(Config) when is_list(Config) -&gt;
<a name="49404"/>49404:     Runtime = which_ttest_runtime(Config),
<a name="ttest_ssockt_csockf_large_tcp6-last_expr"/><a name="49405"/>49405: <b>    ttest_tcp</b>(ttest_ssockt_csockf_large_tcp6,
<a name="49406"/>49406:               Runtime,
<a name="49407"/>49407:               inet6,
<a name="49408"/>49408:               sock, true,
<a name="49409"/>49409:               sock, false,
<a name="49410"/>49410:               3, ttest_large_max_outstanding(Config)).
<a name="49411"/>49411: 
<a name="49412"/>49412: 
<a name="49413"/>49413: 
<a name="49414"/>49414: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="49415"/>49415: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="49416"/>49416: <i>%% ping-pong like test case.</i>
<a name="49417"/>49417: <i>%% Server:       Transport = socket(tcp), Active = true</i>
<a name="49418"/>49418: <i>%% Client:       Transport = socket(tcp), Active = false</i>
<a name="49419"/>49419: <i>%% Message Size: large (=3)</i>
<a name="49420"/>49420: <i>%% Domain:       local</i>
<a name="49421"/>49421: <i>%% </i>
<a name="49422"/>49422: 
<a name="ttest_ssockt_csockf_large_tcpL-1"/><a name="49423"/>49423: <b>ttest_ssockt_csockf_large_tcpL</b>(Config) when is_list(Config) -&gt;
<a name="49424"/>49424:     Runtime = which_ttest_runtime(Config),
<a name="ttest_ssockt_csockf_large_tcpL-last_expr"/><a name="49425"/>49425: <b>    ttest_tcp</b>(ttest_ssockt_csockf_large_tcpL,
<a name="49426"/>49426:               Runtime,
<a name="49427"/>49427:               local,
<a name="49428"/>49428:               sock, true,
<a name="49429"/>49429:               sock, false,
<a name="49430"/>49430:               3, ttest_large_max_outstanding(Config)).
<a name="49431"/>49431: 
<a name="49432"/>49432: 
<a name="49433"/>49433: 
<a name="49434"/>49434: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="49435"/>49435: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="49436"/>49436: <i>%% ping-pong like test case.</i>
<a name="49437"/>49437: <i>%% Server:       Transport = socket(tcp), Active = true</i>
<a name="49438"/>49438: <i>%% Client:       Transport = socket(tcp), Active = once</i>
<a name="49439"/>49439: <i>%% Message Size: small (=1)</i>
<a name="49440"/>49440: <i>%% Domain:       inet</i>
<a name="49441"/>49441: <i>%%</i>
<a name="49442"/>49442: 
<a name="ttest_ssockt_csocko_small_tcp4-1"/><a name="49443"/>49443: <b>ttest_ssockt_csocko_small_tcp4</b>(Config) when is_list(Config) -&gt;
<a name="49444"/>49444:     Runtime = which_ttest_runtime(Config),
<a name="ttest_ssockt_csocko_small_tcp4-last_expr"/><a name="49445"/>49445: <b>    ttest_tcp</b>(ttest_ssockt_csocko_small_tcp4,
<a name="49446"/>49446:               Runtime,
<a name="49447"/>49447:               inet,
<a name="49448"/>49448:               sock, true,
<a name="49449"/>49449:               sock, once,
<a name="49450"/>49450:               1, ttest_small_max_outstanding(Config)).
<a name="49451"/>49451: 
<a name="49452"/>49452: 
<a name="49453"/>49453: 
<a name="49454"/>49454: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="49455"/>49455: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="49456"/>49456: <i>%% ping-pong like test case.</i>
<a name="49457"/>49457: <i>%% Server:       Transport = socket(tcp), Active = true</i>
<a name="49458"/>49458: <i>%% Client:       Transport = socket(tcp), Active = once</i>
<a name="49459"/>49459: <i>%% Message Size: small (=1)</i>
<a name="49460"/>49460: <i>%% Domain:       inet6</i>
<a name="49461"/>49461: <i>%% </i>
<a name="49462"/>49462: 
<a name="ttest_ssockt_csocko_small_tcp6-1"/><a name="49463"/>49463: <b>ttest_ssockt_csocko_small_tcp6</b>(Config) when is_list(Config) -&gt;
<a name="49464"/>49464:     Runtime = which_ttest_runtime(Config),
<a name="ttest_ssockt_csocko_small_tcp6-last_expr"/><a name="49465"/>49465: <b>    ttest_tcp</b>(ttest_ssockt_csocko_small_tcp6,
<a name="49466"/>49466:               Runtime,
<a name="49467"/>49467:               inet6,
<a name="49468"/>49468:               sock, true,
<a name="49469"/>49469:               sock, once,
<a name="49470"/>49470:               1, ttest_small_max_outstanding(Config)).
<a name="49471"/>49471: 
<a name="49472"/>49472: 
<a name="49473"/>49473: 
<a name="49474"/>49474: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="49475"/>49475: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="49476"/>49476: <i>%% ping-pong like test case.</i>
<a name="49477"/>49477: <i>%% Server:       Transport = socket(tcp), Active = true</i>
<a name="49478"/>49478: <i>%% Client:       Transport = socket(tcp), Active = once</i>
<a name="49479"/>49479: <i>%% Message Size: small (=1)</i>
<a name="49480"/>49480: <i>%% Domain:       local</i>
<a name="49481"/>49481: <i>%% </i>
<a name="49482"/>49482: 
<a name="ttest_ssockt_csocko_small_tcpL-1"/><a name="49483"/>49483: <b>ttest_ssockt_csocko_small_tcpL</b>(Config) when is_list(Config) -&gt;
<a name="49484"/>49484:     Runtime = which_ttest_runtime(Config),
<a name="ttest_ssockt_csocko_small_tcpL-last_expr"/><a name="49485"/>49485: <b>    ttest_tcp</b>(ttest_ssockt_csocko_small_tcpL,
<a name="49486"/>49486:               Runtime,
<a name="49487"/>49487:               local,
<a name="49488"/>49488:               sock, true,
<a name="49489"/>49489:               sock, once,
<a name="49490"/>49490:               1, ttest_small_max_outstanding(Config)).
<a name="49491"/>49491: 
<a name="49492"/>49492: 
<a name="49493"/>49493: 
<a name="49494"/>49494: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="49495"/>49495: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="49496"/>49496: <i>%% ping-pong like test case.</i>
<a name="49497"/>49497: <i>%% Server:       Transport = socket(tcp), Active = true</i>
<a name="49498"/>49498: <i>%% Client:       Transport = socket(tcp), Active = once</i>
<a name="49499"/>49499: <i>%% Message Size: medium (=2)</i>
<a name="49500"/>49500: <i>%% Domain:       inet</i>
<a name="49501"/>49501: <i>%%</i>
<a name="49502"/>49502: 
<a name="ttest_ssockt_csocko_medium_tcp4-1"/><a name="49503"/>49503: <b>ttest_ssockt_csocko_medium_tcp4</b>(Config) when is_list(Config) -&gt;
<a name="49504"/>49504:     Runtime = which_ttest_runtime(Config),
<a name="ttest_ssockt_csocko_medium_tcp4-last_expr"/><a name="49505"/>49505: <b>    ttest_tcp</b>(ttest_ssockt_csocko_medium_tcp4,
<a name="49506"/>49506:               Runtime,
<a name="49507"/>49507:               inet,
<a name="49508"/>49508:               sock, true,
<a name="49509"/>49509:               sock, once,
<a name="49510"/>49510:               2, ttest_medium_max_outstanding(Config)).
<a name="49511"/>49511: 
<a name="49512"/>49512: 
<a name="49513"/>49513: 
<a name="49514"/>49514: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="49515"/>49515: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="49516"/>49516: <i>%% ping-pong like test case.</i>
<a name="49517"/>49517: <i>%% Server:       Transport = socket(tcp), Active = true</i>
<a name="49518"/>49518: <i>%% Client:       Transport = socket(tcp), Active = once</i>
<a name="49519"/>49519: <i>%% Message Size: medium (=2)</i>
<a name="49520"/>49520: <i>%% Domain:       inet6</i>
<a name="49521"/>49521: <i>%% </i>
<a name="49522"/>49522: 
<a name="ttest_ssockt_csocko_medium_tcp6-1"/><a name="49523"/>49523: <b>ttest_ssockt_csocko_medium_tcp6</b>(Config) when is_list(Config) -&gt;
<a name="49524"/>49524:     Runtime = which_ttest_runtime(Config),
<a name="ttest_ssockt_csocko_medium_tcp6-last_expr"/><a name="49525"/>49525: <b>    ttest_tcp</b>(ttest_ssockt_csocko_medium_tcp6,
<a name="49526"/>49526:               Runtime,
<a name="49527"/>49527:               inet6,
<a name="49528"/>49528:               sock, true,
<a name="49529"/>49529:               sock, once,
<a name="49530"/>49530:               2, ttest_medium_max_outstanding(Config)).
<a name="49531"/>49531: 
<a name="49532"/>49532: 
<a name="49533"/>49533: 
<a name="49534"/>49534: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="49535"/>49535: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="49536"/>49536: <i>%% ping-pong like test case.</i>
<a name="49537"/>49537: <i>%% Server:       Transport = socket(tcp), Active = true</i>
<a name="49538"/>49538: <i>%% Client:       Transport = socket(tcp), Active = once</i>
<a name="49539"/>49539: <i>%% Message Size: medium (=2)</i>
<a name="49540"/>49540: <i>%% Domain:       local</i>
<a name="49541"/>49541: <i>%% </i>
<a name="49542"/>49542: 
<a name="ttest_ssockt_csocko_medium_tcpL-1"/><a name="49543"/>49543: <b>ttest_ssockt_csocko_medium_tcpL</b>(Config) when is_list(Config) -&gt;
<a name="49544"/>49544:     Runtime = which_ttest_runtime(Config),
<a name="ttest_ssockt_csocko_medium_tcpL-last_expr"/><a name="49545"/>49545: <b>    ttest_tcp</b>(ttest_ssockt_csocko_medium_tcpL,
<a name="49546"/>49546:               Runtime,
<a name="49547"/>49547:               local,
<a name="49548"/>49548:               sock, true,
<a name="49549"/>49549:               sock, once,
<a name="49550"/>49550:               2, ttest_medium_max_outstanding(Config)).
<a name="49551"/>49551: 
<a name="49552"/>49552: 
<a name="49553"/>49553: 
<a name="49554"/>49554: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="49555"/>49555: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="49556"/>49556: <i>%% ping-pong like test case.</i>
<a name="49557"/>49557: <i>%% Server:       Transport = socket(tcp), Active = true</i>
<a name="49558"/>49558: <i>%% Client:       Transport = socket(tcp), Active = once</i>
<a name="49559"/>49559: <i>%% Message Size: large (=3)</i>
<a name="49560"/>49560: <i>%% Domain:       inet</i>
<a name="49561"/>49561: <i>%%</i>
<a name="49562"/>49562: 
<a name="ttest_ssockt_csocko_large_tcp4-1"/><a name="49563"/>49563: <b>ttest_ssockt_csocko_large_tcp4</b>(Config) when is_list(Config) -&gt;
<a name="49564"/>49564:     Runtime = which_ttest_runtime(Config),
<a name="ttest_ssockt_csocko_large_tcp4-last_expr"/><a name="49565"/>49565: <b>    ttest_tcp</b>(ttest_ssockt_csocko_large_tcp4,
<a name="49566"/>49566:               Runtime,
<a name="49567"/>49567:               inet,
<a name="49568"/>49568:               sock, true,
<a name="49569"/>49569:               sock, once,
<a name="49570"/>49570:               3, ttest_large_max_outstanding(Config)).
<a name="49571"/>49571: 
<a name="49572"/>49572: 
<a name="49573"/>49573: 
<a name="49574"/>49574: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="49575"/>49575: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="49576"/>49576: <i>%% ping-pong like test case.</i>
<a name="49577"/>49577: <i>%% Server:       Transport = socket(tcp), Active = true</i>
<a name="49578"/>49578: <i>%% Client:       Transport = socket(tcp), Active = once</i>
<a name="49579"/>49579: <i>%% Message Size: large (=3)</i>
<a name="49580"/>49580: <i>%% Domain:       inet6</i>
<a name="49581"/>49581: <i>%% </i>
<a name="49582"/>49582: 
<a name="ttest_ssockt_csocko_large_tcp6-1"/><a name="49583"/>49583: <b>ttest_ssockt_csocko_large_tcp6</b>(Config) when is_list(Config) -&gt;
<a name="49584"/>49584:     Runtime = which_ttest_runtime(Config),
<a name="ttest_ssockt_csocko_large_tcp6-last_expr"/><a name="49585"/>49585: <b>    ttest_tcp</b>(ttest_ssockt_csocko_large_tcp6,
<a name="49586"/>49586:               Runtime,
<a name="49587"/>49587:               inet6,
<a name="49588"/>49588:               sock, true,
<a name="49589"/>49589:               sock, once,
<a name="49590"/>49590:               3, ttest_large_max_outstanding(Config)).
<a name="49591"/>49591: 
<a name="49592"/>49592: 
<a name="49593"/>49593: 
<a name="49594"/>49594: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="49595"/>49595: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="49596"/>49596: <i>%% ping-pong like test case.</i>
<a name="49597"/>49597: <i>%% Server:       Transport = socket(tcp), Active = true</i>
<a name="49598"/>49598: <i>%% Client:       Transport = socket(tcp), Active = once</i>
<a name="49599"/>49599: <i>%% Message Size: large (=3)</i>
<a name="49600"/>49600: <i>%% Domain:       local</i>
<a name="49601"/>49601: <i>%% </i>
<a name="49602"/>49602: 
<a name="ttest_ssockt_csocko_large_tcpL-1"/><a name="49603"/>49603: <b>ttest_ssockt_csocko_large_tcpL</b>(Config) when is_list(Config) -&gt;
<a name="49604"/>49604:     Runtime = which_ttest_runtime(Config),
<a name="ttest_ssockt_csocko_large_tcpL-last_expr"/><a name="49605"/>49605: <b>    ttest_tcp</b>(ttest_ssockt_csocko_large_tcpL,
<a name="49606"/>49606:               Runtime,
<a name="49607"/>49607:               local,
<a name="49608"/>49608:               sock, true,
<a name="49609"/>49609:               sock, once,
<a name="49610"/>49610:               3, ttest_large_max_outstanding(Config)).
<a name="49611"/>49611: 
<a name="49612"/>49612: 
<a name="49613"/>49613: 
<a name="49614"/>49614: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="49615"/>49615: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="49616"/>49616: <i>%% ping-pong like test case.</i>
<a name="49617"/>49617: <i>%% Server:       Transport = socket(tcp), Active = true</i>
<a name="49618"/>49618: <i>%% Client:       Transport = socket(tcp), Active = true</i>
<a name="49619"/>49619: <i>%% Message Size: small (=1)</i>
<a name="49620"/>49620: <i>%% Domain:       inet</i>
<a name="49621"/>49621: <i>%%</i>
<a name="49622"/>49622: 
<a name="ttest_ssockt_csockt_small_tcp4-1"/><a name="49623"/>49623: <b>ttest_ssockt_csockt_small_tcp4</b>(Config) when is_list(Config) -&gt;
<a name="49624"/>49624:     Runtime = which_ttest_runtime(Config),
<a name="ttest_ssockt_csockt_small_tcp4-last_expr"/><a name="49625"/>49625: <b>    ttest_tcp</b>(ttest_ssockt_csockt_small_tcp4,
<a name="49626"/>49626:               Runtime,
<a name="49627"/>49627:               inet,
<a name="49628"/>49628:               sock, true,
<a name="49629"/>49629:               sock, true,
<a name="49630"/>49630:               1, ttest_small_max_outstanding(Config)).
<a name="49631"/>49631: 
<a name="49632"/>49632: 
<a name="49633"/>49633: 
<a name="49634"/>49634: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="49635"/>49635: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="49636"/>49636: <i>%% ping-pong like test case.</i>
<a name="49637"/>49637: <i>%% Server:       Transport =  socket(tcp), Active = true</i>
<a name="49638"/>49638: <i>%% Client:       Transport = socket(tcp), Active = true</i>
<a name="49639"/>49639: <i>%% Message Size: small (=1)</i>
<a name="49640"/>49640: <i>%% Domain:       inet6</i>
<a name="49641"/>49641: <i>%% </i>
<a name="49642"/>49642: 
<a name="ttest_ssockt_csockt_small_tcp6-1"/><a name="49643"/>49643: <b>ttest_ssockt_csockt_small_tcp6</b>(Config) when is_list(Config) -&gt;
<a name="49644"/>49644:     Runtime = which_ttest_runtime(Config),
<a name="ttest_ssockt_csockt_small_tcp6-last_expr"/><a name="49645"/>49645: <b>    ttest_tcp</b>(ttest_ssockt_csocko_small_tcp6,
<a name="49646"/>49646:               Runtime,
<a name="49647"/>49647:               inet6,
<a name="49648"/>49648:               sock, true,
<a name="49649"/>49649:               sock, true,
<a name="49650"/>49650:               1, ttest_small_max_outstanding(Config)).
<a name="49651"/>49651: 
<a name="49652"/>49652: 
<a name="49653"/>49653: 
<a name="49654"/>49654: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="49655"/>49655: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="49656"/>49656: <i>%% ping-pong like test case.</i>
<a name="49657"/>49657: <i>%% Server:       Transport =  socket(tcp), Active = true</i>
<a name="49658"/>49658: <i>%% Client:       Transport = socket(tcp), Active = true</i>
<a name="49659"/>49659: <i>%% Message Size: small (=1)</i>
<a name="49660"/>49660: <i>%% Domain:       local</i>
<a name="49661"/>49661: <i>%% </i>
<a name="49662"/>49662: 
<a name="ttest_ssockt_csockt_small_tcpL-1"/><a name="49663"/>49663: <b>ttest_ssockt_csockt_small_tcpL</b>(Config) when is_list(Config) -&gt;
<a name="49664"/>49664:     Runtime = which_ttest_runtime(Config),
<a name="ttest_ssockt_csockt_small_tcpL-last_expr"/><a name="49665"/>49665: <b>    ttest_tcp</b>(ttest_ssockt_csocko_small_tcpL,
<a name="49666"/>49666:               Runtime,
<a name="49667"/>49667:               local,
<a name="49668"/>49668:               sock, true,
<a name="49669"/>49669:               sock, true,
<a name="49670"/>49670:               1, ttest_small_max_outstanding(Config)).
<a name="49671"/>49671: 
<a name="49672"/>49672: 
<a name="49673"/>49673: 
<a name="49674"/>49674: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="49675"/>49675: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="49676"/>49676: <i>%% ping-pong like test case.</i>
<a name="49677"/>49677: <i>%% Server:       Transport = socket(tcp), Active = true</i>
<a name="49678"/>49678: <i>%% Client:       Transport = socket(tcp), Active = true</i>
<a name="49679"/>49679: <i>%% Message Size: medium (=2)</i>
<a name="49680"/>49680: <i>%% Domain:       inet</i>
<a name="49681"/>49681: <i>%%</i>
<a name="49682"/>49682: 
<a name="ttest_ssockt_csockt_medium_tcp4-1"/><a name="49683"/>49683: <b>ttest_ssockt_csockt_medium_tcp4</b>(Config) when is_list(Config) -&gt;
<a name="49684"/>49684:     Runtime = which_ttest_runtime(Config),
<a name="ttest_ssockt_csockt_medium_tcp4-last_expr"/><a name="49685"/>49685: <b>    ttest_tcp</b>(ttest_ssockt_csockt_medium_tcp4,
<a name="49686"/>49686:               Runtime,
<a name="49687"/>49687:               inet,
<a name="49688"/>49688:               sock, true,
<a name="49689"/>49689:               sock, true,
<a name="49690"/>49690:               2, ttest_medium_max_outstanding(Config)).
<a name="49691"/>49691: 
<a name="49692"/>49692: 
<a name="49693"/>49693: 
<a name="49694"/>49694: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="49695"/>49695: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="49696"/>49696: <i>%% ping-pong like test case.</i>
<a name="49697"/>49697: <i>%% Server:       Transport = socket(tcp), Active = true</i>
<a name="49698"/>49698: <i>%% Client:       Transport = socket(tcp), Active = true</i>
<a name="49699"/>49699: <i>%% Message Size: medium (=2)</i>
<a name="49700"/>49700: <i>%% Domain:       inet6</i>
<a name="49701"/>49701: <i>%% </i>
<a name="49702"/>49702: 
<a name="ttest_ssockt_csockt_medium_tcp6-1"/><a name="49703"/>49703: <b>ttest_ssockt_csockt_medium_tcp6</b>(Config) when is_list(Config) -&gt;
<a name="49704"/>49704:     Runtime = which_ttest_runtime(Config),
<a name="ttest_ssockt_csockt_medium_tcp6-last_expr"/><a name="49705"/>49705: <b>    ttest_tcp</b>(ttest_ssockt_csockt_medium_tcp6,
<a name="49706"/>49706:               Runtime,
<a name="49707"/>49707:               inet6,
<a name="49708"/>49708:               sock, true,
<a name="49709"/>49709:               sock, true,
<a name="49710"/>49710:               2, ttest_medium_max_outstanding(Config)).
<a name="49711"/>49711: 
<a name="49712"/>49712: 
<a name="49713"/>49713: 
<a name="49714"/>49714: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="49715"/>49715: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="49716"/>49716: <i>%% ping-pong like test case.</i>
<a name="49717"/>49717: <i>%% Server:       Transport = socket(tcp), Active = true</i>
<a name="49718"/>49718: <i>%% Client:       Transport = socket(tcp), Active = true</i>
<a name="49719"/>49719: <i>%% Message Size: medium (=2)</i>
<a name="49720"/>49720: <i>%% Domain:       local</i>
<a name="49721"/>49721: <i>%% </i>
<a name="49722"/>49722: 
<a name="ttest_ssockt_csockt_medium_tcpL-1"/><a name="49723"/>49723: <b>ttest_ssockt_csockt_medium_tcpL</b>(Config) when is_list(Config) -&gt;
<a name="49724"/>49724:     Runtime = which_ttest_runtime(Config),
<a name="ttest_ssockt_csockt_medium_tcpL-last_expr"/><a name="49725"/>49725: <b>    ttest_tcp</b>(ttest_ssockt_csockt_medium_tcpL,
<a name="49726"/>49726:               Runtime,
<a name="49727"/>49727:               local,
<a name="49728"/>49728:               sock, true,
<a name="49729"/>49729:               sock, true,
<a name="49730"/>49730:               2, ttest_medium_max_outstanding(Config)).
<a name="49731"/>49731: 
<a name="49732"/>49732: 
<a name="49733"/>49733: 
<a name="49734"/>49734: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="49735"/>49735: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="49736"/>49736: <i>%% ping-pong like test case.</i>
<a name="49737"/>49737: <i>%% Server:       Transport = socket(tcp), Active = true</i>
<a name="49738"/>49738: <i>%% Client:       Transport = socket(tcp), Active = true</i>
<a name="49739"/>49739: <i>%% Message Size: large (=3)</i>
<a name="49740"/>49740: <i>%% Domain:       inet</i>
<a name="49741"/>49741: <i>%%</i>
<a name="49742"/>49742: 
<a name="ttest_ssockt_csockt_large_tcp4-1"/><a name="49743"/>49743: <b>ttest_ssockt_csockt_large_tcp4</b>(Config) when is_list(Config) -&gt;
<a name="49744"/>49744:     Runtime = which_ttest_runtime(Config),
<a name="ttest_ssockt_csockt_large_tcp4-last_expr"/><a name="49745"/>49745: <b>    ttest_tcp</b>(ttest_ssockt_csockt_large_tcp4,
<a name="49746"/>49746:               Runtime,
<a name="49747"/>49747:               inet,
<a name="49748"/>49748:               sock, true,
<a name="49749"/>49749:               sock, true,
<a name="49750"/>49750:               3, ttest_large_max_outstanding(Config)).
<a name="49751"/>49751: 
<a name="49752"/>49752: 
<a name="49753"/>49753: 
<a name="49754"/>49754: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="49755"/>49755: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="49756"/>49756: <i>%% ping-pong like test case.</i>
<a name="49757"/>49757: <i>%% Server:       Transport = socket(tcp), Active = true</i>
<a name="49758"/>49758: <i>%% Client:       Transport = socket(tcp), Active = true</i>
<a name="49759"/>49759: <i>%% Message Size: large (=3)</i>
<a name="49760"/>49760: <i>%% Domain:       inet6</i>
<a name="49761"/>49761: <i>%% </i>
<a name="49762"/>49762: 
<a name="ttest_ssockt_csockt_large_tcp6-1"/><a name="49763"/>49763: <b>ttest_ssockt_csockt_large_tcp6</b>(Config) when is_list(Config) -&gt;
<a name="49764"/>49764:     Runtime = which_ttest_runtime(Config),
<a name="ttest_ssockt_csockt_large_tcp6-last_expr"/><a name="49765"/>49765: <b>    ttest_tcp</b>(ttest_ssockt_csockt_large_tcp6,
<a name="49766"/>49766:               Runtime,
<a name="49767"/>49767:               inet6,
<a name="49768"/>49768:               sock, true,
<a name="49769"/>49769:               sock, true,
<a name="49770"/>49770:               3, ttest_large_max_outstanding(Config)).
<a name="49771"/>49771: 
<a name="49772"/>49772: 
<a name="49773"/>49773: 
<a name="49774"/>49774: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="49775"/>49775: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="49776"/>49776: <i>%% ping-pong like test case.</i>
<a name="49777"/>49777: <i>%% Server:       Transport = socket(tcp), Active = true</i>
<a name="49778"/>49778: <i>%% Client:       Transport = socket(tcp), Active = true</i>
<a name="49779"/>49779: <i>%% Message Size: large (=3)</i>
<a name="49780"/>49780: <i>%% Domain:       local</i>
<a name="49781"/>49781: <i>%% </i>
<a name="49782"/>49782: 
<a name="ttest_ssockt_csockt_large_tcpL-1"/><a name="49783"/>49783: <b>ttest_ssockt_csockt_large_tcpL</b>(Config) when is_list(Config) -&gt;
<a name="49784"/>49784:     Runtime = which_ttest_runtime(Config),
<a name="ttest_ssockt_csockt_large_tcpL-last_expr"/><a name="49785"/>49785: <b>    ttest_tcp</b>(ttest_ssockt_csockt_large_tcpL,
<a name="49786"/>49786:               Runtime,
<a name="49787"/>49787:               local,
<a name="49788"/>49788:               sock, true,
<a name="49789"/>49789:               sock, true,
<a name="49790"/>49790:               3, ttest_large_max_outstanding(Config)).
<a name="49791"/>49791: 
<a name="49792"/>49792: 
<a name="49793"/>49793: 
<a name="49794"/>49794: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="49795"/>49795: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="49796"/>49796: <i>%% ping-pong like test case.</i>
<a name="49797"/>49797: <i>%% Server:       Transport = socket(tcp), Active = true</i>
<a name="49798"/>49798: <i>%% Client:       Transport = socket(tcp), Active = once</i>
<a name="49799"/>49799: <i>%% Message Size: small (=1)</i>
<a name="49800"/>49800: <i>%% Domain:       inet</i>
<a name="49801"/>49801: <i>%% Remote:       false (run everything on the local node)</i>
<a name="49802"/>49802: <i>%%</i>
<a name="49803"/>49803: 
<a name="ttest_simple_ssockt_csocko_small_tcp4-1"/><a name="49804"/>49804: <b>ttest_simple_ssockt_csocko_small_tcp4</b>(Config) when is_list(Config) -&gt;
<a name="49805"/>49805:     Runtime = which_ttest_runtime(Config),
<a name="ttest_simple_ssockt_csocko_small_tcp4-last_expr"/><a name="49806"/>49806: <b>    ttest_tcp</b>(?FUNCTION_NAME,
<a name="49807"/>49807:               Runtime,
<a name="49808"/>49808:               inet,
<a name="49809"/>49809:               sock, true,
<a name="49810"/>49810:               sock, once,
<a name="49811"/>49811:               1, ttest_small_max_outstanding(Config),
<a name="49812"/>49812: 	      false).
<a name="49813"/>49813: 
<a name="49814"/>49814: 
<a name="49815"/>49815: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="49816"/>49816: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="49817"/>49817: <i>%% ping-pong like test case.</i>
<a name="49818"/>49818: <i>%% Server:       Transport = socket(tcp), Active = true</i>
<a name="49819"/>49819: <i>%% Client:       Transport = socket(tcp), Active = once</i>
<a name="49820"/>49820: <i>%% Message Size: small (=1)</i>
<a name="49821"/>49821: <i>%% Domain:       inet6</i>
<a name="49822"/>49822: <i>%% </i>
<a name="49823"/>49823: 
<a name="ttest_simple_ssockt_csocko_small_tcp6-1"/><a name="49824"/>49824: <b>ttest_simple_ssockt_csocko_small_tcp6</b>(Config) when is_list(Config) -&gt;
<a name="49825"/>49825:     Runtime = which_ttest_runtime(Config),
<a name="ttest_simple_ssockt_csocko_small_tcp6-last_expr"/><a name="49826"/>49826: <b>    ttest_tcp</b>(?FUNCTION_NAME,
<a name="49827"/>49827:               Runtime,
<a name="49828"/>49828:               inet6,
<a name="49829"/>49829:               sock, true,
<a name="49830"/>49830:               sock, once,
<a name="49831"/>49831:               1, ttest_small_max_outstanding(Config),
<a name="49832"/>49832: 	      false).
<a name="49833"/>49833: 
<a name="49834"/>49834: 
<a name="49835"/>49835: 
<a name="49836"/>49836: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="49837"/>49837: <i>%% This test case uses the time test (ttest) utility to implement a </i>
<a name="49838"/>49838: <i>%% ping-pong like test case.</i>
<a name="49839"/>49839: <i>%% Server:       Transport = socket(tcp), Active = true</i>
<a name="49840"/>49840: <i>%% Client:       Transport = socket(tcp), Active = once</i>
<a name="49841"/>49841: <i>%% Message Size: small (=1)</i>
<a name="49842"/>49842: <i>%% Domain:       local</i>
<a name="49843"/>49843: <i>%% </i>
<a name="49844"/>49844: 
<a name="ttest_simple_ssockt_csocko_small_tcpL-1"/><a name="49845"/>49845: <b>ttest_simple_ssockt_csocko_small_tcpL</b>(Config) when is_list(Config) -&gt;
<a name="49846"/>49846:     Runtime = which_ttest_runtime(Config),
<a name="ttest_simple_ssockt_csocko_small_tcpL-last_expr"/><a name="49847"/>49847: <b>    ttest_tcp</b>(?FUNCTION_NAME,
<a name="49848"/>49848:               Runtime,
<a name="49849"/>49849:               local,
<a name="49850"/>49850:               sock, true,
<a name="49851"/>49851:               sock, once,
<a name="49852"/>49852:               1, ttest_small_max_outstanding(Config),
<a name="49853"/>49853: 	      false).
<a name="49854"/>49854: 
<a name="49855"/>49855: 
<a name="49856"/>49856: 
<a name="49857"/>49857: 
<a name="49858"/>49858: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="49859"/>49859: 
<a name="which_ttest_runtime-1"/><a name="49860"/>49860: <b>which_ttest_runtime</b>(Config) when is_list(Config) -&gt;
<a name="which_ttest_runtime-last_expr"/><a name="49861"/>49861: <b>    case lists:keysearch</b>(esock_test_ttest_runtime, 1, Config) of
<a name="49862"/>49862:         {value, {esock_test_ttest_runtime, Runtime}} -&gt;
<a name="49863"/>49863:             Runtime;
<a name="49864"/>49864:         false -&gt;
<a name="49865"/>49865:             which_ttest_runtime_env()
<a name="49866"/>49866:     end.
<a name="49867"/>49867: 
<a name="which_ttest_runtime_env-0"/><a name="49868"/>49868: <b>which_ttest_runtime_env</b>() -&gt;
<a name="which_ttest_runtime_env-last_expr"/><a name="49869"/>49869: <b>    which_ttest_runtime_env</b>(os:getenv(&quot;ESOCK_TEST_TTEST_RUNTIME&quot;)).
<a name="49870"/>49870: 
<a name="which_ttest_runtime_env-1"/><a name="49871"/>49871: <b>which_ttest_runtime_env</b>(TStr) when is_list(TStr) -&gt;
<a name="49872"/>49872:     which_ttest_runtime_env2(lists:reverse(TStr));
<a name="49873"/>49873: <b>which_ttest_runtime_env</b>(false) -&gt;
<a name="which_ttest_runtime_env-last_expr"/><a name="49874"/>49874:     ?TTEST_RUNTIME.
<a name="49875"/>49875: 
<a name="49876"/>49876: 
<a name="49877"/>49877: <i>%% The format is: &lt;int&gt;[unit]</i>
<a name="49878"/>49878: <i>%% where the optional unit can be:</i>
<a name="49879"/>49879: <i>%% ms: milliseconds</i>
<a name="49880"/>49880: <i>%% s:  seconds (default)</i>
<a name="49881"/>49881: <i>%% m:  minutes</i>
<a name="which_ttest_runtime_env2-1"/><a name="49882"/>49882: <b>which_ttest_runtime_env2</b>([$s, $m | MS]) when (length(MS) &gt; 0) -&gt;
<a name="49883"/>49883:     convert_time(MS, fun(X) -&gt; X end);
<a name="49884"/>49884: <b>which_ttest_runtime_env2</b>([$m | M]) when (length(M) &gt; 0) -&gt;
<a name="49885"/>49885:     convert_time(M, fun(X) -&gt; ?MINS(X) end);
<a name="49886"/>49886: <b>which_ttest_runtime_env2</b>([$s | S]) when (length(S) &gt; 0) -&gt;
<a name="49887"/>49887:     convert_time(S, fun(X) -&gt; ?SECS(X) end);
<a name="49888"/>49888: <b>which_ttest_runtime_env2</b>(S) -&gt;
<a name="which_ttest_runtime_env2-last_expr"/><a name="49889"/>49889: <b>    convert_time</b>(S, fun(X) -&gt; ?SECS(X) end).
<a name="49890"/>49890: 
<a name="convert_time-2"/><a name="49891"/>49891: <b>convert_time</b>(TStrRev, Convert) -&gt;
<a name="convert_time-last_expr"/><a name="49892"/>49892: <b>    try list_to_integer</b>(lists:reverse(TStrRev)) of
<a name="49893"/>49893:         I -&gt; Convert(I)
<a name="49894"/>49894:     catch
<a name="49895"/>49895:         _:_ -&gt;
<a name="49896"/>49896:             ?TTEST_RUNTIME
<a name="49897"/>49897:     end.
<a name="49898"/>49898: 
<a name="49899"/>49899: <i>%% ttest_tcp(TC,</i>
<a name="49900"/>49900: <i>%%           Domain,</i>
<a name="49901"/>49901: <i>%%           ServerMod, ServerActive,</i>
<a name="49902"/>49902: <i>%%           ClientMod, ClientActive,</i>
<a name="49903"/>49903: <i>%%           MsgID, MaxOutstanding) -&gt;</i>
<a name="49904"/>49904: <i>%%     ttest_tcp(TC,</i>
<a name="49905"/>49905: <i>%%               ?TTEST_RUNTIME,</i>
<a name="49906"/>49906: <i>%%               Domain,</i>
<a name="49907"/>49907: <i>%%               ServerMod, ServerActive,</i>
<a name="49908"/>49908: <i>%%               ClientMod, ClientActive,</i>
<a name="49909"/>49909: <i>%%               MsgID, MaxOutstanding).</i>
<a name="ttest_tcp-9"/><a name="49910"/>49910: <b>ttest_tcp</b>(TC,
<a name="49911"/>49911:           Runtime,
<a name="49912"/>49912:           Domain,
<a name="49913"/>49913:           ServerMod, ServerActive,
<a name="49914"/>49914:           ClientMod, ClientActive,
<a name="49915"/>49915:           MsgID, MaxOutstanding) -&gt;
<a name="ttest_tcp-last_expr"/><a name="49916"/>49916: <b>    ttest_tcp</b>(TC,
<a name="49917"/>49917: 	      Runtime,
<a name="49918"/>49918: 	      Domain,
<a name="49919"/>49919: 	      ServerMod, ServerActive,
<a name="49920"/>49920: 	      ClientMod, ClientActive,
<a name="49921"/>49921: 	      MsgID, MaxOutstanding, true).
<a name="49922"/>49922: 
<a name="ttest_tcp-10"/><a name="49923"/>49923: <b>ttest_tcp</b>(TC,
<a name="49924"/>49924:           Runtime,
<a name="49925"/>49925:           Domain,
<a name="49926"/>49926:           ServerMod, ServerActive,
<a name="49927"/>49927:           ClientMod, ClientActive,
<a name="49928"/>49928:           MsgID, MaxOutstanding,
<a name="49929"/>49929: 	  Remote) -&gt;
<a name="ttest_tcp-last_expr"/><a name="49930"/>49930: <b>    tc_try</b>(TC,
<a name="49931"/>49931:            fun() -&gt;
<a name="49932"/>49932:                    if
<a name="49933"/>49933:  
<a name="49934"/>49934:                        (Domain =:= local) -&gt;
<a name="49935"/>49935:                            %% On darwin we seem to hit the system limit(s)
<a name="49936"/>49936:                            %% much earlier.
<a name="49937"/>49937:                            %% The tests &quot;mostly&quot; work, but random cases fail
<a name="49938"/>49938:                            %% (even on reasonably powerful machines),
<a name="49939"/>49939:                            %% so its much simpler to just skip on darwin...
<a name="49940"/>49940:                            has_support_unix_domain_socket(),
<a name="49941"/>49941:                            is_not_darwin();
<a name="49942"/>49942:                        (Domain =:= inet) -&gt;
<a name="49943"/>49943:                            has_support_ipv4();
<a name="49944"/>49944:                        (Domain =:= inet6) -&gt;
<a name="49945"/>49945:                            has_support_ipv6();
<a name="49946"/>49946:                        true -&gt; ok 
<a name="49947"/>49947:                    end
<a name="49948"/>49948:            end,
<a name="49949"/>49949:            fun() -&gt;
<a name="49950"/>49950:                    %% This may be overkill, depending on the runtime,
<a name="49951"/>49951:                    %% but better safe then sorry...
<a name="49952"/>49952:                    ?TT(Runtime + ?SECS(60)),
<a name="49953"/>49953:                    ?P(&quot;Parameters: &quot;
<a name="49954"/>49954:                       &quot;~n   Domain:          ~p&quot;
<a name="49955"/>49955:                       &quot;~n   Message ID:      ~p&quot;
<a name="49956"/>49956:                       &quot;~n   Max Outstanding: ~p&quot;
<a name="49957"/>49957:                       &quot;~n   Running Time:    ~p&quot;
<a name="49958"/>49958:                       &quot;~n   Server Module:   ~p&quot;
<a name="49959"/>49959:                       &quot;~n   Server Active:   ~p&quot;
<a name="49960"/>49960:                       &quot;~n   Client Module:   ~p&quot;
<a name="49961"/>49961:                       &quot;~n   Client Active:   ~p&quot;
<a name="49962"/>49962:                       &quot;~n   Remote:          ~p&quot;,
<a name="49963"/>49963:                       [Domain, MsgID, MaxOutstanding, Runtime,
<a name="49964"/>49964:                        ServerMod, ServerActive, ClientMod, ClientActive,
<a name="49965"/>49965: 		       Remote]),
<a name="49966"/>49966:                    InitState = #{domain          =&gt; Domain,
<a name="49967"/>49967:                                  msg_id          =&gt; MsgID,
<a name="49968"/>49968:                                  max_outstanding =&gt; MaxOutstanding,
<a name="49969"/>49969:                                  runtime         =&gt; Runtime,
<a name="49970"/>49970:                                  server_mod      =&gt; ServerMod,
<a name="49971"/>49971:                                  server_active   =&gt; ServerActive,
<a name="49972"/>49972:                                  client_mod      =&gt; ClientMod,
<a name="49973"/>49973:                                  client_active   =&gt; ClientActive,
<a name="49974"/>49974: 				 remote          =&gt; Remote},
<a name="49975"/>49975:                    ok = ttest_tcp(InitState)
<a name="49976"/>49976:            end).
<a name="49977"/>49977: 
<a name="49978"/>49978: 
<a name="49979"/>49979: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="49980"/>49980: 
<a name="ttest_tcp-1"/><a name="49981"/>49981: <b>ttest_tcp</b>(InitState) -&gt;
<a name="49982"/>49982:     ServerSeq =
<a name="49983"/>49983:         [
<a name="49984"/>49984:          %% *** Wait for start order part ***
<a name="49985"/>49985:          #{desc =&gt; &quot;await start&quot;,
<a name="49986"/>49986:            cmd  =&gt; fun(State) -&gt;
<a name="49987"/>49987:                            Tester = ?SEV_AWAIT_START(),
<a name="49988"/>49988:                            {ok, State#{tester =&gt; Tester}}
<a name="49989"/>49989:                    end},
<a name="49990"/>49990:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="49991"/>49991:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="49992"/>49992:                            _MRef = erlang:monitor(process, Tester),
<a name="49993"/>49993:                            ok
<a name="49994"/>49994:                    end},
<a name="49995"/>49995: 
<a name="49996"/>49996: 
<a name="49997"/>49997:          %% *** Init part ***
<a name="49998"/>49998:          #{desc =&gt; &quot;(maybe) create node&quot;,
<a name="49999"/>49999:            cmd  =&gt; fun(#{remote := true} = State) -&gt;
<a name="50000"/>50000:                            {Peer, Node} = ?START_NODE(&quot;server&quot;),
<a name="50001"/>50001: 			   ?SEV_IPRINT(&quot;server node created:&quot;
<a name="50002"/>50002: 				       &quot;~n   Peer: ~p&quot;
<a name="50003"/>50003: 				       &quot;~n   Node: ~p&quot;, [Peer, Node]),
<a name="50004"/>50004:                            {ok, State#{peer =&gt; Peer, node =&gt; Node}};
<a name="50005"/>50005: 		      (State) -&gt;
<a name="50006"/>50006: 			   ?SEV_IPRINT(&quot;use local node for server&quot;),
<a name="50007"/>50007: 			   {ok, State#{peer =&gt; undefined, node =&gt; node()}}
<a name="50008"/>50008:                    end},
<a name="50009"/>50009:          #{desc =&gt; &quot;(maybe) monitor server node&quot;,
<a name="50010"/>50010:            cmd  =&gt; fun(#{node := Node} = _State) when (Node =/= node) -&gt;
<a name="50011"/>50011:                            true = erlang:monitor_node(Node, true),
<a name="50012"/>50012: 			   ?SEV_IPRINT(&quot;~p monitored&quot;, [Node]),
<a name="50013"/>50013:                            ok;
<a name="50014"/>50014: 		      (_State) -&gt;
<a name="50015"/>50015: 			   ?SEV_IPRINT(&quot;nothing&quot;),
<a name="50016"/>50016: 			   ok
<a name="50017"/>50017:                    end},
<a name="50018"/>50018:          #{desc =&gt; &quot;start ttest (remote) server&quot;,
<a name="50019"/>50019:            cmd  =&gt; fun(#{domain := local = Domain,
<a name="50020"/>50020:                          mod    := Mod,
<a name="50021"/>50021:                          active := Active,
<a name="50022"/>50022:                          node   := Node} = State) -&gt;
<a name="50023"/>50023:                            case ttest_tcp_server_start(Node,
<a name="50024"/>50024:                                                        Domain, Mod, Active) of
<a name="50025"/>50025:                                {ok, {{Pid, _}, Path}} -&gt;
<a name="50026"/>50026:                                    ?SEV_IPRINT(&quot;server started: &quot;
<a name="50027"/>50027:                                                &quot;~n   Pid:  ~p&quot;
<a name="50028"/>50028:                                                &quot;~n   Path: ~p&quot;, [Pid, Path]),
<a name="50029"/>50029:                                    {ok, State#{rserver =&gt; Pid,
<a name="50030"/>50030:                                                path    =&gt; Path}};
<a name="50031"/>50031:                                {error, _} = ERROR -&gt;
<a name="50032"/>50032:                                    ERROR
<a name="50033"/>50033:                            end;
<a name="50034"/>50034:                       (#{domain := Domain,
<a name="50035"/>50035:                          mod    := Mod,
<a name="50036"/>50036:                          active := Active,
<a name="50037"/>50037:                          node   := Node} = State) -&gt;
<a name="50038"/>50038:                            case ttest_tcp_server_start(Node,
<a name="50039"/>50039:                                                        Domain, Mod, Active) of
<a name="50040"/>50040:                                {ok, {{Pid, _}, {Addr, Port}}} -&gt;
<a name="50041"/>50041:                                    ?SEV_IPRINT(&quot;server started: &quot;
<a name="50042"/>50042:                                                &quot;~n   Pid:  ~p&quot;
<a name="50043"/>50043:                                                &quot;~n   Addr: ~p&quot;
<a name="50044"/>50044:                                                &quot;~n   Port: ~p&quot;,
<a name="50045"/>50045:                                                [Pid, Addr, Port]),
<a name="50046"/>50046:                                    {ok, State#{rserver =&gt; Pid,
<a name="50047"/>50047:                                                addr    =&gt; Addr,
<a name="50048"/>50048:                                                port    =&gt; Port}};
<a name="50049"/>50049:                                {error, _} = ERROR -&gt;
<a name="50050"/>50050:                                    ERROR
<a name="50051"/>50051:                            end
<a name="50052"/>50052:                    end},
<a name="50053"/>50053:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="50054"/>50054:            cmd  =&gt; fun(#{domain := local,
<a name="50055"/>50055:                          tester := Tester,
<a name="50056"/>50056:                          path   := Path}) -&gt;
<a name="50057"/>50057:                            ?SEV_ANNOUNCE_READY(Tester, init, Path),
<a name="50058"/>50058:                            ok;
<a name="50059"/>50059:                       (#{tester := Tester,
<a name="50060"/>50060:                          addr   := Addr,
<a name="50061"/>50061:                          port   := Port}) -&gt;
<a name="50062"/>50062:                            ?SEV_ANNOUNCE_READY(Tester, init, {Addr, Port}),
<a name="50063"/>50063:                            ok
<a name="50064"/>50064:                    end},
<a name="50065"/>50065: 
<a name="50066"/>50066: 
<a name="50067"/>50067:          %% *** Termination ***
<a name="50068"/>50068:          #{desc =&gt; &quot;await terminate (from tester)&quot;,
<a name="50069"/>50069:            cmd  =&gt; fun(#{tester  := Tester, 
<a name="50070"/>50070:                          rserver := RServer} = State) -&gt;
<a name="50071"/>50071:                            case ?SEV_AWAIT_TERMINATE(Tester, tester,
<a name="50072"/>50072:                                                      [{rserver, RServer}]) of
<a name="50073"/>50073:                                ok -&gt;
<a name="50074"/>50074:                                    ?SEV_IPRINT(&quot;received termination request&quot;),
<a name="50075"/>50075:                                    {ok, maps:remove(tester, State)};
<a name="50076"/>50076:                                {error, Reason} = ERROR -&gt;
<a name="50077"/>50077:                                    ?SEV_EPRINT(&quot;received unexpected error: &quot;
<a name="50078"/>50078:                                                &quot;~n   ~p&quot;, [Reason]),
<a name="50079"/>50079:                                    ERROR
<a name="50080"/>50080:                            end
<a name="50081"/>50081:                    end},
<a name="50082"/>50082:          %% The remote server is in a accept, with a timeout of 5 seconds,
<a name="50083"/>50083:          %% so may have to wait a bit...
<a name="50084"/>50084:          #{desc =&gt; &quot;order (remote) ttest server terminate&quot;,
<a name="50085"/>50085:            cmd  =&gt; fun(#{node    := _Node,
<a name="50086"/>50086:                          rserver := RServer}) -&gt;
<a name="50087"/>50087:                            ttest_tcp_server_stop(RServer),
<a name="50088"/>50088:                            ok
<a name="50089"/>50089:                    end},
<a name="50090"/>50090:          #{desc =&gt; &quot;await ttest (remote) server termination&quot;,
<a name="50091"/>50091:            cmd  =&gt; fun(#{rserver := RServer} = State) -&gt;
<a name="50092"/>50092:                            ?SEV_AWAIT_TERMINATION(RServer),
<a name="50093"/>50093:                            State1 = maps:remove(rserver, State),
<a name="50094"/>50094:                            {ok, State1}
<a name="50095"/>50095:                    end},
<a name="50096"/>50096:          #{desc =&gt; &quot;(maybe) stop (server) node&quot;,
<a name="50097"/>50097:            cmd  =&gt; fun(#{peer := Peer} = State)  when (Peer =/= undefined) -&gt;
<a name="50098"/>50098:                            {ok,
<a name="50099"/>50099:                             try peer:stop(Peer) of
<a name="50100"/>50100:                                 ok -&gt;
<a name="50101"/>50101:                                     State#{node_stop =&gt; ok};
<a name="50102"/>50102:                                 {error, Reason} -&gt;
<a name="50103"/>50103:                                     ?SEV_EPRINT(&quot;Unexpected node stop result: &quot;
<a name="50104"/>50104:                                                 &quot;~n   ~p&quot;, [Reason]),
<a name="50105"/>50105:                                     State#{node_stop =&gt; error}
<a name="50106"/>50106:                             catch
<a name="50107"/>50107:                                 C:E:S -&gt;
<a name="50108"/>50108:                                     ?SEV_EPRINT(&quot;Unexpected node stop result: &quot;
<a name="50109"/>50109:                                                 &quot;~n   Class: ~p&quot;
<a name="50110"/>50110:                                                 &quot;~n   Error: ~p&quot;
<a name="50111"/>50111:                                                 &quot;~n   Stack: ~p&quot;,[C, E, S]),
<a name="50112"/>50112:                                     State#{node_stop =&gt; error}
<a name="50113"/>50113:                             end};
<a name="50114"/>50114: 		      (_) -&gt;
<a name="50115"/>50115:                            ?SEV_IPRINT(&quot;nothing&quot;),
<a name="50116"/>50116: 			   ok
<a name="50117"/>50117:                    end},
<a name="50118"/>50118:          #{desc =&gt; &quot;(maybe) await (server) node termination&quot;,
<a name="50119"/>50119:            cmd  =&gt; fun(#{node := Node, node_stop := ok} = State)
<a name="50120"/>50120: 			 when (Node =/= node()) -&gt;
<a name="50121"/>50121:                            ?SEV_IPRINT(&quot;Success node stop - await nodedown&quot;),
<a name="50122"/>50122:                            receive
<a name="50123"/>50123:                                {nodedown, Node} -&gt;
<a name="50124"/>50124:                                    ?SEV_IPRINT(&quot;nodedown received - cleanup&quot;),
<a name="50125"/>50125:                                    State1 = maps:remove(node, State),
<a name="50126"/>50126:                                    {ok, State1}
<a name="50127"/>50127:                            end;
<a name="50128"/>50128:                       (#{node_stop := error} = State) -&gt;
<a name="50129"/>50129:                            ?SEV_IPRINT(&quot;Failed node stop - cleanup&quot;),
<a name="50130"/>50130:                            State1 = maps:remove(node, State),
<a name="50131"/>50131:                            {ok, State1};
<a name="50132"/>50132: 		      (State) -&gt;
<a name="50133"/>50133:                            ?SEV_IPRINT(&quot;nothing&quot;),
<a name="50134"/>50134:                            State1 = maps:remove(node, State),
<a name="50135"/>50135:                            {ok, State1}
<a name="50136"/>50136:                    end},
<a name="50137"/>50137: 
<a name="50138"/>50138: 
<a name="50139"/>50139:          %% *** We are done ***
<a name="50140"/>50140:          ?SEV_FINISH_NORMAL
<a name="50141"/>50141:         ],
<a name="50142"/>50142: 
<a name="50143"/>50143:     ClientSeq =
<a name="50144"/>50144:         [
<a name="50145"/>50145:          %% *** Wait for start order part ***
<a name="50146"/>50146:          #{desc =&gt; &quot;await start&quot;,
<a name="50147"/>50147:            cmd  =&gt; fun(#{domain := local} = State) -&gt;
<a name="50148"/>50148:                            {Tester, ServerPath} = 
<a name="50149"/>50149:                                ?SEV_AWAIT_START(),
<a name="50150"/>50150:                            ?SEV_IPRINT(&quot;started with server info: &quot;
<a name="50151"/>50151:                                        &quot;~n   Path: ~p&quot;, [ServerPath]),
<a name="50152"/>50152:                            {ok, State#{tester      =&gt; Tester,
<a name="50153"/>50153:                                        server_path =&gt; ServerPath}};
<a name="50154"/>50154:                       (State) -&gt;
<a name="50155"/>50155:                            {Tester, {ServerAddr, ServerPort}} = 
<a name="50156"/>50156:                                ?SEV_AWAIT_START(),
<a name="50157"/>50157:                            ?SEV_IPRINT(&quot;started with server info: &quot;
<a name="50158"/>50158:                                        &quot;~n   Addr: ~p&quot;
<a name="50159"/>50159:                                        &quot;~n   Port: ~p&quot;,
<a name="50160"/>50160:                                        [ServerAddr, ServerPort]),
<a name="50161"/>50161:                            {ok, State#{tester      =&gt; Tester,
<a name="50162"/>50162:                                        server_addr =&gt; ServerAddr,
<a name="50163"/>50163:                                        server_port =&gt; ServerPort}}
<a name="50164"/>50164:                    end},
<a name="50165"/>50165:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="50166"/>50166:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="50167"/>50167:                            _MRef = erlang:monitor(process, Tester),
<a name="50168"/>50168:                            ok
<a name="50169"/>50169:                    end},
<a name="50170"/>50170: 
<a name="50171"/>50171: 
<a name="50172"/>50172:          %% *** Init part ***
<a name="50173"/>50173:          #{desc =&gt; &quot;create node&quot;,
<a name="50174"/>50174:            cmd  =&gt; fun(#{remote := true, host := _Host} = State) -&gt;
<a name="50175"/>50175:                            %% Because peer does not accept a host argument,
<a name="50176"/>50176:                            %% we can no longer start &quot;remote&quot; nodes...
<a name="50177"/>50177:                            %% Not that we actually did that. We always
<a name="50178"/>50178:                            %% used local-host.
<a name="50179"/>50179:                            {Peer, Node} = ?START_NODE(&quot;client&quot;),
<a name="50180"/>50180:                            {ok, State#{peer =&gt; Peer, node =&gt; Node}};
<a name="50181"/>50181: 		      (State) -&gt;
<a name="50182"/>50182: 			   {ok, State#{peer =&gt; undefined, node =&gt; node()}}
<a name="50183"/>50183:                    end},
<a name="50184"/>50184:          #{desc =&gt; &quot;(maybe) monitor client node&quot;,
<a name="50185"/>50185:            cmd  =&gt; fun(#{node := Node} = _State) when (Node =/= node()) -&gt;
<a name="50186"/>50186:                            true = erlang:monitor_node(Node, true),
<a name="50187"/>50187: 			   ?SEV_IPRINT(&quot;~p monitored&quot;, [Node]),
<a name="50188"/>50188:                            ok;
<a name="50189"/>50189: 		      (_) -&gt;
<a name="50190"/>50190: 			   ?SEV_IPRINT(&quot;nothing&quot;),
<a name="50191"/>50191: 			   ok
<a name="50192"/>50192:                    end},
<a name="50193"/>50193:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="50194"/>50194:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="50195"/>50195:                            ?SEV_ANNOUNCE_READY(Tester, init),
<a name="50196"/>50196:                            ok
<a name="50197"/>50197:                    end},
<a name="50198"/>50198: 
<a name="50199"/>50199: 
<a name="50200"/>50200:          %% The actual test
<a name="50201"/>50201:          #{desc =&gt; &quot;await continue (ttest)&quot;,
<a name="50202"/>50202:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="50203"/>50203:                            ?SEV_AWAIT_CONTINUE(Tester, tester, ttest),
<a name="50204"/>50204:                            ok
<a name="50205"/>50205:                    end},
<a name="50206"/>50206:          #{desc =&gt; &quot;start ttest (remote) client&quot;,
<a name="50207"/>50207:            cmd  =&gt; fun(#{domain          := local = Domain,
<a name="50208"/>50208:                          node            := Node,
<a name="50209"/>50209:                          mod             := Mod,
<a name="50210"/>50210:                          active          := Active,
<a name="50211"/>50211:                          msg_id          := MsgID,
<a name="50212"/>50212:                          max_outstanding := MaxOutstanding,
<a name="50213"/>50213:                          runtime         := RunTime,
<a name="50214"/>50214:                          server_path     := Path} = State) -&gt;
<a name="50215"/>50215:                            Self   = self(),
<a name="50216"/>50216:                            Notify =
<a name="50217"/>50217:                                fun(Result) -&gt;
<a name="50218"/>50218:                                        ?SEV_ANNOUNCE_READY(Self, ttest, Result)
<a name="50219"/>50219:                                end,                           
<a name="50220"/>50220:                            case ttest_tcp_client_start(Node, Notify,
<a name="50221"/>50221:                                                        Domain, Mod,
<a name="50222"/>50222:                                                        Path,
<a name="50223"/>50223:                                                        Active,
<a name="50224"/>50224:                                                        MsgID, MaxOutstanding,
<a name="50225"/>50225:                                                        RunTime) of
<a name="50226"/>50226:                                {ok, {Pid, _MRef}} -&gt;
<a name="50227"/>50227:                                    {ok, State#{rclient =&gt; Pid}};
<a name="50228"/>50228:                                {error, _} = ERROR -&gt;
<a name="50229"/>50229:                                    ERROR
<a name="50230"/>50230:                            end;
<a name="50231"/>50231:                       (#{domain          := Domain,
<a name="50232"/>50232:                          node            := Node,
<a name="50233"/>50233:                          mod             := Mod,
<a name="50234"/>50234:                          active          := Active,
<a name="50235"/>50235:                          msg_id          := MsgID,
<a name="50236"/>50236:                          max_outstanding := MaxOutstanding,
<a name="50237"/>50237:                          runtime         := RunTime,
<a name="50238"/>50238:                          server_addr     := Addr,
<a name="50239"/>50239:                          server_port     := Port} = State) -&gt;
<a name="50240"/>50240:                            Self   = self(),
<a name="50241"/>50241:                            Notify =
<a name="50242"/>50242:                                fun(Result) -&gt;
<a name="50243"/>50243:                                        ?SEV_ANNOUNCE_READY(Self, ttest, Result)
<a name="50244"/>50244:                                end,                           
<a name="50245"/>50245:                            case ttest_tcp_client_start(Node, Notify,
<a name="50246"/>50246:                                                        Domain, Mod,
<a name="50247"/>50247:                                                        {Addr, Port},
<a name="50248"/>50248:                                                        Active,
<a name="50249"/>50249:                                                        MsgID, MaxOutstanding,
<a name="50250"/>50250:                                                        RunTime) of
<a name="50251"/>50251:                                {ok, {Pid, _MRef}} -&gt;
<a name="50252"/>50252:                                    {ok, State#{rclient =&gt; Pid}};
<a name="50253"/>50253:                                {error, {connect, Reason, ServerInfo} = EI} -&gt;
<a name="50254"/>50254:                                    ?SEV_EPRINT(&quot;Failed connecting to server: &quot;
<a name="50255"/>50255:                                                &quot;~n   Reason: ~p&quot;
<a name="50256"/>50256:                                                &quot;~n   Server: ~p&quot;,
<a name="50257"/>50257:                                                [Reason, ServerInfo]),
<a name="50258"/>50258:                                    case Reason of
<a name="50259"/>50259:                                        eaddrnotavail -&gt;
<a name="50260"/>50260:                                            {skip, Reason};
<a name="50261"/>50261:                                        network_unreachable -&gt;
<a name="50262"/>50262:                                            {skip, Reason};
<a name="50263"/>50263:                                        _ -&gt;
<a name="50264"/>50264:                                            {error, EI}
<a name="50265"/>50265:                                    end;
<a name="50266"/>50266:                                {error, _} = ERROR -&gt;
<a name="50267"/>50267:                                    ERROR
<a name="50268"/>50268:                            end
<a name="50269"/>50269:                    end},
<a name="50270"/>50270:          #{desc =&gt; &quot;await ttest ready&quot;,
<a name="50271"/>50271:            cmd  =&gt; fun(#{tester  := Tester,
<a name="50272"/>50272:                          rclient := RClient} = State) -&gt;
<a name="50273"/>50273:                            case ?SEV_AWAIT_READY(RClient, rclient, ttest, 
<a name="50274"/>50274:                                                  [{tester, Tester}]) of
<a name="50275"/>50275:                              {ok, Result} -&gt;
<a name="50276"/>50276:                                  {ok, State#{result =&gt; Result}};
<a name="50277"/>50277:                              {error, _} = ERROR -&gt;
<a name="50278"/>50278:                                  ERROR
<a name="50279"/>50279:                          end
<a name="50280"/>50280:                    end},
<a name="50281"/>50281:          #{desc =&gt; &quot;await ttest (remote) client termination&quot;,
<a name="50282"/>50282:            cmd  =&gt; fun(#{rclient := RClient} = State) -&gt;
<a name="50283"/>50283:                            ?SEV_AWAIT_TERMINATION(RClient),
<a name="50284"/>50284:                            State1 = maps:remove(rclient, State),
<a name="50285"/>50285:                            {ok, State1}
<a name="50286"/>50286:                    end},
<a name="50287"/>50287:          #{desc =&gt; &quot;announce ready (ttest)&quot;,
<a name="50288"/>50288:            cmd  =&gt; fun(#{tester := Tester,
<a name="50289"/>50289:                          result := Result} = State) -&gt;
<a name="50290"/>50290:                            ?SEV_ANNOUNCE_READY(Tester, ttest, Result),
<a name="50291"/>50291:                            {ok, maps:remove(result, State)}
<a name="50292"/>50292:                    end},
<a name="50293"/>50293: 
<a name="50294"/>50294: 
<a name="50295"/>50295:          %% *** Termination ***
<a name="50296"/>50296:          #{desc =&gt; &quot;await terminate (from tester)&quot;,
<a name="50297"/>50297:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="50298"/>50298:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="50299"/>50299:                                ok -&gt;
<a name="50300"/>50300:                                    {ok, maps:remove(tester, State)};
<a name="50301"/>50301:                                {error, _} = ERROR -&gt;
<a name="50302"/>50302:                                    ERROR
<a name="50303"/>50303:                            end
<a name="50304"/>50304:                    end},
<a name="50305"/>50305:          #{desc =&gt; &quot;(maybe) stop (client) node&quot;,
<a name="50306"/>50306:            cmd  =&gt; fun(#{peer := Peer} = State) when (Peer =/= undefined) -&gt;
<a name="50307"/>50307:                            {ok,
<a name="50308"/>50308:                             try peer:stop(Peer) of
<a name="50309"/>50309:                                 ok -&gt;
<a name="50310"/>50310:                                     State#{node_stop =&gt; ok};
<a name="50311"/>50311:                                 {error, Reason} -&gt;
<a name="50312"/>50312:                                     ?SEV_EPRINT(&quot;Unexpected node stop result: &quot;
<a name="50313"/>50313:                                                 &quot;~n   ~p&quot;, [Reason]),
<a name="50314"/>50314:                                     State#{node_stop =&gt; error}
<a name="50315"/>50315:                             catch
<a name="50316"/>50316:                                 C:E:S -&gt;
<a name="50317"/>50317:                                     ?SEV_EPRINT(&quot;Unexpected node stop result: &quot;
<a name="50318"/>50318:                                                 &quot;~n   Class: ~p&quot;
<a name="50319"/>50319:                                                 &quot;~n   Error: ~p&quot;
<a name="50320"/>50320:                                                 &quot;~n   Stack: ~p&quot;,[C, E, S]),
<a name="50321"/>50321:                                     State#{node_stop =&gt; error}
<a name="50322"/>50322:                             end};
<a name="50323"/>50323: 		      (_) -&gt;
<a name="50324"/>50324: 			   ?SEV_IPRINT(&quot;nothing&quot;),
<a name="50325"/>50325: 			   ok
<a name="50326"/>50326:                    end},
<a name="50327"/>50327:          #{desc =&gt; &quot;(maybe) await (client) node termination&quot;,
<a name="50328"/>50328:            cmd  =&gt; fun(#{node := Node, node_stop := ok} = State)
<a name="50329"/>50329: 			 when (Node =/= node()) -&gt;
<a name="50330"/>50330:                            ?SEV_IPRINT(&quot;Success node stop - await nodedown&quot;),
<a name="50331"/>50331:                            receive
<a name="50332"/>50332:                                {nodedown, Node} -&gt;
<a name="50333"/>50333:                                    ?SEV_IPRINT(&quot;nodedown received - cleanup&quot;),
<a name="50334"/>50334:                                    State1 = maps:remove(node, State),
<a name="50335"/>50335:                                    {ok, State1}
<a name="50336"/>50336:                            end;
<a name="50337"/>50337:                       (#{node_stop := error} = State) -&gt;
<a name="50338"/>50338:                            ?SEV_IPRINT(&quot;Failed node stop - cleanup&quot;),
<a name="50339"/>50339:                            State1 = maps:remove(node, State),
<a name="50340"/>50340:                            {ok, State1};
<a name="50341"/>50341: 		      (_) -&gt;
<a name="50342"/>50342: 			   ?SEV_IPRINT(&quot;nothing&quot;),
<a name="50343"/>50343: 			   ok
<a name="50344"/>50344:                    end},
<a name="50345"/>50345: 
<a name="50346"/>50346: 
<a name="50347"/>50347:          %% *** We are done ***
<a name="50348"/>50348:          ?SEV_FINISH_NORMAL
<a name="50349"/>50349:         ],
<a name="50350"/>50350: 
<a name="50351"/>50351:     TesterSeq =
<a name="50352"/>50352:         [
<a name="50353"/>50353:          %% *** Init part ***
<a name="50354"/>50354:          #{desc =&gt; &quot;monitor server&quot;,
<a name="50355"/>50355:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="50356"/>50356:                            _MRef = erlang:monitor(process, Pid),
<a name="50357"/>50357:                            ok
<a name="50358"/>50358:                    end},
<a name="50359"/>50359:          #{desc =&gt; &quot;monitor client&quot;,
<a name="50360"/>50360:            cmd  =&gt; fun(#{client := Pid} = _State) -&gt;
<a name="50361"/>50361:                            _MRef = erlang:monitor(process, Pid),
<a name="50362"/>50362:                            ok
<a name="50363"/>50363:                    end},
<a name="50364"/>50364: 
<a name="50365"/>50365:          %% Start the server
<a name="50366"/>50366:          #{desc =&gt; &quot;order server start&quot;,
<a name="50367"/>50367:            cmd  =&gt; fun(#{server := Pid} = _State) -&gt;
<a name="50368"/>50368:                            ?SEV_ANNOUNCE_START(Pid),
<a name="50369"/>50369:                            ok
<a name="50370"/>50370:                    end},
<a name="50371"/>50371:          #{desc =&gt; &quot;await server ready (init)&quot;,
<a name="50372"/>50372:            cmd  =&gt; fun(#{domain := local,
<a name="50373"/>50373:                          server := Pid} = State) -&gt;
<a name="50374"/>50374:                            {ok, Path} = ?SEV_AWAIT_READY(Pid, server, init),
<a name="50375"/>50375:                            {ok, State#{server_path =&gt; Path}};
<a name="50376"/>50376:                       (#{server := Pid} = State) -&gt;
<a name="50377"/>50377:                            {ok, {Addr, Port}} =
<a name="50378"/>50378:                                ?SEV_AWAIT_READY(Pid, server, init),
<a name="50379"/>50379:                            {ok, State#{server_addr =&gt; Addr,
<a name="50380"/>50380:                                        server_port =&gt; Port}}
<a name="50381"/>50381:                    end},
<a name="50382"/>50382: 
<a name="50383"/>50383: 
<a name="50384"/>50384:          %% Start the client
<a name="50385"/>50385:          #{desc =&gt; &quot;order client start&quot;,
<a name="50386"/>50386:            cmd  =&gt; fun(#{domain      := local,
<a name="50387"/>50387:                          client      := Pid,
<a name="50388"/>50388:                          server_path := Path} = _State) -&gt;
<a name="50389"/>50389:                            ?SEV_ANNOUNCE_START(Pid, Path),
<a name="50390"/>50390:                            ok;
<a name="50391"/>50391:                       (#{client      := Pid,
<a name="50392"/>50392:                          server_addr := Addr,
<a name="50393"/>50393:                          server_port := Port} = _State) -&gt;
<a name="50394"/>50394:                            ?SEV_ANNOUNCE_START(Pid, {Addr, Port}),
<a name="50395"/>50395:                            ok
<a name="50396"/>50396:                    end},
<a name="50397"/>50397:          #{desc =&gt; &quot;await client ready (init)&quot;,
<a name="50398"/>50398:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="50399"/>50399:                            ok = ?SEV_AWAIT_READY(Client, client, init)
<a name="50400"/>50400:                    end},
<a name="50401"/>50401:  
<a name="50402"/>50402:          %% The actual test
<a name="50403"/>50403:          #{desc =&gt; &quot;order client continue (ttest)&quot;,
<a name="50404"/>50404:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="50405"/>50405:                            ?SEV_ANNOUNCE_CONTINUE(Client, ttest),
<a name="50406"/>50406:                            ok
<a name="50407"/>50407:                    end},
<a name="50408"/>50408:          #{desc =&gt; &quot;await client ready (ttest)&quot;,
<a name="50409"/>50409:            cmd  =&gt; fun(#{server := Server,
<a name="50410"/>50410:                          client := Client} = State) -&gt;
<a name="50411"/>50411:                            case ?SEV_AWAIT_READY(Client, client, ttest,
<a name="50412"/>50412:                                                  [{server, Server}]) of
<a name="50413"/>50413:                                {ok, Result} -&gt;
<a name="50414"/>50414:                                    {ok, State#{result =&gt; Result}};
<a name="50415"/>50415:                                {error, _} = ERROR -&gt;
<a name="50416"/>50416:                                    ERROR
<a name="50417"/>50417:                            end
<a name="50418"/>50418:                    end},
<a name="50419"/>50419: 
<a name="50420"/>50420: 
<a name="50421"/>50421:          %% *** Terminate server ***
<a name="50422"/>50422:          #{desc =&gt; &quot;order client terminate&quot;,
<a name="50423"/>50423:            cmd  =&gt; fun(#{client := Client} = _State) -&gt;
<a name="50424"/>50424:                            ?SEV_ANNOUNCE_TERMINATE(Client),
<a name="50425"/>50425:                            ok
<a name="50426"/>50426:                    end},
<a name="50427"/>50427:          #{desc =&gt; &quot;await client down&quot;,
<a name="50428"/>50428:            cmd  =&gt; fun(#{client := Client} = State) -&gt;
<a name="50429"/>50429:                            ?SEV_AWAIT_TERMINATION(Client),
<a name="50430"/>50430:                            State1 = maps:remove(client,    State),
<a name="50431"/>50431:                            {ok, State1}
<a name="50432"/>50432:                    end},
<a name="50433"/>50433:          #{desc =&gt; &quot;order server terminate&quot;,
<a name="50434"/>50434:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="50435"/>50435:                            ?SEV_ANNOUNCE_TERMINATE(Server),
<a name="50436"/>50436:                            ok
<a name="50437"/>50437:                    end},
<a name="50438"/>50438:          #{desc =&gt; &quot;await server down&quot;,
<a name="50439"/>50439:            cmd  =&gt; fun(#{server := Server} = _State) -&gt;
<a name="50440"/>50440:                            ?SEV_AWAIT_TERMINATION(Server),
<a name="50441"/>50441:                            ok
<a name="50442"/>50442:                    end},
<a name="50443"/>50443: 
<a name="50444"/>50444:          
<a name="50445"/>50445:          %% Present the results
<a name="50446"/>50446:          #{desc =&gt; &quot;present the results&quot;,
<a name="50447"/>50447:            cmd  =&gt; fun(#{result        := Result,
<a name="50448"/>50448:                          domain        := Domain,
<a name="50449"/>50449:                          server_mod    := ServerTrans,
<a name="50450"/>50450:                          server_active := ServerActive,
<a name="50451"/>50451:                          client_mod    := ClientTrans,
<a name="50452"/>50452:                          client_active := ClientActive,
<a name="50453"/>50453:                          msg_id        := MsgID} = State) -&gt;
<a name="50454"/>50454:                            case Result of
<a name="50455"/>50455:                                #{status  := ok,
<a name="50456"/>50456:                                  runtime := RunTime,
<a name="50457"/>50457:                                  cnt     := Cnt,
<a name="50458"/>50458:                                  bcnt    := BCnt} -&gt;
<a name="50459"/>50459:                                    ttest_report(Domain,
<a name="50460"/>50460:                                                 ServerTrans, ServerActive,
<a name="50461"/>50461:                                                 ClientTrans, ClientActive,
<a name="50462"/>50462:                                                 MsgID,
<a name="50463"/>50463:                                                 RunTime, BCnt, Cnt),
<a name="50464"/>50464:                                    ?SEV_IPRINT(
<a name="50465"/>50465:                                       &quot;TTest results: &quot;
<a name="50466"/>50466:                                       &quot;~n   Run Time:                    ~s&quot;
<a name="50467"/>50467:                                       &quot;~n   Byte Count:                  ~s&quot;
<a name="50468"/>50468:                                       &quot;~n   Number of message exchanges: ~s&quot;
<a name="50469"/>50469:                                       &quot;~n~n&quot;,
<a name="50470"/>50470:                                       [
<a name="50471"/>50471:                                        ?TTEST_LIB:format_time(RunTime),
<a name="50472"/>50472:                                        if ((BCnt =:= 0) orelse (RunTime =:= 0)) -&gt;
<a name="50473"/>50473:                                                ?TTEST_LIB:format(&quot;~w, ~w&quot;,
<a name="50474"/>50474:                                                                  [BCnt, RunTime]);
<a name="50475"/>50475:                                           true -&gt;
<a name="50476"/>50476:                                                ?TTEST_LIB:format(&quot;~p =&gt; ~p byte / ms&quot;,
<a name="50477"/>50477:                                                                  [BCnt, BCnt div RunTime])
<a name="50478"/>50478:                                        end,
<a name="50479"/>50479:                                        if (RunTime =:= 0) -&gt;
<a name="50480"/>50480:                                                &quot;-&quot;;
<a name="50481"/>50481:                                           true -&gt;
<a name="50482"/>50482:                                                ?TTEST_LIB:format(&quot;~p =&gt; ~p iterations / ms&quot;,
<a name="50483"/>50483:                                                                  [Cnt, Cnt div RunTime])
<a name="50484"/>50484:                                        end
<a name="50485"/>50485:                                       ]),
<a name="50486"/>50486:                                    {ok, maps:remove(result, State)};
<a name="50487"/>50487: 
<a name="50488"/>50488:                                #{status  := Failure,
<a name="50489"/>50489:                                  runtime := RunTime,
<a name="50490"/>50490:                                  sid     := SID,
<a name="50491"/>50491:                                  rid     := RID,
<a name="50492"/>50492:                                  scnt    := SCnt,
<a name="50493"/>50493:                                  rcnt    := RCnt,
<a name="50494"/>50494:                                  bcnt    := BCnt,
<a name="50495"/>50495:                                  num     := Num} -&gt;
<a name="50496"/>50496:                                    ?SEV_EPRINT(&quot;Time Test failed: &quot;
<a name="50497"/>50497:                                                &quot;~n   ~p&quot;
<a name="50498"/>50498:                                                &quot;~n&quot;
<a name="50499"/>50499:                                                &quot;~nwhen&quot;
<a name="50500"/>50500:                                                &quot;~n&quot;
<a name="50501"/>50501:                                                &quot;~n   Run Time:       ~s&quot;
<a name="50502"/>50502:                                                &quot;~n   Send ID:        ~p&quot;
<a name="50503"/>50503:                                                &quot;~n   Recv ID:        ~p&quot;
<a name="50504"/>50504:                                                &quot;~n   Send Count:     ~p&quot;
<a name="50505"/>50505:                                                &quot;~n   Recv Count:     ~p&quot;
<a name="50506"/>50506:                                                &quot;~n   Byte Count:     ~p&quot;
<a name="50507"/>50507:                                                &quot;~n   Num Iterations: ~p&quot;,
<a name="50508"/>50508:                                                [Failure,
<a name="50509"/>50509:                                                 ?TTEST_LIB:format_time(RunTime),
<a name="50510"/>50510:                                                 SID, RID, SCnt, RCnt, BCnt, Num]),
<a name="50511"/>50511:                                    {error, Failure}
<a name="50512"/>50512:                            end
<a name="50513"/>50513:                    end},
<a name="50514"/>50514: 
<a name="50515"/>50515:          %% This is just so that the printout above shall have time to come
<a name="50516"/>50516:          %% out before then end of the test case.
<a name="50517"/>50517:          ?SEV_SLEEP(?SECS(1)),
<a name="50518"/>50518: 
<a name="50519"/>50519:          %% *** We are done ***
<a name="50520"/>50520:          ?SEV_FINISH_NORMAL
<a name="50521"/>50521:         ],
<a name="50522"/>50522: 
<a name="50523"/>50523:     Domain = maps:get(domain, InitState),
<a name="50524"/>50524:     LHost  = local_host(),
<a name="50525"/>50525:     LAddr  = which_local_addr(Domain),
<a name="50526"/>50526: 
<a name="50527"/>50527:     i(&quot;start server evaluator&quot;),
<a name="50528"/>50528:     ServerInitState = #{host   =&gt; LHost,
<a name="50529"/>50529: 			addr   =&gt; LAddr,
<a name="50530"/>50530:                         domain =&gt; Domain,
<a name="50531"/>50531:                         mod    =&gt; maps:get(server_mod,    InitState),
<a name="50532"/>50532:                         active =&gt; maps:get(server_active, InitState)},
<a name="50533"/>50533:     Server          = ?SEV_START(&quot;server&quot;, ServerSeq, ServerInitState),
<a name="50534"/>50534: 
<a name="50535"/>50535:     i(&quot;start client evaluator&quot;),
<a name="50536"/>50536:     ClientInitState = #{host            =&gt; LHost,
<a name="50537"/>50537: 			addr            =&gt; LAddr,
<a name="50538"/>50538:                         domain          =&gt; Domain,
<a name="50539"/>50539:                         mod             =&gt; maps:get(client_mod,      InitState),
<a name="50540"/>50540:                         active          =&gt; maps:get(client_active,   InitState),
<a name="50541"/>50541:                         msg_id          =&gt; maps:get(msg_id,          InitState),
<a name="50542"/>50542:                         max_outstanding =&gt; maps:get(max_outstanding, InitState),
<a name="50543"/>50543:                         runtime         =&gt; maps:get(runtime,         InitState)},
<a name="50544"/>50544:     Client          = ?SEV_START(&quot;client&quot;, ClientSeq, ClientInitState),
<a name="50545"/>50545:     
<a name="50546"/>50546:     i(&quot;start 'tester' evaluator&quot;),
<a name="50547"/>50547:     TesterInitState = #{domain        =&gt; Domain,
<a name="50548"/>50548: 			msg_id        =&gt; maps:get(msg_id,        InitState),
<a name="50549"/>50549:                         client        =&gt; Client#ev.pid,
<a name="50550"/>50550: 			client_mod    =&gt; maps:get(client_mod,    InitState),
<a name="50551"/>50551: 			client_active =&gt; maps:get(client_active, InitState),
<a name="50552"/>50552:                         server        =&gt; Server#ev.pid,
<a name="50553"/>50553:                         server_mod    =&gt; maps:get(server_mod,    InitState),
<a name="50554"/>50554:                         server_active =&gt; maps:get(server_active, InitState)},
<a name="50555"/>50555:     Tester = ?SEV_START(&quot;tester&quot;, TesterSeq, TesterInitState),
<a name="50556"/>50556: 
<a name="50557"/>50557:     i(&quot;await evaluator(s)&quot;),
<a name="ttest_tcp-last_expr"/><a name="50558"/>50558: <b>    ok = ?SEV_AWAIT_FINISH</b>([Server, Client, Tester]).
<a name="50559"/>50559: 
<a name="50560"/>50560: 
<a name="50561"/>50561: 
<a name="ttest_tcp_server_start-4"/><a name="50562"/>50562: <b>ttest_tcp_server_start</b>(Node, Domain, gen, Active) -&gt;
<a name="50563"/>50563:     TransportMod = socket_test_ttest_tcp_gen,
<a name="50564"/>50564:     Transport    = {TransportMod, #{domain =&gt; Domain}},
<a name="50565"/>50565:     socket_test_ttest_tcp_server:start_monitor(Node, Transport, Active);
<a name="50566"/>50566: <b>ttest_tcp_server_start</b>(Node, Domain, gs, Active) -&gt;
<a name="50567"/>50567:     TransportMod = socket_test_ttest_tcp_gs,
<a name="50568"/>50568:     Transport    = {TransportMod, #{domain =&gt; Domain}},
<a name="50569"/>50569:     socket_test_ttest_tcp_server:start_monitor(Node, Transport, Active);
<a name="50570"/>50570: <b>ttest_tcp_server_start</b>(Node, Domain, sock, Active) -&gt;
<a name="50571"/>50571:     TransportMod = socket_test_ttest_tcp_socket,
<a name="50572"/>50572:     Transport    = {TransportMod, #{domain =&gt; Domain,
<a name="50573"/>50573:                                     async  =&gt; true,
<a name="50574"/>50574:                                     method =&gt; plain}},
<a name="ttest_tcp_server_start-last_expr"/><a name="50575"/>50575: <b>    socket_test_ttest_tcp_server:start_monitor</b>(Node, Transport, Active).
<a name="50576"/>50576: 
<a name="ttest_tcp_server_stop-1"/><a name="50577"/>50577: <b>ttest_tcp_server_stop</b>(Pid) -&gt;
<a name="ttest_tcp_server_stop-last_expr"/><a name="50578"/>50578: <b>    socket_test_ttest_tcp_server:stop</b>(Pid).
<a name="50579"/>50579: 
<a name="ttest_tcp_client_start-9"/><a name="50580"/>50580: <b>ttest_tcp_client_start</b>(Node,
<a name="50581"/>50581:                        Notify,
<a name="50582"/>50582:                        Domain, gen,
<a name="50583"/>50583:                        ServerInfo, Active, MsgID, MaxOutstanding, RunTime) -&gt;
<a name="50584"/>50584:     TransportMod = socket_test_ttest_tcp_gen,
<a name="50585"/>50585:     Transport    = {TransportMod, #{domain =&gt; Domain}},    
<a name="50586"/>50586:     socket_test_ttest_tcp_client:start_monitor(Node,
<a name="50587"/>50587:                                                Notify,
<a name="50588"/>50588:                                                Transport,
<a name="50589"/>50589:                                                ServerInfo,
<a name="50590"/>50590:                                                Active,
<a name="50591"/>50591:                                                MsgID, MaxOutstanding, RunTime);
<a name="50592"/>50592: <b>ttest_tcp_client_start</b>(Node,
<a name="50593"/>50593:                        Notify,
<a name="50594"/>50594:                        Domain, gs,
<a name="50595"/>50595:                        ServerInfo, Active, MsgID, MaxOutstanding, RunTime) -&gt;
<a name="50596"/>50596:     TransportMod = socket_test_ttest_tcp_gs,
<a name="50597"/>50597:     Transport    = {TransportMod, #{domain =&gt; Domain}},    
<a name="50598"/>50598:     socket_test_ttest_tcp_client:start_monitor(Node,
<a name="50599"/>50599:                                                Notify,
<a name="50600"/>50600:                                                Transport,
<a name="50601"/>50601:                                                ServerInfo,
<a name="50602"/>50602:                                                Active,
<a name="50603"/>50603:                                                MsgID, MaxOutstanding, RunTime);
<a name="50604"/>50604: <b>ttest_tcp_client_start</b>(Node,
<a name="50605"/>50605:                        Notify,
<a name="50606"/>50606:                        Domain, sock,
<a name="50607"/>50607:                        ServerInfo, Active, MsgID, MaxOutstanding, RunTime) -&gt;
<a name="50608"/>50608:     TransportMod = socket_test_ttest_tcp_socket,
<a name="50609"/>50609:     Transport    = {TransportMod, #{domain =&gt; Domain,
<a name="50610"/>50610:                                     async  =&gt; true,
<a name="50611"/>50611:                                     method =&gt; plain}},
<a name="ttest_tcp_client_start-last_expr"/><a name="50612"/>50612: <b>    socket_test_ttest_tcp_client:start_monitor</b>(Node,
<a name="50613"/>50613:                                                Notify,
<a name="50614"/>50614:                                                Transport,
<a name="50615"/>50615:                                                ServerInfo,
<a name="50616"/>50616:                                                Active,
<a name="50617"/>50617:                                                MsgID, MaxOutstanding, RunTime).
<a name="50618"/>50618: 
<a name="50619"/>50619: 
<a name="50620"/>50620: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="50621"/>50621: 
<a name="50622"/>50622: <b>-define</b>(TTEST_MANAGER, esock_ttest_manager).
<a name="50623"/>50623: 
<a name="50624"/>50624: <b>-record</b>(ttest_report_id,
<a name="50625"/>50625:         {domain        :: socket:domain(),
<a name="50626"/>50626:          serv_trans    :: gen | sock,
<a name="50627"/>50627:          serv_active   :: once | boolean(),
<a name="50628"/>50628:          client_trans  :: gen | sock,
<a name="50629"/>50629:          client_active :: once | boolean(),
<a name="50630"/>50630:          msg_id        :: small | medium | large}).
<a name="50631"/>50631: 
<a name="50632"/>50632: <b>-record</b>(ttest_report, {id    :: #ttest_report_id{},
<a name="50633"/>50633:                        time  :: non_neg_integer(),
<a name="50634"/>50634:                        bytes :: non_neg_integer(),
<a name="50635"/>50635:                        msgs  :: non_neg_integer()}).
<a name="50636"/>50636: 
<a name="50637"/>50637: <b>-spec ttest_report</b>(Domain      :: socket:domain(),
<a name="50638"/>50638:                    ServTrans   :: gen | sock, ServActive   :: once | boolean(),
<a name="50639"/>50639:                    ClientTrans :: gen | sock, ClientActive :: once | boolean(),
<a name="50640"/>50640:                    MsgID       :: 1 | 2 | 3,
<a name="50641"/>50641:                    RunTime     :: non_neg_integer(),
<a name="50642"/>50642:                    NumBytes    :: non_neg_integer(),
<a name="50643"/>50643:                    NumMsgs     :: non_neg_integer()) -&gt; ok.
<a name="50644"/>50644: 
<a name="ttest_report-9"/><a name="50645"/>50645: <b>ttest_report</b>(Domain,
<a name="50646"/>50646:              ServTrans,   ServActive,
<a name="50647"/>50647:              ClientTrans, ClientActive,
<a name="50648"/>50648:              MsgID,
<a name="50649"/>50649:              RunTime,
<a name="50650"/>50650:              NumBytes,
<a name="50651"/>50651:              NumMsgs) -&gt;
<a name="50652"/>50652:     ID = #ttest_report_id{domain        = Domain,
<a name="50653"/>50653:                           serv_trans    = ServTrans,
<a name="50654"/>50654:                           serv_active   = ServActive,
<a name="50655"/>50655:                           client_trans  = ClientTrans,
<a name="50656"/>50656:                           client_active = ClientActive,
<a name="50657"/>50657:                           msg_id        = ttest_msg_id_num_to_name(MsgID)},
<a name="50658"/>50658:     Report = #ttest_report{id    = ID,
<a name="50659"/>50659:                            time  = RunTime,
<a name="50660"/>50660:                            bytes = NumBytes,
<a name="50661"/>50661:                            msgs  = NumMsgs},
<a name="50662"/>50662:     %% If we run just one test case, the group init has never been run
<a name="50663"/>50663:     %% and therefore the ttest manager is not running (we also don't actually
<a name="50664"/>50664:     %% care about collecting reports in that case).
<a name="50665"/>50665:     (catch global:send(?TTEST_MANAGER, Report)),
<a name="ttest_report-last_expr"/><a name="50666"/>50666:     ok.
<a name="50667"/>50667: 
<a name="ttest_msg_id_num_to_name-1"/><a name="50668"/>50668: <b>ttest_msg_id_num_to_name</b>(1) -&gt;
<a name="50669"/>50669:     small;
<a name="50670"/>50670: <b>ttest_msg_id_num_to_name</b>(2) -&gt;
<a name="50671"/>50671:     medium;
<a name="50672"/>50672: <b>ttest_msg_id_num_to_name</b>(3) -&gt;
<a name="ttest_msg_id_num_to_name-last_expr"/><a name="50673"/>50673:     large.
<a name="50674"/>50674:     
<a name="ttest_manager_start-0"/><a name="50675"/>50675: <b>ttest_manager_start</b>() -&gt;
<a name="50676"/>50676:     Self = self(),
<a name="50677"/>50677:     {Pid, MRef} = spawn_monitor(fun() -&gt; ttest_manager_init(Self) end),
<a name="ttest_manager_start-last_expr"/><a name="50678"/>50678:     receive
<a name="50679"/>50679:         {ttest_manager_started, Pid} -&gt;
<a name="50680"/>50680:             erlang:demonitor(MRef, [flush]),
<a name="50681"/>50681:             ok;
<a name="50682"/>50682:         {'DOWN', MRef, process, Pid, Reason} -&gt;
<a name="50683"/>50683:             exit({failed_starting, ttest_manager, Reason})
<a name="50684"/>50684:     after 5000 -&gt;
<a name="50685"/>50685:             exit(Pid, kill),
<a name="50686"/>50686:             exit({failed_starting, ttest_manager, timeout})
<a name="50687"/>50687:     end.
<a name="50688"/>50688: 
<a name="ttest_manager_stop-0"/><a name="50689"/>50689: <b>ttest_manager_stop</b>() -&gt;
<a name="ttest_manager_stop-last_expr"/><a name="50690"/>50690: <b>    case global:whereis_name</b>(?TTEST_MANAGER) of
<a name="50691"/>50691:         Pid when is_pid(Pid) -&gt;
<a name="50692"/>50692:             erlang:monitor(process, Pid),
<a name="50693"/>50693:             global:send(?TTEST_MANAGER, stop),
<a name="50694"/>50694:             receive
<a name="50695"/>50695:                 {'DOWN', _MRef, process, Pid, _} -&gt;
<a name="50696"/>50696:                     ok
<a name="50697"/>50697:             after 10000 -&gt;
<a name="50698"/>50698:                     exit(Pid, kill),
<a name="50699"/>50699:                     ok
<a name="50700"/>50700:             end;
<a name="50701"/>50701:         _ -&gt;
<a name="50702"/>50702:             ok
<a name="50703"/>50703:     end.
<a name="50704"/>50704: 
<a name="ttest_manager_init-1"/><a name="50705"/>50705: <b>ttest_manager_init</b>(Parent) -&gt;
<a name="50706"/>50706:     yes = global:register_name(?TTEST_MANAGER, self()),
<a name="50707"/>50707:     ets:new(?TTEST_MANAGER, 
<a name="50708"/>50708:             [{keypos, #ttest_report.id}, named_table, protected, ordered_set]),
<a name="50709"/>50709:     Parent ! {ttest_manager_started, self()},
<a name="ttest_manager_init-last_expr"/><a name="50710"/>50710: <b>    ttest_manager_loop</b>().
<a name="50711"/>50711: 
<a name="ttest_manager_loop-0"/><a name="50712"/>50712: <b>ttest_manager_loop</b>() -&gt;
<a name="ttest_manager_loop-last_expr"/><a name="50713"/>50713:     receive
<a name="50714"/>50714:         stop -&gt;
<a name="50715"/>50715:             ?LOGGER:format(&quot;manager stopping~n&quot;, []),
<a name="50716"/>50716:             ttest_manager_done();
<a name="50717"/>50717: 
<a name="50718"/>50718:         #ttest_report{id    = _ID,
<a name="50719"/>50719:                       time  = _RunTime,
<a name="50720"/>50720:                       bytes = _NumBytes,
<a name="50721"/>50721:                       msgs  = _NumMsgs} = Report -&gt;
<a name="50722"/>50722:             true = ets:insert_new(?TTEST_MANAGER, Report),
<a name="50723"/>50723:             ttest_manager_loop()
<a name="50724"/>50724:     end.
<a name="50725"/>50725: 
<a name="50726"/>50726: <i>%% We are supposed to pretty print the result here...</i>
<a name="ttest_manager_done-0"/><a name="50727"/>50727: <b>ttest_manager_done</b>() -&gt;
<a name="50728"/>50728:     format_reports(inet),
<a name="50729"/>50729:     %% format_reports(inet6),
<a name="50730"/>50730:     ets:delete(?TTEST_MANAGER),
<a name="ttest_manager_done-last_expr"/><a name="50731"/>50731: <b>    exit</b>(normal).
<a name="50732"/>50732: 
<a name="format_reports-1"/><a name="50733"/>50733: <b>format_reports</b>(Domain) -&gt;
<a name="50734"/>50734:     ?LOGGER:format(&quot;Domain ~w reports:~n~n&quot;, [Domain]),
<a name="50735"/>50735:     format_reports(Domain, small),
<a name="50736"/>50736:     format_reports(Domain, medium),
<a name="format_reports-last_expr"/><a name="50737"/>50737: <b>    format_reports</b>(Domain, large).
<a name="50738"/>50738:     
<a name="format_reports-2"/><a name="50739"/>50739: <b>format_reports</b>(Domain, MsgID) when is_atom(MsgID) -&gt;
<a name="format_reports-last_expr"/><a name="50740"/>50740: <b>    case which_ttest_reports</b>(Domain, MsgID) of
<a name="50741"/>50741:         [] -&gt;
<a name="50742"/>50742:             ?LOGGER:format(&quot;   No ~w reports~n~n&quot;, [MsgID]);
<a name="50743"/>50743:         Reports -&gt;
<a name="50744"/>50744:             ?LOGGER:format(&quot;   ~w reports: ~n&quot;, [MsgID]),
<a name="50745"/>50745:             lists:foreach(fun(R) -&gt; format_report(R) end, Reports)
<a name="50746"/>50746:     end.
<a name="50747"/>50747: 
<a name="50748"/>50748: <i>%% This should really be a table like this:</i>
<a name="50749"/>50749: <i>%%</i>
<a name="50750"/>50750: <i>%%             client</i>
<a name="50751"/>50751: <i>%% server      gen(false)  gen(once)  gen(true)  sock(false)  sock(once)  sock(true)</i>
<a name="50752"/>50752: <i>%% gen(false)  nnn</i>
<a name="50753"/>50753: <i>%% gen(once)   nnn</i>
<a name="50754"/>50754: <i>%% gen(true)   nnn</i>
<a name="50755"/>50755: <i>%% sock(false) nnn</i>
<a name="50756"/>50756: <i>%% sock(once)  nnn</i>
<a name="50757"/>50757: <i>%% sock(true)  nnn</i>
<a name="50758"/>50758: <i>%%</i>
<a name="format_report-1"/><a name="50759"/>50759: <b>format_report</b>(#ttest_report{id    = #ttest_report_id{serv_trans    = STrans,
<a name="50760"/>50760:                                                      serv_active   = SActive,
<a name="50761"/>50761:                                                      client_trans  = CTrans,
<a name="50762"/>50762:                                                      client_active = CActive},
<a name="50763"/>50763:                             time  = RunTime,
<a name="50764"/>50764:                             bytes = BCnt,
<a name="50765"/>50765:                             msgs  = MCnt}) -&gt;
<a name="50766"/>50766:     ?LOGGER:format(&quot;      server ~w[~w] - client ~w[~w] =&gt; &quot;
<a name="50767"/>50767:                    &quot;~n         Run Time: ~s&quot;
<a name="50768"/>50768:                    &quot;~n         Bytes:    ~s&quot;
<a name="50769"/>50769:                    &quot;~n         Messages: ~s&quot;
<a name="50770"/>50770:                    &quot;~n&quot;, [STrans, SActive, CTrans, CActive,
<a name="50771"/>50771:                           ?TTEST_LIB:format_time(RunTime),
<a name="50772"/>50772:                           if ((BCnt =:= 0) orelse (RunTime =:= 0)) -&gt;
<a name="50773"/>50773:                                   ?TTEST_LIB:format(&quot;~w, ~w&quot;,
<a name="50774"/>50774:                                                     [BCnt, RunTime]);
<a name="50775"/>50775:                              true -&gt;
<a name="50776"/>50776:                                   ?TTEST_LIB:format(&quot;~p =&gt; ~p byte / ms&quot;,
<a name="50777"/>50777:                                                     [BCnt, BCnt div RunTime])
<a name="50778"/>50778:                           end,
<a name="50779"/>50779:                           if (RunTime =:= 0) -&gt;
<a name="50780"/>50780:                                   &quot;-&quot;;
<a name="50781"/>50781:                              true -&gt;
<a name="50782"/>50782:                                   ?TTEST_LIB:format(&quot;~p =&gt; ~p iterations / ms&quot;,
<a name="50783"/>50783:                                                     [MCnt, MCnt div RunTime])
<a name="50784"/>50784:                           end]),
<a name="format_report-last_expr"/><a name="50785"/>50785:     ok.
<a name="50786"/>50786: 
<a name="50787"/>50787: 
<a name="which_ttest_reports-2"/><a name="50788"/>50788: <b>which_ttest_reports</b>(Domain, all) -&gt;
<a name="50789"/>50789:     [R || R = #ttest_report{id = #ttest_report_id{domain = D}} &lt;- 
<a name="50790"/>50790:               ets:tab2list(?TTEST_MANAGER), Domain =:= D];
<a name="50791"/>50791: <b>which_ttest_reports</b>(Domain, MsgID) -&gt;
<a name="which_ttest_reports-last_expr"/><a name="50792"/>50792:     [R || R = #ttest_report{id = #ttest_report_id{domain = D, msg_id = MID}} &lt;- 
<a name="50793"/>50793:               ets:tab2list(?TTEST_MANAGER), (Domain =:= D) andalso (MsgID =:= MID)].
<a name="50794"/>50794: 
<a name="50795"/>50795: 
<a name="50796"/>50796: 
<a name="50797"/>50797: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="50798"/>50798: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="50799"/>50799: <i>%%                                                                     %%</i>
<a name="50800"/>50800: <i>%%                            TICKETS                                  %%</i>
<a name="50801"/>50801: <i>%%                                                                     %%</i>
<a name="50802"/>50802: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="50803"/>50803: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="50804"/>50804: 
<a name="50805"/>50805: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="50806"/>50806: 
<a name="50807"/>50807: <i>%% Create several acceptor processes (processes that calls socket:accept/1)</i>
<a name="50808"/>50808: <i>%% and then a couple of clients connects to them without any problems.</i>
<a name="50809"/>50809: <i>%% TCP, IPv4.</i>
<a name="otp16359_maccept_tcp4-1"/><a name="50810"/>50810: <b>otp16359_maccept_tcp4</b>(_Config) when is_list(_Config) -&gt;
<a name="50811"/>50811:     ?TT(?SECS(10)),
<a name="otp16359_maccept_tcp4-last_expr"/><a name="50812"/>50812: <b>    tc_try</b>(otp16359_maccept_tcp4,
<a name="50813"/>50813:            fun() -&gt; has_support_ipv4() end,
<a name="50814"/>50814:            fun() -&gt;
<a name="50815"/>50815:                    InitState = #{domain   =&gt; inet,
<a name="50816"/>50816:                                  protocol =&gt; tcp},
<a name="50817"/>50817:                    ok = otp16359_maccept_tcp(InitState)
<a name="50818"/>50818:            end).
<a name="50819"/>50819: 
<a name="50820"/>50820: 
<a name="50821"/>50821: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="50822"/>50822: 
<a name="50823"/>50823: <i>%% Create several acceptor processes (processes that calls socket:accept/1)</i>
<a name="50824"/>50824: <i>%% and then a couple of clients connects to them without any problems.</i>
<a name="50825"/>50825: <i>%% TCP, IPv6.</i>
<a name="otp16359_maccept_tcp6-1"/><a name="50826"/>50826: <b>otp16359_maccept_tcp6</b>(_Config) when is_list(_Config) -&gt;
<a name="50827"/>50827:     ?TT(?SECS(10)),
<a name="otp16359_maccept_tcp6-last_expr"/><a name="50828"/>50828: <b>    tc_try</b>(otp16359_maccept_tcp6,
<a name="50829"/>50829:            fun() -&gt; has_support_ipv6() end,
<a name="50830"/>50830:            fun() -&gt;
<a name="50831"/>50831:                    InitState = #{domain   =&gt; inet6,
<a name="50832"/>50832:                                  protocol =&gt; tcp},
<a name="50833"/>50833:                    ok = otp16359_maccept_tcp(InitState)
<a name="50834"/>50834:            end).
<a name="50835"/>50835: 
<a name="50836"/>50836: 
<a name="50837"/>50837: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="50838"/>50838: 
<a name="50839"/>50839: <i>%% Create several acceptor processes (processes that calls socket:accept/1)</i>
<a name="50840"/>50840: <i>%% and then a couple of clients connects to them without any problems.</i>
<a name="50841"/>50841: <i>%% TCP, UNix Domain Sockets.</i>
<a name="otp16359_maccept_tcpL-1"/><a name="50842"/>50842: <b>otp16359_maccept_tcpL</b>(_Config) when is_list(_Config) -&gt;
<a name="50843"/>50843:     ?TT(?SECS(10)),
<a name="otp16359_maccept_tcpL-last_expr"/><a name="50844"/>50844: <b>    tc_try</b>(otp16359_maccept_tcpL,
<a name="50845"/>50845:            fun() -&gt; has_support_unix_domain_socket() end,
<a name="50846"/>50846:            fun() -&gt;
<a name="50847"/>50847:                    InitState = #{domain   =&gt; local,
<a name="50848"/>50848:                                  protocol =&gt; default},
<a name="50849"/>50849:                    ok = otp16359_maccept_tcp(InitState)
<a name="50850"/>50850:            end).
<a name="50851"/>50851: 
<a name="50852"/>50852: 
<a name="50853"/>50853: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="50854"/>50854: 
<a name="otp16359_maccept_tcp-1"/><a name="50855"/>50855: <b>otp16359_maccept_tcp</b>(InitState) -&gt;
<a name="50856"/>50856:     PrimAcceptorSeq =
<a name="50857"/>50857:         [
<a name="50858"/>50858:          %% *** Init part ***
<a name="50859"/>50859:          #{desc =&gt; &quot;await start&quot;,
<a name="50860"/>50860:            cmd  =&gt; fun(State) -&gt;
<a name="50861"/>50861:                            Tester = ?SEV_AWAIT_START(),
<a name="50862"/>50862:                            {ok, State#{tester =&gt; Tester}}
<a name="50863"/>50863:                    end},
<a name="50864"/>50864:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="50865"/>50865:            cmd  =&gt; fun(#{tester := Pid} = _State) -&gt;
<a name="50866"/>50866:                            _MRef = erlang:monitor(process, Pid),
<a name="50867"/>50867:                            ok
<a name="50868"/>50868:                    end},
<a name="50869"/>50869:          #{desc =&gt; &quot;which local address&quot;,
<a name="50870"/>50870:            cmd  =&gt; fun(#{domain := Domain} = State) -&gt;
<a name="50871"/>50871:                            LSA = which_local_socket_addr(Domain),
<a name="50872"/>50872:                            ?SEV_IPRINT(&quot;LSA: ~p&quot;, [LSA]),
<a name="50873"/>50873:                            {ok, State#{lsa =&gt; LSA}}
<a name="50874"/>50874:                    end},
<a name="50875"/>50875:          #{desc =&gt; &quot;create (listen) socket&quot;,
<a name="50876"/>50876:            cmd  =&gt; fun(#{domain   := Domain,
<a name="50877"/>50877:                          protocol := Proto} = State) -&gt;
<a name="50878"/>50878:                            case socket:open(Domain, stream, Proto) of
<a name="50879"/>50879:                                {ok, Sock} -&gt;
<a name="50880"/>50880:                                    {ok, State#{lsock =&gt; Sock}};
<a name="50881"/>50881:                                {error, _} = ERROR -&gt;
<a name="50882"/>50882:                                    ERROR
<a name="50883"/>50883:                            end
<a name="50884"/>50884:                    end},
<a name="50885"/>50885:          #{desc =&gt; &quot;bind to local address&quot;,
<a name="50886"/>50886:            cmd  =&gt; fun(#{domain := local,
<a name="50887"/>50887:                          lsock  := LSock,
<a name="50888"/>50888:                          lsa    := LSA} = _State) -&gt;
<a name="50889"/>50889:                            case socket:bind(LSock, LSA) of
<a name="50890"/>50890:                                ok -&gt;
<a name="50891"/>50891:                                    ok; % We do not care about the port for local
<a name="50892"/>50892:                                {error, _} = ERROR -&gt;
<a name="50893"/>50893:                                    ERROR
<a name="50894"/>50894:                            end;
<a name="50895"/>50895:                       (#{lsock := LSock, lsa := LSA} = State) -&gt;
<a name="50896"/>50896:                            case sock_bind(LSock, LSA) of
<a name="50897"/>50897:                                ok -&gt;
<a name="50898"/>50898:                                    Port = sock_port(LSock),
<a name="50899"/>50899:                                    {ok, State#{lport =&gt; Port}};
<a name="50900"/>50900:                                {error, _} = ERROR -&gt;
<a name="50901"/>50901:                                    ERROR
<a name="50902"/>50902:                            end
<a name="50903"/>50903:                    end},
<a name="50904"/>50904:          #{desc =&gt; &quot;make listen socket&quot;,
<a name="50905"/>50905:            cmd  =&gt; fun(#{lsock := LSock}) -&gt;
<a name="50906"/>50906:                            socket:listen(LSock)
<a name="50907"/>50907:                    end},
<a name="50908"/>50908:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="50909"/>50909:            cmd  =&gt; fun(#{domain := local,
<a name="50910"/>50910:                          tester := Tester,
<a name="50911"/>50911:                          lsock  := LSock,
<a name="50912"/>50912:                          lsa    := #{path := Path}}) -&gt;
<a name="50913"/>50913:                            ?SEV_ANNOUNCE_READY(Tester, init, {LSock, Path}),
<a name="50914"/>50914:                            ok;
<a name="50915"/>50915:                       (#{lsock := LSock, lport := LPort, tester := Tester}) -&gt;
<a name="50916"/>50916:                            ?SEV_ANNOUNCE_READY(Tester, init, {LSock, LPort}),
<a name="50917"/>50917:                            ok
<a name="50918"/>50918:                    end},
<a name="50919"/>50919: 
<a name="50920"/>50920:          %% *** The actual test ***
<a name="50921"/>50921:          #{desc =&gt; &quot;await continue (accept)&quot;,
<a name="50922"/>50922:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="50923"/>50923:                            ?SEV_AWAIT_CONTINUE(Tester, tester, accept)
<a name="50924"/>50924:                    end},
<a name="50925"/>50925:          #{desc =&gt; &quot;attempt to accept (with success)&quot;,
<a name="50926"/>50926:            cmd  =&gt; fun(#{lsock := LSock} = State) -&gt;
<a name="50927"/>50927:                            case socket:accept(LSock) of
<a name="50928"/>50928:                                {ok, Sock} -&gt;
<a name="50929"/>50929:                                    ?SEV_IPRINT(&quot;Expected (accept) success: &quot;
<a name="50930"/>50930:                                                &quot;~n   ~p&quot;, [Sock]),
<a name="50931"/>50931:                                    {ok, State#{sock =&gt; Sock}};
<a name="50932"/>50932:                                {error, _} = ERROR -&gt;
<a name="50933"/>50933:                                    ERROR
<a name="50934"/>50934:                            end
<a name="50935"/>50935:                    end},
<a name="50936"/>50936:          #{desc =&gt; &quot;announce ready (accept)&quot;,
<a name="50937"/>50937:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="50938"/>50938:                            ?SEV_ANNOUNCE_READY(Tester, accept),
<a name="50939"/>50939:                            ok
<a name="50940"/>50940:                    end},
<a name="50941"/>50941: 
<a name="50942"/>50942:          %% *** Terminate ***
<a name="50943"/>50943:          #{desc =&gt; &quot;await terminate&quot;,
<a name="50944"/>50944:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="50945"/>50945:                            ?SEV_AWAIT_TERMINATE(Tester, tester),
<a name="50946"/>50946:                            ok
<a name="50947"/>50947:                    end},
<a name="50948"/>50948:          %% *** Close (connect) socket ***
<a name="50949"/>50949:          #{desc =&gt; &quot;close (connect) socket&quot;,
<a name="50950"/>50950:            cmd  =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="50951"/>50951:                            sock_close(Sock),
<a name="50952"/>50952:                            {ok, maps:remove(sock, State)}
<a name="50953"/>50953:                    end},
<a name="50954"/>50954:          %% *** Close (listen) socket ***
<a name="50955"/>50955:          #{desc =&gt; &quot;close (listen) socket&quot;,
<a name="50956"/>50956:            cmd  =&gt; fun(#{domain := local,
<a name="50957"/>50957:                          lsock  := Sock,
<a name="50958"/>50958:                          lsa    := #{path := Path}} = State) -&gt;
<a name="50959"/>50959:                            ok = socket:close(Sock),
<a name="50960"/>50960:                            State1 =
<a name="50961"/>50961:                                unlink_path(Path,
<a name="50962"/>50962:                                            fun() -&gt;
<a name="50963"/>50963:                                                    maps:remove(lsa, State)
<a name="50964"/>50964:                                            end,
<a name="50965"/>50965:                                            fun() -&gt; State end),
<a name="50966"/>50966:                            {ok, maps:remove(lsock, State1)};
<a name="50967"/>50967:                       (#{lsock := LSock} = State) -&gt;
<a name="50968"/>50968:                            sock_close(LSock),
<a name="50969"/>50969:                            {ok, maps:remove(lsock, State)}
<a name="50970"/>50970:                    end},
<a name="50971"/>50971: 
<a name="50972"/>50972:          %% *** We are done ***
<a name="50973"/>50973:          ?SEV_FINISH_NORMAL
<a name="50974"/>50974:         ],
<a name="50975"/>50975: 
<a name="50976"/>50976:     SecAcceptorSeq =
<a name="50977"/>50977:         [
<a name="50978"/>50978:          %% *** Init part ***
<a name="50979"/>50979:          #{desc =&gt; &quot;await start&quot;,
<a name="50980"/>50980:            cmd  =&gt; fun(State) -&gt;
<a name="50981"/>50981:                            {Tester, LSock} = ?SEV_AWAIT_START(),
<a name="50982"/>50982:                            {ok, State#{tester =&gt; Tester,
<a name="50983"/>50983:                                        lsock  =&gt; LSock}}
<a name="50984"/>50984:                            
<a name="50985"/>50985:                    end},
<a name="50986"/>50986:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="50987"/>50987:            cmd  =&gt; fun(#{tester := Pid} = _State) -&gt;
<a name="50988"/>50988:                            _MRef = erlang:monitor(process, Pid),
<a name="50989"/>50989:                            ok
<a name="50990"/>50990:                    end},
<a name="50991"/>50991:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="50992"/>50992:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="50993"/>50993:                            ?SEV_ANNOUNCE_READY(Tester, init),
<a name="50994"/>50994:                            ok
<a name="50995"/>50995:                    end},
<a name="50996"/>50996: 
<a name="50997"/>50997:          %% *** The actual test part ***
<a name="50998"/>50998:          #{desc =&gt; &quot;await continue (accept)&quot;,
<a name="50999"/>50999:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="51000"/>51000:                            ?SEV_AWAIT_CONTINUE(Tester, tester, accept)
<a name="51001"/>51001:                    end},
<a name="51002"/>51002:          #{desc =&gt; &quot;attempt to accept&quot;,
<a name="51003"/>51003:            cmd  =&gt; fun(#{lsock := LSock} = State) -&gt;
<a name="51004"/>51004:                            case socket:accept(LSock) of
<a name="51005"/>51005:                                {ok, Sock} -&gt;
<a name="51006"/>51006:                                    ?SEV_IPRINT(&quot;Expected (accept) success: &quot;
<a name="51007"/>51007:                                                &quot;~n   ~p&quot;, [Sock]),
<a name="51008"/>51008:                                    {ok, State#{sock =&gt; Sock}};
<a name="51009"/>51009:                                {error, _} = ERROR -&gt;
<a name="51010"/>51010:                                    ERROR
<a name="51011"/>51011:                            end
<a name="51012"/>51012:                    end},
<a name="51013"/>51013:          #{desc =&gt; &quot;announce ready (accept)&quot;,
<a name="51014"/>51014:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="51015"/>51015:                            ?SEV_ANNOUNCE_READY(Tester, accept),
<a name="51016"/>51016:                            ok
<a name="51017"/>51017:                    end},
<a name="51018"/>51018: 
<a name="51019"/>51019:          %% *** Terminate ***
<a name="51020"/>51020:          #{desc =&gt; &quot;await terminate&quot;,
<a name="51021"/>51021:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="51022"/>51022:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="51023"/>51023:                                ok -&gt;
<a name="51024"/>51024:                                    {ok, maps:remove(tester, State)};
<a name="51025"/>51025:                                {error, _} = ERROR -&gt;
<a name="51026"/>51026:                                    ERROR
<a name="51027"/>51027:                            end
<a name="51028"/>51028:                    end},
<a name="51029"/>51029:          %% *** Close (connect) socket ***
<a name="51030"/>51030:          #{desc =&gt; &quot;close (connect) socket&quot;,
<a name="51031"/>51031:            cmd  =&gt; fun(#{sock := Sock} = State) -&gt;
<a name="51032"/>51032:                            sock_close(Sock),
<a name="51033"/>51033:                            {ok, maps:remove(sock, State)}
<a name="51034"/>51034:                    end},
<a name="51035"/>51035: 
<a name="51036"/>51036:          %% *** We are done ***
<a name="51037"/>51037:          ?SEV_FINISH_NORMAL
<a name="51038"/>51038:         ],
<a name="51039"/>51039: 
<a name="51040"/>51040:     ClientSeq =
<a name="51041"/>51041:         [
<a name="51042"/>51042:          %% *** Wait for start order ***
<a name="51043"/>51043:          #{desc =&gt; &quot;await start (from tester)&quot;,
<a name="51044"/>51044:            cmd  =&gt; fun(#{domain := local} = State) -&gt;
<a name="51045"/>51045:                            {Tester, Path} = ?SEV_AWAIT_START(),
<a name="51046"/>51046:                            {ok, State#{tester =&gt; Tester, server_path =&gt; Path}};
<a name="51047"/>51047:                       (State) -&gt;
<a name="51048"/>51048:                            {Tester, Port} = ?SEV_AWAIT_START(),
<a name="51049"/>51049:                            {ok, State#{tester =&gt; Tester, server_port =&gt; Port}}
<a name="51050"/>51050:                    end},
<a name="51051"/>51051:          #{desc =&gt; &quot;monitor tester&quot;,
<a name="51052"/>51052:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="51053"/>51053:                            _MRef = erlang:monitor(process, Tester),
<a name="51054"/>51054:                            ok
<a name="51055"/>51055:                    end},
<a name="51056"/>51056: 
<a name="51057"/>51057:          %% *** The init part ***
<a name="51058"/>51058:          #{desc =&gt; &quot;which server (local) address&quot;,
<a name="51059"/>51059:            cmd  =&gt; fun(#{domain      := local = Domain,
<a name="51060"/>51060:                          server_path := Path} = State) -&gt;
<a name="51061"/>51061:                            LSA = which_local_socket_addr(Domain),
<a name="51062"/>51062:                            SSA = #{family =&gt; Domain, path =&gt; Path},
<a name="51063"/>51063:                            {ok, State#{lsa =&gt; LSA, server_sa =&gt; SSA}};
<a name="51064"/>51064:                       (#{domain := Domain, server_port := Port} = State) -&gt;
<a name="51065"/>51065:                            LSA = which_local_socket_addr(Domain),
<a name="51066"/>51066:                            SSA = LSA#{port =&gt; Port},
<a name="51067"/>51067:                            {ok, State#{lsa =&gt; LSA, server_sa =&gt; SSA}}
<a name="51068"/>51068:                    end},
<a name="51069"/>51069:          #{desc =&gt; &quot;create socket&quot;,
<a name="51070"/>51070:            cmd  =&gt; fun(#{domain   := Domain,
<a name="51071"/>51071:                          protocol := Proto} = State) -&gt;
<a name="51072"/>51072:                            case socket:open(Domain, stream, Proto) of
<a name="51073"/>51073:                                {ok, Sock} -&gt;
<a name="51074"/>51074:                                    {ok, State#{sock =&gt; Sock}};
<a name="51075"/>51075:                                {error, _} = ERROR -&gt;
<a name="51076"/>51076:                                    ERROR
<a name="51077"/>51077:                            end
<a name="51078"/>51078:                    end},
<a name="51079"/>51079:          #{desc =&gt; &quot;bind to local address&quot;,
<a name="51080"/>51080:            cmd  =&gt; fun(#{sock := Sock, lsa := LSA} = _State) -&gt;
<a name="51081"/>51081:                            case sock_bind(Sock, LSA) of
<a name="51082"/>51082:                                ok -&gt;
<a name="51083"/>51083:                                    ok;
<a name="51084"/>51084:                                {error, _} = ERROR -&gt;
<a name="51085"/>51085:                                    ERROR
<a name="51086"/>51086:                            end
<a name="51087"/>51087:                    end},
<a name="51088"/>51088:          #{desc =&gt; &quot;announce ready (init)&quot;,
<a name="51089"/>51089:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="51090"/>51090:                            ?SEV_ANNOUNCE_READY(Tester, init),
<a name="51091"/>51091:                            ok
<a name="51092"/>51092:                    end},
<a name="51093"/>51093: 
<a name="51094"/>51094:          %% *** The actual test ***
<a name="51095"/>51095:          #{desc =&gt; &quot;await continue (connect)&quot;,
<a name="51096"/>51096:            cmd  =&gt; fun(#{tester := Tester} = _State) -&gt;
<a name="51097"/>51097:                            ?SEV_AWAIT_CONTINUE(Tester, tester, connect)
<a name="51098"/>51098:                    end},
<a name="51099"/>51099:          #{desc =&gt; &quot;connect to server&quot;,
<a name="51100"/>51100:            cmd  =&gt; fun(#{sock := Sock, server_sa := SSA}) -&gt;
<a name="51101"/>51101:                            case socket:connect(Sock, SSA) of
<a name="51102"/>51102:                                ok -&gt;
<a name="51103"/>51103:                                    ?SEV_IPRINT(&quot;connected&quot;, []),
<a name="51104"/>51104:                                    ok;
<a name="51105"/>51105:                                {error, Reason} = ERROR -&gt;
<a name="51106"/>51106:                                    ?SEV_EPRINT(&quot;failed connect: &quot;
<a name="51107"/>51107:                                                &quot;~n   ~p&quot;, [Reason]),
<a name="51108"/>51108:                                    ERROR
<a name="51109"/>51109:                            end
<a name="51110"/>51110:                    end},
<a name="51111"/>51111:          #{desc =&gt; &quot;announce ready (connect)&quot;,
<a name="51112"/>51112:            cmd  =&gt; fun(#{tester := Tester}) -&gt;
<a name="51113"/>51113:                            ?SEV_ANNOUNCE_READY(Tester, connect),
<a name="51114"/>51114:                            ok
<a name="51115"/>51115:                    end},
<a name="51116"/>51116: 
<a name="51117"/>51117:          %% *** Termination ***
<a name="51118"/>51118:          #{desc =&gt; &quot;await terminate&quot;,
<a name="51119"/>51119:            cmd  =&gt; fun(#{tester := Tester} = State) -&gt;
<a name="51120"/>51120:                            case ?SEV_AWAIT_TERMINATE(Tester, tester) of
<a name="51121"/>51121:                                ok -&gt;
<a name="51122"/>51122:                                    {ok, maps:remove(tester, State)};
<a name="51123"/>51123:                                {error, _} = ERROR -&gt;
<a name="51124"/>51124:                                    ERROR
<a name="51125"/>51125:                            end
<a name="51126"/>51126:                    end},
<a name="51127"/>51127:          #{desc =&gt; &quot;close socket&quot;,
<a name="51128"/>51128:            cmd  =&gt; fun(#{domain := local,
<a name="51129"/>51129:                          sock   := Sock,
<a name="51130"/>51130:                          lsa    := #{path := Path}} = State) -&gt;
<a name="51131"/>51131:                            ok = socket:close(Sock),
<a name="51132"/>51132:                            State1 =
<a name="51133"/>51133:                                unlink_path(Path,
<a name="51134"/>51134:                                            fun() -&gt;
<a name="51135"/>51135:                                                    maps:remove(lsa, State)
<a name="51136"/>51136:                                            end,
<a name="51137"/>51137:                                            fun() -&gt; State end),
<a name="51138"/>51138:                            {ok, maps:remove(sock, State1)};
<a name="51139"/>51139:                       (#{sock := Sock} = State) -&gt;
<a name="51140"/>51140:                            ok = socket:close(Sock),
<a name="51141"/>51141:                            {ok, maps:remove(sock, State)}
<a name="51142"/>51142:                    end},
<a name="51143"/>51143: 
<a name="51144"/>51144:          %% *** We are done ***
<a name="51145"/>51145:          ?SEV_FINISH_NORMAL
<a name="51146"/>51146:         ],
<a name="51147"/>51147: 
<a name="51148"/>51148:     TesterSeq =
<a name="51149"/>51149:         [
<a name="51150"/>51150:          %% Init part
<a name="51151"/>51151:          #{desc =&gt; &quot;monitor prim-acceptor&quot;,
<a name="51152"/>51152:            cmd  =&gt; fun(#{prim_acceptor := Pid} = _State) -&gt;
<a name="51153"/>51153:                            _MRef = erlang:monitor(process, Pid),
<a name="51154"/>51154:                            ok
<a name="51155"/>51155:                    end},
<a name="51156"/>51156:          #{desc =&gt; &quot;monitor sec-acceptor 1&quot;,
<a name="51157"/>51157:            cmd  =&gt; fun(#{sec_acceptor1 := Pid} = _State) -&gt;
<a name="51158"/>51158:                            _MRef = erlang:monitor(process, Pid),
<a name="51159"/>51159:                            ok
<a name="51160"/>51160:                    end},
<a name="51161"/>51161:          #{desc =&gt; &quot;monitor sec-acceptor 2&quot;,
<a name="51162"/>51162:            cmd  =&gt; fun(#{sec_acceptor2 := Pid} = _State) -&gt;
<a name="51163"/>51163:                            _MRef = erlang:monitor(process, Pid),
<a name="51164"/>51164:                            ok
<a name="51165"/>51165:                    end},
<a name="51166"/>51166:          #{desc =&gt; &quot;monitor client 1&quot;,
<a name="51167"/>51167:            cmd  =&gt; fun(#{client1 := Pid} = _State) -&gt;
<a name="51168"/>51168:                            _MRef = erlang:monitor(process, Pid),
<a name="51169"/>51169:                            ok
<a name="51170"/>51170:                    end},
<a name="51171"/>51171:          #{desc =&gt; &quot;monitor client 2&quot;,
<a name="51172"/>51172:            cmd  =&gt; fun(#{client2 := Pid} = _State) -&gt;
<a name="51173"/>51173:                            _MRef = erlang:monitor(process, Pid),
<a name="51174"/>51174:                            ok
<a name="51175"/>51175:                    end},
<a name="51176"/>51176:          #{desc =&gt; &quot;monitor client 3&quot;,
<a name="51177"/>51177:            cmd  =&gt; fun(#{client3 := Pid} = _State) -&gt;
<a name="51178"/>51178:                            _MRef = erlang:monitor(process, Pid),
<a name="51179"/>51179:                            ok
<a name="51180"/>51180:                    end},
<a name="51181"/>51181: 
<a name="51182"/>51182: 
<a name="51183"/>51183:          %% Start the prim-acceptor
<a name="51184"/>51184:          #{desc =&gt; &quot;start prim-acceptor&quot;,
<a name="51185"/>51185:            cmd  =&gt; fun(#{prim_acceptor := Pid} = _State) -&gt;
<a name="51186"/>51186:                            ?SEV_ANNOUNCE_START(Pid),
<a name="51187"/>51187:                            ok
<a name="51188"/>51188:                    end},
<a name="51189"/>51189:          #{desc =&gt; &quot;await prim-acceptor ready (init)&quot;,
<a name="51190"/>51190:            cmd  =&gt; fun(#{prim_acceptor := Pid} = State) -&gt;
<a name="51191"/>51191:                            {ok, {Sock, Port}} =
<a name="51192"/>51192:                                ?SEV_AWAIT_READY(Pid, prim_acceptor, init),
<a name="51193"/>51193:                            {ok, State#{lsock =&gt; Sock, lport =&gt; Port}}
<a name="51194"/>51194:                    end},
<a name="51195"/>51195: 
<a name="51196"/>51196:          %% Start sec-acceptor-1
<a name="51197"/>51197:          #{desc =&gt; &quot;start sec-acceptor 1&quot;,
<a name="51198"/>51198:            cmd  =&gt; fun(#{sec_acceptor1 := Pid, lsock := LSock} = _State) -&gt;
<a name="51199"/>51199:                            ?SEV_ANNOUNCE_START(Pid, LSock),
<a name="51200"/>51200:                            ok
<a name="51201"/>51201:                    end},
<a name="51202"/>51202:          #{desc =&gt; &quot;await sec-acceptor 1 ready (init)&quot;,
<a name="51203"/>51203:            cmd  =&gt; fun(#{sec_acceptor1 := Pid} = _State) -&gt;
<a name="51204"/>51204:                            ?SEV_AWAIT_READY(Pid, sec_acceptor1, init)
<a name="51205"/>51205:                    end},
<a name="51206"/>51206: 
<a name="51207"/>51207:          %% Start sec-acceptor-2
<a name="51208"/>51208:          #{desc =&gt; &quot;start sec-acceptor 2&quot;,
<a name="51209"/>51209:            cmd  =&gt; fun(#{sec_acceptor2 := Pid, lsock := LSock} = _State) -&gt;
<a name="51210"/>51210:                            ?SEV_ANNOUNCE_START(Pid, LSock),
<a name="51211"/>51211:                            ok
<a name="51212"/>51212:                    end},
<a name="51213"/>51213:          #{desc =&gt; &quot;await sec-acceptor 2 ready (init)&quot;,
<a name="51214"/>51214:            cmd  =&gt; fun(#{sec_acceptor2 := Pid} = _State) -&gt;
<a name="51215"/>51215:                            ?SEV_AWAIT_READY(Pid, sec_acceptor2, init)
<a name="51216"/>51216:                    end},
<a name="51217"/>51217: 
<a name="51218"/>51218:          %% Start client-1
<a name="51219"/>51219:          #{desc =&gt; &quot;start client 1&quot;,
<a name="51220"/>51220:            cmd  =&gt; fun(#{client1 := Pid, lport := LPort} = _State) -&gt;
<a name="51221"/>51221:                            ?SEV_ANNOUNCE_START(Pid, LPort),
<a name="51222"/>51222:                            ok
<a name="51223"/>51223:                    end},
<a name="51224"/>51224:          #{desc =&gt; &quot;await client 1 ready (init)&quot;,
<a name="51225"/>51225:            cmd  =&gt; fun(#{client1 := Pid} = _State) -&gt;
<a name="51226"/>51226:                            ?SEV_AWAIT_READY(Pid, client1, init)
<a name="51227"/>51227:                    end},
<a name="51228"/>51228: 
<a name="51229"/>51229:          %% Start client-2
<a name="51230"/>51230:          #{desc =&gt; &quot;start client 2&quot;,
<a name="51231"/>51231:            cmd  =&gt; fun(#{client2 := Pid, lport := LPort} = _State) -&gt;
<a name="51232"/>51232:                            ?SEV_ANNOUNCE_START(Pid, LPort),
<a name="51233"/>51233:                            ok
<a name="51234"/>51234:                    end},
<a name="51235"/>51235:          #{desc =&gt; &quot;await client 2 ready (init)&quot;,
<a name="51236"/>51236:            cmd  =&gt; fun(#{client2 := Pid} = _State) -&gt;
<a name="51237"/>51237:                            ?SEV_AWAIT_READY(Pid, client2, init)
<a name="51238"/>51238:                    end},
<a name="51239"/>51239: 
<a name="51240"/>51240:          %% Start client-3
<a name="51241"/>51241:          #{desc =&gt; &quot;start client 3&quot;,
<a name="51242"/>51242:            cmd  =&gt; fun(#{client3 := Pid, lport := LPort} = _State) -&gt;
<a name="51243"/>51243:                            ?SEV_ANNOUNCE_START(Pid, LPort),
<a name="51244"/>51244:                            ok
<a name="51245"/>51245:                    end},
<a name="51246"/>51246:          #{desc =&gt; &quot;await client 3 ready (init)&quot;,
<a name="51247"/>51247:            cmd  =&gt; fun(#{client3 := Pid} = _State) -&gt;
<a name="51248"/>51248:                            ?SEV_AWAIT_READY(Pid, client3, init)
<a name="51249"/>51249:                    end},
<a name="51250"/>51250: 
<a name="51251"/>51251:          %% Activate the acceptor(s)
<a name="51252"/>51252:          #{desc =&gt; &quot;active prim-acceptor&quot;,
<a name="51253"/>51253:            cmd  =&gt; fun(#{prim_acceptor := Pid} = _State) -&gt;
<a name="51254"/>51254:                            ?SEV_ANNOUNCE_CONTINUE(Pid, accept),
<a name="51255"/>51255:                            ok
<a name="51256"/>51256:                    end},
<a name="51257"/>51257:          #{desc =&gt; &quot;active sec-acceptor 1&quot;,
<a name="51258"/>51258:            cmd  =&gt; fun(#{sec_acceptor1 := Pid} = _State) -&gt;
<a name="51259"/>51259:                            ?SEV_ANNOUNCE_CONTINUE(Pid, accept),
<a name="51260"/>51260:                            ok
<a name="51261"/>51261:                    end},
<a name="51262"/>51262:          #{desc =&gt; &quot;active sec-acceptor 2&quot;,
<a name="51263"/>51263:            cmd  =&gt; fun(#{sec_acceptor2 := Pid} = _State) -&gt;
<a name="51264"/>51264:                            ?SEV_ANNOUNCE_CONTINUE(Pid, accept),
<a name="51265"/>51265:                            ok
<a name="51266"/>51266:                    end},
<a name="51267"/>51267: 
<a name="51268"/>51268:          ?SEV_SLEEP(?SECS(1)),
<a name="51269"/>51269: 
<a name="51270"/>51270:          %% Activate the client(s)
<a name="51271"/>51271:          #{desc =&gt; &quot;active client 1&quot;,
<a name="51272"/>51272:            cmd  =&gt; fun(#{client1 := Pid} = _State) -&gt;
<a name="51273"/>51273:                            ?SEV_ANNOUNCE_CONTINUE(Pid, connect),
<a name="51274"/>51274:                            ok
<a name="51275"/>51275:                    end},
<a name="51276"/>51276: 
<a name="51277"/>51277:          ?SEV_SLEEP(100),
<a name="51278"/>51278: 
<a name="51279"/>51279:          #{desc =&gt; &quot;active client 2&quot;,
<a name="51280"/>51280:            cmd  =&gt; fun(#{client2 := Pid} = _State) -&gt;
<a name="51281"/>51281:                            ?SEV_ANNOUNCE_CONTINUE(Pid, connect),
<a name="51282"/>51282:                            ok
<a name="51283"/>51283:                    end},
<a name="51284"/>51284: 
<a name="51285"/>51285:          ?SEV_SLEEP(100),
<a name="51286"/>51286: 
<a name="51287"/>51287:          #{desc =&gt; &quot;active client 3&quot;,
<a name="51288"/>51288:            cmd  =&gt; fun(#{client3 := Pid} = _State) -&gt;
<a name="51289"/>51289:                            ?SEV_ANNOUNCE_CONTINUE(Pid, connect),
<a name="51290"/>51290:                            ok
<a name="51291"/>51291:                    end},
<a name="51292"/>51292: 
<a name="51293"/>51293:          %% Await acceptor(s) completions
<a name="51294"/>51294:          #{desc =&gt; &quot;await prim-acceptor ready (accept)&quot;,
<a name="51295"/>51295:            cmd  =&gt; fun(#{prim_acceptor := Pid} = _State) -&gt;
<a name="51296"/>51296:                            ?SEV_AWAIT_READY(Pid, prim_acceptor, accept)
<a name="51297"/>51297:                    end},
<a name="51298"/>51298:          #{desc =&gt; &quot;await sec-acceptor 1 ready (accept)&quot;,
<a name="51299"/>51299:            cmd  =&gt; fun(#{sec_acceptor1 := Pid} = _State) -&gt;
<a name="51300"/>51300:                            ?SEV_AWAIT_READY(Pid, sec_acceptor1, accept)
<a name="51301"/>51301:                    end},
<a name="51302"/>51302:          #{desc =&gt; &quot;await sec-acceptor 2 ready (accept)&quot;,
<a name="51303"/>51303:            cmd  =&gt; fun(#{sec_acceptor2 := Pid} = _State) -&gt;
<a name="51304"/>51304:                            ?SEV_AWAIT_READY(Pid, sec_acceptor2, accept)
<a name="51305"/>51305:                    end},
<a name="51306"/>51306:          #{desc =&gt; &quot;await client 1 ready (connect)&quot;,
<a name="51307"/>51307:            cmd  =&gt; fun(#{client1 := Pid} = _State) -&gt;
<a name="51308"/>51308:                            ?SEV_AWAIT_READY(Pid, client1, connect)
<a name="51309"/>51309:                    end},
<a name="51310"/>51310:          #{desc =&gt; &quot;await client 2 ready (connect)&quot;,
<a name="51311"/>51311:            cmd  =&gt; fun(#{client2 := Pid} = _State) -&gt;
<a name="51312"/>51312:                            ?SEV_AWAIT_READY(Pid, client2, connect)
<a name="51313"/>51313:                    end},
<a name="51314"/>51314:          #{desc =&gt; &quot;await client 3 ready (connect)&quot;,
<a name="51315"/>51315:            cmd  =&gt; fun(#{client3 := Pid} = _State) -&gt;
<a name="51316"/>51316:                            ?SEV_AWAIT_READY(Pid, client3, connect)
<a name="51317"/>51317:                    end},
<a name="51318"/>51318: 
<a name="51319"/>51319:          %% Terminate
<a name="51320"/>51320:          #{desc =&gt; &quot;order client 1 to terminate&quot;,
<a name="51321"/>51321:            cmd  =&gt; fun(#{client1 := Pid} = _State) -&gt;
<a name="51322"/>51322:                            ?SEV_ANNOUNCE_TERMINATE(Pid),
<a name="51323"/>51323:                            ok
<a name="51324"/>51324:                    end},
<a name="51325"/>51325:          #{desc =&gt; &quot;await client 1 termination&quot;,
<a name="51326"/>51326:            cmd  =&gt; fun(#{client1 := Pid} = State) -&gt;
<a name="51327"/>51327:                            case ?SEV_AWAIT_TERMINATION(Pid) of
<a name="51328"/>51328:                                ok -&gt;
<a name="51329"/>51329:                                    State1 = maps:remove(client1, State),
<a name="51330"/>51330:                                    {ok, State1};
<a name="51331"/>51331:                                {error, _} = ERROR -&gt;
<a name="51332"/>51332:                                    ERROR
<a name="51333"/>51333:                            end
<a name="51334"/>51334:                    end},
<a name="51335"/>51335:          #{desc =&gt; &quot;order client 2 to terminate&quot;,
<a name="51336"/>51336:            cmd  =&gt; fun(#{client2 := Pid} = _State) -&gt;
<a name="51337"/>51337:                            ?SEV_ANNOUNCE_TERMINATE(Pid),
<a name="51338"/>51338:                            ok
<a name="51339"/>51339:                    end},
<a name="51340"/>51340:          #{desc =&gt; &quot;await client 2 termination&quot;,
<a name="51341"/>51341:            cmd  =&gt; fun(#{client2 := Pid} = State) -&gt;
<a name="51342"/>51342:                            case ?SEV_AWAIT_TERMINATION(Pid) of
<a name="51343"/>51343:                                ok -&gt;
<a name="51344"/>51344:                                    State1 = maps:remove(client2, State),
<a name="51345"/>51345:                                    {ok, State1};
<a name="51346"/>51346:                                {error, _} = ERROR -&gt;
<a name="51347"/>51347:                                    ERROR
<a name="51348"/>51348:                            end
<a name="51349"/>51349:                    end},
<a name="51350"/>51350:          #{desc =&gt; &quot;order client 3 to terminate&quot;,
<a name="51351"/>51351:            cmd  =&gt; fun(#{client3 := Pid} = _State) -&gt;
<a name="51352"/>51352:                            ?SEV_ANNOUNCE_TERMINATE(Pid),
<a name="51353"/>51353:                            ok
<a name="51354"/>51354:                    end},
<a name="51355"/>51355:          #{desc =&gt; &quot;await client 3 termination&quot;,
<a name="51356"/>51356:            cmd  =&gt; fun(#{client3 := Pid} = State) -&gt;
<a name="51357"/>51357:                            case ?SEV_AWAIT_TERMINATION(Pid) of
<a name="51358"/>51358:                                ok -&gt;
<a name="51359"/>51359:                                    State1 = maps:remove(client3, State),
<a name="51360"/>51360:                                    {ok, State1};
<a name="51361"/>51361:                                {error, _} = ERROR -&gt;
<a name="51362"/>51362:                                    ERROR
<a name="51363"/>51363:                            end
<a name="51364"/>51364:                    end},
<a name="51365"/>51365:          #{desc =&gt; &quot;order prim-acceptor to terminate&quot;,
<a name="51366"/>51366:            cmd  =&gt; fun(#{prim_acceptor := Pid} = _State) -&gt;
<a name="51367"/>51367:                            ?SEV_ANNOUNCE_TERMINATE(Pid),
<a name="51368"/>51368:                            ok
<a name="51369"/>51369:                    end},
<a name="51370"/>51370:          #{desc =&gt; &quot;await prim-acceptor termination&quot;,
<a name="51371"/>51371:            cmd  =&gt; fun(#{prim_acceptor := Pid} = State) -&gt;
<a name="51372"/>51372:                            case ?SEV_AWAIT_TERMINATION(Pid) of
<a name="51373"/>51373:                                ok -&gt;
<a name="51374"/>51374:                                    State1 = maps:remove(prim_acceptor, State),
<a name="51375"/>51375:                                    {ok, State1};
<a name="51376"/>51376:                                {error, _} = ERROR -&gt;
<a name="51377"/>51377:                                    ERROR
<a name="51378"/>51378:                            end
<a name="51379"/>51379:                    end},
<a name="51380"/>51380:          #{desc =&gt; &quot;order sec-acceptor 1 to terminate&quot;,
<a name="51381"/>51381:            cmd  =&gt; fun(#{sec_acceptor1 := Pid} = _State) -&gt;
<a name="51382"/>51382:                            ?SEV_ANNOUNCE_TERMINATE(Pid),
<a name="51383"/>51383:                            ok
<a name="51384"/>51384:                    end},
<a name="51385"/>51385:          #{desc =&gt; &quot;await sec-acceptor 1 termination&quot;,
<a name="51386"/>51386:            cmd  =&gt; fun(#{sec_acceptor1 := Pid} = State) -&gt;
<a name="51387"/>51387:                            case ?SEV_AWAIT_TERMINATION(Pid) of
<a name="51388"/>51388:                                ok -&gt;
<a name="51389"/>51389:                                    State1 = maps:remove(sec_acceptor1, State),
<a name="51390"/>51390:                                    {ok, State1};
<a name="51391"/>51391:                                {error, _} = ERROR -&gt;
<a name="51392"/>51392:                                    ERROR
<a name="51393"/>51393:                            end
<a name="51394"/>51394:                    end},
<a name="51395"/>51395:          #{desc =&gt; &quot;order sec-acceptor 2 to terminate&quot;,
<a name="51396"/>51396:            cmd  =&gt; fun(#{sec_acceptor2 := Pid} = _State) -&gt;
<a name="51397"/>51397:                            ?SEV_ANNOUNCE_TERMINATE(Pid),
<a name="51398"/>51398:                            ok
<a name="51399"/>51399:                    end},
<a name="51400"/>51400:          #{desc =&gt; &quot;await sec-acceptor 2 termination&quot;,
<a name="51401"/>51401:            cmd  =&gt; fun(#{sec_acceptor2 := Pid} = State) -&gt;
<a name="51402"/>51402:                            case ?SEV_AWAIT_TERMINATION(Pid) of
<a name="51403"/>51403:                                ok -&gt;
<a name="51404"/>51404:                                    State1 = maps:remove(sec_acceptor2, State),
<a name="51405"/>51405:                                    {ok, State1};
<a name="51406"/>51406:                                {error, _} = ERROR -&gt;
<a name="51407"/>51407:                                    ERROR
<a name="51408"/>51408:                            end
<a name="51409"/>51409:                    end},
<a name="51410"/>51410:          
<a name="51411"/>51411:          %% *** We are done ***
<a name="51412"/>51412:          ?SEV_FINISH_NORMAL
<a name="51413"/>51413:         ],
<a name="51414"/>51414: 
<a name="51415"/>51415: 
<a name="51416"/>51416: 
<a name="51417"/>51417:     i(&quot;create prim-acceptor evaluator&quot;),
<a name="51418"/>51418:     PrimAInitState = InitState,
<a name="51419"/>51419:     PrimAcceptor = ?SEV_START(&quot;prim-acceptor&quot;, PrimAcceptorSeq, PrimAInitState),
<a name="51420"/>51420: 
<a name="51421"/>51421:     i(&quot;create sec-acceptor 1 evaluator&quot;),
<a name="51422"/>51422:     SecAInitState1 = maps:remove(domain, InitState),
<a name="51423"/>51423:     SecAcceptor1 = ?SEV_START(&quot;sec-acceptor-1&quot;, SecAcceptorSeq, SecAInitState1),
<a name="51424"/>51424: 
<a name="51425"/>51425:     i(&quot;create sec-acceptor 2 evaluator&quot;),
<a name="51426"/>51426:     SecAInitState2 = SecAInitState1,
<a name="51427"/>51427:     SecAcceptor2 = ?SEV_START(&quot;sec-acceptor-2&quot;, SecAcceptorSeq, SecAInitState2),
<a name="51428"/>51428: 
<a name="51429"/>51429:     i(&quot;create client 1 evaluator&quot;),
<a name="51430"/>51430:     ClientInitState1 = InitState,
<a name="51431"/>51431:     Client1 = ?SEV_START(&quot;client-1&quot;, ClientSeq, ClientInitState1),
<a name="51432"/>51432: 
<a name="51433"/>51433:     i(&quot;create client 2 evaluator&quot;),
<a name="51434"/>51434:     ClientInitState2 = InitState,
<a name="51435"/>51435:     Client2 = ?SEV_START(&quot;client-2&quot;, ClientSeq, ClientInitState2),
<a name="51436"/>51436: 
<a name="51437"/>51437:     i(&quot;create client 3 evaluator&quot;),
<a name="51438"/>51438:     ClientInitState3 = InitState,
<a name="51439"/>51439:     Client3 = ?SEV_START(&quot;client-3&quot;, ClientSeq, ClientInitState3),
<a name="51440"/>51440: 
<a name="51441"/>51441:     i(&quot;create tester evaluator&quot;),
<a name="51442"/>51442:     TesterInitState = #{prim_acceptor =&gt; PrimAcceptor#ev.pid,
<a name="51443"/>51443:                         sec_acceptor1 =&gt; SecAcceptor1#ev.pid,
<a name="51444"/>51444:                         sec_acceptor2 =&gt; SecAcceptor2#ev.pid,
<a name="51445"/>51445:                         client1       =&gt; Client1#ev.pid,
<a name="51446"/>51446:                         client2       =&gt; Client2#ev.pid,
<a name="51447"/>51447:                         client3       =&gt; Client3#ev.pid},
<a name="51448"/>51448:     Tester = ?SEV_START(&quot;tester&quot;, TesterSeq, TesterInitState),
<a name="51449"/>51449: 
<a name="51450"/>51450:     i(&quot;await evaluator(s)&quot;),
<a name="otp16359_maccept_tcp-last_expr"/><a name="51451"/>51451: <b>    ok = ?SEV_AWAIT_FINISH</b>([PrimAcceptor, SecAcceptor1, SecAcceptor2,
<a name="51452"/>51452:                             Client1, Client2, Client3,
<a name="51453"/>51453:                             Tester]).
<a name="51454"/>51454: 
<a name="51455"/>51455: 
<a name="51456"/>51456: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="51457"/>51457: 
<a name="51458"/>51458: <i>%% This test case is to verify that we do not leak monitors.</i>
<a name="otp18240_accept_mon_leak_tcp4-1"/><a name="51459"/>51459: <b>otp18240_accept_mon_leak_tcp4</b>(Config) when is_list(Config) -&gt;
<a name="51460"/>51460:     ?TT(?SECS(30)),
<a name="otp18240_accept_mon_leak_tcp4-last_expr"/><a name="51461"/>51461: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="51462"/>51462:            fun() -&gt; has_support_ipv4() end,
<a name="51463"/>51463:            fun() -&gt;
<a name="51464"/>51464:                    InitState = #{domain    =&gt; inet,
<a name="51465"/>51465:                                  protocol  =&gt; tcp,
<a name="51466"/>51466:                                  num_socks =&gt; 10},
<a name="51467"/>51467:                    ok = otp18240_accept_tcp(InitState)
<a name="51468"/>51468:            end).
<a name="51469"/>51469: 
<a name="51470"/>51470: 
<a name="51471"/>51471: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="51472"/>51472: 
<a name="51473"/>51473: <i>%% This test case is to verify that we do not leak monitors.</i>
<a name="otp18240_accept_mon_leak_tcp6-1"/><a name="51474"/>51474: <b>otp18240_accept_mon_leak_tcp6</b>(Config) when is_list(Config) -&gt;
<a name="51475"/>51475:     ?TT(?SECS(30)),
<a name="otp18240_accept_mon_leak_tcp6-last_expr"/><a name="51476"/>51476: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="51477"/>51477:            fun() -&gt; has_support_ipv6() end,
<a name="51478"/>51478:            fun() -&gt;
<a name="51479"/>51479:                    InitState = #{domain    =&gt; inet6,
<a name="51480"/>51480:                                  protocol  =&gt; tcp,
<a name="51481"/>51481:                                  num_socks =&gt; 10},
<a name="51482"/>51482:                    ok = otp18240_accept_tcp(InitState)
<a name="51483"/>51483:            end).
<a name="51484"/>51484: 
<a name="51485"/>51485: 
<a name="51486"/>51486: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="51487"/>51487: 
<a name="otp18240_accept_tcp-1"/><a name="51488"/>51488: <b>otp18240_accept_tcp</b>(#{domain    := Domain,
<a name="51489"/>51489:                       protocol  := Proto,
<a name="51490"/>51490:                       num_socks := NumSocks}) -&gt;
<a name="51491"/>51491:     Self = self(),
<a name="51492"/>51492:     {Pid, Mon} = spawn_monitor(fun() -&gt;
<a name="51493"/>51493:                                        otp18240_acceptor(Self,
<a name="51494"/>51494:                                                          Domain, Proto,
<a name="51495"/>51495:                                                          NumSocks)
<a name="51496"/>51496:                                end),
<a name="otp18240_accept_tcp-last_expr"/><a name="51497"/>51497: <b>    otp18240_await_acceptor</b>(Pid, Mon).
<a name="51498"/>51498: 
<a name="otp18240_await_acceptor-2"/><a name="51499"/>51499: <b>otp18240_await_acceptor</b>(Pid, Mon) -&gt;
<a name="otp18240_await_acceptor-last_expr"/><a name="51500"/>51500:     receive
<a name="51501"/>51501: 	{'DOWN', Mon, process, Pid, ok} -&gt;
<a name="51502"/>51502: 	    i(&quot;acceptor successfully terminated&quot;),
<a name="51503"/>51503:             ok;
<a name="51504"/>51504: 	{'DOWN', Mon, process, Pid, {skip, _} = SKIP} -&gt;
<a name="51505"/>51505: 	    i(&quot;acceptor successfully terminated&quot;),
<a name="51506"/>51506:             exit(SKIP);
<a name="51507"/>51507:         {'DOWN', Mon, process, Pid, Info} -&gt;
<a name="51508"/>51508:             i(&quot;acceptor unexpected termination: &quot;
<a name="51509"/>51509:               &quot;~n   ~p&quot;, [Info]),
<a name="51510"/>51510:             exit({unexpected_result, Info})
<a name="51511"/>51511:     after 5000 -&gt;
<a name="51512"/>51512: 	    i(&quot;acceptor process (~p) info&quot;
<a name="51513"/>51513: 	      &quot;~n   Refs: ~p&quot;
<a name="51514"/>51514: 	      &quot;~n   Info: ~p&quot;,
<a name="51515"/>51515: 	      [Pid, monitored_by(Pid), erlang:process_info(Pid)]),
<a name="51516"/>51516: 	    otp18240_await_acceptor(Pid, Mon)
<a name="51517"/>51517:     end.
<a name="51518"/>51518: 
<a name="otp18240_acceptor-4"/><a name="51519"/>51519: <b>otp18240_acceptor</b>(Parent, Domain, Proto, NumSocks) -&gt;
<a name="51520"/>51520:     i(&quot;[acceptor] begin with: &quot;
<a name="51521"/>51521:       &quot;~n   Parent:   ~p&quot;
<a name="51522"/>51522:       &quot;~n   Domain:   ~p&quot;
<a name="51523"/>51523:       &quot;~n   Protocol: ~p&quot;, [Parent, Domain, Proto]),
<a name="51524"/>51524:     MonitoredBy0 = monitored_by(),
<a name="51525"/>51525:     ?SLEEP(?SECS(5)),
<a name="51526"/>51526:     Addr = case ?LIB:which_local_host_info(Domain) of
<a name="51527"/>51527:                {ok, #{addr := A}} -&gt;
<a name="51528"/>51528:                    A;
<a name="51529"/>51529:                {error, Reason} -&gt;
<a name="51530"/>51530:                    exit({skip, Reason})
<a name="51531"/>51531:            end,
<a name="51532"/>51532:     {ok, LSock} = socket:open(Domain, stream, Proto,
<a name="51533"/>51533:                               #{use_registry =&gt; false}),
<a name="51534"/>51534:     ok = socket:bind(LSock, #{family =&gt; Domain, addr =&gt; Addr, port =&gt; 0}),
<a name="51535"/>51535:     ok = socket:listen(LSock, NumSocks),
<a name="51536"/>51536:     ?SLEEP(?SECS(5)),
<a name="51537"/>51537:     MonitoredBy1 = monitored_by(),
<a name="51538"/>51538:     i(&quot;[acceptor]: listen socket created&quot;
<a name="51539"/>51539:       &quot;~n   'Montored By' before listen socket: ~p&quot;
<a name="51540"/>51540:       &quot;~n   'Montored By' after listen socket:  ~p&quot;,
<a name="51541"/>51541:       [MonitoredBy0, MonitoredBy1]),
<a name="51542"/>51542: 
<a name="51543"/>51543:     [LSockMon] = MonitoredBy1 -- MonitoredBy0,
<a name="51544"/>51544: 
<a name="51545"/>51545:     i(&quot;[acceptor]: &quot;
<a name="51546"/>51546:       &quot;~n   Listen Socket Monitor: ~p&quot;
<a name="51547"/>51547:       &quot;~n   Listen Socket info:    ~p&quot;,
<a name="51548"/>51548:       [LSockMon, socket:info(LSock)]),
<a name="51549"/>51549: 
<a name="51550"/>51550:     {ok, #{port := Port}} = socket:sockname(LSock),
<a name="51551"/>51551: 
<a name="51552"/>51552:     i(&quot;[acceptor] create ~w clients (connectors)&quot;, [NumSocks]),
<a name="51553"/>51553:     _Clients = [spawn_link(fun() -&gt;
<a name="51554"/>51554:                                    otp18240_client(CID,
<a name="51555"/>51555:                                                    Domain, Proto,
<a name="51556"/>51556:                                                    Addr, Port)
<a name="51557"/>51557:                            end) || CID &lt;- lists:seq(1, NumSocks)],
<a name="51558"/>51558: 
<a name="51559"/>51559:     i(&quot;[acceptor] accept ~w connections&quot;, [NumSocks]),
<a name="51560"/>51560:     ServSocks = [otp18240_do_accept(AID, LSock) ||
<a name="51561"/>51561:                     AID &lt;- lists:seq(1, NumSocks)],
<a name="51562"/>51562: 
<a name="51563"/>51563:     i(&quot;[acceptor] close accepted connections when: &quot;
<a name="51564"/>51564:       &quot;~n   Listen Socket info: ~p&quot;, [socket:info(LSock)]),
<a name="51565"/>51565:     _ = [otp18240_do_close(S) || S &lt;- ServSocks],
<a name="51566"/>51566: 
<a name="51567"/>51567:     %% at this point in time there should be no monitors from NIFs,
<a name="51568"/>51568:     %% because we're not accepting anything
<a name="51569"/>51569:     i(&quot;[acceptor] check monitor status&quot;),
<a name="51570"/>51570:     MonitoredBy2 = monitored_by(),
<a name="51571"/>51571:     MonitoredBy3 = MonitoredBy2 -- [Parent, LSockMon],
<a name="51572"/>51572:     i(&quot;[acceptor] monitor status: &quot;
<a name="51573"/>51573:       &quot;~n   UnRefs:       ~p&quot;
<a name="51574"/>51574:       &quot;~n   MonitoredBy2: ~p&quot;
<a name="51575"/>51575:       &quot;~n   MonitoredBy3: ~p&quot;,
<a name="51576"/>51576:       [[Parent, LSockMon], MonitoredBy2, MonitoredBy3]),
<a name="otp18240_acceptor-last_expr"/><a name="51577"/>51577:     if
<a name="51578"/>51578:         ([] =:= MonitoredBy3) -&gt;
<a name="51579"/>51579:             i(&quot;[acceptor] done&quot;),
<a name="51580"/>51580:             socket:close(LSock),
<a name="51581"/>51581:             exit(ok);
<a name="51582"/>51582:         true -&gt;
<a name="51583"/>51583:             socket:close(LSock),
<a name="51584"/>51584:             i(&quot;[acceptor] Unexpected monitors: &quot;
<a name="51585"/>51585:               &quot;~n   ~p&quot;, [MonitoredBy2]),
<a name="51586"/>51586:             exit({unexpected_monitors, MonitoredBy2})
<a name="51587"/>51587:     end.
<a name="51588"/>51588: 
<a name="51589"/>51589: 
<a name="otp18240_client-5"/><a name="51590"/>51590: <b>otp18240_client</b>(ID, Domain, Proto, Addr, PortNo) -&gt;
<a name="51591"/>51591:     i(&quot;[connector ~w] try create connector socket&quot;, [ID]),
<a name="51592"/>51592:     {ok, Sock} = socket:open(Domain, stream, Proto, #{use_registry =&gt; false}),
<a name="51593"/>51593:     ok = socket:bind(Sock, #{family =&gt; Domain, addr =&gt; Addr, port =&gt; 0}),
<a name="51594"/>51594:     %% ok = socket:setopt(Sock, otp, debug, true),
<a name="51595"/>51595:     i(&quot;[connector ~w] try connect&quot;, [ID]),
<a name="51596"/>51596:     case socket:connect(Sock,
<a name="51597"/>51597:                         #{family =&gt; Domain, addr =&gt; Addr, port =&gt; PortNo}) of
<a name="51598"/>51598:         ok -&gt;
<a name="51599"/>51599:             i(&quot;[connector ~w] connected - now try recv&quot;, [ID]),
<a name="51600"/>51600:             case socket:recv(Sock) of
<a name="51601"/>51601:                 {ok, Data} -&gt;
<a name="51602"/>51602:                     i(&quot;[connector ~w] received unexpected data: &quot;
<a name="51603"/>51603:                       &quot;~n   ~p&quot;, [ID, Data]),
<a name="51604"/>51604:                     (catch socket:close(Sock)),
<a name="51605"/>51605:                     exit('unexpected data');
<a name="51606"/>51606:                 {error, closed} -&gt;
<a name="51607"/>51607:                     i(&quot;[connector ~w] expected socket close&quot;, [ID]);
<a name="51608"/>51608:                 {error, Reason} -&gt;
<a name="51609"/>51609:                     i(&quot;[connector ~w] unexpected error when reading: &quot;
<a name="51610"/>51610:                       &quot;~n   ~p&quot;, [ID, Reason]),
<a name="51611"/>51611:                     (catch socket:close(Sock))
<a name="51612"/>51612:             end;
<a name="51613"/>51613:         {error, {completion_status, #{info := invalid_netname = R} = Reason}} -&gt;
<a name="51614"/>51614:             i(&quot;[connector ~w] failed connecting: &quot;
<a name="51615"/>51615:               &quot;~n   ~p&quot;, [ID, Reason]),
<a name="51616"/>51616:             (catch socket:close(Sock)),
<a name="51617"/>51617:             exit({skip, R});
<a name="51618"/>51618:         {error, {completion_status, invalid_netname = Reason}} -&gt;
<a name="51619"/>51619:             i(&quot;[connector ~w] failed connecting: &quot;
<a name="51620"/>51620:               &quot;~n   ~p&quot;, [ID, Reason]),
<a name="51621"/>51621:             (catch socket:close(Sock)),
<a name="51622"/>51622:             exit({skip, Reason});
<a name="51623"/>51623:         {error, enetunreach = Reason} -&gt;
<a name="51624"/>51624:             i(&quot;[connector ~w] failed connecting: &quot;
<a name="51625"/>51625:               &quot;~n   ~p&quot;, [ID, Reason]),
<a name="51626"/>51626:             (catch socket:close(Sock)),
<a name="51627"/>51627:             exit({skip, Reason});
<a name="51628"/>51628: 
<a name="51629"/>51629:         {error, Reason} -&gt;
<a name="51630"/>51630:             i(&quot;[connector ~w] failed connecting: &quot;
<a name="51631"/>51631:               &quot;~n   ~p&quot;, [ID, Reason]),
<a name="51632"/>51632:             (catch socket:close(Sock))
<a name="51633"/>51633:     end,
<a name="51634"/>51634:     i(&quot;[connector ~w] done&quot;, [ID]),
<a name="otp18240_client-last_expr"/><a name="51635"/>51635:     ok.
<a name="51636"/>51636: 
<a name="51637"/>51637: 
<a name="otp18240_do_accept-2"/><a name="51638"/>51638: <b>otp18240_do_accept</b>(ID, LSock) -&gt;
<a name="51639"/>51639:     i(&quot;[acceptor ~w] try accept&quot;, [ID]),
<a name="51640"/>51640:     {ok, Sock} = socket:accept(LSock),
<a name="51641"/>51641:     i(&quot;[acceptor ~w] accepted: ~p&quot;, [ID, Sock]),
<a name="otp18240_do_accept-last_expr"/><a name="51642"/>51642:     {ID, Sock}.
<a name="51643"/>51643: 
<a name="51644"/>51644: 
<a name="otp18240_do_close-1"/><a name="51645"/>51645: <b>otp18240_do_close</b>({ID, Sock}) -&gt;
<a name="51646"/>51646:     i(&quot;[acceptor ~w] try close ~p&quot;, [ID, Sock]),
<a name="otp18240_do_close-last_expr"/><a name="51647"/>51647: <b>    case socket:close</b>(Sock) of
<a name="51648"/>51648: 	ok -&gt;
<a name="51649"/>51649: 	    i(&quot;[acceptor ~w] socket closed&quot;, [ID]),
<a name="51650"/>51650: 	    ok;
<a name="51651"/>51651: 	{error, Reason} -&gt;
<a name="51652"/>51652: 	    i(&quot;[acceptor ~w] failed close socket: &quot;
<a name="51653"/>51653: 	      &quot;~n   ~p&quot;, [ID, Reason]),
<a name="51654"/>51654: 	    error
<a name="51655"/>51655:     end.
<a name="51656"/>51656: 
<a name="51657"/>51657: 
<a name="51658"/>51658: 
<a name="51659"/>51659: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="51660"/>51660: 
<a name="51661"/>51661: <i>%% This test case is to verify that we do not leak monitors.</i>
<a name="otp18635-1"/><a name="51662"/>51662: <b>otp18635</b>(Config) when is_list(Config) -&gt;
<a name="51663"/>51663:     ?TT(?SECS(10)),
<a name="otp18635-last_expr"/><a name="51664"/>51664: <b>    tc_try</b>(?FUNCTION_NAME,
<a name="51665"/>51665:            fun() -&gt;
<a name="51666"/>51666:                    is_not_windows(),
<a name="51667"/>51667:                    has_support_ipv4()
<a name="51668"/>51668:            end,
<a name="51669"/>51669:            fun() -&gt;
<a name="51670"/>51670:                    InitState = #{},
<a name="51671"/>51671:                    ok = do_otp18635(InitState)
<a name="51672"/>51672:            end).
<a name="51673"/>51673: 
<a name="51674"/>51674: 
<a name="do_otp18635-1"/><a name="51675"/>51675: <b>do_otp18635</b>(_) -&gt;
<a name="51676"/>51676:     Parent = self(),
<a name="51677"/>51677: 
<a name="51678"/>51678:     ?P(&quot;try create (listen) socket when&quot;
<a name="51679"/>51679:        &quot;~n   (gen socket) info: ~p&quot;
<a name="51680"/>51680:        &quot;~n   Sockets:           ~p&quot;,
<a name="51681"/>51681:        [socket:info(), socket:which_sockets()]),
<a name="51682"/>51682: 
<a name="51683"/>51683:     ?P(&quot;Get \&quot;proper\&quot; local socket address&quot;),
<a name="51684"/>51684:     LSA = which_local_socket_addr(inet),
<a name="51685"/>51685: 
<a name="51686"/>51686:     {ok, LSock} = socket:open(inet, stream, #{use_registry =&gt; true}),
<a name="51687"/>51687: 
<a name="51688"/>51688:     ?P(&quot;bind (listen) socket to: &quot;
<a name="51689"/>51689:        &quot;~n   ~p&quot;, [LSA]),
<a name="51690"/>51690:     ok = socket:bind(LSock, LSA),
<a name="51691"/>51691: 
<a name="51692"/>51692:     ?P(&quot;make listen socket&quot;),
<a name="51693"/>51693:     ok = socket:listen(LSock),
<a name="51694"/>51694: 
<a name="51695"/>51695:     ?P(&quot;get sockname for listen socket&quot;),
<a name="51696"/>51696:     {ok, SA} = socket:sockname(LSock),
<a name="51697"/>51697: 
<a name="51698"/>51698:     %% ok = socket:setopt(LSock, otp, debug, true),
<a name="51699"/>51699: 
<a name="51700"/>51700:     % show handle returned from nowait accept
<a name="51701"/>51701:     ?P(&quot;try accept with timeout = nowait - expect select when&quot;
<a name="51702"/>51702:        &quot;~n   (gen socket) info: ~p&quot;
<a name="51703"/>51703:        &quot;~n   Sockets:           ~p&quot;,
<a name="51704"/>51704:        [socket:info(), socket:which_sockets()]),
<a name="51705"/>51705:     {select, {select_info, _, Handle}} = socket:accept(LSock, nowait),
<a name="51706"/>51706:     ?P(&quot;expected select result: &quot;
<a name="51707"/>51707:        &quot;~n   Select Handle:     ~p&quot;
<a name="51708"/>51708:        &quot;~n   (gen socket) info: ~p&quot;
<a name="51709"/>51709:        &quot;~n   Sockets:           ~p&quot;,
<a name="51710"/>51710:        [Handle, socket:info(), socket:which_sockets()]),
<a name="51711"/>51711: 
<a name="51712"/>51712:     ?SLEEP(?SECS(1)),
<a name="51713"/>51713: 
<a name="51714"/>51714:     %% perform a blocking accept that will fail (timeout)
<a name="51715"/>51715:     ?P(&quot;attempt accept with timeout = 500 - expect failure (timeout)&quot;),
<a name="51716"/>51716:     {error, timeout} = socket:accept(LSock, 500),
<a name="51717"/>51717: 
<a name="51718"/>51718:     ?P(&quot;await abort message for the first accept call: &quot;
<a name="51719"/>51719:        &quot;~n   Select Handle:     ~p&quot;
<a name="51720"/>51720:        &quot;~n   (gen socket) info: ~p&quot;
<a name="51721"/>51721:        &quot;~n   Sockets:           ~p&quot;,
<a name="51722"/>51722:        [Handle, socket:info(), socket:which_sockets()]),
<a name="51723"/>51723:     receive
<a name="51724"/>51724:         {'$socket', LSock, abort, {Handle, cancelled}} -&gt;
<a name="51725"/>51725:             ?P(&quot;received expected abort message&quot;),
<a name="51726"/>51726:             ok
<a name="51727"/>51727:     end,
<a name="51728"/>51728: 
<a name="51729"/>51729:     %% spawn a client to connect
<a name="51730"/>51730:     ?P(&quot;spawn connector when&quot;
<a name="51731"/>51731:        &quot;~n   (gen socket) info:  ~p&quot;
<a name="51732"/>51732:        &quot;~n   Listen Socket info: ~p&quot;
<a name="51733"/>51733:        &quot;~n   Sockets:            ~p&quot;,
<a name="51734"/>51734:        [socket:info(), socket:info(LSock), socket:which_sockets()]),
<a name="51735"/>51735:     {Connector, MRef} =
<a name="51736"/>51736:         spawn_monitor(
<a name="51737"/>51737:           fun() -&gt;
<a name="51738"/>51738:                   ?P(&quot;[connector] try create socket&quot;),
<a name="51739"/>51739:                   {ok, CSock} = socket:open(inet, stream),
<a name="51740"/>51740:                   ?P(&quot;[connector] try connect: &quot;
<a name="51741"/>51741:                        &quot;~n   (server) ~p&quot;, [SA]),
<a name="51742"/>51742:                   ok = socket:connect(CSock, SA),
<a name="51743"/>51743:                   ?P(&quot;[connector] connected - inform parent&quot;),
<a name="51744"/>51744:                   Parent ! {self(), connected},
<a name="51745"/>51745:                   ?P(&quot;[connector] await termination command&quot;),
<a name="51746"/>51746:                   receive
<a name="51747"/>51747:                       {Parent, terminate} -&gt;
<a name="51748"/>51748:                           ?P(&quot;[connector] terminate - close socket&quot;),
<a name="51749"/>51749:                           (catch socket:close(CSock)),
<a name="51750"/>51750:                           exit(normal)
<a name="51751"/>51751:                   end
<a name="51752"/>51752:               end),
<a name="51753"/>51753: 
<a name="51754"/>51754:     ?P(&quot;await (connection-) confirmation from connector (~p)&quot;, [Connector]),
<a name="51755"/>51755:     receive
<a name="51756"/>51756:         {Connector, connected} -&gt;
<a name="51757"/>51757:             ?P(&quot;connector connected&quot;),
<a name="51758"/>51758:             ok
<a name="51759"/>51759:     end,
<a name="51760"/>51760: 
<a name="51761"/>51761:     %% We should *not* get *any* select messages;
<a name="51762"/>51762:     %% since the second call (that *replaced* the current active request)
<a name="51763"/>51763:     %% timeout out
<a name="51764"/>51764:     ?P(&quot;wait for a select message that should never come&quot;),
<a name="51765"/>51765:     Result =
<a name="51766"/>51766:         receive
<a name="51767"/>51767:             {'$socket', LSock, select, AnyHandle} -&gt;
<a name="51768"/>51768:                 ?P(&quot;received unexpected select message when&quot;
<a name="51769"/>51769:                    &quot;~n   Unexpected Handle:  ~p&quot;
<a name="51770"/>51770:                    &quot;~n   (gen socket) info:  ~p&quot;
<a name="51771"/>51771:                    &quot;~n   Listen Socket info: ~p&quot;
<a name="51772"/>51772:                    &quot;~n   Sockets:            ~p&quot;,
<a name="51773"/>51773:                    [AnyHandle,
<a name="51774"/>51774:                     socket:info(), socket:info(LSock), socket:which_sockets()]),
<a name="51775"/>51775:                 error
<a name="51776"/>51776:         after 5000 -&gt;
<a name="51777"/>51777:                 ?P(&quot;expected timeout&quot;),
<a name="51778"/>51778:                 ok
<a name="51779"/>51779:         end,
<a name="51780"/>51780: 
<a name="51781"/>51781:     ?P(&quot;try accept the waiting connection when&quot;
<a name="51782"/>51782:        &quot;~n   (gen socket) info:  ~p&quot;
<a name="51783"/>51783:        &quot;~n   Listen Socket info: ~p&quot;
<a name="51784"/>51784:        &quot;~n   Sockets:            ~p&quot;,
<a name="51785"/>51785:        [socket:info(), socket:info(LSock), socket:which_sockets()]),
<a name="51786"/>51786: 
<a name="51787"/>51787:     {ok, ASock} = socket:accept(LSock),
<a name="51788"/>51788: 
<a name="51789"/>51789:     ?P(&quot;connection accepted&quot;
<a name="51790"/>51790:        &quot;~n   (gen socket) info:    ~p&quot;
<a name="51791"/>51791:        &quot;~n   Accepted socket:      ~p&quot;
<a name="51792"/>51792:        &quot;~n   Accepted Socket info: ~p&quot;
<a name="51793"/>51793:        &quot;~n   Listen Socket info:   ~p&quot;
<a name="51794"/>51794:        &quot;~n   Sockets:              ~p&quot;,
<a name="51795"/>51795:        [socket:info(),
<a name="51796"/>51796:         ASock,
<a name="51797"/>51797:         socket:info(ASock),
<a name="51798"/>51798:         socket:info(LSock),
<a name="51799"/>51799:         socket:which_sockets()]),
<a name="51800"/>51800: 
<a name="51801"/>51801:     ?P(&quot;cleanup&quot;),
<a name="51802"/>51802:     socket:close(LSock),
<a name="51803"/>51803:     socket:close(ASock),
<a name="51804"/>51804:     Connector ! {self(), terminate},
<a name="51805"/>51805:     receive
<a name="51806"/>51806:         {'DOWN', MRef, process, Connector, _} -&gt;
<a name="51807"/>51807:             ?P(&quot;connector terminated&quot;),
<a name="51808"/>51808:             ok
<a name="51809"/>51809:     end,
<a name="51810"/>51810: 
<a name="51811"/>51811:     ?SLEEP(?SECS(1)),
<a name="51812"/>51812: 
<a name="51813"/>51813:     ?P(&quot;done when&quot;
<a name="51814"/>51814:        &quot;~n   (gen socket) info: ~p&quot;
<a name="51815"/>51815:        &quot;~n   Sockets:           ~p&quot;, [socket:info(), socket:which_sockets()]),
<a name="51816"/>51816: 
<a name="do_otp18635-last_expr"/><a name="51817"/>51817:     Result.
<a name="51818"/>51818: 
<a name="51819"/>51819: 
<a name="51820"/>51820: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="51821"/>51821: 
<a name="sock_open-3"/><a name="51822"/>51822: <b>sock_open</b>(Domain, Type, Proto) -&gt;
<a name="sock_open-last_expr"/><a name="51823"/>51823: <b>    try socket:open</b>(Domain, Type, Proto) of
<a name="51824"/>51824:         {ok, Socket} -&gt;
<a name="51825"/>51825:             Socket;
<a name="51826"/>51826:         {error, Reason} -&gt;
<a name="51827"/>51827:             ?FAIL({open, Reason})
<a name="51828"/>51828:     catch
<a name="51829"/>51829:         C:E:S -&gt;
<a name="51830"/>51830:             ?FAIL({open, C, E, S})
<a name="51831"/>51831:     end.
<a name="51832"/>51832: 
<a name="51833"/>51833: 
<a name="sock_bind-2"/><a name="51834"/>51834: <b>sock_bind</b>(Sock, LSA) -&gt;
<a name="sock_bind-last_expr"/><a name="51835"/>51835: <b>    try socket:bind</b>(Sock, LSA) of
<a name="51836"/>51836:         ok = OK -&gt;
<a name="51837"/>51837:             OK;
<a name="51838"/>51838:         {error, eaddrnotavail = Reason} -&gt;
<a name="51839"/>51839:             ?SEV_IPRINT(&quot;Address not available&quot;),
<a name="51840"/>51840:             throw({skip, Reason});
<a name="51841"/>51841:         {error, _} = ERROR -&gt;
<a name="51842"/>51842:             ERROR
<a name="51843"/>51843:     catch
<a name="51844"/>51844:         C:E:S -&gt;
<a name="51845"/>51845:             ?FAIL({bind, C, E, S})
<a name="51846"/>51846:     end.
<a name="51847"/>51847: 
<a name="sock_connect-2"/><a name="51848"/>51848: <b>sock_connect</b>(Sock, SockAddr) -&gt;
<a name="sock_connect-last_expr"/><a name="51849"/>51849: <b>    try socket:connect</b>(Sock, SockAddr) of
<a name="51850"/>51850:         ok -&gt;
<a name="51851"/>51851:             ok;
<a name="51852"/>51852:         {error, Reason} -&gt;
<a name="51853"/>51853:             ?FAIL({connect, Reason})
<a name="51854"/>51854:     catch
<a name="51855"/>51855:         C:E:S -&gt;
<a name="51856"/>51856:             ?FAIL({connect, C, E, S})
<a name="51857"/>51857:     end.
<a name="51858"/>51858:     
<a name="sock_sockname-1"/><a name="51859"/>51859: <b>sock_sockname</b>(Sock) -&gt;
<a name="sock_sockname-last_expr"/><a name="51860"/>51860: <b>    try socket:sockname</b>(Sock) of
<a name="51861"/>51861:         {ok, SockAddr} -&gt;
<a name="51862"/>51862:             SockAddr;
<a name="51863"/>51863:         {error, Reason} -&gt;
<a name="51864"/>51864:             ?FAIL({sockname, Reason})
<a name="51865"/>51865:     catch
<a name="51866"/>51866:         C:E:S -&gt;
<a name="51867"/>51867:             ?FAIL({sockname, C, E, S})
<a name="51868"/>51868:     end.
<a name="51869"/>51869:     
<a name="sock_close-1"/><a name="51870"/>51870: <b>sock_close</b>(Sock) -&gt;
<a name="sock_close-last_expr"/><a name="51871"/>51871: <b>    try socket:close</b>(Sock) of
<a name="51872"/>51872:         ok -&gt;
<a name="51873"/>51873:             ok;
<a name="51874"/>51874:         {error, Reason} -&gt;
<a name="51875"/>51875:             i(&quot;sock_close -&gt; error: ~p&quot;, [Reason]),
<a name="51876"/>51876:             ?FAIL({close, Reason})
<a name="51877"/>51877:     catch
<a name="51878"/>51878:         C:E:S -&gt;
<a name="51879"/>51879:             i(&quot;sock_close -&gt; failed: ~p, ~p, ~p&quot;, [C, E, S]),
<a name="51880"/>51880:             ?FAIL({close, C, E, S})
<a name="51881"/>51881:     end.
<a name="51882"/>51882: 
<a name="51883"/>51883: 
<a name="51884"/>51884: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="51885"/>51885: 
<a name="local_host-0"/><a name="51886"/>51886: <b>local_host</b>() -&gt;
<a name="local_host-last_expr"/><a name="51887"/>51887: <b>    try net_adm:localhost</b>() of
<a name="51888"/>51888:         Host when is_list(Host) -&gt;
<a name="51889"/>51889: 	    %% Convert to shortname if long
<a name="51890"/>51890: 	    case string:tokens(Host, [$.]) of
<a name="51891"/>51891: 		[H|_] -&gt;
<a name="51892"/>51892: 		    list_to_atom(H)
<a name="51893"/>51893: 	    end
<a name="51894"/>51894:     catch
<a name="51895"/>51895:         C:E:S -&gt;
<a name="51896"/>51896:             erlang:raise(C, E, S)
<a name="51897"/>51897:     end.
<a name="51898"/>51898: 
<a name="51899"/>51899: 
<a name="51900"/>51900: <i>%% The point of this is to &quot;ensure&quot; that paths from different test runs</i>
<a name="51901"/>51901: <i>%% don't clash.</i>
<a name="51902"/>51902: 
<a name="mk_unique_path-0"/><a name="51903"/>51903: <b>mk_unique_path</b>() -&gt;
<a name="mk_unique_path-last_expr"/><a name="51904"/>51904: <b>    ?LIB:mk_unique_path</b>().
<a name="51905"/>51905: 
<a name="51906"/>51906: 
<a name="which_local_socket_addr-1"/><a name="51907"/>51907: <b>which_local_socket_addr</b>(local = Domain) -&gt;
<a name="51908"/>51908:     #{family =&gt; Domain,
<a name="51909"/>51909:       path   =&gt; mk_unique_path()};
<a name="51910"/>51910: 
<a name="51911"/>51911: <i>%% This gets the local socket address (not 127.0...)</i>
<a name="51912"/>51912: <i>%% We should really implement this using the (new) net module,</i>
<a name="51913"/>51913: <i>%% but until that gets the necessary functionality...</i>
<a name="51914"/>51914: <b>which_local_socket_addr</b>(Domain) -&gt;
<a name="which_local_socket_addr-last_expr"/><a name="51915"/>51915: <b>    case ?KLIB:which_local_host_info</b>(Domain) of
<a name="51916"/>51916:         {ok, [#{addr := Addr}|_]} -&gt;
<a name="51917"/>51917:             #{family =&gt; Domain,
<a name="51918"/>51918:               addr   =&gt; Addr};
<a name="51919"/>51919:         {error, Reason} -&gt;
<a name="51920"/>51920:             ?FAIL(Reason)
<a name="51921"/>51921:     end.
<a name="51922"/>51922: 
<a name="which_local_host_info-1"/><a name="51923"/>51923: <b>which_local_host_info</b>(Domain) -&gt;
<a name="which_local_host_info-last_expr"/><a name="51924"/>51924: <b>    case ?KLIB:which_local_host_info</b>(Domain) of
<a name="51925"/>51925:         {ok, [Info|_]} -&gt;
<a name="51926"/>51926:             {ok, Info#{family =&gt; Domain}};
<a name="51927"/>51927:         {error, Reason} -&gt;
<a name="51928"/>51928:             ?FAIL(Reason)
<a name="51929"/>51929:     end.
<a name="51930"/>51930: 
<a name="51931"/>51931: 
<a name="51932"/>51932: 
<a name="which_local_addr-1"/><a name="51933"/>51933: <b>which_local_addr</b>(local = _Domain) -&gt;
<a name="51934"/>51934:     mk_unique_path();
<a name="51935"/>51935: 
<a name="51936"/>51936: <i>%% This gets the local address (not 127.0...)</i>
<a name="51937"/>51937: <i>%% We should really implement this using the (new) net module,</i>
<a name="51938"/>51938: <i>%% but until that gets the necessary functionality...</i>
<a name="51939"/>51939: <b>which_local_addr</b>(Domain) -&gt;
<a name="which_local_addr-last_expr"/><a name="51940"/>51940: <b>    ?KLIB:which_local_addr</b>(Domain).
<a name="51941"/>51941: 
<a name="51942"/>51942: 
<a name="51943"/>51943: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="51944"/>51944: 
<a name="monitored_by-0"/><a name="51945"/>51945: <b>monitored_by</b>() -&gt;
<a name="monitored_by-last_expr"/><a name="51946"/>51946: <b>    monitored_by</b>(self()).
<a name="monitored_by-1"/><a name="51947"/>51947: <b>monitored_by</b>(Pid) -&gt;	
<a name="51948"/>51948:     {monitored_by, Refs} = erlang:process_info(Pid, monitored_by),
<a name="monitored_by-last_expr"/><a name="51949"/>51949:     Refs.
<a name="51950"/>51950: 
<a name="51951"/>51951: 
<a name="51952"/>51952: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="51953"/>51953: 
<a name="51954"/>51954: <i>%% Here are all the *general* test case condition functions.</i>
<a name="51955"/>51955: 
<a name="51956"/>51956: <i>%% We also need to (be able to) figure out the multicast address,</i>
<a name="51957"/>51957: <i>%% which we only support for some platforms (linux and sunos).</i>
<a name="51958"/>51958: <i>%% We don't do that here, but since we can only do that (find a</i>
<a name="51959"/>51959: <i>%% multicast address) for specific platforms, we check that we are</i>
<a name="51960"/>51960: <i>%% on of those platforms here.</i>
<a name="has_support_ip_multicast-0"/><a name="51961"/>51961: <b>has_support_ip_multicast</b>() -&gt;
<a name="has_support_ip_multicast-last_expr"/><a name="51962"/>51962: <b>    case os:type</b>() of
<a name="51963"/>51963:         {unix, OsName} when (OsName =:= linux) orelse
<a name="51964"/>51964:                             (OsName =:= sunos) -&gt;
<a name="51965"/>51965:             case ?LIB:which_local_host_info(inet) of
<a name="51966"/>51966:                 {ok, #{flags := Flags}} -&gt;
<a name="51967"/>51967:                     case lists:member(multicast, Flags) of
<a name="51968"/>51968:                         true -&gt;
<a name="51969"/>51969:                             ok;
<a name="51970"/>51970:                         false -&gt;
<a name="51971"/>51971:                             not_supported(multicast)
<a name="51972"/>51972:                     end;
<a name="51973"/>51973:                 {error, Reason} -&gt;
<a name="51974"/>51974:                     not_supported({multicast, Reason})
<a name="51975"/>51975:             end;
<a name="51976"/>51976:         {unix, OsName} -&gt;
<a name="51977"/>51977:             skip(?F(&quot;Not Supported: platform ~w&quot;, [OsName]));
<a name="51978"/>51978:         Type -&gt;
<a name="51979"/>51979:             skip(?F(&quot;Not Supported: platform ~p&quot;, [Type]))
<a name="51980"/>51980:     end.
<a name="51981"/>51981: 
<a name="51982"/>51982: 
<a name="51983"/>51983: <i>%% --- SOCK socket option test functions ---</i>
<a name="51984"/>51984: 
<a name="has_support_sock_acceptconn-0"/><a name="51985"/>51985: <b>has_support_sock_acceptconn</b>() -&gt;
<a name="has_support_sock_acceptconn-last_expr"/><a name="51986"/>51986: <b>    has_support_socket_option_sock</b>(acceptconn).
<a name="51987"/>51987: 
<a name="has_support_sock_bindtodevice-0"/><a name="51988"/>51988: <b>has_support_sock_bindtodevice</b>() -&gt;
<a name="has_support_sock_bindtodevice-last_expr"/><a name="51989"/>51989: <b>    has_support_socket_option_sock</b>(bindtodevice).
<a name="51990"/>51990: 
<a name="has_support_sock_broadcast-0"/><a name="51991"/>51991: <b>has_support_sock_broadcast</b>() -&gt;
<a name="51992"/>51992:     has_support_ipv4(),
<a name="51993"/>51993:     has_support_socket_option_sock(broadcast),
<a name="has_support_sock_broadcast-last_expr"/><a name="51994"/>51994: <b>    case ?LIB:which_local_host_info</b>(inet) of
<a name="51995"/>51995:         {ok, #{flags := Flags}} -&gt;
<a name="51996"/>51996:             case lists:member(broadcast, Flags) of
<a name="51997"/>51997:                 true -&gt;
<a name="51998"/>51998:                     ok;
<a name="51999"/>51999:                 false -&gt;
<a name="52000"/>52000:                     not_supported({broadcast, Flags})
<a name="52001"/>52001:             end;
<a name="52002"/>52002:         {error, Reason} -&gt;
<a name="52003"/>52003:             not_supported({broadcast, Reason})
<a name="52004"/>52004:     end.
<a name="52005"/>52005: 
<a name="has_support_sock_debug-0"/><a name="52006"/>52006: <b>has_support_sock_debug</b>() -&gt;
<a name="has_support_sock_debug-last_expr"/><a name="52007"/>52007: <b>    has_support_socket_option_sock</b>(debug).
<a name="52008"/>52008: 
<a name="has_support_sock_domain-0"/><a name="52009"/>52009: <b>has_support_sock_domain</b>() -&gt;
<a name="has_support_sock_domain-last_expr"/><a name="52010"/>52010: <b>    has_support_socket_option_sock</b>(domain).
<a name="52011"/>52011: 
<a name="has_support_sock_dontroute-0"/><a name="52012"/>52012: <b>has_support_sock_dontroute</b>() -&gt;
<a name="has_support_sock_dontroute-last_expr"/><a name="52013"/>52013: <b>    has_support_socket_option_sock</b>(dontroute).
<a name="52014"/>52014: 
<a name="has_support_sock_keepalive-0"/><a name="52015"/>52015: <b>has_support_sock_keepalive</b>() -&gt;
<a name="has_support_sock_keepalive-last_expr"/><a name="52016"/>52016: <b>    has_support_socket_option_sock</b>(keepalive).
<a name="52017"/>52017: 
<a name="has_support_sock_reuseaddr-0"/><a name="52018"/>52018: <b>has_support_sock_reuseaddr</b>() -&gt;
<a name="has_support_sock_reuseaddr-last_expr"/><a name="52019"/>52019: <b>    has_support_socket_option_sock</b>(reuseaddr).
<a name="52020"/>52020: 
<a name="has_support_sock_bsp_state-0"/><a name="52021"/>52021: <b>has_support_sock_bsp_state</b>() -&gt;
<a name="has_support_sock_bsp_state-last_expr"/><a name="52022"/>52022: <b>    has_support_socket_option_sock</b>(bsp_state).
<a name="52023"/>52023: 
<a name="has_support_sock_exclusiveaddruse-0"/><a name="52024"/>52024: <b>has_support_sock_exclusiveaddruse</b>() -&gt;
<a name="has_support_sock_exclusiveaddruse-last_expr"/><a name="52025"/>52025: <b>    has_support_socket_option_sock</b>(exclusiveaddruse).
<a name="52026"/>52026: 
<a name="has_support_sock_maxdg-0"/><a name="52027"/>52027: <b>has_support_sock_maxdg</b>() -&gt;
<a name="has_support_sock_maxdg-last_expr"/><a name="52028"/>52028: <b>    has_support_socket_option_sock</b>(maxdg).
<a name="52029"/>52029: 
<a name="has_support_sock_max_msg_size-0"/><a name="52030"/>52030: <b>has_support_sock_max_msg_size</b>() -&gt;
<a name="has_support_sock_max_msg_size-last_expr"/><a name="52031"/>52031: <b>    has_support_socket_option_sock</b>(max_msg_size).
<a name="52032"/>52032: 
<a name="has_support_sock_oobinline-0"/><a name="52033"/>52033: <b>has_support_sock_oobinline</b>() -&gt;
<a name="has_support_sock_oobinline-last_expr"/><a name="52034"/>52034: <b>    has_support_socket_option_sock</b>(oobinline).
<a name="52035"/>52035: 
<a name="has_support_sock_passcred-0"/><a name="52036"/>52036: <b>has_support_sock_passcred</b>() -&gt;
<a name="has_support_sock_passcred-last_expr"/><a name="52037"/>52037: <b>    has_support_socket_option_sock</b>(passcred).
<a name="52038"/>52038: 
<a name="has_support_sock_peek_off-0"/><a name="52039"/>52039: <b>has_support_sock_peek_off</b>() -&gt;
<a name="has_support_sock_peek_off-last_expr"/><a name="52040"/>52040: <b>    has_support_socket_option_sock</b>(peek_off).
<a name="52041"/>52041: 
<a name="has_support_sock_peercred-0"/><a name="52042"/>52042: <b>has_support_sock_peercred</b>() -&gt;
<a name="has_support_sock_peercred-last_expr"/><a name="52043"/>52043: <b>    has_support_socket_option_sock</b>(peercred).
<a name="52044"/>52044: 
<a name="has_support_sock_priority-0"/><a name="52045"/>52045: <b>has_support_sock_priority</b>() -&gt;
<a name="has_support_sock_priority-last_expr"/><a name="52046"/>52046: <b>    has_support_socket_option_sock</b>(priority).
<a name="52047"/>52047: 
<a name="has_support_sock_rcvbuf-0"/><a name="52048"/>52048: <b>has_support_sock_rcvbuf</b>() -&gt;
<a name="has_support_sock_rcvbuf-last_expr"/><a name="52049"/>52049: <b>    has_support_socket_option_sock</b>(rcvbuf).
<a name="52050"/>52050: 
<a name="has_support_sock_rcvlowat-0"/><a name="52051"/>52051: <b>has_support_sock_rcvlowat</b>() -&gt;
<a name="has_support_sock_rcvlowat-last_expr"/><a name="52052"/>52052: <b>    has_support_socket_option_sock</b>(rcvlowat).
<a name="52053"/>52053: 
<a name="has_support_sock_rcvtimeo-0"/><a name="52054"/>52054: <b>has_support_sock_rcvtimeo</b>() -&gt;
<a name="has_support_sock_rcvtimeo-last_expr"/><a name="52055"/>52055: <b>    has_support_socket_option_sock</b>(rcvtimeo).
<a name="52056"/>52056: 
<a name="has_support_sock_sndbuf-0"/><a name="52057"/>52057: <b>has_support_sock_sndbuf</b>() -&gt;
<a name="has_support_sock_sndbuf-last_expr"/><a name="52058"/>52058: <b>    has_support_socket_option_sock</b>(sndbuf).
<a name="52059"/>52059: 
<a name="has_support_sock_sndlowat-0"/><a name="52060"/>52060: <b>has_support_sock_sndlowat</b>() -&gt;
<a name="has_support_sock_sndlowat-last_expr"/><a name="52061"/>52061: <b>    has_support_socket_option_sock</b>(sndlowat).
<a name="52062"/>52062: 
<a name="has_support_sock_sndtimeo-0"/><a name="52063"/>52063: <b>has_support_sock_sndtimeo</b>() -&gt;
<a name="has_support_sock_sndtimeo-last_expr"/><a name="52064"/>52064: <b>    has_support_socket_option_sock</b>(sndtimeo).
<a name="52065"/>52065: 
<a name="has_support_sock_timestamp-0"/><a name="52066"/>52066: <b>has_support_sock_timestamp</b>() -&gt;
<a name="has_support_sock_timestamp-last_expr"/><a name="52067"/>52067: <b>    has_support_socket_option_sock</b>(timestamp).
<a name="52068"/>52068: 
<a name="52069"/>52069: 
<a name="52070"/>52070: <i>%% --- IP socket option test functions ---</i>
<a name="52071"/>52071: 
<a name="has_support_ip_add_membership-0"/><a name="52072"/>52072: <b>has_support_ip_add_membership</b>() -&gt;
<a name="has_support_ip_add_membership-last_expr"/><a name="52073"/>52073: <b>    has_support_socket_option_ip</b>(add_membership).
<a name="52074"/>52074: 
<a name="has_support_ip_drop_membership-0"/><a name="52075"/>52075: <b>has_support_ip_drop_membership</b>() -&gt;
<a name="has_support_ip_drop_membership-last_expr"/><a name="52076"/>52076: <b>    has_support_socket_option_ip</b>(drop_membership).
<a name="52077"/>52077: 
<a name="has_support_ip_pktinfo-0"/><a name="52078"/>52078: <b>has_support_ip_pktinfo</b>() -&gt;
<a name="has_support_ip_pktinfo-last_expr"/><a name="52079"/>52079: <b>    has_support_socket_option_ip</b>(pktinfo).
<a name="52080"/>52080: 
<a name="has_support_ip_recvopts-0"/><a name="52081"/>52081: <b>has_support_ip_recvopts</b>() -&gt;
<a name="has_support_ip_recvopts-last_expr"/><a name="52082"/>52082: <b>    has_support_socket_option_ip</b>(recvopts).
<a name="52083"/>52083: 
<a name="has_support_ip_recvorigdstaddr-0"/><a name="52084"/>52084: <b>has_support_ip_recvorigdstaddr</b>() -&gt;
<a name="has_support_ip_recvorigdstaddr-last_expr"/><a name="52085"/>52085: <b>    has_support_socket_option_ip</b>(recvorigdstaddr).
<a name="52086"/>52086: 
<a name="has_support_ip_recvtos-0"/><a name="52087"/>52087: <b>has_support_ip_recvtos</b>() -&gt;
<a name="has_support_ip_recvtos-last_expr"/><a name="52088"/>52088: <b>    has_support_socket_option_ip</b>(recvtos).
<a name="52089"/>52089: 
<a name="has_support_ip_recvtos_and_or_sock_timestamp-0"/><a name="52090"/>52090: <b>has_support_ip_recvtos_and_or_sock_timestamp</b>() -&gt;
<a name="has_support_ip_recvtos_and_or_sock_timestamp-last_expr"/><a name="52091"/>52091: <b>    case </b>(socket:is_supported(options, ip, recvtos) orelse 
<a name="52092"/>52092:           socket:is_supported(options, socket, timestamp)) of
<a name="52093"/>52093:         true -&gt;
<a name="52094"/>52094:             ok;
<a name="52095"/>52095:         false -&gt;
<a name="52096"/>52096:             skip(?F(&quot;Neither needed opts &quot;
<a name="52097"/>52097:                     &quot;ip:recvtos or socket:timestamp supported&quot;, []))
<a name="52098"/>52098:     end.
<a name="52099"/>52099: 
<a name="has_support_ip_recvttl-0"/><a name="52100"/>52100: <b>has_support_ip_recvttl</b>() -&gt;
<a name="has_support_ip_recvttl-last_expr"/><a name="52101"/>52101: <b>    has_support_socket_option_ip</b>(recvttl).
<a name="52102"/>52102: 
<a name="has_support_ip_tos-0"/><a name="52103"/>52103: <b>has_support_ip_tos</b>() -&gt;
<a name="has_support_ip_tos-last_expr"/><a name="52104"/>52104: <b>    has_support_socket_option_ip</b>(tos).
<a name="52105"/>52105: 
<a name="has_support_ip_recverr-0"/><a name="52106"/>52106: <b>has_support_ip_recverr</b>() -&gt;
<a name="has_support_ip_recverr-last_expr"/><a name="52107"/>52107: <b>    has_support_socket_option_ip</b>(recverr).
<a name="52108"/>52108: 
<a name="52109"/>52109: 
<a name="52110"/>52110: <i>%% --- IPv6 socket option test functions ---</i>
<a name="52111"/>52111: 
<a name="has_support_ipv6_flowinfo-0"/><a name="52112"/>52112: <b>has_support_ipv6_flowinfo</b>() -&gt;
<a name="has_support_ipv6_flowinfo-last_expr"/><a name="52113"/>52113: <b>    has_support_socket_option_ipv6</b>(flowinfo).
<a name="52114"/>52114: 
<a name="has_support_ipv6_hoplimit_or_recvhoplimit-0"/><a name="52115"/>52115: <b>has_support_ipv6_hoplimit_or_recvhoplimit</b>() -&gt;
<a name="52116"/>52116:     %% case (socket:is_supported(options, ipv6, recvhoplimit) orelse
<a name="52117"/>52117:     %%       socket:is_supported(options, ipv6, hoplimit)) of
<a name="has_support_ipv6_hoplimit_or_recvhoplimit-last_expr"/><a name="52118"/>52118: <b>    case is_any_options_supported</b>([{ipv6, recvhoplimit}, {ipv6, hoplimit}]) of
<a name="52119"/>52119: 	true -&gt;
<a name="52120"/>52120: 	    ok;
<a name="52121"/>52121: 	false -&gt;
<a name="52122"/>52122: 	    skip(?F(&quot;Neither recvhoplimit or hoplimit supported&quot;, []))
<a name="52123"/>52123:     end.
<a name="52124"/>52124: 
<a name="has_support_ipv6_recvpktinfo-0"/><a name="52125"/>52125: <b>has_support_ipv6_recvpktinfo</b>() -&gt;
<a name="has_support_ipv6_recvpktinfo-last_expr"/><a name="52126"/>52126: <b>    has_support_socket_option_ipv6</b>(recvpktinfo).
<a name="52127"/>52127: 
<a name="52128"/>52128: 
<a name="has_support_ipv6_tclass_or_recvtclass-0"/><a name="52129"/>52129: <b>has_support_ipv6_tclass_or_recvtclass</b>() -&gt;
<a name="has_support_ipv6_tclass_or_recvtclass-last_expr"/><a name="52130"/>52130: <b>    case is_any_options_supported</b>([{ipv6, recvtclass}, {ipv6, tclass}]) of
<a name="52131"/>52131: 	true -&gt;
<a name="52132"/>52132: 	    ok;
<a name="52133"/>52133: 	false -&gt;
<a name="52134"/>52134: 	    skip(?F(&quot;Neither recvtclass or tclass supported&quot;, []))
<a name="52135"/>52135:     end.
<a name="52136"/>52136: 
<a name="52137"/>52137: 
<a name="has_support_ipv6_recverr-0"/><a name="52138"/>52138: <b>has_support_ipv6_recverr</b>() -&gt;
<a name="has_support_ipv6_recverr-last_expr"/><a name="52139"/>52139: <b>    has_support_socket_option_ipv6</b>(recverr).
<a name="52140"/>52140: 
<a name="52141"/>52141: 
<a name="52142"/>52142: <i>%% --- TCP socket option test functions ---</i>
<a name="52143"/>52143: 
<a name="has_support_tcp_congestion-0"/><a name="52144"/>52144: <b>has_support_tcp_congestion</b>() -&gt;
<a name="has_support_tcp_congestion-last_expr"/><a name="52145"/>52145: <b>    has_support_socket_option_tcp</b>(congestion).
<a name="52146"/>52146: 
<a name="has_support_tcp_cork-0"/><a name="52147"/>52147: <b>has_support_tcp_cork</b>() -&gt;
<a name="has_support_tcp_cork-last_expr"/><a name="52148"/>52148: <b>    has_support_socket_option_tcp</b>(cork).
<a name="52149"/>52149: 
<a name="has_support_tcp_maxseg-0"/><a name="52150"/>52150: <b>has_support_tcp_maxseg</b>() -&gt;
<a name="has_support_tcp_maxseg-last_expr"/><a name="52151"/>52151: <b>    has_support_socket_option_tcp</b>(maxseg).
<a name="52152"/>52152: 
<a name="has_support_tcp_nodelay-0"/><a name="52153"/>52153: <b>has_support_tcp_nodelay</b>() -&gt;
<a name="has_support_tcp_nodelay-last_expr"/><a name="52154"/>52154: <b>    has_support_socket_option_tcp</b>(nodelay).
<a name="52155"/>52155: 
<a name="has_support_tcp_keepcnt-0"/><a name="52156"/>52156: <b>has_support_tcp_keepcnt</b>() -&gt;
<a name="has_support_tcp_keepcnt-last_expr"/><a name="52157"/>52157: <b>    has_support_socket_option_tcp</b>(keepcnt).
<a name="52158"/>52158: 
<a name="has_support_tcp_keepidle-0"/><a name="52159"/>52159: <b>has_support_tcp_keepidle</b>() -&gt;
<a name="has_support_tcp_keepidle-last_expr"/><a name="52160"/>52160: <b>    has_support_socket_option_tcp</b>(keepidle).
<a name="52161"/>52161: 
<a name="has_support_tcp_keepintvl-0"/><a name="52162"/>52162: <b>has_support_tcp_keepintvl</b>() -&gt;
<a name="has_support_tcp_keepintvl-last_expr"/><a name="52163"/>52163: <b>    has_support_socket_option_tcp</b>(keepintvl).
<a name="52164"/>52164: 
<a name="52165"/>52165: 
<a name="52166"/>52166: <i>%% --- UDP socket option test functions ---</i>
<a name="52167"/>52167: 
<a name="has_support_udp_cork-0"/><a name="52168"/>52168: <b>has_support_udp_cork</b>() -&gt;
<a name="has_support_udp_cork-last_expr"/><a name="52169"/>52169: <b>    has_support_socket_option_udp</b>(cork).
<a name="52170"/>52170: 
<a name="52171"/>52171: 
<a name="52172"/>52172: <i>%% --- General purpose socket option test functions ---</i>
<a name="52173"/>52173: 
<a name="has_support_socket_option_sock-1"/><a name="52174"/>52174: <b>has_support_socket_option_sock</b>(Opt) -&gt;
<a name="has_support_socket_option_sock-last_expr"/><a name="52175"/>52175: <b>    has_support_socket_option</b>(socket, Opt).
<a name="52176"/>52176: 
<a name="has_support_socket_option_ip-1"/><a name="52177"/>52177: <b>has_support_socket_option_ip</b>(Opt) -&gt;
<a name="has_support_socket_option_ip-last_expr"/><a name="52178"/>52178: <b>    has_support_socket_option</b>(ip, Opt).
<a name="52179"/>52179: 
<a name="has_support_socket_option_ipv6-1"/><a name="52180"/>52180: <b>has_support_socket_option_ipv6</b>(Opt) -&gt;
<a name="has_support_socket_option_ipv6-last_expr"/><a name="52181"/>52181: <b>    has_support_socket_option</b>(ipv6, Opt).
<a name="52182"/>52182: 
<a name="has_support_socket_option_tcp-1"/><a name="52183"/>52183: <b>has_support_socket_option_tcp</b>(Opt) -&gt;
<a name="has_support_socket_option_tcp-last_expr"/><a name="52184"/>52184: <b>    has_support_socket_option</b>(tcp, Opt).
<a name="52185"/>52185: 
<a name="has_support_socket_option_udp-1"/><a name="52186"/>52186: <b>has_support_socket_option_udp</b>(Opt) -&gt;
<a name="has_support_socket_option_udp-last_expr"/><a name="52187"/>52187: <b>    has_support_socket_option</b>(udp, Opt).
<a name="52188"/>52188: 
<a name="52189"/>52189: 
<a name="has_support_socket_option-2"/><a name="52190"/>52190: <b>has_support_socket_option</b>(Level, Option) -&gt;
<a name="has_support_socket_option-last_expr"/><a name="52191"/>52191: <b>    case socket:is_supported</b>(options, Level, Option) of
<a name="52192"/>52192:         true -&gt;
<a name="52193"/>52193:             ok;
<a name="52194"/>52194:         false -&gt;
<a name="52195"/>52195:             skip(?F(&quot;Not Supported: ~w option ~w&quot;, [Level, Option]))
<a name="52196"/>52196:     end.
<a name="52197"/>52197: 
<a name="is_any_options_supported-1"/><a name="52198"/>52198: <b>is_any_options_supported</b>(Options) -&gt;
<a name="52199"/>52199:     Pred = fun({Level, Option}) -&gt; socket:is_supported(options, Level, Option) end,
<a name="is_any_options_supported-last_expr"/><a name="52200"/>52200: <b>    lists:any</b>(Pred, Options).
<a name="52201"/>52201: 
<a name="52202"/>52202: 
<a name="52203"/>52203: <i>%% --- Send flag test functions ---</i>
<a name="52204"/>52204: 
<a name="has_support_msg_flag-1"/><a name="52205"/>52205: <b>has_support_msg_flag</b>(Flag) -&gt;
<a name="has_support_msg_flag-last_expr"/><a name="52206"/>52206: <b>    case socket:is_supported</b>(msg_flags, Flag) of
<a name="52207"/>52207:         true -&gt;
<a name="52208"/>52208:             ok;
<a name="52209"/>52209:         false -&gt;
<a name="52210"/>52210:             skip(?F(&quot;Message flag ~w *Not* Supported&quot;, [Flag]))
<a name="52211"/>52211:     end.
<a name="52212"/>52212: 
<a name="52213"/>52213: 
<a name="52214"/>52214: <i>%% Checks that the version is &quot;good enough&quot; (of the specified platform).</i>
<a name="52215"/>52215: 
<a name="is_good_enough_linux-1"/><a name="52216"/>52216: <b>is_good_enough_linux</b>(CondVsn) -&gt;
<a name="is_good_enough_linux-last_expr"/><a name="52217"/>52217: <b>    is_good_enough_platform</b>(unix, linux, CondVsn).
<a name="52218"/>52218: 
<a name="is_good_enough_darwin-1"/><a name="52219"/>52219: <b>is_good_enough_darwin</b>(CondVsn) -&gt;
<a name="is_good_enough_darwin-last_expr"/><a name="52220"/>52220: <b>    is_good_enough_platform</b>(unix, darwin, CondVsn).
<a name="52221"/>52221: 
<a name="is_good_enough_montavista-1"/><a name="52222"/>52222: <b>is_good_enough_montavista</b>(_Vsn) -&gt;
<a name="52223"/>52223:     %% We have *one* old M, which have kernel version 2.6.10.
<a name="52224"/>52224:     %% So if its that kernel version, we only need to check
<a name="52225"/>52225:     %% if its M (no need to figure out the version of M).
<a name="is_good_enough_montavista-last_expr"/><a name="52226"/>52226: <b>    case os:type</b>() of
<a name="52227"/>52227:         {unix, linux} -&gt;
<a name="52228"/>52228:             case os:version() of
<a name="52229"/>52229:                 {2,6,10} -&gt;
<a name="52230"/>52230:                     case string:trim(os:cmd(&quot;cat /etc/issue&quot;)) of
<a name="52231"/>52231:                         &quot;MontaVista&quot; ++ _ = V -&gt; % Stone age MontaVista =&gt; Skip
<a name="52232"/>52232:                             skip(V);
<a name="52233"/>52233:                         _ -&gt;
<a name="52234"/>52234:                             ok
<a name="52235"/>52235:                     end;
<a name="52236"/>52236:                 _ -&gt;
<a name="52237"/>52237:                     ok
<a name="52238"/>52238:             end;
<a name="52239"/>52239:         _ -&gt;
<a name="52240"/>52240:             ok
<a name="52241"/>52241:     end.
<a name="52242"/>52242:                     
<a name="52243"/>52243: 
<a name="is_good_enough_platform-3"/><a name="52244"/>52244: <b>is_good_enough_platform</b>(Family, Name, CondVsn) -&gt;
<a name="is_good_enough_platform-last_expr"/><a name="52245"/>52245: <b>    case os:type</b>() of
<a name="52246"/>52246: 	{Family, Name} -&gt;
<a name="52247"/>52247: 	    ID = fun() -&gt; ?F(&quot;~w:~w&quot;, [Family, Name]) end,
<a name="52248"/>52248: 	    is_good_enough_platform2(os:version(), CondVsn, ID);
<a name="52249"/>52249: 	_ -&gt;
<a name="52250"/>52250: 	    ok
<a name="52251"/>52251:     end.
<a name="52252"/>52252: 
<a name="is_good_enough_platform2-3"/><a name="52253"/>52253: <b>is_good_enough_platform2</b>(Vsn, CondVsn, _) when (Vsn &gt; CondVsn) -&gt;
<a name="52254"/>52254:     ok;
<a name="52255"/>52255: <b>is_good_enough_platform2</b>(Vsn, CondVsn, ID) -&gt;
<a name="is_good_enough_platform2-last_expr"/><a name="52256"/>52256: <b>    skip</b>(?F(&quot;Not 'good enough' ~s (~p &lt;= ~p)&quot;, [ID(), Vsn, CondVsn])).
<a name="52257"/>52257: 
<a name="is_not_freebsd-0"/><a name="52258"/>52258: <b>is_not_freebsd</b>() -&gt;
<a name="is_not_freebsd-last_expr"/><a name="52259"/>52259: <b>    is_not_platform</b>(freebsd, &quot;FreeBSD&quot;).
<a name="52260"/>52260: 
<a name="is_not_openbsd-0"/><a name="52261"/>52261: <b>is_not_openbsd</b>() -&gt;
<a name="is_not_openbsd-last_expr"/><a name="52262"/>52262: <b>    is_not_platform</b>(openbsd, &quot;OpenBSD&quot;).
<a name="52263"/>52263: 
<a name="is_not_netbsd-0"/><a name="52264"/>52264: <b>is_not_netbsd</b>() -&gt;
<a name="is_not_netbsd-last_expr"/><a name="52265"/>52265: <b>    is_not_platform</b>(netbsd, &quot;NetBSD&quot;).
<a name="52266"/>52266: 
<a name="is_not_darwin-0"/><a name="52267"/>52267: <b>is_not_darwin</b>() -&gt;
<a name="is_not_darwin-last_expr"/><a name="52268"/>52268: <b>    is_not_platform</b>(darwin, &quot;Darwin&quot;).
<a name="52269"/>52269: 
<a name="is_not_windows-0"/><a name="52270"/>52270: <b>is_not_windows</b>() -&gt;
<a name="is_not_windows-last_expr"/><a name="52271"/>52271: <b>    case os:type</b>() of
<a name="52272"/>52272:         {win32, nt} -&gt;
<a name="52273"/>52273:             skip(&quot;This does not work on Windows&quot;);
<a name="52274"/>52274:         _ -&gt;
<a name="52275"/>52275:             ok
<a name="52276"/>52276:     end.
<a name="52277"/>52277: 
<a name="is_not_platform-2"/><a name="52278"/>52278: <b>is_not_platform</b>(Platform, PlatformStr)
<a name="52279"/>52279:   when is_atom(Platform) andalso is_list(PlatformStr) -&gt;
<a name="is_not_platform-last_expr"/><a name="52280"/>52280: <b>      case os:type</b>() of
<a name="52281"/>52281:           {unix, Platform} -&gt;
<a name="52282"/>52282:               skip(&quot;This does not work on &quot; ++ PlatformStr);
<a name="52283"/>52283:         _ -&gt;
<a name="52284"/>52284:             ok
<a name="52285"/>52285:     end.
<a name="52286"/>52286:   
<a name="52287"/>52287: 
<a name="unix_domain_socket_host_cond-0"/><a name="52288"/>52288: <b>unix_domain_socket_host_cond</b>() -&gt;
<a name="unix_domain_socket_host_cond-last_expr"/><a name="52289"/>52289: <b>    unix_domain_socket_host_cond</b>(os:type(), os:version()).
<a name="52290"/>52290: 
<a name="unix_domain_socket_host_cond-2"/><a name="52291"/>52291: <b>unix_domain_socket_host_cond</b>({unix, linux}, {M, _, _}) when (M &lt; 3) -&gt;
<a name="52292"/>52292:     skip(&quot;TC may not work on this version&quot;);
<a name="52293"/>52293: <b>unix_domain_socket_host_cond</b>(_, _) -&gt;
<a name="unix_domain_socket_host_cond-last_expr"/><a name="52294"/>52294:     ok.
<a name="52295"/>52295: 
<a name="has_support_unix_domain_socket-0"/><a name="52296"/>52296: <b>has_support_unix_domain_socket</b>() -&gt;
<a name="has_support_unix_domain_socket-last_expr"/><a name="52297"/>52297: <b>    case socket:is_supported</b>(local) of
<a name="52298"/>52298: 	true -&gt;
<a name="52299"/>52299: 	    ok;
<a name="52300"/>52300: 	false -&gt;
<a name="52301"/>52301: 	    skip(&quot;Not supported&quot;)
<a name="52302"/>52302:     end.
<a name="52303"/>52303: 
<a name="has_support_sctp-0"/><a name="52304"/>52304: <b>has_support_sctp</b>() -&gt;
<a name="has_support_sctp-last_expr"/><a name="52305"/>52305: <b>    case os:type</b>() of
<a name="52306"/>52306:         {win32, _} -&gt;
<a name="52307"/>52307:             skip(&quot;Not supported&quot;);
<a name="52308"/>52308:         {unix, netbsd} -&gt;
<a name="52309"/>52309:             %% XXX We will have to investigate this later...
<a name="52310"/>52310:             skip(&quot;Not supported&quot;);
<a name="52311"/>52311:         _ -&gt;
<a name="52312"/>52312:             case socket:is_supported(sctp) of
<a name="52313"/>52313:                 true -&gt;
<a name="52314"/>52314:                     ok;
<a name="52315"/>52315:                 false -&gt;
<a name="52316"/>52316:                     skip(&quot;Not supported&quot;)
<a name="52317"/>52317:             end
<a name="52318"/>52318:     end.
<a name="52319"/>52319: 
<a name="52320"/>52320: 
<a name="52321"/>52321: <i>%% The idea is that this function shall test if the test host has </i>
<a name="52322"/>52322: <i>%% support for IPv4 or IPv6. If not, there is no point in running corresponding tests.</i>
<a name="52323"/>52323: <i>%% Currently we just skip.</i>
<a name="has_support_ipv4-0"/><a name="52324"/>52324: <b>has_support_ipv4</b>() -&gt;
<a name="has_support_ipv4-last_expr"/><a name="52325"/>52325: <b>    ?KLIB:has_support_ipv4</b>().
<a name="52326"/>52326: 
<a name="has_support_ipv6-0"/><a name="52327"/>52327: <b>has_support_ipv6</b>() -&gt;
<a name="has_support_ipv6-last_expr"/><a name="52328"/>52328: <b>    ?KLIB:has_support_ipv6</b>().
<a name="52329"/>52329: 
<a name="inet_or_inet6-0"/><a name="52330"/>52330: <b>inet_or_inet6</b>() -&gt;
<a name="inet_or_inet6-last_expr"/><a name="52331"/>52331:     try
<a name="52332"/>52332:         has_support_ipv4(),
<a name="52333"/>52333:         inet
<a name="52334"/>52334:     catch
<a name="52335"/>52335:         throw:{skip, _Reason} -&gt;
<a name="52336"/>52336:             has_support_ipv6(),
<a name="52337"/>52337:             inet6
<a name="52338"/>52338:     end.
<a name="52339"/>52339: 
<a name="has_support_sendfile-0"/><a name="52340"/>52340: <b>has_support_sendfile</b>() -&gt;
<a name="has_support_sendfile-last_expr"/><a name="52341"/>52341: <b>    try socket:is_supported</b>(sendfile) of
<a name="52342"/>52342:         true -&gt;
<a name="52343"/>52343:             ok;
<a name="52344"/>52344:         false -&gt;
<a name="52345"/>52345:             skip(&quot;Not supported: sendfile&quot;)
<a name="52346"/>52346:     catch
<a name="52347"/>52347:         error : notsup -&gt;
<a name="52348"/>52348:             skip(&quot;Not supported: socket&quot;)
<a name="52349"/>52349:     end.
<a name="52350"/>52350: 
<a name="52351"/>52351: 
<a name="has_support_net_if_names-0"/><a name="52352"/>52352: <b>has_support_net_if_names</b>() -&gt;
<a name="has_support_net_if_names-last_expr"/><a name="52353"/>52353: <b>    try net:if_names</b>() of
<a name="52354"/>52354:         {ok, N} when is_list(N) -&gt;
<a name="52355"/>52355:             ok;
<a name="52356"/>52356:         _ -&gt;
<a name="52357"/>52357:             skip(&quot;Not supported: net:if_names()&quot;)
<a name="52358"/>52358:     catch
<a name="52359"/>52359:         error : notsup -&gt;
<a name="52360"/>52360:             skip(&quot;Not supported: net&quot;)
<a name="52361"/>52361:     end.
<a name="52362"/>52362: 
<a name="has_support_ioctl_requests-0"/><a name="52363"/>52363: <b>has_support_ioctl_requests</b>() -&gt;
<a name="has_support_ioctl_requests-last_expr"/><a name="52364"/>52364: <b>    try socket:supports</b>(ioctl_requests) of
<a name="52365"/>52365:         Reqs when is_list(Reqs) -&gt;
<a name="52366"/>52366:             ok;
<a name="52367"/>52367:         _ -&gt;
<a name="52368"/>52368:             skip(&quot;Not supported: ioctl_requests&quot;)
<a name="52369"/>52369:     catch
<a name="52370"/>52370:         error : notsup -&gt;
<a name="52371"/>52371:             skip(&quot;Not supported: socket&quot;)
<a name="52372"/>52372:     end.
<a name="52373"/>52373: 
<a name="has_support_ioctl_gifconf-0"/><a name="52374"/>52374: <b>has_support_ioctl_gifconf</b>() -&gt;
<a name="has_support_ioctl_gifconf-last_expr"/><a name="52375"/>52375: <b>    has_support_ioctl_request</b>(gifconf).
<a name="52376"/>52376: 
<a name="has_support_ioctl_nread-0"/><a name="52377"/>52377: <b>has_support_ioctl_nread</b>() -&gt;
<a name="has_support_ioctl_nread-last_expr"/><a name="52378"/>52378: <b>    has_support_ioctl_request</b>(nread).
<a name="52379"/>52379: 
<a name="has_support_ioctl_gifname-0"/><a name="52380"/>52380: <b>has_support_ioctl_gifname</b>() -&gt;
<a name="has_support_ioctl_gifname-last_expr"/><a name="52381"/>52381: <b>    has_support_ioctl_request</b>(gifname).
<a name="52382"/>52382: 
<a name="has_support_ioctl_gifindex-0"/><a name="52383"/>52383: <b>has_support_ioctl_gifindex</b>() -&gt;
<a name="has_support_ioctl_gifindex-last_expr"/><a name="52384"/>52384: <b>    has_support_ioctl_request</b>(gifindex).
<a name="52385"/>52385: 
<a name="has_support_ioctl_gifaddr-0"/><a name="52386"/>52386: <b>has_support_ioctl_gifaddr</b>() -&gt;
<a name="has_support_ioctl_gifaddr-last_expr"/><a name="52387"/>52387: <b>    has_support_ioctl_request</b>(gifaddr).
<a name="52388"/>52388: 
<a name="has_support_ioctl_gifdstaddr-0"/><a name="52389"/>52389: <b>has_support_ioctl_gifdstaddr</b>() -&gt;
<a name="has_support_ioctl_gifdstaddr-last_expr"/><a name="52390"/>52390: <b>    has_support_ioctl_request</b>(gifdstaddr).
<a name="52391"/>52391: 
<a name="has_support_ioctl_gifbrdaddr-0"/><a name="52392"/>52392: <b>has_support_ioctl_gifbrdaddr</b>() -&gt;
<a name="has_support_ioctl_gifbrdaddr-last_expr"/><a name="52393"/>52393: <b>    has_support_ioctl_request</b>(gifbrdaddr).
<a name="52394"/>52394: 
<a name="has_support_ioctl_gifnetmask-0"/><a name="52395"/>52395: <b>has_support_ioctl_gifnetmask</b>() -&gt;
<a name="has_support_ioctl_gifnetmask-last_expr"/><a name="52396"/>52396: <b>    has_support_ioctl_request</b>(gifnetmask).
<a name="52397"/>52397: 
<a name="has_support_ioctl_gifmtu-0"/><a name="52398"/>52398: <b>has_support_ioctl_gifmtu</b>() -&gt;
<a name="has_support_ioctl_gifmtu-last_expr"/><a name="52399"/>52399: <b>    has_support_ioctl_request</b>(gifmtu).
<a name="52400"/>52400: 
<a name="has_support_ioctl_gifhwaddr-0"/><a name="52401"/>52401: <b>has_support_ioctl_gifhwaddr</b>() -&gt;
<a name="has_support_ioctl_gifhwaddr-last_expr"/><a name="52402"/>52402: <b>    has_support_ioctl_request</b>(gifhwaddr).
<a name="52403"/>52403: 
<a name="has_support_ioctl_giftxqlen-0"/><a name="52404"/>52404: <b>has_support_ioctl_giftxqlen</b>() -&gt;
<a name="has_support_ioctl_giftxqlen-last_expr"/><a name="52405"/>52405: <b>    has_support_ioctl_request</b>(giftxqlen).
<a name="52406"/>52406: 
<a name="has_support_ioctl_gifflags-0"/><a name="52407"/>52407: <b>has_support_ioctl_gifflags</b>() -&gt;
<a name="has_support_ioctl_gifflags-last_expr"/><a name="52408"/>52408: <b>    has_support_ioctl_request</b>(gifflags).
<a name="52409"/>52409: 
<a name="has_support_ioctl_gifmap-0"/><a name="52410"/>52410: <b>has_support_ioctl_gifmap</b>() -&gt;
<a name="has_support_ioctl_gifmap-last_expr"/><a name="52411"/>52411: <b>    has_support_ioctl_request</b>(gifmap).
<a name="52412"/>52412: 
<a name="has_support_ioctl_tcp_info-0"/><a name="52413"/>52413: <b>has_support_ioctl_tcp_info</b>() -&gt;
<a name="has_support_ioctl_tcp_info-last_expr"/><a name="52414"/>52414: <b>    has_support_ioctl_request</b>(tcp_info).
<a name="52415"/>52415: 
<a name="has_support_ioctl_request-1"/><a name="52416"/>52416: <b>has_support_ioctl_request</b>(Req) when is_atom(Req) -&gt;
<a name="has_support_ioctl_request-last_expr"/><a name="52417"/>52417: <b>    try socket:is_supported</b>(ioctl_requests, Req) of
<a name="52418"/>52418:         true -&gt;
<a name="52419"/>52419:             ok;
<a name="52420"/>52420:         false -&gt;
<a name="52421"/>52421:             skip(f(&quot;Not supported: ioctl_request: ~w&quot;, [Req]))
<a name="52422"/>52422:     catch
<a name="52423"/>52423:         error : notsup -&gt;
<a name="52424"/>52424:             skip(&quot;Not supported: socket&quot;)
<a name="52425"/>52425:     end.
<a name="52426"/>52426: 
<a name="52427"/>52427: 
<a name="52428"/>52428: <i>%% has_support_ioctl_flags() -&gt;</i>
<a name="52429"/>52429: <i>%%     try socket:supports(ioctl_flags) of</i>
<a name="52430"/>52430: <i>%%         Reqs when is_list(Reqs) -&gt;</i>
<a name="52431"/>52431: <i>%%             ok;</i>
<a name="52432"/>52432: <i>%%         _ -&gt;</i>
<a name="52433"/>52433: <i>%%             skip(&quot;Not supported: ioctl_flags&quot;)</i>
<a name="52434"/>52434: <i>%%     catch</i>
<a name="52435"/>52435: <i>%%         error : notsup -&gt;</i>
<a name="52436"/>52436: <i>%%             skip(&quot;Not supported: socket&quot;)</i>
<a name="52437"/>52437: <i>%%     end.</i>
<a name="52438"/>52438: 
<a name="52439"/>52439: 
<a name="52440"/>52440: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="52441"/>52441: 
<a name="unlink_path-1"/><a name="52442"/>52442: <b>unlink_path</b>(Path) -&gt;
<a name="unlink_path-last_expr"/><a name="52443"/>52443: <b>    unlink_path</b>(Path, fun() -&gt; ok end, fun() -&gt; ok end).
<a name="52444"/>52444: 
<a name="unlink_path-3"/><a name="52445"/>52445: <b>unlink_path</b>(Path, Success, Failure)
<a name="52446"/>52446:   when is_function(Success, 0), is_function(Failure, 0) -&gt;
<a name="unlink_path-last_expr"/><a name="52447"/>52447:     case Path of
<a name="52448"/>52448:         undefined -&gt;
<a name="52449"/>52449:             ?SEV_IPRINT(&quot;not a path to unlink&quot;),
<a name="52450"/>52450:                     Success();
<a name="52451"/>52451:         _ -&gt;
<a name="52452"/>52452:             ?SEV_IPRINT(&quot;try unlink path: &quot;
<a name="52453"/>52453:                         &quot;~n   ~s&quot;, [Path]),
<a name="52454"/>52454:             case file:delete(Path) of
<a name="52455"/>52455:                 ok -&gt;
<a name="52456"/>52456:                     ?SEV_IPRINT(&quot;path unlinked: &quot;
<a name="52457"/>52457:                                 &quot;~n   Path: ~s&quot;, [Path]),
<a name="52458"/>52458:                     Success();
<a name="52459"/>52459:                 Error -&gt;
<a name="52460"/>52460:                     ?SEV_EPRINT(&quot;unlink failed: &quot;
<a name="52461"/>52461:                                 &quot;~n   Path: ~s&quot;
<a name="52462"/>52462:                                 &quot;~n   Res:  ~p&quot;, [Path, Error]),
<a name="52463"/>52463:                     Failure()
<a name="52464"/>52464:             end
<a name="52465"/>52465:     end.
<a name="52466"/>52466: 
<a name="52467"/>52467: 
<a name="52468"/>52468: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="52469"/>52469: 
<a name="not_supported-1"/><a name="52470"/>52470: <b>not_supported</b>(What) -&gt;
<a name="not_supported-last_expr"/><a name="52471"/>52471: <b>    skip</b>({not_supported, What}).
<a name="52472"/>52472: 
<a name="not_yet_implemented-0"/><a name="52473"/>52473: <b>not_yet_implemented</b>() -&gt;
<a name="not_yet_implemented-last_expr"/><a name="52474"/>52474: <b>    skip</b>(&quot;not yet implemented&quot;).
<a name="52475"/>52475: 
<a name="skip-1"/><a name="52476"/>52476: <b>skip</b>(Reason) -&gt;
<a name="skip-last_expr"/><a name="52477"/>52477: <b>    throw</b>({skip, Reason}).
<a name="52478"/>52478: 
<a name="52479"/>52479: 
<a name="52480"/>52480: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="52481"/>52481: 
<a name="lookup-3"/><a name="52482"/>52482: <b>lookup</b>(Key, Default, Config) -&gt;
<a name="lookup-last_expr"/><a name="52483"/>52483: <b>    case lists:keysearch</b>(Key, 1, Config) of
<a name="52484"/>52484:         {value, {Key, Value}} -&gt;
<a name="52485"/>52485:             Value;
<a name="52486"/>52486:         _ -&gt;
<a name="52487"/>52487:             Default
<a name="52488"/>52488:     end.
<a name="52489"/>52489: 
<a name="52490"/>52490: 
<a name="52491"/>52491: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="52492"/>52492: 
<a name="t-0"/><a name="52493"/>52493: <b>t</b>() -&gt;
<a name="t-last_expr"/><a name="52494"/>52494: <b>    ts</b>(ms).
<a name="52495"/>52495: 
<a name="ts-1"/><a name="52496"/>52496: <b>ts</b>(ms) -&gt;
<a name="ts-last_expr"/><a name="52497"/>52497: <b>    erlang:monotonic_time</b>(milli_seconds).
<a name="52498"/>52498: 
<a name="tdiff-2"/><a name="52499"/>52499: <b>tdiff</b>({A1, B1, C1} = _T1x, {A2, B2, C2} = _T2x) -&gt;
<a name="52500"/>52500:     T1 = A1*1000000000+B1*1000+(C1 div 1000), 
<a name="52501"/>52501:     T2 = A2*1000000000+B2*1000+(C2 div 1000), 
<a name="tdiff-last_expr"/><a name="52502"/>52502:     T2 - T1.
<a name="52503"/>52503: 
<a name="52504"/>52504: 
<a name="formated_timestamp-0"/><a name="52505"/>52505: <b>formated_timestamp</b>() -&gt;
<a name="formated_timestamp-last_expr"/><a name="52506"/>52506: <b>    format_timestamp</b>(os:timestamp()).
<a name="52507"/>52507: 
<a name="format_timestamp-1"/><a name="52508"/>52508: <b>format_timestamp</b>({_N1, _N2, _N3} = TS) -&gt;
<a name="52509"/>52509:     {_Date, Time}   = calendar:now_to_local_time(TS),
<a name="52510"/>52510:     %% {YYYY,MM,DD}   = Date,
<a name="52511"/>52511:     {Hour,Min,Sec} = Time,
<a name="52512"/>52512:     %% FormatTS = 
<a name="52513"/>52513:     %%     io_lib:format(&quot;~.4w-~.2.0w-~.2.0w ~.2.0w:~.2.0w:~.2.0w.~w&quot;,
<a name="52514"/>52514:     %%                   [YYYY, MM, DD, Hour, Min, Sec, N3]),  
<a name="52515"/>52515:     FormatTS = io_lib:format(&quot;~.2.0w:~.2.0w:~.2.0w&quot;, [Hour, Min, Sec]),  
<a name="format_timestamp-last_expr"/><a name="52516"/>52516: <b>    lists:flatten</b>(FormatTS).
<a name="52517"/>52517: 
<a name="52518"/>52518:    
<a name="52519"/>52519: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="52520"/>52520: 
<a name="set_tc_name-1"/><a name="52521"/>52521: <b>set_tc_name</b>(N) when is_atom(N) -&gt;
<a name="52522"/>52522:     set_tc_name(atom_to_list(N));
<a name="52523"/>52523: <b>set_tc_name</b>(N) when is_list(N) -&gt;
<a name="set_tc_name-last_expr"/><a name="52524"/>52524: <b>    put</b>(tc_name, N).
<a name="52525"/>52525: 
<a name="52526"/>52526: <i>%% get_tc_name() -&gt;</i>
<a name="52527"/>52527: <i>%%     get(tc_name).</i>
<a name="52528"/>52528: 
<a name="tc_begin-1"/><a name="52529"/>52529: <b>tc_begin</b>(TC) -&gt;
<a name="52530"/>52530:     OldVal = process_flag(trap_exit, true),
<a name="52531"/>52531:     put(old_trap_exit, OldVal),
<a name="52532"/>52532:     set_tc_name(TC),
<a name="tc_begin-last_expr"/><a name="52533"/>52533: <b>    tc_print</b>(&quot;begin ***&quot;,
<a name="52534"/>52534:              &quot;~n----------------------------------------------------~n&quot;, &quot;&quot;).
<a name="52535"/>52535:     
<a name="tc_end-1"/><a name="52536"/>52536: <b>tc_end</b>(Result) when is_list(Result) -&gt;
<a name="52537"/>52537:     OldVal = erase(old_trap_exit),
<a name="52538"/>52538:     process_flag(trap_exit, OldVal),
<a name="52539"/>52539:     tc_print(&quot;done: ~s&quot;, [Result], 
<a name="52540"/>52540:              &quot;&quot;, &quot;----------------------------------------------------~n~n&quot;),
<a name="tc_end-last_expr"/><a name="52541"/>52541:     ok.
<a name="52542"/>52542: 
<a name="52543"/>52543: <i>%% *** tc_try/2,3 ***</i>
<a name="52544"/>52544: <i>%% Case:      Basically the test case name</i>
<a name="52545"/>52545: <i>%% TCCondFun: A fun that is evaluated before the actual test case</i>
<a name="52546"/>52546: <i>%%            The point of this is that it can performs checks to</i>
<a name="52547"/>52547: <i>%%            see if we shall run the test case at all.</i>
<a name="52548"/>52548: <i>%%            For instance, the test case may only work in specific</i>
<a name="52549"/>52549: <i>%%            conditions.</i>
<a name="52550"/>52550: <i>%% FCFun:     The test case fun</i>
<a name="tc_try-2"/><a name="52551"/>52551: <b>tc_try</b>(Case, TCFun) -&gt;
<a name="52552"/>52552:     TCCondFun = fun() -&gt; ok end,
<a name="tc_try-last_expr"/><a name="52553"/>52553: <b>    tc_try</b>(Case, TCCondFun, TCFun).
<a name="52554"/>52554: 
<a name="tc_try-3"/><a name="52555"/>52555: <b>tc_try</b>(Case, TCCondFun, TCFun) 
<a name="52556"/>52556:   when is_atom(Case) andalso
<a name="52557"/>52557:        is_function(TCCondFun, 0) andalso
<a name="52558"/>52558:        is_function(TCFun, 0) -&gt;
<a name="52559"/>52559:     tc_begin(Case),
<a name="tc_try-last_expr"/><a name="52560"/>52560: <b>    try TCCondFun</b>() of
<a name="52561"/>52561:         ok -&gt;
<a name="52562"/>52562:             try 
<a name="52563"/>52563:                 begin
<a name="52564"/>52564:                     TCFun(),
<a name="52565"/>52565:                     ?SLEEP(?SECS(1)),
<a name="52566"/>52566:                     tc_end(&quot;ok&quot;)
<a name="52567"/>52567:                 end
<a name="52568"/>52568:             catch
<a name="52569"/>52569:                 C:{skip, _} = SKIP when ((C =:= throw) orelse (C =:= exit)) -&gt;
<a name="52570"/>52570:                     %% i(&quot;caught[tc] (skip): &quot;
<a name="52571"/>52571:                     %%   &quot;~n   C:    ~p&quot;
<a name="52572"/>52572:                     %%   &quot;~n   SKIP: ~p&quot;
<a name="52573"/>52573:                     %%   &quot;~n&quot;, [C, SKIP]),
<a name="52574"/>52574:                     tc_end( f(&quot;skipping(caught,~w,tc)&quot;, [C]) ),
<a name="52575"/>52575:                     SKIP;
<a name="52576"/>52576:                 C:E:S -&gt;
<a name="52577"/>52577:                     %% i(&quot;caught[tc]: &quot;
<a name="52578"/>52578:                     %%   &quot;~n   C: ~p&quot;
<a name="52579"/>52579:                     %%   &quot;~n   E: ~p&quot;
<a name="52580"/>52580:                     %%   &quot;~n   S: ~p&quot;
<a name="52581"/>52581:                     %%    &quot;~n&quot;, [C, E, S]),
<a name="52582"/>52582:                     tc_end( f(&quot;failed(caught,~w,tc)&quot;, [C]) ),
<a name="52583"/>52583:                     erlang:raise(C, E, S)
<a name="52584"/>52584:             end;
<a name="52585"/>52585:         {skip, _} = SKIP -&gt;
<a name="52586"/>52586:             tc_end(&quot;skipping(tc)&quot;),
<a name="52587"/>52587:             SKIP;
<a name="52588"/>52588:         {error, Reason} -&gt;
<a name="52589"/>52589:             tc_end(&quot;failed(tc)&quot;),
<a name="52590"/>52590:             exit({tc_cond_failed, Reason})
<a name="52591"/>52591:     catch
<a name="52592"/>52592:         C:{skip, _} = SKIP when ((C =:= throw) orelse (C =:= exit)) -&gt;
<a name="52593"/>52593:             %% i(&quot;caught[cond] (skip): &quot;
<a name="52594"/>52594:             %%   &quot;~n   C:    ~p&quot;
<a name="52595"/>52595:             %%   &quot;~n   SKIP: ~p&quot;
<a name="52596"/>52596:             %%   &quot;~n&quot;, [C, SKIP]),
<a name="52597"/>52597:             tc_end( f(&quot;skipping(caught,~w,cond)&quot;, [C]) ),
<a name="52598"/>52598:             SKIP;
<a name="52599"/>52599:         C:E:S -&gt;
<a name="52600"/>52600:             %% i(&quot;caught[cond]: &quot;
<a name="52601"/>52601:             %%   &quot;~n   C: ~p&quot;
<a name="52602"/>52602:             %%   &quot;~n   E: ~p&quot;
<a name="52603"/>52603:             %%   &quot;~n   S: ~p&quot;
<a name="52604"/>52604:             %%   &quot;~n&quot;, [C, E, S]),
<a name="52605"/>52605:             tc_end( f(&quot;failed(caught,~w,cond)&quot;, [C]) ),
<a name="52606"/>52606:             erlang:raise(C, E, S)
<a name="52607"/>52607:     end.
<a name="52608"/>52608: 
<a name="52609"/>52609: 
<a name="tc_print-3"/><a name="52610"/>52610: <b>tc_print</b>(F, Before, After) -&gt;
<a name="tc_print-last_expr"/><a name="52611"/>52611: <b>    tc_print</b>(F, [], Before, After).
<a name="52612"/>52612: 
<a name="tc_print-4"/><a name="52613"/>52613: <b>tc_print</b>(F, A, Before, After) -&gt;
<a name="52614"/>52614:     Name = tc_which_name(),
<a name="52615"/>52615:     FStr = f(&quot;*** [~s][~s][~p] &quot; ++ F ++ &quot;~n&quot;, 
<a name="52616"/>52616:              [formated_timestamp(),Name,self()|A]),
<a name="tc_print-last_expr"/><a name="52617"/>52617: <b>    io:format</b>(user, Before ++ FStr ++ After, []).
<a name="52618"/>52618: 
<a name="tc_which_name-0"/><a name="52619"/>52619: <b>tc_which_name</b>() -&gt;
<a name="tc_which_name-last_expr"/><a name="52620"/>52620: <b>    case get</b>(tc_name) of
<a name="52621"/>52621:         undefined -&gt;
<a name="52622"/>52622:             case get(sname) of
<a name="52623"/>52623:                 undefined -&gt;
<a name="52624"/>52624:                     &quot;&quot;;
<a name="52625"/>52625:                 SName when is_list(SName) -&gt;
<a name="52626"/>52626:                     SName
<a name="52627"/>52627:             end;
<a name="52628"/>52628:         Name when is_list(Name) -&gt;
<a name="52629"/>52629:             Name
<a name="52630"/>52630:     end.
<a name="52631"/>52631:     
<a name="52632"/>52632:    
<a name="52633"/>52633: 
<a name="52634"/>52634: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="52635"/>52635: 
<a name="52636"/>52636: <i>%% start_node(Name) -&gt;</i>
<a name="52637"/>52637: <i>%%     start_node(Name, 5000).</i>
<a name="52638"/>52638: 
<a name="start_node-2"/><a name="52639"/>52639: <b>start_node</b>(Name, Timeout) when is_integer(Timeout) andalso (Timeout &gt; 0) -&gt;
<a name="start_node-last_expr"/><a name="52640"/>52640: <b>    try ?CT_PEER</b>(#{name =&gt; Name, wait_boot =&gt; Timeout}) of
<a name="52641"/>52641:         {ok, Peer, Node} -&gt;
<a name="52642"/>52642:             ?SEV_IPRINT(&quot;Started node ~p&quot;, [Name]),
<a name="52643"/>52643:             {Peer, Node};
<a name="52644"/>52644:         {error, Reason} -&gt;
<a name="52645"/>52645:             ?SEV_EPRINT(&quot;failed starting node ~p (=&gt; SKIP):&quot;
<a name="52646"/>52646:                         &quot;~n   ~p&quot;, [Name, Reason]),
<a name="52647"/>52647:             skip(Reason)
<a name="52648"/>52648:     catch
<a name="52649"/>52649:         Class:Reason:Stack -&gt;
<a name="52650"/>52650:             ?SEV_EPRINT(&quot;Failed starting node: &quot;
<a name="52651"/>52651:                         &quot;~n   Class:  ~p&quot;
<a name="52652"/>52652:                         &quot;~n   Reason: ~p&quot;
<a name="52653"/>52653:                         &quot;~n   Stack:  ~p&quot;,
<a name="52654"/>52654:                         [Class, Reason, Stack]),
<a name="52655"/>52655:             skip({node_start, Class, Reason})
<a name="52656"/>52656:     end.
<a name="52657"/>52657: 
<a name="52658"/>52658:             
<a name="52659"/>52659: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="52660"/>52660: 
<a name="mq-0"/><a name="52661"/>52661: <b>mq</b>() -&gt;
<a name="mq-last_expr"/><a name="52662"/>52662: <b>    mq</b>(self()).
<a name="52663"/>52663: 
<a name="mq-1"/><a name="52664"/>52664: <b>mq</b>(Pid) when is_pid(Pid) -&gt;
<a name="52665"/>52665:     {messages, MQ} = process_info(Pid, messages),
<a name="mq-last_expr"/><a name="52666"/>52666:     MQ.
<a name="52667"/>52667: 
<a name="52668"/>52668:              
<a name="52669"/>52669: <i>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</i>
<a name="52670"/>52670: 
<a name="nowait-1"/><a name="52671"/>52671: <b>nowait</b>(Config) -&gt;
<a name="nowait-last_expr"/><a name="52672"/>52672: <b>    case lists:member</b>({select_handle, true}, Config) of
<a name="52673"/>52673:         true -&gt;
<a name="52674"/>52674:             make_ref();
<a name="52675"/>52675:         false -&gt;
<a name="52676"/>52676:             nowait
<a name="52677"/>52677:     end.
<a name="52678"/>52678: 
<a name="sock_port-1"/><a name="52679"/>52679: <b>sock_port</b>(S) -&gt;
<a name="sock_port-last_expr"/><a name="52680"/>52680: <b>    case socket:sockname</b>(S) of
<a name="52681"/>52681:         {ok, #{port := Port}} -&gt; Port;
<a name="52682"/>52682:         {ok, #{}}             -&gt; undefined
<a name="52683"/>52683:     end.
<a name="52684"/>52684: 
<a name="l2b-1"/><a name="52685"/>52685: <b>l2b</b>(L) when is_list(L) -&gt;
<a name="l2b-last_expr"/><a name="52686"/>52686: <b>    list_to_binary</b>(L).
<a name="52687"/>52687: 
<a name="b2l-1"/><a name="52688"/>52688: <b>b2l</b>(B) when is_binary(B) -&gt;
<a name="b2l-last_expr"/><a name="52689"/>52689: <b>    binary_to_list</b>(B).
<a name="52690"/>52690: 
<a name="f-2"/><a name="52691"/>52691: <b>f</b>(F, A) -&gt;
<a name="f-last_expr"/><a name="52692"/>52692: <b>    lists:flatten</b>(io_lib:format(F, A)).
<a name="52693"/>52693: 
<a name="i-1"/><a name="52694"/>52694: <b>i</b>(F) -&gt;
<a name="i-last_expr"/><a name="52695"/>52695: <b>    i</b>(F, []).
<a name="52696"/>52696: 
<a name="i-2"/><a name="52697"/>52697: <b>i</b>(F, A) -&gt;
<a name="52698"/>52698:     FStr = f(&quot;[~s] &quot; ++ F, [formated_timestamp()|A]),
<a name="52699"/>52699:     io:format(user, FStr ++ &quot;~n&quot;, []),
<a name="i-last_expr"/><a name="52700"/>52700: <b>    io:format</b>(FStr, []).
<a name="52701"/>52701: 
</pre>
</body>
</html>
