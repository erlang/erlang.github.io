<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<!-- autogenerated by 'erl2html2'. -->
<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8"/></meta>
<title>/buildroot/otp/lib/snmp/make_test_dir/snmp_test/snmp_agent_mibs_SUITE.erl</title>
</head>

<body bgcolor="white" text="black" link="blue" vlink="purple" alink="red">
<pre>
<a name="1"/>    1: <i>%% </i>
<a name="2"/>    2: <i>%% %CopyrightBegin%</i>
<a name="3"/>    3: <i>%% </i>
<a name="4"/>    4: <i>%% Copyright Ericsson AB 2003-2022. All Rights Reserved.</i>
<a name="5"/>    5: <i>%% </i>
<a name="6"/>    6: <i>%% Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</i>
<a name="7"/>    7: <i>%% you may not use this file except in compliance with the License.</i>
<a name="8"/>    8: <i>%% You may obtain a copy of the License at</i>
<a name="9"/>    9: <i>%%</i>
<a name="10"/>   10: <i>%%     http://www.apache.org/licenses/LICENSE-2.0</i>
<a name="11"/>   11: <i>%%</i>
<a name="12"/>   12: <i>%% Unless required by applicable law or agreed to in writing, software</i>
<a name="13"/>   13: <i>%% distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</i>
<a name="14"/>   14: <i>%% WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</i>
<a name="15"/>   15: <i>%% See the License for the specific language governing permissions and</i>
<a name="16"/>   16: <i>%% limitations under the License.</i>
<a name="17"/>   17: <i>%% </i>
<a name="18"/>   18: <i>%% %CopyrightEnd%</i>
<a name="19"/>   19: <i>%% </i>
<a name="20"/>   20: 
<a name="21"/>   21: <i>%%</i>
<a name="22"/>   22: <i>%%----------------------------------------------------------------------</i>
<a name="23"/>   23: <i>%% Purpose: Test suite of the agent mib-server.</i>
<a name="24"/>   24: <i>%%          Some of these tests should really be in a mib-storage suite.</i>
<a name="25"/>   25: <i>%%----------------------------------------------------------------------</i>
<a name="26"/>   26: 
<a name="27"/>   27: <b>-module</b>(snmp_agent_mibs_SUITE).
<a name="28"/>   28: 
<a name="29"/>   29: 
<a name="30"/>   30: <i>%%----------------------------------------------------------------------</i>
<a name="31"/>   31: <i>%% Include files</i>
<a name="32"/>   32: <i>%%----------------------------------------------------------------------</i>
<a name="33"/>   33: 
<a name="34"/>   34: <b>-include_lib</b>(&quot;common_test/include/ct.hrl&quot;).
<a name="35"/>   35: <b>-include</b>(&quot;snmp_test_lib.hrl&quot;).
<a name="36"/>   36: <b>-include_lib</b>(&quot;snmp/include/snmp_types.hrl&quot;).
<a name="37"/>   37: <b>-include_lib</b>(&quot;snmp/include/SNMP-COMMUNITY-MIB.hrl&quot;).
<a name="38"/>   38: <b>-include_lib</b>(&quot;snmp/include/SNMP-VIEW-BASED-ACM-MIB.hrl&quot;).
<a name="39"/>   39: <b>-include_lib</b>(&quot;snmp/include/SNMP-USER-BASED-SM-MIB.hrl&quot;).
<a name="40"/>   40: <b>-include</b>(&quot;snmp_test_data/Test2.hrl&quot;).
<a name="41"/>   41: 
<a name="42"/>   42: 
<a name="43"/>   43: <i>%%----------------------------------------------------------------------</i>
<a name="44"/>   44: <i>%% External exports</i>
<a name="45"/>   45: <i>%%----------------------------------------------------------------------</i>
<a name="46"/>   46: 
<a name="47"/>   47: <b>-export</b>([
<a name="48"/>   48:          suite/0, all/0, groups/0,
<a name="49"/>   49:          init_per_suite/1,    end_per_suite/1,
<a name="50"/>   50:          init_per_group/2,    end_per_group/2, 
<a name="51"/>   51:          init_per_testcase/2, end_per_testcase/2,
<a name="52"/>   52: 
<a name="53"/>   53: 	 start_and_stop/1,
<a name="54"/>   54: 	
<a name="55"/>   55: 	 size_check_ets1/1,
<a name="56"/>   56: 	 size_check_ets2/1,
<a name="57"/>   57: 	 size_check_ets2_bad_file1/1,
<a name="58"/>   58: 	 size_check_ets3/1,
<a name="59"/>   59: 	 size_check_ets3_bad_file1/1,
<a name="60"/>   60: 	 size_check_dets/1,
<a name="61"/>   61: 	 size_check_mnesia/1,
<a name="62"/>   62: 	 load_unload/1,
<a name="63"/>   63: 	 me_lookup/1,
<a name="64"/>   64: 	 which_mib/1,
<a name="65"/>   65: 	 cache_test/1
<a name="66"/>   66: 
<a name="67"/>   67: 	]).
<a name="68"/>   68: 
<a name="69"/>   69: 
<a name="70"/>   70: <b>-define</b>(ALIB, snmp_agent_test_lib).
<a name="71"/>   71: 
<a name="72"/>   72: 
<a name="73"/>   73: <i>%%======================================================================</i>
<a name="74"/>   74: <i>%% Common Test interface functions</i>
<a name="75"/>   75: <i>%%======================================================================</i>
<a name="76"/>   76: 
<a name="suite-0"/><a name="77"/>   77: <b>suite</b>() -&gt; 
<a name="suite-last_expr"/><a name="78"/>   78:     [{ct_hooks, [ts_install_cth]}].
<a name="79"/>   79: 
<a name="all-0"/><a name="80"/>   80: <b>all</b>() -&gt; 
<a name="all-last_expr"/><a name="81"/>   81:     [
<a name="82"/>   82:      start_and_stop, 
<a name="83"/>   83:      load_unload, 
<a name="84"/>   84:      {group, size_check},
<a name="85"/>   85:      me_lookup, 
<a name="86"/>   86:      which_mib, 
<a name="87"/>   87:      cache_test
<a name="88"/>   88:     ].
<a name="89"/>   89: 
<a name="groups-0"/><a name="90"/>   90: <b>groups</b>() -&gt; 
<a name="groups-last_expr"/><a name="91"/>   91:     [
<a name="92"/>   92:      {size_check, [], size_check_cases()}
<a name="93"/>   93:     ].
<a name="94"/>   94: 
<a name="size_check_cases-0"/><a name="95"/>   95: <b>size_check_cases</b>() -&gt;
<a name="size_check_cases-last_expr"/><a name="96"/>   96:     [
<a name="97"/>   97:      size_check_ets1,            % Plain ets
<a name="98"/>   98:      size_check_ets2,            % ets with a file
<a name="99"/>   99:      size_check_ets2_bad_file1,  % ets with a bad file
<a name="100"/>  100:      size_check_ets3,            % ets with a checksummed file
<a name="101"/>  101:      size_check_ets3_bad_file1,  % ets with bad file (checksummed) 
<a name="102"/>  102:      size_check_dets,            % Plain dets
<a name="103"/>  103:      size_check_mnesia           % Plain mnesia
<a name="104"/>  104:     ].
<a name="105"/>  105: 
<a name="106"/>  106: 
<a name="107"/>  107: 
<a name="108"/>  108: <i>%%</i>
<a name="109"/>  109: <i>%% -----</i>
<a name="110"/>  110: <i>%%</i>
<a name="111"/>  111: 
<a name="init_per_suite-1"/><a name="112"/>  112: <b>init_per_suite</b>(Config0) when is_list(Config0) -&gt;
<a name="113"/>  113: 
<a name="114"/>  114:     ?DBG(&quot;init_per_suite -&gt; entry with&quot;
<a name="115"/>  115:          &quot;~n   Config0: ~p&quot;, [Config0]),
<a name="116"/>  116: 
<a name="init_per_suite-last_expr"/><a name="117"/>  117: <b>    case snmp_test_lib:init_per_suite</b>(Config0) of
<a name="118"/>  118:         {skip, _} = SKIP -&gt;
<a name="119"/>  119:             SKIP;
<a name="120"/>  120: 
<a name="121"/>  121:         Config1 when is_list(Config1) -&gt;
<a name="122"/>  122:             Config2 = ?LIB:init_suite_top_dir(?MODULE, Config1), 
<a name="123"/>  123: 
<a name="124"/>  124:             %% We need a monitor on this node also
<a name="125"/>  125:             snmp_test_sys_monitor:start(),
<a name="126"/>  126: 
<a name="127"/>  127:             ?DBG(&quot;init_per_suite -&gt; done when&quot;
<a name="128"/>  128:                  &quot;~n   Config: ~p&quot;, [Config]),
<a name="129"/>  129: 
<a name="130"/>  130:             Config2
<a name="131"/>  131:     end.
<a name="132"/>  132: 
<a name="end_per_suite-1"/><a name="133"/>  133: <b>end_per_suite</b>(Config) when is_list(Config) -&gt;
<a name="134"/>  134: 
<a name="135"/>  135:     ?DBG(&quot;end_per_suite -&gt; entry with&quot;
<a name="136"/>  136:          &quot;~n   Config: ~p&quot;, [Config]),
<a name="137"/>  137: 
<a name="138"/>  138:     snmp_test_sys_monitor:stop(),
<a name="139"/>  139: 
<a name="end_per_suite-last_expr"/><a name="140"/>  140: <b>    ?LIB:end_per_suite</b>(Config).
<a name="141"/>  141: 
<a name="142"/>  142: 
<a name="143"/>  143: 
<a name="144"/>  144: <i>%%</i>
<a name="145"/>  145: <i>%% -----</i>
<a name="146"/>  146: <i>%%</i>
<a name="147"/>  147: 
<a name="init_per_group-2"/><a name="148"/>  148: <b>init_per_group</b>(GroupName, Config) -&gt;
<a name="init_per_group-last_expr"/><a name="149"/>  149: <b>    ?LIB:init_group_top_dir</b>(GroupName, Config).
<a name="150"/>  150: 
<a name="end_per_group-2"/><a name="151"/>  151: <b>end_per_group</b>(_GroupName, Config) -&gt;
<a name="end_per_group-last_expr"/><a name="152"/>  152:     Config.
<a name="153"/>  153: 
<a name="154"/>  154: 
<a name="155"/>  155: 
<a name="156"/>  156: 
<a name="157"/>  157: <i>%%</i>
<a name="158"/>  158: <i>%% -----</i>
<a name="159"/>  159: <i>%%</i>
<a name="160"/>  160: 
<a name="init_per_testcase-2"/><a name="161"/>  161: <b>init_per_testcase</b>(Case, Config0) when is_list(Config0) -&gt;
<a name="162"/>  162:     snmp_test_global_sys_monitor:reset_events(),
<a name="163"/>  163:     Config1    = ?LIB:fix_data_dir(Config0),
<a name="164"/>  164:     CaseTopDir = ?LIB:init_testcase_top_dir(Case, Config1), 
<a name="165"/>  165:     DbDir      = join(CaseTopDir, &quot;db_dir/&quot;),
<a name="166"/>  166:     ok   = file:make_dir(DbDir),
<a name="init_per_testcase-last_expr"/><a name="167"/>  167: <b>    init_per_testcase2</b>(Case, [{db_dir,       DbDir}, 
<a name="168"/>  168: 			      {case_top_dir, CaseTopDir} | Config1]).
<a name="169"/>  169: 
<a name="init_per_testcase2-2"/><a name="170"/>  170: <b>init_per_testcase2</b>(size_check_ets2_bad_file1, Config) when is_list(Config) -&gt;
<a name="171"/>  171:     DbDir = ?config(db_dir, Config),
<a name="172"/>  172:     %% Create a bad file
<a name="173"/>  173:     ok = file:write_file(join(DbDir, &quot;snmpa_symbolic_store.db&quot;), 
<a name="174"/>  174: 			 &quot;calvin and hoppes play chess&quot;),
<a name="175"/>  175:     Factor = ?config(snmp_factor, Config),
<a name="176"/>  176:     ct:timetrap(?MINS(1 + (Factor div 2))),
<a name="177"/>  177:     Config;
<a name="178"/>  178: <b>init_per_testcase2</b>(size_check_ets3_bad_file1, Config) when is_list(Config) -&gt;
<a name="179"/>  179:     DbDir = ?config(db_dir, Config),
<a name="180"/>  180:     %% Create a bad file
<a name="181"/>  181:     ok = file:write_file(join(DbDir, &quot;snmpa_symbolic_store.db&quot;), 
<a name="182"/>  182: 			 &quot;calvin and hoppes play chess&quot;),
<a name="183"/>  183:     Factor = ?config(snmp_factor, Config),
<a name="184"/>  184:     ct:timetrap(?MINS(1 + (Factor div 2))),
<a name="185"/>  185:     Config;
<a name="186"/>  186: <b>init_per_testcase2</b>(size_check_mnesia, Config) when is_list(Config) -&gt;
<a name="187"/>  187:     Factor = ?config(snmp_factor, Config),
<a name="188"/>  188:     ct:timetrap(?MINS(1 + (Factor div 2))),
<a name="189"/>  189:     Config;
<a name="190"/>  190: <b>init_per_testcase2</b>(cache_test, Config) when is_list(Config) -&gt;
<a name="191"/>  191:     Factor = ?config(snmp_factor, Config),
<a name="192"/>  192:     ct:timetrap(?MINS(10 + (Factor div 2))),
<a name="193"/>  193:     Config;
<a name="194"/>  194: <b>init_per_testcase2</b>(_Case, Config) when is_list(Config) -&gt;
<a name="195"/>  195:     Factor = ?config(snmp_factor, Config),
<a name="196"/>  196:     ct:timetrap(?MINS(1 + (Factor div 3))),
<a name="init_per_testcase2-last_expr"/><a name="197"/>  197:     Config.
<a name="198"/>  198: 
<a name="199"/>  199: 
<a name="end_per_testcase-2"/><a name="200"/>  200: <b>end_per_testcase</b>(Case, Config) when is_list(Config) -&gt;
<a name="201"/>  201:     ?IPRINT(&quot;system events during test: &quot;
<a name="202"/>  202:             &quot;~n   ~p&quot;, [snmp_test_global_sys_monitor:events()]),
<a name="end_per_testcase-last_expr"/><a name="203"/>  203: <b>    end_per_testcase1</b>(Case, Config).
<a name="204"/>  204: 
<a name="end_per_testcase1-2"/><a name="205"/>  205: <b>end_per_testcase1</b>(size_check_mnesia, Config) when is_list(Config) -&gt;
<a name="206"/>  206:     mnesia_stop(),
<a name="207"/>  207:     Config;
<a name="208"/>  208: <b>end_per_testcase1</b>(cache_test, Config) when is_list(Config) -&gt;
<a name="209"/>  209:     Config;
<a name="210"/>  210: <b>end_per_testcase1</b>(_Case, Config) when is_list(Config) -&gt;
<a name="end_per_testcase1-last_expr"/><a name="211"/>  211:     Config.
<a name="212"/>  212: 
<a name="213"/>  213: 
<a name="214"/>  214: <i>%%======================================================================</i>
<a name="215"/>  215: <i>%% Test functions</i>
<a name="216"/>  216: <i>%%======================================================================</i>
<a name="217"/>  217: 
<a name="start_and_stop-1"/><a name="218"/>  218: <b>start_and_stop</b>(Config) when is_list(Config) -&gt;
<a name="start_and_stop-last_expr"/><a name="219"/>  219: <b>    tc_try</b>(start_and_start,
<a name="220"/>  220:            fun() -&gt; do_start_and_stop(Config) end).
<a name="221"/>  221: 
<a name="do_start_and_stop-1"/><a name="222"/>  222: <b>do_start_and_stop</b>(_Config) -&gt;
<a name="223"/>  223:     Prio      = normal,
<a name="224"/>  224:     Verbosity = trace,
<a name="225"/>  225: 
<a name="226"/>  226:     sym_start(Prio, Verbosity),
<a name="227"/>  227:     MibsPid = mibs_start(Prio, Verbosity),
<a name="228"/>  228: 
<a name="229"/>  229:     mibs_info(MibsPid),
<a name="230"/>  230: 
<a name="231"/>  231:     mibs_stop(MibsPid),
<a name="232"/>  232:     sym_stop(),
<a name="233"/>  233: 
<a name="do_start_and_stop-last_expr"/><a name="234"/>  234:     ok.
<a name="235"/>  235: 
<a name="236"/>  236: 
<a name="237"/>  237: <i>%% ---------------------------------------------------------------------</i>
<a name="238"/>  238: 
<a name="load_unload-1"/><a name="239"/>  239: <b>load_unload</b>(Config) when is_list(Config) -&gt;
<a name="load_unload-last_expr"/><a name="240"/>  240: <b>    tc_try</b>(load_unload,
<a name="241"/>  241:            fun() -&gt; do_load_unload(Config) end).
<a name="242"/>  242: 
<a name="do_load_unload-1"/><a name="243"/>  243: <b>do_load_unload</b>(Config) -&gt;
<a name="244"/>  244:     ?DBG(&quot;load_unload -&gt; start&quot;, []),
<a name="245"/>  245: 
<a name="246"/>  246:     Prio       = normal,
<a name="247"/>  247:     Verbosity  = log,
<a name="248"/>  248:     MibDir     = ?config(data_dir, Config),
<a name="249"/>  249: 
<a name="250"/>  250:     ?DBG(&quot;load_unload -&gt; start symbolic store&quot;, []),
<a name="251"/>  251:     sym_start(Prio, Verbosity),
<a name="252"/>  252: 
<a name="253"/>  253:     ?DBG(&quot;load_unload -&gt; start mib server&quot;, []),
<a name="254"/>  254:     MibsPid = mibs_start(Prio, Verbosity),
<a name="255"/>  255:     
<a name="256"/>  256:     ?DBG(&quot;load_unload -&gt; load one not already loaded mib&quot;, []),
<a name="257"/>  257:     ok = verify_loaded_mibs(MibsPid, MibDir, []),
<a name="258"/>  258:     ok = load_mibs(MibsPid, MibDir, [&quot;Test2&quot;]),
<a name="259"/>  259:     ok = verify_loaded_mibs(MibsPid, MibDir, [&quot;Test2&quot;]),
<a name="260"/>  260:     
<a name="261"/>  261:     ?DBG(&quot;load_unload -&gt; try load one *already loaded* mib&quot;, []),
<a name="262"/>  262:     EMib = join(MibDir, &quot;Test2&quot;), 
<a name="263"/>  263:     {error, {'load aborted at', EMib, already_loaded}} =
<a name="264"/>  264: 	load_mibs(MibsPid, MibDir, [&quot;Test2&quot;]),
<a name="265"/>  265: 
<a name="266"/>  266:     ?DBG(&quot;load_unload -&gt; load 2 not already loaded mibs&quot;, []),
<a name="267"/>  267:     ok = load_mibs(MibsPid, MibDir, [&quot;TestTrap&quot;, &quot;TestTrapv2&quot;]),
<a name="268"/>  268:     ok = verify_loaded_mibs(MibsPid, MibDir,
<a name="269"/>  269: 				  [&quot;Test2&quot;, &quot;TestTrap&quot;, &quot;TestTrapv2&quot;]),
<a name="270"/>  270:     
<a name="271"/>  271:     ?DBG(&quot;load_unload -&gt; unload one loaded mib&quot;, []),
<a name="272"/>  272:     ok = unload_mibs(MibsPid, [&quot;Test2&quot;]),
<a name="273"/>  273:     ok = verify_loaded_mibs(MibsPid, MibDir, [&quot;TestTrap&quot;, &quot;TestTrapv2&quot;]),
<a name="274"/>  274:     
<a name="275"/>  275:     ?DBG(&quot;load_unload -&gt; try unload two loaded mibs and one not loaded&quot;, []),
<a name="276"/>  276:     {error, {'unload aborted at', &quot;Test2&quot;, not_loaded}} =
<a name="277"/>  277: 	   unload_mibs(MibsPid, [&quot;TestTrap&quot;,&quot;Test2&quot;,&quot;TestTrapv2&quot;]),
<a name="278"/>  278:     ok = verify_loaded_mibs(MibsPid, MibDir, [&quot;TestTrapv2&quot;]),
<a name="279"/>  279:     
<a name="280"/>  280:     ?DBG(&quot;load_unload -&gt; unload the remaining loaded mib&quot;, []),
<a name="281"/>  281:     ok = unload_mibs(MibsPid, [&quot;TestTrapv2&quot;]),
<a name="282"/>  282:     ok = verify_loaded_mibs(MibsPid, MibDir, []),
<a name="283"/>  283:     
<a name="284"/>  284:     ?DBG(&quot;load_unload -&gt; stop mib server&quot;, []),
<a name="285"/>  285:     mibs_stop(MibsPid),
<a name="286"/>  286: 
<a name="287"/>  287:     ?DBG(&quot;load_unload -&gt; stop symbolic store&quot;, []),
<a name="288"/>  288:     sym_stop(),
<a name="289"/>  289: 
<a name="290"/>  290:     ?DBG(&quot;load_unload -&gt; done&quot;, []),
<a name="do_load_unload-last_expr"/><a name="291"/>  291:     ok.
<a name="292"/>  292: 
<a name="293"/>  293: 
<a name="294"/>  294: <i>%% ---------------------------------------------------------------------</i>
<a name="295"/>  295: 
<a name="296"/>  296: 
<a name="size_check_ets1-1"/><a name="297"/>  297: <b>size_check_ets1</b>(Config) when is_list(Config) -&gt;
<a name="298"/>  298:     MibStorage = [{module, snmpa_mib_storage_ets}], 
<a name="size_check_ets1-last_expr"/><a name="299"/>  299: <b>    do_size_check</b>(size_check_ets1,
<a name="300"/>  300:                   [{mib_storage, MibStorage}|Config]).
<a name="301"/>  301: 
<a name="size_check_ets2-1"/><a name="302"/>  302: <b>size_check_ets2</b>(Config) when is_list(Config) -&gt;
<a name="303"/>  303:     Dir = ?config(db_dir, Config),    
<a name="304"/>  304:     MibStorage = [{module,  snmpa_mib_storage_ets}, 
<a name="305"/>  305: 		  {options, [{dir, Dir}]}], 
<a name="size_check_ets2-last_expr"/><a name="306"/>  306: <b>    do_size_check</b>(size_check_ets2,
<a name="307"/>  307:                   [{mib_storage, MibStorage}|Config]).
<a name="308"/>  308: 
<a name="size_check_ets2_bad_file1-1"/><a name="309"/>  309: <b>size_check_ets2_bad_file1</b>(Config) when is_list(Config) -&gt;
<a name="310"/>  310:     Dir = ?config(db_dir, Config),    
<a name="311"/>  311:     %% Ensure that the bad file does not cause any problems (action = clear)
<a name="312"/>  312:     MibStorage = [{module,  snmpa_mib_storage_ets}, 
<a name="313"/>  313: 		  {options, [{dir,    Dir}, 
<a name="314"/>  314: 			     {action, clear}]}], 
<a name="size_check_ets2_bad_file1-last_expr"/><a name="315"/>  315: <b>    do_size_check</b>(size_check_ets2_bad_file1,
<a name="316"/>  316:                   [{mib_storage, MibStorage}|Config]).
<a name="317"/>  317: 
<a name="size_check_ets3-1"/><a name="318"/>  318: <b>size_check_ets3</b>(Config) when is_list(Config) -&gt;
<a name="319"/>  319:     Dir = ?config(db_dir, Config),    
<a name="320"/>  320:     MibStorage = [{module,  snmpa_mib_storage_ets}, 
<a name="321"/>  321: 		  {options, [{dir,      Dir}, 
<a name="322"/>  322: 			     {checksum, true}]}], 
<a name="size_check_ets3-last_expr"/><a name="323"/>  323: <b>    do_size_check</b>(size_check_ets3,
<a name="324"/>  324:                   [{mib_storage, MibStorage}|Config]).
<a name="325"/>  325: 
<a name="size_check_ets3_bad_file1-1"/><a name="326"/>  326: <b>size_check_ets3_bad_file1</b>(Config) when is_list(Config) -&gt;
<a name="327"/>  327:     Dir = ?config(db_dir, Config),    
<a name="328"/>  328:     %% Ensure that the bad file does not cause any problems (action = clear)
<a name="329"/>  329:     MibStorage = [{module,  snmpa_mib_storage_ets}, 
<a name="330"/>  330: 		  {options, [{dir,      Dir}, 
<a name="331"/>  331: 			     {action,   clear}, 
<a name="332"/>  332: 			     {checksum, true}]}], 
<a name="size_check_ets3_bad_file1-last_expr"/><a name="333"/>  333: <b>    do_size_check</b>(size_check_ets3_bad_file1,
<a name="334"/>  334:                   [{mib_storage, MibStorage}|Config]).
<a name="335"/>  335: 
<a name="size_check_dets-1"/><a name="336"/>  336: <b>size_check_dets</b>(Config) when is_list(Config) -&gt;
<a name="337"/>  337:     Dir = ?config(db_dir, Config),
<a name="338"/>  338:     MibStorage = [{module,  snmpa_mib_storage_dets}, 
<a name="339"/>  339: 		  {options, [{dir, Dir}]}], 
<a name="size_check_dets-last_expr"/><a name="340"/>  340: <b>    do_size_check</b>(size_check_dets,
<a name="341"/>  341:                   [{mib_storage, MibStorage}|Config]).
<a name="342"/>  342: 
<a name="size_check_mnesia-1"/><a name="343"/>  343: <b>size_check_mnesia</b>(Config) when is_list(Config) -&gt;
<a name="344"/>  344:     MibStorage = [{module,  snmpa_mib_storage_mnesia}, 
<a name="345"/>  345:                   {options, [{nodes, []}]}],
<a name="346"/>  346:     DbDir      = ?config(db_dir, Config),
<a name="347"/>  347:     Init       = fun() -&gt; mnesia_start([{dir, DbDir}]), ok end,
<a name="size_check_mnesia-last_expr"/><a name="348"/>  348: <b>    do_size_check</b>(size_check_mnesia,
<a name="349"/>  349:                   Init,
<a name="350"/>  350:                   [{mib_storage, MibStorage}|Config]).
<a name="351"/>  351: 
<a name="do_size_check-2"/><a name="352"/>  352: <b>do_size_check</b>(Name, Config) -&gt;
<a name="353"/>  353:     Init = fun() -&gt; ok end,
<a name="do_size_check-last_expr"/><a name="354"/>  354: <b>    do_size_check</b>(Name, Init, Config).
<a name="355"/>  355: 
<a name="do_size_check-3"/><a name="356"/>  356: <b>do_size_check</b>(Name, Init, Config) -&gt;
<a name="do_size_check-last_expr"/><a name="357"/>  357: <b>    tc_try</b>(Name, Init, fun() -&gt; do_size_check(Config) end).
<a name="358"/>  358: 
<a name="359"/>  359: 
<a name="do_size_check-1"/><a name="360"/>  360: <b>do_size_check</b>(Config) -&gt;
<a name="361"/>  361:     ?IPRINT(&quot;do_size_check -&gt; start with&quot;
<a name="362"/>  362:             &quot;~n   Config: ~p&quot;, [Config]),
<a name="363"/>  363:     Prio      = normal,
<a name="364"/>  364:     Verbosity = trace,
<a name="365"/>  365: 
<a name="366"/>  366:     MibStorage = ?config(mib_storage, Config),
<a name="367"/>  367:     ?IPRINT(&quot;do_size_check -&gt; MibStorage: ~p&quot;, [MibStorage]),
<a name="368"/>  368:     MibDir     = ?config(data_dir, Config),
<a name="369"/>  369:     StdMibDir  = filename:join(code:priv_dir(snmp), &quot;mibs&quot;) ++ &quot;/&quot;,
<a name="370"/>  370:     
<a name="371"/>  371:     ?IPRINT(&quot;do_size_check -&gt; start symbolic store&quot;, []),
<a name="372"/>  372:     sym_start(Prio, MibStorage, Verbosity),
<a name="373"/>  373:     ?IPRINT(&quot;do_size_check -&gt; start mib server&quot;, []),
<a name="374"/>  374:     MibsPid = mibs_start(Prio, MibStorage, Verbosity),
<a name="375"/>  375: 
<a name="376"/>  376:     Mibs    = [&quot;Test2&quot;, &quot;TestTrap&quot;, &quot;TestTrapv2&quot;],
<a name="377"/>  377:     StdMibs = [&quot;OTP-SNMPEA-MIB&quot;,
<a name="378"/>  378: 	       &quot;SNMP-COMMUNITY-MIB&quot;,
<a name="379"/>  379: 	       &quot;SNMP-FRAMEWORK-MIB&quot;,
<a name="380"/>  380: 	       &quot;SNMP-MPD-MIB&quot;,
<a name="381"/>  381: 	       &quot;SNMP-NOTIFICATION-MIB&quot;,
<a name="382"/>  382: 	       &quot;SNMP-TARGET-MIB&quot;,
<a name="383"/>  383: 	       &quot;SNMP-USER-BASED-SM-MIB&quot;,
<a name="384"/>  384: 	       &quot;SNMP-VIEW-BASED-ACM-MIB&quot;,
<a name="385"/>  385: 	       &quot;SNMPv2-MIB&quot;,
<a name="386"/>  386: 	       &quot;SNMPv2-TC&quot;,
<a name="387"/>  387: 	       &quot;SNMPv2-TM&quot;],
<a name="388"/>  388: 
<a name="389"/>  389:     ?IPRINT(&quot;do_size_check -&gt; load std mibs&quot;, []),
<a name="390"/>  390:     load_mibs(MibsPid, StdMibDir, StdMibs),
<a name="391"/>  391:     ?IPRINT(&quot;do_size_check -&gt; load (own) mibs&quot;, []),
<a name="392"/>  392:     load_mibs(MibsPid, MibDir, Mibs),
<a name="393"/>  393: 
<a name="394"/>  394:     ?SLEEP(2000),
<a name="395"/>  395:     ?IPRINT(&quot;do_size_check -&gt; display mem usage&quot;, []),
<a name="396"/>  396:     display_memory_usage(MibsPid),
<a name="397"/>  397:     
<a name="398"/>  398:     ?IPRINT(&quot;do_size_check -&gt; unload (own) mibs&quot;, []),
<a name="399"/>  399:     unload_mibs(MibsPid, Mibs),
<a name="400"/>  400:     ?IPRINT(&quot;do_size_check -&gt; unload std mibs&quot;, []),
<a name="401"/>  401:     unload_mibs(MibsPid, StdMibs),
<a name="402"/>  402: 
<a name="403"/>  403:     ?IPRINT(&quot;do_size_check -&gt; stop mib server&quot;, []),
<a name="404"/>  404:     mibs_stop(MibsPid),
<a name="405"/>  405:     ?IPRINT(&quot;do_size_check -&gt; stop symbolic store&quot;, []),
<a name="406"/>  406:     sym_stop(),
<a name="407"/>  407: 
<a name="408"/>  408:     ?IPRINT(&quot;do_size_check -&gt; done&quot;, []),
<a name="do_size_check-last_expr"/><a name="409"/>  409:     ok.
<a name="410"/>  410: 
<a name="411"/>  411: 
<a name="412"/>  412: <i>%% ---------------------------------------------------------------------</i>
<a name="413"/>  413: 
<a name="me_lookup-1"/><a name="414"/>  414: <b>me_lookup</b>(Config) when is_list(Config) -&gt;
<a name="me_lookup-last_expr"/><a name="415"/>  415: <b>    tc_try</b>(me_lookup,
<a name="416"/>  416:            fun() -&gt; do_me_lookup(Config) end).
<a name="417"/>  417: 
<a name="do_me_lookup-1"/><a name="418"/>  418: <b>do_me_lookup</b>(Config) -&gt;
<a name="419"/>  419:     Prio       = normal,
<a name="420"/>  420:     Verbosity  = trace,
<a name="421"/>  421:     MibDir     = ?config(data_dir, Config),
<a name="422"/>  422:     StdMibDir  = filename:join(code:priv_dir(snmp), &quot;mibs&quot;) ++ &quot;/&quot;,
<a name="423"/>  423:     Mibs    = [&quot;Test2&quot;, &quot;TestTrap&quot;, &quot;TestTrapv2&quot;],
<a name="424"/>  424:     StdMibs = [&quot;OTP-SNMPEA-MIB&quot;,
<a name="425"/>  425: 	       &quot;SNMP-COMMUNITY-MIB&quot;,
<a name="426"/>  426: 	       &quot;SNMP-FRAMEWORK-MIB&quot;,
<a name="427"/>  427: 	       &quot;SNMP-MPD-MIB&quot;,
<a name="428"/>  428: 	       &quot;SNMP-NOTIFICATION-MIB&quot;,
<a name="429"/>  429: 	       &quot;SNMP-TARGET-MIB&quot;,
<a name="430"/>  430: 	       %% &quot;SNMP-USER-BASED-SM-MIB&quot;,
<a name="431"/>  431: 	       &quot;SNMP-VIEW-BASED-ACM-MIB&quot;,
<a name="432"/>  432: 	       &quot;SNMPv2-MIB&quot;,
<a name="433"/>  433: 	       &quot;SNMPv2-TC&quot;,
<a name="434"/>  434: 	       &quot;SNMPv2-TM&quot;],
<a name="435"/>  435: 
<a name="436"/>  436:     ?DBG(&quot;me_lookup -&gt; start symbolic store&quot;, []),
<a name="437"/>  437:     sym_start(Prio, Verbosity),
<a name="438"/>  438: 
<a name="439"/>  439:     ?DBG(&quot;me_lookup -&gt; start mib server&quot;, []),
<a name="440"/>  440:     MibsPid = mibs_start(Prio, Verbosity),
<a name="441"/>  441:     
<a name="442"/>  442:     ?DBG(&quot;me_lookup -&gt; load mibs&quot;, []),
<a name="443"/>  443:     load_mibs(MibsPid, MibDir, Mibs),
<a name="444"/>  444:     ?DBG(&quot;me_lookup -&gt; load std mibs&quot;, []),
<a name="445"/>  445:     load_mibs(MibsPid, StdMibDir, StdMibs),
<a name="446"/>  446: 
<a name="447"/>  447:     ?DBG(&quot;me_lookup -&gt; find ~w from SNMP-COMMUNITY-MIB&quot;, 
<a name="448"/>  448: 	 [?snmpTrapCommunity_instance]),
<a name="449"/>  449:     ok = me_lookup(MibsPid, ?snmpTrapCommunity_instance),
<a name="450"/>  450:     
<a name="451"/>  451:     ?DBG(&quot;me_lookup -&gt; find ~w from SNMP-VIEW-BASED-ACM-MIB&quot;, 
<a name="452"/>  452: 	 [?vacmViewSpinLock_instance]),
<a name="453"/>  453:     ok = me_lookup(MibsPid, ?vacmViewSpinLock_instance),
<a name="454"/>  454:     
<a name="455"/>  455:     ?DBG(&quot;me_lookup -&gt; find ~w from SNMP-USER-BASED-SM-MIB&quot;, 
<a name="456"/>  456: 	 [?usmStatsNotInTimeWindows_instance]),
<a name="457"/>  457:     {error, _} = me_lookup(MibsPid, ?usmStatsNotInTimeWindows_instance),
<a name="458"/>  458:     
<a name="459"/>  459:     ?DBG(&quot;me_lookup -&gt; stop mib server&quot;, []),
<a name="460"/>  460:     mibs_stop(MibsPid),
<a name="461"/>  461: 
<a name="462"/>  462:     ?DBG(&quot;me_lookup -&gt; stop symbolic store&quot;, []),
<a name="463"/>  463:     sym_stop(),
<a name="464"/>  464: 
<a name="do_me_lookup-last_expr"/><a name="465"/>  465:     ok.
<a name="466"/>  466: 
<a name="467"/>  467: 
<a name="468"/>  468: <i>%% ---------------------------------------------------------------------</i>
<a name="469"/>  469: 
<a name="which_mib-1"/><a name="470"/>  470: <b>which_mib</b>(Config) when is_list(Config) -&gt;
<a name="which_mib-last_expr"/><a name="471"/>  471: <b>    tc_try</b>(which_mib,
<a name="472"/>  472:            fun() -&gt; do_which_mib(Config) end).
<a name="473"/>  473: 
<a name="do_which_mib-1"/><a name="474"/>  474: <b>do_which_mib</b>(Config) -&gt;
<a name="475"/>  475:     Prio       = normal,
<a name="476"/>  476:     Verbosity  = trace,
<a name="477"/>  477:     MibDir     = ?config(data_dir, Config),
<a name="478"/>  478:     StdMibDir  = filename:join(code:priv_dir(snmp), &quot;mibs&quot;) ++ &quot;/&quot;,
<a name="479"/>  479:     Mibs    = [&quot;Test2&quot;, &quot;TestTrap&quot;, &quot;TestTrapv2&quot;],
<a name="480"/>  480:     StdMibs = [&quot;OTP-SNMPEA-MIB&quot;,
<a name="481"/>  481: 	       &quot;SNMP-COMMUNITY-MIB&quot;,
<a name="482"/>  482: 	       &quot;SNMP-FRAMEWORK-MIB&quot;,
<a name="483"/>  483: 	       &quot;SNMP-MPD-MIB&quot;,
<a name="484"/>  484: 	       &quot;SNMP-NOTIFICATION-MIB&quot;,
<a name="485"/>  485: 	       &quot;SNMP-TARGET-MIB&quot;,
<a name="486"/>  486: 	       %% &quot;SNMP-USER-BASED-SM-MIB&quot;,
<a name="487"/>  487: 	       &quot;SNMP-VIEW-BASED-ACM-MIB&quot;,
<a name="488"/>  488: 	       &quot;SNMPv2-MIB&quot;,
<a name="489"/>  489: 	       &quot;SNMPv2-TC&quot;,
<a name="490"/>  490: 	       &quot;SNMPv2-TM&quot;],
<a name="491"/>  491: 
<a name="492"/>  492:     ?DBG(&quot;which_mib -&gt; start symbolic store&quot;, []),
<a name="493"/>  493:     sym_start(Prio, Verbosity),
<a name="494"/>  494: 
<a name="495"/>  495:     ?DBG(&quot;which_mib -&gt; start mib server&quot;, []),
<a name="496"/>  496:     MibsPid = mibs_start(Prio, Verbosity),
<a name="497"/>  497:     
<a name="498"/>  498:     ?DBG(&quot;which_mib -&gt; load mibs&quot;, []),
<a name="499"/>  499:     load_mibs(MibsPid, MibDir, Mibs),
<a name="500"/>  500:     ?DBG(&quot;which_mib -&gt; load std mibs&quot;, []),
<a name="501"/>  501:     load_mibs(MibsPid, StdMibDir, StdMibs),
<a name="502"/>  502: 
<a name="503"/>  503:     ?DBG(&quot;which_mib -&gt; find ~w from SNMP-COMMUNITY-MIB&quot;, 
<a name="504"/>  504: 	 [?snmpTrapCommunity_instance]),
<a name="505"/>  505:     ok = which_mib(MibsPid, ?snmpTrapCommunity_instance,
<a name="506"/>  506: 			 &quot;SNMP-COMMUNITY-MIB&quot;),
<a name="507"/>  507:     
<a name="508"/>  508:     ?DBG(&quot;which_mib -&gt; find ~w from SNMP-VIEW-BASED-ACM-MIB&quot;, 
<a name="509"/>  509: 	 [?vacmViewSpinLock_instance]),
<a name="510"/>  510:     ok = which_mib(MibsPid, ?vacmViewSpinLock_instance,
<a name="511"/>  511: 			 &quot;SNMP-VIEW-BASED-ACM-MIB&quot;),
<a name="512"/>  512:     
<a name="513"/>  513:     ?DBG(&quot;which_mib -&gt; find ~w from SNMP-USER-BASED-SM-MIB (not loaded)&quot;, 
<a name="514"/>  514: 	 [?usmStatsNotInTimeWindows_instance]),
<a name="515"/>  515:     {error, _} = which_mib(MibsPid, ?usmStatsNotInTimeWindows_instance,
<a name="516"/>  516: 				&quot;SNMP-USER-BASED-SM-MIB&quot;),
<a name="517"/>  517:     
<a name="518"/>  518:     ?DBG(&quot;which_mib -&gt; stop mib server&quot;, []),
<a name="519"/>  519:     mibs_stop(MibsPid),
<a name="520"/>  520: 
<a name="521"/>  521:     ?DBG(&quot;which_mib -&gt; stop symbolic store&quot;, []),
<a name="522"/>  522:     sym_stop(),
<a name="523"/>  523: 
<a name="do_which_mib-last_expr"/><a name="524"/>  524:     ok.
<a name="525"/>  525: 
<a name="526"/>  526: 
<a name="527"/>  527: <i>%% ---------------------------------------------------------------------</i>
<a name="528"/>  528: 
<a name="cache_test-1"/><a name="529"/>  529: <b>cache_test</b>(Config) when is_list(Config) -&gt;
<a name="cache_test-last_expr"/><a name="530"/>  530: <b>    tc_try</b>(cache_test,
<a name="531"/>  531:            fun() -&gt; do_cache_test(Config) end).
<a name="532"/>  532: 
<a name="do_cache_test-1"/><a name="533"/>  533: <b>do_cache_test</b>(Config) -&gt;
<a name="534"/>  534:     ?IPRINT(&quot;cache_test -&gt; start&quot;),
<a name="535"/>  535:     Prio       = normal,
<a name="536"/>  536:     %% Verbosity  = trace,
<a name="537"/>  537:     Verbosity  = info,
<a name="538"/>  538:     MibStorage = [{module, snmpa_mib_storage_ets}],
<a name="539"/>  539:     MibDir     = ?config(data_dir, Config),
<a name="540"/>  540:     StdMibDir  = filename:join(code:priv_dir(snmp), &quot;mibs&quot;) ++ &quot;/&quot;,
<a name="541"/>  541:     Mibs       = [&quot;Test2&quot;, &quot;TestTrap&quot;, &quot;TestTrapv2&quot;],
<a name="542"/>  542:     StdMibs    = [&quot;OTP-SNMPEA-MIB&quot;,
<a name="543"/>  543: 		  &quot;SNMP-COMMUNITY-MIB&quot;,
<a name="544"/>  544: 		  &quot;SNMP-FRAMEWORK-MIB&quot;,
<a name="545"/>  545: 		  &quot;SNMP-MPD-MIB&quot;,
<a name="546"/>  546: 		  &quot;SNMP-NOTIFICATION-MIB&quot;,
<a name="547"/>  547: 		  &quot;SNMP-TARGET-MIB&quot;,
<a name="548"/>  548: 		  &quot;SNMP-USER-BASED-SM-MIB&quot;,
<a name="549"/>  549: 		  &quot;SNMP-VIEW-BASED-ACM-MIB&quot;,
<a name="550"/>  550: 		  &quot;SNMPv2-MIB&quot;,
<a name="551"/>  551: 		  &quot;SNMPv2-TC&quot;,
<a name="552"/>  552: 		  &quot;SNMPv2-TM&quot;],
<a name="553"/>  553: 
<a name="554"/>  554:     ?IPRINT(&quot;cache_test -&gt; start symbolic store&quot;),
<a name="555"/>  555:     sym_start(Prio, MibStorage, silence), % Verbosity),
<a name="556"/>  556: 
<a name="557"/>  557:     ?IPRINT(&quot;cache_test -&gt; start mib server&quot;),
<a name="558"/>  558:     GcLimit   = 3,
<a name="559"/>  559:     Age       = timer:seconds(10),
<a name="560"/>  560:     CacheOpts = [{autogc,    false},
<a name="561"/>  561:                  {age,       Age},
<a name="562"/>  562:                  {gclimit,   GcLimit},
<a name="563"/>  563:                  {gcverbose, true}],
<a name="564"/>  564:     MibsPid = mibs_start(Prio, MibStorage, [], Verbosity, CacheOpts),
<a name="565"/>  565:     
<a name="566"/>  566:     ?NPRINT(&quot;Info before load mibs: &quot;
<a name="567"/>  567:             &quot;~n      ~p&quot;, [snmpa_mib:info(MibsPid)]),
<a name="568"/>  568: 
<a name="569"/>  569:     ?IPRINT(&quot;cache_test -&gt; load mibs&quot;),
<a name="570"/>  570:     load_mibs(MibsPid, MibDir, Mibs),
<a name="571"/>  571: 
<a name="572"/>  572:     ?NPRINT(&quot;Info before load std mibs: &quot;
<a name="573"/>  573:             &quot;~n      ~p&quot;, [snmpa_mib:info(MibsPid)]),
<a name="574"/>  574: 
<a name="575"/>  575:     ?IPRINT(&quot;cache_test -&gt; load std mibs&quot;),
<a name="576"/>  576:     load_mibs(MibsPid, StdMibDir, StdMibs),
<a name="577"/>  577: 
<a name="578"/>  578:     ?NPRINT(&quot;Info (after mibs load but) before populate: &quot;
<a name="579"/>  579:             &quot;~n      ~p&quot;, [snmpa_mib:info(MibsPid)]),
<a name="580"/>  580: 
<a name="581"/>  581:     ?IPRINT(&quot;cache_test -&gt; populate the cache&quot;),
<a name="582"/>  582:     ok = populate(MibsPid),
<a name="583"/>  583: 
<a name="584"/>  584:     ?NPRINT(&quot;Info after populate: &quot;
<a name="585"/>  585:             &quot;~n      ~p&quot;, [snmpa_mib:info(MibsPid)]),
<a name="586"/>  586: 
<a name="587"/>  587:     Sz1 = cache_sz_verify(1, MibsPid, any),
<a name="588"/>  588: 
<a name="589"/>  589:     ?IPRINT(&quot;cache_test -&gt; sleep 5 secs&quot;),
<a name="590"/>  590:     ?SLEEP(timer:seconds(5)),
<a name="591"/>  591: 
<a name="592"/>  592:     _ = cache_gc_verify(1, MibsPid),
<a name="593"/>  593: 
<a name="594"/>  594:     ?NPRINT(&quot;Info after 5 sec sleep: &quot;
<a name="595"/>  595:             &quot;~n      ~p&quot;, [snmpa_mib:info(MibsPid)]),
<a name="596"/>  596: 
<a name="597"/>  597:     ?IPRINT(&quot;cache_test -&gt; sleep 10 secs&quot;),
<a name="598"/>  598:     ?SLEEP(timer:seconds(10)),
<a name="599"/>  599: 
<a name="600"/>  600:     ?NPRINT(&quot;Info after 10 sec sleep: &quot;
<a name="601"/>  601:             &quot;~n      ~p&quot;, [snmpa_mib:info(MibsPid)]),
<a name="602"/>  602: 
<a name="603"/>  603:     GcLimit1 = cache_gc_verify(2, MibsPid, Age, GcLimit + 1),
<a name="604"/>  604: 
<a name="605"/>  605:     Sz2 = cache_sz_verify(2, MibsPid, Sz1 - GcLimit1),
<a name="606"/>  606: 
<a name="607"/>  607: 
<a name="608"/>  608:     ?IPRINT(&quot;cache_test -&gt; subscribe to GC events&quot;),
<a name="609"/>  609:     ok = snmpa_mib:subscribe_gc_events(MibsPid),
<a name="610"/>  610: 
<a name="611"/>  611:     ?IPRINT(&quot;cache_test -&gt; enable cache autogc&quot;),
<a name="612"/>  612:     ok = snmpa_mib:enable_cache_autogc(MibsPid),
<a name="613"/>  613: 
<a name="614"/>  614:     ?IPRINT(&quot;cache_test -&gt; wait 65 seconds to allow gc to happen&quot;),
<a name="615"/>  615:     ?SLEEP(timer:seconds(65)),
<a name="616"/>  616: 
<a name="617"/>  617:     ?NPRINT(&quot;Info after 65 sec sleep: &quot;
<a name="618"/>  618:             &quot;~n      ~p&quot;, [snmpa_mib:info(MibsPid)]),
<a name="619"/>  619: 
<a name="620"/>  620:     ?IPRINT(&quot;cache_test -&gt; [1] flush expected GC events&quot;),
<a name="621"/>  621:     {NumEvents1, TotGC1} = cache_flush_gc_events(MibsPid),
<a name="622"/>  622:     ?IPRINT(&quot;cache_test -&gt; GC events: &quot;
<a name="623"/>  623:             &quot;~n      Number of Events:    ~p&quot;
<a name="624"/>  624:             &quot;~n      Total elements GCed: ~p&quot;, [NumEvents1, TotGC1]),
<a name="625"/>  625: 
<a name="626"/>  626:     _ = cache_sz_verify(3, MibsPid, Sz2 - GcLimit),
<a name="627"/>  627: 
<a name="628"/>  628:     ?IPRINT(&quot;cache_test -&gt; &quot;
<a name="629"/>  629:             &quot;wait 2 minutes to allow gc to happen, expect empty cache&quot;),
<a name="630"/>  630:     ?SLEEP(timer:minutes(2)),
<a name="631"/>  631: 
<a name="632"/>  632:     ?NPRINT(&quot;Info after 2 min sleep: &quot;
<a name="633"/>  633:             &quot;~n      ~p&quot;, [snmpa_mib:info(MibsPid)]),
<a name="634"/>  634: 
<a name="635"/>  635:     _ = cache_sz_verify(4, MibsPid, 0),
<a name="636"/>  636: 
<a name="637"/>  637: 
<a name="638"/>  638:     ?IPRINT(&quot;cache_test -&gt; change gclimit to infinity&quot;),
<a name="639"/>  639:     snmpa_mib:update_cache_gclimit(MibsPid, infinity),
<a name="640"/>  640: 
<a name="641"/>  641:     ?IPRINT(&quot;cache_test -&gt; change age to ~w mins&quot;, [3]),
<a name="642"/>  642:     snmpa_mib:update_cache_age(MibsPid, ?MINS(3)),
<a name="643"/>  643: 
<a name="644"/>  644:     ?IPRINT(&quot;cache_test -&gt; [2] flush expected GC events&quot;),
<a name="645"/>  645:     {NumEvents2, TotGC2} = cache_flush_gc_events(MibsPid),
<a name="646"/>  646:     ?IPRINT(&quot;cache_test -&gt; GC events: &quot;
<a name="647"/>  647:             &quot;~n      Number of Events:    ~p&quot;
<a name="648"/>  648:             &quot;~n      Total elements GCed: ~p&quot;, [NumEvents2, TotGC2]),
<a name="649"/>  649: 
<a name="650"/>  650:     ?IPRINT(&quot;cache_test -&gt; populate the cache again&quot;),
<a name="651"/>  651:     populate(MibsPid),
<a name="652"/>  652: 
<a name="653"/>  653:     ?IPRINT(&quot;cache_test -&gt; validate cache size&quot;),
<a name="654"/>  654:     {ok, Sz4} = snmpa_mib:which_cache_size(MibsPid),
<a name="655"/>  655:     if (Sz4 &gt; 0) -&gt;
<a name="656"/>  656:             ?IPRINT(&quot;cache_test -&gt; expected cache size: ~w &gt; 0&quot;, [Sz4]);
<a name="657"/>  657:        true      -&gt;
<a name="658"/>  658:             ?EPRINT(&quot;cache_test -&gt; cache *not* populated&quot;),
<a name="659"/>  659:             ?FAIL(cache_not_populated)
<a name="660"/>  660:     end,    
<a name="661"/>  661: 
<a name="662"/>  662:     ?NPRINT(&quot;Info after poulated: &quot;
<a name="663"/>  663:             &quot;~n      ~p&quot;, [snmpa_mib:info(MibsPid)]),
<a name="664"/>  664: 
<a name="665"/>  665:     ?IPRINT(&quot;cache_test -&gt; wait 2 mins - before tuching some entries&quot;),
<a name="666"/>  666:     ?SLEEP(?MINS(2)),
<a name="667"/>  667: 
<a name="668"/>  668:     %% There should not be anything GC:ed
<a name="669"/>  669: 
<a name="670"/>  670:     receive
<a name="671"/>  671:         {MibsPid, gc_result, {ok, NGC1}} -&gt;
<a name="672"/>  672:             ?EPRINT(&quot;cache_test -&gt; unexpected GC of ~w elements&quot;, [NGC1]),
<a name="673"/>  673:             exit({unexpected_gc_result, NGC1})
<a name="674"/>  674:     after 0 -&gt;
<a name="675"/>  675:             ok
<a name="676"/>  676:     end,
<a name="677"/>  677: 
<a name="678"/>  678:     ?IPRINT(&quot;cache_test -&gt; touch some elements again (update the cache)&quot;),
<a name="679"/>  679:     populate_lookup(MibsPid),
<a name="680"/>  680: 
<a name="681"/>  681:     ?IPRINT(&quot;cache_test -&gt; await partial GC&quot;),
<a name="682"/>  682:     NumGC2 =
<a name="683"/>  683:         receive
<a name="684"/>  684:             {MibsPid, gc_result, {ok, NGC2}} 
<a name="685"/>  685:               when (NGC2 &gt; 0) andalso (Sz4 &gt; NGC2) -&gt;
<a name="686"/>  686:                 ?NPRINT(&quot;cache_test -&gt; &quot;
<a name="687"/>  687:                         &quot;received partial GC result of ~w elements&quot;, [NGC2]),
<a name="688"/>  688:                 NGC2
<a name="689"/>  689:         end,
<a name="690"/>  690: 
<a name="691"/>  691:     ?NPRINT(&quot;Info after partial GC: &quot;
<a name="692"/>  692:             &quot;~n      ~p&quot;, [snmpa_mib:info(MibsPid)]),
<a name="693"/>  693: 
<a name="694"/>  694: 
<a name="695"/>  695:     ?IPRINT(&quot;cache_test -&gt; await final GC&quot;),
<a name="696"/>  696:     receive
<a name="697"/>  697:         {MibsPid, gc_result, {ok, NGC3}} 
<a name="698"/>  698:           when (NGC3 &gt; 0) andalso ((Sz4 - NumGC2) =:= NGC3) -&gt;
<a name="699"/>  699:             ?NPRINT(&quot;cache_test -&gt; &quot;
<a name="700"/>  700:                     &quot;received final GC result of ~w elements&quot;, [NGC3]),
<a name="701"/>  701:             NGC3;
<a name="702"/>  702:         Any -&gt;
<a name="703"/>  703:             ?EPRINT(&quot;cache_test -&gt; unexpected message: &quot;
<a name="704"/>  704:                     &quot;~n      ~p&quot;, [Any]),
<a name="705"/>  705:             ?FAIL({unexpected, Any})
<a name="706"/>  706:     end,
<a name="707"/>  707: 
<a name="708"/>  708:     ?NPRINT(&quot;Info after final GC: &quot;
<a name="709"/>  709:             &quot;~n      ~p&quot;, [snmpa_mib:info(MibsPid)]),
<a name="710"/>  710: 
<a name="711"/>  711:     ?IPRINT(&quot;cache_test -&gt; validate cache size (expect empty)&quot;),
<a name="712"/>  712:     {ok, Sz5} = snmpa_mib:which_cache_size(MibsPid),
<a name="713"/>  713:     if (Sz5 =:= 0) -&gt;
<a name="714"/>  714:             ?IPRINT(&quot;cache_test -&gt; expected cache size: 0&quot;);
<a name="715"/>  715:        true      -&gt;
<a name="716"/>  716:             ?EPRINT(&quot;cache_test -&gt; cache *not* empty (~w)&quot;, [Sz5]),
<a name="717"/>  717:             ?FAIL({cache_populated, Sz5})
<a name="718"/>  718:     end,
<a name="719"/>  719: 
<a name="720"/>  720: 
<a name="721"/>  721:     ?IPRINT(&quot;cache_test -&gt; stop mib server&quot;),
<a name="722"/>  722:     mibs_stop(MibsPid),
<a name="723"/>  723: 
<a name="724"/>  724:     ?IPRINT(&quot;cache_test -&gt; stop symbolic store&quot;),
<a name="725"/>  725:     sym_stop(),
<a name="726"/>  726: 
<a name="727"/>  727:     ?IPRINT(&quot;cache_test -&gt; end&quot;),
<a name="do_cache_test-last_expr"/><a name="728"/>  728:     ok.
<a name="729"/>  729: 
<a name="populate-1"/><a name="730"/>  730: <b>populate</b>(MibsPid) -&gt;
<a name="731"/>  731:     %% Make some lookups
<a name="732"/>  732:     populate_lookup(MibsPid),
<a name="733"/>  733:     %% Make some walk's
<a name="populate-last_expr"/><a name="734"/>  734: <b>    populate_walk</b>(MibsPid).
<a name="735"/>  735: 
<a name="populate_lookup-1"/><a name="736"/>  736: <b>populate_lookup</b>(MibsPid) -&gt;    
<a name="737"/>  737:     {variable, _} = snmpa_mib:lookup(MibsPid, ?snmpTrapCommunity_instance),
<a name="738"/>  738:     {variable, _} = snmpa_mib:lookup(MibsPid, ?vacmViewSpinLock_instance),
<a name="739"/>  739:     {variable, _} = snmpa_mib:lookup(MibsPid, ?usmStatsNotInTimeWindows_instance),
<a name="740"/>  740:     {variable, _} = snmpa_mib:lookup(MibsPid, ?tDescr_instance),
<a name="populate_lookup-last_expr"/><a name="741"/>  741:     ok.
<a name="742"/>  742: 
<a name="populate_walk-1"/><a name="743"/>  743: <b>populate_walk</b>(MibsPid) -&gt;
<a name="744"/>  744:     MibView = snmpa_acm:get_root_mib_view(),
<a name="745"/>  745:     walk(MibsPid, ?snmpTrapCommunity_instance,        MibView),
<a name="746"/>  746:     walk(MibsPid, ?vacmViewSpinLock_instance,         MibView),
<a name="747"/>  747:     walk(MibsPid, ?usmStatsNotInTimeWindows_instance, MibView),
<a name="748"/>  748:     walk(MibsPid, ?tDescr_instance,                   MibView),
<a name="populate_walk-last_expr"/><a name="749"/>  749:     ok.
<a name="750"/>  750: 
<a name="walk-3"/><a name="751"/>  751: <b>walk</b>(MibsPid, Oid, MibView) -&gt;
<a name="752"/>  752:     ?IPRINT(&quot;walk -&gt; entry with&quot;
<a name="753"/>  753:             &quot;~n      Oid: ~p&quot;, [Oid]),
<a name="walk-last_expr"/><a name="754"/>  754: <b>    do_walk</b>(MibsPid, Oid, MibView).
<a name="755"/>  755: 
<a name="do_walk-3"/><a name="756"/>  756: <b>do_walk</b>(MibsPid, Oid, MibView) -&gt;
<a name="757"/>  757:     ?IPRINT(&quot;do_walk -&gt; entry with&quot;
<a name="758"/>  758:             &quot;~n   Oid: ~p&quot;
<a name="759"/>  759:             &quot;~n&quot;, [Oid]),
<a name="do_walk-last_expr"/><a name="760"/>  760: <b>    case snmpa_mib:next</b>(MibsPid, Oid, MibView) of
<a name="761"/>  761: 	{table, _, _, #me{oid = Oid}} -&gt;
<a name="762"/>  762:             ?IPRINT(&quot;do_walk -&gt; done for table (~p)&quot;, [Oid]),
<a name="763"/>  763: 	    ok;
<a name="764"/>  764: 	{table, _, _, #me{oid = Next}} -&gt;
<a name="765"/>  765:             ?IPRINT(&quot;do_walk -&gt; table next ~p&quot;, [Next]),
<a name="766"/>  766: 	    do_walk(MibsPid, Next, MibView);
<a name="767"/>  767: 	{variable, #me{oid = Oid}, _} -&gt;
<a name="768"/>  768:             ?IPRINT(&quot;do_walk -&gt; done for variable (~p)&quot;, [Oid]),
<a name="769"/>  769: 	    ok;
<a name="770"/>  770: 	{variable, #me{oid = Next}, _} -&gt;
<a name="771"/>  771:             ?IPRINT(&quot;do_walk -&gt; variable next ~p&quot;, [Next]),
<a name="772"/>  772: 	    do_walk(MibsPid, Next, MibView)
<a name="773"/>  773:     end.
<a name="774"/>  774: 
<a name="775"/>  775: 
<a name="cache_gc_verify-2"/><a name="776"/>  776: <b>cache_gc_verify</b>(ID, MibsPid) -&gt;
<a name="777"/>  777:     GC = fun() -&gt; snmpa_mib:gc_cache(MibsPid) end,
<a name="cache_gc_verify-last_expr"/><a name="778"/>  778: <b>    cache_gc_verify</b>(ID, GC, 0).
<a name="779"/>  779: 
<a name="cache_gc_verify-4"/><a name="780"/>  780: <b>cache_gc_verify</b>(ID, MibsPid, Age, ExpectedGcLimit) -&gt;
<a name="781"/>  781:     GC = fun() -&gt; snmpa_mib:gc_cache(MibsPid, Age, ExpectedGcLimit) end,
<a name="cache_gc_verify-last_expr"/><a name="782"/>  782: <b>    cache_gc_verify</b>(ID, GC, ExpectedGcLimit).
<a name="783"/>  783: 
<a name="cache_gc_verify-3"/><a name="784"/>  784: <b>cache_gc_verify</b>(ID, GC, ExpectedGc) -&gt;
<a name="785"/>  785:     ?IPRINT(&quot;cache_gc_verify -&gt; [~w] perform gc, expect ~w&quot;, [ID, ExpectedGc]),
<a name="cache_gc_verify-last_expr"/><a name="786"/>  786: <b>    case GC</b>() of
<a name="787"/>  787:         {ok, ExpectedGc} -&gt;
<a name="788"/>  788:             ?IPRINT(&quot;cache_gc_verify -&gt; [~w] gc =&gt; ok&quot;, [ID]),
<a name="789"/>  789:             ExpectedGc;
<a name="790"/>  790:         {ok, OtherGc} -&gt;
<a name="791"/>  791:             ?IPRINT(&quot;cache_gc_verify -&gt; [~w] invalid GC limit: &quot;
<a name="792"/>  792:                     &quot;~n      Expected: ~p&quot;
<a name="793"/>  793:                     &quot;~n      Got:      ~p&quot;,
<a name="794"/>  794:                     [ID, ExpectedGc, OtherGc]),
<a name="795"/>  795:             exit({ID, invalid_gc_limit, {ExpectedGc, OtherGc}});
<a name="796"/>  796:         Unexpected -&gt;
<a name="797"/>  797:             ?IPRINT(&quot;cache_gc_verify -&gt; [~w] unexpected: &quot;
<a name="798"/>  798:                     &quot;~n      ~p&quot;,
<a name="799"/>  799:                     [ID, Unexpected]),
<a name="800"/>  800:             exit({ID, unexpected, Unexpected})
<a name="801"/>  801:     end.
<a name="802"/>  802: 
<a name="803"/>  803: 
<a name="cache_sz_verify-3"/><a name="804"/>  804: <b>cache_sz_verify</b>(ID, MibsPid, ExpectedSz) -&gt;
<a name="805"/>  805:     ?IPRINT(&quot;cache_sz_verify -&gt; [~w] expect size ~w&quot;, [ID, ExpectedSz]),
<a name="cache_sz_verify-last_expr"/><a name="806"/>  806: <b>    case snmpa_mib:which_cache_size</b>(MibsPid) of
<a name="807"/>  807:         {ok, ExpectedSz} -&gt;
<a name="808"/>  808:             ?IPRINT(&quot;cache_sz_verify -&gt; [~w] sz =&gt; ok&quot;, [ID]),
<a name="809"/>  809:             ExpectedSz;
<a name="810"/>  810:         {ok, UnexpectedSz} when (ExpectedSz =:= any) -&gt;
<a name="811"/>  811:             ?IPRINT(&quot;cache_sz_verify -&gt; [~w] sz =&gt; ok (~w)&quot;, [ID, UnexpectedSz]),
<a name="812"/>  812:             UnexpectedSz;
<a name="813"/>  813:         {ok, UnexpectedSz} -&gt;
<a name="814"/>  814:             ?IPRINT(&quot;cache_sz_verify -&gt; [~w] invalid size: &quot;
<a name="815"/>  815:                     &quot;~n      Expected: ~p&quot;
<a name="816"/>  816:                     &quot;~n      Got:      ~p&quot;,
<a name="817"/>  817:                     [ID, ExpectedSz, UnexpectedSz]),
<a name="818"/>  818:             exit({ID, invalid_size, {ExpectedSz, UnexpectedSz}});
<a name="819"/>  819:         Unexpected -&gt;
<a name="820"/>  820:             ?IPRINT(&quot;cache_sz_verify -&gt; [~w] unexpected: &quot;
<a name="821"/>  821:                     &quot;~n      ~p&quot;,
<a name="822"/>  822:                     [ID, Unexpected]),
<a name="823"/>  823:             exit({ID, unexpected, Unexpected})
<a name="824"/>  824:     end.
<a name="825"/>  825: 
<a name="826"/>  826: 
<a name="cache_flush_gc_events-1"/><a name="827"/>  827: <b>cache_flush_gc_events</b>(MibServer) -&gt;
<a name="cache_flush_gc_events-last_expr"/><a name="828"/>  828: <b>    cache_flush_gc_events</b>(MibServer, 0, 0).
<a name="829"/>  829: 
<a name="cache_flush_gc_events-3"/><a name="830"/>  830: <b>cache_flush_gc_events</b>(MibServer, NumEvents, TotGC) -&gt;
<a name="cache_flush_gc_events-last_expr"/><a name="831"/>  831:     receive
<a name="832"/>  832:         {MibServer, gc_result, {ok, NumGC}} -&gt;
<a name="833"/>  833:             ?IPRINT(&quot;cache_flush_gc_events -&gt; GC event ~w (~w)&quot;,
<a name="834"/>  834:                     [NumGC, NumEvents]),
<a name="835"/>  835:             cache_flush_gc_events(MibServer, NumEvents+1, TotGC+NumGC)
<a name="836"/>  836:     after 0 -&gt;
<a name="837"/>  837:             if
<a name="838"/>  838:                 (NumEvents =:= 0) andalso (TotGC =:= 0) -&gt;
<a name="839"/>  839:                     ?IPRINT(&quot;cache_flush_gc_events -&gt; no GC events&quot;),
<a name="840"/>  840:                     exit(no_gc_events);
<a name="841"/>  841:                 true -&gt;
<a name="842"/>  842:                     {NumEvents, TotGC}
<a name="843"/>  843:             end
<a name="844"/>  844:     end.
<a name="845"/>  845: 
<a name="846"/>  846: 
<a name="847"/>  847: <i>%%======================================================================</i>
<a name="848"/>  848: <i>%% Internal functions</i>
<a name="849"/>  849: <i>%%======================================================================</i>
<a name="850"/>  850: 
<a name="851"/>  851: <i>%% -- Mnesia functions</i>
<a name="852"/>  852: 
<a name="mnesia_start-1"/><a name="853"/>  853: <b>mnesia_start</b>(Opts) -&gt;
<a name="mnesia_start-last_expr"/><a name="854"/>  854: <b>    mnesia_start</b>(Opts, [node()]).
<a name="855"/>  855: 
<a name="mnesia_start-2"/><a name="856"/>  856: <b>mnesia_start</b>(Opts, Nodes) -&gt;
<a name="857"/>  857:     %% We can accept mnesia being loaded but *not* started.
<a name="858"/>  858:     %% If its started it *may* contain data that will invalidate
<a name="859"/>  859:     %% this test case.
<a name="860"/>  860:     ?IPRINT(&quot;mnesia_start -&gt; try load mnesia when:&quot;
<a name="861"/>  861:             &quot;~n   Loaded:  ~p&quot;
<a name="862"/>  862:             &quot;~n   Running: ~p&quot;, [apps_loaded(), apps_running()]),
<a name="863"/>  863:     ok = case application:load(mnesia) of
<a name="864"/>  864:                    ok -&gt;
<a name="865"/>  865:                        ok;
<a name="866"/>  866:                    {error, {already_loaded, mnesia}} -&gt;
<a name="867"/>  867:                        ok;
<a name="868"/>  868:                    {error, _} = ERROR -&gt;
<a name="869"/>  869:                        ERROR
<a name="870"/>  870:                end,
<a name="871"/>  871:     F = fun({Key, Val}) -&gt;
<a name="872"/>  872: 		?IPRINT(&quot;mnesia_start -&gt; try set mnesia env: &quot;
<a name="873"/>  873:                         &quot;~n   ~p -&gt; ~p&quot;, [Key, Val]),
<a name="874"/>  874: 		application_controller:set_env(mnesia, Key, Val)
<a name="875"/>  875: 	end,
<a name="876"/>  876:     lists:foreach(F, Opts),
<a name="877"/>  877:     ?IPRINT(&quot;mnesia_start -&gt; create mnesia schema on ~p&quot;, [Nodes]),
<a name="878"/>  878:     case mnesia:create_schema(Nodes) of
<a name="879"/>  879:               ok -&gt;
<a name="880"/>  880:                   ok;
<a name="881"/>  881:               {error, {_, {already_exist, _}}} -&gt;
<a name="882"/>  882:                   throw({skip, &quot;Mnesia schema already exists&quot;});
<a name="883"/>  883:               {error, SchemaReason} -&gt;
<a name="884"/>  884:                   throw({skip,
<a name="885"/>  885:                          ?F(&quot;Failed create mnesia schema: ~p&quot;, [SchemaReason])})
<a name="886"/>  886:           end,
<a name="887"/>  887:     ?IPRINT(&quot;mnesia_start -&gt; start mnesia&quot;, []),
<a name="888"/>  888:     case application:start(mnesia) of
<a name="889"/>  889:               ok -&gt;
<a name="890"/>  890:                   ok;
<a name="891"/>  891:               {error, {already_started, mnesia}} -&gt;
<a name="892"/>  892:                   throw({skip, &quot;Mnesia already started&quot;});
<a name="893"/>  893:               {error, StartReason} -&gt;
<a name="894"/>  894:                   throw({skip,
<a name="895"/>  895:                          ?F(&quot;Failed starting mnesia: ~p&quot;, [StartReason])})
<a name="896"/>  896:           end,
<a name="897"/>  897:     ?IPRINT(&quot;mnesia_start -&gt; mnesia started&quot;, []),
<a name="mnesia_start-last_expr"/><a name="898"/>  898:     ok.
<a name="899"/>  899: 
<a name="mnesia_stop-0"/><a name="900"/>  900: <b>mnesia_stop</b>() -&gt;
<a name="901"/>  901:     ?IPRINT(&quot;mnesia_stop -&gt; try stop mnesia when:&quot;
<a name="902"/>  902:             &quot;~n   Loaded:  ~p&quot;
<a name="903"/>  903:             &quot;~n   Running: ~p&quot;, [apps_loaded(), apps_running()]),
<a name="904"/>  904:     application:stop(mnesia),
<a name="905"/>  905:     ?IPRINT(&quot;mnesia_stop -&gt; try unload mnesia when&quot;
<a name="906"/>  906:             &quot;~n   Loaded:  ~p&quot;
<a name="907"/>  907:             &quot;~n   Running: ~p&quot;, [apps_loaded(), apps_running()]),
<a name="908"/>  908:     application:unload(mnesia),
<a name="909"/>  909:     ?IPRINT(&quot;mnesia_stop -&gt; done when:&quot;
<a name="910"/>  910:             &quot;~n   Loaded:  ~p&quot;
<a name="911"/>  911:             &quot;~n   Running: ~p&quot;, [apps_loaded(), apps_running()]),
<a name="mnesia_stop-last_expr"/><a name="912"/>  912:     ok.
<a name="913"/>  913: 
<a name="apps_loaded-0"/><a name="914"/>  914: <b>apps_loaded</b>() -&gt;
<a name="apps_loaded-last_expr"/><a name="915"/>  915: <b>    [App || {App, _, _} &lt;- application:loaded_applications</b>()].
<a name="916"/>  916: 
<a name="apps_running-0"/><a name="917"/>  917: <b>apps_running</b>() -&gt;
<a name="apps_running-last_expr"/><a name="918"/>  918: <b>    [App || {App, _, _} &lt;- application:which_applications</b>()].
<a name="919"/>  919: 
<a name="920"/>  920: 
<a name="921"/>  921: <i>%% - Symbolic Store mini interface</i>
<a name="922"/>  922: 
<a name="sym_start-2"/><a name="923"/>  923: <b>sym_start</b>(Prio, Verbosity) -&gt;
<a name="sym_start-last_expr"/><a name="924"/>  924: <b>    sym_start</b>(Prio, mib_storage(), Verbosity).
<a name="925"/>  925: 
<a name="sym_start-3"/><a name="926"/>  926: <b>sym_start</b>(Prio, MibStorage, Verbosity) -&gt;
<a name="927"/>  927:     Opts = [{mib_storage, MibStorage}, {verbosity,Verbosity}],
<a name="928"/>  928:     {ok, _Pid} = snmpa_symbolic_store:start_link(Prio, Opts),
<a name="sym_start-last_expr"/><a name="929"/>  929:     ok.
<a name="930"/>  930: 
<a name="sym_stop-0"/><a name="931"/>  931: <b>sym_stop</b>() -&gt;
<a name="sym_stop-last_expr"/><a name="932"/>  932: <b>    ok = snmpa_symbolic_store:stop</b>().
<a name="933"/>  933: 
<a name="sym_info-0"/><a name="934"/>  934: <b>sym_info</b>() -&gt;
<a name="sym_info-last_expr"/><a name="935"/>  935: <b>    snmpa_symbolic_store:info</b>().
<a name="936"/>  936: 
<a name="937"/>  937: 
<a name="938"/>  938: <i>%% -- MIB server mini interface </i>
<a name="939"/>  939: 		   
<a name="mibs_start-2"/><a name="940"/>  940: <b>mibs_start</b>(Prio, Verbosity) when is_atom(Prio) andalso is_atom(Verbosity) -&gt;
<a name="mibs_start-last_expr"/><a name="941"/>  941: <b>    mibs_start</b>(Prio, mib_storage(), [], Verbosity).
<a name="942"/>  942: 
<a name="mibs_start-3"/><a name="943"/>  943: <b>mibs_start</b>(Prio, MibStorage, Verbosity) 
<a name="944"/>  944:   when is_atom(Prio) andalso is_atom(Verbosity) -&gt;
<a name="mibs_start-last_expr"/><a name="945"/>  945: <b>    mibs_start</b>(Prio, MibStorage, [], Verbosity).
<a name="946"/>  946: 
<a name="mibs_start-4"/><a name="947"/>  947: <b>mibs_start</b>(Prio, MibStorage, Mibs, Verbosity) 
<a name="948"/>  948:   when is_atom(Prio)       andalso 
<a name="949"/>  949:        is_list(Mibs)       andalso 
<a name="950"/>  950:        is_atom(Verbosity) -&gt;
<a name="mibs_start-last_expr"/><a name="951"/>  951: <b>    mibs_start</b>(Prio, MibStorage, Mibs, Verbosity, []).
<a name="952"/>  952: 
<a name="mibs_start-5"/><a name="953"/>  953: <b>mibs_start</b>(Prio, MibStorage, Mibs, Verbosity, CacheOpts) 
<a name="954"/>  954:   when is_atom(Prio)       andalso 
<a name="955"/>  955:        is_list(Mibs)       andalso 
<a name="956"/>  956:        is_atom(Verbosity)  andalso 
<a name="957"/>  957:        is_list(CacheOpts) -&gt;
<a name="958"/>  958:     Opts = [{mib_storage, MibStorage}, 
<a name="959"/>  959: 	    {verbosity,   Verbosity}, 
<a name="960"/>  960: 	    {cache,       CacheOpts}],
<a name="961"/>  961:     {ok, Pid} = snmpa_mib:start_link(Prio, Mibs, Opts),
<a name="mibs_start-last_expr"/><a name="962"/>  962:     Pid.
<a name="963"/>  963: 
<a name="mibs_stop-1"/><a name="964"/>  964: <b>mibs_stop</b>(Pid) -&gt;
<a name="mibs_stop-last_expr"/><a name="965"/>  965: <b>    ok = snmpa_mib:stop</b>(Pid).
<a name="966"/>  966: 
<a name="mibs_info-1"/><a name="967"/>  967: <b>mibs_info</b>(Pid) -&gt;
<a name="mibs_info-last_expr"/><a name="968"/>  968: <b>    snmpa_mib:info</b>(Pid).
<a name="969"/>  969: 
<a name="load_mibs-3"/><a name="970"/>  970: <b>load_mibs</b>(Pid, Dir, Mibs0) -&gt;
<a name="971"/>  971:     Mibs = [join(Dir, Mib) || Mib &lt;- Mibs0],
<a name="972"/>  972:     Res = snmpa_mib:load_mibs(Pid, Mibs, false),
<a name="973"/>  973:     %% ?DBG(&quot;load_mibs -&gt; &quot;
<a name="974"/>  974:     %% 	 &quot;~n   Res: ~p&quot;, [Res]),
<a name="load_mibs-last_expr"/><a name="975"/>  975:     Res.
<a name="976"/>  976: 
<a name="unload_mibs-2"/><a name="977"/>  977: <b>unload_mibs</b>(Pid, Mibs) -&gt;
<a name="978"/>  978:     Res = snmpa_mib:unload_mibs(Pid, Mibs, false),
<a name="979"/>  979:     %% ?DBG(&quot;unload_mibs -&gt; &quot;
<a name="980"/>  980:     %% 	 &quot;~n   Res: ~p&quot;, [Res]),
<a name="unload_mibs-last_expr"/><a name="981"/>  981:     Res.
<a name="982"/>  982: 
<a name="verify_loaded_mibs-3"/><a name="983"/>  983: <b>verify_loaded_mibs</b>(Pid, Dir, ExpectedMibs0) -&gt;
<a name="984"/>  984:     ExpectedMibs = [join(Dir, Mib) || Mib &lt;- ExpectedMibs0],
<a name="verify_loaded_mibs-last_expr"/><a name="985"/>  985: <b>    case snmpa_mib:info</b>(Pid, loaded_mibs) of
<a name="986"/>  986: 	ExpectedMibs -&gt;
<a name="987"/>  987: 	    ok;
<a name="988"/>  988: 	LoadedMibs0 -&gt;
<a name="989"/>  989: 	    ?DBG(&quot;verify_loaded_mibs -&gt; LoadedMibs0: ~p&quot;, [LoadedMibs0]),
<a name="990"/>  990: 	    LoadedMibs = [filename:rootname(FN, &quot;.bin&quot;) || FN &lt;- LoadedMibs0],
<a name="991"/>  991: 	    ?DBG(&quot;verify_loaded_mibs -&gt; LoadedMibs: ~p&quot;, [LoadedMibs]),
<a name="992"/>  992: 	    ExpNotLoadedMibs = ExpectedMibs -- LoadedMibs,
<a name="993"/>  993: 	    LoadedNotExpMibs = LoadedMibs -- ExpectedMibs,
<a name="994"/>  994: 	    ?DBG(&quot;verify_loaded_mibs -&gt; &quot;
<a name="995"/>  995: 		 &quot;~n   ExpNotLoadedMibs: ~p&quot;
<a name="996"/>  996: 		 &quot;~n   LoadedNotExpMibs: ~p&quot;, 
<a name="997"/>  997: 		 [ExpNotLoadedMibs, LoadedNotExpMibs]),
<a name="998"/>  998: 	    case ExpNotLoadedMibs of
<a name="999"/>  999: 		[] -&gt;
<a name="1000"/> 1000: 		    case LoadedNotExpMibs of
<a name="1001"/> 1001: 			[] -&gt;
<a name="1002"/> 1002: 			    ok;
<a name="1003"/> 1003: 			_ -&gt;
<a name="1004"/> 1004: 			    {error, {unexpected_loaded_mibs, LoadedNotExpMibs}}
<a name="1005"/> 1005: 		    end;
<a name="1006"/> 1006: 		_ -&gt;
<a name="1007"/> 1007: 		    case LoadedNotExpMibs of
<a name="1008"/> 1008: 			[] -&gt;
<a name="1009"/> 1009: 			    {error, {not_loaded_mibs, ExpNotLoadedMibs}};
<a name="1010"/> 1010: 			_ -&gt;
<a name="1011"/> 1011: 			    {error, {unexpected_mibs, 
<a name="1012"/> 1012: 				     ExpNotLoadedMibs, LoadedNotExpMibs}}
<a name="1013"/> 1013: 		    end
<a name="1014"/> 1014: 	    end
<a name="1015"/> 1015: 	
<a name="1016"/> 1016:     end.
<a name="1017"/> 1017: 
<a name="me_lookup-2"/><a name="1018"/> 1018: <b>me_lookup</b>(Pid, Oid) -&gt;    
<a name="me_lookup-last_expr"/><a name="1019"/> 1019: <b>    case snmpa_mib:lookup</b>(Pid, Oid) of
<a name="1020"/> 1020: 	{variable, #me{oid = Oid}} -&gt;
<a name="1021"/> 1021: 	    ok;
<a name="1022"/> 1022: 	{variable, #me{oid = OtherOid}} -&gt;
<a name="1023"/> 1023: 	    case lists:reverse(Oid) of
<a name="1024"/> 1024: 		[0|Rest] -&gt;
<a name="1025"/> 1025: 		    case lists:reverse(Rest) of
<a name="1026"/> 1026: 			OtherOid -&gt;
<a name="1027"/> 1027: 			    ok;
<a name="1028"/> 1028: 			AnotherOid -&gt;
<a name="1029"/> 1029: 			    {error, {invalid_oid, Oid, AnotherOid}}
<a name="1030"/> 1030: 		    end;
<a name="1031"/> 1031: 		_ -&gt;
<a name="1032"/> 1032: 		    {error, {invalid_oid, Oid, OtherOid}}
<a name="1033"/> 1033: 	    end;
<a name="1034"/> 1034: 	{table_column, _ME, _TableEntryOid} -&gt;
<a name="1035"/> 1035:             ok;
<a name="1036"/> 1036:         {subagent, SubAgentPid, _SANextOid} -&gt;
<a name="1037"/> 1037:             {error, {subagent, SubAgentPid}};
<a name="1038"/> 1038:         {false, Reason} -&gt;
<a name="1039"/> 1039:             {error, Reason};
<a name="1040"/> 1040:         Else -&gt;
<a name="1041"/> 1041:             {error, Else}
<a name="1042"/> 1042:     end.
<a name="1043"/> 1043: 
<a name="1044"/> 1044: 			    
<a name="which_mib-3"/><a name="1045"/> 1045: <b>which_mib</b>(Pid, Oid, Mib1) -&gt;    
<a name="which_mib-last_expr"/><a name="1046"/> 1046: <b>    case snmpa_mib:which_mib</b>(Pid, Oid) of
<a name="1047"/> 1047: 	{ok, Mib2} when is_atom(Mib2) -&gt;
<a name="1048"/> 1048: 	    Mib3 = atom_to_list(Mib2),
<a name="1049"/> 1049: 	    which_mib(Mib1, Mib3);
<a name="1050"/> 1050: 	{ok, Mib2} -&gt;
<a name="1051"/> 1051: 	    which_mib(Mib1, Mib2);
<a name="1052"/> 1052:         {error, Reason} -&gt;
<a name="1053"/> 1053:             {error, Reason};
<a name="1054"/> 1054:         Else -&gt;
<a name="1055"/> 1055:             {error, Else}
<a name="1056"/> 1056:     end.
<a name="1057"/> 1057: 
<a name="which_mib-2"/><a name="1058"/> 1058: <b>which_mib</b>(M, M) -&gt;
<a name="1059"/> 1059:     ok;
<a name="1060"/> 1060: <b>which_mib</b>(M1, M2) -&gt;
<a name="which_mib-last_expr"/><a name="1061"/> 1061:     {error, {invalid_mib, M1, M2}}.
<a name="1062"/> 1062: 
<a name="1063"/> 1063: 
<a name="1064"/> 1064: <i>%% Default mib-storage</i>
<a name="mib_storage-0"/><a name="1065"/> 1065: <b>mib_storage</b>() -&gt;
<a name="mib_storage-last_expr"/><a name="1066"/> 1066:     [{module, snmpa_mib_storage_ets}].
<a name="1067"/> 1067: 
<a name="1068"/> 1068: 
<a name="1069"/> 1069: <i>%% --</i>
<a name="1070"/> 1070: 
<a name="tc_try-2"/><a name="1071"/> 1071: <b>tc_try</b>(Name, TC) -&gt;
<a name="tc_try-last_expr"/><a name="1072"/> 1072: <b>    tc_try</b>(Name, fun() -&gt; ok end, TC).
<a name="1073"/> 1073: 
<a name="tc_try-3"/><a name="1074"/> 1074: <b>tc_try</b>(Name, Init, TC)
<a name="1075"/> 1075:   when is_atom(Name) andalso is_function(Init, 0) andalso is_function(TC, 0) -&gt;
<a name="1076"/> 1076:     Pre = fun() -&gt;
<a name="1077"/> 1077:                   {ok, Peer, Node} = ?START_PEER(atom_to_list(Name)),
<a name="1078"/> 1078:                   ok = run_on(Node, Init),
<a name="1079"/> 1079:                   {Peer, Node}
<a name="1080"/> 1080:           end,
<a name="1081"/> 1081:     Case = fun({_Peer, Node}) -&gt;
<a name="1082"/> 1082:                    monitor_node(Node, true),
<a name="1083"/> 1083:                    Pid = spawn_link(Node, TC),
<a name="1084"/> 1084:                    receive
<a name="1085"/> 1085:                        %% No test case could/would provoke a nodedown =&gt; SKIP
<a name="1086"/> 1086:                        {nodedown, Node} = N -&gt;
<a name="1087"/> 1087:                            ?NPRINT(&quot;unexpected node down ~p&quot;, [Node]),
<a name="1088"/> 1088:                            exit({skip, N});
<a name="1089"/> 1089:                        {'EXIT', Pid, normal} -&gt;
<a name="1090"/> 1090:                            monitor_node(Node, false),                           
<a name="1091"/> 1091:                            ok;
<a name="1092"/> 1092:                        {'EXIT', Pid, ok} -&gt;
<a name="1093"/> 1093:                            monitor_node(Node, false),                           
<a name="1094"/> 1094:                            ok;
<a name="1095"/> 1095:                        %% This is a node down.
<a name="1096"/> 1096:                        %% Its just a race that this came before the actual
<a name="1097"/> 1097:                        %% 'nodedown'.
<a name="1098"/> 1098:                        %% Also, there is no normal test case that could provoke
<a name="1099"/> 1099:                        %% a node down, so this is *not* our fault =&gt; SKIP
<a name="1100"/> 1100:                        {'EXIT', Pid, noconnection = Reason} -&gt;
<a name="1101"/> 1101:                            ?NPRINT(&quot;unexpected '~p' termination&quot;, [Reason]),
<a name="1102"/> 1102:                            monitor_node(Node, false), % Just in case
<a name="1103"/> 1103:                            exit({skip, Reason});
<a name="1104"/> 1104:                        {'EXIT', Pid, Reason} -&gt;
<a name="1105"/> 1105:                            monitor_node(Node, false),
<a name="1106"/> 1106:                            exit(Reason)
<a name="1107"/> 1107:                    end
<a name="1108"/> 1108:            end,
<a name="1109"/> 1109:     Post = fun({Peer, Node}) -&gt;
<a name="1110"/> 1110:                    receive
<a name="1111"/> 1111:                        {nodedown, Node} -&gt;
<a name="1112"/> 1112:                            ?NPRINT(&quot;node ~p (already) stopped&quot;, [Node]),
<a name="1113"/> 1113:                            ok
<a name="1114"/> 1114:                    after 0 -&gt;
<a name="1115"/> 1115:                            monitor_node(Node, true),
<a name="1116"/> 1116:                            ?NPRINT(&quot;try stop node ~p&quot;, [Node]),
<a name="1117"/> 1117:                            peer:stop(Peer),
<a name="1118"/> 1118:                            receive
<a name="1119"/> 1119:                                {nodedown, Node} -&gt;
<a name="1120"/> 1120:                                    ?NPRINT(&quot;node ~p stopped&quot;, [Node]),
<a name="1121"/> 1121:                                    ok
<a name="1122"/> 1122:                            end
<a name="1123"/> 1123:                    end
<a name="1124"/> 1124:            end,
<a name="tc_try-last_expr"/><a name="1125"/> 1125: <b>    ?TC_TRY</b>(Name, Pre, Case, Post).
<a name="1126"/> 1126:     
<a name="run_on-2"/><a name="1127"/> 1127: <b>run_on</b>(Node, F) when is_atom(Node) andalso is_function(F, 0) -&gt;
<a name="1128"/> 1128:     monitor_node(Node, true),
<a name="1129"/> 1129:     Pid = spawn_link(Node, F),
<a name="run_on-last_expr"/><a name="1130"/> 1130:     receive
<a name="1131"/> 1131:         {nodedown, Node} = N -&gt;
<a name="1132"/> 1132:             exit(N);
<a name="1133"/> 1133:         {'EXIT', Pid, normal} -&gt;
<a name="1134"/> 1134:             monitor_node(Node, false),                           
<a name="1135"/> 1135:             ok;
<a name="1136"/> 1136:         {'EXIT', Pid, Reason} -&gt;
<a name="1137"/> 1137:             monitor_node(Node, false),                           
<a name="1138"/> 1138:             Reason
<a name="1139"/> 1139:     end.
<a name="1140"/> 1140: 
<a name="1141"/> 1141: 
<a name="1142"/> 1142: <i>%% -- </i>
<a name="1143"/> 1143: 
<a name="display_memory_usage-1"/><a name="1144"/> 1144: <b>display_memory_usage</b>(MibsPid) -&gt;
<a name="1145"/> 1145:     SymInfo     = sym_info(),
<a name="1146"/> 1146:     SymProcSize = key1search(process_memory, SymInfo),
<a name="1147"/> 1147:     DbSize      = key1search(db_memory,      SymInfo),
<a name="1148"/> 1148:     MibsInfo    = mibs_info(MibsPid),
<a name="1149"/> 1149:     TreeSize    = key1search(tree_size_bytes,  MibsInfo),
<a name="1150"/> 1150:     MibsProcMem = key1search(process_memory,   MibsInfo),
<a name="1151"/> 1151:     MibDbSize   = key1search([db_memory,mib],  MibsInfo),
<a name="1152"/> 1152:     NodeDbSize  = key1search([db_memory,node], MibsInfo),
<a name="1153"/> 1153:     TreeDbSize  = key1search([db_memory,tree], MibsInfo),
<a name="display_memory_usage-last_expr"/><a name="1154"/> 1154: <b>    ?IPRINT</b>(&quot;Symbolic store memory usage: &quot;
<a name="1155"/> 1155:             &quot;~n   Process memory size: ~p&quot;
<a name="1156"/> 1156:             &quot;~n   Db size:             ~p&quot;
<a name="1157"/> 1157:             &quot;~n&quot;
<a name="1158"/> 1158:             &quot;~nMib server memory usage: &quot;
<a name="1159"/> 1159:             &quot;~n   Tree size:           ~p&quot;
<a name="1160"/> 1160:             &quot;~n   Process memory size: ~p&quot;
<a name="1161"/> 1161:             &quot;~n   Mib db size:         ~p&quot;
<a name="1162"/> 1162:             &quot;~n   Node db size:        ~p&quot;
<a name="1163"/> 1163:             &quot;~n   Tree db size:        ~p&quot;
<a name="1164"/> 1164:             &quot;~n&quot;, 
<a name="1165"/> 1165:             [SymProcSize, DbSize,
<a name="1166"/> 1166:              TreeSize, MibsProcMem, MibDbSize, NodeDbSize, TreeDbSize]).
<a name="1167"/> 1167:     
<a name="key1search-2"/><a name="1168"/> 1168: <b>key1search</b>([], Res) -&gt;
<a name="1169"/> 1169:     Res;
<a name="1170"/> 1170: <b>key1search</b>([Key|Keys], List) when is_atom(Key) andalso is_list(List) -&gt;
<a name="1171"/> 1171:     case lists:keysearch(Key, 1, List) of
<a name="1172"/> 1172: 	{value, {Key, Val}} -&gt;
<a name="1173"/> 1173: 	    key1search(Keys, Val);
<a name="1174"/> 1174: 	false -&gt;
<a name="1175"/> 1175: 	    undefined
<a name="1176"/> 1176:     end;
<a name="1177"/> 1177: <b>key1search</b>(Key, List) when is_atom(Key) -&gt;
<a name="key1search-last_expr"/><a name="1178"/> 1178: <b>    case lists:keysearch</b>(Key, 1, List) of
<a name="1179"/> 1179: 	{value, {Key, Val}} -&gt;
<a name="1180"/> 1180: 	    Val;
<a name="1181"/> 1181: 	false -&gt;
<a name="1182"/> 1182: 	    undefined
<a name="1183"/> 1183:     end.
<a name="1184"/> 1184: 
<a name="join-2"/><a name="1185"/> 1185: <b>join</b>(Dir, File) -&gt;
<a name="join-last_expr"/><a name="1186"/> 1186: <b>    filename:join</b>(Dir, File).
</pre>
<script>
var hash = window.location.hash.substring(1);
var anchor = document.getElementsByName(hash);
anchor[0].style.backgroundColor="orange";
</script>
</body>
</html>
