<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<!-- autogenerated by 'erl2html2'. -->
<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8"/></meta>
<title>/buildroot/otp/lib/stdlib/make_test_dir/stdlib_test/shell_SUITE.erl</title>
</head>

<body bgcolor="white" text="black" link="blue" vlink="purple" alink="red">
<pre>
<a name="1"/>    1: <i>%%</i>
<a name="2"/>    2: <i>%% %CopyrightBegin%</i>
<a name="3"/>    3: <i>%%</i>
<a name="4"/>    4: <i>%% Copyright Ericsson AB 2004-2022. All Rights Reserved.</i>
<a name="5"/>    5: <i>%%</i>
<a name="6"/>    6: <i>%% Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</i>
<a name="7"/>    7: <i>%% you may not use this file except in compliance with the License.</i>
<a name="8"/>    8: <i>%% You may obtain a copy of the License at</i>
<a name="9"/>    9: <i>%%</i>
<a name="10"/>   10: <i>%%     http://www.apache.org/licenses/LICENSE-2.0</i>
<a name="11"/>   11: <i>%%</i>
<a name="12"/>   12: <i>%% Unless required by applicable law or agreed to in writing, software</i>
<a name="13"/>   13: <i>%% distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</i>
<a name="14"/>   14: <i>%% WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</i>
<a name="15"/>   15: <i>%% See the License for the specific language governing permissions and</i>
<a name="16"/>   16: <i>%% limitations under the License.</i>
<a name="17"/>   17: <i>%%</i>
<a name="18"/>   18: <i>%% %CopyrightEnd%</i>
<a name="19"/>   19: <i>%%</i>
<a name="20"/>   20: <b>-module</b>(shell_SUITE).
<a name="21"/>   21: <b>-export</b>([all/0, suite/0,groups/0,init_per_suite/1, end_per_suite/1,
<a name="22"/>   22: 	 init_per_group/2,end_per_group/2]).
<a name="23"/>   23: <b>-export</b>([forget/1, records/1, known_bugs/1, otp_5226/1, otp_5327/1,
<a name="24"/>   24: 	 otp_5435/1, otp_5195/1, otp_5915/1, otp_5916/1,
<a name="25"/>   25: 	 bs_match_misc_SUITE/1, bs_match_int_SUITE/1,
<a name="26"/>   26: 	 bs_match_tail_SUITE/1, bs_match_bin_SUITE/1,
<a name="27"/>   27: 	 bs_construct_SUITE/1,
<a name="28"/>   28:      prompt_width/1,
<a name="29"/>   29: 	 refman_bit_syntax/1,
<a name="30"/>   30: 	 progex_bit_syntax/1, progex_records/1,
<a name="31"/>   31: 	 progex_lc/1, progex_funs/1,
<a name="32"/>   32: 	 otp_5990/1, otp_6166/1, otp_6554/1,
<a name="33"/>   33: 	 otp_7184/1, otp_7232/1, otp_8393/1, otp_10302/1, otp_13719/1,
<a name="34"/>   34:          otp_14285/1, otp_14296/1, typed_records/1, types/1]).
<a name="35"/>   35: 
<a name="36"/>   36: <b>-export</b>([ start_restricted_from_shell/1,
<a name="37"/>   37: 	  start_restricted_on_command_line/1,restricted_local/1]).
<a name="38"/>   38: 
<a name="39"/>   39: <b>-export</b>([ start_interactive/1, whereis/1 ]).
<a name="40"/>   40: 
<a name="41"/>   41: <i>%% Internal export.</i>
<a name="42"/>   42: <b>-export</b>([otp_5435_2/0, prompt1/1, prompt2/1, prompt3/1, prompt4/1,
<a name="43"/>   43: 	 prompt5/1]).
<a name="44"/>   44: 
<a name="45"/>   45: <i>%%</i>
<a name="46"/>   46: <i>%% Define to run outside of test server</i>
<a name="47"/>   47: <i>%%</i>
<a name="48"/>   48: <i>%% -define(STANDALONE,1).</i>
<a name="49"/>   49: 
<a name="50"/>   50: <b>-ifdef</b>(STANDALONE).
<a name="51"/>   51: <b>-define</b>(config(A,B),config(A,B)).
<a name="52"/>   52: <b>-export</b>([config/2]).
<a name="53"/>   53: <b>-define</b>(line, noop, ).
<a name="54"/>   54: config(priv_dir,_) -&gt;
<a name="55"/>   55:     &quot;.&quot;.
<a name="56"/>   56: -else.
<a name="57"/>   57: <b>-include_lib</b>(&quot;common_test/include/ct.hrl&quot;).
<a name="58"/>   58: <b>-export</b>([init_per_testcase/2, end_per_testcase/2]).
<a name="init_per_testcase-2"/><a name="59"/>   59: <b>init_per_testcase</b>(_Case, Config) -&gt;
<a name="60"/>   60:     OrigPath = code:get_path(),
<a name="61"/>   61:     code:add_patha(proplists:get_value(priv_dir,Config)),
<a name="init_per_testcase-last_expr"/><a name="62"/>   62:     [{orig_path,OrigPath} | Config].
<a name="63"/>   63: 
<a name="end_per_testcase-2"/><a name="64"/>   64: <b>end_per_testcase</b>(_Case, Config) -&gt;
<a name="65"/>   65:     OrigPath = proplists:get_value(orig_path,Config),
<a name="66"/>   66:     code:set_path(OrigPath),
<a name="67"/>   67:     application:unset_env(stdlib, restricted_shell),
<a name="68"/>   68:     purge_and_delete(user_default),
<a name="69"/>   69:     %% used by `records' test case
<a name="70"/>   70:     purge_and_delete(test),
<a name="end_per_testcase-last_expr"/><a name="71"/>   71:     ok.
<a name="72"/>   72: -endif.
<a name="73"/>   73: 
<a name="suite-0"/><a name="74"/>   74: <b>suite</b>() -&gt;
<a name="suite-last_expr"/><a name="75"/>   75:     [{ct_hooks,[ts_install_cth]},
<a name="76"/>   76:      {timetrap,{minutes,10}}].
<a name="77"/>   77: 
<a name="all-0"/><a name="78"/>   78: <b>all</b>() -&gt;
<a name="all-last_expr"/><a name="79"/>   79:     [forget, known_bugs, otp_5226, otp_5327,
<a name="80"/>   80:      otp_5435, otp_5195, otp_5915, otp_5916,
<a name="81"/>   81:      prompt_width,
<a name="82"/>   82:      start_interactive, whereis, {group, bits},
<a name="83"/>   83:      {group, refman}, {group, progex}, {group, tickets},
<a name="84"/>   84:      {group, restricted}, {group, records}, {group, definitions}].
<a name="85"/>   85: 
<a name="groups-0"/><a name="86"/>   86: <b>groups</b>() -&gt;
<a name="groups-last_expr"/><a name="87"/>   87:     [{restricted, [],
<a name="88"/>   88:       [start_restricted_from_shell,
<a name="89"/>   89:        start_restricted_on_command_line, restricted_local]},
<a name="90"/>   90:      {bits, [],
<a name="91"/>   91:       [bs_match_misc_SUITE, bs_match_tail_SUITE,
<a name="92"/>   92:        bs_match_bin_SUITE, bs_construct_SUITE]},
<a name="93"/>   93:      {definitions, [], [types]},
<a name="94"/>   94:      {records, [],
<a name="95"/>   95:       [records, typed_records]},
<a name="96"/>   96:      {refman, [], [refman_bit_syntax]},
<a name="97"/>   97:      {progex, [],
<a name="98"/>   98:       [progex_bit_syntax, progex_records, progex_lc,
<a name="99"/>   99:        progex_funs]},
<a name="100"/>  100:      {tickets, [],
<a name="101"/>  101:       [otp_5990, otp_6166, otp_6554, otp_7184,
<a name="102"/>  102:        otp_7232, otp_8393, otp_10302, otp_13719, otp_14285, otp_14296]}].
<a name="103"/>  103: 
<a name="init_per_suite-1"/><a name="104"/>  104: <b>init_per_suite</b>(Config) -&gt;
<a name="init_per_suite-last_expr"/><a name="105"/>  105:     Config.
<a name="106"/>  106: 
<a name="end_per_suite-1"/><a name="107"/>  107: <b>end_per_suite</b>(_Config) -&gt;
<a name="end_per_suite-last_expr"/><a name="108"/>  108:     ok.
<a name="109"/>  109: 
<a name="init_per_group-2"/><a name="110"/>  110: <b>init_per_group</b>(_GroupName, Config) -&gt;
<a name="init_per_group-last_expr"/><a name="111"/>  111:     Config.
<a name="112"/>  112: 
<a name="end_per_group-2"/><a name="113"/>  113: <b>end_per_group</b>(_GroupName, Config) -&gt;
<a name="end_per_group-last_expr"/><a name="114"/>  114:     Config.
<a name="115"/>  115: 
<a name="116"/>  116: 
<a name="117"/>  117: <b>-record</b>(state, {bin, reply, leader, unic = latin1}).
<a name="118"/>  118: 
<a name="119"/>  119: 
<a name="120"/>  120: <i>%% Test that a restricted shell can be started from the normal shell.</i>
<a name="start_restricted_from_shell-1"/><a name="121"/>  121: <b>start_restricted_from_shell</b>(Config) when is_list(Config) -&gt;
<a name="122"/>  122:     [{error,nofile}] = scan(&lt;&lt;&quot;begin shell:start_restricted(&quot;
<a name="123"/>  123: 			      &quot;nonexisting_module) end.&quot;&gt;&gt;),
<a name="124"/>  124:     Test = filename:join(proplists:get_value(priv_dir, Config),
<a name="125"/>  125: 			 &quot;test_restricted.erl&quot;),
<a name="126"/>  126:     Contents = &lt;&lt;&quot;-module(test_restricted).
<a name="127"/>  127:                   -export([local_allowed/3, non_local_allowed/3]).
<a name="128"/>  128: local_allowed(m,[],State) -&gt;
<a name="129"/>  129:     {true,State};
<a name="130"/>  130: local_allowed(ugly,[],_State) -&gt;
<a name="131"/>  131:     non_conforming_reply;
<a name="132"/>  132: local_allowed(_,_,State) -&gt;
<a name="133"/>  133:     {false,State}.
<a name="134"/>  134: 
<a name="135"/>  135: non_local_allowed({shell,stop_restricted},[],State) -&gt;
<a name="136"/>  136:     {true,State};
<a name="137"/>  137: non_local_allowed({erlang,'+'},[_],State) -&gt;
<a name="138"/>  138:     {true,State};
<a name="139"/>  139: non_local_allowed({erlang,'-'},[_,_],_State) -&gt;
<a name="140"/>  140:     non_conforming_reply;
<a name="141"/>  141: non_local_allowed({h, d}, [Arg], S) -&gt;
<a name="142"/>  142:     {{redirect, {erlang,hd}, [Arg]}, S};
<a name="143"/>  143: non_local_allowed(_,_,State) -&gt;
<a name="144"/>  144:     {false,State}.
<a name="145"/>  145: &quot;&gt;&gt;,
<a name="146"/>  146:     ok = compile_file(Config, Test, Contents, []),
<a name="147"/>  147: &quot;exception exit: restricted shell starts now&quot; =
<a name="148"/>  148: comm_err(&lt;&lt;&quot;begin shell:start_restricted(&quot;
<a name="149"/>  149: 	   &quot;test_restricted) end.&quot;&gt;&gt;),
<a name="150"/>  150: {ok, test_restricted} =
<a name="151"/>  151: application:get_env(stdlib, restricted_shell),
<a name="152"/>  152: &quot;Module&quot; ++ _ = t({&lt;&lt;&quot;begin m() end.&quot;&gt;&gt;, utf8}),
<a name="153"/>  153: &quot;exception exit: restricted shell does not allow c(foo)&quot; =
<a name="154"/>  154: comm_err(&lt;&lt;&quot;begin c(foo) end.&quot;&gt;&gt;),
<a name="155"/>  155: &quot;exception exit: restricted shell does not allow init:stop()&quot; =
<a name="156"/>  156: comm_err(&lt;&lt;&quot;begin init:stop() end.&quot;&gt;&gt;),
<a name="157"/>  157: &quot;exception exit: restricted shell does not allow init:stop()&quot; =
<a name="158"/>  158: comm_err(&lt;&lt;&quot;begin F = fun() -&gt; init:stop() end, F() end.&quot;&gt;&gt;),
<a name="159"/>  159: &quot;exception error: an error occurred when evaluating an arithmetic expression&quot; =
<a name="160"/>  160: comm_err(&lt;&lt;&quot;begin +a end.&quot;&gt;&gt;),
<a name="161"/>  161: &quot;exception exit: restricted shell does not allow a + b&quot; =
<a name="162"/>  162: comm_err(&lt;&lt;&quot;begin a+b end.&quot;&gt;&gt;),
<a name="163"/>  163: &quot;exception exit: restricted shell does not allow - b&quot; =
<a name="164"/>  164: comm_err(&lt;&lt;&quot;begin -b end.&quot;&gt;&gt;),
<a name="165"/>  165: &quot;exception exit: restricted shell does not allow 1 + 2&quot; =
<a name="166"/>  166: comm_err(&lt;&lt;&quot;begin if atom(1 + 2&gt; 0) -&gt; 1; true -&gt; 2 end end.&quot;&gt;&gt;),
<a name="167"/>  167: &quot;exception exit: restricted shell does not allow 1 + 2&quot; =
<a name="168"/>  168: comm_err(&lt;&lt;&quot;begin if is_atom(1 + 2&gt; 0) -&gt; 1; true -&gt; 2 end end.&quot;&gt;&gt;),
<a name="169"/>  169: &quot;exception exit: restricted shell does not allow - 2&quot; =
<a name="170"/>  170: comm_err(&lt;&lt;&quot;begin if - 2 -&gt; 1; true -&gt; 2 end end.&quot;&gt;&gt;),
<a name="171"/>  171: &quot;exception exit: restricted shell does not allow - 2&quot; =
<a name="172"/>  172: comm_err(&lt;&lt;&quot;begin if (- 2 &gt; 0)  andalso true -&gt; 1; true -&gt; 2 end end.&quot;&gt;&gt;),
<a name="173"/>  173: &quot;exception exit: restricted shell does not allow - 2&quot; =
<a name="174"/>  174: comm_err(&lt;&lt;&quot;begin if (- 2 &gt; 0)  orelse true -&gt; 1; true -&gt; 2 end end.&quot;&gt;&gt;),
<a name="175"/>  175: &quot;exception exit: restricted shell does not allow 1 + 2&quot; =
<a name="176"/>  176: comm_err(&lt;&lt;&quot;begin if 1 + 2 &gt; 0 -&gt; 1; true -&gt; 2 end end.&quot;&gt;&gt;),
<a name="177"/>  177: &quot;exception exit: restricted shell does not allow 1 + 2&quot; =
<a name="178"/>  178: comm_err(&lt;&lt;&quot;begin if erlang:is_atom(1 + 2&gt; 0) -&gt; 1; true -&gt; 2 end end.&quot;&gt;&gt;),
<a name="179"/>  179: &quot;exception exit: restricted shell does not allow is_integer(1)&quot; =
<a name="180"/>  180: comm_err(&lt;&lt;&quot;begin if is_integer(1) -&gt; 1; true -&gt; 2 end end.&quot;&gt;&gt;),
<a name="181"/>  181: &quot;exception exit: restricted shell does not allow is_integer(1)&quot; =
<a name="182"/>  182: comm_err(&lt;&lt;&quot;begin if integer(1) -&gt; 1; true -&gt; 2 end end.&quot;&gt;&gt;),
<a name="183"/>  183: &quot;exception exit: &quot;
<a name="184"/>  184: &quot;restricted shell module returned bad value non_conforming_reply&quot; =
<a name="185"/>  185: comm_err(&lt;&lt;&quot;ugly().&quot;&gt;&gt;),
<a name="186"/>  186: [one] = scan(&lt;&lt;&quot;h:d([one,two]).&quot;&gt;&gt;),
<a name="187"/>  187: &quot;exception exit: &quot;
<a name="188"/>  188: &quot;restricted shell module returned bad value non_conforming_reply&quot; =
<a name="189"/>  189: comm_err(&lt;&lt;&quot;1 - 2.&quot;&gt;&gt;),
<a name="190"/>  190: <i>%% Make sure we test all local shell functions in a restricted shell.</i>
<a name="191"/>  191: LocalFuncs = shell:local_func(),
<a name="192"/>  192: [] = lists:subtract(LocalFuncs, [v,h,b,f,fl,rd,rf,rl,rp,rr,history,results,catch_exception]),
<a name="193"/>  193: 
<a name="194"/>  194: LocalFuncs2 = [
<a name="195"/>  195:     &lt;&lt;&quot;A = 1.\nv(1).&quot;&gt;&gt;, &lt;&lt;&quot;h().&quot;&gt;&gt;, &lt;&lt;&quot;b().&quot;&gt;&gt;, &lt;&lt;&quot;f().&quot;&gt;&gt;, &lt;&lt;&quot;f(A).&quot;&gt;&gt;,
<a name="196"/>  196:     &lt;&lt;&quot;fl()&quot;&gt;&gt;, &lt;&lt;&quot;rd(foo,{bar}).&quot;&gt;&gt;, &lt;&lt;&quot;rf().&quot;&gt;&gt;, &lt;&lt;&quot;rf(foo).&quot;&gt;&gt;, &lt;&lt;&quot;rl().&quot;&gt;&gt;, &lt;&lt;&quot;rl(foo).&quot;&gt;&gt;, &lt;&lt;&quot;rp([hej]).&quot;&gt;&gt;,
<a name="197"/>  197:     &lt;&lt;&quot;rr(shell).&quot;&gt;&gt;, &lt;&lt;&quot;rr(shell, shell_state).&quot;&gt;&gt;, &lt;&lt;&quot;rr(shell,shell_state,[]).&quot;&gt;&gt;,
<a name="198"/>  198:     &lt;&lt;&quot;history(20).&quot;&gt;&gt;, &lt;&lt;&quot;results(20).&quot;&gt;&gt;, &lt;&lt;&quot;catch_exception(0).&quot;&gt;&gt;],
<a name="199"/>  199: lists:foreach(fun(LocalFunc) -&gt;
<a name="200"/>  200:         try
<a name="201"/>  201:             (&quot;exception exit: restricted shell does not allow&quot;++_Rest) = Error = local_func_error_t(LocalFunc),
<a name="202"/>  202:             error(Error)
<a name="203"/>  203:         catch
<a name="204"/>  204:             error:{badmatch, _} -&gt; ok
<a name="205"/>  205:         end
<a name="206"/>  206:     end,
<a name="207"/>  207:     LocalFuncs2),
<a name="208"/>  208: &quot;exception exit: restricted shell stopped&quot;=
<a name="209"/>  209: comm_err(&lt;&lt;&quot;begin shell:stop_restricted() end.&quot;&gt;&gt;),
<a name="210"/>  210: undefined =
<a name="211"/>  211: application:get_env(stdlib, restricted_shell),
<a name="start_restricted_from_shell-last_expr"/><a name="212"/>  212: ok.
<a name="213"/>  213: 
<a name="local_func_error_t-1"/><a name="214"/>  214: <b>local_func_error_t</b>(B) -&gt;
<a name="215"/>  215:     Reply = t(B),
<a name="216"/>  216:     S0 = lists:flatten(string:replace(Reply, &quot;1\n&quot;, &quot;&quot;)), %% v(1) requires special treatment
<a name="217"/>  217:     S1 = string:left(S0, string:chr(S0, $\n)-1),
<a name="218"/>  218:     S2 = string:strip(S1, left, $*),
<a name="219"/>  219:     S3 = string:strip(S2, both, $ ),
<a name="220"/>  220:     S = string:strip(S3, both, $&quot;),
<a name="local_func_error_t-last_expr"/><a name="221"/>  221: <b>    string:strip</b>(S, right, $.).
<a name="222"/>  222: 
<a name="223"/>  223: <i>%% Check restricted shell when started from the command line.</i>
<a name="start_restricted_on_command_line-1"/><a name="224"/>  224: <b>start_restricted_on_command_line</b>(Config) when is_list(Config) -&gt;
<a name="225"/>  225:     {ok, Peer, Node} = ?CT_PEER([&quot;-pa&quot;, proplists:get_value(priv_dir,Config),
<a name="226"/>  226: 			         &quot;-stdlib&quot;, &quot;restricted_shell&quot;, &quot;foo&quot;]),
<a name="227"/>  227:     &quot;Warning! Restricted shell module foo not found: nofile&quot;++_ =
<a name="228"/>  228: 	t({Node, &lt;&lt;&quot;begin m() end.&quot;&gt;&gt;}),
<a name="229"/>  229:     &quot;exception exit: restricted shell does not allow m()&quot; =
<a name="230"/>  230: 	comm_err({Node, &lt;&lt;&quot;begin m() end.&quot;&gt;&gt;}),
<a name="231"/>  231:     [ok] =
<a name="232"/>  232: 	(catch scan({Node, &lt;&lt;&quot;begin q() end.&quot;&gt;&gt;})),
<a name="233"/>  233:     peer:stop(Peer),
<a name="234"/>  234:     Test = filename:join(proplists:get_value(priv_dir, Config),
<a name="235"/>  235: 			       &quot;test_restricted2.erl&quot;),
<a name="236"/>  236:     Contents = &lt;&lt;&quot;-module(test_restricted2).
<a name="237"/>  237:                   -export([local_allowed/3, non_local_allowed/3]).
<a name="238"/>  238:                   local_allowed(m,[],State) -&gt;
<a name="239"/>  239:                       {true,State};
<a name="240"/>  240:                   local_allowed(_,_,State) -&gt;
<a name="241"/>  241:                       {false,State}.
<a name="242"/>  242: 
<a name="243"/>  243:                   non_local_allowed({shell,stop_restricted},[],State) -&gt;
<a name="244"/>  244:                       {true,State};
<a name="245"/>  245:                   non_local_allowed({erlang,node},[],State) -&gt;
<a name="246"/>  246:                       {true,State};
<a name="247"/>  247:                   non_local_allowed(_,_,State) -&gt;
<a name="248"/>  248:                       {false,State}.
<a name="249"/>  249:                  &quot;&gt;&gt;,
<a name="250"/>  250:     ok = compile_file(Config, Test, Contents, []),
<a name="251"/>  251:     {ok, Peer2, Node2} = ?CT_PEER([&quot;-pa&quot;, proplists:get_value(priv_dir,Config),
<a name="252"/>  252: 				  &quot;-stdlib&quot;, &quot;restricted_shell&quot;, &quot;test_restricted2&quot;]),
<a name="253"/>  253:     &quot;Module&quot; ++ _ = t({Node2,&lt;&lt;&quot;begin m() end.&quot;&gt;&gt;, utf8}),
<a name="254"/>  254:     &quot;exception exit: restricted shell does not allow c(foo)&quot; =
<a name="255"/>  255: 	comm_err({Node2,&lt;&lt;&quot;begin c(foo) end.&quot;&gt;&gt;}),
<a name="256"/>  256:     &quot;exception exit: restricted shell does not allow init:stop()&quot; =
<a name="257"/>  257: 	comm_err({Node2,&lt;&lt;&quot;begin init:stop() end.&quot;&gt;&gt;}),
<a name="258"/>  258:     &quot;exception exit: restricted shell does not allow init:stop()&quot; =
<a name="259"/>  259: 	comm_err({Node2,&lt;&lt;&quot;begin F = fun() -&gt; init:stop() end, F() end.&quot;&gt;&gt;}),
<a name="260"/>  260:     [Node2] =
<a name="261"/>  261: 	scan({Node2, &lt;&lt;&quot;begin erlang:node() end.&quot;&gt;&gt;}),
<a name="262"/>  262:     [Node2] =
<a name="263"/>  263: 	scan({Node2, &lt;&lt;&quot;begin node() end.&quot;&gt;&gt;}),
<a name="264"/>  264:     &quot;exception exit: restricted shell stopped&quot;=
<a name="265"/>  265: 	comm_err({Node2,&lt;&lt;&quot;begin shell:stop_restricted() end.&quot;&gt;&gt;}),
<a name="266"/>  266:     [ok] =
<a name="267"/>  267: 	scan({Node2, &lt;&lt;&quot;begin q() end.&quot;&gt;&gt;}),
<a name="268"/>  268:     peer:stop(Peer2),
<a name="start_restricted_on_command_line-last_expr"/><a name="269"/>  269:     ok.
<a name="270"/>  270: 
<a name="271"/>  271: <i>%% Tests calling local shell functions with spectacular arguments in</i>
<a name="272"/>  272: <i>%% restricted shell.</i>
<a name="restricted_local-1"/><a name="273"/>  273: <b>restricted_local</b>(Config) when is_list(Config) -&gt;
<a name="274"/>  274:     [{error,nofile}] = scan(&lt;&lt;&quot;begin shell:start_restricted(&quot;
<a name="275"/>  275: 				    &quot;nonexisting_module) end.&quot;&gt;&gt;),
<a name="276"/>  276:     Test = filename:join(proplists:get_value(priv_dir, Config),
<a name="277"/>  277: 			       &quot;test_restricted_local.erl&quot;),
<a name="278"/>  278:     Contents = &lt;&lt;&quot;-module(test_restricted_local).
<a name="279"/>  279:                   -export([local_allowed/3, non_local_allowed/3]).
<a name="280"/>  280:                   local_allowed(m,[],State) -&gt;
<a name="281"/>  281:                       {true,State};
<a name="282"/>  282:                   local_allowed(banan,_,State) -&gt;
<a name="283"/>  283:                       {true,State};
<a name="284"/>  284:                   local_allowed(funkis,_,State) -&gt;
<a name="285"/>  285:                       {true,State};
<a name="286"/>  286:                   local_allowed(c,_,State) -&gt;
<a name="287"/>  287:                       {true,State};
<a name="288"/>  288:                   local_allowed(_,_,State) -&gt;
<a name="289"/>  289:                       {false,State}.
<a name="290"/>  290: 
<a name="291"/>  291:                   non_local_allowed({erlang,raise},[error, _, _],State) -&gt;
<a name="292"/>  292:                       {true,State};
<a name="293"/>  293:                   non_local_allowed({shell,stop_restricted},[],State) -&gt;
<a name="294"/>  294:                       {true,State};
<a name="295"/>  295:                   non_local_allowed(_,_,State) -&gt;
<a name="296"/>  296:                       {false,State}.
<a name="297"/>  297:                  &quot;&gt;&gt;,
<a name="298"/>  298:     ok = compile_file(Config, Test, Contents, []),
<a name="299"/>  299:     Test2 = filename:join(proplists:get_value(priv_dir, Config),
<a name="300"/>  300: 			       &quot;user_default.erl&quot;),
<a name="301"/>  301:     Contents2 = &lt;&lt;&quot;-module(user_default).
<a name="302"/>  302:                   -export([funkis/1,apple/1]).
<a name="303"/>  303:                   funkis(F) when is_function(F) -&gt;
<a name="304"/>  304:                       funkis;
<a name="305"/>  305:                   funkis(_) -&gt;
<a name="306"/>  306:                       nofunkis.
<a name="307"/>  307:                   apple(_) -&gt;
<a name="308"/>  308:                       apple.
<a name="309"/>  309:                  &quot;&gt;&gt;,
<a name="310"/>  310:     ok = compile_file(Config, Test2, Contents2, []),
<a name="311"/>  311:     &quot;exception exit: restricted shell starts now&quot; =
<a name="312"/>  312: 	comm_err(&lt;&lt;&quot;begin shell:start_restricted(&quot;
<a name="313"/>  313: 			 &quot;test_restricted_local) end.&quot;&gt;&gt;),
<a name="314"/>  314:     {ok, test_restricted_local} =
<a name="315"/>  315: 	application:get_env(stdlib, restricted_shell),
<a name="316"/>  316:     &quot;exception exit: restricted shell does not allow foo(&quot; ++ _ =
<a name="317"/>  317: 	comm_err(&lt;&lt;&quot;begin F=fun() -&gt; hello end, foo(F) end.&quot;&gt;&gt;),
<a name="318"/>  318:     &quot;exception error: undefined shell command banan/1&quot; =
<a name="319"/>  319: 	comm_err(&lt;&lt;&quot;begin F=fun() -&gt; hello end, banan(F) end.&quot;&gt;&gt;),
<a name="320"/>  320:     &quot;Recompiling &quot;++_ = t(&lt;&lt;&quot;c(shell_SUITE).&quot;&gt;&gt;),
<a name="321"/>  321:     &quot;exception exit: restricted shell does not allow l(&quot; ++ _ =
<a name="322"/>  322: 	comm_err(&lt;&lt;&quot;begin F=fun() -&gt; hello end, l(F) end.&quot;&gt;&gt;),
<a name="323"/>  323:     &quot;exception error: variable 'F' is unbound&quot; =
<a name="324"/>  324: 	comm_err(&lt;&lt;&quot;begin F=fun() -&gt; hello end, f(F), F end.&quot;&gt;&gt;),
<a name="325"/>  325:     [funkis] =
<a name="326"/>  326: 	scan(&lt;&lt;&quot;begin F=fun() -&gt; hello end, funkis(F) end.&quot;&gt;&gt;),
<a name="327"/>  327:     &quot;exception exit: restricted shell does not allow apple(&quot; ++ _ =
<a name="328"/>  328: 	comm_err(&lt;&lt;&quot;begin F=fun() -&gt; hello end, apple(F) end.&quot;&gt;&gt;),
<a name="329"/>  329:     &quot;exception exit: restricted shell stopped&quot;=
<a name="330"/>  330: 	comm_err(&lt;&lt;&quot;begin shell:stop_restricted() end.&quot;&gt;&gt;),
<a name="331"/>  331:     undefined =
<a name="332"/>  332: 	application:get_env(stdlib, restricted_shell),
<a name="333"/>  333:     true = purge_and_delete(user_default),
<a name="restricted_local-last_expr"/><a name="334"/>  334:     ok.
<a name="335"/>  335: 
<a name="336"/>  336: 
<a name="337"/>  337: <i>%% f/0 and f/1.</i>
<a name="forget-1"/><a name="338"/>  338: <b>forget</b>(Config) when is_list(Config) -&gt;
<a name="339"/>  339:     %% f/0
<a name="340"/>  340:     [ok] = scan(&lt;&lt;&quot;begin f() end.&quot;&gt;&gt;),
<a name="341"/>  341:     &quot;1:13: variable 'A' is unbound&quot; =
<a name="342"/>  342:         comm_err(&lt;&lt;&quot;A = 3, f(), A.&quot;&gt;&gt;),
<a name="343"/>  343:     [ok] = scan(&lt;&lt;&quot;A = 3, A = f(), A.&quot;&gt;&gt;),
<a name="344"/>  344: 
<a name="345"/>  345:     %% f/1
<a name="346"/>  346:     [ok] = scan(&lt;&lt;&quot;begin f(A) end.&quot;&gt;&gt;),
<a name="347"/>  347:     &quot;1:14: variable 'A' is unbound&quot; =
<a name="348"/>  348:         comm_err(&lt;&lt;&quot;A = 3, f(A), A.&quot;&gt;&gt;),
<a name="349"/>  349:     [ok] = scan(&lt;&lt;&quot;A = 3, A = f(A), A.&quot;&gt;&gt;),
<a name="350"/>  350:     &quot;exception error: no function clause matching call to f/1&quot; =
<a name="351"/>  351:         comm_err(&lt;&lt;&quot;f(a).&quot;&gt;&gt;),
<a name="forget-last_expr"/><a name="352"/>  352:     ok.
<a name="353"/>  353: 
<a name="354"/>  354: <i>%% type definition support</i>
<a name="types-1"/><a name="355"/>  355: <b>types</b>(Config) when is_list(Config) -&gt;
<a name="356"/>  356:     %% type
<a name="357"/>  357:     [ok] = scan(&lt;&lt;&quot;-type baz() :: integer().&quot;&gt;&gt;),
<a name="358"/>  358:     %% record
<a name="359"/>  359:     [ok] = scan(&lt;&lt;&quot;-record(foo, {bar :: baz()}).&quot;&gt;&gt;),
<a name="360"/>  360:     %% spec
<a name="361"/>  361:     [ok] = scan(&lt;&lt;&quot;-spec foo(Bar) -&gt; Baz when
<a name="362"/>  362:         Bar :: string(),
<a name="363"/>  363:         Baz :: integer().&quot;&gt;&gt;),
<a name="364"/>  364:     &quot;exception error&quot;++_ = comm_err(&lt;&lt;&quot;-hej.&quot;&gt;&gt;),
<a name="365"/>  365:     shell_attribute_test(Config),
<a name="types-last_expr"/><a name="366"/>  366:     ok.
<a name="shell_attribute_test-1"/><a name="367"/>  367: <b>shell_attribute_test</b>(Config) -&gt;
<a name="368"/>  368:     Path =     filename:join([proplists:get_value(priv_dir, Config),
<a name="369"/>  369:     &quot;shell_history&quot;, &quot;function_def&quot;]),
<a name="370"/>  370:     rtnode:run(
<a name="371"/>  371:       [{putline, &quot;foo(Bar) -&gt; Bar.&quot;},
<a name="372"/>  372:        {expect, &quot;ok&quot;},
<a name="373"/>  373:        {putline, &quot;fl().&quot;},
<a name="374"/>  374:        {expect, &quot;\\Q{function,{shell_default,foo,1}}\\E&quot;},
<a name="375"/>  375:        {putline, &quot;foo(1).&quot;},
<a name="376"/>  376:        {expect, &quot;1&quot;},
<a name="377"/>  377:        {putline, &quot;shell_default:foo(2).&quot;},
<a name="378"/>  378:        {expect, &quot;2&quot;}
<a name="379"/>  379:       ],[],&quot;&quot;, [&quot;-kernel&quot;,&quot;shell_history&quot;,&quot;enabled&quot;,
<a name="380"/>  380:       &quot;-kernel&quot;,&quot;shell_history_path&quot;,&quot;\&quot;&quot; ++ Path ++ &quot;\&quot;&quot;,
<a name="381"/>  381:       &quot;-kernel&quot;,&quot;shell_history_drop&quot;,&quot;[\&quot;init:stop().\&quot;]&quot;]),
<a name="382"/>  382:     receive after 1000 -&gt; ok end,
<a name="383"/>  383:     rtnode:run(
<a name="384"/>  384:         [{putline, &quot;-record(hej, {a = 0 :: integer()}).&quot;},
<a name="385"/>  385:          {expect, &quot;ok&quot;},
<a name="386"/>  386:          {putline, &quot;rl().&quot;},
<a name="387"/>  387:          {expect, &quot;\\Q-record(hej,{a = 0 :: integer()}).\\E&quot;},
<a name="388"/>  388:          {putline, &quot;#hej{a=1}.&quot;},
<a name="389"/>  389:          {expect, &quot;\\Q#hej{a = 1}\\E&quot;}
<a name="390"/>  390:         ],[],&quot;&quot;, [&quot;-kernel&quot;,&quot;shell_history&quot;,&quot;enabled&quot;,
<a name="391"/>  391:         &quot;-kernel&quot;,&quot;shell_history_path&quot;,&quot;\&quot;&quot; ++ Path ++ &quot;\&quot;&quot;,
<a name="392"/>  392:         &quot;-kernel&quot;,&quot;shell_history_drop&quot;,&quot;[\&quot;init:stop().\&quot;]&quot;]),
<a name="393"/>  393:     receive after 1000 -&gt; ok end,
<a name="394"/>  394:     rtnode:run(
<a name="395"/>  395:         [{putline, &quot;-spec foo(Bar) -&gt; Bar when Bar :: integer().&quot;},
<a name="396"/>  396:          {expect, &quot;ok&quot;},
<a name="397"/>  397:          {putline, &quot;fl().&quot;},
<a name="398"/>  398:          {expect, &quot;\\Q{function_type,{shell_default,foo,1}}\\E&quot;}
<a name="399"/>  399:         ],[],&quot;&quot;, [&quot;-kernel&quot;,&quot;shell_history&quot;,&quot;enabled&quot;,
<a name="400"/>  400:         &quot;-kernel&quot;,&quot;shell_history_path&quot;,&quot;\&quot;&quot; ++ Path ++ &quot;\&quot;&quot;,
<a name="401"/>  401:         &quot;-kernel&quot;,&quot;shell_history_drop&quot;,&quot;[\&quot;init:stop().\&quot;]&quot;]),
<a name="402"/>  402:     receive after 1000 -&gt; ok end,
<a name="403"/>  403:     rtnode:run(
<a name="404"/>  404:         [{putline, &quot;-type my_type() :: boolean() | integer().&quot;},
<a name="405"/>  405:          {expect, &quot;ok&quot;},
<a name="406"/>  406:          {putline, &quot;fl().&quot;},
<a name="407"/>  407:          {expect, &quot;\\Q{type,my_type}\\E&quot;}
<a name="408"/>  408:         ],[],&quot;&quot;, [&quot;-kernel&quot;,&quot;shell_history&quot;,&quot;enabled&quot;,
<a name="409"/>  409:         &quot;-kernel&quot;,&quot;shell_history_path&quot;,&quot;\&quot;&quot; ++ Path ++ &quot;\&quot;&quot;,
<a name="410"/>  410:         &quot;-kernel&quot;,&quot;shell_history_drop&quot;,&quot;[\&quot;init:stop().\&quot;]&quot;]),
<a name="shell_attribute_test-last_expr"/><a name="411"/>  411:     ok.
<a name="412"/>  412: 
<a name="prompt_width-1"/><a name="413"/>  413: <b>prompt_width</b>(Config) when is_list(Config) -&gt;
<a name="414"/>  414:     5 = shell:prompt_width(&quot;\e[31molá&gt; &quot;),
<a name="415"/>  415:     5 = shell:prompt_width(&lt;&lt;&quot;\e[31molá&gt; &quot;/utf8&gt;&gt;),
<a name="prompt_width-last_expr"/><a name="416"/>  416:     ok.
<a name="417"/>  417: 
<a name="418"/>  418: <i>%% Test of the record support. OTP-5063.</i>
<a name="records-1"/><a name="419"/>  419: <b>records</b>(Config) when is_list(Config) -&gt;
<a name="420"/>  420:     %% rd/2
<a name="421"/>  421:     [{attribute,_,record,{bar,_}},ok] =
<a name="422"/>  422:         scan(&lt;&lt;&quot;rd(foo,{bar}),
<a name="423"/>  423:                 rd(bar,{foo = (#foo{})#foo.bar}),
<a name="424"/>  424:                 rl(bar).&quot;&gt;&gt;),
<a name="425"/>  425:     &quot;variable 'R' is unbound&quot; = % used to work (before OTP-5878, R11B)
<a name="426"/>  426:         exit_string(&lt;&lt;&quot;rd(foo,{bar}),
<a name="427"/>  427:                        R = #foo{},
<a name="428"/>  428:                        rd(bar,{foo = R#foo.bar}).&quot;&gt;&gt;),
<a name="429"/>  429:     &quot;exception error: no function clause matching call to rd/2&quot; =
<a name="430"/>  430:         comm_err(&lt;&lt;&quot;rd({foo},{bar}).&quot;&gt;&gt;),
<a name="431"/>  431:     &quot;bad record declaration&quot; = exit_string(&lt;&lt;&quot;A = bar, rd(foo,A).&quot;&gt;&gt;),
<a name="432"/>  432:     [foo] = scan(&lt;&lt;&quot;begin rd(foo,{bar}) end.&quot;&gt;&gt;),
<a name="433"/>  433:     &quot;1:22: record foo undefined&quot; =
<a name="434"/>  434:          comm_err(&lt;&lt;&quot;begin rd(foo,{bar}), #foo{} end.&quot;&gt;&gt;),
<a name="435"/>  435:     ['f o o'] = scan(&lt;&lt;&quot;rd('f o o', {bar}).&quot;&gt;&gt;),
<a name="436"/>  436:     [foo] = scan(&lt;&lt;&quot;rd(foo,{bar}), rd(foo,{foo = #foo{}}).&quot;&gt;&gt;),
<a name="437"/>  437: 
<a name="438"/>  438:     %% rf/0,1
<a name="439"/>  439:     [_, {attribute,_,record,{foo,_}},ok] =
<a name="440"/>  440:          scan(&lt;&lt;&quot;rf('_'). rd(foo,{bar}),rl().&quot;&gt;&gt;),
<a name="441"/>  441:     &quot;1:33: record foo undefined&quot; =
<a name="442"/>  442:         comm_err(&lt;&lt;&quot;rd(foo,{bar}), #foo{}, rf(foo), #foo{}.&quot;&gt;&gt;),
<a name="443"/>  443:     [ok,{foo,undefined}] =
<a name="444"/>  444:         scan(&lt;&lt;&quot;rd(foo,{bar}), A = #foo{}, rf(foo). A.&quot;&gt;&gt;),
<a name="445"/>  445:     [_] = scan(&lt;&lt;&quot;begin rf() end.&quot;&gt;&gt;),
<a name="446"/>  446:     [ok] = scan(&lt;&lt;&quot;begin rf(foo) end.&quot;&gt;&gt;),
<a name="447"/>  447: 
<a name="448"/>  448:     %% rp/1
<a name="449"/>  449:     &quot;#foo{bar = undefined}.\nok.\n&quot; =
<a name="450"/>  450:         t(&lt;&lt;&quot;rd(foo,{bar}), rp(#foo{}).&quot;&gt;&gt;),
<a name="451"/>  451:     [{foo,3,4,3},ok] = scan(&lt;&lt;&quot;rd(foo,{a = 3, b}), rp({foo,3,4,3}).&quot;&gt;&gt;),
<a name="452"/>  452:     &quot;#foo{a = 12}.\nok.\n&quot; = t(&lt;&lt;&quot;rd(foo,{a = 3}), rp({foo,12}).&quot;&gt;&gt;),
<a name="453"/>  453:     [{[{foo}],12},ok] = scan(&lt;&lt;&quot;rd(foo,{a = 3}), rp({[{foo}],12}).&quot;&gt;&gt;),
<a name="454"/>  454: 
<a name="455"/>  455:     %% rr/1,2,3
<a name="456"/>  456:     MS = ?MODULE_STRING,
<a name="457"/>  457:     RR1 = &quot;rr(&quot; ++ MS ++ &quot;). #state{}.&quot;,
<a name="458"/>  458:     &quot;[state]\n&quot;
<a name="459"/>  459:           &quot;#state{bin = undefined,reply = undefined,leader = undefined,\n&quot;
<a name="460"/>  460:           &quot;       unic = latin1}.\n&quot; =
<a name="461"/>  461:         t(RR1),
<a name="462"/>  462:     RR2 = &quot;rr(&quot; ++ MS ++ &quot;,[state]). #state{}.&quot;,
<a name="463"/>  463:     &quot;[state]\n&quot;
<a name="464"/>  464:           &quot;#state{bin = undefined,reply = undefined,leader = undefined,\n&quot;
<a name="465"/>  465:           &quot;       unic = latin1}.\n&quot; =
<a name="466"/>  466:         t(RR2),
<a name="467"/>  467:     RR3 = &quot;rr(&quot; ++ MS ++ &quot;,'_'). #state{}.&quot;,
<a name="468"/>  468:     &quot;[state]\n&quot;
<a name="469"/>  469:           &quot;#state{bin = undefined,reply = undefined,leader = undefined,\n&quot;
<a name="470"/>  470:           &quot;       unic = latin1}.\n&quot; =
<a name="471"/>  471:         t(RR3),
<a name="472"/>  472:     RR4 = &quot;rr(&quot; ++ MS ++ &quot;, '_', {d,test1}).&quot;,
<a name="473"/>  473:     [[state]] = scan(RR4),
<a name="474"/>  474: 
<a name="475"/>  475:     Test = filename:join(proplists:get_value(priv_dir, Config), &quot;test.erl&quot;),
<a name="476"/>  476:     BeamDir = filename:join(proplists:get_value(priv_dir, Config), &quot;beam&quot;),
<a name="477"/>  477:     BeamFile = filename:join(BeamDir, &quot;test&quot;),
<a name="478"/>  478:     ok = file:make_dir(BeamDir),
<a name="479"/>  479:     Contents = &lt;&lt;&quot;-module(test).
<a name="480"/>  480:                   -record(state, {bin :: binary(),
<a name="481"/>  481:                                   reply = no,
<a name="482"/>  482:                                   leader = some :: atom()}).
<a name="483"/>  483: 
<a name="484"/>  484:                   -ifdef(test1).
<a name="485"/>  485:                   -record(test1, {f}).
<a name="486"/>  486:                   -endif.
<a name="487"/>  487: 
<a name="488"/>  488:                   -ifdef(test2).
<a name="489"/>  489:                   -record(test2, {g}).
<a name="490"/>  490:                   -endif.
<a name="491"/>  491:                  &quot;&gt;&gt;,
<a name="492"/>  492:     ok = file:write_file(Test, Contents),
<a name="493"/>  493:     {ok, test} = compile:file(Test, [{outdir, BeamDir}]),
<a name="494"/>  494: 
<a name="495"/>  495:     RR5 = &quot;rr(\&quot;&quot; ++ Test ++ &quot;\&quot;, '_', {d,test1}), rl([test1,test2]).&quot;,
<a name="496"/>  496:     A1 = erl_anno:new(1),
<a name="497"/>  497:     [{attribute,A1,record,{test1,_}},ok] = scan(RR5),
<a name="498"/>  498:     RR6 = &quot;rr(\&quot;&quot; ++ Test ++ &quot;\&quot;, '_', {d,test2}), rl([test1,test2]).&quot;,
<a name="499"/>  499:     [{attribute,A1,record,{test2,_}},ok] = scan(RR6),
<a name="500"/>  500:     RR7 = &quot;rr(\&quot;&quot; ++ Test ++
<a name="501"/>  501:            &quot;\&quot;, '_', [{d,test1},{d,test2,17}]), rl([test1,test2]).&quot;,
<a name="502"/>  502:     [{attribute,A1,record,{test1,_}},{attribute,A1,record,{test2,_}},ok] =
<a name="503"/>  503:         scan(RR7),
<a name="504"/>  504:     PreReply = scan(&lt;&lt;&quot;rr(prim_file).&quot;&gt;&gt;), % preloaded...
<a name="505"/>  505:     true = is_list(PreReply),
<a name="506"/>  506:     Dir = filename:join(proplists:get_value(priv_dir, Config), &quot;*.erl&quot;),
<a name="507"/>  507:     RR8 = &quot;rp(rr(\&quot;&quot; ++ Dir ++ &quot;\&quot;)).&quot;,
<a name="508"/>  508:     [_,ok] = scan(RR8),
<a name="509"/>  509: 
<a name="510"/>  510:     {module, test} = code:load_abs(BeamFile),
<a name="511"/>  511:     [[state]] = scan(&lt;&lt;&quot;rr(test).&quot;&gt;&gt;),
<a name="512"/>  512:     file:delete(Test),
<a name="513"/>  513:     file:delete(BeamFile++&quot;.beam&quot;),
<a name="514"/>  514: 
<a name="515"/>  515:     RR1000 = &quot;begin rr(&quot; ++ MS ++ &quot;) end.&quot;,
<a name="516"/>  516:     [_] = scan(RR1000),
<a name="517"/>  517:     RR1001 = &quot;begin rr(&quot; ++ MS ++ &quot;, state) end.&quot;,
<a name="518"/>  518:     [_] = scan(RR1001),
<a name="519"/>  519:     RR1002 = &quot;begin rr(&quot; ++ MS ++ &quot;, state,{i,'.'}) end.&quot;,
<a name="520"/>  520:     [_] = scan(RR1002),
<a name="521"/>  521: 
<a name="522"/>  522:     [{error,nofile}] = scan(&lt;&lt;&quot;rr(not_a_module).&quot;&gt;&gt;),
<a name="523"/>  523:     [{error,invalid_filename}] = scan(&lt;&lt;&quot;rr({foo}).&quot;&gt;&gt;),
<a name="524"/>  524:     [[]] = scan(&lt;&lt;&quot;rr(\&quot;not_a_file\&quot;).&quot;&gt;&gt;),
<a name="525"/>  525: 
<a name="526"/>  526:     %% load record from archive
<a name="527"/>  527:     true = purge_and_delete(test),
<a name="528"/>  528: 
<a name="529"/>  529:     PrivDir = proplists:get_value(priv_dir, Config),
<a name="530"/>  530:     AppDir = filename:join(PrivDir, &quot;test_app&quot;),
<a name="531"/>  531:     ok = file:make_dir(AppDir),
<a name="532"/>  532:     AppEbinDir = filename:join(AppDir, &quot;ebin&quot;),
<a name="533"/>  533:     ok = file:make_dir(AppEbinDir),
<a name="534"/>  534: 
<a name="535"/>  535:     ok = file:write_file(Test, Contents),
<a name="536"/>  536:     {ok, test} = compile:file(Test, [{outdir, AppEbinDir}]),
<a name="537"/>  537: 
<a name="538"/>  538:     Ext = init:archive_extension(),
<a name="539"/>  539:     Archive = filename:join(PrivDir, &quot;test_app&quot; ++ Ext),
<a name="540"/>  540:     {ok, _} = zip:create(Archive, [&quot;test_app&quot;], [{compress, []}, {cwd, PrivDir}]),
<a name="541"/>  541: 
<a name="542"/>  542:     ArchiveEbinDir = filename:join(Archive, &quot;test_app/ebin&quot;),
<a name="543"/>  543:     true = code:add_path(ArchiveEbinDir),
<a name="544"/>  544:     {module, test} = code:load_file(test),
<a name="545"/>  545:     BeamInArchive = filename:join(ArchiveEbinDir, &quot;test.beam&quot;),
<a name="546"/>  546:     BeamInArchive = code:which(test),
<a name="547"/>  547: 
<a name="548"/>  548:     [[state]] = scan(&lt;&lt;&quot;rr(test).&quot;&gt;&gt;),
<a name="549"/>  549: 
<a name="550"/>  550:     %% using records
<a name="551"/>  551:     [2] = scan(&lt;&lt;&quot;rd(foo,{bar}), record_info(size, foo).&quot;&gt;&gt;),
<a name="552"/>  552:     [true] = scan(&lt;&lt;&quot;rd(foo,{bar}), is_record(#foo{}, foo).&quot;&gt;&gt;),
<a name="553"/>  553:     [true] = scan(&lt;&lt;&quot;rd(foo,{bar}), erlang:is_record(#foo{}, foo).&quot;&gt;&gt;),
<a name="554"/>  554:     [true] = scan(&lt;&lt;&quot;rd(foo,{bar}),
<a name="555"/>  555:                      fun() when record(#foo{},foo) -&gt; true end().&quot;&gt;&gt;),
<a name="556"/>  556:     [2] = scan(&lt;&lt;&quot;rd(foo,{bar}), #foo.bar.&quot;&gt;&gt;),
<a name="557"/>  557:     &quot;#foo{bar = 17}.\n&quot; =
<a name="558"/>  558:         t(&lt;&lt;&quot;rd(foo,{bar}), A = #foo{}, A#foo{bar = 17}.&quot;&gt;&gt;),
<a name="559"/>  559: 
<a name="560"/>  560:     %% test of is_record/2 in lc
<a name="561"/>  561:     &quot;[#foo{bar = 3}].\n&quot; =
<a name="562"/>  562:         t(&lt;&lt;&quot;rd(foo,{bar}), [X || X &lt;- [#foo{bar=3},x,[],{a,b}],&quot;
<a name="563"/>  563:             &quot;is_record(X, foo)].&quot;&gt;&gt;),
<a name="564"/>  564:     &quot;[x,[],{a,b}].\n&quot; =
<a name="565"/>  565:         t(&lt;&lt;&quot;rd(foo,{bar}), [X || X &lt;- [#foo{bar=3},x,[],{a,b}],&quot;
<a name="566"/>  566:             &quot;not is_record(X, foo)].&quot;&gt;&gt;),
<a name="567"/>  567:     &quot;[#foo{bar = 3}].\n&quot; =
<a name="568"/>  568:         t(&lt;&lt;&quot;rd(foo,{bar}), [X || X &lt;- [#foo{bar=3},x,[],{a,b}],&quot;
<a name="569"/>  569:             &quot;begin is_record(X, foo) end].&quot;&gt;&gt;),
<a name="570"/>  570:     &quot;[x,[],{a,b}].\n&quot; =
<a name="571"/>  571:         t(&lt;&lt;&quot;rd(foo,{bar}), [X || X &lt;- [#foo{bar=3},x,[],{a,b}],&quot;
<a name="572"/>  572:             &quot;begin not is_record(X, foo) end].&quot;&gt;&gt;),
<a name="573"/>  573: 
<a name="574"/>  574:     &quot;[#foo{bar = 3},x,[],{a,b}].\n&quot; =
<a name="575"/>  575:         t(&lt;&lt;&quot;rd(foo,{bar}), [X || X &lt;- [#foo{bar=3},x,[],{a,b}],&quot;
<a name="576"/>  576:             &quot;is_record(X, foo) or not is_binary(X)].&quot;&gt;&gt;),
<a name="577"/>  577:     &quot;[#foo{bar = 3},x,[],{a,b}].\n&quot; =
<a name="578"/>  578:         t(&lt;&lt;&quot;rd(foo,{bar}), [X || X &lt;- [#foo{bar=3},x,[],{a,b}],&quot;
<a name="579"/>  579:             &quot;not is_record(X, foo) or not is_binary(X)].&quot;&gt;&gt;),
<a name="580"/>  580:     &quot;[#foo{bar = 3}].\n&quot; =
<a name="581"/>  581:         t(&lt;&lt;&quot;rd(foo,{bar}), [X || X &lt;- [#foo{bar=3},x,[],{a,b}],&quot;
<a name="582"/>  582:             &quot;is_record(X, foo) or is_reference(X)].&quot;&gt;&gt;),
<a name="583"/>  583:     &quot;[x,[],{a,b}].\n&quot; =
<a name="584"/>  584:         t(&lt;&lt;&quot;rd(foo,{bar}), [X || X &lt;- [#foo{bar=3},x,[],{a,b}],&quot;
<a name="585"/>  585:             &quot;not is_record(X, foo) or is_reference(X)].&quot;&gt;&gt;),
<a name="586"/>  586: 
<a name="587"/>  587:     &quot;[#foo{bar = 3},x,[],{a,b}].\n&quot; =
<a name="588"/>  588:         t(&lt;&lt;&quot;rd(foo,{bar}), [X || X &lt;- [#foo{bar=3},x,[],{a,b}],&quot;
<a name="589"/>  589:             &quot;begin is_record(X, foo) or not is_binary(X) end].&quot;&gt;&gt;),
<a name="590"/>  590:     &quot;[#foo{bar = 3},x,[],{a,b}].\n&quot; =
<a name="591"/>  591:         t(&lt;&lt;&quot;rd(foo,{bar}), [X || X &lt;- [#foo{bar=3},x,[],{a,b}],&quot;
<a name="592"/>  592:             &quot;begin not is_record(X, foo) or not is_binary(X) end].&quot;&gt;&gt;),
<a name="593"/>  593:     &quot;[#foo{bar = 3}].\n&quot; =
<a name="594"/>  594:         t(&lt;&lt;&quot;rd(foo,{bar}), [X || X &lt;- [#foo{bar=3},x,[],{a,b}],&quot;
<a name="595"/>  595:             &quot;begin is_record(X, foo) or is_reference(X) end].&quot;&gt;&gt;),
<a name="596"/>  596:     &quot;[x,[],{a,b}].\n&quot; =
<a name="597"/>  597:         t(&lt;&lt;&quot;rd(foo,{bar}), [X || X &lt;- [#foo{bar=3},x,[],{a,b}],&quot;
<a name="598"/>  598:             &quot;begin not is_record(X, foo) or is_reference(X) end].&quot;&gt;&gt;),
<a name="599"/>  599: 
<a name="600"/>  600:     [ok] =
<a name="601"/>  601:         scan(&lt;&lt;&quot;rd(a,{}), is_record({a},a) andalso true, b().&quot;&gt;&gt;),
<a name="602"/>  602: 
<a name="603"/>  603:     %% nested record defs
<a name="604"/>  604:     &quot;#b{a = #a{}}.\n&quot; = t(&lt;&lt;&quot;rd(a,{}), rd(b, {a = #a{}}), #b{}.&quot;&gt;&gt;),
<a name="605"/>  605: 
<a name="606"/>  606:     [ok,ok,ok] = scan(&lt;&lt;&quot;rf('_'), rp(rp(rl(rf(rf(rf(rl())))))).&quot;&gt;&gt;),
<a name="607"/>  607: 
<a name="records-last_expr"/><a name="608"/>  608:     ok.
<a name="609"/>  609: 
<a name="610"/>  610: <i>%% Test of typed record support.</i>
<a name="typed_records-1"/><a name="611"/>  611: <b>typed_records</b>(Config) when is_list(Config) -&gt;
<a name="612"/>  612:     Test = filename:join(proplists:get_value(priv_dir, Config), &quot;test.hrl&quot;),
<a name="613"/>  613:     Contents = &lt;&lt;&quot;-module(test).
<a name="614"/>  614:                   -record(r0,{f :: any()}).
<a name="615"/>  615:                   -record(r1,{f1 :: #r1{} | undefined, f2 :: #r0{} | atom()}).
<a name="616"/>  616:                   -record(r2,{f :: #r2{} | undefined}).
<a name="617"/>  617:                  &quot;&gt;&gt;,
<a name="618"/>  618:     ok = file:write_file(Test, Contents),
<a name="619"/>  619: 
<a name="620"/>  620:     RR1 = &quot;rr(\&quot;&quot; ++ Test ++ &quot;\&quot;),
<a name="621"/>  621:           #r1{} = (#r1{f1=#r1{f1=undefined, f2=x}, f2 = #r0{}})#r1.f1,
<a name="622"/>  622:           ok.&quot;,
<a name="623"/>  623:     RR2 = &quot;rr(\&quot;&quot; ++ Test ++ &quot;\&quot;),
<a name="624"/>  624:           #r0{} = (#r1{f1=#r1{f1=undefined, f2=x}, f2 = #r0{}})#r1.f2,
<a name="625"/>  625:           ok. &quot;,
<a name="626"/>  626:     RR3 = &quot;rr(\&quot;&quot; ++ Test ++ &quot;\&quot;),
<a name="627"/>  627:           #r1{f2=#r0{}} = (#r1{f1=#r1{f1=undefined, f2=#r0{}}, f2 = x})#r1.f1,
<a name="628"/>  628:           ok.&quot;,
<a name="629"/>  629:     RR4 = &quot;rr(\&quot;&quot; ++ Test ++ &quot;\&quot;),
<a name="630"/>  630:           (#r1{f2 = #r0{}})#r1{f2 = x},
<a name="631"/>  631:           ok. &quot;,
<a name="632"/>  632:     RR5 = &quot;rr(\&quot;&quot; ++ Test ++ &quot;\&quot;),
<a name="633"/>  633:           (#r1{f2 = #r0{}})#r1{f1 = #r1{}},
<a name="634"/>  634:           ok. &quot;,
<a name="635"/>  635:     RR6 = &quot;rr(\&quot;&quot; ++ Test ++ &quot;\&quot;),
<a name="636"/>  636:            (#r2{f=#r2{f=undefined}})#r2.f,
<a name="637"/>  637:           ok.&quot;,
<a name="638"/>  638:     RR7 = &quot;rr(\&quot;&quot; ++ Test ++ &quot;\&quot;),
<a name="639"/>  639:            #r2{} = (#r2{f=#r2{f=undefined}})#r2.f,
<a name="640"/>  640:           ok.&quot;,
<a name="641"/>  641:     [ok] = scan(RR1),
<a name="642"/>  642:     [ok] = scan(RR2),
<a name="643"/>  643:     [ok] = scan(RR3),
<a name="644"/>  644:     [ok] = scan(RR4),
<a name="645"/>  645:     [ok] = scan(RR5),
<a name="646"/>  646:     [ok] = scan(RR6),
<a name="647"/>  647:     [ok] = scan(RR7),
<a name="648"/>  648: 
<a name="649"/>  649:     file:delete(Test),
<a name="typed_records-last_expr"/><a name="650"/>  650:     ok.
<a name="651"/>  651: 
<a name="652"/>  652: <i>%% Known bugs.</i>
<a name="known_bugs-1"/><a name="653"/>  653: <b>known_bugs</b>(Config) when is_list(Config) -&gt;
<a name="654"/>  654:     %% erl_eval:merge_bindings/2 cannot handle _removal_ of bindings.
<a name="655"/>  655:     [3] = scan(&lt;&lt;&quot;A = 3, length(begin f(A), [3] end), A.&quot;&gt;&gt;),
<a name="known_bugs-last_expr"/><a name="656"/>  656:     ok.
<a name="657"/>  657: 
<a name="658"/>  658: <i>%% OTP-5226. Wildcards accepted when reading BEAM files using rr/1,2,3.</i>
<a name="otp_5226-1"/><a name="659"/>  659: <b>otp_5226</b>(Config) when is_list(Config) -&gt;
<a name="660"/>  660:     Test1 = &lt;&lt;&quot;-module(test1).
<a name="661"/>  661:                -record('_test1', {a,b}).&quot;&gt;&gt;,
<a name="662"/>  662:     Test2 = &lt;&lt;&quot;-module(test2).
<a name="663"/>  663:                -record('_test2', {c,d}).&quot;&gt;&gt;,
<a name="664"/>  664:     File1 = filename(&quot;test1.erl&quot;, Config),
<a name="665"/>  665: 	      File2 = filename(&quot;test2.erl&quot;, Config),
<a name="666"/>  666: 	      Beam = filename(&quot;*.beam&quot;, Config),
<a name="667"/>  667: 	      ok = compile_file(Config, File1, Test1, [no_debug_info]),
<a name="668"/>  668: 	      ok = compile_file(Config, File2, Test2, [no_debug_info]),
<a name="669"/>  669: 	      RR = &quot;rr(\&quot;&quot; ++ Beam ++ &quot;\&quot;).&quot;,
<a name="670"/>  670: 	      [Recs] = scan(RR),
<a name="671"/>  671: 	      true = lists:member('_test1', Recs),
<a name="672"/>  672: 	      true = lists:member('_test2', Recs),
<a name="673"/>  673: 	      file:delete(filename(&quot;test1.beam&quot;, Config)),
<a name="674"/>  674: 	      file:delete(filename(&quot;test2.beam&quot;, Config)),
<a name="675"/>  675: 	      file:delete(File1),
<a name="676"/>  676: 	      file:delete(File2),
<a name="otp_5226-last_expr"/><a name="677"/>  677: 	      ok.
<a name="678"/>  678: 
<a name="679"/>  679: <i>%% OTP-5226. Test of eval_bits, mostly.</i>
<a name="otp_5327-1"/><a name="680"/>  680: <b>otp_5327</b>(Config) when is_list(Config) -&gt;
<a name="681"/>  681:     &quot;exception error: bad argument&quot; =
<a name="682"/>  682:         comm_err(&lt;&lt;&quot;&lt;&lt;\&quot;hej\&quot;:default&gt;&gt;.&quot;&gt;&gt;),
<a name="683"/>  683:     L1 = erl_anno:new(1),
<a name="684"/>  684:     &lt;&lt;&quot;abc&quot;&gt;&gt; =
<a name="685"/>  685:         erl_parse:normalise({bin,L1,[{bin_element,L1,{string,L1,&quot;abc&quot;},
<a name="686"/>  686:                                       default,default}]}),
<a name="687"/>  687:     [&lt;&lt;&quot;abc&quot;&gt;&gt;] = scan(&lt;&lt;&quot;&lt;&lt;(&lt;&lt;\&quot;abc\&quot;&gt;&gt;):3/binary&gt;&gt;.&quot;&gt;&gt;),
<a name="688"/>  688:     [&lt;&lt;&quot;abc&quot;&gt;&gt;] = scan(&lt;&lt;&quot;&lt;&lt;(&lt;&lt;\&quot;abc\&quot;&gt;&gt;)/binary&gt;&gt;.&quot;&gt;&gt;),
<a name="689"/>  689:     &quot;exception error: construction of binary failed&quot; =
<a name="690"/>  690:         comm_err(&lt;&lt;&quot;&lt;&lt;(&lt;&lt;\&quot;abc\&quot;&gt;&gt;):4/binary&gt;&gt;.&quot;&gt;&gt;),
<a name="691"/>  691:     true = byte_size(hd(scan(&quot;&lt;&lt;3.14:64/float&gt;&gt;.&quot;))) =:= 8,
<a name="692"/>  692:     true = byte_size(hd(scan(&quot;&lt;&lt;3.14:32/float&gt;&gt;.&quot;))) =:= 4,
<a name="693"/>  693:     &quot;exception error: construction of binary failed&quot; =
<a name="694"/>  694:         comm_err(&lt;&lt;&quot;&lt;&lt;3.14:128/float&gt;&gt;.&quot;&gt;&gt;),
<a name="695"/>  695:     &quot;exception error: bad argument&quot; =
<a name="696"/>  696:         comm_err(&lt;&lt;&quot;&lt;&lt;10:default&gt;&gt;.&quot;&gt;&gt;),
<a name="697"/>  697:     [&lt;&lt;98,1:1&gt;&gt;] = scan(&lt;&lt;&quot;&lt;&lt;3:3,5:6&gt;&gt;.&quot;&gt;&gt;),
<a name="698"/>  698:     {'EXIT',{badarg,_}} =
<a name="699"/>  699:         (catch erl_parse:normalise({bin,L1,[{bin_element,L1,{integer,L1,17},
<a name="700"/>  700:                                              {atom,L1,all},
<a name="701"/>  701:                                              default}]})),
<a name="702"/>  702:     [&lt;&lt;-20/signed&gt;&gt;] = scan(&lt;&lt;&quot;&lt;&lt;-20/signed&gt;&gt; = &lt;&lt;-20&gt;&gt;.&quot;&gt;&gt;),
<a name="703"/>  703:     [&lt;&lt;-300:16/signed&gt;&gt;] =
<a name="704"/>  704: 	scan(&lt;&lt;&quot;&lt;&lt;-300:16/signed&gt;&gt; = &lt;&lt;-300:16&gt;&gt;.&quot;&gt;&gt;),
<a name="705"/>  705:     [&lt;&lt;-1000:24/signed&gt;&gt;] =
<a name="706"/>  706: 	scan(&lt;&lt;&quot;&lt;&lt;-1000:24/signed&gt;&gt; = &lt;&lt;-1000:24&gt;&gt;.&quot;&gt;&gt;),
<a name="707"/>  707:     [&lt;&lt;-(1 bsl 29):32/signed&gt;&gt;] =
<a name="708"/>  708:         scan(&lt;&lt;&quot;&lt;&lt;-(1 bsl 29):32/signed&gt;&gt; = &lt;&lt;-(1 bsl 29):32&gt;&gt;.&quot;&gt;&gt;),
<a name="709"/>  709: 
<a name="710"/>  710:     &quot;exception error: no match of right hand side value &lt;&lt;0,0,0&gt;&gt;&quot; =
<a name="711"/>  711:         comm_err(&lt;&lt;&quot;&lt;&lt;B:3/unit:7-binary,_/binary&gt;&gt; = &lt;&lt;0:24&gt;&gt;.&quot;&gt;&gt;),
<a name="712"/>  712:     true = [&lt;&lt;103133:64/float&gt;&gt;] =:=
<a name="713"/>  713:         scan(&lt;&lt;&quot;&lt;&lt;103133:64/float&gt;&gt; = &lt;&lt;103133:64/float&gt;&gt;.&quot;&gt;&gt;),
<a name="714"/>  714:     true = [&lt;&lt;103133.0:64/float&gt;&gt;] =:=
<a name="715"/>  715:         scan(&lt;&lt;&quot;&lt;&lt;103133.0:64/float&gt;&gt; = &lt;&lt;103133:64/float&gt;&gt;.&quot;&gt;&gt;),
<a name="716"/>  716:     true = [&lt;&lt;103133:64/float&gt;&gt;] =:= scan(&lt;&lt;&quot;&lt;&lt;103133:64/float&gt;&gt;.&quot;&gt;&gt;),
<a name="717"/>  717:     Int = 17,
<a name="718"/>  718:     true = [&lt;&lt;Int:64/float&gt;&gt;] =:= scan(&lt;&lt;&quot;Int = 17, &lt;&lt;Int:64/float&gt;&gt;.&quot;&gt;&gt;),
<a name="719"/>  719:     &quot;exception error: no match of right hand side value&quot; ++ _ =
<a name="720"/>  720:         comm_err(&lt;&lt;&quot;&lt;&lt;103133:64/binary&gt;&gt; = &lt;&lt;103133:64/float&gt;&gt;.&quot;&gt;&gt;),
<a name="721"/>  721:     &quot;exception error: interpreted function with arity 1 called with two arguments&quot; =
<a name="722"/>  722:         comm_err(&lt;&lt;&quot;(fun(X) -&gt; X end)(a,b).&quot;&gt;&gt;),
<a name="723"/>  723:     {'EXIT', {{badmatch,&lt;&lt;17:32&gt;&gt;}, _}} =
<a name="724"/>  724:         (catch evaluate(&quot;&lt;&lt;A:a&gt;&gt; = &lt;&lt;17:32&gt;&gt;.&quot;, [])),
<a name="725"/>  725:     C = &lt;&lt;&quot;
<a name="726"/>  726:          &lt;&lt;A:4,B:4,C:4,D:4,E:4,F:4&gt;&gt; = &lt;&lt;\&quot;hej\&quot;&gt;&gt;,
<a name="727"/>  727:          case &lt;&lt;7:4,A:4,B:4,C:4,D:4,E:4,F:4,3:4&gt;&gt; of
<a name="728"/>  728:             &lt;&lt;_:4,\&quot;hej\&quot;,3:4&gt;&gt; -&gt; 1;
<a name="729"/>  729:             _ -&gt; 2
<a name="730"/>  730:          end.
<a name="731"/>  731:         &quot;&gt;&gt;,
<a name="732"/>  732:     1 = evaluate(C, []),
<a name="733"/>  733:     %% unbound_var would be nicer...
<a name="734"/>  734:     {'EXIT',{{illegal_pattern,_},_}} =
<a name="735"/>  735:         (catch evaluate(&lt;&lt;&quot;&lt;&lt;A:B&gt;&gt; = &lt;&lt;17:32&gt;&gt;.&quot;&gt;&gt;, [])),
<a name="736"/>  736:     %% A badarith exception is turned into badmatch.
<a name="737"/>  737:     {'EXIT', {{badmatch,&lt;&lt;1777:32&gt;&gt;}, _}} =
<a name="738"/>  738:         (catch evaluate(&lt;&lt;&quot;&lt;&lt;A:(1/0)&gt;&gt; = &lt;&lt;1777:32&gt;&gt;.&quot;&gt;&gt;, [])),
<a name="739"/>  739:     %% undefined_bittype is turned into badmatch:
<a name="740"/>  740:     {'EXIT',{{badmatch,&lt;&lt;17:32&gt;&gt;},_}} =
<a name="741"/>  741:         (catch evaluate(&lt;&lt;&quot;&lt;&lt;A/apa&gt;&gt; = &lt;&lt;17:32&gt;&gt;.&quot;&gt;&gt;, [])),
<a name="742"/>  742:     {'EXIT',_} =
<a name="743"/>  743:         (catch evaluate(&lt;&lt;&quot;&lt;&lt;17/binary-unit:8-unit:16&gt;&gt;.&quot;&gt;&gt;, [])),
<a name="744"/>  744:     {'EXIT',_} =
<a name="745"/>  745:         (catch evaluate(&lt;&lt;&quot;&lt;&lt;17:32/unsigned-signed&gt;&gt; = &lt;&lt;17:32&gt;&gt;.&quot;&gt;&gt;, [])),
<a name="746"/>  746:     {'EXIT',_} =
<a name="747"/>  747:         (catch evaluate(&lt;&lt;&quot;&lt;&lt;17:32/unsigned-signed&gt;&gt;.&quot;&gt;&gt;, [])),
<a name="748"/>  748:     &lt;&lt;17:32&gt;&gt; = evaluate(&lt;&lt;&quot;&lt;&lt;17:32/signed-signed&gt;&gt;.&quot;&gt;&gt;, []),
<a name="749"/>  749:     {'EXIT',_} =
<a name="750"/>  750:         (catch evaluate(&lt;&lt;&quot;&lt;&lt;32/unit:8&gt;&gt;.&quot;&gt;&gt;, [])),
<a name="otp_5327-last_expr"/><a name="751"/>  751:     ok.
<a name="752"/>  752: 
<a name="753"/>  753: <i>%% OTP-5435. compiler application not in the path.</i>
<a name="otp_5435-1"/><a name="754"/>  754: <b>otp_5435</b>(Config) when is_list(Config) -&gt;
<a name="755"/>  755:     true = &lt;&lt;103133:64/float&gt;&gt; =:=
<a name="756"/>  756:         evaluate(&lt;&lt;&quot;&lt;&lt;103133:64/float&gt;&gt; = &lt;&lt;103133:64/float&gt;&gt;.&quot;&gt;&gt;, []),
<a name="757"/>  757:     true = &lt;&lt;103133.0:64/float&gt;&gt; =:=
<a name="758"/>  758:         evaluate(&lt;&lt;&quot;&lt;&lt;103133.0:64/float&gt;&gt; = &lt;&lt;103133:64/float&gt;&gt;.&quot;&gt;&gt;, []),
<a name="759"/>  759:     true = is_alive(),
<a name="760"/>  760:     {ok, Peer, Node} = ?CT_PEER(),
<a name="761"/>  761:     ok = rpc:call(Node, ?MODULE, otp_5435_2, []),
<a name="762"/>  762:     peer:stop(Peer),
<a name="otp_5435-last_expr"/><a name="763"/>  763:     ok.
<a name="764"/>  764: 
<a name="otp_5435_2-0"/><a name="765"/>  765: <b>otp_5435_2</b>() -&gt;
<a name="766"/>  766:     true = code:del_path(compiler),
<a name="767"/>  767:     %% Make sure record evaluation is not dependent on the compiler
<a name="768"/>  768:     %% application being in the path.
<a name="769"/>  769:     %% OTP-5876.
<a name="770"/>  770:     [{attribute,_,record,{bar,_}},ok] =
<a name="771"/>  771:         scan(&lt;&lt;&quot;rd(foo,{bar}),
<a name="772"/>  772:                 rd(bar,{foo = (#foo{})#foo.bar}),
<a name="773"/>  773: 	       rl(bar).&quot;&gt;&gt;),
<a name="otp_5435_2-last_expr"/><a name="774"/>  774:     ok.
<a name="775"/>  775: 
<a name="776"/>  776: <i>%% OTP-5195. QLC, mostly.</i>
<a name="otp_5195-1"/><a name="777"/>  777: <b>otp_5195</b>(Config) when is_list(Config) -&gt;
<a name="778"/>  778:     %% QLC. It was easier to put these cases here than in qlc_SUITE.
<a name="779"/>  779:     &quot;[#a{b = undefined}].\n&quot; =
<a name="780"/>  780:         t(&lt;&lt;&quot;rd(a,{b}), qlc:e(qlc:q([X || X &lt;- [#a{}],is_record(X, a)])).&quot;&gt;&gt;),
<a name="781"/>  781: 
<a name="782"/>  782:     %% An experimental shell used to translate error tuples:
<a name="783"/>  783:     %% &quot;(qlc) \&quot;1: generated variable 'X' must not be used in &quot;
<a name="784"/>  784:     %% &quot;list expression\&quot;.\n&quot; =
<a name="785"/>  785:     %%    t(&lt;&lt;&quot;qlc:q([X || X &lt;- [{a}], Y &lt;- [X]]).&quot;&gt;&gt;),
<a name="786"/>  786:     %% Same as last one (if the shell does not translate error tuples):
<a name="787"/>  787:     [{error,qlc,{{1,31},qlc,{used_generator_variable,'X'}}}] =
<a name="788"/>  788:         scan(&lt;&lt;&quot;qlc:q([X || X &lt;- [{a}], Y &lt;- [X]]).&quot;&gt;&gt;),
<a name="789"/>  789:     {error,qlc,{1,qlc,{used_generator_variable,'X'}}} =
<a name="790"/>  790:         evaluate(&lt;&lt;&quot;qlc:q([X || X &lt;- [{a}], Y &lt;- [X]]).&quot;&gt;&gt;, []),
<a name="791"/>  791:     Ugly = &lt;&lt;&quot;qlc:e(qlc:q([X || X &lt;- qlc:append([[1,2,3],ugly()])])).&quot;&gt;&gt;,
<a name="792"/>  792:     &quot;undefined shell command ugly/0&quot; = error_string(Ugly),
<a name="793"/>  793:     {'EXIT',{undef,_}} = (catch evaluate(Ugly, [])),
<a name="794"/>  794: 
<a name="795"/>  795:     V_1 = &lt;&lt;&quot;qlc:e(qlc:q([X || X &lt;- qlc:append([[1,2,3],v(-1)])])).&quot;&gt;&gt;,
<a name="796"/>  796:     &quot;-1: command not found&quot; = comm_err(V_1),
<a name="797"/>  797:     {'EXIT', {undef,_}} = (catch evaluate(V_1, [])),
<a name="798"/>  798: 
<a name="799"/>  799:     &quot;1\n2\n3\n3.\n&quot; =
<a name="800"/>  800:         t(&lt;&lt;&quot;1. 2. 3. 3 = fun(A) when A =:= 2 -&gt; v(3) end(v(2)).&quot;&gt;&gt;),
<a name="801"/>  801: 
<a name="802"/>  802:     List4 = t(&lt;&lt;&quot;[a,list]. A = [1,2]. &quot;
<a name="803"/>  803: 		&quot;qlc:q([X || X &lt;- qlc:append(A, v(1))]). &quot;
<a name="804"/>  804: 		&quot;[1,2,a,list] = qlc:e(v(-1)).&quot;&gt;&gt;),
<a name="805"/>  805:     &quot;[1,2,a,list].\n&quot; = string:substr(List4, string:len(List4)-13),
<a name="806"/>  806: 
<a name="otp_5195-last_expr"/><a name="807"/>  807:     ok.
<a name="808"/>  808: 
<a name="809"/>  809: <i>%% OTP-5915. Strict record tests in guards.</i>
<a name="otp_5915-1"/><a name="810"/>  810: <b>otp_5915</b>(Config) when is_list(Config) -&gt;
<a name="811"/>  811:     C = &lt;&lt;&quot;
<a name="812"/>  812:         rd(r, {a = 4,b}),
<a name="813"/>  813: 	  rd(r1, {a,b}),
<a name="814"/>  814: 	  rd(r2, {a = #r1{},b,c=length([1,2,3])}),
<a name="815"/>  815: 	  rd(r3, {a = fun(_) -&gt; #r1{} end(1), b}),
<a name="816"/>  816: 
<a name="817"/>  817: 	  foo = fun(A) when A#r1.a &gt; A#r1.b -&gt; foo end(#r1{b = 2}),
<a name="818"/>  818: 	  0 = fun(A) when A#r2.a -&gt; 0 end(#r2{a = true}),
<a name="819"/>  819: 	  1 = fun(A) when (#r1{a = A})#r1.a &gt; 2 -&gt; 1 end(3),
<a name="820"/>  820: 	  2 = fun(N) when ((#r2{a = #r{a = 4}, b = length([a,b,c])})#r2.a)#r.a &gt; N -&gt;
<a name="821"/>  821: 		      2 end(2),
<a name="822"/>  822: 	  3 = fun(A) when (A#r2.a)#r1.a =:= 3 -&gt; 3 end(#r2{a = #r1{a = 3}}),
<a name="823"/>  823: 	  ok = fun() -&gt;
<a name="824"/>  824: 		       F = fun(A) when record(A#r.a, r1) -&gt; 4;
<a name="825"/>  825: 			      (A) when record(A#r1.a, r1) -&gt; 5
<a name="826"/>  826: 			   end,
<a name="827"/>  827: 		       5 = F(#r1{a = #r1{}}),
<a name="828"/>  828: 		       4 = F(#r{a = #r1{}}),
<a name="829"/>  829: 		       ok
<a name="830"/>  830: 	       end(),
<a name="831"/>  831: 	  3 = fun(A) when record(A#r1.a, r),
<a name="832"/>  832: 			  (A#r1.a)#r.a &gt; 3 -&gt; 3
<a name="833"/>  833: 	      end(#r1{a = #r{a = 4}}),
<a name="834"/>  834: 	  7 = fun(A) when record(A#r3.a, r1) -&gt; 7 end(#r3{}),
<a name="835"/>  835: 	  [#r1{a = 2,b = 1}] =
<a name="836"/>  836: 	  fun() -&gt;
<a name="837"/>  837: 		  [A || A &lt;- [#r1{a = 1, b = 3},
<a name="838"/>  838: 			      #r2{a = 2,b = 1},
<a name="839"/>  839: 			      #r1{a = 2, b = 1}],
<a name="840"/>  840: 			A#r1.a &gt;
<a name="841"/>  841: 			    A#r1.b]
<a name="842"/>  842: 	  end(),
<a name="843"/>  843: 	  {[_],b} =
<a name="844"/>  844: 	  fun(L) -&gt;
<a name="845"/>  845:                     %% A is checked only once:
<a name="846"/>  846: 		  R1 = [{A,B} || A &lt;- L, A#r1.a, B &lt;- L, A#r1.b],
<a name="847"/>  847: 		  A = #r2{a = true},
<a name="848"/>  848:                     %% A is checked again:
<a name="849"/>  849: 		  B = if A#r1.a -&gt; a; true -&gt; b end,
<a name="850"/>  850: 		  {R1,B}
<a name="851"/>  851: 	  end([#r1{a = true, b = true}]),
<a name="852"/>  852: 
<a name="853"/>  853: 	  p = fun(A) when (A#r1.a =:= 2) or (A#r2.a =:= 1) -&gt; o;
<a name="854"/>  854: 		 (_) -&gt; p
<a name="855"/>  855: 	      end(#r1{a = 2}),
<a name="856"/>  856: 
<a name="857"/>  857: 	  o = fun(A) when (A#r1.a =:= 2) orelse (A#r2.a =:= 1) -&gt; o;
<a name="858"/>  858: 		 (_) -&gt; p
<a name="859"/>  859: 	      end(#r1{a = 2}),
<a name="860"/>  860: 
<a name="861"/>  861: 	  3 = fun(A) when A#r1.a &gt; 3,
<a name="862"/>  862: 			  record(A, r1) -&gt; 3
<a name="863"/>  863: 	      end(#r1{a = 5}),
<a name="864"/>  864: 
<a name="865"/>  865: 	  ok = fun() -&gt;
<a name="866"/>  866: 		       F = fun(A) when (A#r2.a =:= 1) orelse (A#r2.a) -&gt; 2;
<a name="867"/>  867: 			      (A) when (A#r1.a =:= 1) orelse (A#r1.a) -&gt; 1;
<a name="868"/>  868: 			      (A) when (A#r2.a =:= 2) andalso (A#r2.b) -&gt; 3
<a name="869"/>  869: 			   end,
<a name="870"/>  870: 		       1 = F(#r1{a = 1}),
<a name="871"/>  871: 		       2 = F(#r2{a = true}),
<a name="872"/>  872: 		       3 = F(#r2{a = 2, b = true}),
<a name="873"/>  873: 		       ok
<a name="874"/>  874: 	       end(),
<a name="875"/>  875: 
<a name="876"/>  876: 	  b = fun(A) when false or not (A#r.a =:= 1) -&gt; a;
<a name="877"/>  877: 		 (_) -&gt; b
<a name="878"/>  878: 	      end(#r1{a = 1}),
<a name="879"/>  879: 	  b = fun(A) when not (A#r.a =:= 1) or false -&gt; a;
<a name="880"/>  880: 		 (_) -&gt; b
<a name="881"/>  881: 	      end(#r1{a = 1}),
<a name="882"/>  882: 
<a name="883"/>  883: 	  ok = fun() -&gt;
<a name="884"/>  884: 		       F = fun(A) when not (A#r.a =:= 1) -&gt; yes;
<a name="885"/>  885: 			      (_) -&gt; no
<a name="886"/>  886: 			   end,
<a name="887"/>  887: 		       no = F(#r1{a = 2}),
<a name="888"/>  888: 		       yes = F(#r{a = 2}),
<a name="889"/>  889: 		       no = F(#r{a = 1}),
<a name="890"/>  890: 		       ok
<a name="891"/>  891: 	       end(),
<a name="892"/>  892: 
<a name="893"/>  893: 	  a = fun(A) when record(A, r),
<a name="894"/>  894: 			  A#r.a =:= 1,
<a name="895"/>  895: 			  A#r.b =:= 2 -&gt;a
<a name="896"/>  896: 	      end(#r{a = 1, b = 2}),
<a name="897"/>  897: 	  a = fun(A) when erlang:is_record(A, r),
<a name="898"/>  898: 			  A#r.a =:= 1,
<a name="899"/>  899: 			  A#r.b =:= 2 -&gt; a
<a name="900"/>  900: 	      end(#r{a = 1, b = 2}),
<a name="901"/>  901: 	  a = fun(A) when is_record(A, r),
<a name="902"/>  902: 			  A#r.a =:= 1,
<a name="903"/>  903: 			  A#r.b =:= 2 -&gt; a
<a name="904"/>  904: 	      end(#r{a = 1, b = 2}),
<a name="905"/>  905: 
<a name="906"/>  906: 	  nop = fun(A) when (is_record(A, r1) and (A#r1.a &gt; 3)) or (A#r2.a &lt; 1) -&gt;
<a name="907"/>  907: 			japp;
<a name="908"/>  908: 		   (_) -&gt;
<a name="909"/>  909: 			nop
<a name="910"/>  910: 		end(#r2{a = 0}),
<a name="911"/>  911: 	  nop = fun(A) when (A#r1.a &gt; 3) or (A#r2.a &lt; 1) -&gt; japp;
<a name="912"/>  912: 		   (_) -&gt;
<a name="913"/>  913: 			nop
<a name="914"/>  914: 		end(#r2{a = 0}),
<a name="915"/>  915: 
<a name="916"/>  916: 	  ok = fun() -&gt;
<a name="917"/>  917: 		       F = fun(A) when (A#r1.a =:= 2) or (A#r2.a =:= 1) -&gt; o;
<a name="918"/>  918: 			      (_) -&gt; p
<a name="919"/>  919: 			   end,
<a name="920"/>  920: 		       p = F(#r2{a = 1}),
<a name="921"/>  921: 		       p = F(#r1{a = 2}),
<a name="922"/>  922: 		       ok
<a name="923"/>  923: 	       end(),
<a name="924"/>  924: 
<a name="925"/>  925: 	  ok = fun() -&gt;
<a name="926"/>  926: 		       F = fun(A) when fail, A#r1.a; A#r1.a -&gt; ab;
<a name="927"/>  927: 			      (_) -&gt; bu
<a name="928"/>  928: 			   end,
<a name="929"/>  929: 		       ab = F(#r1{a = true}),
<a name="930"/>  930: 		       bu = F(#r2{a = true}),
<a name="931"/>  931: 		       ok
<a name="932"/>  932: 	       end(),
<a name="933"/>  933: 
<a name="934"/>  934: 	  both = fun(A) when A#r.a, A#r.b -&gt; both
<a name="935"/>  935: 		 end(#r{a = true, b = true}),
<a name="936"/>  936: 
<a name="937"/>  937: 	  ok = fun() -&gt;
<a name="938"/>  938: 		       F = fun(A, B) when ((A#r1.a) orelse (B#r2.a))
<a name="939"/>  939: 					  or (B#r2.b) or (A#r1.b) -&gt; true;
<a name="940"/>  940: 			      (_, _) -&gt; false
<a name="941"/>  941: 			   end,
<a name="942"/>  942: 		       true = F(#r1{a = false, b = false}, #r2{a = false, b = true}),
<a name="943"/>  943: 		       false = F(#r1{a = true, b = true}, #r1{a = false, b = true}),
<a name="944"/>  944: 		       ok
<a name="945"/>  945: 	       end(),
<a name="946"/>  946: 
<a name="947"/>  947: 	  ok.&quot;&gt;&gt;,
<a name="948"/>  948:     [ok] = scan(C),
<a name="otp_5915-last_expr"/><a name="949"/>  949: 	  ok.
<a name="950"/>  950: 
<a name="951"/>  951: <i>%% OTP-5916. erlang:is_record/3 allowed in guards.</i>
<a name="otp_5916-1"/><a name="952"/>  952: <b>otp_5916</b>(Config) when is_list(Config) -&gt;
<a name="953"/>  953:     C = &lt;&lt;&quot;
<a name="954"/>  954:         rd(r1, {a,b}),
<a name="955"/>  955: 	  rd(r2, {a,b}),
<a name="956"/>  956: 
<a name="957"/>  957: 	  true = if erlang:is_record(#r1{},r1,3) -&gt; true; true -&gt;  false end,
<a name="958"/>  958: 	  false = if erlang:is_record(#r2{},r1,3) -&gt; true; true -&gt;  false end,
<a name="959"/>  959: 
<a name="960"/>  960: 	  true = if is_record(#r1{},r1,3) -&gt; true; true -&gt;  false end,
<a name="961"/>  961: 	  false = if is_record(#r2{},r1,3) -&gt; true; true -&gt;  false end,
<a name="962"/>  962: 
<a name="963"/>  963: 	  ok.&quot;&gt;&gt;,
<a name="964"/>  964:     [ok] = scan(C),
<a name="otp_5916-last_expr"/><a name="965"/>  965: 	  ok.
<a name="966"/>  966: 
<a name="967"/>  967: 
<a name="968"/>  968: <i>%% OTP-5327. Adopted from parts of emulator/test/bs_match_misc_SUITE.erl.</i>
<a name="bs_match_misc_SUITE-1"/><a name="969"/>  969: <b>bs_match_misc_SUITE</b>(Config) when is_list(Config) -&gt;
<a name="970"/>  970:     C = &lt;&lt;&quot;
<a name="971"/>  971:       F1 = fun() -&gt; 3.1415 end,
<a name="972"/>  972: 
<a name="973"/>  973: 	  FOne = fun() -&gt; 1.0 end,
<a name="974"/>  974: 
<a name="975"/>  975: 	  Fcmp = fun(F1, F2) when (F1 - F2) / F2 &lt; 0.0000001 -&gt; ok end,
<a name="976"/>  976: 
<a name="977"/>  977: 	  MakeSubBin = fun(Bin0) -&gt;
<a name="978"/>  978: 			       Sz = size(Bin0),
<a name="979"/>  979: 			       Bin1 = &lt;&lt;37,Bin0/binary,38,39&gt;&gt;,
<a name="980"/>  980: 			       &lt;&lt;_:8,Bin:Sz/binary,_:8,_:8&gt;&gt; = Bin1,
<a name="981"/>  981: 			       Bin
<a name="982"/>  982: 		       end,
<a name="983"/>  983: 
<a name="984"/>  984: 	  MatchFloat =
<a name="985"/>  985: 	  fun(Bin0, Fsz, I) -&gt;
<a name="986"/>  986: 		  Bin = MakeSubBin(Bin0),
<a name="987"/>  987: 		  Bsz = size(Bin) * 8,
<a name="988"/>  988: 		  Tsz = Bsz - Fsz - I,
<a name="989"/>  989: 		  &lt;&lt;_:I,F:Fsz/float,_:Tsz&gt;&gt; = Bin,
<a name="990"/>  990: 		  F
<a name="991"/>  991: 	  end,
<a name="992"/>  992: 
<a name="993"/>  993: 	  TFloat = fun() -&gt;
<a name="994"/>  994: 			   F = F1(),
<a name="995"/>  995: 			   G = FOne(),
<a name="996"/>  996: 
<a name="997"/>  997: 			   G = MatchFloat(&lt;&lt;63,128,0,0&gt;&gt;, 32, 0),
<a name="998"/>  998: 			   G = MatchFloat(&lt;&lt;63,240,0,0,0,0,0,0&gt;&gt;, 64, 0),
<a name="999"/>  999: 
<a name="1000"/> 1000: 			   Fcmp(F, MatchFloat(&lt;&lt;F:32/float&gt;&gt;, 32, 0)),
<a name="1001"/> 1001: 			   Fcmp(F, MatchFloat(&lt;&lt;F:64/float&gt;&gt;, 64, 0)),
<a name="1002"/> 1002: 			   Fcmp(F, MatchFloat(&lt;&lt;1:1,F:32/float,127:7&gt;&gt;, 32, 1)),
<a name="1003"/> 1003: 			   Fcmp(F, MatchFloat(&lt;&lt;1:1,F:64/float,127:7&gt;&gt;, 64, 1)),
<a name="1004"/> 1004: 			   Fcmp(F, MatchFloat(&lt;&lt;1:13,F:32/float,127:3&gt;&gt;, 32, 13)),
<a name="1005"/> 1005: 			   Fcmp(F, MatchFloat(&lt;&lt;1:13,F:64/float,127:3&gt;&gt;, 64, 13))
<a name="1006"/> 1006: 		   end,
<a name="1007"/> 1007: 	  TFloat(),
<a name="1008"/> 1008: 
<a name="1009"/> 1009: 	  F2 = fun() -&gt; 2.7133 end,
<a name="1010"/> 1010: 
<a name="1011"/> 1011: 	  MatchFloatLittle = fun(Bin0, Fsz, I) -&gt;
<a name="1012"/> 1012: 				     Bin = MakeSubBin(Bin0),
<a name="1013"/> 1013: 				     Bsz = size(Bin) * 8,
<a name="1014"/> 1014: 				     Tsz = Bsz - Fsz - I,
<a name="1015"/> 1015: 				     &lt;&lt;_:I,F:Fsz/float-little,_:Tsz&gt;&gt; = Bin,
<a name="1016"/> 1016: 				     F
<a name="1017"/> 1017: 			     end,
<a name="1018"/> 1018: 
<a name="1019"/> 1019: 	  LittleFloat = fun() -&gt;
<a name="1020"/> 1020: 				F = F2(),
<a name="1021"/> 1021: 				G = FOne(),
<a name="1022"/> 1022: 
<a name="1023"/> 1023: 				G = MatchFloatLittle(&lt;&lt;0,0,0,0,0,0,240,63&gt;&gt;, 64, 0),
<a name="1024"/> 1024: 				G = MatchFloatLittle(&lt;&lt;0,0,128,63&gt;&gt;, 32, 0),
<a name="1025"/> 1025: 
<a name="1026"/> 1026: 				Fcmp(F, MatchFloatLittle(&lt;&lt;F:32/float-little&gt;&gt;, 32, 0)),
<a name="1027"/> 1027: 				Fcmp(F, MatchFloatLittle(&lt;&lt;F:64/float-little&gt;&gt;, 64, 0)),
<a name="1028"/> 1028: 				Fcmp(F, MatchFloatLittle(&lt;&lt;1:1,F:32/float-little,127:7&gt;&gt;, 32, 1)),
<a name="1029"/> 1029: 				Fcmp(F, MatchFloatLittle(&lt;&lt;1:1,F:64/float-little,127:7&gt;&gt;, 64, 1)),
<a name="1030"/> 1030: 				Fcmp(F, MatchFloatLittle(&lt;&lt;1:13,F:32/float-little,127:3&gt;&gt;, 32, 13)),
<a name="1031"/> 1031: 				Fcmp(F, MatchFloatLittle(&lt;&lt;1:13,F:64/float-little,127:3&gt;&gt;, 64, 13))
<a name="1032"/> 1032: 			end,
<a name="1033"/> 1033: 	  LittleFloat(),
<a name="1034"/> 1034: 
<a name="1035"/> 1035: 	  Sean1 = fun(&lt;&lt;B/binary&gt;&gt;) when size(B) &lt; 4 -&gt; small;
<a name="1036"/> 1036: 		     (&lt;&lt;1, _B/binary&gt;&gt;) -&gt; large
<a name="1037"/> 1037: 		  end,
<a name="1038"/> 1038: 
<a name="1039"/> 1039: 	  Sean = fun() -&gt;
<a name="1040"/> 1040: 			 small = Sean1(&lt;&lt;&gt;&gt;),
<a name="1041"/> 1041: 			 small = Sean1(&lt;&lt;1&gt;&gt;),
<a name="1042"/> 1042: 			 small = Sean1(&lt;&lt;1,2&gt;&gt;),
<a name="1043"/> 1043: 			 small = Sean1(&lt;&lt;1,2,3&gt;&gt;),
<a name="1044"/> 1044: 			 large = Sean1(&lt;&lt;1,2,3,4&gt;&gt;),
<a name="1045"/> 1045: 
<a name="1046"/> 1046: 			 small = Sean1(&lt;&lt;4&gt;&gt;),
<a name="1047"/> 1047: 			 small = Sean1(&lt;&lt;4,5&gt;&gt;),
<a name="1048"/> 1048: 			 small = Sean1(&lt;&lt;4,5,6&gt;&gt;),
<a name="1049"/> 1049: 			 {'EXIT',{function_clause,_}} = (catch Sean1(&lt;&lt;4,5,6,7&gt;&gt;))
<a name="1050"/> 1050: 		 end,
<a name="1051"/> 1051: 	  Sean(),
<a name="1052"/> 1052: 
<a name="1053"/> 1053: 	  NativeBig = fun() -&gt;
<a name="1054"/> 1054: 			      &lt;&lt;37.33:64/native-float&gt;&gt; = &lt;&lt;37.33:64/big-float&gt;&gt;,
<a name="1055"/> 1055: 			      &lt;&lt;3974:16/native-integer&gt;&gt; = &lt;&lt;3974:16/big-integer&gt;&gt;
<a name="1056"/> 1056: 		      end,
<a name="1057"/> 1057: 
<a name="1058"/> 1058: 	  NativeLittle = fun() -&gt;
<a name="1059"/> 1059: 				 &lt;&lt;37869.32343:64/native-float&gt;&gt; = &lt;&lt;37869.32343:64/little-float&gt;&gt;,
<a name="1060"/> 1060: 				 &lt;&lt;7974:16/native-integer&gt;&gt; = &lt;&lt;7974:16/little-integer&gt;&gt;
<a name="1061"/> 1061: 			 end,
<a name="1062"/> 1062: 
<a name="1063"/> 1063: 	  Native = fun() -&gt;
<a name="1064"/> 1064: 			   &lt;&lt;3.14:64/native-float&gt;&gt; = &lt;&lt;3.14:64/native-float&gt;&gt;,
<a name="1065"/> 1065: 			   &lt;&lt;333:16/native&gt;&gt; = &lt;&lt;333:16/native&gt;&gt;,
<a name="1066"/> 1066: 			   &lt;&lt;38658345:32/native&gt;&gt; = &lt;&lt;38658345:32/native&gt;&gt;,
<a name="1067"/> 1067: 			   case &lt;&lt;1:16/native&gt;&gt; of
<a name="1068"/> 1068: 			       &lt;&lt;0,1&gt;&gt; -&gt; NativeBig();
<a name="1069"/> 1069: 			       &lt;&lt;1,0&gt;&gt; -&gt; NativeLittle()
<a name="1070"/> 1070: 			   end
<a name="1071"/> 1071: 		   end,
<a name="1072"/> 1072: 	  Native(),
<a name="1073"/> 1073: 
<a name="1074"/> 1074: 	  Split = fun(&lt;&lt;N:16,B:N/binary,T/binary&gt;&gt;) -&gt; {B,T} end,
<a name="1075"/> 1075: 
<a name="1076"/> 1076: 	  Split2 = fun(N, &lt;&lt;N:16,B:N/binary,T/binary&gt;&gt;) -&gt; {B,T} end,
<a name="1077"/> 1077: 
<a name="1078"/> 1078: 	  Split_2 = fun(&lt;&lt;N0:8,N:N0,B:N/binary,T/binary&gt;&gt;) -&gt; {B,T} end,
<a name="1079"/> 1079: 
<a name="1080"/> 1080: 	  Skip = fun(&lt;&lt;N:8,_:N/binary,T/binary&gt;&gt;) -&gt; T end,
<a name="1081"/> 1081: 
<a name="1082"/> 1082: 	  SizeVar = fun() -&gt;
<a name="1083"/> 1083: 			    {&lt;&lt;45&gt;&gt;,&lt;&lt;&gt;&gt;} = Split(&lt;&lt;1:16,45&gt;&gt;),
<a name="1084"/> 1084: 			    {&lt;&lt;45&gt;&gt;,&lt;&lt;46,47&gt;&gt;} = Split(&lt;&lt;1:16,45,46,47&gt;&gt;),
<a name="1085"/> 1085: 			    {&lt;&lt;45,46&gt;&gt;,&lt;&lt;47&gt;&gt;} = Split(&lt;&lt;2:16,45,46,47&gt;&gt;),
<a name="1086"/> 1086: 
<a name="1087"/> 1087: 			    {&lt;&lt;45,46,47&gt;&gt;,&lt;&lt;48&gt;&gt;} = Split_2(&lt;&lt;16:8,3:16,45,46,47,48&gt;&gt;),
<a name="1088"/> 1088: 
<a name="1089"/> 1089: 			    {&lt;&lt;45,46&gt;&gt;,&lt;&lt;47&gt;&gt;} = Split2(2, &lt;&lt;2:16,45,46,47&gt;&gt;),
<a name="1090"/> 1090: 			    {'EXIT',{function_clause,_}} =
<a name="1091"/> 1091: 				(catch Split2(42, &lt;&lt;2:16,45,46,47&gt;&gt;)),
<a name="1092"/> 1092: 
<a name="1093"/> 1093: 			    &lt;&lt;\&quot;cdef\&quot;&gt;&gt; = Skip(&lt;&lt;2:8,\&quot;abcdef\&quot;&gt;&gt;)
<a name="1094"/> 1094:        end,
<a name="1095"/> 1095: 			      SizeVar(),
<a name="1096"/> 1096: 
<a name="1097"/> 1097: 			      Wcheck = fun(&lt;&lt;A&gt;&gt;) when A==3-&gt; ok1;
<a name="1098"/> 1098: 					  (&lt;&lt;_,_:2/binary&gt;&gt;) -&gt; ok2;
<a name="1099"/> 1099: 					  (&lt;&lt;_&gt;&gt;) -&gt; ok3;
<a name="1100"/> 1100: 					  (Other) -&gt; {error,Other}
<a name="1101"/> 1101: 				       end,
<a name="1102"/> 1102: 
<a name="1103"/> 1103: 			      Wiger = fun()  -&gt;
<a name="1104"/> 1104: 					      ok1 = Wcheck(&lt;&lt;3&gt;&gt;),
<a name="1105"/> 1105: 					      ok2 = Wcheck(&lt;&lt;1,2,3&gt;&gt;),
<a name="1106"/> 1106: 					      ok3 = Wcheck(&lt;&lt;4&gt;&gt;),
<a name="1107"/> 1107: 					      {error,&lt;&lt;1,2,3,4&gt;&gt;} = Wcheck(&lt;&lt;1,2,3,4&gt;&gt;),
<a name="1108"/> 1108: 					      {error,&lt;&lt;&gt;&gt;} = Wcheck(&lt;&lt;&gt;&gt;)
<a name="1109"/> 1109: 				      end,
<a name="1110"/> 1110: 			      Wiger(),
<a name="1111"/> 1111: 
<a name="1112"/> 1112: 			      ok.
<a name="1113"/> 1113: &quot;&gt;&gt;,
<a name="1114"/> 1114:     [ok] = scan(C),
<a name="bs_match_misc_SUITE-last_expr"/><a name="1115"/> 1115: <b>ok = evaluate</b>(C, []).
<a name="1116"/> 1116: 
<a name="1117"/> 1117: <i>%% This one is not run during night builds since it takes several minutes.</i>
<a name="1118"/> 1118: 
<a name="1119"/> 1119: <i>%% OTP-5327. Adopted from emulator/test/bs_match_int_SUITE.erl.</i>
<a name="bs_match_int_SUITE-1"/><a name="1120"/> 1120: <b>bs_match_int_SUITE</b>(Config) when is_list(Config) -&gt;
<a name="1121"/> 1121:     C = &lt;&lt;&quot;
<a name="1122"/> 1122:        FunClause = fun({'EXIT',{function_clause,_}}) -&gt; ok end,
<a name="1123"/> 1123: 
<a name="1124"/> 1124: 	  Mkbin = fun(L) when list(L) -&gt; list_to_binary(L) end,
<a name="1125"/> 1125: 
<a name="1126"/> 1126: 	  GetInt1 = fun(&lt;&lt;I:0&gt;&gt;) -&gt; I;
<a name="1127"/> 1127: 		       (&lt;&lt;I:8&gt;&gt;) -&gt; I;
<a name="1128"/> 1128: 		       (&lt;&lt;I:16&gt;&gt;) -&gt; I;
<a name="1129"/> 1129: 		       (&lt;&lt;I:24&gt;&gt;) -&gt; I;
<a name="1130"/> 1130: 		       (&lt;&lt;I:32&gt;&gt;) -&gt; I
<a name="1131"/> 1131: 		    end,
<a name="1132"/> 1132: 
<a name="1133"/> 1133: 	  GetInt2 = fun(Bin0, I, F) when size(Bin0) &lt; 4 -&gt;
<a name="1134"/> 1134: 			    Bin = &lt;&lt;0,Bin0/binary&gt;&gt;,
<a name="1135"/> 1135: 			    I = GetInt1(Bin),
<a name="1136"/> 1136: 			    F(Bin, I, F);
<a name="1137"/> 1137: 		       (_, I, _F) -&gt; I
<a name="1138"/> 1138: 		    end,
<a name="1139"/> 1139: 
<a name="1140"/> 1140: 	  GetInt = fun(Bin) -&gt;
<a name="1141"/> 1141: 			   I = GetInt1(Bin),
<a name="1142"/> 1142: 			   GetInt2(Bin, I, GetInt2)
<a name="1143"/> 1143: 		   end,
<a name="1144"/> 1144: 
<a name="1145"/> 1145: 
<a name="1146"/> 1146: 	  Cmp128 = fun(&lt;&lt;I:128&gt;&gt;, I) -&gt; equal;
<a name="1147"/> 1147: 		      (_, _) -&gt; not_equal
<a name="1148"/> 1148: 		   end,
<a name="1149"/> 1149: 
<a name="1150"/> 1150: 	  Uint2 = fun([H|T], Acc, F) -&gt; F(T, Acc bsl 8 bor H, F);
<a name="1151"/> 1151: 		     ([], Acc, _F) -&gt; Acc
<a name="1152"/> 1152: 		  end,
<a name="1153"/> 1153: 
<a name="1154"/> 1154: 	  Uint = fun(L) -&gt; Uint2(L, 0, Uint2) end,
<a name="1155"/> 1155: 
<a name="1156"/> 1156: 	  Integer = fun() -&gt;
<a name="1157"/> 1157: 			    0 = GetInt(Mkbin([])),
<a name="1158"/> 1158: 			    0 = GetInt(Mkbin([0])),
<a name="1159"/> 1159: 			    42 = GetInt(Mkbin([42])),
<a name="1160"/> 1160: 			    255 = GetInt(Mkbin([255])),
<a name="1161"/> 1161: 			    256 = GetInt(Mkbin([1,0])),
<a name="1162"/> 1162: 			    257 = GetInt(Mkbin([1,1])),
<a name="1163"/> 1163: 			    258 = GetInt(Mkbin([1,2])),
<a name="1164"/> 1164: 			    258 = GetInt(Mkbin([1,2])),
<a name="1165"/> 1165: 			    65534 = GetInt(Mkbin([255,254])),
<a name="1166"/> 1166: 			    16776455 = GetInt(Mkbin([255,253,7])),
<a name="1167"/> 1167: 			    4245492555 = GetInt(Mkbin([253,13,19,75])),
<a name="1168"/> 1168: 			    4294967294 = GetInt(Mkbin([255,255,255,254])),
<a name="1169"/> 1169: 			    4294967295 = GetInt(Mkbin([255,255,255,255])),
<a name="1170"/> 1170: 			    Eight = [200,1,19,128,222,42,97,111],
<a name="1171"/> 1171: 			    Cmp128(Eight, Uint(Eight)),
<a name="1172"/> 1172: 			    FunClause(catch GetInt(Mkbin(lists:seq(1,5))))
<a name="1173"/> 1173: 		    end,
<a name="1174"/> 1174: 	  Integer(),
<a name="1175"/> 1175: 
<a name="1176"/> 1176: 	  Sint = fun(Bin) -&gt;
<a name="1177"/> 1177: 			 case Bin of
<a name="1178"/> 1178: 			     &lt;&lt;I:8/signed&gt;&gt; -&gt; I;
<a name="1179"/> 1179: 			     &lt;&lt;I:8/signed,_:3,_:5&gt;&gt; -&gt; I;
<a name="1180"/> 1180: 			     Other -&gt; {no_match,Other}
<a name="1181"/> 1181: 			 end
<a name="1182"/> 1182: 		 end,
<a name="1183"/> 1183: 
<a name="1184"/> 1184: 	  SignedInteger = fun() -&gt;
<a name="1185"/> 1185: 				  {no_match,_} = Sint(Mkbin([])),
<a name="1186"/> 1186: 				  {no_match,_} = Sint(Mkbin([1,2,3])),
<a name="1187"/> 1187: 				  127 = Sint(Mkbin([127])),
<a name="1188"/> 1188: 				  -1 = Sint(Mkbin([255])),
<a name="1189"/> 1189: 				  -128 = Sint(Mkbin([128])),
<a name="1190"/> 1190: 				  42 = Sint(Mkbin([42,255])),
<a name="1191"/> 1191: 				  127 = Sint(Mkbin([127,255]))
<a name="1192"/> 1192: 			  end,
<a name="1193"/> 1193: 	  SignedInteger(),
<a name="1194"/> 1194: 
<a name="1195"/> 1195: 	  Dynamic5 = fun(Bin, S1, S2, A, B) -&gt;
<a name="1196"/> 1196: 			     case Bin of
<a name="1197"/> 1197: 				 &lt;&lt;A:S1,B:S2&gt;&gt; -&gt;
<a name="1198"/> 1198:                               %% io:format(\&quot;~p ~p ~p ~p~n\&quot;, [S1,S2,A,B]),
<a name="1199"/> 1199: 				     ok;
<a name="1200"/> 1200: 				 _Other -&gt; erlang:error(badmatch, [Bin,S1,S2,A,B])
<a name="1201"/> 1201: 			     end
<a name="1202"/> 1202: 		     end,
<a name="1203"/> 1203: 
<a name="1204"/> 1204: 	  Dynamic2 = fun(Bin, S1, F) when S1 &gt;= 0 -&gt;
<a name="1205"/> 1205: 			     S2 = size(Bin) * 8 - S1,
<a name="1206"/> 1206: 			     Dynamic5(Bin, S1, S2, (1 bsl S1) - 1, (1 bsl S2) - 1),
<a name="1207"/> 1207: 			     F(Bin, S1-1, F);
<a name="1208"/> 1208: 			(_, _, _) -&gt; ok
<a name="1209"/> 1209: 		     end,
<a name="1210"/> 1210: 
<a name="1211"/> 1211: 	  Dynamic = fun(Bin, S1) -&gt;
<a name="1212"/> 1212: 			    Dynamic2(Bin, S1, Dynamic2)
<a name="1213"/> 1213: 		    end,
<a name="1214"/> 1214: 
<a name="1215"/> 1215: 	  Dynamic(Mkbin([255]), 8),
<a name="1216"/> 1216: 	  Dynamic(Mkbin([255,255]), 16),
<a name="1217"/> 1217: 	  Dynamic(Mkbin([255,255,255]), 24),
<a name="1218"/> 1218: 	  Dynamic(Mkbin([255,255,255,255]), 32),
<a name="1219"/> 1219: 
<a name="1220"/> 1220: 	  BigToLittle4 =
<a name="1221"/> 1221: 	  fun([B0,B1,B2,B3,B4,B5,B6,B7|T], N, Acc, F) when N &gt;= 8 -&gt;
<a name="1222"/> 1222: 		  F(T, N-8, [B0,B1,B2,B3,B4,B5,B6,B7|Acc], F);
<a name="1223"/> 1223: 	     (List, N, Acc, _F) -&gt; lists:sublist(List, 1, N) ++ Acc
<a name="1224"/> 1224: 	  end,
<a name="1225"/> 1225: 
<a name="1226"/> 1226: 	  BigToLittle =
<a name="1227"/> 1227: 	  fun(List, N) -&gt; BigToLittle4(List, N, [], BigToLittle4) end,
<a name="1228"/> 1228: 
<a name="1229"/> 1229: 	  ReversedSublist =
<a name="1230"/> 1230: 	  fun(_List, 0, Acc, _F) -&gt; Acc;
<a name="1231"/> 1231: 	     ([H|T], N, Acc, F) -&gt; F(T, N-1, [H|Acc], F)
<a name="1232"/> 1232: 	  end,
<a name="1233"/> 1233: 
<a name="1234"/> 1234: 	  TwoComplementAndReverse =
<a name="1235"/> 1235: 	  fun([H|T], Carry, Acc, F) -&gt;
<a name="1236"/> 1236: 		  Sum = 1-H+Carry,
<a name="1237"/> 1237: 		  F(T, Sum div 2, [Sum rem 2|Acc], F);
<a name="1238"/> 1238: 	     ([], Carry, Acc, _F) -&gt; [Carry|Acc]
<a name="1239"/> 1239: 	  end,
<a name="1240"/> 1240: 
<a name="1241"/> 1241: 	  MakeInt = fun(_List, 0, Acc, _F) -&gt; Acc;
<a name="1242"/> 1242: 		       ([H|T], N, Acc, F) -&gt; F(T, N-1, Acc bsl 1 bor H, F)
<a name="1243"/> 1243: 		    end,
<a name="1244"/> 1244: 
<a name="1245"/> 1245: 	  MakeSignedInt =
<a name="1246"/> 1246: 	  fun(_List, 0) -&gt; 0;
<a name="1247"/> 1247: 	     ([0|_]=List, N) -&gt; MakeInt(List, N, 0, MakeInt);
<a name="1248"/> 1248: 	     ([1|_]=List0, N) -&gt;
<a name="1249"/> 1249: 		  List1 = ReversedSublist(List0, N, [], ReversedSublist),
<a name="1250"/> 1250: 		  List2 = TwoComplementAndReverse(List1, 1, [],
<a name="1251"/> 1251: 						  TwoComplementAndReverse),
<a name="1252"/> 1252: 		  -MakeInt(List2, length(List2), 0, MakeInt)
<a name="1253"/> 1253: 	  end,
<a name="1254"/> 1254: 
<a name="1255"/> 1255: 	  BitsToList =
<a name="1256"/> 1256: 	  fun([H|T], 0, F) -&gt; F(T, 16#80, F);
<a name="1257"/> 1257: 	     ([H|_]=List, Mask, F) -&gt;
<a name="1258"/> 1258: 		  [case H band Mask of
<a name="1259"/> 1259:                        0 -&gt; 0;
<a name="1260"/> 1260:                        _ -&gt; 1
<a name="1261"/> 1261: 		   end | F(List, Mask bsr 1, F)];
<a name="1262"/> 1262: 	     ([], _, _F) -&gt; []
<a name="1263"/> 1263: 	  end,
<a name="1264"/> 1264: 
<a name="1265"/> 1265: 	  MoreDynamic3 =
<a name="1266"/> 1266: 	  fun(Action, Bin, List, Bef, Aft, F) when Bef =&lt; Aft -&gt;
<a name="1267"/> 1267: 		  Action(Bin, List, Bef, Aft-Bef),
<a name="1268"/> 1268: 		  F(Action, Bin, List, Bef, Aft-1, F);
<a name="1269"/> 1269: 	     (_, _, _, _, _, _) -&gt; ok
<a name="1270"/> 1270: 	  end,
<a name="1271"/> 1271: 
<a name="1272"/> 1272: 	  MoreDynamic2 =
<a name="1273"/> 1273: 	  fun(Action, Bin, [_|T]=List, Bef, F) -&gt;
<a name="1274"/> 1274: 		  MoreDynamic3(Action, Bin, List, Bef, size(Bin)*8,
<a name="1275"/> 1275: 			       MoreDynamic3),
<a name="1276"/> 1276: 		  F(Action, Bin, T, Bef+1, F);
<a name="1277"/> 1277: 	     (_, _, [], _, _F) -&gt; ok
<a name="1278"/> 1278: 	  end,
<a name="1279"/> 1279: 
<a name="1280"/> 1280: 	  MoreDynamic1 =
<a name="1281"/> 1281: 	  fun(Action, Bin) -&gt;
<a name="1282"/> 1282: 		  BitList = BitsToList(binary_to_list(Bin),16#80,BitsToList),
<a name="1283"/> 1283: 		  MoreDynamic2(Action, Bin, BitList, 0, MoreDynamic2)
<a name="1284"/> 1284: 	  end,
<a name="1285"/> 1285: 
<a name="1286"/> 1286: 	  MoreDynamic = fun() -&gt;
<a name="1287"/> 1287:            %% Unsigned big-endian numbers.
<a name="1288"/> 1288: 				Unsigned  = fun(Bin, List, SkipBef, N) -&gt;
<a name="1289"/> 1289: 						    SkipAft = 8*size(Bin) - N - SkipBef,
<a name="1290"/> 1290: 						    &lt;&lt;_:SkipBef,Int:N,_:SkipAft&gt;&gt; = Bin,
<a name="1291"/> 1291: 						    Int = MakeInt(List, N, 0, MakeInt)
<a name="1292"/> 1292: 					    end,
<a name="1293"/> 1293: 				MoreDynamic1(Unsigned, erlang:md5(Mkbin([42]))),
<a name="1294"/> 1294: 
<a name="1295"/> 1295:            %% Signed big-endian numbers.
<a name="1296"/> 1296: 				Signed  = fun(Bin, List, SkipBef, N) -&gt;
<a name="1297"/> 1297: 						  SkipAft = 8*size(Bin) - N - SkipBef,
<a name="1298"/> 1298: 						  &lt;&lt;_:SkipBef,Int:N/signed,_:SkipAft&gt;&gt; = Bin,
<a name="1299"/> 1299: 						  case MakeSignedInt(List, N) of
<a name="1300"/> 1300: 						      Int -&gt; ok;
<a name="1301"/> 1301: 						      Other -&gt;
<a name="1302"/> 1302: 							  io:format(\&quot;Bin = ~p,\&quot;, [Bin]),
<a name="1303"/> 1303:                                      io:format(\&quot;SkipBef = ~p, N = ~p\&quot;,
<a name="1304"/> 1304:                                                [SkipBef,N]),
<a name="1305"/> 1305: 								    io:format(\&quot;Expected ~p, got ~p\&quot;,
<a name="1306"/> 1306:                                                [Int,Other])
<a name="1307"/> 1307: 								    end
<a name="1308"/> 1308: 								    end,
<a name="1309"/> 1309: 								    MoreDynamic1(Signed, erlang:md5(Mkbin([43]))),
<a name="1310"/> 1310: 
<a name="1311"/> 1311:            %% Unsigned little-endian numbers.
<a name="1312"/> 1312: 								    UnsLittle  = fun(Bin, List, SkipBef, N) -&gt;
<a name="1313"/> 1313: 											 SkipAft = 8*size(Bin) - N - SkipBef,
<a name="1314"/> 1314: 											 &lt;&lt;_:SkipBef,Int:N/little,_:SkipAft&gt;&gt; = Bin,
<a name="1315"/> 1315: 											 Int = MakeInt(BigToLittle(List, N), N, 0,
<a name="1316"/> 1316: 												       MakeInt)
<a name="1317"/> 1317: 										 end,
<a name="1318"/> 1318: 								    MoreDynamic1(UnsLittle, erlang:md5(Mkbin([44]))),
<a name="1319"/> 1319: 
<a name="1320"/> 1320:            %% Signed little-endian numbers.
<a name="1321"/> 1321: 								    SignLittle  = fun(Bin, List, SkipBef, N) -&gt;
<a name="1322"/> 1322: 											  SkipAft = 8*size(Bin) - N - SkipBef,
<a name="1323"/> 1323: 											  &lt;&lt;_:SkipBef,Int:N/signed-little,_:SkipAft&gt;&gt; = Bin,
<a name="1324"/> 1324: 											  Little = BigToLittle(List, N),
<a name="1325"/> 1325: 											  Int = MakeSignedInt(Little, N)
<a name="1326"/> 1326: 										  end,
<a name="1327"/> 1327: 								    MoreDynamic1(SignLittle, erlang:md5(Mkbin([45])))
<a name="1328"/> 1328: 								    end,
<a name="1329"/> 1329: 								    MoreDynamic(),
<a name="1330"/> 1330: 
<a name="1331"/> 1331: 								    ok.
<a name="1332"/> 1332: &quot;&gt;&gt;,
<a name="1333"/> 1333:     [ok] = scan(C),
<a name="bs_match_int_SUITE-last_expr"/><a name="1334"/> 1334: <b>ok = evaluate</b>(C, []).
<a name="1335"/> 1335: 
<a name="1336"/> 1336: <i>%% OTP-5327. Adopted from emulator/test/bs_match_tail_SUITE.erl.</i>
<a name="bs_match_tail_SUITE-1"/><a name="1337"/> 1337: <b>bs_match_tail_SUITE</b>(Config) when is_list(Config) -&gt;
<a name="1338"/> 1338:     C = &lt;&lt;&quot;
<a name="1339"/> 1339:           GetTailUsed = fun(&lt;&lt;A:1,T/binary&gt;&gt;) -&gt; {A,T} end,
<a name="1340"/> 1340: 
<a name="1341"/> 1341:           GetTailUnused = fun(&lt;&lt;A:15,_/binary&gt;&gt;) -&gt; A end,
<a name="1342"/> 1342: 
<a name="1343"/> 1343:           GetDynTailUsed = fun(Bin, Sz) -&gt;
<a name="1344"/> 1344: 				   &lt;&lt;A:Sz,T/binary&gt;&gt; = Bin,
<a name="1345"/> 1345: 				   {A,T}
<a name="1346"/> 1346:                            end,
<a name="1347"/> 1347: 
<a name="1348"/> 1348:           GetDynTailUnused = fun(Bin, Sz) -&gt;
<a name="1349"/> 1349: 				     &lt;&lt;A:Sz,_/binary&gt;&gt; = Bin,
<a name="1350"/> 1350: 				     A
<a name="1351"/> 1351:                              end,
<a name="1352"/> 1352: 
<a name="1353"/> 1353:           Mkbin = fun(L) when list(L) -&gt; list_to_binary(L) end,
<a name="1354"/> 1354: 
<a name="1355"/> 1355:           TestZeroTail = fun(&lt;&lt;A:8&gt;&gt;) -&gt; A end,
<a name="1356"/> 1356: 
<a name="1357"/> 1357:           TestZeroTail2 = fun(&lt;&lt;_A:4,_B:4&gt;&gt;) -&gt; ok end,
<a name="1358"/> 1358: 
<a name="1359"/> 1359:           ZeroTail = fun() -&gt;
<a name="1360"/> 1360: 			     7 = (catch TestZeroTail(Mkbin([7]))),
<a name="1361"/> 1361: 			     {'EXIT',{function_clause,_}} =
<a name="1362"/> 1362: 				 (catch TestZeroTail(Mkbin([1,2]))),
<a name="1363"/> 1363: 			     {'EXIT',{function_clause,_}} =
<a name="1364"/> 1364: 				 (catch TestZeroTail2(Mkbin([1,2,3])))
<a name="1365"/> 1365: 		     end,
<a name="1366"/> 1366:           ZeroTail(),
<a name="1367"/> 1367: 
<a name="1368"/> 1368:           AlGetTailUsed = fun(&lt;&lt;A:16,T/binary&gt;&gt;) -&gt; {A,T} end,
<a name="1369"/> 1369: 
<a name="1370"/> 1370:           AlGetTailUnused = fun(&lt;&lt;A:16,_/binary&gt;&gt;) -&gt; A end,
<a name="1371"/> 1371: 
<a name="1372"/> 1372:           Aligned = fun() -&gt;
<a name="1373"/> 1373: 			    Tail1 = Mkbin([]),
<a name="1374"/> 1374: 			    {258,Tail1} = AlGetTailUsed(Mkbin([1,2])),
<a name="1375"/> 1375: 			    Tail2 = Mkbin(lists:seq(1, 127)),
<a name="1376"/> 1376: 			    {35091,Tail2} = AlGetTailUsed(Mkbin([137,19|Tail2])),
<a name="1377"/> 1377: 
<a name="1378"/> 1378: 			    64896 = AlGetTailUnused(Mkbin([253,128])),
<a name="1379"/> 1379: 			    64895 = AlGetTailUnused(Mkbin([253,127|lists:seq(42, 255)])),
<a name="1380"/> 1380: 
<a name="1381"/> 1381: 			    Tail3 = Mkbin(lists:seq(0, 19)),
<a name="1382"/> 1382: 			    {0,Tail1} = GetDynTailUsed(Tail1, 0),
<a name="1383"/> 1383: 			    {0,Tail3} = GetDynTailUsed(Mkbin([Tail3]), 0),
<a name="1384"/> 1384: 			    {73,Tail3} = GetDynTailUsed(Mkbin([73|Tail3]), 8),
<a name="1385"/> 1385: 
<a name="1386"/> 1386: 			    0 = GetDynTailUnused(Mkbin([]), 0),
<a name="1387"/> 1387: 			    233 = GetDynTailUnused(Mkbin([233]), 8),
<a name="1388"/> 1388: 			    23 = GetDynTailUnused(Mkbin([23,22,2]), 8)
<a name="1389"/> 1389: 		    end,
<a name="1390"/> 1390:           Aligned(),
<a name="1391"/> 1391: 
<a name="1392"/> 1392:           UnAligned = fun() -&gt;
<a name="1393"/> 1393: 			      {'EXIT',{function_clause,_}} =
<a name="1394"/> 1394: 				  (catch GetTailUsed(Mkbin([42]))),
<a name="1395"/> 1395: 			      {'EXIT',{{badmatch,_},_}} =
<a name="1396"/> 1396: 				  (catch GetDynTailUsed(Mkbin([137]), 3)),
<a name="1397"/> 1397: 			      {'EXIT',{function_clause,_}} =
<a name="1398"/> 1398: 				  (catch GetTailUnused(Mkbin([42,33]))),
<a name="1399"/> 1399: 			      {'EXIT',{{badmatch,_},_}} =
<a name="1400"/> 1400: 				  (catch GetDynTailUnused(Mkbin([44]), 7))
<a name="1401"/> 1401: 		      end,
<a name="1402"/> 1402:           UnAligned(),
<a name="1403"/> 1403:           ok.
<a name="1404"/> 1404: &quot;&gt;&gt;,
<a name="1405"/> 1405:     [ok] = scan(C),
<a name="bs_match_tail_SUITE-last_expr"/><a name="1406"/> 1406: <b>ok = evaluate</b>(C, []).
<a name="1407"/> 1407: 
<a name="1408"/> 1408: <i>%% OTP-5327. Adopted from emulator/test/bs_match_bin_SUITE.erl.</i>
<a name="bs_match_bin_SUITE-1"/><a name="1409"/> 1409: <b>bs_match_bin_SUITE</b>(Config) when is_list(Config) -&gt;
<a name="1410"/> 1410:     ByteSplitBinary =
<a name="1411"/> 1411:         &lt;&lt;&quot;ByteSplit =
<a name="1412"/> 1412:              fun(L, B, Pos, Fun) when Pos &gt;= 0 -&gt;
<a name="1413"/> 1413:                      Sz1 = Pos,
<a name="1414"/> 1414:                      Sz2 = size(B) - Pos,
<a name="1415"/> 1415:                      &lt;&lt;B1:Sz1/binary,B2:Sz2/binary&gt;&gt; = B,
<a name="1416"/> 1416:                      B1 = list_to_binary(lists:sublist(L, 1, Pos)),
<a name="1417"/> 1417:                      B2 = list_to_binary(lists:nthtail(Pos, L)),
<a name="1418"/> 1418: 		     Fun(L, B, Pos-1, Fun);
<a name="1419"/> 1419: 		(L, B, _, _Fun) -&gt; ok
<a name="1420"/> 1420:              end,
<a name="1421"/> 1421: 	  Mkbin = fun(L) when list(L) -&gt; list_to_binary(L) end,
<a name="1422"/> 1422: 	  L = lists:seq(0, 57),
<a name="1423"/> 1423: 	  B = Mkbin(L),
<a name="1424"/> 1424: 	  ByteSplit(L, B, size(B), ByteSplit),
<a name="1425"/> 1425: 	  Id = fun(I) -&gt; I end,
<a name="1426"/> 1426: 	  MakeUnalignedSubBinary =
<a name="1427"/> 1427: 	  fun(Bin0) -&gt;
<a name="1428"/> 1428: 		  Bin1 = &lt;&lt;0:3,Bin0/binary,31:5&gt;&gt;,
<a name="1429"/> 1429: 		  Sz = size(Bin0),
<a name="1430"/> 1430: 		  &lt;&lt;0:3,Bin:Sz/binary,31:5&gt;&gt; = Id(Bin1),
<a name="1431"/> 1431: 		  Bin
<a name="1432"/> 1432: 	  end,
<a name="1433"/> 1433: 	  Unaligned = MakeUnalignedSubBinary(B),
<a name="1434"/> 1434: 	  ByteSplit(L, Unaligned, size(Unaligned), ByteSplit),
<a name="1435"/> 1435: 	  ok.
<a name="1436"/> 1436: &quot;&gt;&gt;,
<a name="1437"/> 1437:     [ok] = scan(ByteSplitBinary),
<a name="1438"/> 1438: ok = evaluate(ByteSplitBinary, []),
<a name="1439"/> 1439: BitSplitBinary =
<a name="1440"/> 1440: &lt;&lt;&quot;Mkbin = fun(L) when list(L) -&gt; list_to_binary(L) end,
<a name="1441"/> 1441: 
<a name="1442"/> 1442:            MakeInt =
<a name="1443"/> 1443:   fun(List, 0, Acc, _F) -&gt; Acc;
<a name="1444"/> 1444:      ([H|T], N, Acc, F) -&gt; F(T, N-1, Acc bsl 1 bor H, F)
<a name="1445"/> 1445:   end,
<a name="1446"/> 1446: 
<a name="1447"/> 1447:   MakeBinFromList =
<a name="1448"/> 1448:   fun(List, 0, _F) -&gt; Mkbin([]);
<a name="1449"/> 1449:      (List, N, F) -&gt;
<a name="1450"/> 1450: 	  list_to_binary([MakeInt(List, 8, 0, MakeInt),
<a name="1451"/> 1451: 			  F(lists:nthtail(8, List), N-8, F)])
<a name="1452"/> 1452:   end,
<a name="1453"/> 1453: 
<a name="1454"/> 1454:   BitSplitBinary3 =
<a name="1455"/> 1455:   fun(Action, Bin, List, Bef, Aft, F) when Bef =&lt; Aft -&gt;
<a name="1456"/> 1456: 	  Action(Bin, List, Bef, (Aft-Bef) div 8 * 8),
<a name="1457"/> 1457: 	  F(Action, Bin, List, Bef, Aft-8, F);
<a name="1458"/> 1458:      (_, _, _, _, _, _) -&gt; ok
<a name="1459"/> 1459:   end,
<a name="1460"/> 1460: 
<a name="1461"/> 1461:   BitSplitBinary2 =
<a name="1462"/> 1462:   fun(Action, Bin, [_|T]=List, Bef, F) -&gt;
<a name="1463"/> 1463: 	  BitSplitBinary3(Action, Bin, List, Bef, size(Bin)*8,
<a name="1464"/> 1464: 			  BitSplitBinary3),
<a name="1465"/> 1465: 	  F(Action, Bin, T, Bef+1, F);
<a name="1466"/> 1466:      (Action, Bin, [], Bef, F) -&gt; ok
<a name="1467"/> 1467:   end,
<a name="1468"/> 1468: 
<a name="1469"/> 1469:   BitsToList =
<a name="1470"/> 1470:   fun([H|T], 0, F) -&gt; F(T, 16#80, F);
<a name="1471"/> 1471:      ([H|_]=List, Mask, F) -&gt;
<a name="1472"/> 1472: 	  [case H band Mask of
<a name="1473"/> 1473: 	       0 -&gt; 0;
<a name="1474"/> 1474: 	       _ -&gt; 1
<a name="1475"/> 1475: 	   end | F(List, Mask bsr 1, F)];
<a name="1476"/> 1476:      ([], _, _F) -&gt; []
<a name="1477"/> 1477:   end,
<a name="1478"/> 1478: 
<a name="1479"/> 1479:   BitSplitBinary1 =
<a name="1480"/> 1480:   fun(Action, Bin) -&gt;
<a name="1481"/> 1481: 	  BitList = BitsToList(binary_to_list(Bin), 16#80,
<a name="1482"/> 1482: 			       BitsToList),
<a name="1483"/> 1483: 	  BitSplitBinary2(Action, Bin, BitList, 0, BitSplitBinary2)
<a name="1484"/> 1484:   end,
<a name="1485"/> 1485: 
<a name="1486"/> 1486:   Fun = fun(Bin, List, SkipBef, N) -&gt;
<a name="1487"/> 1487: 		SkipAft = 8*size(Bin) - N - SkipBef,
<a name="1488"/> 1488: 		&lt;&lt;I1:SkipBef,OutBin:N/binary-unit:1,I2:SkipAft&gt;&gt; = Bin,
<a name="1489"/> 1489: 		OutBin = MakeBinFromList(List, N, MakeBinFromList)
<a name="1490"/> 1490: 	end,
<a name="1491"/> 1491: 
<a name="1492"/> 1492:   BitSplitBinary1(Fun, erlang:md5(&lt;&lt;1,2,3&gt;&gt;)),
<a name="1493"/> 1493:   Id = fun(I) -&gt; I end,
<a name="1494"/> 1494:   MakeUnalignedSubBinary =
<a name="1495"/> 1495:   fun(Bin0) -&gt;
<a name="1496"/> 1496: 	  Bin1 = &lt;&lt;0:3,Bin0/binary,31:5&gt;&gt;,
<a name="1497"/> 1497: 	  Sz = size(Bin0),
<a name="1498"/> 1498: 	  &lt;&lt;0:3,Bin:Sz/binary,31:5&gt;&gt; = Id(Bin1),
<a name="1499"/> 1499: 	  Bin
<a name="1500"/> 1500:   end,
<a name="1501"/> 1501:   BitSplitBinary1(Fun, MakeUnalignedSubBinary(erlang:md5(&lt;&lt;1,2,3&gt;&gt;))),
<a name="1502"/> 1502:   ok.
<a name="1503"/> 1503: &quot;&gt;&gt;,
<a name="1504"/> 1504:     [ok] = scan(BitSplitBinary),
<a name="bs_match_bin_SUITE-last_expr"/><a name="1505"/> 1505: <b>ok = evaluate</b>(BitSplitBinary, []).
<a name="1506"/> 1506: 
<a name="1507"/> 1507: <b>-define</b>(FAIL(Expr), &quot;{'EXIT',{badarg,_}} = (catch &quot; ??Expr &quot;)&quot;).
<a name="1508"/> 1508: 
<a name="1509"/> 1509: <b>-define</b>(COF(Int0),
<a name="1510"/> 1510:         &quot;(fun(Int) -&gt;
<a name="1511"/> 1511:                        true = &lt;&lt;Int:32/float&gt;&gt; =:= &lt;&lt;(float(Int)):32/float&gt;&gt;,
<a name="1512"/> 1512: 	true = &lt;&lt;Int:64/float&gt;&gt; =:= &lt;&lt;(float(Int)):64/float&gt;&gt;
<a name="1513"/> 1513: 	    end)(Nonliteral(&quot; ??Int0 &quot;)),
<a name="1514"/> 1514: true = &lt;&lt;&quot; ??Int0 &quot;:32/float&gt;&gt; =:= &lt;&lt;(float(&quot;??Int0&quot;)):32/float&gt;&gt;,
<a name="1515"/> 1515: true = &lt;&lt;&quot; ??Int0 &quot;:64/float&gt;&gt; =:= &lt;&lt;(float(&quot;??Int0&quot;)):64/float&gt;&gt;&quot;).
<a name="1516"/> 1516: 
<a name="1517"/> 1517: <b>-define</b>(COF64(Int0),
<a name="1518"/> 1518:         &quot;(fun(Int) -&gt;
<a name="1519"/> 1519:                        true = &lt;&lt;Int:64/float&gt;&gt; =:= &lt;&lt;(float(Int)):64/float&gt;&gt;
<a name="1520"/> 1520: 	    end)(Nonliteral(&quot; ??Int0 &quot;)),
<a name="1521"/> 1521: true = &lt;&lt;&quot; ??Int0 &quot;:64/float&gt;&gt; =:= &lt;&lt;(float(&quot;??Int0&quot;)):64/float&gt;&gt;&quot;).
<a name="1522"/> 1522: 
<a name="1523"/> 1523: <i>%% OTP-5327. Adopted from parts of emulator/test/bs_construct_SUITE.erl.</i>
<a name="bs_construct_SUITE-1"/><a name="1524"/> 1524: <b>bs_construct_SUITE</b>(Config) when is_list(Config) -&gt;
<a name="1525"/> 1525:     C1 = &lt;&lt;&quot;
<a name="1526"/> 1526: 
<a name="1527"/> 1527:        Testf_1 = fun(W, B) -&gt; &quot;
<a name="1528"/> 1528:             ?FAIL(&lt;&lt;42:W&gt;&gt;) &quot;,&quot;
<a name="1529"/> 1529: 				  ?FAIL(&lt;&lt;3.14:W/float&gt;&gt;) &quot;,&quot;
<a name="1530"/> 1530: 				  ?FAIL(&lt;&lt;B:W/binary&gt;&gt;) &quot;
<a name="1531"/> 1531:        end,
<a name="1532"/> 1532: 
<a name="1533"/> 1533: 	   TestF = fun() -&gt; &quot;
<a name="1534"/> 1534:             ?FAIL(&lt;&lt;3.14&gt;&gt;) &quot;,&quot;
<a name="1535"/> 1535: 				?FAIL(&lt;&lt;&lt;&lt;1,2&gt;&gt;&gt;&gt;) &quot;,&quot;
<a name="1536"/> 1536: 
<a name="1537"/> 1537: 				?FAIL(&lt;&lt;2.71/binary&gt;&gt;) &quot;,&quot;
<a name="1538"/> 1538: 				?FAIL(&lt;&lt;24334/binary&gt;&gt;) &quot;,&quot;
<a name="1539"/> 1539: 				?FAIL(&lt;&lt;24334344294788947129487129487219847/binary&gt;&gt;) &quot;,&quot;
<a name="1540"/> 1540: 
<a name="1541"/> 1541: 				?FAIL(&lt;&lt;&lt;&lt;1,2,3&gt;&gt;/float&gt;&gt;) &quot;,
<a name="1542"/> 1542: 
<a name="1543"/> 1543:             %% Negative field widths.
<a name="1544"/> 1544:             Testf_1(-8, &lt;&lt;1,2,3,4,5&gt;&gt;),&quot;
<a name="1545"/> 1545: 
<a name="1546"/> 1546:             ?FAIL(&lt;&lt;42:(-16)&gt;&gt;) &quot;,&quot;
<a name="1547"/> 1547: 				?FAIL(&lt;&lt;3.14:(-8)/float&gt;&gt;) &quot;,&quot;
<a name="1548"/> 1548: 				?FAIL(&lt;&lt;&lt;&lt;23,56,0,2&gt;&gt;:(-16)/binary&gt;&gt;) &quot;,&quot;
<a name="1549"/> 1549: 				?FAIL(&lt;&lt;&lt;&lt;23,56,0,2&gt;&gt;:(2.5)/binary&gt;&gt;) &quot;,&quot;
<a name="1550"/> 1550: 				?FAIL(&lt;&lt;&lt;&lt;23,56,0,2&gt;&gt;:(anka)&gt;&gt;) &quot;
<a name="1551"/> 1551:        end,
<a name="1552"/> 1552: 	   TestF(),
<a name="1553"/> 1553: 
<a name="1554"/> 1554: 	   NotUsed1 = fun(I, BinString) -&gt; &lt;&lt;I:32,BinString/binary&gt;&gt;, ok end,
<a name="1555"/> 1555: 
<a name="1556"/> 1556: 	   NotUsed2 = fun(I, Sz) -&gt; &lt;&lt;I:Sz&gt;&gt;, ok end,
<a name="1557"/> 1557: 
<a name="1558"/> 1558: 	   NotUsed3 = fun(I) -&gt;&lt;&lt;I:(-8)&gt;&gt;, ok end,
<a name="1559"/> 1559: 
<a name="1560"/> 1560: 	   NotUsed = fun() -&gt;
<a name="1561"/> 1561: 			     ok = NotUsed1(3, &lt;&lt;\&quot;dum\&quot;&gt;&gt;),
<a name="1562"/> 1562:             {'EXIT',{badarg,_}} = (catch NotUsed1(3, \&quot;dum\&quot;)), &quot;
<a name="1563"/> 1563: 						  ?FAIL(NotUsed2(444, -2)) &quot;,&quot;
<a name="1564"/> 1564: 						  ?FAIL(NotUsed2(444, anka)) &quot;,&quot;
<a name="1565"/> 1565: 						  ?FAIL(NotUsed3(444)) &quot;
<a name="1566"/> 1566:        end,
<a name="1567"/> 1567: 						  NotUsed(),
<a name="1568"/> 1568: 
<a name="1569"/> 1569: 						  InGuard3 = fun(Bin, A, B) when &lt;&lt;A:13,B:3&gt;&gt; == Bin -&gt; 1;
<a name="1570"/> 1570: 								(Bin, A, B) when &lt;&lt;A:16,B/binary&gt;&gt; == Bin -&gt; 2;
<a name="1571"/> 1571: 								(Bin, A, B) when &lt;&lt;A:14,B/float,3:2&gt;&gt; == Bin -&gt; 3;
<a name="1572"/> 1572: 								(Bin, A, B) when {a,b,&lt;&lt;A:14,B/float,3:2&gt;&gt;} == Bin -&gt;
<a name="1573"/> 1573: 								     cant_happen;
<a name="1574"/> 1574: 								(_, _, _) -&gt; nope
<a name="1575"/> 1575: 							     end,
<a name="1576"/> 1576: 
<a name="1577"/> 1577: 						  InGuard = fun() -&gt;
<a name="1578"/> 1578: 								    1 = InGuard3(&lt;&lt;16#74ad:16&gt;&gt;, 16#e95, 5),
<a name="1579"/> 1579: 								    2 = InGuard3(&lt;&lt;16#3A,16#F7,\&quot;hello\&quot;&gt;&gt;, 16#3AF7, &lt;&lt;\&quot;hello\&quot;&gt;&gt;),
<a name="1580"/> 1580:             3 = InGuard3(&lt;&lt;16#FBCD:14,3.1415/float,3:2&gt;&gt;, 16#FBCD, 3.1415),
<a name="1581"/> 1581: 										   nope = InGuard3(&lt;&lt;1&gt;&gt;, 42, b),
<a name="1582"/> 1582: 										   nope = InGuard3(&lt;&lt;1&gt;&gt;, a, b),
<a name="1583"/> 1583: 										   nope = InGuard3(&lt;&lt;1,2&gt;&gt;, 1, 1),
<a name="1584"/> 1584: 										   nope = InGuard3(&lt;&lt;4,5&gt;&gt;, 1, 2.71),
<a name="1585"/> 1585: 										   nope = InGuard3(&lt;&lt;4,5&gt;&gt;, 1, &lt;&lt;12,13&gt;&gt;)
<a name="1586"/> 1586: 										   end,
<a name="1587"/> 1587: 										   InGuard(),
<a name="1588"/> 1588: 
<a name="1589"/> 1589: 										   Nonliteral = fun(X) -&gt; X end,
<a name="1590"/> 1590: 
<a name="1591"/> 1591: 										   CoerceToFloat = fun() -&gt; &quot;
<a name="1592"/> 1592:            ?COF(0) &quot;,&quot;
<a name="1593"/> 1593: 														?COF(-1) &quot;,&quot;
<a name="1594"/> 1594: 														?COF(1) &quot;,&quot;
<a name="1595"/> 1595: 														?COF(42) &quot;,&quot;
<a name="1596"/> 1596: 														?COF(255) &quot;,&quot;
<a name="1597"/> 1597: 														?COF(-255) &quot;,&quot;
<a name="1598"/> 1598: 														?COF64(298748888888888888888888888883478264866528467367364766666666666666663) &quot;,&quot;
<a name="1599"/> 1599: 														?COF64(-367546729879999999999947826486652846736736476555566666663) &quot;
<a name="1600"/> 1600:        end,
<a name="1601"/> 1601: 										   CoerceToFloat(),
<a name="1602"/> 1602: 										   ok.
<a name="1603"/> 1603: &quot;&gt;&gt;,
<a name="1604"/> 1604:     [ok] = scan(C1),
<a name="1605"/> 1605: ok = evaluate(C1, []),
<a name="1606"/> 1606: 
<a name="1607"/> 1607: <i>%% There is another one, lib/compiler/test/bs_construct_SUITE.erl...</i>
<a name="1608"/> 1608: C2 = &lt;&lt;&quot;
<a name="1609"/> 1609:        I = fun(X) -&gt; X end,
<a name="1610"/> 1610: 
<a name="1611"/> 1611:        Fail = fun() -&gt;
<a name="1612"/> 1612: 
<a name="1613"/> 1613: 		      I_minus_777 = I(-777),
<a name="1614"/> 1614: 		      I_minus_2047 = I(-2047),
<a name="1615"/> 1615: 
<a name="1616"/> 1616:          %% One negative field size, but the sum of field sizes will be 1 byte.
<a name="1617"/> 1617:          %% Make sure that we reject that properly.
<a name="1618"/> 1618: 
<a name="1619"/> 1619: 		      {'EXIT',{badarg,_}} = (catch &lt;&lt;I_minus_777:2048/unit:8,
<a name="1620"/> 1620: 						     57:I_minus_2047/unit:8&gt;&gt;),
<a name="1621"/> 1621: 
<a name="1622"/> 1622:          %% Same thing, but use literals.
<a name="1623"/> 1623: 		      {'EXIT',{badarg,_}} = (catch &lt;&lt;I_minus_777:2048/unit:8,
<a name="1624"/> 1624: 						     57:(-2047)/unit:8&gt;&gt;),
<a name="1625"/> 1625: 
<a name="1626"/> 1626:          %% Bad alignment.
<a name="1627"/> 1627: 		      I_one = I(1),
<a name="1628"/> 1628: 		      &lt;&lt;1:1&gt;&gt; = &lt;&lt;2375:I_one&gt;&gt;,
<a name="1629"/> 1629: 		      &lt;&lt;3:2&gt;&gt; = &lt;&lt;45:1,2375:I_one&gt;&gt;,
<a name="1630"/> 1630: 		      &lt;&lt;14:4&gt;&gt; = &lt;&lt;45:1,2375:I_one,918:2&gt;&gt;,
<a name="1631"/> 1631: 		      &lt;&lt;118:7&gt;&gt; = &lt;&lt;45:1,2375:I_one,918:5&gt;&gt;,
<a name="1632"/> 1632: 
<a name="1633"/> 1633:          %% Not numbers.
<a name="1634"/> 1634: 		      {'EXIT',{badarg,_}} = (catch &lt;&lt;45:(I(not_a_number))&gt;&gt;),
<a name="1635"/> 1635: 		      {'EXIT',{badarg,_}} = (catch &lt;&lt;13:8,45:(I(not_a_number))&gt;&gt;),
<a name="1636"/> 1636: 
<a name="1637"/> 1637:          %% Unaligned sizes.
<a name="1638"/> 1638: 		      BadSz = I(7),
<a name="1639"/> 1639: 		      &lt;&lt;2:4&gt;&gt; = &lt;&lt;34:4&gt;&gt;,
<a name="1640"/> 1640: 		      &lt;&lt;34:7&gt;&gt; = &lt;&lt;34:BadSz&gt;&gt;,
<a name="1641"/> 1641: 
<a name="1642"/> 1642: 		      [] = [X || {X} &lt;- [], X == &lt;&lt;3:BadSz&gt;&gt;],
<a name="1643"/> 1643: 		      [] = [X || {X} &lt;- [], X == &lt;&lt;3:4&gt;&gt;]
<a name="1644"/> 1644: 	      end,
<a name="1645"/> 1645:        Fail(),
<a name="1646"/> 1646: 
<a name="1647"/> 1647:        FloatBin1 = fun(F) -&gt;
<a name="1648"/> 1648: 			   {&lt;&lt;1,2,3&gt;&gt;,F+3.0}
<a name="1649"/> 1649: 		   end,
<a name="1650"/> 1650: 
<a name="1651"/> 1651:        FloatBin = fun() -&gt;
<a name="1652"/> 1652:            %% Some more coverage.
<a name="1653"/> 1653: 			  {&lt;&lt;1,2,3&gt;&gt;,7.0} = FloatBin1(4)
<a name="1654"/> 1654: 		  end,
<a name="1655"/> 1655:        FloatBin(),
<a name="1656"/> 1656: 
<a name="1657"/> 1657:        ok.
<a name="1658"/> 1658: &quot;&gt;&gt;,
<a name="1659"/> 1659:     [ok] = scan(C2),
<a name="bs_construct_SUITE-last_expr"/><a name="1660"/> 1660: <b>ok = evaluate</b>(C2, []).
<a name="1661"/> 1661: 
<a name="evaluate-2"/><a name="1662"/> 1662: <b>evaluate</b>(B, Vars) when is_binary(B) -&gt;
<a name="1663"/> 1663:     evaluate(binary_to_list(B), Vars);
<a name="1664"/> 1664: <b>evaluate</b>(Str, Vars) -&gt;
<a name="1665"/> 1665:     {ok,Tokens,_} =
<a name="1666"/> 1666: 	erl_scan:string(Str),
<a name="1667"/> 1667:     {ok, Exprs} = erl_parse:parse_exprs(Tokens),
<a name="evaluate-last_expr"/><a name="1668"/> 1668: <b>    case erl_eval:exprs</b>(Exprs, Vars, none) of
<a name="1669"/> 1669: 	{value, Result, _} -&gt;
<a name="1670"/> 1670: 	    Result
<a name="1671"/> 1671:     end.
<a name="1672"/> 1672: 
<a name="1673"/> 1673: 
<a name="1674"/> 1674: <i>%% Bit syntax examples from the Reference Manual. OTP-5237.</i>
<a name="refman_bit_syntax-1"/><a name="1675"/> 1675: <b>refman_bit_syntax</b>(Config) when is_list(Config) -&gt;
<a name="1676"/> 1676:     %% Reference Manual &quot;Bit Syntax Expressions&quot;
<a name="1677"/> 1677:     Bin1 = &lt;&lt;1,17,42&gt;&gt;,
<a name="1678"/> 1678:     true = [1,17,42] =:= binary_to_list(Bin1),
<a name="1679"/> 1679:     Bin2 = &lt;&lt;&quot;abc&quot;&gt;&gt;,
<a name="1680"/> 1680:     true = &quot;abc&quot; =:= binary_to_list(Bin2),
<a name="1681"/> 1681:     Bin3 = &lt;&lt;1,17,42:16&gt;&gt;,
<a name="1682"/> 1682:     true = [1,17,0,42] =:= binary_to_list(Bin3),
<a name="1683"/> 1683:     &lt;&lt;_A,_B,C:16&gt;&gt; = &lt;&lt;1,17,42:16&gt;&gt;,
<a name="1684"/> 1684:     true = C =:= 42,
<a name="1685"/> 1685:     &lt;&lt;D:16,_E,F&gt;&gt; = &lt;&lt;1,17,42:16&gt;&gt;,
<a name="1686"/> 1686:     true = D =:= 273,
<a name="1687"/> 1687:     true = F =:= 42,
<a name="1688"/> 1688:     &lt;&lt;_G,H/binary&gt;&gt; = &lt;&lt;1,17,42:16&gt;&gt;,
<a name="1689"/> 1689:     true = H =:= &lt;&lt;17,0,42&gt;&gt;,
<a name="1690"/> 1690: 
<a name="1691"/> 1691:     [ok] =
<a name="1692"/> 1692:         scan(&lt;&lt;&quot;Bin1 = &lt;&lt;1,17,42&gt;&gt;,
<a name="1693"/> 1693:                          true = [1,17,42] =:= binary_to_list(Bin1),
<a name="1694"/> 1694: 	       Bin2 = &lt;&lt;\&quot;abc\&quot;&gt;&gt;,
<a name="1695"/> 1695:                          true = \&quot;abc\&quot; =:= binary_to_list(Bin2),
<a name="1696"/> 1696:                          Bin3 = &lt;&lt;1,17,42:16&gt;&gt;,
<a name="1697"/> 1697: 			true =
<a name="1698"/> 1698: 			[1,17,0,42] =:= binary_to_list(Bin3),
<a name="1699"/> 1699: 			&lt;&lt;A,B,C:16&gt;&gt; = &lt;&lt;1,17,42:16&gt;&gt;,
<a name="1700"/> 1700: 			true = C =:= 42,
<a name="1701"/> 1701: 			&lt;&lt;D:16,E,F&gt;&gt; = &lt;&lt;1,17,42:16&gt;&gt;,
<a name="1702"/> 1702: 			true = D =:= 273,
<a name="1703"/> 1703: 			true = F =:= 42,
<a name="1704"/> 1704: 			&lt;&lt;G,H/binary&gt;&gt; = &lt;&lt;1,17,42:16&gt;&gt;,
<a name="1705"/> 1705: 			true = H =:= &lt;&lt;17,0,42&gt;&gt;,
<a name="1706"/> 1706: 			ok.&quot;&gt;&gt;),
<a name="1707"/> 1707: 
<a name="1708"/> 1708:     %% Binary comprehensions.
<a name="1709"/> 1709:     &lt;&lt;2,4,6&gt;&gt; =  &lt;&lt; &lt;&lt; (X*2) &gt;&gt; || &lt;&lt;X&gt;&gt; &lt;= &lt;&lt; 1,2,3 &gt;&gt; &gt;&gt;,
<a name="refman_bit_syntax-last_expr"/><a name="1710"/> 1710: 			ok.
<a name="1711"/> 1711: 
<a name="1712"/> 1712: 
<a name="1713"/> 1713: <b>-define</b>(IP_VERSION, 4).
<a name="1714"/> 1714: <b>-define</b>(IP_MIN_HDR_LEN, 5).
<a name="1715"/> 1715: 
<a name="1716"/> 1716: <i>%% Bit syntax examples from Programming Examples. OTP-5237.</i>
<a name="progex_bit_syntax-1"/><a name="1717"/> 1717: <b>progex_bit_syntax</b>(Config) when is_list(Config) -&gt;
<a name="1718"/> 1718:     Bin11 = &lt;&lt;1, 17, 42&gt;&gt;,
<a name="1719"/> 1719:     true = [1, 17, 42] =:= binary_to_list(Bin11),
<a name="1720"/> 1720:     Bin12 = &lt;&lt;&quot;abc&quot;&gt;&gt;,
<a name="1721"/> 1721:     true = [97, 98, 99] =:= binary_to_list(Bin12),
<a name="1722"/> 1722: 
<a name="1723"/> 1723:     A = 1, B = 17, C = 42,
<a name="1724"/> 1724:     Bin2 = &lt;&lt;A, B, C:16&gt;&gt;,
<a name="1725"/> 1725:     true = [1, 17, 00, 42] =:= binary_to_list(Bin2),
<a name="1726"/> 1726:     &lt;&lt;D:16, E, F/binary&gt;&gt; = Bin2,
<a name="1727"/> 1727:     true = D =:= 273,
<a name="1728"/> 1728:     true = E =:= 00,
<a name="1729"/> 1729:     true = [42] =:= binary_to_list(F),
<a name="1730"/> 1730: 
<a name="1731"/> 1731:     Fun4 = fun(Dgram) -&gt;
<a name="1732"/> 1732:                    DgramSize = byte_size(Dgram),
<a name="1733"/> 1733:                    case Dgram of
<a name="1734"/> 1734:                        &lt;&lt;?IP_VERSION:4, HLen:4, SrvcType:8, TotLen:16,
<a name="1735"/> 1735: 			 ID:16, Flgs:3, FragOff:13,
<a name="1736"/> 1736: 			 TTL:8, Proto:8, HdrChkSum:16,
<a name="1737"/> 1737: 			 SrcIP:32, DestIP:32,
<a name="1738"/> 1738: 			 RestDgram/binary&gt;&gt; when HLen&gt;=5, 4*HLen=&lt;DgramSize -&gt;
<a name="1739"/> 1739:                            OptsLen = 4*(HLen - ?IP_MIN_HDR_LEN),
<a name="1740"/> 1740:                            &lt;&lt;Opts:OptsLen/binary,Data/binary&gt;&gt; = RestDgram,
<a name="1741"/> 1741:                            {SrvcType, TotLen, Flgs, FragOff, ID, HdrChkSum,
<a name="1742"/> 1742:                             Proto, TTL, SrcIP, DestIP, Data, Opts};
<a name="1743"/> 1743:                        _ -&gt;
<a name="1744"/> 1744:                            not_ok
<a name="1745"/> 1745:                    end
<a name="1746"/> 1746:            end,
<a name="1747"/> 1747:     true = Fun4(&lt;&lt;&gt;&gt;) =:= not_ok,
<a name="1748"/> 1748:     true = is_tuple(Fun4(list_to_binary([&lt;&lt;?IP_VERSION:4,5:4&gt;&gt;,
<a name="1749"/> 1749:                                          list_to_binary(lists:seq(1,255))]))),
<a name="1750"/> 1750: 
<a name="1751"/> 1751:     X = 23432324, Y = 24324234,
<a name="1752"/> 1752:     &lt;&lt;10:7&gt;&gt; = &lt;&lt;X:1, Y:6&gt;&gt;,
<a name="1753"/> 1753:     Z = 234324324,
<a name="1754"/> 1754:     XYZ = &lt;&lt;X:1, Y:6, Z:1&gt;&gt;,
<a name="1755"/> 1755:     true = [20] =:= binary_to_list(XYZ),
<a name="1756"/> 1756:     Hello1 = &lt;&lt;&quot;hello&quot;&gt;&gt;,
<a name="1757"/> 1757:     Hello2 = &lt;&lt;$h,$e,$l,$l,$o&gt;&gt;,
<a name="1758"/> 1758:     true = &quot;hello&quot; =:= binary_to_list(Hello1),
<a name="1759"/> 1759:     true = &quot;hello&quot; =:= binary_to_list(Hello2),
<a name="1760"/> 1760: 
<a name="1761"/> 1761:     FunM1 = fun(&lt;&lt;X1:7/binary, Y1:1/binary&gt;&gt;) -&gt; {X1,Y1} end,
<a name="1762"/> 1762:     true = {&lt;&lt;&quot;1234567&quot;&gt;&gt;,&lt;&lt;&quot;8&quot;&gt;&gt;} =:= FunM1(&lt;&lt;&quot;12345678&quot;&gt;&gt;),
<a name="1763"/> 1763: 
<a name="1764"/> 1764:     FunM2 = fun(&lt;&lt;_X1:7/binary-unit:7, _Y1:1/binary-unit:1&gt;&gt;) -&gt; ok;
<a name="1765"/> 1765:                (_) -&gt; not_ok end,
<a name="1766"/> 1766:     true = not_ok =:= FunM2(&lt;&lt;&quot;1&quot;&gt;&gt;),
<a name="1767"/> 1767: 
<a name="1768"/> 1768:     BL = [{3,4,5},{6,7,8}],
<a name="1769"/> 1769:     Lst = [0,0,0,3,0,0,0,4,0,0,0,5,0,0,0,6,0,0,0,7,0,0,0,8],
<a name="1770"/> 1770:     B1 = triples_to_bin1(BL),
<a name="1771"/> 1771:     true = Lst =:= binary_to_list(B1),
<a name="1772"/> 1772:     B2 = triples_to_bin2(BL),
<a name="1773"/> 1773:     true = Lst =:= binary_to_list(B2),
<a name="1774"/> 1774: 
<a name="1775"/> 1775:     [ok] = scan(
<a name="1776"/> 1776: 	     &lt;&lt;&quot;Bin11 = &lt;&lt;1, 17, 42&gt;&gt;,
<a name="1777"/> 1777:         true = [1, 17, 42] =:= binary_to_list(Bin11),
<a name="1778"/> 1778: 	       Bin12 = &lt;&lt;\&quot;abc\&quot;&gt;&gt;,
<a name="1779"/> 1779:         true = [97, 98, 99] =:= binary_to_list(Bin12),
<a name="1780"/> 1780: 
<a name="1781"/> 1781: 			 A = 1, B = 17, C = 42,
<a name="1782"/> 1782: 			 Bin2 = &lt;&lt;A, B, C:16&gt;&gt;,
<a name="1783"/> 1783: 			 true = [1, 17, 00, 42] =:= binary_to_list(Bin2),
<a name="1784"/> 1784: 			 &lt;&lt;D:16, E, F/binary&gt;&gt; = Bin2,
<a name="1785"/> 1785: 			 true = D =:= 273,
<a name="1786"/> 1786: 			 true = E =:= 00,
<a name="1787"/> 1787: 			 true = [42] =:= binary_to_list(F),
<a name="1788"/> 1788: 
<a name="1789"/> 1789: 			 Fun4 = fun(Dgram) -&gt;
<a name="1790"/> 1790: 					DgramSize = byte_size(Dgram),
<a name="1791"/> 1791: 					case Dgram of
<a name="1792"/> 1792: 					    &lt;&lt;4:4, HLen:4, SrvcType:8, TotLen:16,
<a name="1793"/> 1793: 					      ID:16, Flgs:3, FragOff:13,
<a name="1794"/> 1794: 					      TTL:8, Proto:8, HdrChkSum:16,
<a name="1795"/> 1795: 					      SrcIP:32, DestIP:32,
<a name="1796"/> 1796: 					      RestDgram/binary&gt;&gt; when HLen&gt;=5,
<a name="1797"/> 1797: 								      4*HLen=&lt;DgramSize -&gt;
<a name="1798"/> 1798: 						OptsLen = 4*(HLen - 5),
<a name="1799"/> 1799: 						&lt;&lt;Opts:OptsLen/binary,Data/binary&gt;&gt; = RestDgram,
<a name="1800"/> 1800: 						{SrvcType, TotLen, Flgs, FragOff, ID, HdrChkSum,
<a name="1801"/> 1801: 						 Proto, TTL, SrcIP, DestIP, Data, Opts};
<a name="1802"/> 1802: 					    _ -&gt;
<a name="1803"/> 1803: 						not_ok
<a name="1804"/> 1804: 					end
<a name="1805"/> 1805: 				end,
<a name="1806"/> 1806: 			 true = Fun4(&lt;&lt;&gt;&gt;) =:= not_ok,
<a name="1807"/> 1807: 			 true = is_tuple(Fun4(list_to_binary
<a name="1808"/> 1808: 						([&lt;&lt;4:4,5:4&gt;&gt;,list_to_binary(lists:seq(1,255))]))),
<a name="1809"/> 1809: 
<a name="1810"/> 1810: 			 X = 23432324, Y = 24324234,
<a name="1811"/> 1811: 			 &lt;&lt;10:7&gt;&gt; = &lt;&lt;X:1, Y:6&gt;&gt;,
<a name="1812"/> 1812: 			 Z = 234324324,
<a name="1813"/> 1813: 			 XYZ = &lt;&lt;X:1, Y:6, Z:1&gt;&gt;,
<a name="1814"/> 1814: 			 true = [20] =:= binary_to_list(XYZ),
<a name="1815"/> 1815: 			 Hello1 = &lt;&lt;\&quot;hello\&quot;&gt;&gt;,
<a name="1816"/> 1816:         Hello2 = &lt;&lt;$h,$e,$l,$l,$o&gt;&gt;,
<a name="1817"/> 1817: 				    true = \&quot;hello\&quot; =:= binary_to_list(Hello1),
<a name="1818"/> 1818:         true = \&quot;hello\&quot; =:= binary_to_list(Hello2),
<a name="1819"/> 1819: 
<a name="1820"/> 1820:         FunM1 = fun(&lt;&lt;X1:7/binary, Y1:1/binary&gt;&gt;) -&gt; {X1,Y1} end,
<a name="1821"/> 1821: 				    true = {&lt;&lt;\&quot;1234567\&quot;&gt;&gt;,&lt;&lt;\&quot;8\&quot;&gt;&gt;} =:= FunM1(&lt;&lt;\&quot;12345678\&quot;&gt;&gt;),
<a name="1822"/> 1822: 
<a name="1823"/> 1823:         FunM2 = fun(&lt;&lt;_X1:7/binary-unit:7, _Y1:1/binary-unit:1&gt;&gt;) -&gt; ok;
<a name="1824"/> 1824:                    (_) -&gt; not_ok end,
<a name="1825"/> 1825: 					      true = not_ok =:= FunM2(&lt;&lt;\&quot;1\&quot;&gt;&gt;),
<a name="1826"/> 1826:         ok.&quot;&gt;&gt;),
<a name="1827"/> 1827: 
<a name="progex_bit_syntax-last_expr"/><a name="1828"/> 1828:     ok.
<a name="1829"/> 1829: 
<a name="triples_to_bin1-1"/><a name="1830"/> 1830: <b>triples_to_bin1</b>(T) -&gt;
<a name="triples_to_bin1-last_expr"/><a name="1831"/> 1831: <b>    triples_to_bin1</b>(T, &lt;&lt;&gt;&gt;).
<a name="1832"/> 1832: 
<a name="triples_to_bin1-2"/><a name="1833"/> 1833: <b>triples_to_bin1</b>([{X,Y,Z} | T], Acc) -&gt;
<a name="1834"/> 1834:     triples_to_bin1(T, &lt;&lt;Acc/binary, X:32, Y:32, Z:32&gt;&gt;);   % inefficient
<a name="1835"/> 1835: <b>triples_to_bin1</b>([], Acc) -&gt;
<a name="triples_to_bin1-last_expr"/><a name="1836"/> 1836:     Acc.
<a name="1837"/> 1837: 
<a name="triples_to_bin2-1"/><a name="1838"/> 1838: <b>triples_to_bin2</b>(T) -&gt;
<a name="triples_to_bin2-last_expr"/><a name="1839"/> 1839: <b>    triples_to_bin2</b>(T, []).
<a name="1840"/> 1840: 
<a name="triples_to_bin2-2"/><a name="1841"/> 1841: <b>triples_to_bin2</b>([{X,Y,Z} | T], Acc) -&gt;
<a name="1842"/> 1842:     triples_to_bin2(T, [&lt;&lt;X:32, Y:32, Z:32&gt;&gt; | Acc]);
<a name="1843"/> 1843: <b>triples_to_bin2</b>([], Acc) -&gt;
<a name="triples_to_bin2-last_expr"/><a name="1844"/> 1844: <b>    list_to_binary</b>(lists:reverse(Acc)).
<a name="1845"/> 1845: 
<a name="1846"/> 1846: <i>%% Record examples from Programming Examples. OTP-5237.</i>
<a name="progex_records-1"/><a name="1847"/> 1847: <b>progex_records</b>(Config) when is_list(Config) -&gt;
<a name="1848"/> 1848:     Test1 =
<a name="1849"/> 1849: 	&lt;&lt;&quot;-module(recs).
<a name="1850"/> 1850:           -record(person, {name = \&quot;\&quot;, phone = [], address}).
<a name="1851"/> 1851:           -record(name, {first = \&quot;Robert\&quot;, last = \&quot;Ericsson\&quot;}).
<a name="1852"/> 1852:           -record(person2, {name = #name{}, phone}).
<a name="1853"/> 1853: <b>-export</b>([t/0]).
<a name="1854"/> 1854: 
<a name="1855"/> 1855: t() -&gt;
<a name="1856"/> 1856:     _P1 = #person{phone=[0,8,2,3,4,3,1,2], name=\&quot;Robert\&quot;},
<a name="1857"/> 1857:               \&quot;Robert\&quot; = _P1#person.name,
<a name="1858"/> 1858:               [0,8,2,3,4,3,1,2] = _P1#person.phone,
<a name="1859"/> 1859: 		  undefined = _P1#person.address,
<a name="1860"/> 1860: 
<a name="1861"/> 1861: 		  _P2 = #person{name = \&quot;Jakob\&quot;, _ = '_'},
<a name="1862"/> 1862:                \&quot;Jakob\&quot; = _P2#person.name,
<a name="1863"/> 1863:               '_' = _P2#person.phone,
<a name="1864"/> 1864: 				'_' = _P2#person.address,
<a name="1865"/> 1865: 
<a name="1866"/> 1866: 				P = #person{name = \&quot;Joe\&quot;, phone = [0,8,2,3,4,3,1,2]},
<a name="1867"/> 1867:               \&quot;Joe\&quot; = P#person.name,
<a name="1868"/> 1868:               [0,8,2,3,4,3,1,2] = P#person.phone,
<a name="1869"/> 1869: 					    undefined = P#person.address,
<a name="1870"/> 1870: 
<a name="1871"/> 1871: 					    P1 = #person{name=\&quot;Joe\&quot;, phone=[1,2,3], address=\&quot;A street\&quot;},
<a name="1872"/> 1872:               P2 = P1#person{name=\&quot;Robert\&quot;},
<a name="1873"/> 1873:               \&quot;Robert\&quot; = P2#person.name,
<a name="1874"/> 1874:               [1,2,3] = P2#person.phone,
<a name="1875"/> 1875: 			     \&quot;A street\&quot; = P2#person.address,
<a name="1876"/> 1876:               a_person = foo(P1),
<a name="1877"/> 1877: 
<a name="1878"/> 1878: 			     {found, [1,2,3]} =
<a name="1879"/> 1879: 				 find_phone([#person{name = a},
<a name="1880"/> 1880: 					     #person{name = b, phone = [3,2,1]},
<a name="1881"/> 1881: 					     #person{name = c, phone = [1,2,3]}],
<a name="1882"/> 1882: 					    c),
<a name="1883"/> 1883: 
<a name="1884"/> 1884: 			     P3 = #person{name=\&quot;Joe\&quot;, phone=[0,0,7], address=\&quot;A street\&quot;},
<a name="1885"/> 1885:               #person{name = Name} = P3,
<a name="1886"/> 1886: 					  \&quot;Joe\&quot; = Name,
<a name="1887"/> 1887: 
<a name="1888"/> 1888:               \&quot;Robert\&quot; = demo(),
<a name="1889"/> 1889:               ok.
<a name="1890"/> 1890: 
<a name="1891"/> 1891: foo(P) when is_record(P, person) -&gt; a_person;
<a name="1892"/> 1892: foo(_) -&gt; not_a_person.
<a name="1893"/> 1893: 
<a name="1894"/> 1894: find_phone([#person{name=Name, phone=Phone} | _], Name) -&gt;
<a name="1895"/> 1895:     {found,  Phone};
<a name="1896"/> 1896: find_phone([_| T], Name) -&gt;
<a name="1897"/> 1897:     find_phone(T, Name);
<a name="1898"/> 1898: find_phone([], _Name) -&gt;
<a name="1899"/> 1899:     not_found.
<a name="1900"/> 1900: 
<a name="1901"/> 1901: demo() -&gt;
<a name="1902"/> 1902:     P = #person2{name= #name{first=\&quot;Robert\&quot;,last=\&quot;Virding\&quot;},
<a name="1903"/> 1903:                                phone=123},
<a name="1904"/> 1904: 		 _First = (P#person2.name)#name.first.
<a name="1905"/> 1905: &quot;&gt;&gt;,
<a name="1906"/> 1906:     ok = run_file(Config, recs, Test1),
<a name="1907"/> 1907: 
<a name="1908"/> 1908: Test1_shell =
<a name="1909"/> 1909: &lt;&lt;&quot;rd(person, {name = \&quot;\&quot;, phone = [], address}),
<a name="1910"/> 1910:           rd(name, {first = \&quot;Robert\&quot;, last = \&quot;Ericsson\&quot;}),
<a name="1911"/> 1911:           rd(person2, {name = #name{}, phone}),
<a name="1912"/> 1912: 
<a name="1913"/> 1913: 		    _P1 = #person{phone=[0,8,2,3,4,3,1,2], name=\&quot;Robert\&quot;},
<a name="1914"/> 1914:           \&quot;Robert\&quot; = _P1#person.name,
<a name="1915"/> 1915:           [0,8,2,3,4,3,1,2] = _P1#person.phone,
<a name="1916"/> 1916: 				  undefined = _P1#person.address,
<a name="1917"/> 1917: 
<a name="1918"/> 1918: 				  _P2 = #person{name = \&quot;Jakob\&quot;, _ = '_'},
<a name="1919"/> 1919:            \&quot;Jakob\&quot; = _P2#person.name,
<a name="1920"/> 1920:           '_' = _P2#person.phone,
<a name="1921"/> 1921: 						'_' = _P2#person.address,
<a name="1922"/> 1922: 
<a name="1923"/> 1923: 						P = #person{name = \&quot;Joe\&quot;, phone = [0,8,2,3,4,3,1,2]},
<a name="1924"/> 1924:           \&quot;Joe\&quot; = P#person.name,
<a name="1925"/> 1925:           [0,8,2,3,4,3,1,2] = P#person.phone,
<a name="1926"/> 1926: 							    undefined = P#person.address,
<a name="1927"/> 1927: 
<a name="1928"/> 1928: 							    P1 = #person{name=\&quot;Joe\&quot;, phone=[1,2,3], address=\&quot;A street\&quot;},
<a name="1929"/> 1929:           P2 = P1#person{name=\&quot;Robert\&quot;},
<a name="1930"/> 1930:           \&quot;Robert\&quot; = P2#person.name,
<a name="1931"/> 1931:           [1,2,3] = P2#person.phone,
<a name="1932"/> 1932: 			 \&quot;A street\&quot; = P2#person.address,
<a name="1933"/> 1933:           Foo = fun(P) when is_record(P, person) -&gt; a_person;
<a name="1934"/> 1934:                    (_) -&gt; not_a_person
<a name="1935"/> 1935:                 end,
<a name="1936"/> 1936: 			 a_person = Foo(P1),
<a name="1937"/> 1937: 
<a name="1938"/> 1938: 			 Find = fun([#person{name=Name, phone=Phone} | _], Name, Fn) -&gt;
<a name="1939"/> 1939: 					{found,  Phone};
<a name="1940"/> 1940: 				   ([_| T], Name, Fn) -&gt;
<a name="1941"/> 1941: 					Fn(T, Name, Fn);
<a name="1942"/> 1942: 				   ([], _Name, _Fn) -&gt;
<a name="1943"/> 1943: 					not_found
<a name="1944"/> 1944: 				end,
<a name="1945"/> 1945: 
<a name="1946"/> 1946: 			 {found, [1,2,3]} = Find([#person{name = a},
<a name="1947"/> 1947: 						  #person{name = b, phone = [3,2,1]},
<a name="1948"/> 1948: 						  #person{name = c, phone = [1,2,3]}],
<a name="1949"/> 1949: 						 c,
<a name="1950"/> 1950: 						 Find),
<a name="1951"/> 1951: 
<a name="1952"/> 1952: 			 P3 = #person{name=\&quot;Joe\&quot;, phone=[0,0,7], address=\&quot;A street\&quot;},
<a name="1953"/> 1953:           #person{name = Name} = P3,
<a name="1954"/> 1954: 				      \&quot;Joe\&quot; = Name,
<a name="1955"/> 1955: 
<a name="1956"/> 1956:           Demo = fun() -&gt;
<a name="1957"/> 1957: 			 P17 = #person2{name= #name{first=\&quot;Robert\&quot;,last=\&quot;Virding\&quot;},
<a name="1958"/> 1958:                            phone=123},
<a name="1959"/> 1959: 					_First = (P17#person2.name)#name.first
<a name="1960"/> 1960: 					end,
<a name="1961"/> 1961: 
<a name="1962"/> 1962: 					\&quot;Robert\&quot; = Demo(),
<a name="1963"/> 1963:           ok.
<a name="1964"/> 1964: &quot;&gt;&gt;,
<a name="1965"/> 1965:     [ok] = scan(Test1_shell),
<a name="1966"/> 1966: 
<a name="1967"/> 1967: Test2 =
<a name="1968"/> 1968: &lt;&lt;&quot;-module(recs).
<a name="1969"/> 1969:           -record(person, {name, age, phone = [], dict = []}).
<a name="1970"/> 1970: <b>-export</b>([t/0]).
<a name="1971"/> 1971: 
<a name="1972"/> 1972: t() -&gt; ok.
<a name="1973"/> 1973: 
<a name="1974"/> 1974: make_hacker_without_phone(Name, Age) -&gt;
<a name="1975"/> 1975:     #person{name = Name, age = Age,
<a name="1976"/> 1976: 	    dict = [{computer_knowledge, excellent},
<a name="1977"/> 1977: 		    {drinks, coke}]}.
<a name="1978"/> 1978: print(#person{name = Name, age = Age,
<a name="1979"/> 1979: 	      phone = Phone, dict = Dict}) -&gt;
<a name="1980"/> 1980:     io:format(\&quot;Name: ~s, Age: ~w, Phone: ~w ~n\&quot;
<a name="1981"/> 1981:                         \&quot;Dictionary: ~w.~n\&quot;, [Name, Age, Phone, Dict]).
<a name="1982"/> 1982: 
<a name="1983"/> 1983:           birthday(P) when record(P, person) -&gt;
<a name="1984"/> 1984: 		     P#person{age = P#person.age + 1}.
<a name="1985"/> 1985: 
<a name="1986"/> 1986: register_two_hackers() -&gt;
<a name="1987"/> 1987:     Hacker1 = make_hacker_without_phone(\&quot;Joe\&quot;, 29),
<a name="1988"/> 1988:              OldHacker = birthday(Hacker1),
<a name="1989"/> 1989:              %% The central_register_server should have
<a name="1990"/> 1990:              %% an interface function for this.
<a name="1991"/> 1991: 					central_register_server ! {register_person, Hacker1},
<a name="1992"/> 1992: 					central_register_server ! {register_person,
<a name="1993"/> 1993: 								   OldHacker#person{name = \&quot;Robert\&quot;,
<a name="1994"/> 1994:                                         phone = [0,8,3,2,4,5,3,1]}}.
<a name="1995"/> 1995: &quot;&gt;&gt;,
<a name="1996"/> 1996:     ok = run_file(Config, recs, Test2),
<a name="progex_records-last_expr"/><a name="1997"/> 1997: ok.
<a name="1998"/> 1998: 
<a name="1999"/> 1999: <i>%% List comprehension examples from Programming Examples. OTP-5237.</i>
<a name="progex_lc-1"/><a name="2000"/> 2000: <b>progex_lc</b>(Config) when is_list(Config) -&gt;
<a name="2001"/> 2001:     Test1 =
<a name="2002"/> 2002: 	&lt;&lt;&quot;-module(lc).
<a name="2003"/> 2003:           -export([t/0]).
<a name="2004"/> 2004: 
<a name="2005"/> 2005: t() -&gt;
<a name="2006"/> 2006:     [a,4,b,5,6] = [X || X &lt;- [1,2,a,3,4,b,5,6], X &gt; 3],
<a name="2007"/> 2007:     [4,5,6] = [X || X &lt;- [1,2,a,3,4,b,5,6], integer(X), X &gt; 3],
<a name="2008"/> 2008:     [{1,a},{1,b},{2,a},{2,b},{3,a},{3,b}] =
<a name="2009"/> 2009: 	[{X, Y} || X &lt;- [1,2,3], Y &lt;- [a,b]],
<a name="2010"/> 2010: 
<a name="2011"/> 2011:     [1,2,3,4,5,6,7,8] = sort([4,5,1,8,3,6,7,2]),
<a name="2012"/> 2012:     [[b,u,g],[b,g,u],[u,b,g],[u,g,b],[g,b,u],[g,u,b]] =
<a name="2013"/> 2013: 	perms([b,u,g]),
<a name="2014"/> 2014:     [] = pyth(11),
<a name="2015"/> 2015:     [{3,4,5},{4,3,5}] = pyth(12),
<a name="2016"/> 2016:     [{3,4,5},{4,3,5},{5,12,13},{6,8,10},{8,6,10},{8,15,17},
<a name="2017"/> 2017:      {9,12,15},{12,5,13},{12,9,15},{12,16,20},{15,8,17},
<a name="2018"/> 2018:      {16,12,20}] = pyth(50),
<a name="2019"/> 2019:     [] = pyth1(11),
<a name="2020"/> 2020:     [{3,4,5},{4,3,5}] = pyth1(12),
<a name="2021"/> 2021:     [{3,4,5},{4,3,5},{5,12,13},{6,8,10},{8,6,10},{8,15,17},
<a name="2022"/> 2022:      {9,12,15},{12,5,13},{12,9,15},{12,16,20},{15,8,17},
<a name="2023"/> 2023:      {16,12,20}] = pyth1(50),
<a name="2024"/> 2024:     [1,2,3,4,5] = append([[1,2,3],[4,5]]),
<a name="2025"/> 2025:     [2,3,4] = map(fun(X) -&gt; X + 1 end, [1,2,3]),
<a name="2026"/> 2026:     [2,4] = filter(fun(X) -&gt; X &gt; 1 end, [0,2,4]),
<a name="2027"/> 2027:     [1,2,3,7] = select(b,[{a,1},{b,2},{c,3},{b,7}]),
<a name="2028"/> 2028:     [2,7] = select2(b,[{a,1},{b,2},{c,3},{b,7}]),
<a name="2029"/> 2029:     ok.
<a name="2030"/> 2030: 
<a name="2031"/> 2031: sort([Pivot|T]) -&gt;
<a name="2032"/> 2032:     sort([ X || X &lt;- T, X &lt; Pivot]) ++
<a name="2033"/> 2033: 	[Pivot] ++
<a name="2034"/> 2034: 	sort([ X || X &lt;- T, X &gt;= Pivot]);
<a name="2035"/> 2035: sort([]) -&gt; [].
<a name="2036"/> 2036: 
<a name="2037"/> 2037: perms([]) -&gt; [[]];
<a name="2038"/> 2038: perms(L)  -&gt; [[H|T] || H &lt;- L, T &lt;- perms(L--[H])].
<a name="2039"/> 2039: 
<a name="2040"/> 2040: pyth(N) -&gt;
<a name="2041"/> 2041:     [ {A,B,C} ||
<a name="2042"/> 2042: 	A &lt;- lists:seq(1,N),
<a name="2043"/> 2043: 	B &lt;- lists:seq(1,N),
<a name="2044"/> 2044: 	C &lt;- lists:seq(1,N),
<a name="2045"/> 2045: 	A+B+C =&lt; N,
<a name="2046"/> 2046: 	A*A+B*B == C*C
<a name="2047"/> 2047:     ].
<a name="2048"/> 2048: 
<a name="2049"/> 2049: pyth1(N) -&gt;
<a name="2050"/> 2050:     [{A,B,C} ||
<a name="2051"/> 2051: 	A &lt;- lists:seq(1,N),
<a name="2052"/> 2052: 	B &lt;- lists:seq(1,N-A+1),
<a name="2053"/> 2053: 	C &lt;- lists:seq(1,N-A-B+2),
<a name="2054"/> 2054: 	A+B+C =&lt; N,
<a name="2055"/> 2055: 	A*A+B*B == C*C ].
<a name="2056"/> 2056: 
<a name="2057"/> 2057: append(L)   -&gt;  [X || L1 &lt;- L, X &lt;- L1].
<a name="2058"/> 2058: map(Fun, L) -&gt; [Fun(X) || X &lt;- L].
<a name="2059"/> 2059: filter(Pred, L) -&gt; [X || X &lt;- L, Pred(X)].
<a name="2060"/> 2060: 
<a name="2061"/> 2061: select(X, L) -&gt;  [Y || {X, Y} &lt;- L].
<a name="2062"/> 2062: select2(X, L) -&gt;  [Y || {X1, Y} &lt;- L, X == X1].
<a name="2063"/> 2063: &quot;&gt;&gt;,
<a name="2064"/> 2064:     ok = run_file(Config, lc, Test1),
<a name="2065"/> 2065: 
<a name="2066"/> 2066: Test1_shell =
<a name="2067"/> 2067: &lt;&lt;&quot;[a,4,b,5,6] = [X || X &lt;- [1,2,a,3,4,b,5,6], X &gt; 3],
<a name="2068"/> 2068:           [4,5,6] = [X || X &lt;- [1,2,a,3,4,b,5,6], integer(X), X &gt; 3],
<a name="2069"/> 2069:   [{1,a},{1,b},{2,a},{2,b},{3,a},{3,b}] =
<a name="2070"/> 2070:   [{X, Y} || X &lt;- [1,2,3], Y &lt;- [a,b]],
<a name="2071"/> 2071: 
<a name="2072"/> 2072:   Sort = fun([Pivot|T], Fn) -&gt;
<a name="2073"/> 2073: 		 Fn([ X || X &lt;- T, X &lt; Pivot], Fn) ++
<a name="2074"/> 2074: 		     [Pivot] ++
<a name="2075"/> 2075: 		     Fn([ X || X &lt;- T, X &gt;= Pivot], Fn);
<a name="2076"/> 2076: 	    ([], _Fn) -&gt; []
<a name="2077"/> 2077: 	 end,
<a name="2078"/> 2078: 
<a name="2079"/> 2079:   [1,2,3,4,5,6,7,8] = Sort([4,5,1,8,3,6,7,2], Sort),
<a name="2080"/> 2080:   Perms = fun([], _Fn) -&gt; [[]];
<a name="2081"/> 2081: 	     (L, Fn)  -&gt; [[H|T] || H &lt;- L, T &lt;- Fn(L--[H], Fn)]
<a name="2082"/> 2082: 	  end,
<a name="2083"/> 2083:   [[b,u,g],[b,g,u],[u,b,g],[u,g,b],[g,b,u],[g,u,b]] =
<a name="2084"/> 2084:   Perms([b,u,g], Perms),
<a name="2085"/> 2085: 
<a name="2086"/> 2086:   Pyth = fun(N) -&gt;
<a name="2087"/> 2087: 		 [ {A,B,C} ||
<a name="2088"/> 2088: 		     A &lt;- lists:seq(1,N),
<a name="2089"/> 2089: 		     B &lt;- lists:seq(1,N),
<a name="2090"/> 2090: 		     C &lt;- lists:seq(1,N),
<a name="2091"/> 2091: 		     A+B+C =&lt; N,
<a name="2092"/> 2092: 		     A*A+B*B == C*C
<a name="2093"/> 2093: 		 ]
<a name="2094"/> 2094: 	 end,
<a name="2095"/> 2095: 
<a name="2096"/> 2096:   [] = Pyth(11),
<a name="2097"/> 2097:   [{3,4,5},{4,3,5}] = Pyth(12),
<a name="2098"/> 2098: <i>%%[{3,4,5},{4,3,5},{5,12,13},{6,8,10},{8,6,10},{8,15,17},</i>
<a name="2099"/> 2099: <i>%% {9,12,15},{12,5,13},{12,9,15},{12,16,20},{15,8,17},</i>
<a name="2100"/> 2100: <i>%% {16,12,20}] = Pyth(50),</i>
<a name="2101"/> 2101: 
<a name="2102"/> 2102:   Pyth1 = fun(N) -&gt;
<a name="2103"/> 2103: 		  [{A,B,C} ||
<a name="2104"/> 2104: 		      A &lt;- lists:seq(1,N),
<a name="2105"/> 2105: 		      B &lt;- lists:seq(1,N-A+1),
<a name="2106"/> 2106: 		      C &lt;- lists:seq(1,N-A-B+2),
<a name="2107"/> 2107: 		      A+B+C =&lt; N,
<a name="2108"/> 2108: 		      A*A+B*B == C*C ]
<a name="2109"/> 2109: 	  end,
<a name="2110"/> 2110: 
<a name="2111"/> 2111:   [] = Pyth1(11),
<a name="2112"/> 2112:   [{3,4,5},{4,3,5}] = Pyth1(12),
<a name="2113"/> 2113:   [{3,4,5},{4,3,5},{5,12,13},{6,8,10},{8,6,10},{8,15,17},
<a name="2114"/> 2114:    {9,12,15},{12,5,13},{12,9,15},{12,16,20},{15,8,17},
<a name="2115"/> 2115:    {16,12,20}] = Pyth1(50),
<a name="2116"/> 2116: 
<a name="2117"/> 2117:   Append = fun(L)   -&gt;  [X || L1 &lt;- L, X &lt;- L1] end,
<a name="2118"/> 2118:   [1,2,3,4,5] = Append([[1,2,3],[4,5]]),
<a name="2119"/> 2119:   Map = fun(Fun, L) -&gt; [Fun(X) || X &lt;- L] end,
<a name="2120"/> 2120:   [2,3,4] = Map(fun(X) -&gt; X + 1 end, [1,2,3]),
<a name="2121"/> 2121:   Filter = fun(Pred, L) -&gt; [X || X &lt;- L, Pred(X)] end,
<a name="2122"/> 2122:   [2,4] = Filter(fun(X) -&gt; X &gt; 1 end, [0,2,4]),
<a name="2123"/> 2123: 
<a name="2124"/> 2124:   Select = fun(X, L) -&gt;  [Y || {X, Y} &lt;- L] end,
<a name="2125"/> 2125:   [1,2,3,7] = Select(b,[{a,1},{b,2},{c,3},{b,7}]),
<a name="2126"/> 2126:   Select2 = fun(X, L) -&gt;  [Y || {X1, Y} &lt;- L, X == X1] end,
<a name="2127"/> 2127:   [2,7] = Select2(b,[{a,1},{b,2},{c,3},{b,7}]),
<a name="2128"/> 2128:   ok.
<a name="2129"/> 2129: &quot;&gt;&gt;,
<a name="2130"/> 2130:     [ok] = scan(Test1_shell),
<a name="progex_lc-last_expr"/><a name="2131"/> 2131: ok.
<a name="2132"/> 2132: 
<a name="2133"/> 2133: <i>%% Funs examples from Programming Examples. OTP-5237.</i>
<a name="progex_funs-1"/><a name="2134"/> 2134: <b>progex_funs</b>(Config) when is_list(Config) -&gt;
<a name="2135"/> 2135:     Test1 =
<a name="2136"/> 2136: 	&lt;&lt;&quot;-module(funs).
<a name="2137"/> 2137:           -export([t/0]).
<a name="2138"/> 2138: 
<a name="2139"/> 2139: double([H|T]) -&gt; [2*H|double(T)];
<a name="2140"/> 2140: double([])    -&gt; [].
<a name="2141"/> 2141: 
<a name="2142"/> 2142: add_one([H|T]) -&gt; [H+1|add_one(T)];
<a name="2143"/> 2143: add_one([])    -&gt; [].
<a name="2144"/> 2144: 
<a name="2145"/> 2145: map(F, [H|T]) -&gt; [F(H)|map(F, T)];
<a name="2146"/> 2146: map(F, [])    -&gt; [].
<a name="2147"/> 2147: 
<a name="2148"/> 2148: double2(L)  -&gt; map(fun(X) -&gt; 2*X end, L).
<a name="2149"/> 2149: add_one2(L) -&gt; map(fun(X) -&gt; 1 + X end, L).
<a name="2150"/> 2150: 
<a name="2151"/> 2151: print_list(Stream, [H|T]) -&gt;
<a name="2152"/> 2152:     io:format(Stream, \&quot;~p~n\&quot;, [H]),
<a name="2153"/> 2153:               print_list(Stream, T);
<a name="2154"/> 2154: 		  print_list(Stream, []) -&gt;
<a name="2155"/> 2155: 		     true.
<a name="2156"/> 2156: 
<a name="2157"/> 2157: broadcast(Msg, [Pid|Pids]) -&gt;
<a name="2158"/> 2158:     Pid ! Msg,
<a name="2159"/> 2159:     broadcast(Msg, Pids);
<a name="2160"/> 2160: broadcast(_, []) -&gt;
<a name="2161"/> 2161:     true.
<a name="2162"/> 2162: 
<a name="2163"/> 2163: foreach(F, [H|T]) -&gt;
<a name="2164"/> 2164:     F(H),
<a name="2165"/> 2165:     foreach(F, T);
<a name="2166"/> 2166: foreach(F, []) -&gt;
<a name="2167"/> 2167:     ok.
<a name="2168"/> 2168: 
<a name="2169"/> 2169: print_list2(S, L) -&gt;
<a name="2170"/> 2170:     foreach(fun(H) -&gt; io:format(S, \&quot;~p~n\&quot;,[H]) end, L).
<a name="2171"/> 2171: 
<a name="2172"/> 2172:           broadcast2(M, L) -&gt; foreach(fun(Pid) -&gt; Pid ! M end, L).
<a name="2173"/> 2173: 
<a name="2174"/> 2174: t1() -&gt; map(fun(X) -&gt; 2 * X end, [1,2,3,4,5]).
<a name="2175"/> 2175: 
<a name="2176"/> 2176: t2() -&gt; map(fun double/1, [1,2,3,4,5]).
<a name="2177"/> 2177: 
<a name="2178"/> 2178: t3() -&gt; map({?MODULE, double3}, [1,2,3,4,5]).
<a name="2179"/> 2179: 
<a name="2180"/> 2180: double3(X) -&gt; X * 2.
<a name="2181"/> 2181: 
<a name="2182"/> 2182: f(F, Args) when function(F) -&gt;
<a name="2183"/> 2183:     apply(F, Args);
<a name="2184"/> 2184: f(N, _) when integer(N) -&gt;
<a name="2185"/> 2185:     N.
<a name="2186"/> 2186: 
<a name="2187"/> 2187: print_list3(File, List) -&gt;
<a name="2188"/> 2188:     {ok, Stream} = file:open(File, write),
<a name="2189"/> 2189:     foreach(fun(X) -&gt; io:format(Stream,\&quot;~p~n\&quot;,[X]) end, List),
<a name="2190"/> 2190:               file:close(Stream).
<a name="2191"/> 2191: 
<a name="2192"/> 2192: print_list4(File, List) -&gt;
<a name="2193"/> 2193:     {ok, Stream} = file:open(File, write),
<a name="2194"/> 2194:     foreach(fun(File) -&gt;
<a name="2195"/> 2195: 		    io:format(Stream,\&quot;~p~n\&quot;,[File])
<a name="2196"/> 2196:                       end, List),
<a name="2197"/> 2197: 		    file:close(Stream).
<a name="2198"/> 2198: 
<a name="2199"/> 2199: any(Pred, [H|T]) -&gt;
<a name="2200"/> 2200:     case Pred(H) of
<a name="2201"/> 2201: 	true  -&gt;  true;
<a name="2202"/> 2202: 	false -&gt;  any(Pred, T)
<a name="2203"/> 2203:     end;
<a name="2204"/> 2204: any(Pred, []) -&gt;
<a name="2205"/> 2205:     false.
<a name="2206"/> 2206: 
<a name="2207"/> 2207: all(Pred, [H|T]) -&gt;
<a name="2208"/> 2208:     case Pred(H) of
<a name="2209"/> 2209: 	true  -&gt;  all(Pred, T);
<a name="2210"/> 2210: 	false -&gt;  false
<a name="2211"/> 2211:     end;
<a name="2212"/> 2212: all(Pred, []) -&gt;
<a name="2213"/> 2213:     true.
<a name="2214"/> 2214: 
<a name="2215"/> 2215: foldl(F, Accu, [Hd|Tail]) -&gt;
<a name="2216"/> 2216:     foldl(F, F(Hd, Accu), Tail);
<a name="2217"/> 2217: foldl(F, Accu, []) -&gt; Accu.
<a name="2218"/> 2218: 
<a name="2219"/> 2219: mapfoldl(F, Accu0, [Hd|Tail]) -&gt;
<a name="2220"/> 2220:     {R,Accu1} = F(Hd, Accu0),
<a name="2221"/> 2221:     {Rs,Accu2} = mapfoldl(F, Accu1, Tail),
<a name="2222"/> 2222:     {[R|Rs], Accu2};
<a name="2223"/> 2223: mapfoldl(F, Accu, []) -&gt; {[], Accu}.
<a name="2224"/> 2224: 
<a name="2225"/> 2225: filter(F, [H|T]) -&gt;
<a name="2226"/> 2226:     case F(H) of
<a name="2227"/> 2227: 	true  -&gt; [H|filter(F, T)];
<a name="2228"/> 2228: 	false -&gt; filter(F, T)
<a name="2229"/> 2229:     end;
<a name="2230"/> 2230: filter(F, []) -&gt; [].
<a name="2231"/> 2231: 
<a name="2232"/> 2232: diff(L1, L2) -&gt;
<a name="2233"/> 2233:     filter(fun(X) -&gt; not lists:member(X, L2) end, L1).
<a name="2234"/> 2234: 
<a name="2235"/> 2235: intersection(L1,L2) -&gt; filter(fun(X) -&gt; lists:member(X,L1) end, L2).
<a name="2236"/> 2236: 
<a name="2237"/> 2237: takewhile(Pred, [H|T]) -&gt;
<a name="2238"/> 2238:     case Pred(H) of
<a name="2239"/> 2239: 	true  -&gt; [H|takewhile(Pred, T)];
<a name="2240"/> 2240: 	false -&gt; []
<a name="2241"/> 2241:     end;
<a name="2242"/> 2242: takewhile(Pred, []) -&gt;
<a name="2243"/> 2243:     [].
<a name="2244"/> 2244: 
<a name="2245"/> 2245: dropwhile(Pred, [H|T]) -&gt;
<a name="2246"/> 2246:     case Pred(H) of
<a name="2247"/> 2247: 	true  -&gt; dropwhile(Pred, T);
<a name="2248"/> 2248: 	false -&gt; [H|T]
<a name="2249"/> 2249:     end;
<a name="2250"/> 2250: dropwhile(Pred, []) -&gt;
<a name="2251"/> 2251:     [].
<a name="2252"/> 2252: 
<a name="2253"/> 2253: splitlist(Pred, L) -&gt;
<a name="2254"/> 2254:     splitlist(Pred, L, []).
<a name="2255"/> 2255: 
<a name="2256"/> 2256: splitlist(Pred, [H|T], L) -&gt;
<a name="2257"/> 2257:     case Pred(H) of
<a name="2258"/> 2258: 	true  -&gt; splitlist(Pred, T, [H|L]);
<a name="2259"/> 2259: 	false -&gt; {lists:reverse(L), [H|T]}
<a name="2260"/> 2260:     end;
<a name="2261"/> 2261: splitlist(Pred, [], L) -&gt;
<a name="2262"/> 2262:     {lists:reverse(L), []}.
<a name="2263"/> 2263: 
<a name="2264"/> 2264: first(Pred, [H|T]) -&gt;
<a name="2265"/> 2265:     case Pred(H) of
<a name="2266"/> 2266: 	true -&gt;
<a name="2267"/> 2267: 	    {true, H};
<a name="2268"/> 2268: 	false -&gt;
<a name="2269"/> 2269: 	    first(Pred, T)
<a name="2270"/> 2270:     end;
<a name="2271"/> 2271: first(Pred, []) -&gt;
<a name="2272"/> 2272:     false.
<a name="2273"/> 2273: 
<a name="2274"/> 2274: ints_from(N) -&gt;
<a name="2275"/> 2275:     fun() -&gt;
<a name="2276"/> 2276: 	    [N|ints_from(N+1)]
<a name="2277"/> 2277:     end.
<a name="2278"/> 2278: 
<a name="2279"/> 2279: pconst(X) -&gt;
<a name="2280"/> 2280:     fun (T) -&gt;
<a name="2281"/> 2281: 	    case T of
<a name="2282"/> 2282: 		[X|T1] -&gt; {ok, {const, X}, T1};
<a name="2283"/> 2283: 		_      -&gt; fail
<a name="2284"/> 2284: 	    end
<a name="2285"/> 2285:     end.
<a name="2286"/> 2286: 
<a name="2287"/> 2287: pand(P1, P2) -&gt;
<a name="2288"/> 2288:     fun (T) -&gt;
<a name="2289"/> 2289: 	    case P1(T) of
<a name="2290"/> 2290: 		{ok, R1, T1} -&gt;
<a name="2291"/> 2291: 		    case P2(T1) of
<a name="2292"/> 2292: 			{ok, R2, T2} -&gt;
<a name="2293"/> 2293: 			    {ok, {'and', R1, R2}};
<a name="2294"/> 2294: 			fail -&gt;
<a name="2295"/> 2295: 			    fail
<a name="2296"/> 2296: 		    end;
<a name="2297"/> 2297: 		fail -&gt;
<a name="2298"/> 2298: 		    fail
<a name="2299"/> 2299: 	    end
<a name="2300"/> 2300:     end.
<a name="2301"/> 2301: 
<a name="2302"/> 2302: por(P1, P2) -&gt;
<a name="2303"/> 2303:     fun (T) -&gt;
<a name="2304"/> 2304: 	    case P1(T) of
<a name="2305"/> 2305: 		{ok, R, T1} -&gt;
<a name="2306"/> 2306: 		    {ok, {'or',1,R}, T1};
<a name="2307"/> 2307: 		fail -&gt;
<a name="2308"/> 2308: 		    case P2(T) of
<a name="2309"/> 2309: 			{ok, R1, T1} -&gt;
<a name="2310"/> 2310: 			    {ok, {'or',2,R1}, T1};
<a name="2311"/> 2311: 			fail -&gt;
<a name="2312"/> 2312: 			    fail
<a name="2313"/> 2313: 		    end
<a name="2314"/> 2314: 	    end
<a name="2315"/> 2315:     end.
<a name="2316"/> 2316: 
<a name="2317"/> 2317: grammar() -&gt;
<a name="2318"/> 2318:     pand(
<a name="2319"/> 2319:       por(pconst(a), pconst(b)),
<a name="2320"/> 2320:       por(pconst(c), pconst(d))).
<a name="2321"/> 2321: 
<a name="2322"/> 2322: parse(List) -&gt;
<a name="2323"/> 2323:     (grammar())(List).
<a name="2324"/> 2324: 
<a name="2325"/> 2325: 
<a name="2326"/> 2326: t() -&gt;
<a name="2327"/> 2327:     [2,4,6,8] = double([1,2,3,4]),
<a name="2328"/> 2328:     [2,3,4,5] = add_one([1,2,3,4]),
<a name="2329"/> 2329:     [2,4,6,8] = double2([1,2,3,4]),
<a name="2330"/> 2330:     [2,3,4,5] = add_one2([1,2,3,4]),
<a name="2331"/> 2331:     XX = ints_from(1),
<a name="2332"/> 2332:     [1 | _] = XX(),
<a name="2333"/> 2333:     1 = hd(XX()),
<a name="2334"/> 2334:     Y = tl(XX()),
<a name="2335"/> 2335:     2 = hd(Y()),
<a name="2336"/> 2336: 
<a name="2337"/> 2337:     P1 = pconst(a),
<a name="2338"/> 2338:     {ok,{const,a},[b,c]} = P1([a,b,c]),
<a name="2339"/> 2339:     fail = P1([x,y,z]),
<a name="2340"/> 2340: 
<a name="2341"/> 2341:     {ok,{'and',{'or',1,{const,a}},{'or',1,{const,c}}}} =
<a name="2342"/> 2342: 	parse([a,c]),
<a name="2343"/> 2343:     {ok,{'and',{'or',1,{const,a}},{'or',2,{const,d}}}} =
<a name="2344"/> 2344: 	parse([a,d]),
<a name="2345"/> 2345:     {ok,{'and',{'or',2,{const,b}},{'or',1,{const,c}}}} =
<a name="2346"/> 2346: 	parse([b,c]),
<a name="2347"/> 2347:     {ok,{'and',{'or',2,{const,b}},{'or',2,{const,d}}}} =
<a name="2348"/> 2348: 	parse([b,d]),
<a name="2349"/> 2349:     fail = parse([a,b]),
<a name="2350"/> 2350:     ok.
<a name="2351"/> 2351: &quot;&gt;&gt;,
<a name="2352"/> 2352:     ok = run_file(Config, funs, Test1),
<a name="2353"/> 2353: 
<a name="2354"/> 2354: Test2_shell =
<a name="2355"/> 2355: &lt;&lt;&quot;Double = fun(X) -&gt; 2 * X end,
<a name="2356"/> 2356:           [2,4,6,8,10] = lists:map(Double, [1,2,3,4,5]),
<a name="2357"/> 2357: 
<a name="2358"/> 2358:   Big =  fun(X) -&gt; if X &gt; 10 -&gt; true; true -&gt; false end end,
<a name="2359"/> 2359:   false = lists:any(Big, [1,2,3,4]),
<a name="2360"/> 2360:   true = lists:any(Big, [1,2,3,12,5]),
<a name="2361"/> 2361:   false = lists:all(Big, [1,2,3,4,12,6]),
<a name="2362"/> 2362:   true = lists:all(Big, [12,13,14,15]),
<a name="2363"/> 2363:   L = [\&quot;I\&quot;,\&quot;like\&quot;,\&quot;Erlang\&quot;],
<a name="2364"/> 2364:           11 = lists:foldl(fun(X, Sum) -&gt; length(X) + Sum end, 0, L),
<a name="2365"/> 2365:        Upcase =  fun(X) when $a =&lt; X,  X =&lt; $z -&gt; X + $A - $a;
<a name="2366"/> 2366: 		    (X) -&gt; X
<a name="2367"/> 2367: 		 end,
<a name="2368"/> 2368:        Upcase_word = fun(X) -&gt; lists:map(Upcase, X) end,
<a name="2369"/> 2369:        \&quot;ERLANG\&quot; = Upcase_word(\&quot;Erlang\&quot;),
<a name="2370"/> 2370:           [\&quot;I\&quot;,\&quot;LIKE\&quot;,\&quot;ERLANG\&quot;] = lists:map(Upcase_word, L),
<a name="2371"/> 2371:           {[\&quot;I\&quot;,\&quot;LIKE\&quot;,\&quot;ERLANG\&quot;],11} =
<a name="2372"/> 2372:                lists:mapfoldl(fun(Word, Sum) -&gt;
<a name="2373"/> 2373: 				      {Upcase_word(Word), Sum + length(Word)}
<a name="2374"/> 2374:                               end, 0, L),
<a name="2375"/> 2375: 	    [500,12,45] = lists:filter(Big, [500,12,2,45,6,7]),
<a name="2376"/> 2376: 	    [200,500,45] = lists:takewhile(Big, [200,500,45,5,3,45,6]),
<a name="2377"/> 2377: 	    [5,3,45,6] = lists:dropwhile(Big, [200,500,45,5,3,45,6]),
<a name="2378"/> 2378: 	    {[200,500,45],[5,3,45,6]} =
<a name="2379"/> 2379: 		lists:splitwith(Big, [200,500,45,5,3,45,6]),
<a name="2380"/> 2380:           %% {true,45} = lists:first(Big, [1,2,45,6,123]),
<a name="2381"/> 2381:           %% false = lists:first(Big, [1,2,4,5]),
<a name="2382"/> 2382: 
<a name="2383"/> 2383: 	    Adder = fun(X) -&gt; fun(Y) -&gt; X + Y end end,
<a name="2384"/> 2384: 	    Add6 = Adder(6),
<a name="2385"/> 2385: 	    16 = Add6(10),
<a name="2386"/> 2386: 	    ok.
<a name="2387"/> 2387: &quot;&gt;&gt;,
<a name="2388"/> 2388:     [ok] = scan(Test2_shell),
<a name="progex_funs-last_expr"/><a name="2389"/> 2389: ok.
<a name="2390"/> 2390: 
<a name="2391"/> 2391: 
<a name="2392"/> 2392: <i>%% OTP-5990. {erlang,is_record}.</i>
<a name="otp_5990-1"/><a name="2393"/> 2393: <b>otp_5990</b>(Config) when is_list(Config) -&gt;
<a name="2394"/> 2394:     [true] =
<a name="2395"/> 2395:         scan(&lt;&lt;&quot;rd('OrdSet', {orddata = {},ordtype = type}), &quot;
<a name="2396"/> 2396:                &quot;S = #'OrdSet'{ordtype = {}}, &quot;
<a name="2397"/> 2397:                &quot;if tuple(S#'OrdSet'.ordtype) -&gt; true; true -&gt; false end.&quot;&gt;&gt;),
<a name="otp_5990-last_expr"/><a name="2398"/> 2398:     ok.
<a name="2399"/> 2399: 
<a name="2400"/> 2400: <i>%% OTP-6166. Order of record definitions.</i>
<a name="otp_6166-1"/><a name="2401"/> 2401: <b>otp_6166</b>(Config) when is_list(Config) -&gt;
<a name="2402"/> 2402:     Test1 = filename:join(proplists:get_value(priv_dir, Config), &quot;test1.hrl&quot;),
<a name="2403"/> 2403:     Contents1 = &lt;&lt;&quot;-module(test1).
<a name="2404"/> 2404:                    -record(r5, {f}). -record(r3, {f = #r5{}}). &quot;
<a name="2405"/> 2405:                   &quot;-record(r1, {f = #r3{}}). -record(r4, {f = #r1{}}). &quot;
<a name="2406"/> 2406: &quot;-record(r2, {f = #r4{}}).&quot;&gt;&gt;,
<a name="2407"/> 2407:     ok = file:write_file(Test1, Contents1),
<a name="2408"/> 2408: 
<a name="2409"/> 2409:     Test2 = filename:join(proplists:get_value(priv_dir, Config), &quot;test2.hrl&quot;),
<a name="2410"/> 2410:     Contents2 = &lt;&lt;&quot;-module(test2).
<a name="2411"/> 2411:                    -record(r5, {f}). -record(r3, {f = #r5{}}). &quot;
<a name="2412"/> 2412:                   &quot;-record(r1, {f = #r3{}}). -record(r4, {f = #r1{}}). &quot;
<a name="2413"/> 2413:                   &quot;-record(r2, {f = #r4{}}).
<a name="2414"/> 2414:                    -record(r6, {f = #r5{}}).            % r6 &gt; r0
<a name="2415"/> 2415:                    -record(r0, {f = #r5{}, g = #r5{}}). % r0 &lt; r5&quot;&gt;&gt;,
<a name="2416"/> 2416:     ok = file:write_file(Test2, Contents2),
<a name="2417"/> 2417: 
<a name="2418"/> 2418:     RR12 = &quot;[r1,r2,r3,r4,r5] = rr(\&quot;&quot; ++ Test1 ++ &quot;\&quot;),
<a name="2419"/> 2419:             [r0,r1,r2,r3,r4,r5,r6] = rr(\&quot;&quot; ++ Test2 ++ &quot;\&quot;),
<a name="2420"/> 2420:             R0 = #r0{}, R6 = #r6{},
<a name="2421"/> 2421:             true = is_record(R0, r0),
<a name="2422"/> 2422:             true = is_record(R6, r6),
<a name="2423"/> 2423:             ok. &quot;,
<a name="2424"/> 2424:     [ok] = scan(RR12),
<a name="2425"/> 2425: 
<a name="2426"/> 2426:     file:delete(Test1),
<a name="2427"/> 2427:     file:delete(Test2),
<a name="otp_6166-last_expr"/><a name="2428"/> 2428:     ok.
<a name="2429"/> 2429: 
<a name="2430"/> 2430: <i>%% OTP-6554. Formatted exits and error messages.</i>
<a name="otp_6554-1"/><a name="2431"/> 2431: <b>otp_6554</b>(Config) when is_list(Config) -&gt;
<a name="2432"/> 2432:     %% Should check the stacktrace as well...
<a name="2433"/> 2433:     &quot;exception error: bad argument&quot; =
<a name="2434"/> 2434:         comm_err(&lt;&lt;&quot;math:sqrt(a).&quot;&gt;&gt;),
<a name="2435"/> 2435:     &quot;exception error: bad argument&quot; =
<a name="2436"/> 2436:         comm_err(&lt;&lt;&quot;fun(X, Y) -&gt; X ++ Y end(a, b).&quot;&gt;&gt;),
<a name="2437"/> 2437:     &quot;exception error: bad argument&quot; =
<a name="2438"/> 2438:         comm_err(&lt;&lt;&quot;math:sqrt(lists:seq(1,40)).&quot;&gt;&gt;),
<a name="2439"/> 2439:     &quot;exception error: bad argument&quot; =
<a name="2440"/> 2440:         comm_err(&lt;&lt;&quot;math:sqrt(lists:seq(1,10)).&quot;&gt;&gt;),
<a name="2441"/> 2441:     &quot;exception error: bad argument&quot; =
<a name="2442"/> 2442:         comm_err(&lt;&lt;&quot;a ++ b.&quot;&gt;&gt;),
<a name="2443"/> 2443:     &quot;exception error: bad argument&quot; =
<a name="2444"/> 2444:         comm_err(&lt;&lt;&quot;I = {file_info,undefined,undefined,undefined,undefined,
<a name="2445"/> 2445:                          undefined,undefined,undefined,undefined,undefined,
<a name="2446"/> 2446:                          undefined,undefined,undefined,undefined},
<a name="2447"/> 2447:                     aa ++ I.&quot;&gt;&gt;),
<a name="2448"/> 2448:     &quot;exception error: bad argument&quot; =
<a name="2449"/> 2449:         comm_err(&lt;&lt;&quot;I = {file_info,undefined,undefined,undefined,undefined,
<a name="2450"/> 2450:                          undefined,undefined,undefined,undefined,undefined,
<a name="2451"/> 2451:                          undefined,undefined,undefined,undefined},
<a name="2452"/> 2452:                     aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa ++ I.&quot;&gt;&gt;),
<a name="2453"/> 2453:     &quot;exception error: bad argument&quot; =
<a name="2454"/> 2454:         comm_err(&lt;&lt;&quot;I = {file_info,undefined,undefined,undefined,undefined,
<a name="2455"/> 2455:                          undefined,undefined,undefined,undefined,undefined,
<a name="2456"/> 2456:                          undefined,undefined,undefined,undefined},
<a name="2457"/> 2457:                     I ++ I.&quot;&gt;&gt;),
<a name="2458"/> 2458:     &quot;exception error: bad argument&quot; =
<a name="2459"/> 2459:         comm_err(&lt;&lt;&quot;fun(X) -&gt; not X end(a).&quot;&gt;&gt;),
<a name="2460"/> 2460:     &quot;exception error: bad argument: a&quot; =
<a name="2461"/> 2461:         comm_err(&lt;&lt;&quot;fun(A, B) -&gt; A orelse B end(a, b).&quot;&gt;&gt;),
<a name="2462"/> 2462:     &quot;exception error: bad key: key&quot; =
<a name="2463"/> 2463:         comm_err(&lt;&lt;&quot;map_get(key, #{}).&quot;&gt;&gt;),
<a name="2464"/> 2464:     &quot;exception error: bad map: not_a_map&quot; =
<a name="2465"/> 2465:         comm_err(&lt;&lt;&quot;map_get(key, not_a_map).&quot;&gt;&gt;),
<a name="2466"/> 2466:     &quot;exception error: an error occurred when evaluating an arithmetic expression&quot; =
<a name="2467"/> 2467:         comm_err(&lt;&lt;&quot;math:sqrt(2)/round(math:sqrt(0)).&quot;&gt;&gt;),
<a name="2468"/> 2468:     &quot;exception error: interpreted function with arity 1 called with no arguments&quot; =
<a name="2469"/> 2469:         comm_err(&lt;&lt;&quot;fun(V) -&gt; V end().&quot;&gt;&gt;),
<a name="2470"/> 2470:     &quot;exception error: interpreted function with arity 1 called with two arguments&quot; =
<a name="2471"/> 2471:         comm_err(&lt;&lt;&quot;fun(V) -&gt; V end(1,2).&quot;&gt;&gt;),
<a name="2472"/> 2472:     &quot;exception error: interpreted function with arity 0 called with one argument&quot; =
<a name="2473"/> 2473:         comm_err(&lt;&lt;&quot;fun() -&gt; v end(1).&quot;&gt;&gt;),
<a name="2474"/> 2474:     &quot;exception error: interpreted function with arity 0 called with 4 arguments&quot; =
<a name="2475"/> 2475:         comm_err(&lt;&lt;&quot;fun() -&gt; v end(1,2,3,4).&quot;&gt;&gt;),
<a name="2476"/> 2476:     &quot;exception error: math:sqrt/1 called with two arguments&quot; =
<a name="2477"/> 2477:         comm_err(&lt;&lt;&quot;fun math:sqrt/1(1,2).&quot;&gt;&gt;),
<a name="2478"/> 2478:     &quot;exception error: bad function 1.&quot; ++ _ =
<a name="2479"/> 2479:         comm_err(&lt;&lt;&quot;(math:sqrt(2))().&quot;&gt;&gt;),
<a name="2480"/> 2480:     &quot;exception error: bad function [1,&quot; ++ _ =
<a name="2481"/> 2481:         comm_err(&lt;&lt;&quot;(lists:seq(1, 100))().&quot;&gt;&gt;),
<a name="2482"/> 2482:     &quot;exception error: no match of right hand side value 1&quot; ++ _ =
<a name="2483"/> 2483:         comm_err(&lt;&lt;&quot;a = math:sqrt(2).&quot;&gt;&gt;),
<a name="2484"/> 2484:     &quot;exception error: no match of right hand side value&quot; ++ _ =
<a name="2485"/> 2485:         comm_err(&lt;&lt;&quot;I = {file_info,undefined,undefined,undefined,undefined,
<a name="2486"/> 2486:                          undefined,undefined,undefined,undefined,undefined,
<a name="2487"/> 2487:                          undefined,undefined,undefined,undefined},
<a name="2488"/> 2488:                     a = I.&quot;&gt;&gt;),
<a name="2489"/> 2489:     &quot;exception error: no case clause matching 1&quot; ++ _ =
<a name="2490"/> 2490:         comm_err(&lt;&lt;&quot;case math:sqrt(2) of a -&gt; ok end.&quot;&gt;&gt;),
<a name="2491"/> 2491:     &quot;exception error: no case clause matching [1,&quot; ++ _ =
<a name="2492"/> 2492:         comm_err(&lt;&lt;&quot;V = lists:seq(1, 20), case V of a -&gt; ok end.&quot;&gt;&gt;),
<a name="2493"/> 2493:     &quot;exception error: no function clause matching&quot; =
<a name="2494"/> 2494:         comm_err(&lt;&lt;&quot;fun(P) when is_pid(P) -&gt; true end(a).&quot;&gt;&gt;),
<a name="2495"/> 2495:     &quot;exception error: {function_clause,&quot; =
<a name="2496"/> 2496:         comm_err(&lt;&lt;&quot;erlang:error(function_clause, &quot;
<a name="2497"/> 2497:                    &quot;[unproper | list]).&quot;&gt;&gt;),
<a name="2498"/> 2498:     %% Cheating:
<a name="2499"/> 2499:     &quot;exception error: no function clause matching &quot;
<a name="2500"/> 2500:         &quot;shell:apply_fun(4)&quot; ++ _ =
<a name="2501"/> 2501:         comm_err(&lt;&lt;&quot;erlang:error(function_clause, [4]).&quot;&gt;&gt;),
<a name="2502"/> 2502:     &quot;exception error: no function clause matching &quot;
<a name="2503"/> 2503:         &quot;lists:reverse(&quot; ++ _ =
<a name="2504"/> 2504:         comm_err(&lt;&lt;&quot;F=fun() -&gt; hello end, lists:reverse(F).&quot;&gt;&gt;),
<a name="2505"/> 2505:     &quot;exception error: no function clause matching &quot;
<a name="2506"/> 2506:         &quot;lists:reverse(34) (lists.erl, line &quot; ++ _ =
<a name="2507"/> 2507:         comm_err(&lt;&lt;&quot;lists:reverse(34).&quot;&gt;&gt;),
<a name="2508"/> 2508:     &quot;exception error: function_clause&quot; =
<a name="2509"/> 2509:         comm_err(&lt;&lt;&quot;erlang:error(function_clause, 4).&quot;&gt;&gt;),
<a name="2510"/> 2510:     &quot;exception error: no function clause matching&quot; ++ _ =
<a name="2511"/> 2511:         comm_err(&lt;&lt;&quot;fun(a, b, c, d) -&gt; foo end&quot;
<a name="2512"/> 2512:                    &quot;       (lists:seq(1,17),&quot;
<a name="2513"/> 2513:                    &quot;        lists:seq(1, 18),&quot;
<a name="2514"/> 2514:                    &quot;        lists:seq(1, 40),&quot;
<a name="2515"/> 2515:                    &quot;        lists:seq(1, 5)).&quot;&gt;&gt;),
<a name="2516"/> 2516: 
<a name="2517"/> 2517:     &quot;exception error: no function clause matching&quot; =
<a name="2518"/> 2518:         comm_err(&lt;&lt;&quot;fun(P, q) when is_pid(P) -&gt; true end(a, b).&quot;&gt;&gt;),
<a name="2519"/> 2519:     &quot;exception error: no true branch found when evaluating an if expression&quot; =
<a name="2520"/> 2520:         comm_err(&lt;&lt;&quot;if length([a,b]) &gt; 17 -&gt; a end.&quot;&gt;&gt;),
<a name="2521"/> 2521:     &quot;exception error: no such process or port&quot; =
<a name="2522"/> 2522:         comm_err(&lt;&lt;&quot;Pid = spawn(fun() -&gt; a end),&quot;
<a name="2523"/> 2523:                    &quot;timer:sleep(1),&quot;
<a name="2524"/> 2524:                    &quot;link(Pid).&quot;&gt;&gt;),
<a name="2525"/> 2525:     &quot;exception error: a system limit has been reached&quot; =
<a name="2526"/> 2526:         comm_err(&lt;&lt;&quot;list_to_atom(lists:duplicate(300,$a)).&quot;&gt;&gt;),
<a name="2527"/> 2527:     &quot;exception error: bad receive timeout value&quot; =
<a name="2528"/> 2528:         comm_err(&lt;&lt;&quot;receive after a -&gt; foo end.&quot;&gt;&gt;),
<a name="2529"/> 2529:     &quot;exception error: no try clause matching 1&quot; ++ _ =
<a name="2530"/> 2530:         comm_err(&lt;&lt;&quot;try math:sqrt(2) of bar -&gt; yes after 3 end.&quot;&gt;&gt;),
<a name="2531"/> 2531:     &quot;exception error: no try clause matching [1&quot; ++ _ =
<a name="2532"/> 2532:         comm_err(&lt;&lt;&quot;V = lists:seq(1, 20),&quot;
<a name="2533"/> 2533:                    &quot;try V of bar -&gt; yes after 3 end.&quot;&gt;&gt;),
<a name="2534"/> 2534:     &quot;exception error: undefined function math:sqrt/2&quot; =
<a name="2535"/> 2535:         comm_err(&lt;&lt;&quot;math:sqrt(2, 2).&quot;&gt;&gt;),
<a name="2536"/> 2536:     &quot;exception error: limit of number of arguments to interpreted function &quot;
<a name="2537"/> 2537:           &quot;exceeded&quot; =
<a name="2538"/> 2538:         comm_err(&lt;&lt;&quot;fun(A,B,C,D,E,F,G,H,I,J,K,L,M,N,O,P,Q,R,S,T,U) -&gt;&quot;
<a name="2539"/> 2539:                    &quot;   a end().&quot;&gt;&gt;),
<a name="2540"/> 2540:     &quot;exception error: bad filter a&quot; =
<a name="2541"/> 2541:         comm_err(&lt;&lt;&quot;[b || begin a end].&quot;&gt;&gt;),
<a name="2542"/> 2542:     &quot;exception error: bad generator a&quot; =
<a name="2543"/> 2543:         comm_err(&lt;&lt;&quot;[X || X &lt;- a].&quot;&gt;&gt;),
<a name="2544"/> 2544:     &quot;exception throw: undef&quot; = comm_err(&lt;&lt;&quot;throw(undef).&quot;&gt;&gt;),
<a name="2545"/> 2545:     &quot;exception exit: undef&quot; = comm_err(&lt;&lt;&quot;exit(undef).&quot;&gt;&gt;),
<a name="2546"/> 2546: 
<a name="2547"/> 2547:     &quot;exception exit: foo&quot; =
<a name="2548"/> 2548:           comm_err(&lt;&lt;&quot;catch spawn_link(fun() -&gt;&quot;
<a name="2549"/> 2549:                      &quot;                     timer:sleep(300), exit(foo) &quot;
<a name="2550"/> 2550:                      &quot;                 end),&quot;
<a name="2551"/> 2551:                      &quot;timer:sleep(500).&quot;&gt;&gt;),
<a name="2552"/> 2552:     [ok] = scan(
<a name="2553"/> 2553:                    &lt;&lt;&quot;begin process_flag(trap_exit, true),&quot;
<a name="2554"/> 2554:                      &quot;  Pid = spawn_link(fun() -&gt;&quot;
<a name="2555"/> 2555:                      &quot;                       timer:sleep(300), exit(foo) &quot;
<a name="2556"/> 2556:                      &quot;                   end),&quot;
<a name="2557"/> 2557:                      &quot;  timer:sleep(500),&quot;
<a name="2558"/> 2558:                      &quot;  receive {'EXIT', Pid, foo} -&gt; ok end end.&quot;&gt;&gt;),
<a name="2559"/> 2559:     &quot;exception exit: badarith&quot; =
<a name="2560"/> 2560:           comm_err(&lt;&lt;&quot;catch spawn_link(fun() -&gt;&quot;
<a name="2561"/> 2561:                      &quot;                     timer:sleep(300), 1/0 &quot;
<a name="2562"/> 2562:                      &quot;                 end),&quot;
<a name="2563"/> 2563:                      &quot;timer:sleep(500).&quot;&gt;&gt;),
<a name="2564"/> 2564:     &quot;exception exit: {nocatch,foo}&quot; =
<a name="2565"/> 2565:           comm_err(&lt;&lt;&quot;catch spawn_link(fun() -&gt;&quot;
<a name="2566"/> 2566:                      &quot;                     timer:sleep(300), throw(foo) &quot;
<a name="2567"/> 2567:                      &quot;                 end),&quot;
<a name="2568"/> 2568:                      &quot;timer:sleep(500).&quot;&gt;&gt;),
<a name="2569"/> 2569:     [ok] = scan(
<a name="2570"/> 2570:                    &lt;&lt;&quot;begin process_flag(trap_exit, true),&quot;
<a name="2571"/> 2571:                      &quot;  Pid = spawn_link(fun() -&gt;&quot;
<a name="2572"/> 2572:                      &quot;                       timer:sleep(300), throw(foo) &quot;
<a name="2573"/> 2573:                      &quot;                   end),&quot;
<a name="2574"/> 2574:                      &quot;  timer:sleep(500),&quot;
<a name="2575"/> 2575:                      &quot;  receive {'EXIT', Pid, {{nocatch,foo},_}} -&gt; ok end &quot;
<a name="2576"/> 2576:                      &quot;end.&quot;&gt;&gt;),
<a name="2577"/> 2577: 
<a name="2578"/> 2578:     &quot;exception error: an error occurred when evaluating an arithmetic expression&quot; =
<a name="2579"/> 2579:         comm_err(&lt;&lt;&quot;begin catch_exception(true), 1/0 end.&quot;&gt;&gt;),
<a name="2580"/> 2580:     &quot;exception error: an error occurred when evaluating an arithmetic expression&quot; =
<a name="2581"/> 2581:         comm_err(&lt;&lt;&quot;begin catch_exception(false), 1/0 end.&quot;&gt;&gt;),
<a name="2582"/> 2582:     &quot;exception error: no function clause matching call to catch_exception/1&quot; =
<a name="2583"/> 2583:         comm_err(&lt;&lt;&quot;catch_exception(1).&quot;&gt;&gt;),
<a name="2584"/> 2584: 
<a name="2585"/> 2585:     %% A bug was corrected (expansion of 'try'):
<a name="2586"/> 2586:     &quot;2: command not found&quot; =
<a name="2587"/> 2587:         comm_err(&lt;&lt;&quot;try 1 of 1 -&gt; v(2) after 3 end.&quot;&gt;&gt;),
<a name="2588"/> 2588:     %% Cover a few lines:
<a name="2589"/> 2589:     &quot;3: command not found&quot; =
<a name="2590"/> 2590:         comm_err(&lt;&lt;&quot;receive foo -&gt; foo after 0 -&gt; v(3) end.&quot;&gt;&gt;),
<a name="2591"/> 2591:     &quot;3: command not found&quot; =
<a name="2592"/> 2592:         comm_err(&lt;&lt;&quot;receive foo -&gt; foo after 0 -&gt; e(3) end.&quot;&gt;&gt;),
<a name="2593"/> 2593:     &quot;1 / 0: command not found&quot; = comm_err(&lt;&lt;&quot;v(1/0).&quot;&gt;&gt;),
<a name="2594"/> 2594:     &quot;1\n1.\n&quot; = t(&lt;&lt;&quot;1. e(1).&quot;&gt;&gt;),
<a name="2595"/> 2595:     [ok] = scan(&lt;&lt;&quot;h().&quot;&gt;&gt;),
<a name="2596"/> 2596:     &quot;exception exit: normal&quot; = comm_err(&lt;&lt;&quot;exit(normal).&quot;&gt;&gt;),
<a name="2597"/> 2597:     [foo] = scan(&lt;&lt;&quot;begin history(0), foo end.&quot;&gt;&gt;),
<a name="2598"/> 2598:     application:unset_env(stdlib, shell_history_length),
<a name="2599"/> 2599:     [true] = scan(&lt;&lt;&quot;begin &lt;&lt;10:(1024*1024*10)&gt;&gt;,&quot;
<a name="2600"/> 2600:                           &quot;&lt;&lt;10:(1024*1024*10)&gt;&gt;, garbage_collect() end.&quot;&gt;&gt;),
<a name="2601"/> 2601:     &quot;1:3: syntax error before: '.'&quot; = comm_err(&quot;1-.&quot;),
<a name="2602"/> 2602:     %% comm_err(&lt;&lt;&quot;exit().&quot;&gt;&gt;), % would hang
<a name="2603"/> 2603:     &quot;exception error: no function clause matching call to history/1&quot; =
<a name="2604"/> 2604:         comm_err(&lt;&lt;&quot;history(foo).&quot;&gt;&gt;),
<a name="2605"/> 2605:     &quot;exception error: no function clause matching call to results/1&quot; =
<a name="2606"/> 2606:         comm_err(&lt;&lt;&quot;results(foo).&quot;&gt;&gt;),
<a name="2607"/> 2607: 
<a name="2608"/> 2608:     Test = filename:join(proplists:get_value(priv_dir, Config),
<a name="2609"/> 2609: 			       &quot;otp_6554.erl&quot;),
<a name="2610"/> 2610:     Contents = &lt;&lt;&quot;-module(otp_6554).
<a name="2611"/> 2611:                   -export([local_allowed/3, non_local_allowed/3]).
<a name="2612"/> 2612:                   local_allowed(_,_,State) -&gt;
<a name="2613"/> 2613:                       {true,State}.
<a name="2614"/> 2614: 
<a name="2615"/> 2615:                   non_local_allowed(_,_,State) -&gt;
<a name="2616"/> 2616:                       {true,State}.
<a name="2617"/> 2617:                  &quot;&gt;&gt;,
<a name="2618"/> 2618:     ok = compile_file(Config, Test, Contents, []),
<a name="2619"/> 2619:     &quot;exception exit: restricted shell starts now&quot; =
<a name="2620"/> 2620: 	comm_err(&lt;&lt;&quot;begin shell:start_restricted(otp_6554) end.&quot;&gt;&gt;),
<a name="2621"/> 2621:     &quot;-record(r,{}).\n1.\nok.\n&quot; =
<a name="2622"/> 2622:                     t(&lt;&lt;&quot;f(), f(B), h(), b(), history(20), results(20),&quot;
<a name="2623"/> 2623:                         &quot;rd(r, {}), rl(r), rf('_'), rl(), rf(),&quot;
<a name="2624"/> 2624:                         &quot;rp(1), _ = rr({foo}), _ = rr({foo}, []),&quot;
<a name="2625"/> 2625:                         &quot;rr({foo}, [], []), ok.&quot;&gt;&gt;),
<a name="2626"/> 2626:     &quot;false.\n&quot; = t(&lt;&lt;&quot;catch_exception(true).&quot;&gt;&gt;),
<a name="2627"/> 2627:     &quot;exception exit: restricted shell stopped&quot;=
<a name="2628"/> 2628: 	comm_err(&lt;&lt;&quot;begin shell:stop_restricted() end.&quot;&gt;&gt;),
<a name="2629"/> 2629:     &quot;true.\n&quot; = t(&lt;&lt;&quot;catch_exception(false).&quot;&gt;&gt;),
<a name="2630"/> 2630: 
<a name="2631"/> 2631:     &quot;20\n1\n1\n1: results(2)\n2: 1\n-&gt; 1\n3: v(2)\n-&gt; 1.\nok.\n&quot; =
<a name="2632"/> 2632:              t(&lt;&lt;&quot;results(2). 1. v(2). h().&quot;&gt;&gt;),
<a name="2633"/> 2633:     application:unset_env(stdlib, shell_saved_results),
<a name="2634"/> 2634:     &quot;1\nfoo\n17\nB = foo\nC = 17\nF = fun() -&gt;\n           foo&quot;
<a name="2635"/> 2635:           &quot;\n    end.\nok.\n&quot; =
<a name="2636"/> 2636:         t(&lt;&lt;&quot;begin F = fun() -&gt; foo end, 1 end. B = F(). C = 17. b().&quot;&gt;&gt;),
<a name="2637"/> 2637: 
<a name="2638"/> 2638:     &quot;3: command not found&quot; = comm_err(&lt;&lt;&quot;#{v(3) =&gt; v}.&quot;&gt;&gt;),
<a name="2639"/> 2639:     &quot;3: command not found&quot; = comm_err(&lt;&lt;&quot;#{k =&gt; v(3)}.&quot;&gt;&gt;),
<a name="2640"/> 2640:     &quot;3: command not found&quot; = comm_err(&lt;&lt;&quot;#{v(3) := v}.&quot;&gt;&gt;),
<a name="2641"/> 2641:     &quot;3: command not found&quot; = comm_err(&lt;&lt;&quot;#{k := v(3)}.&quot;&gt;&gt;),
<a name="2642"/> 2642:     &quot;3: command not found&quot; = comm_err(&lt;&lt;&quot;(v(3))#{}.&quot;&gt;&gt;),
<a name="2643"/> 2643:     %% Tests I'd like to do: (you should try them manually)
<a name="2644"/> 2644:     %% &quot;catch spawn_link(fun() -&gt; timer:sleep(1000), exit(foo) end).&quot;
<a name="2645"/> 2645:     %%   &quot;** exception error: foo&quot; should be output after 1 second
<a name="2646"/> 2646:     %% &quot;catch spawn_link(fun() -&gt; timer:sleep(1000), 1/0 end).&quot;
<a name="2647"/> 2647:     %%   &quot;** exception error: bad argument...&quot; should be output after 1 second
<a name="2648"/> 2648:     %% &quot;1/0&quot;, &quot;exit(foo)&quot;, &quot;throw(foo)&quot;.
<a name="2649"/> 2649:     %%   &quot;h().&quot; should show {'EXIT', {badarith,..}}, {'EXIT',{foo,...}},
<a name="2650"/> 2650:     %%   and {'EXIT',{{nocatch,foo},...}}.
<a name="2651"/> 2651: 
<a name="otp_6554-last_expr"/><a name="2652"/> 2652:     ok.
<a name="2653"/> 2653: 
<a name="2654"/> 2654: <i>%% OTP-7184. Propagate exit signals from dying evaluator process.</i>
<a name="otp_7184-1"/><a name="2655"/> 2655: <b>otp_7184</b>(Config) when is_list(Config) -&gt;
<a name="2656"/> 2656:     register(otp_7184, self()),
<a name="2657"/> 2657:     catch
<a name="2658"/> 2658:            t(&lt;&lt;&quot;P = self(),
<a name="2659"/> 2659:                 spawn_link(fun() -&gt; process_flag(trap_exit,true),
<a name="2660"/> 2660:                                     P ! up,
<a name="2661"/> 2661:                                     receive X -&gt;
<a name="2662"/> 2662:                                         otp_7184 ! {otp_7184, X}
<a name="2663"/> 2663:                                     end
<a name="2664"/> 2664:                            end),
<a name="2665"/> 2665:                 receive up -&gt; ok end,
<a name="2666"/> 2666:                 erlang:raise(throw, thrown, []).&quot;&gt;&gt;),
<a name="2667"/> 2667:     receive {otp_7184,{'EXIT',_,{{nocatch,thrown},[]}}} -&gt; ok end,
<a name="2668"/> 2668: 
<a name="2669"/> 2669:     catch
<a name="2670"/> 2670:            t(&lt;&lt;&quot;P = self(),
<a name="2671"/> 2671:                 spawn_link(fun() -&gt; process_flag(trap_exit,true),
<a name="2672"/> 2672:                                     P ! up,
<a name="2673"/> 2673:                                     receive X -&gt;
<a name="2674"/> 2674:                                         otp_7184 ! {otp_7184, X}
<a name="2675"/> 2675:                                     end
<a name="2676"/> 2676:                            end),
<a name="2677"/> 2677:                 receive up -&gt; ok end,
<a name="2678"/> 2678:                 erlang:raise(exit, fini, []).&quot;&gt;&gt;),
<a name="2679"/> 2679:     receive {otp_7184,{'EXIT',_,{fini,[]}}} -&gt; ok end,
<a name="2680"/> 2680: 
<a name="2681"/> 2681:     catch
<a name="2682"/> 2682:            t(&lt;&lt;&quot;P = self(),
<a name="2683"/> 2683:                 spawn_link(fun() -&gt; process_flag(trap_exit,true),
<a name="2684"/> 2684:                                     P ! up,
<a name="2685"/> 2685:                                     receive X -&gt;
<a name="2686"/> 2686:                                         otp_7184 ! {otp_7184,X}
<a name="2687"/> 2687:                                     end
<a name="2688"/> 2688:                            end),
<a name="2689"/> 2689:                 receive up -&gt; ok end,
<a name="2690"/> 2690:                 erlang:raise(error, bad, []).&quot;&gt;&gt;),
<a name="2691"/> 2691:     receive {otp_7184,{'EXIT',_,{bad,[]}}} -&gt; ok end,
<a name="2692"/> 2692: 
<a name="2693"/> 2693:     unregister(otp_7184),
<a name="2694"/> 2694: 
<a name="2695"/> 2695:     %% v/1, a few missed cases
<a name="2696"/> 2696:     &quot;17\n&lt;&lt;0,0,0,64&gt;&gt;.\nok.\n&quot; =
<a name="2697"/> 2697:         t(&lt;&lt;&quot;17. &quot;
<a name="2698"/> 2698:             &quot;&lt;&lt;64:32&gt;&gt;. &quot;
<a name="2699"/> 2699:            &quot;&lt;&lt;64&gt;&gt; = &lt;&lt; &lt;&lt; X &gt;&gt; || &lt;&lt; X &gt;&gt;  &lt;= v(2), X &gt; v(1) &gt;&gt;, ok.&quot;&gt;&gt;),
<a name="2700"/> 2700: 
<a name="2701"/> 2701:     &quot;17\n&lt;&lt;0,17&gt;&gt;.\n&quot; =t(&lt;&lt;&quot;17. &lt;&lt;(v(1)):16&gt;&gt;.&quot;&gt;&gt;),
<a name="2702"/> 2702: 
<a name="otp_7184-last_expr"/><a name="2703"/> 2703:     ok.
<a name="2704"/> 2704: 
<a name="2705"/> 2705: <i>%% OTP-7232. qlc:info() bug.</i>
<a name="otp_7232-1"/><a name="2706"/> 2706: <b>otp_7232</b>(Config) when is_list(Config) -&gt;
<a name="2707"/> 2707:     Info = &lt;&lt;&quot;qlc:info(qlc:sort(qlc:q([X || X &lt;- [55296,56296]]), &quot;
<a name="2708"/> 2708:              &quot;{order, fun(A,B)-&gt; A&gt;B end})).&quot;&gt;&gt;,
<a name="2709"/> 2709:     &quot;qlc:sort([55296, 56296],\n&quot;
<a name="2710"/> 2710:     &quot;         [{order,\n&quot;
<a name="2711"/> 2711:     &quot;           fun(A, B) -&gt;\n&quot;
<a name="2712"/> 2712:     &quot;                  A &gt; B\n&quot;
<a name="2713"/> 2713:     &quot;           end}])&quot; = evaluate(Info, []),
<a name="otp_7232-last_expr"/><a name="2714"/> 2714:     ok.
<a name="2715"/> 2715: 
<a name="2716"/> 2716: <i>%% OTP-8393. Prompt string.</i>
<a name="otp_8393-1"/><a name="2717"/> 2717: <b>otp_8393</b>(Config) when is_list(Config) -&gt;
<a name="2718"/> 2718:     _ = shell:prompt_func(default),
<a name="2719"/> 2719:     &quot;Bad prompt function: '&gt; '&quot; =
<a name="2720"/> 2720:         prompt_err(&lt;&lt;&quot;shell:prompt_func('&gt; ').&quot;&gt;&gt;),
<a name="2721"/> 2721: 
<a name="2722"/> 2722:     _ = shell:prompt_func(default),
<a name="2723"/> 2723:     &quot;exception error: an error occurred when evaluating an arithmetic expression&quot;++_ =
<a name="2724"/> 2724:         prompt_err(&lt;&lt;&quot;shell:prompt_func({shell_SUITE,prompt4}).&quot;&gt;&gt;),
<a name="2725"/> 2725: 
<a name="2726"/> 2726:     _ = shell:prompt_func(default),
<a name="2727"/> 2727:     &quot;default.\n&quot; =
<a name="2728"/> 2728:         t(&lt;&lt;&quot;shell:prompt_func({shell_SUITE,prompt2}).&quot;&gt;&gt;),
<a name="2729"/> 2729: 
<a name="2730"/> 2730:     _ = shell:prompt_func(default),
<a name="2731"/> 2731:     &quot;default\nl.\n&quot; =
<a name="2732"/> 2732:         t(&lt;&lt;&quot;shell:prompt_func({shell_SUITE,prompt3}). l.&quot;&gt;&gt;),
<a name="2733"/> 2733: 
<a name="2734"/> 2734:     %%
<a name="2735"/> 2735:     %% Although this tests that you can set a unicode prompt function
<a name="2736"/> 2736:     %% it does not really test that it does work with the io-servers.
<a name="2737"/> 2737:     %% That is instead tested in the io_proto_SUITE, which has
<a name="2738"/> 2738:     %% the right infrastructure in place for such tests. /PaN
<a name="2739"/> 2739:     %%
<a name="2740"/> 2740:     _ = shell:prompt_func(default),
<a name="2741"/> 2741:     &quot;default\nl.\n&quot; =
<a name="2742"/> 2742:         t(&lt;&lt;&quot;shell:prompt_func({shell_SUITE,prompt5}). l.&quot;&gt;&gt;),
<a name="2743"/> 2743: 
<a name="2744"/> 2744:     %% Restricted shell.
<a name="2745"/> 2745:     Contents = &lt;&lt;&quot;-module(test_restricted_shell).
<a name="2746"/> 2746:                   -export([local_allowed/3, non_local_allowed/3]).
<a name="2747"/> 2747:                   local_allowed(_,_,State) -&gt;
<a name="2748"/> 2748:                       {false,State}.
<a name="2749"/> 2749: 
<a name="2750"/> 2750:                   non_local_allowed({shell,stop_restricted},[],State) -&gt;
<a name="2751"/> 2751:                       {true,State};
<a name="2752"/> 2752:                   non_local_allowed({shell,prompt_func},[_L],State) -&gt;
<a name="2753"/> 2753:                       {true,State};
<a name="2754"/> 2754:                   non_local_allowed({shell_SUITE,prompt1},[_L],State) -&gt;
<a name="2755"/> 2755:                       {true,State};
<a name="2756"/> 2756:                   non_local_allowed(_,_,State) -&gt;
<a name="2757"/> 2757:                       {false,State}.
<a name="2758"/> 2758:                  &quot;&gt;&gt;,
<a name="2759"/> 2759:     Test = filename:join(proplists:get_value(priv_dir, Config),
<a name="2760"/> 2760: 			       &quot;test_restricted_shell.erl&quot;),
<a name="2761"/> 2761:     ok = compile_file(Config, Test, Contents, []),
<a name="2762"/> 2762:     _ = shell:prompt_func(default),
<a name="2763"/> 2763:     &quot;exception exit: restricted shell starts now&quot; =
<a name="2764"/> 2764: 	comm_err(&lt;&lt;&quot;begin shell:start_restricted(&quot;
<a name="2765"/> 2765: 			 &quot;test_restricted_shell) end.&quot;&gt;&gt;),
<a name="2766"/> 2766:     &quot;default.\n&quot;++_ =
<a name="2767"/> 2767:         t(&lt;&lt;&quot;shell:prompt_func({shell_SUITE,prompt1}).&quot;&gt;&gt;),
<a name="2768"/> 2768:     &quot;exception exit: restricted shell does not allow apple(&quot; ++ _ =
<a name="2769"/> 2769: 	comm_err(&lt;&lt;&quot;apple(1).&quot;&gt;&gt;),
<a name="2770"/> 2770:     &quot;{shell_SUITE,prompt1}.\n&quot; =
<a name="2771"/> 2771:         t(&lt;&lt;&quot;shell:prompt_func(default).&quot;&gt;&gt;),
<a name="2772"/> 2772:     &quot;exception exit: restricted shell stopped&quot;=
<a name="2773"/> 2773: 	comm_err(&lt;&lt;&quot;begin shell:stop_restricted() end.&quot;&gt;&gt;),
<a name="2774"/> 2774:     undefined =
<a name="2775"/> 2775: 	application:get_env(stdlib, restricted_shell),
<a name="2776"/> 2776: 
<a name="2777"/> 2777:     NR = shell:results(20),
<a name="2778"/> 2778:     &quot;default\n20.\n&quot; =
<a name="2779"/> 2779:         t(&lt;&lt;&quot;shell:prompt_func({shell_SUITE,prompt3}). results(0).&quot;&gt;&gt;),
<a name="2780"/> 2780: 
<a name="2781"/> 2781:     _ = shell:prompt_func(default),
<a name="2782"/> 2782:     0 = shell:results(NR),
<a name="otp_8393-last_expr"/><a name="2783"/> 2783:     ok.
<a name="2784"/> 2784: 
<a name="prompt1-1"/><a name="2785"/> 2785: <b>prompt1</b>(_L) -&gt;
<a name="prompt1-last_expr"/><a name="2786"/> 2786:     &quot;prompt&gt; &quot;.
<a name="2787"/> 2787: 
<a name="prompt2-1"/><a name="2788"/> 2788: <b>prompt2</b>(_L) -&gt;
<a name="prompt2-last_expr"/><a name="2789"/> 2789:     {'EXIT', []}.
<a name="2790"/> 2790: 
<a name="prompt3-1"/><a name="2791"/> 2791: <b>prompt3</b>(L) -&gt;
<a name="2792"/> 2792:     N = proplists:get_value(history, L),
<a name="prompt3-last_expr"/><a name="2793"/> 2793: <b>    integer_to_list</b>(N).
<a name="2794"/> 2794: 
<a name="prompt4-1"/><a name="2795"/> 2795: <b>prompt4</b>(_L) -&gt;
<a name="prompt4-last_expr"/><a name="2796"/> 2796: <b>    erlang:apply</b>(fun erlang:'/'/2, [1,0]).
<a name="2797"/> 2797: 
<a name="prompt5-1"/><a name="2798"/> 2798: <b>prompt5</b>(_L) -&gt;
<a name="prompt5-last_expr"/><a name="2799"/> 2799:     [1050,1072,1082,1074,1086,32,1077,32,85,110,105,99,111,100,101,32,63].
<a name="2800"/> 2800: 
<a name="2801"/> 2801: <b>-ifdef</b>(not_used).
<a name="2802"/> 2802: exit_term(B) -&gt;
<a name="2803"/> 2803:     &quot;** exception exit:&quot; ++ Reply = t(B),
<a name="2804"/> 2804:     S0 = string:left(Reply, string:chr(Reply, $\n)-1),
<a name="2805"/> 2805:     S = string:strip(S0, right, $*),
<a name="2806"/> 2806:     {ok,Ts,_} = erl_scan:string(S),
<a name="2807"/> 2807:     {ok,Term} = erl_parse:parse_term(Ts),
<a name="2808"/> 2808:     Term.
<a name="2809"/> 2809: -endif.
<a name="2810"/> 2810: 
<a name="error_string-1"/><a name="2811"/> 2811: <b>error_string</b>(B) -&gt;
<a name="2812"/> 2812:     &quot;** exception error:&quot; ++ Reply = t(B),
<a name="error_string-last_expr"/><a name="2813"/> 2813: <b>    caught_string</b>(Reply).
<a name="2814"/> 2814: 
<a name="exit_string-1"/><a name="2815"/> 2815: <b>exit_string</b>(B) -&gt;
<a name="2816"/> 2816:     &quot;** exception exit:&quot; ++ Reply = t(B),
<a name="exit_string-last_expr"/><a name="2817"/> 2817: <b>    caught_string</b>(Reply).
<a name="2818"/> 2818: 
<a name="caught_string-1"/><a name="2819"/> 2819: <b>caught_string</b>(Reply) -&gt;
<a name="2820"/> 2820:     S0 = string:left(Reply, string:chr(Reply, $\n)-1),
<a name="2821"/> 2821:     S1 = string:strip(S0, right, $.),
<a name="2822"/> 2822:     S2 = string:strip(S1, left, $*),
<a name="2823"/> 2823:     S =  string:strip(S2, both, $ ),
<a name="caught_string-last_expr"/><a name="2824"/> 2824: <b>    string:strip</b>(S, both, $&quot;).
<a name="2825"/> 2825: 
<a name="comm_err-1"/><a name="2826"/> 2826: <b>comm_err</b>(B) -&gt;
<a name="2827"/> 2827:     Reply = t(B),
<a name="2828"/> 2828:     S0 = string:left(Reply, string:chr(Reply, $\n)-1),
<a name="2829"/> 2829:     S1 = string:strip(S0, left, $*),
<a name="2830"/> 2830:     S2 = string:strip(S1, both, $ ),
<a name="2831"/> 2831:     S = string:strip(S2, both, $&quot;),
<a name="comm_err-last_expr"/><a name="2832"/> 2832: <b>    string:strip</b>(S, right, $.).
<a name="2833"/> 2833: 
<a name="prompt_err-1"/><a name="2834"/> 2834: <b>prompt_err</b>(B) -&gt;
<a name="2835"/> 2835:     Reply = t(B),
<a name="2836"/> 2836:     S00 = string:sub_string(Reply, string:chr(Reply, $\n)+1),
<a name="2837"/> 2837:     S0 = string:left(S00, string:chr(S00, $\n)-1),
<a name="2838"/> 2838:     S1 = string:strip(S0, left, $*),
<a name="2839"/> 2839:     S2 = string:strip(S1, both, $ ),
<a name="2840"/> 2840:     S = string:strip(S2, both, $&quot;),
<a name="prompt_err-last_expr"/><a name="2841"/> 2841: <b>    string:strip</b>(S, right, $.).
<a name="2842"/> 2842: 
<a name="2843"/> 2843: <i>%% OTP-10302. Unicode. Also OTP-14285, Unicode atoms.</i>
<a name="otp_10302-1"/><a name="2844"/> 2844: <b>otp_10302</b>(Config) when is_list(Config) -&gt;
<a name="2845"/> 2845:     {ok, Peer, Node} = ?CT_PEER([&quot;-pa&quot;, proplists:get_value(priv_dir,Config),
<a name="2846"/> 2846: 			         &quot;+pc&quot;, &quot;unicode&quot;]),
<a name="2847"/> 2847:     Test1 =
<a name="2848"/> 2848:         &lt;&lt;&quot;begin
<a name="2849"/> 2849:                io:setopts([{encoding,utf8}]),
<a name="2850"/> 2850:                [1024] = \&quot;\\x{400}\&quot;,
<a name="2851"/> 2851:                rd(rec, {a = \&quot;\\x{400}\&quot;}),
<a name="2852"/> 2852:                ok = rl(rec)
<a name="2853"/> 2853:             end.&quot;&gt;&gt;,
<a name="2854"/> 2854:     &quot;-record(rec,{a = \&quot;\x{400}\&quot;}).\nok.\n&quot; = t({Node,Test1}),
<a name="2855"/> 2855: 
<a name="2856"/> 2856:     Test3 =
<a name="2857"/> 2857:         &lt;&lt;&quot;io:setopts([{encoding,utf8}]).
<a name="2858"/> 2858:            rd(rec, {a = \&quot;\\x{400}\&quot;}).
<a name="2859"/> 2859:            ok = rp(#rec{}).&quot;&gt;&gt;,
<a name="2860"/> 2860:     &quot;ok.\nrec\n#rec{a = \&quot;\x{400}\&quot;}.\nok.\n&quot; = t({Node,Test3}),
<a name="2861"/> 2861: 
<a name="2862"/> 2862:     Test4 =
<a name="2863"/> 2863:         &lt;&lt;&quot;io:setopts([{encoding,utf8}]).
<a name="2864"/> 2864:            A = [1024] = \&quot;\\x{400}\&quot;.
<a name="2865"/> 2865:            b().
<a name="2866"/> 2866:            h().&quot;&gt;&gt;,
<a name="2867"/> 2867: 
<a name="2868"/> 2868:     &quot;ok.\n\&quot;\x{400}\&quot;\nA = \&quot;\x{400}\&quot;.\nok.\n&quot;
<a name="2869"/> 2869:     &quot;1: io:setopts([{encoding, utf8}])\n-&gt; ok.\n&quot;
<a name="2870"/> 2870:     &quot;2: A = [1024] = \&quot;\x{400}\&quot;\n-&gt; \&quot;\x{400}\&quot;\n&quot;
<a name="2871"/> 2871:     &quot;3: b()\n-&gt; ok.\nok.\n&quot; = t({Node,Test4}),
<a name="2872"/> 2872: 
<a name="2873"/> 2873:     Test5 =
<a name="2874"/> 2874:         &lt;&lt;&quot;begin
<a name="2875"/> 2875:                io:setopts([{encoding,utf8}]),
<a name="2876"/> 2876:                results(0),
<a name="2877"/> 2877:                A = [1024] = \&quot;\\x{400}\&quot;,
<a name="2878"/> 2878:                b(),
<a name="2879"/> 2879:                h()
<a name="2880"/> 2880:            end.&quot;&gt;&gt;,
<a name="2881"/> 2881:     &quot;A = \&quot;\x{400}\&quot;.\nok.\n&quot; = t({Node,Test5}),
<a name="2882"/> 2882: 
<a name="2883"/> 2883:     %% One $&quot; is &quot;lost&quot;:
<a name="2884"/> 2884:     true =
<a name="2885"/> 2885:        &quot;\x{400}\&quot;: command not found&quot; =:=
<a name="2886"/> 2886:        prompt_err({Node,
<a name="2887"/> 2887:                    &lt;&lt;&quot;io:setopts([{encoding,utf8}]). v(\&quot;\x{400}\&quot;).&quot;/utf8&gt;&gt;,
<a name="2888"/> 2888:                    unicode}),
<a name="2889"/> 2889: 
<a name="2890"/> 2890:     &quot;ok.\ndefault\n* Bad prompt function: \&quot;\x{400}\&quot;.\n&quot; =
<a name="2891"/> 2891:         t({Node,&lt;&lt;&quot;io:setopts([{encoding,utf8}]). &quot;
<a name="2892"/> 2892:              &quot;shell:prompt_func(\&quot;\x{400}\&quot;).&quot;/utf8&gt;&gt;,
<a name="2893"/> 2893:            unicode}),
<a name="2894"/> 2894:     rpc:call(Node,shell, prompt_func, [default]),
<a name="2895"/> 2895:     _ = shell:prompt_func(default),
<a name="2896"/> 2896: 
<a name="2897"/> 2897:     %% Test erl_error:format_exception() (cf. OTP-6554)
<a name="2898"/> 2898:     Test6 =
<a name="2899"/> 2899:         &lt;&lt;&quot;begin
<a name="2900"/> 2900:                A = &lt;&lt;\&quot;\\xaa\&quot;&gt;&gt;,
<a name="2901"/> 2901:                S = lists:flatten(io_lib:format(\&quot;~p/~p.\&quot;, [A, A])),
<a name="2902"/> 2902:                {ok, Ts, _} = erl_scan:string(S, 1),
<a name="2903"/> 2903:                {ok, Es} = erl_parse:parse_exprs(Ts),
<a name="2904"/> 2904:                B = erl_eval:new_bindings(),
<a name="2905"/> 2905:                erl_eval:exprs(Es, B)
<a name="2906"/> 2906:            end.&quot;&gt;&gt;,
<a name="2907"/> 2907: 
<a name="2908"/> 2908:     &quot;** exception error: an error occurred when evaluating&quot;
<a name="2909"/> 2909:         &quot; an arithmetic expression\n     in operator  '/'/2\n&quot;
<a name="2910"/> 2910:         &quot;        called as &lt;&lt;\&quot;\xaa\&quot;&gt;&gt; / &lt;&lt;\&quot;\xaa\&quot;&gt;&gt;.\n&quot; = t(Test6),
<a name="2911"/> 2911:     Test7 =
<a name="2912"/> 2912:         &lt;&lt;&quot;io:setopts([{encoding,utf8}]).
<a name="2913"/> 2913:            A = &lt;&lt;\&quot;\\xaa\&quot;&gt;&gt;,
<a name="2914"/> 2914:            S = lists:flatten(io_lib:format(\&quot;~p/~p.\&quot;, [A, A])),
<a name="2915"/> 2915:            {ok, Ts, _} = erl_scan:string(S, 1),
<a name="2916"/> 2916:            {ok, Es} = erl_parse:parse_exprs(Ts),
<a name="2917"/> 2917:            B = erl_eval:new_bindings(),
<a name="2918"/> 2918:            erl_eval:exprs(Es, B).&quot;&gt;&gt;,
<a name="2919"/> 2919: 
<a name="2920"/> 2920:     &quot;ok.\n** exception error: an error occurred when evaluating&quot;
<a name="2921"/> 2921:         &quot; an arithmetic expression\n     in operator  '/'/2\n&quot;
<a name="2922"/> 2922:         &quot;        called as &lt;&lt;\&quot;ª\&quot;&gt;&gt; / &lt;&lt;\&quot;ª\&quot;&gt;&gt;.\n&quot; = t({Node,Test7}),
<a name="2923"/> 2923:     Test8 =
<a name="2924"/> 2924:         &lt;&lt;&quot;begin
<a name="2925"/> 2925:                A = [1089],
<a name="2926"/> 2926:                S = lists:flatten(io_lib:format(\&quot;~tp/~tp.\&quot;, [A, A])),
<a name="2927"/> 2927:                {ok, Ts, _} = erl_scan:string(S, 1),
<a name="2928"/> 2928:                {ok, Es} = erl_parse:parse_exprs(Ts),
<a name="2929"/> 2929:                B = erl_eval:new_bindings(),
<a name="2930"/> 2930:                erl_eval:exprs(Es, B)
<a name="2931"/> 2931:            end.&quot;&gt;&gt;,
<a name="2932"/> 2932:     &quot;** exception error: an error occurred when evaluating&quot;
<a name="2933"/> 2933:         &quot; an arithmetic expression\n     in operator  '/'/2\n&quot;
<a name="2934"/> 2934:         &quot;        called as [1089] / [1089].\n&quot; = t(Test8),
<a name="2935"/> 2935:     Test9 =
<a name="2936"/> 2936:         &lt;&lt;&quot;io:setopts([{encoding,utf8}]).
<a name="2937"/> 2937:            A = [1089],
<a name="2938"/> 2938:            S = lists:flatten(io_lib:format(\&quot;~tp/~tp.\&quot;, [A, A])),
<a name="2939"/> 2939:            {ok, Ts, _} = erl_scan:string(S, 1),
<a name="2940"/> 2940:            {ok, Es} = erl_parse:parse_exprs(Ts),
<a name="2941"/> 2941:            B = erl_eval:new_bindings(),
<a name="2942"/> 2942:            erl_eval:exprs(Es, B).&quot;&gt;&gt;,
<a name="2943"/> 2943: 
<a name="2944"/> 2944:     &quot;ok.\n** exception error: an error occurred when evaluating&quot;
<a name="2945"/> 2945:         &quot; an arithmetic expression\n     in operator  '/'/2\n&quot;
<a name="2946"/> 2946:         &quot;        called as \&quot;\x{441}\&quot; / \&quot;\x{441}\&quot;.\n&quot; = t({Node,Test9}),
<a name="2947"/> 2947:     Test10 =
<a name="2948"/> 2948:         &lt;&lt;&quot;A = {\&quot;1\\xaa\&quot;,
<a name="2949"/> 2949:            $\\xaa,
<a name="2950"/> 2950:            &lt;&lt; &lt;&lt;\&quot;hi\&quot;&gt;&gt;/binary &gt;&gt;,
<a name="2951"/> 2951:            &lt;&lt;\&quot;1\xaa\&quot;&gt;&gt;},
<a name="2952"/> 2952:            fun(a) -&gt; true end(A).&quot;&gt;&gt;,
<a name="2953"/> 2953:     &quot;** exception error: no function clause matching \n&quot;
<a name="2954"/> 2954:     &quot;                    erl_eval:'-inside-an-interpreted-fun-'&quot;
<a name="2955"/> 2955:     &quot;({\&quot;1\xc2\xaa\&quot;,170,&lt;&lt;\&quot;hi\&quot;&gt;&gt;,\n                                    &quot;
<a name="2956"/> 2956:     &quot;                        &lt;&lt;\&quot;1\xc2\xaa\&quot;&gt;&gt;}) .\n&quot; = t(Test10),
<a name="2957"/> 2957:     Test11 =
<a name="2958"/> 2958:         &lt;&lt;&quot;io:setopts([{encoding,utf8}]).
<a name="2959"/> 2959:            A = {\&quot;1\\xaa\&quot;,
<a name="2960"/> 2960:            $\\xaa,
<a name="2961"/> 2961:            &lt;&lt; &lt;&lt;\&quot;hi\&quot;&gt;&gt;/binary &gt;&gt;,
<a name="2962"/> 2962:            &lt;&lt;\&quot;1\xaa\&quot;&gt;&gt;},
<a name="2963"/> 2963:            fun(a) -&gt; true end(A).&quot;&gt;&gt;,
<a name="2964"/> 2964: 
<a name="2965"/> 2965:     &quot;ok.\n** exception error: no function clause matching \n&quot;
<a name="2966"/> 2966:     &quot;                    erl_eval:'-inside-an-interpreted-fun-'&quot;
<a name="2967"/> 2967:     &quot;({\&quot;1\xaa\&quot;,170,&lt;&lt;\&quot;hi\&quot;&gt;&gt;,\n                                           &quot;
<a name="2968"/> 2968:     &quot;                 &lt;&lt;\&quot;1\xaa\&quot;/utf8&gt;&gt;}) .\n&quot;  = t({Node,Test11}),
<a name="2969"/> 2969:     Test12 = &lt;&lt;&quot;fun(a, b) -&gt; false end(65, [1089]).&quot;&gt;&gt;,
<a name="2970"/> 2970:     &quot;** exception error: no function clause matching \n&quot;
<a name="2971"/> 2971:     &quot;                    erl_eval:'-inside-an-interpreted-fun-'(65,[1089])&quot;
<a name="2972"/> 2972:     &quot; .\n&quot; = t(Test12),
<a name="2973"/> 2973:     Test13 =
<a name="2974"/> 2974:         &lt;&lt;&quot;io:setopts([{encoding,utf8}]).
<a name="2975"/> 2975:            fun(a, b) -&gt; false end(65, [1089]).&quot;&gt;&gt;,
<a name="2976"/> 2976:     &quot;ok.\n** exception error: no function clause matching \n&quot;
<a name="2977"/> 2977:     &quot;                    erl_eval:'-inside-an-interpreted-fun-'(65,\&quot;\x{441}\&quot;)&quot;
<a name="2978"/> 2978:     &quot; .\n&quot; = t({Node,Test13}),
<a name="2979"/> 2979: 
<a name="2980"/> 2980:     %% Unicode atoms.
<a name="2981"/> 2981:     Test14 = &lt;&lt;&quot;'\\x{447}\\x{435}'().&quot;&gt;&gt;,
<a name="2982"/> 2982:     &quot;** exception error: undefined shell command '\\x{447}\\x{435}'/0.\n&quot; =
<a name="2983"/> 2983:         t(Test14),
<a name="2984"/> 2984:     Test15 = &lt;&lt;&quot;io:setopts([{encoding,utf8}]).
<a name="2985"/> 2985:                 '\\x{447}\\x{435}'().&quot;&gt;&gt;,
<a name="2986"/> 2986:     &quot;ok.\n** exception error: undefined shell command '\x{447}\x{435}'/0.\n&quot; =
<a name="2987"/> 2987:         t({Node,Test15}),
<a name="2988"/> 2988:     Test16 = &lt;&lt;&quot;shell_SUITE:'\\x{447}\\x{435}'().&quot;&gt;&gt;,
<a name="2989"/> 2989:     &quot;** exception error: undefined function &quot;
<a name="2990"/> 2990:    &quot;shell_SUITE:'\\x{447}\\x{435}'/0.\n&quot; = t(Test16),
<a name="2991"/> 2991:     Test17 = &lt;&lt;&quot;io:setopts([{encoding,utf8}]).
<a name="2992"/> 2992:                 shell_SUITE:'\\x{447}\\x{435}'().&quot;&gt;&gt;,
<a name="2993"/> 2993:     &quot;ok.\n** exception error: undefined function &quot;
<a name="2994"/> 2994:     &quot;shell_SUITE:'\x{447}\x{435}'/0.\n&quot; =
<a name="2995"/> 2995:         t({Node,Test17}),
<a name="2996"/> 2996:     peer:stop(Peer),
<a name="otp_10302-last_expr"/><a name="2997"/> 2997:     ok.
<a name="2998"/> 2998: 
<a name="otp_13719-1"/><a name="2999"/> 2999: <b>otp_13719</b>(Config) when is_list(Config) -&gt;
<a name="3000"/> 3000:     Test = &lt;&lt;&quot;-module(otp_13719).
<a name="3001"/> 3001:               -record(bar, {}).
<a name="3002"/> 3002:               -record(foo, {bar :: #bar{}}).&quot;&gt;&gt;,
<a name="3003"/> 3003:     File = filename(&quot;otp_13719.erl&quot;, Config),
<a name="3004"/> 3004:     Beam = filename(&quot;otp_13719.beam&quot;, Config),
<a name="3005"/> 3005:     ok = compile_file(Config, File, Test, []),
<a name="3006"/> 3006:     RR = &quot;rr(\&quot;&quot; ++ Beam ++ &quot;\&quot;). #foo{}.&quot;,
<a name="3007"/> 3007:     &quot;[bar,foo]\n#foo{bar = undefined}.\n&quot; = t(RR),
<a name="3008"/> 3008:     file:delete(filename(&quot;test.beam&quot;, Config)),
<a name="3009"/> 3009:     file:delete(File),
<a name="otp_13719-last_expr"/><a name="3010"/> 3010:     ok.
<a name="3011"/> 3011: 
<a name="otp_14285-1"/><a name="3012"/> 3012: <b>otp_14285</b>(Config) -&gt;
<a name="3013"/> 3013:     {ok, Peer, Node} = ?CT_PEER([&quot;-pa&quot;, proplists:get_value(priv_dir,Config),
<a name="3014"/> 3014:         &quot;+pc&quot;, &quot;unicode&quot;]),
<a name="3015"/> 3015:     Test1 =
<a name="3016"/> 3016:         &lt;&lt;&quot;begin
<a name="3017"/> 3017:                io:setopts([{encoding,utf8}]),
<a name="3018"/> 3018:                [1024] = atom_to_list('\\x{400}'),
<a name="3019"/> 3019:                rd('\\x{400}', {'\\x{400}' = '\\x{400}'}),
<a name="3020"/> 3020:                ok = rl('\\x{400}')
<a name="3021"/> 3021:            end.&quot;&gt;&gt;,
<a name="3022"/> 3022:     &quot;-record('\x{400}',{'\x{400}' = '\x{400}'}).\nok.\n&quot; =
<a name="3023"/> 3023:         t({Node,Test1}),
<a name="3024"/> 3024:     peer:stop(Peer),
<a name="otp_14285-last_expr"/><a name="3025"/> 3025:     ok.
<a name="3026"/> 3026: 
<a name="otp_14296-1"/><a name="3027"/> 3027: <b>otp_14296</b>(Config) when is_list(Config) -&gt;
<a name="3028"/> 3028:     fun() -&gt;
<a name="3029"/> 3029:             F = fun() -&gt; a end,
<a name="3030"/> 3030:             LocalFun = term_to_string(F),
<a name="3031"/> 3031:             S = LocalFun ++ &quot;.&quot;,
<a name="3032"/> 3032:             &quot;1:2: syntax error before: Fun&quot; = comm_err(S)
<a name="3033"/> 3033:     end(),
<a name="3034"/> 3034: 
<a name="3035"/> 3035:     fun() -&gt;
<a name="3036"/> 3036:             F = fun mod:func/1,
<a name="3037"/> 3037:             ExternalFun = term_to_string(F),
<a name="3038"/> 3038:             S = ExternalFun ++ &quot;.&quot;,
<a name="3039"/> 3039:             R = ExternalFun ++ &quot;.\n&quot;,
<a name="3040"/> 3040:             R = t(S)
<a name="3041"/> 3041:     end(),
<a name="3042"/> 3042: 
<a name="3043"/> 3043:     fun() -&gt;
<a name="3044"/> 3044:             UnknownPid = &quot;&lt;100000.0.0&gt;&quot;,
<a name="3045"/> 3045:             S = UnknownPid ++ &quot;.&quot;,
<a name="3046"/> 3046:             &quot;1:1: syntax error before: '&lt;'&quot; = comm_err(S)
<a name="3047"/> 3047:     end(),
<a name="3048"/> 3048: 
<a name="3049"/> 3049:     fun() -&gt;
<a name="3050"/> 3050:             KnownPid = term_to_string(self()),
<a name="3051"/> 3051:             S = KnownPid ++ &quot;.&quot;,
<a name="3052"/> 3052:             R = KnownPid ++ &quot;.\n&quot;,
<a name="3053"/> 3053:             R = t(S)
<a name="3054"/> 3054:     end(),
<a name="3055"/> 3055: 
<a name="3056"/> 3056:     fun() -&gt;
<a name="3057"/> 3057:             Port = open_port({spawn, &quot;erl -s erlang halt&quot;}, [{line,1}]),
<a name="3058"/> 3058:             KnownPort = erlang:port_to_list(Port),
<a name="3059"/> 3059:             S = KnownPort ++ &quot;.&quot;,
<a name="3060"/> 3060:             R = KnownPort ++ &quot;.\n&quot;,
<a name="3061"/> 3061:             R = t(S)
<a name="3062"/> 3062:     end(),
<a name="3063"/> 3063: 
<a name="3064"/> 3064:     fun() -&gt;
<a name="3065"/> 3065:             UnknownPort = &quot;#Port&lt;100000.0&gt;&quot;,
<a name="3066"/> 3066:             S = UnknownPort ++ &quot;.&quot;,
<a name="3067"/> 3067:             &quot;1:2: syntax error before: Port&quot; = comm_err(S)
<a name="3068"/> 3068:     end(),
<a name="3069"/> 3069: 
<a name="3070"/> 3070:     fun() -&gt;
<a name="3071"/> 3071:             UnknownRef = &quot;#Ref&lt;100000.0.0.0&gt;&quot;,
<a name="3072"/> 3072:             S = UnknownRef ++ &quot;.&quot;,
<a name="3073"/> 3073:             &quot;1:2: syntax error before: Ref&quot; = comm_err(S)
<a name="3074"/> 3074:     end(),
<a name="3075"/> 3075: 
<a name="3076"/> 3076:     fun() -&gt;
<a name="3077"/> 3077:             KnownRef = term_to_string(make_ref()),
<a name="3078"/> 3078:             S = KnownRef ++ &quot;.&quot;,
<a name="3079"/> 3079:             R = KnownRef ++ &quot;.\n&quot;,
<a name="3080"/> 3080:             R = t(S)
<a name="3081"/> 3081:     end(),
<a name="3082"/> 3082: 
<a name="3083"/> 3083:     %% Test erl_eval:extended_parse_term/1
<a name="3084"/> 3084:     TF = fun(S) -&gt;
<a name="3085"/> 3085:                  {ok, Ts, _} = erl_scan:string(S++&quot;.&quot;, 1, [text]),
<a name="3086"/> 3086:                  case erl_eval:extended_parse_term(Ts) of
<a name="3087"/> 3087:                      {ok, Term} -&gt; Term;
<a name="3088"/> 3088:                      {error, _}=Error -&gt; Error
<a name="3089"/> 3089:                  end
<a name="3090"/> 3090:          end,
<a name="3091"/> 3091:     Fun = fun m:f/1,
<a name="3092"/> 3092:     Fun = TF(term_to_string(Fun)),
<a name="3093"/> 3093:     Fun = TF(&quot;fun m:f/1&quot;),
<a name="3094"/> 3094:     Pid = self(),
<a name="3095"/> 3095:     Pid = TF(term_to_string(Pid)),
<a name="3096"/> 3096:     Ref = make_ref(),
<a name="3097"/> 3097:     Ref = TF(term_to_string(Ref)),
<a name="3098"/> 3098:     Term = {[10, a], {&quot;foo&quot;, []}, #{x =&gt; &lt;&lt;&quot;bar&quot;&gt;&gt;}},
<a name="3099"/> 3099:     Term = TF(lists:flatten(io_lib:format(&quot;~p&quot;, [Term]))),
<a name="3100"/> 3100:     {$a, F1, &quot;foo&quot;} = TF(&quot;{$a, 1.0, \&quot;foo\&quot;}&quot;),
<a name="3101"/> 3101:     true = is_float(F1),
<a name="3102"/> 3102:     3 = TF(&quot;+3&quot;),
<a name="3103"/> 3103:     $a = TF(&quot;+$a&quot;),
<a name="3104"/> 3104:     true = is_float(TF(&quot;+1.0&quot;)),
<a name="3105"/> 3105:     true  = -3 =:= TF(&quot;-3&quot;),
<a name="3106"/> 3106:     true = -$a =:= TF(&quot;-$a&quot;),
<a name="3107"/> 3107:     true = is_float(TF(&quot;-1.0&quot;)),
<a name="3108"/> 3108:     {error, {_, _, [&quot;syntax error&quot;++_|_]}} = TF(&quot;{1&quot;),
<a name="3109"/> 3109:     {error, {_,_,&quot;bad term&quot;}} = TF(&quot;fun() -&gt; foo end&quot;),
<a name="3110"/> 3110:     {error, {_,_,&quot;bad term&quot;}} = TF(&quot;1, 2&quot;),
<a name="otp_14296-last_expr"/><a name="3111"/> 3111:     ok.
<a name="3112"/> 3112: 
<a name="start_interactive-1"/><a name="3113"/> 3113: <b>start_interactive</b>(_Config) -&gt;
<a name="3114"/> 3114:     start_interactive_shell([]),
<a name="start_interactive-last_expr"/><a name="3115"/> 3115: <b>    start_interactive_shell</b>([&quot;-env&quot;,&quot;TERM&quot;,&quot;dumb&quot;]).
<a name="3116"/> 3116: 
<a name="start_interactive_shell-1"/><a name="3117"/> 3117: <b>start_interactive_shell</b>(ExtraArgs) -&gt;
<a name="3118"/> 3118: 
<a name="3119"/> 3119:     %% Basic test case
<a name="3120"/> 3120:     rtnode:run(
<a name="3121"/> 3121:       [{expect, &quot;eval_test&quot;},
<a name="3122"/> 3122:        {putline, &quot;test.&quot;},
<a name="3123"/> 3123:        {eval, fun() -&gt; shell:start_interactive() end},
<a name="3124"/> 3124:        {expect, &quot;1&gt;&quot;},
<a name="3125"/> 3125:        {expect, &quot;2&gt;&quot;},
<a name="3126"/> 3126:        {eval, fun() -&gt; {error,already_started} = shell:start_interactive(), ok end}
<a name="3127"/> 3127:       ],[],&quot;&quot;,[&quot;-noinput&quot;,&quot;-eval&quot;,&quot;io:format(\&quot;eval_test~n\&quot;)&quot;] ++ ExtraArgs),
<a name="3128"/> 3128: 
<a name="3129"/> 3129:     %% Test that custom MFA works
<a name="3130"/> 3130:     rtnode:run(
<a name="3131"/> 3131:       [{expect, &quot;eval_test&quot;},
<a name="3132"/> 3132:        {putline, &quot;test.&quot;},
<a name="3133"/> 3133:        {eval, fun() -&gt; shell:start_interactive({shell,start,[]}) end},
<a name="3134"/> 3134:        {expect, &quot;1&gt;&quot;},
<a name="3135"/> 3135:        {expect, &quot;2&gt;&quot;}
<a name="3136"/> 3136:       ],[],&quot;&quot;,[&quot;-noinput&quot;,&quot;-eval&quot;,&quot;io:format(\&quot;eval_test~n\&quot;)&quot;] ++ ExtraArgs),
<a name="3137"/> 3137: 
<a name="3138"/> 3138:     %% Test that we can start noshell and then a shell
<a name="3139"/> 3139:     rtnode:run(
<a name="3140"/> 3140:       [{expect, &quot;eval_test&quot;},
<a name="3141"/> 3141:        {putline, &quot;test.&quot;},
<a name="3142"/> 3142:        {eval, fun() -&gt; shell:start_interactive(noshell) end},
<a name="3143"/> 3143:        {eval, fun() -&gt; io:format(user,&quot;~ts&quot;,[io:get_line(user, &quot;&quot;)]) end},
<a name="3144"/> 3144:        {expect, &quot;test\\.&quot;},
<a name="3145"/> 3145:        {eval, fun() -&gt; shell:start_interactive() end},
<a name="3146"/> 3146:        {expect, &quot;1&gt;&quot;},
<a name="3147"/> 3147:        {putline, &quot;test.&quot;},
<a name="3148"/> 3148:        {expect, &quot;2&gt;&quot;}
<a name="3149"/> 3149:       ],[],&quot;&quot;,[&quot;-noinput&quot;,&quot;-eval&quot;,&quot;io:format(\&quot;eval_test~n\&quot;)&quot;] ++ ExtraArgs),
<a name="3150"/> 3150: 
<a name="3151"/> 3151:     %% Test that we can start various remote shell combos
<a name="3152"/> 3152:     [ begin
<a name="3153"/> 3153:           {ok, Peer, Node} = ?CT_PEER(),
<a name="3154"/> 3154:           SNode = atom_to_list(Node),
<a name="3155"/> 3155:           rtnode:run(
<a name="3156"/> 3156:             [{expect, &quot;eval_test&quot;},
<a name="3157"/> 3157:              {putline, &quot;test.&quot;},
<a name="3158"/> 3158:              {eval, fun() -&gt; shell:start_interactive(Arg(Node)) end},
<a name="3159"/> 3159:              {expect, &quot;\\Q(&quot;++SNode++&quot;)\\E2&gt;&quot;}
<a name="3160"/> 3160:             ] ++ quit_hosting_node(),
<a name="3161"/> 3161:             [],&quot;&quot;,[&quot;-noinput&quot;,&quot;-eval&quot;,&quot;io:format(\&quot;eval_test~n\&quot;)&quot;] ++ ExtraArgs),
<a name="3162"/> 3162:           peer:stop(Peer)
<a name="3163"/> 3163:       end || Arg &lt;- [fun(Node) -&gt; {Node, {shell,start,[]}} end,
<a name="3164"/> 3164:                      fun(Node) -&gt; {remote, atom_to_list(Node)} end,
<a name="3165"/> 3165:                      fun(Node) -&gt; {remote, hd(string:split(atom_to_list(Node),&quot;@&quot;))} end,
<a name="3166"/> 3166:                      fun(Node) -&gt; {remote, atom_to_list(Node), {shell,start,[]}} end
<a name="3167"/> 3167:                     ]],
<a name="3168"/> 3168: 
<a name="3169"/> 3169:     %% Test that errors work as they should
<a name="3170"/> 3170:     {ok, Peer, Node} = ?CT_PEER(),
<a name="3171"/> 3171:     rtnode:run(
<a name="3172"/> 3172:       [{expect, &quot;eval_test&quot;},
<a name="3173"/> 3173:        {eval, fun() -&gt;
<a name="3174"/> 3174:                       {error,noconnection} = shell:start_interactive(
<a name="3175"/> 3175:                                                {remote,&quot;invalid_node&quot;}),
<a name="3176"/> 3176:                       {error,noconnection} = shell:start_interactive(
<a name="3177"/> 3177:                                                {remote,&quot;invalid_node&quot;,
<a name="3178"/> 3178:                                                 {invalid_module, start, []}}),
<a name="3179"/> 3179:                       {error,nofile} = shell:start_interactive(
<a name="3180"/> 3180:                                          {remote,atom_to_list(Node),
<a name="3181"/> 3181:                                           {invalid_module, start, []}}),
<a name="3182"/> 3182:                       shell:start_interactive({remote, atom_to_list(Node)})
<a name="3183"/> 3183:               end},
<a name="3184"/> 3184:        {expect, &quot;1&gt; $&quot;}
<a name="3185"/> 3185:       ] ++ quit_hosting_node(),
<a name="3186"/> 3186:       [],&quot;&quot;,[&quot;-noinput&quot;,&quot;-eval&quot;,&quot;io:format(\&quot;eval_test~n\&quot;)&quot;] ++ ExtraArgs),
<a name="3187"/> 3187:     peer:stop(Peer),
<a name="3188"/> 3188: 
<a name="start_interactive_shell-last_expr"/><a name="3189"/> 3189:     ok.
<a name="3190"/> 3190: 
<a name="whereis-1"/><a name="3191"/> 3191: <b>whereis</b>(_Config) -&gt;
<a name="3192"/> 3192:     Proxy = spawn_link(
<a name="3193"/> 3193:               fun() -&gt;
<a name="3194"/> 3194:                       (fun F(P) -&gt;
<a name="3195"/> 3195:                                receive
<a name="3196"/> 3196:                                    {set,NewPid} -&gt;
<a name="3197"/> 3197:                                        F(NewPid);
<a name="3198"/> 3198:                                    {get,From} -&gt;
<a name="3199"/> 3199:                                        From ! P,
<a name="3200"/> 3200:                                        F(P)
<a name="3201"/> 3201:                                end
<a name="3202"/> 3202:                        end)(undefined)
<a name="3203"/> 3203:               end),
<a name="3204"/> 3204: 
<a name="3205"/> 3205:     %% Test that shell:whereis() works with JCL in newshell
<a name="3206"/> 3206:     rtnode:run(
<a name="3207"/> 3207:       [{expect,&quot;1&gt; $&quot;},
<a name="3208"/> 3208:        {putline,&quot;shell:whereis().&quot;},
<a name="3209"/> 3209:        {expect,&quot;2&gt; $&quot;},
<a name="3210"/> 3210:        {eval,fun() -&gt;
<a name="3211"/> 3211:                      group_leader(erlang:whereis(user),self()),
<a name="3212"/> 3212:                      Proxy ! {set,shell:whereis()},
<a name="3213"/> 3213:                      ok
<a name="3214"/> 3214:              end},
<a name="3215"/> 3215:        {putline,&quot;\^g&quot;},
<a name="3216"/> 3216:        {expect,  &quot;--&gt; $&quot;},
<a name="3217"/> 3217:        {putline, &quot;s&quot;},
<a name="3218"/> 3218:        {expect,  &quot;--&gt; $&quot;},
<a name="3219"/> 3219:        {putline, &quot;c&quot;},
<a name="3220"/> 3220:        {expect,  &quot;\r\nEshell&quot;},
<a name="3221"/> 3221:        {putline,&quot;shell:whereis().&quot;},
<a name="3222"/> 3222:        {expect,&quot;2&gt; $&quot;},
<a name="3223"/> 3223:        {eval,fun() -&gt;
<a name="3224"/> 3224:                      group_leader(erlang:whereis(user),self()),
<a name="3225"/> 3225:                      Proxy ! {get, self()},
<a name="3226"/> 3226:                      receive PrevPid -&gt; PrevPid end,
<a name="3227"/> 3227:                      io:format(&quot;~p =:= ~p~n&quot;,[PrevPid, shell:whereis()]),
<a name="3228"/> 3228:                      false = PrevPid =:= shell:whereis(),
<a name="3229"/> 3229:                      ok
<a name="3230"/> 3230:              end},
<a name="3231"/> 3231:        {putline,&quot;\^g&quot;},
<a name="3232"/> 3232:        {expect,  &quot;--&gt; $&quot;},
<a name="3233"/> 3233:        {putline, &quot;c 1&quot;},
<a name="3234"/> 3234:        {expect, &quot;\r\n&quot;},
<a name="3235"/> 3235:        {putline, &quot;&quot;},
<a name="3236"/> 3236:        {expect, &quot;2&gt; $&quot;},
<a name="3237"/> 3237:        {eval,fun() -&gt;
<a name="3238"/> 3238:                      group_leader(erlang:whereis(user),self()),
<a name="3239"/> 3239:                      Proxy ! {get, self()},
<a name="3240"/> 3240:                      receive PrevPid -&gt; PrevPid end,
<a name="3241"/> 3241:                      true = PrevPid =:= shell:whereis(),
<a name="3242"/> 3242:                      ok
<a name="3243"/> 3243:              end}]),
<a name="3244"/> 3244: 
<a name="3245"/> 3245:     %% Test that shell:whereis() works in oldshell
<a name="3246"/> 3246:     rtnode:run(
<a name="3247"/> 3247:       [{expect,&quot;1&gt;&quot;},
<a name="3248"/> 3248:        {eval,fun() -&gt;
<a name="3249"/> 3249:                      group_leader(erlang:whereis(user),self()),
<a name="3250"/> 3250:                      true = is_pid(shell:whereis()),
<a name="3251"/> 3251:                      ok
<a name="3252"/> 3252:              end}],
<a name="3253"/> 3253:      [],&quot;&quot;,[&quot;-env&quot;,&quot;TERM&quot;,&quot;dumb&quot;]),
<a name="3254"/> 3254: 
<a name="3255"/> 3255:     %% Test that noinput and noshell gives undefined shell process
<a name="3256"/> 3256:     rtnode:run(
<a name="3257"/> 3257:       [{eval,fun() -&gt;
<a name="3258"/> 3258:                      group_leader(erlang:whereis(user),self()),
<a name="3259"/> 3259:                      undefined = shell:whereis(),
<a name="3260"/> 3260:                      ok
<a name="3261"/> 3261:              end}],
<a name="3262"/> 3262:       [],&quot;&quot;,[&quot;-noinput&quot;]),
<a name="3263"/> 3263:     rtnode:run(
<a name="3264"/> 3264:       [{eval,fun() -&gt;
<a name="3265"/> 3265:                      group_leader(erlang:whereis(user),self()),
<a name="3266"/> 3266:                      undefined = shell:whereis(),
<a name="3267"/> 3267:                      ok
<a name="3268"/> 3268:              end}],
<a name="3269"/> 3269:       [],&quot;&quot;,[&quot;-noshell&quot;]),
<a name="3270"/> 3270: 
<a name="3271"/> 3271:     %% Test that remsh gives the correct shell process
<a name="3272"/> 3272:     {ok, Peer, Node} = ?CT_PEER(),
<a name="3273"/> 3273:     NodeStr = lists:flatten(io_lib:format(&quot;~w&quot;,[Node])),
<a name="3274"/> 3274:     rtnode:run(
<a name="3275"/> 3275:       [{expect, &quot;1&gt;&quot;},
<a name="3276"/> 3276:        {putline,&quot;shell:whereis().&quot;},
<a name="3277"/> 3277:        {expect,&quot;\n&lt;0[.]&quot;},
<a name="3278"/> 3278:        {expect, &quot;2&gt;&quot;},
<a name="3279"/> 3279:        {eval, fun() -&gt;
<a name="3280"/> 3280:                       group_leader(erlang:whereis(user),self()),
<a name="3281"/> 3281:                       true = Node =:= node(shell:whereis()),
<a name="3282"/> 3282:                       ok
<a name="3283"/> 3283:               end}] ++ quit_hosting_node(),
<a name="3284"/> 3284:       peer:random_name(?FUNCTION_NAME), &quot; &quot;, &quot;-remsh &quot; ++ NodeStr  ++
<a name="3285"/> 3285:           &quot; -pa &quot; ++ filename:dirname(code:which(?MODULE))),
<a name="3286"/> 3286: 
<a name="3287"/> 3287:     peer:stop(Peer),
<a name="3288"/> 3288: 
<a name="whereis-last_expr"/><a name="3289"/> 3289:     ok.
<a name="3290"/> 3290: 
<a name="quit_hosting_node-0"/><a name="3291"/> 3291: <b>quit_hosting_node</b>() -&gt;
<a name="quit_hosting_node-last_expr"/><a name="3292"/> 3292:     [{putline, &quot;\^g&quot;},
<a name="3293"/> 3293:      {expect, &quot;--&gt; $&quot;},
<a name="3294"/> 3294:      {putline, &quot;s&quot;},
<a name="3295"/> 3295:      {expect, &quot;--&gt; $&quot;},
<a name="3296"/> 3296:      {putline, &quot;c&quot;},
<a name="3297"/> 3297:      {expect, [&quot;Eshell&quot;]},
<a name="3298"/> 3298:      {expect, [&quot;1&gt; $&quot;]}].
<a name="3299"/> 3299: 
<a name="term_to_string-1"/><a name="3300"/> 3300: <b>term_to_string</b>(T) -&gt;
<a name="term_to_string-last_expr"/><a name="3301"/> 3301: <b>    lists:flatten</b>(io_lib:format(&quot;~w&quot;, [T])).
<a name="3302"/> 3302: 
<a name="scan-1"/><a name="3303"/> 3303: <b>scan</b>(B) -&gt;
<a name="3304"/> 3304:     F = fun(Ts) -&gt;
<a name="3305"/> 3305:                 case erl_parse:parse_term(Ts) of
<a name="3306"/> 3306:                     {ok,Term} -&gt;
<a name="3307"/> 3307:                         Term;
<a name="3308"/> 3308:                     _Error -&gt;
<a name="3309"/> 3309:                         {ok,Form} = erl_parse:parse_form(Ts),
<a name="3310"/> 3310:                         Form
<a name="3311"/> 3311:                 end
<a name="3312"/> 3312:         end,
<a name="scan-last_expr"/><a name="3313"/> 3313: <b>    scan</b>(t(B), F).
<a name="3314"/> 3314: 
<a name="scan-2"/><a name="3315"/> 3315: <b>scan</b>(S0, F) -&gt;
<a name="scan-last_expr"/><a name="3316"/> 3316: <b>    case erl_scan:tokens</b>([], S0, 1) of
<a name="3317"/> 3317:         {done,{ok,Ts,_},S} -&gt;
<a name="3318"/> 3318:             [F(Ts) | scan(S, F)];
<a name="3319"/> 3319:         _Else -&gt;
<a name="3320"/> 3320:             []
<a name="3321"/> 3321:     end.
<a name="3322"/> 3322: 
<a name="t-1"/><a name="3323"/> 3323: <b>t</b>({Node,Bin,Enc}) when is_atom(Node),is_binary(Bin), is_atom(Enc) -&gt;
<a name="3324"/> 3324:     t0({Bin,Enc}, fun() -&gt; start_new_shell(Node) end);
<a name="3325"/> 3325: <b>t</b>({Node,Bin}) when is_atom(Node),is_binary(Bin) -&gt;
<a name="3326"/> 3326:     t0({Bin,latin1}, fun() -&gt; start_new_shell(Node) end);
<a name="3327"/> 3327: <b>t</b>(Bin) when is_binary(Bin) -&gt;
<a name="3328"/> 3328:     t0({Bin,latin1}, fun() -&gt; start_new_shell() end);
<a name="3329"/> 3329: <b>t</b>({Bin,Enc}) when is_binary(Bin), is_atom(Enc) -&gt;
<a name="3330"/> 3330:     t0({Bin,Enc}, fun() -&gt; start_new_shell() end);
<a name="3331"/> 3331: <b>t</b>(L) -&gt;
<a name="t-last_expr"/><a name="3332"/> 3332: <b>    t</b>(list_to_binary(L)).
<a name="3333"/> 3333: 
<a name="t0-2"/><a name="3334"/> 3334: <b>t0</b>({Bin,Enc}, F) -&gt;
<a name="3335"/> 3335:     %% Spawn a process so that io_request messages do not interfer.
<a name="3336"/> 3336:     P = self(),
<a name="3337"/> 3337:     C = spawn(fun() -&gt; t1(P, {Bin, Enc}, F) end),
<a name="t0-last_expr"/><a name="3338"/> 3338:     receive {C, R} -&gt; R end.
<a name="3339"/> 3339: 
<a name="t1-3"/><a name="3340"/> 3340: <b>t1</b>(Parent, {Bin,Enc}, F) -&gt;
<a name="3341"/> 3341:     io:format(&quot;*** Testing ~s~n&quot;, [binary_to_list(Bin)]),
<a name="3342"/> 3342:     S = #state{bin = Bin, unic = Enc, reply = [], leader = group_leader()},
<a name="3343"/> 3343:     group_leader(self(), self()),
<a name="3344"/> 3344:     _Shell = F(),
<a name="t1-last_expr"/><a name="3345"/> 3345:     try
<a name="3346"/> 3346:         server_loop(S)
<a name="3347"/> 3347:     catch exit:R -&gt; Parent ! {self(), R};
<a name="3348"/> 3348:           throw:{?MODULE,LoopReply,latin1} -&gt;
<a name="3349"/> 3349:             L0 = binary_to_list(list_to_binary(LoopReply)),
<a name="3350"/> 3350:             [$\n | L1] = lists:dropwhile(fun(X) -&gt; X =/= $\n end, L0),
<a name="3351"/> 3351:             Parent ! {self(), dotify(L1)};
<a name="3352"/> 3352:           throw:{?MODULE,LoopReply,_Uni} -&gt;
<a name="3353"/> 3353:             Tmp = unicode:characters_to_binary(LoopReply),
<a name="3354"/> 3354:             L0 = unicode:characters_to_list(Tmp),
<a name="3355"/> 3355:             [$\n | L1] = lists:dropwhile(fun(X) -&gt; X =/= $\n end, L0),
<a name="3356"/> 3356:             Parent ! {self(), dotify(L1)}
<a name="3357"/> 3357:     after group_leader(S#state.leader, self())
<a name="3358"/> 3358:     end.
<a name="3359"/> 3359: 
<a name="dotify-1"/><a name="3360"/> 3360: <b>dotify</b>([$., $\n | L]) -&gt;
<a name="3361"/> 3361:     [$., $\n | dotify(L)];
<a name="3362"/> 3362: <b>dotify</b>([$,, $\n | L]) -&gt;
<a name="3363"/> 3363:     [$,, $\n | dotify(L)];
<a name="3364"/> 3364: <b>dotify</b>(&quot;ok\n&quot; ++ L) -&gt;
<a name="3365"/> 3365:     &quot;ok.\n&quot; ++ dotify(L);
<a name="3366"/> 3366: <b>dotify</b>(&quot;\nok\n&quot; ++ L) -&gt;
<a name="3367"/> 3367:     &quot;.\nok.\n&quot; ++ dotify(L);
<a name="3368"/> 3368: <b>dotify</b>([$\n]) -&gt;
<a name="3369"/> 3369:     [$., $\n];
<a name="3370"/> 3370: <b>dotify</b>([C | L]) -&gt;
<a name="3371"/> 3371:     [C | dotify(L)];
<a name="3372"/> 3372: <b>dotify</b>([]) -&gt;
<a name="dotify-last_expr"/><a name="3373"/> 3373:     [].
<a name="3374"/> 3374: 
<a name="start_new_shell-0"/><a name="3375"/> 3375: <b>start_new_shell</b>() -&gt;
<a name="3376"/> 3376:     Shell = shell:start(),
<a name="3377"/> 3377:     link(Shell),
<a name="start_new_shell-last_expr"/><a name="3378"/> 3378:     Shell.
<a name="3379"/> 3379: 
<a name="start_new_shell-1"/><a name="3380"/> 3380: <b>start_new_shell</b>(Node) -&gt;
<a name="3381"/> 3381:     Shell = rpc:call(Node,shell,start,[]),
<a name="3382"/> 3382:     link(Shell),
<a name="start_new_shell-last_expr"/><a name="3383"/> 3383:     Shell.
<a name="3384"/> 3384: 
<a name="3385"/> 3385: <i>%% This is a very minimal implementation of the IO protocol...</i>
<a name="3386"/> 3386: 
<a name="server_loop-1"/><a name="3387"/> 3387: <b>server_loop</b>(S) -&gt;
<a name="server_loop-last_expr"/><a name="3388"/> 3388:     receive
<a name="3389"/> 3389:         {io_request, From, ReplyAs, Request} when is_pid(From) -&gt;
<a name="3390"/> 3390:             server_loop(do_io_request(Request, From, S, ReplyAs));
<a name="3391"/> 3391:         NotExpected -&gt;
<a name="3392"/> 3392:             exit(NotExpected)
<a name="3393"/> 3393:     end.
<a name="3394"/> 3394: 
<a name="do_io_request-4"/><a name="3395"/> 3395: <b>do_io_request</b>(Req, From, S, ReplyAs) -&gt;
<a name="do_io_request-last_expr"/><a name="3396"/> 3396: <b>    case io_requests</b>([Req], [], S) of
<a name="3397"/> 3397:         {_Status,{eof,_},S1} -&gt;
<a name="3398"/> 3398:             io_reply(From, ReplyAs, {error,terminated}),
<a name="3399"/> 3399:             throw({?MODULE,S1#state.reply,S1#state.unic});
<a name="3400"/> 3400:     {_Status,Reply,S1} -&gt;
<a name="3401"/> 3401:         io_reply(From, ReplyAs, Reply),
<a name="3402"/> 3402: 	    S1
<a name="3403"/> 3403:     end.
<a name="3404"/> 3404: 
<a name="io_reply-3"/><a name="3405"/> 3405: <b>io_reply</b>(From, ReplyAs, Reply) -&gt;
<a name="io_reply-last_expr"/><a name="3406"/> 3406:     From ! {io_reply, ReplyAs, Reply}.
<a name="3407"/> 3407: 
<a name="io_requests-3"/><a name="3408"/> 3408: <b>io_requests</b>([{requests, Rs1} | Rs], Cont, S) -&gt;
<a name="3409"/> 3409:     io_requests(Rs1, [Rs | Cont], S);
<a name="3410"/> 3410: <b>io_requests</b>([R | Rs], Cont, S) -&gt;
<a name="3411"/> 3411:     case io_request(R, S) of
<a name="3412"/> 3412:         {ok, ok, S1} -&gt;
<a name="3413"/> 3413:             io_requests(Rs, Cont, S1);
<a name="3414"/> 3414:         Reply -&gt;
<a name="3415"/> 3415:             Reply
<a name="3416"/> 3416:     end;
<a name="3417"/> 3417: <b>io_requests</b>([], [Rs|Cont], S) -&gt;
<a name="3418"/> 3418:     io_requests(Rs, Cont, S);
<a name="3419"/> 3419: <b>io_requests</b>([], [], S) -&gt;
<a name="io_requests-last_expr"/><a name="3420"/> 3420:     {ok,ok,S}.
<a name="3421"/> 3421: 
<a name="io_request-2"/><a name="3422"/> 3422: <b>io_request</b>({setopts, Opts}, S) -&gt;
<a name="3423"/> 3423:     #state{unic = OldEnc, bin = Bin} = S,
<a name="3424"/> 3424:     NewEnc = case proplists:get_value(encoding, Opts) of
<a name="3425"/> 3425:                  undefined -&gt; OldEnc;
<a name="3426"/> 3426:                  utf8 -&gt; unicode;
<a name="3427"/> 3427:                  New -&gt; New
<a name="3428"/> 3428:              end,
<a name="3429"/> 3429:     NewBin = case {OldEnc, NewEnc} of
<a name="3430"/> 3430:                  {E, E} -&gt; Bin;
<a name="3431"/> 3431:                  {latin1, _} -&gt;
<a name="3432"/> 3432:                      unicode:characters_to_binary(Bin, latin1, unicode);
<a name="3433"/> 3433:                  {_, latin1} -&gt;
<a name="3434"/> 3434:                      unicode:characters_to_binary(Bin, unicode, latin1);
<a name="3435"/> 3435:                  {_, _} -&gt; Bin
<a name="3436"/> 3436:              end,
<a name="3437"/> 3437:     {ok, ok, S#state{unic = NewEnc, bin = NewBin}};
<a name="3438"/> 3438: <b>io_request</b>(getopts, S) -&gt;
<a name="3439"/> 3439:     {ok,[{encoding,S#state.unic}],S};
<a name="3440"/> 3440: <b>io_request</b>({get_geometry,columns}, S) -&gt;
<a name="3441"/> 3441:     {ok,80,S};
<a name="3442"/> 3442: <b>io_request</b>({get_geometry,rows}, S) -&gt;
<a name="3443"/> 3443:     {ok,24,S};
<a name="3444"/> 3444: <b>io_request</b>({put_chars,latin1,Chars}, S) -&gt;
<a name="3445"/> 3445:     {ok,ok,S#state{reply = [S#state.reply | Chars]}};
<a name="3446"/> 3446: <b>io_request</b>({put_chars,unicode,Chars0}, S) -&gt;
<a name="3447"/> 3447:     Chars = unicode:characters_to_list(Chars0),
<a name="3448"/> 3448:     {ok,ok,S#state{reply = [S#state.reply | Chars]}};
<a name="3449"/> 3449: <b>io_request</b>({put_chars,Enc,Mod,Func,Args}, S) -&gt;
<a name="3450"/> 3450:     case catch apply(Mod, Func, Args) of
<a name="3451"/> 3451:         Chars when is_list(Chars) -&gt;
<a name="3452"/> 3452:             io_request({put_chars,Enc,Chars}, S)
<a name="3453"/> 3453:     end;
<a name="3454"/> 3454: <b>io_request</b>({get_until,Enc,_Prompt,Mod,Func,ExtraArgs}, S) -&gt;
<a name="io_request-last_expr"/><a name="3455"/> 3455: <b>    get_until</b>(Mod, Func, ExtraArgs, S, Enc).
<a name="3456"/> 3456: 
<a name="get_until-5"/><a name="3457"/> 3457: <b>get_until</b>(Mod, Func, ExtraArgs, S, Enc) -&gt;
<a name="get_until-last_expr"/><a name="3458"/> 3458: <b>    get_until_loop</b>(Mod, Func, ExtraArgs, S, {more,[]}, Enc).
<a name="3459"/> 3459: 
<a name="get_until_loop-6"/><a name="3460"/> 3460: <b>get_until_loop</b>(M, F, As, S, {more,Cont}, Enc) -&gt;
<a name="3461"/> 3461:     Bin = S#state.bin,
<a name="3462"/> 3462:     case byte_size(Bin) of
<a name="3463"/> 3463:         0 -&gt;
<a name="3464"/> 3464:             get_until_loop(M, F, As, S,
<a name="3465"/> 3465:                            catch apply(M, F, [Cont,eof|As]), Enc);
<a name="3466"/> 3466: 	_ when S#state.unic =:= latin1 -&gt;
<a name="3467"/> 3467: 	    get_until_loop(M, F, As, S#state{bin = &lt;&lt;&gt;&gt;},
<a name="3468"/> 3468: 			   catch apply(M, F, [Cont,binary_to_list(Bin)|As]), Enc);
<a name="3469"/> 3469: 	_ -&gt;
<a name="3470"/> 3470: 	    get_until_loop(M, F, As, S#state{bin = &lt;&lt;&gt;&gt;},
<a name="3471"/> 3471: 			   catch apply(M, F, [Cont,unicode:characters_to_list(Bin)|As]), Enc)
<a name="3472"/> 3472:     end;
<a name="3473"/> 3473: <b>get_until_loop</b>(_M, _F, _As, S, {done,Res,Buf}, Enc) -&gt;
<a name="3474"/> 3474:     {ok,Res,S#state{bin = buf2bin(Buf, Enc)}};
<a name="3475"/> 3475: <b>get_until_loop</b>(_M, F, _As, S, _Other, _Enc) -&gt;
<a name="get_until_loop-last_expr"/><a name="3476"/> 3476:     {error,{error,F},S}.
<a name="3477"/> 3477: 
<a name="buf2bin-2"/><a name="3478"/> 3478: <b>buf2bin</b>(eof,_) -&gt;
<a name="3479"/> 3479:     &lt;&lt;&gt;&gt;;
<a name="3480"/> 3480: <b>buf2bin</b>(Buf,latin1) -&gt;
<a name="3481"/> 3481:     list_to_binary(Buf);
<a name="3482"/> 3482: <b>buf2bin</b>(Buf,utf8) -&gt;
<a name="3483"/> 3483:     unicode:characters_to_binary(Buf,unicode,unicode);
<a name="3484"/> 3484: <b>buf2bin</b>(Buf,unicode) -&gt;
<a name="buf2bin-last_expr"/><a name="3485"/> 3485: <b>    unicode:characters_to_binary</b>(Buf,unicode,unicode).
<a name="3486"/> 3486: 
<a name="run_file-3"/><a name="3487"/> 3487: <b>run_file</b>(Config, Module, Test) -&gt;
<a name="3488"/> 3488:     FileName = filename(lists:concat([Module, &quot;.erl&quot;]), Config),
<a name="3489"/> 3489:     BeamFile = filename(lists:concat([Module, &quot;.beam&quot;]), Config),
<a name="3490"/> 3490:     LoadBeamFile = filename(Module, Config),
<a name="3491"/> 3491:     ok = file:write_file(FileName, Test),
<a name="3492"/> 3492:     ok = compile_file(Config, FileName, Test, []),
<a name="3493"/> 3493:     code:purge(Module),
<a name="3494"/> 3494:     {module, Module} = code:load_abs(LoadBeamFile),
<a name="3495"/> 3495:     ok = Module:t(),
<a name="3496"/> 3496:     file:delete(FileName),
<a name="3497"/> 3497:     file:delete(BeamFile),
<a name="run_file-last_expr"/><a name="3498"/> 3498:     ok.
<a name="3499"/> 3499: 
<a name="compile_file-4"/><a name="3500"/> 3500: <b>compile_file</b>(Config, File, Test, Opts0) -&gt;
<a name="3501"/> 3501:     Opts = [export_all,nowarn_export_all,return,{outdir,proplists:get_value(priv_dir, Config)}|Opts0],
<a name="3502"/> 3502:     ok = file:write_file(File, Test),
<a name="compile_file-last_expr"/><a name="3503"/> 3503: <b>    case compile:file</b>(File, Opts) of
<a name="3504"/> 3504:               {ok, _M, _Ws} -&gt; ok;
<a name="3505"/> 3505:               _ -&gt; error
<a name="3506"/> 3506:           end.
<a name="3507"/> 3507: 
<a name="filename-2"/><a name="3508"/> 3508: <b>filename</b>(Name, Config) when is_atom(Name) -&gt;
<a name="3509"/> 3509:     filename(atom_to_list(Name), Config);
<a name="3510"/> 3510: <b>filename</b>(Name, Config) -&gt;
<a name="filename-last_expr"/><a name="3511"/> 3511: <b>    filename:join</b>(proplists:get_value(priv_dir, Config), Name).
<a name="3512"/> 3512: 
<a name="purge_and_delete-1"/><a name="3513"/> 3513: <b>purge_and_delete</b>(Module) -&gt;
<a name="3514"/> 3514:     (catch code:purge(Module)),
<a name="purge_and_delete-last_expr"/><a name="3515"/> 3515: <b>    </b>(catch code:delete(Module)).
</pre>
</body>
</html>
