<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<!-- autogenerated by 'erl2html2'. -->
<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8"/></meta>
<title>/buildroot/otp/lib/compiler/make_test_dir/compiler_test/beam_doc_SUITE.erl</title>
</head>

<body bgcolor="white" text="black" link="blue" vlink="purple" alink="red">
<pre>
<a name="1"/>    1: 
<a name="2"/>    2: <b>-module</b>(beam_doc_SUITE).
<a name="3"/>    3: <b>-export</b>([all/0, groups/0, init_per_group/2, end_per_group/2, singleton_moduledoc/1, singleton_doc/1,
<a name="4"/>    4:          docmodule_with_doc_attributes/1, hide_moduledoc/1, docformat/1,
<a name="5"/>    5:          singleton_docformat/1, singleton_meta/1, slogan/1,
<a name="6"/>    6:          types_and_opaques/1, callback/1, hide_moduledoc2/1,
<a name="7"/>    7:          private_types/1, export_all/1, equiv/1, spec/1, deprecated/1, warn_missing_doc/1,
<a name="8"/>    8:          doc_with_file/1, doc_with_file_error/1, all_string_formats/1,
<a name="9"/>    9:          docs_from_ast/1, spec_switch_order/1, user_defined_type/1, skip_doc/1]).
<a name="10"/>   10: 
<a name="11"/>   11: <b>-include_lib</b>(&quot;common_test/include/ct.hrl&quot;).
<a name="12"/>   12: <b>-include_lib</b>(&quot;kernel/include/eep48.hrl&quot;).
<a name="13"/>   13: <b>-include_lib</b>(&quot;stdlib/include/assert.hrl&quot;).
<a name="14"/>   14: 
<a name="15"/>   15: <b>-define</b>(get_name(), atom_to_list(?FUNCTION_NAME)).
<a name="16"/>   16: 
<a name="all-0"/><a name="17"/>   17: <b>all</b>() -&gt;
<a name="all-last_expr"/><a name="18"/>   18:     [{group, documentation_generation_tests}, doc_with_file].
<a name="19"/>   19: 
<a name="groups-0"/><a name="20"/>   20: <b>groups</b>() -&gt;
<a name="groups-last_expr"/><a name="21"/>   21: <b>    [{documentation_generation_tests, [parallel], documentation_generation_tests</b>()}].
<a name="22"/>   22: 
<a name="init_per_group-2"/><a name="23"/>   23: <b>init_per_group</b>(_, Config) -&gt;
<a name="init_per_group-last_expr"/><a name="24"/>   24:     Config.
<a name="25"/>   25: 
<a name="end_per_group-2"/><a name="26"/>   26: <b>end_per_group</b>(_, _Config) -&gt;
<a name="end_per_group-last_expr"/><a name="27"/>   27:     ok.
<a name="28"/>   28: 
<a name="documentation_generation_tests-0"/><a name="29"/>   29: <b>documentation_generation_tests</b>() -&gt;
<a name="documentation_generation_tests-last_expr"/><a name="30"/>   30:     [singleton_moduledoc,
<a name="31"/>   31:      singleton_doc,
<a name="32"/>   32:      docmodule_with_doc_attributes,
<a name="33"/>   33:      hide_moduledoc,
<a name="34"/>   34:      hide_moduledoc2,
<a name="35"/>   35:      docformat,
<a name="36"/>   36:      singleton_docformat,
<a name="37"/>   37:      singleton_meta,
<a name="38"/>   38:      slogan,
<a name="39"/>   39:      types_and_opaques,
<a name="40"/>   40:      callback,
<a name="41"/>   41:      private_types,
<a name="42"/>   42:      export_all,
<a name="43"/>   43:      equiv,
<a name="44"/>   44:      spec,
<a name="45"/>   45:      deprecated,
<a name="46"/>   46:      warn_missing_doc,
<a name="47"/>   47:      doc_with_file_error,
<a name="48"/>   48:      all_string_formats,
<a name="49"/>   49:      spec_switch_order,
<a name="50"/>   50:      docs_from_ast,
<a name="51"/>   51:      user_defined_type,
<a name="52"/>   52:      skip_doc
<a name="53"/>   53:     ].
<a name="54"/>   54: 
<a name="singleton_moduledoc-1"/><a name="55"/>   55: <b>singleton_moduledoc</b>(Conf) -&gt;
<a name="56"/>   56:     ModuleName = &quot;singletonmoduledoc&quot;,
<a name="57"/>   57:     {ok, ModName} = default_compile_file(Conf, ModuleName),
<a name="58"/>   58: 
<a name="59"/>   59:     Mime = &lt;&lt;&quot;text/markdown&quot;&gt;&gt;,
<a name="60"/>   60:     ModuleDoc = #{&lt;&lt;&quot;en&quot;&gt;&gt; =&gt; &lt;&lt;&quot;Moduledoc test module&quot;&gt;&gt;},
<a name="61"/>   61:     {ok, {docs_v1, _,_, Mime,ModuleDoc, _,_}} = code:get_doc(ModName),
<a name="singleton_moduledoc-last_expr"/><a name="62"/>   62:     ok.
<a name="63"/>   63: 
<a name="singleton_doc-1"/><a name="64"/>   64: <b>singleton_doc</b>(Conf) -&gt;
<a name="65"/>   65:     ModuleName = &quot;singletondoc&quot;,
<a name="66"/>   66:     {ok, ModName} = default_compile_file(Conf, ModuleName),
<a name="67"/>   67:     Mime = &lt;&lt;&quot;text/markdown&quot;&gt;&gt;,
<a name="68"/>   68:     Doc = #{&lt;&lt;&quot;en&quot;&gt;&gt; =&gt; &lt;&lt;&quot;Doc test module&quot;&gt;&gt;},
<a name="69"/>   69:     FooDoc = #{&lt;&lt;&quot;en&quot;&gt;&gt; =&gt; &lt;&lt;&quot;Tests multi-clauses&quot;&gt;&gt;},
<a name="70"/>   70:     {ok, {docs_v1, 1,_, Mime, none, _,
<a name="71"/>   71:           [{{function, foo,1},_, [&lt;&lt;&quot;foo(ok)&quot;&gt;&gt;], FooDoc, _},
<a name="72"/>   72:            {{function, main,0},_, [&lt;&lt;&quot;main()&quot;&gt;&gt;], Doc, _}]}} = code:get_doc(ModName),
<a name="singleton_doc-last_expr"/><a name="73"/>   73:     ok.
<a name="74"/>   74: 
<a name="docmodule_with_doc_attributes-1"/><a name="75"/>   75: <b>docmodule_with_doc_attributes</b>(Conf) -&gt;
<a name="76"/>   76:     ModuleName = &quot;docmodule_with_doc_attributes&quot;,
<a name="77"/>   77:     {ok, ModName} = default_compile_file(Conf, ModuleName),
<a name="78"/>   78:     Mime = &lt;&lt;&quot;text/markdown&quot;&gt;&gt;,
<a name="79"/>   79:     ModuleDoc = #{&lt;&lt;&quot;en&quot;&gt;&gt; =&gt; &lt;&lt;&quot;Moduledoc test module&quot;&gt;&gt;},
<a name="80"/>   80:     Doc = #{&lt;&lt;&quot;en&quot;&gt;&gt; =&gt; &lt;&lt;&quot;Doc test module&quot;&gt;&gt;},
<a name="81"/>   81:     FileDocs =  #{&lt;&lt;&quot;en&quot;&gt;&gt; =&gt; &lt;&lt;&quot;# README\n\nThis is a test&quot;&gt;&gt;},
<a name="82"/>   82:     {ok, #docs_v1{ anno = ModuleAnno,
<a name="83"/>   83:                    beam_language = erlang,
<a name="84"/>   84:                    format = Mime,
<a name="85"/>   85:                    module_doc = ModuleDoc,
<a name="86"/>   86:                    metadata = #{},
<a name="87"/>   87:                    docs = Docs
<a name="88"/>   88:                  }} = code:get_doc(ModName),
<a name="89"/>   89: 
<a name="90"/>   90:     
<a name="91"/>   91:     [{{function,no_docs_multi,1},NoDocsMultiAnno,[&lt;&lt;&quot;no_docs_multi/1&quot;&gt;&gt;],none,#{}},
<a name="92"/>   92:      {{function,with_file_docs,0},FileDocsAnno, [&lt;&lt;&quot;with_file_docs()&quot;&gt;&gt;],FileDocs,#{}},
<a name="93"/>   93:      {{function,no_docs,0},NoDocsAnno, [&lt;&lt;&quot;no_docs()&quot;&gt;&gt;],none,#{}},
<a name="94"/>   94:      {{function,ok,0}, OkAnno, [&lt;&lt;&quot;ok()&quot;&gt;&gt;],none,#{authors := &quot;Someone&quot;}},
<a name="95"/>   95:      {{function, main,_},MainAnno, _, Doc, _}] = Docs,
<a name="96"/>   96:     
<a name="97"/>   97:     ?assertEqual(5, erl_anno:line(ModuleAnno)),
<a name="98"/>   98:     ?assertEqual(10, erl_anno:line(MainAnno)),
<a name="99"/>   99:     ?assertEqual(18, erl_anno:line(OkAnno)),
<a name="100"/>  100:     ?assertEqual(21, erl_anno:line(NoDocsAnno)),
<a name="101"/>  101:     ?assertEqual(1, erl_anno:line(FileDocsAnno)),
<a name="102"/>  102:     ?assertEqual(&quot;README&quot;, filename:basename(erl_anno:file(FileDocsAnno))),
<a name="103"/>  103:     ?assertEqual(28, erl_anno:line(NoDocsMultiAnno)),
<a name="104"/>  104: 
<a name="docmodule_with_doc_attributes-last_expr"/><a name="105"/>  105:     ok.
<a name="106"/>  106: 
<a name="hide_moduledoc-1"/><a name="107"/>  107: <b>hide_moduledoc</b>(Conf) -&gt;
<a name="108"/>  108:     {ok, ModName} = default_compile_file(Conf, &quot;hide_moduledoc&quot;),
<a name="109"/>  109:     {ok, {docs_v1, _,_, _Mime, hidden, _,
<a name="110"/>  110:           [{{function, main, 0}, _, [&lt;&lt;&quot;main()&quot;&gt;&gt;],
<a name="111"/>  111:             #{ &lt;&lt;&quot;en&quot;&gt;&gt; := &lt;&lt;&quot;Doc test module&quot;&gt;&gt; }, #{}}]}} = code:get_doc(ModName),
<a name="hide_moduledoc-last_expr"/><a name="112"/>  112:     ok.
<a name="113"/>  113: 
<a name="114"/>  114: <i>%% TODO: crashes</i>
<a name="hide_moduledoc2-1"/><a name="115"/>  115: <b>hide_moduledoc2</b>(Conf) -&gt;
<a name="116"/>  116:     ModuleName = ?get_name(),
<a name="117"/>  117:     {ok, ModName} = default_compile_file(Conf, ModuleName),
<a name="118"/>  118:     {ok, {docs_v1, _,_, _Mime, hidden, _,
<a name="119"/>  119:           [{{function,handle_call,1},{16,2},[&lt;&lt;&quot;handle_call/1&quot;&gt;&gt;],hidden,#{}},
<a name="120"/>  120:            {{function, main, 0}, _, [&lt;&lt;&quot;main()&quot;&gt;&gt;], hidden, #{}}]}} = code:get_doc(ModName),
<a name="hide_moduledoc2-last_expr"/><a name="121"/>  121:     ok.
<a name="122"/>  122: 
<a name="docformat-1"/><a name="123"/>  123: <b>docformat</b>(Conf) -&gt;
<a name="124"/>  124:     {ok, ModName} = default_compile_file(Conf, &quot;docformat&quot;),
<a name="125"/>  125:     ModuleDoc = #{&lt;&lt;&quot;en&quot;&gt;&gt; =&gt; &lt;&lt;&quot;Moduledoc test module&quot;&gt;&gt;},
<a name="126"/>  126:     Meta = #{format =&gt; &quot;text/asciidoc&quot;,
<a name="127"/>  127:              deprecated =&gt; &quot;Use something else&quot;,
<a name="128"/>  128:              otp_doc_vsn =&gt; {1,0,0},
<a name="129"/>  129:              since =&gt; &quot;1.0&quot;},
<a name="130"/>  130:     Doc = #{&lt;&lt;&quot;en&quot;&gt;&gt; =&gt; &lt;&lt;&quot;Doc test module&quot;&gt;&gt;},
<a name="131"/>  131:     {ok, {docs_v1, _,_, &lt;&lt;&quot;text/asciidoc&quot;&gt;&gt;, ModuleDoc, Meta,
<a name="132"/>  132:           [{{function, main,_},_, _, Doc, _}]}} = code:get_doc(ModName),
<a name="docformat-last_expr"/><a name="133"/>  133:     ok.
<a name="134"/>  134: 
<a name="singleton_docformat-1"/><a name="135"/>  135: <b>singleton_docformat</b>(Conf) -&gt;
<a name="136"/>  136:     {ok, ModName} = default_compile_file(Conf, &quot;singleton_docformat&quot;),
<a name="137"/>  137:     ModuleDoc = #{&lt;&lt;&quot;en&quot;&gt;&gt; =&gt; &lt;&lt;&quot;Moduledoc test module&quot;&gt;&gt;},
<a name="138"/>  138:     Meta = #{format =&gt; &lt;&lt;&quot;text/asciidoc&quot;&gt;&gt;,
<a name="139"/>  139:              deprecated =&gt; &quot;Use something else&quot;,
<a name="140"/>  140:              otp_doc_vsn =&gt; {1,0,0},
<a name="141"/>  141:              since =&gt; &quot;1.0&quot;},
<a name="142"/>  142:     Doc = #{&lt;&lt;&quot;en&quot;&gt;&gt; =&gt; &lt;&lt;&quot;Doc test module\n\nMore info here&quot;&gt;&gt;},
<a name="143"/>  143:     FunMeta = #{ authors =&gt; [&lt;&lt;&quot;Beep Bop&quot;&gt;&gt;], equiv =&gt; &lt;&lt;&quot;main/3&quot;&gt;&gt; },
<a name="144"/>  144:     {ok, {docs_v1, _,erlang, &lt;&lt;&quot;text/asciidoc&quot;&gt;&gt;, ModuleDoc, Meta,
<a name="145"/>  145:           [{{function, main,0},_, [&lt;&lt;&quot;main()&quot;&gt;&gt;], Doc, FunMeta}]}} = code:get_doc(ModName),
<a name="singleton_docformat-last_expr"/><a name="146"/>  146:     ok.
<a name="147"/>  147: 
<a name="singleton_meta-1"/><a name="148"/>  148: <b>singleton_meta</b>(Conf) -&gt;
<a name="149"/>  149:     ModuleName = ?get_name(),
<a name="150"/>  150:     {ok, ModName} = default_compile_file(Conf, ModuleName),
<a name="151"/>  151:     Meta = #{ authors =&gt; [&lt;&lt;&quot;Beep Bop&quot;&gt;&gt;], equiv =&gt; &lt;&lt;&quot;main/3&quot;&gt;&gt;},
<a name="152"/>  152:     DocMain1 = #{&lt;&lt;&quot;en&quot;&gt;&gt; =&gt; &lt;&lt;&quot;Returns always ok.&quot;&gt;&gt;},
<a name="153"/>  153:     {ok, {docs_v1, _,erlang, &lt;&lt;&quot;text/markdown&quot;&gt;&gt;, none, _,
<a name="154"/>  154:           [{{function, main1,0},_, [&lt;&lt;&quot;main1()&quot;&gt;&gt;], DocMain1, #{equiv := &lt;&lt;&quot;main(_)&quot;&gt;&gt;}},
<a name="155"/>  155:            {{function, main,0},_, [&lt;&lt;&quot;main()&quot;&gt;&gt;], none, Meta}]}}
<a name="156"/>  156:         = code:get_doc(ModName),
<a name="singleton_meta-last_expr"/><a name="157"/>  157:     ok.
<a name="158"/>  158: 
<a name="slogan-1"/><a name="159"/>  159: <b>slogan</b>(Conf) -&gt;
<a name="160"/>  160:   ModuleName = ?get_name(),
<a name="161"/>  161:   {ok, ModName} = default_compile_file(Conf, ModuleName),
<a name="162"/>  162:   Doc = #{&lt;&lt;&quot;en&quot;&gt;&gt; =&gt; &lt;&lt;&quot;Returns ok.&quot;&gt;&gt;},
<a name="163"/>  163:   BarDoc = #{ &lt;&lt;&quot;en&quot;&gt;&gt; =&gt; &lt;&lt;&quot;foo()\nNot a slogan since foo =/= bar&quot;&gt;&gt; },
<a name="164"/>  164:   NoSloganDoc = #{ &lt;&lt;&quot;en&quot;&gt;&gt; =&gt; &lt;&lt;&quot;Not a slogan\n\nTests slogans in multi-clause&quot;&gt;&gt;},
<a name="165"/>  165:   {ok, {docs_v1, _,_, _, none, _,
<a name="166"/>  166:           [Connect, MulticlauseSloganIgnored, SpecNoDocSlogan, NoDocSlogan,
<a name="167"/>  167:            Slogan2, Slogan1, NoSlogan, Bar, Main]}} = code:get_doc(ModName),
<a name="168"/>  168: 
<a name="169"/>  169:   {{function,connect,2},_,
<a name="170"/>  170:    [&lt;&lt;&quot;connect(TCPSocket, TLSOptions)&quot;&gt;&gt;],none,#{equiv := &lt;&lt;&quot;connect/3&quot;&gt;&gt;,since := &lt;&lt;&quot;OTP R14B&quot;&gt;&gt;}} = Connect,
<a name="171"/>  171:   {{function,spec_multiclause_slogan_ignored,1},_,[&lt;&lt;&quot;spec_multiclause_slogan_ignored(X)&quot;&gt;&gt;],none,#{}} = MulticlauseSloganIgnored,
<a name="172"/>  172:   {{function, spec_no_doc_slogan, 1}, _, [&lt;&lt;&quot;spec_no_doc_slogan(Y)&quot;&gt;&gt;], none, #{}} = SpecNoDocSlogan,
<a name="173"/>  173:   {{function, no_doc_slogan, 1}, _, [&lt;&lt;&quot;no_doc_slogan(X)&quot;&gt;&gt;], none, #{}}= NoDocSlogan,
<a name="174"/>  174:   {{function, spec_slogan, 2}, _, [&lt;&lt;&quot;spec_slogan(Y, Z)&quot;&gt;&gt;], _, #{}} = Slogan2,
<a name="175"/>  175:   {{function, spec_slogan, 1}, _, [&lt;&lt;&quot;spec_slogan(Y)&quot;&gt;&gt;], _, #{}} = Slogan1,
<a name="176"/>  176:   {{function, no_slogan,1},_,[&lt;&lt;&quot;no_slogan/1&quot;&gt;&gt;], NoSloganDoc, #{}} = NoSlogan,
<a name="177"/>  177:   {{function, bar,0},_,[&lt;&lt;&quot;bar()&quot;&gt;&gt;], BarDoc, #{}} = Bar,
<a name="178"/>  178:   {{function, main,1},_,[&lt;&lt;&quot;main(Foo)&quot;&gt;&gt;], Doc, #{}} = Main,
<a name="slogan-last_expr"/><a name="179"/>  179:   ok.
<a name="180"/>  180: 
<a name="types_and_opaques-1"/><a name="181"/>  181: <b>types_and_opaques</b>(Conf) -&gt;
<a name="182"/>  182:     ModuleName = ?get_name(),
<a name="183"/>  183:     {ok, ModName, Warnings} = default_compile_file(Conf, ModuleName, [return_warnings]),
<a name="184"/>  184:     TypeDoc = #{&lt;&lt;&quot;en&quot;&gt;&gt; =&gt; &lt;&lt;&quot;Represents the name of a person.&quot;&gt;&gt;},
<a name="185"/>  185:     GenericsDoc = #{&lt;&lt;&quot;en&quot;&gt;&gt; =&gt; &lt;&lt;&quot;Tests generics&quot;&gt;&gt;},
<a name="186"/>  186:     OpaqueDoc = #{&lt;&lt;&quot;en&quot;&gt;&gt; =&gt;
<a name="187"/>  187:                       &lt;&lt;&quot;Represents the name of a person that cannot be named.&quot;&gt;&gt;},
<a name="188"/>  188:     MaybeOpaqueDoc = #{&lt;&lt;&quot;en&quot;&gt;&gt; =&gt; &lt;&lt;&quot;mmaybe(X) ::= nothing | X.\n\nRepresents a maybe type.&quot;&gt;&gt;},
<a name="189"/>  189:     MaybeMeta = #{ authors =&gt; &quot;Someone else&quot;, exported =&gt; true },
<a name="190"/>  190:     NaturalNumberMeta = #{since =&gt; &quot;1.0&quot;, equiv =&gt; &lt;&lt;&quot;non_neg_integer/0&quot;&gt;&gt;, exported =&gt; true},
<a name="191"/>  191: 
<a name="192"/>  192:     {ok, {docs_v1, _,_, _, none, _,
<a name="193"/>  193:           [%% Type Definitions
<a name="194"/>  194:            Public, Intermediate, HiddenNoWarnType, HiddenType, OtherPrivateType, MyPrivateType,
<a name="195"/>  195:            MyMap, StateEnter, CallbackMode,CallbackResult, EncodingFunc, Three,
<a name="196"/>  196:            Two, One, Hidden, HiddenFalse, MMaybe, Unnamed, Param,NatNumber, Name,
<a name="197"/>  197:            HiddenIncludedType,
<a name="198"/>  198:            %% Functions
<a name="199"/>  199:            UsesPublic, Ignore, MapFun, PrivateEncoding, Foo
<a name="200"/>  200:           ]}} = code:get_doc(ModName),
<a name="201"/>  201: 
<a name="202"/>  202:     {{type,public,0},{125,2},[&lt;&lt;&quot;public()&quot;&gt;&gt;],none,#{exported := true}} = Public,
<a name="203"/>  203:     {{type,intermediate,0},{124,2},[&lt;&lt;&quot;intermediate()&quot;&gt;&gt;],none,#{exported := false}} = Intermediate,
<a name="204"/>  204:     {{type,hidden_nowarn_type,0},{120,2},[&lt;&lt;&quot;hidden_nowarn_type()&quot;&gt;&gt;],hidden,#{exported := false}} = HiddenNoWarnType,
<a name="205"/>  205:     {{type,hidden_type,0},{117,2},[&lt;&lt;&quot;hidden_type()&quot;&gt;&gt;],hidden,#{exported := false}} = HiddenType,
<a name="206"/>  206:     {{type,my_other_private_type,0},MyOtherPrivateTypeLine,
<a name="207"/>  207:               [&lt;&lt;&quot;my_other_private_type()&quot;&gt;&gt;],none,#{exported := false}} = OtherPrivateType,
<a name="208"/>  208:     {{type,my_private_type,0},MyPrivateTypeLine,
<a name="209"/>  209:      [&lt;&lt;&quot;my_private_type()&quot;&gt;&gt;],none,#{exported := false}} = MyPrivateType,
<a name="210"/>  210:     {{type,mymap,0},MyMapLine,[&lt;&lt;&quot;mymap()&quot;&gt;&gt;],none,#{exported := false}} = MyMap,
<a name="211"/>  211:     {{type,state_enter,0},StateEnterLine,[&lt;&lt;&quot;state_enter()&quot;&gt;&gt;],none,#{exported := false}}=StateEnter,
<a name="212"/>  212:     {{type,callback_mode,0},CallbackModeLine, [&lt;&lt;&quot;callback_mode()&quot;&gt;&gt;],none,#{exported := false}} = CallbackMode,
<a name="213"/>  213:     {{type,callback_mode_result,0},CallbackResultLine,
<a name="214"/>  214:                [&lt;&lt;&quot;callback_mode_result()&quot;&gt;&gt;],none,#{exported := true}} = CallbackResult,
<a name="215"/>  215:     {{type,encoding_func,0},_,[&lt;&lt;&quot;encoding_func()&quot;&gt;&gt;],none,#{exported := false}} = EncodingFunc,
<a name="216"/>  216:     {{type,three,0},_,[&lt;&lt;&quot;three()&quot;&gt;&gt;],none,#{exported := false}} = Three,
<a name="217"/>  217:     {{type,two,0},_,[&lt;&lt;&quot;two()&quot;&gt;&gt;],none,#{exported := false}} = Two,
<a name="218"/>  218:     {{type,one,0},_,[&lt;&lt;&quot;one()&quot;&gt;&gt;],none,#{exported := false}} = One,
<a name="219"/>  219:     {{type,hidden,0},_,[&lt;&lt;&quot;hidden()&quot;&gt;&gt;],hidden,#{exported := true}} = Hidden,
<a name="220"/>  220:     {{type,hidden_false,0},_,[&lt;&lt;&quot;hidden_false()&quot;&gt;&gt;],hidden,
<a name="221"/>  221:      #{exported := true, authors := &quot;Someone else&quot;}} = HiddenFalse,
<a name="222"/>  222:     {{type, mmaybe,1},_,[&lt;&lt;&quot;mmaybe(X)&quot;&gt;&gt;], MaybeOpaqueDoc, MaybeMeta} = MMaybe,
<a name="223"/>  223:     {{type, unnamed,0},{30,2},[&lt;&lt;&quot;unnamed()&quot;&gt;&gt;], OpaqueDoc,
<a name="224"/>  224:      #{equiv := &lt;&lt;&quot;non_neg_integer()&quot;&gt;&gt;, exported := true}} = Unnamed,
<a name="225"/>  225:     {{type, param,1},_,[&lt;&lt;&quot;param(X)&quot;&gt;&gt;], GenericsDoc,
<a name="226"/>  226:      #{equiv := &lt;&lt;&quot;madeup()&quot;&gt;&gt;, exported := true}} = Param,
<a name="227"/>  227:     {{type, natural_number,0},_,[&lt;&lt;&quot;natural_number()&quot;&gt;&gt;], none, NaturalNumberMeta} = NatNumber,
<a name="228"/>  228:     {{type, name,1},_,[&lt;&lt;&quot;name(_)&quot;&gt;&gt;], TypeDoc, #{exported := true}} = Name,
<a name="229"/>  229:     {{type, hidden_included_type, 0}, _, _, hidden, #{exported := false }} = HiddenIncludedType,
<a name="230"/>  230: 
<a name="231"/>  231:     {{function,uses_public,0},{128,1},[&lt;&lt;&quot;uses_public()&quot;&gt;&gt;],none,#{}} = UsesPublic,
<a name="232"/>  232:     {{function,ignore_type_from_hidden_fun,0},_,[&lt;&lt;&quot;ignore_type_from_hidden_fun()&quot;&gt;&gt;],hidden,#{}} = Ignore,
<a name="233"/>  233:     {{function,map_fun,0},_,[&lt;&lt;&quot;map_fun()&quot;&gt;&gt;],none,#{}} = MapFun,
<a name="234"/>  234:     {{function,private_encoding_func,2},_,[&lt;&lt;&quot;private_encoding_func(Data, Options)&quot;&gt;&gt;],none,#{}} = PrivateEncoding,
<a name="235"/>  235:     {{function,foo,0},_,[&lt;&lt;&quot;foo()&quot;&gt;&gt;],none,#{}} = Foo,
<a name="236"/>  236: 
<a name="237"/>  237:     ?assertEqual(103, erl_anno:line(MyOtherPrivateTypeLine)),
<a name="238"/>  238:     ?assertEqual(102, erl_anno:line(MyPrivateTypeLine)),
<a name="239"/>  239:     ?assertEqual(99, erl_anno:line(MyMapLine)),
<a name="240"/>  240:     ?assertEqual(96, erl_anno:line(StateEnterLine)),
<a name="241"/>  241:     ?assertEqual(95, erl_anno:line(CallbackModeLine)),
<a name="242"/>  242:     ?assertEqual(93, erl_anno:line(CallbackResultLine)),
<a name="243"/>  243: 
<a name="244"/>  244:     [{File, Ws}, {HrlFile, HrlWs}] = Warnings,
<a name="245"/>  245:     ?assertEqual(&quot;types_and_opaques.erl&quot;, filename:basename(File)),
<a name="246"/>  246:     ?assertEqual({{117,2}, beam_doc,
<a name="247"/>  247:                   {hidden_type_used_in_exported_fun,{hidden_type,0}}}, lists:nth(4, Ws)),
<a name="248"/>  248: 
<a name="249"/>  249:     ?assertEqual(&quot;types_and_opaques.hrl&quot;, filename:basename(HrlFile)),
<a name="250"/>  250:     ?assertEqual({{1,2}, beam_doc,
<a name="251"/>  251:                   {hidden_type_used_in_exported_fun,{hidden_included_type,0}}}, lists:nth(1, HrlWs)),
<a name="252"/>  252: 
<a name="253"/>  253:     {ok, ModName, [_]} =
<a name="254"/>  254:         default_compile_file(Conf, ModuleName, [return_warnings, nowarn_hidden_doc, nowarn_unused_type]),
<a name="255"/>  255: 
<a name="types_and_opaques-last_expr"/><a name="256"/>  256:     ok.
<a name="257"/>  257: 
<a name="callback-1"/><a name="258"/>  258: <b>callback</b>(Conf) -&gt;
<a name="259"/>  259:     ModuleName = ?get_name(),
<a name="260"/>  260:     {ok, ModName, [{File,Warnings}]} =
<a name="261"/>  261:         default_compile_file(Conf, ModuleName, [return_warnings, report]),
<a name="262"/>  262:     Doc = #{&lt;&lt;&quot;en&quot;&gt;&gt; =&gt; &lt;&lt;&quot;Callback fn that always returns ok.&quot;&gt;&gt;},
<a name="263"/>  263:     ImpCallback = #{&lt;&lt;&quot;en&quot;&gt;&gt; =&gt; &lt;&lt;&quot;This is a test&quot;&gt;&gt;},
<a name="264"/>  264:     FunctionDoc = #{&lt;&lt;&quot;en&quot;&gt;&gt; =&gt; &lt;&lt;&quot;all_ok()\n\nCalls all_ok/0&quot;&gt;&gt;},
<a name="265"/>  265:     ChangeOrder = #{&lt;&lt;&quot;en&quot;&gt;&gt; =&gt; &lt;&lt;&quot;Test changing order&quot;&gt;&gt;},
<a name="266"/>  266:     {ok, {docs_v1, _,_, _, none, _,
<a name="267"/>  267:           [{{callback,nowarn,1},{39,2},[&lt;&lt;&quot;nowarn(Arg)&quot;&gt;&gt;],hidden,#{}},
<a name="268"/>  268:            {{callback,warn,0},{36,2},[&lt;&lt;&quot;warn()&quot;&gt;&gt;],hidden,#{}},
<a name="269"/>  269:            {{callback,bounded,1},_,[&lt;&lt;&quot;bounded(X)&quot;&gt;&gt;],none,#{}},
<a name="270"/>  270:            {{callback,multi,1},_,[&lt;&lt;&quot;multi(Argument)&quot;&gt;&gt;],
<a name="271"/>  271:             #{ &lt;&lt;&quot;en&quot;&gt;&gt; := &lt;&lt;&quot;A multiclause callback with slogan docs&quot;&gt;&gt; },#{}},
<a name="272"/>  272:            {{callback,multi_no_slogan,1},_,[&lt;&lt;&quot;multi_no_slogan/1&quot;&gt;&gt;],none,#{}},
<a name="273"/>  273:            {{callback,ann,1},_,[&lt;&lt;&quot;ann(X)&quot;&gt;&gt;],none,#{}},
<a name="274"/>  274:            {{callback,param,1},_,[&lt;&lt;&quot;param(X)&quot;&gt;&gt;],none,#{}},
<a name="275"/>  275:            {{callback, change_order,0},_,[&lt;&lt;&quot;change_order()&quot;&gt;&gt;], ChangeOrder,
<a name="276"/>  276:             #{equiv := &lt;&lt;&quot;ok()&quot;&gt;&gt;}},
<a name="277"/>  277:            {{callback, all_ok,0},_,[&lt;&lt;&quot;all_ok()&quot;&gt;&gt;], Doc, #{}},
<a name="278"/>  278:            {{function, main2,0},_,[&lt;&lt;&quot;main2()&quot;&gt;&gt;], #{&lt;&lt;&quot;en&quot;&gt;&gt; := &lt;&lt;&quot;Second main&quot;&gt;&gt;},
<a name="279"/>  279:             #{equiv := &lt;&lt;&quot;main()&quot;&gt;&gt;}},
<a name="280"/>  280:            {{function, main,0},_,[&lt;&lt;&quot;main()&quot;&gt;&gt;], FunctionDoc, #{}},
<a name="281"/>  281:            {{function, all_ok,0},_, [&lt;&lt;&quot;all_ok()&quot;&gt;&gt;],ImpCallback,
<a name="282"/>  282:             #{equiv := &lt;&lt;&quot;ok/0&quot;&gt;&gt;}}
<a name="283"/>  283:           ]}} = code:get_doc(ModName),
<a name="284"/>  284: 
<a name="285"/>  285:     ?assertEqual(&quot;callback.erl&quot;, filename:basename(File)),
<a name="286"/>  286:     io:format(&quot;Warnings: ~p~n&quot;, [Warnings]),
<a name="287"/>  287:     ?assertEqual(1, length(Warnings)),
<a name="288"/>  288:     ?assertMatch({{36,2},beam_doc,{hidden_callback,{warn,0}}}, lists:nth(1, Warnings)),
<a name="289"/>  289: 
<a name="290"/>  290:     {ok, ModName, []} =
<a name="291"/>  291:         default_compile_file(Conf, ModuleName, [return_warnings, report, nowarn_hidden_doc]),
<a name="292"/>  292: 
<a name="callback-last_expr"/><a name="293"/>  293:     ok.
<a name="294"/>  294: 
<a name="private_types-1"/><a name="295"/>  295: <b>private_types</b>(Conf) -&gt;
<a name="296"/>  296:     ModuleName = ?get_name(),
<a name="297"/>  297:     {ok, ModName} = default_compile_file(Conf, ModuleName),
<a name="298"/>  298: 
<a name="299"/>  299:     {ok, {docs_v1, _,_, _, none, _,
<a name="300"/>  300:           [
<a name="301"/>  301:            %% Types
<a name="302"/>  302:            RemoteTypeT, TupleT, RecordAT, RecordInlineT,
<a name="303"/>  303:            MapValue2T, MapKey2T, MapValueT, MapKeyT,
<a name="304"/>  304:            FunRet2T, FunRetT, FunT, Complex, BoundedRetT,
<a name="305"/>  305:            ArgT, BoundedArgT, Private, HiddenExportT, PrivateCBT,
<a name="306"/>  306:            OpaqueT, PublicT, PrivateT,
<a name="307"/>  307:            %% Callbacks
<a name="308"/>  308:            CBar,
<a name="309"/>  309:            %% Functions
<a name="310"/>  310:            Bounded, HiddenTypeExposed, Hidden, Bar]}} = code:get_doc(ModName),
<a name="311"/>  311: 
<a name="312"/>  312:     ?assertMatch({{type,remote_type_t,1}, _, _, none, #{exported := false}},RemoteTypeT),
<a name="313"/>  313:     ?assertMatch({{type,tuple_t,0}, _, _, none, #{exported := false}},TupleT),
<a name="314"/>  314:     ?assertMatch({{type,record_a_t,0}, _, _, none, #{exported := false}},RecordAT),
<a name="315"/>  315:     ?assertMatch({{type,record_inline_t,0}, _, _, none, #{exported := false}},RecordInlineT),
<a name="316"/>  316:     ?assertMatch({{type,map_value_2_t,0}, _, _, none, #{exported := false}},MapValue2T),
<a name="317"/>  317:     ?assertMatch({{type,map_key_2_t,0}, _, _, none, #{exported := false}},MapKey2T),
<a name="318"/>  318:     ?assertMatch({{type,map_value_t,0}, _, _, none, #{exported := false}},MapValueT),
<a name="319"/>  319:     ?assertMatch({{type,map_key_t,0}, _, _, none, #{exported := false}},MapKeyT),
<a name="320"/>  320:     ?assertMatch({{type,fun_ret_2_t,0}, _, _, none, #{exported := false}},FunRet2T),
<a name="321"/>  321:     ?assertMatch({{type,fun_ret_t,0}, _, _, none, #{exported := false}},FunRetT),
<a name="322"/>  322:     ?assertMatch({{type,fun_t,0}, _, _, none, #{exported := false}},FunT),
<a name="323"/>  323:     ?assertMatch({{type,complex,1}, _, _, none, #{exported := true}},Complex),
<a name="324"/>  324:     ?assertMatch({{type,bounded_ret_t,0}, _, _, none, #{exported := false}},BoundedRetT),
<a name="325"/>  325:     ?assertMatch({{type,arg_t,0}, _, _, none, #{exported := false}},ArgT),
<a name="326"/>  326:     ?assertMatch({{type,bounded_arg_t,0}, _, _, none, #{exported := false}},BoundedArgT),
<a name="327"/>  327:     ?assertMatch({{type,private,0}, {30,2}, [&lt;&lt;&quot;private()&quot;&gt;&gt;], hidden, #{exported := false}},Private),
<a name="328"/>  328:     ?assertMatch({{type,hidden_export_t,0},_,[&lt;&lt;&quot;hidden_export_t()&quot;&gt;&gt;],hidden,#{exported := true}},HiddenExportT),
<a name="329"/>  329:     ?assertMatch({{type,private_cb_t,0},_,_,none,#{exported := false}},PrivateCBT),
<a name="330"/>  330:     ?assertMatch({{type,opaque_t,0},_, [&lt;&lt;&quot;opaque_t()&quot;&gt;&gt;], none,#{ exported := true}},OpaqueT),
<a name="331"/>  331:     ?assertMatch({{type,public_t,0},_, [&lt;&lt;&quot;public_t()&quot;&gt;&gt;], none,#{ exported := true}},PublicT),
<a name="332"/>  332:     ?assertMatch({{type,private_t,0},_, [&lt;&lt;&quot;private_t()&quot;&gt;&gt;], none,#{ exported := false}},PrivateT),
<a name="333"/>  333:     ?assertMatch({{callback,bar,1},_,_,none,#{}},CBar),
<a name="334"/>  334:     ?assertMatch({{function,bounded,2},_,_,none,#{}},Bounded),
<a name="335"/>  335:     ?assertMatch({{function,hidden_type_exposed,0},{34,1},[&lt;&lt;&quot;hidden_type_exposed()&quot;&gt;&gt;],none,#{}},HiddenTypeExposed),
<a name="336"/>  336:     ?assertMatch({{function,hidden,0},_,[&lt;&lt;&quot;hidden()&quot;&gt;&gt;],hidden,#{}},Hidden),
<a name="337"/>  337:     ?assertMatch({{function,bar,0},_,[&lt;&lt;&quot;bar()&quot;&gt;&gt;],none,#{}},Bar),
<a name="338"/>  338: 
<a name="private_types-last_expr"/><a name="339"/>  339:     ok.
<a name="340"/>  340: 
<a name="341"/>  341: 
<a name="export_all-1"/><a name="342"/>  342: <b>export_all</b>(Conf) -&gt;
<a name="343"/>  343:     ModuleName = ?get_name(),
<a name="344"/>  344:     {ok, ModName} = default_compile_file(Conf, ModuleName),
<a name="345"/>  345:     ImpCallback = #{&lt;&lt;&quot;en&quot;&gt;&gt; =&gt; &lt;&lt;&quot;This is a test&quot;&gt;&gt;},
<a name="346"/>  346:     FunctionDoc = #{&lt;&lt;&quot;en&quot;&gt;&gt; =&gt; &lt;&lt;&quot;all_ok()\n\nCalls all_ok/0&quot;&gt;&gt;},
<a name="347"/>  347:     {ok, {docs_v1, _,_, _, none, _,
<a name="348"/>  348:           [{{function, main2,0},_,[&lt;&lt;&quot;main2()&quot;&gt;&gt;], #{&lt;&lt;&quot;en&quot;&gt;&gt; := &lt;&lt;&quot;Second main&quot;&gt;&gt;},
<a name="349"/>  349:             #{equiv := &lt;&lt;&quot;main()&quot;&gt;&gt;}},
<a name="350"/>  350:            {{function, main,0},_,[&lt;&lt;&quot;main()&quot;&gt;&gt;], FunctionDoc, #{}},
<a name="351"/>  351:            {{function, all_ok,0},_, [&lt;&lt;&quot;all_ok()&quot;&gt;&gt;],ImpCallback,
<a name="352"/>  352:             #{equiv := &lt;&lt;&quot;ok/0&quot;&gt;&gt;}}
<a name="353"/>  353:           ]}} = code:get_doc(ModName),
<a name="export_all-last_expr"/><a name="354"/>  354:     ok.
<a name="355"/>  355: 
<a name="equiv-1"/><a name="356"/>  356: <b>equiv</b>(Conf) -&gt;
<a name="357"/>  357:     ModuleName = ?get_name(),
<a name="358"/>  358:     {ok, ModName} = default_compile_file(Conf, ModuleName),
<a name="359"/>  359:     {ok, {docs_v1, _,_, _, none, _,
<a name="360"/>  360:           [{{function, main, 2},_,[&lt;&lt;&quot;main(A, B)&quot;&gt;&gt;], none,
<a name="361"/>  361:             #{ }},
<a name="362"/>  362:             {{function, main, 1},_,[&lt;&lt;&quot;main(A)&quot;&gt;&gt;], none,
<a name="363"/>  363:              #{ equiv := &lt;&lt;&quot;main(A, 1)&quot;&gt;&gt; }}
<a name="364"/>  364:           ]}} = code:get_doc(ModName),
<a name="equiv-last_expr"/><a name="365"/>  365:     ok.
<a name="366"/>  366: 
<a name="spec-1"/><a name="367"/>  367: <b>spec</b>(Conf) -&gt;
<a name="368"/>  368:     ModuleName = ?get_name(),
<a name="369"/>  369:     {ok, ModName} = default_compile_file(Conf, ModuleName),
<a name="370"/>  370:     {ok, {docs_v1, _,_, _, none, _,
<a name="371"/>  371:           [{{type,no,0},_,[&lt;&lt;&quot;no()&quot;&gt;&gt;],none,#{exported := false}},
<a name="372"/>  372:            {{type,yes,0},_,[&lt;&lt;&quot;yes()&quot;&gt;&gt;],none,#{exported := false}},
<a name="373"/>  373:            {{callback,me,1},_,[&lt;&lt;&quot;me/1&quot;&gt;&gt;],none,#{}},
<a name="374"/>  374:            {{function,baz,1},_,[&lt;&lt;&quot;baz(X)&quot;&gt;&gt;],none,#{}},
<a name="375"/>  375:            {{function,foo,1},_,[&lt;&lt;&quot;foo(X)&quot;&gt;&gt;],none,#{}}]}} = code:get_doc(ModName),
<a name="spec-last_expr"/><a name="376"/>  376:     ok.
<a name="377"/>  377: 
<a name="user_defined_type-1"/><a name="378"/>  378: <b>user_defined_type</b>(Conf) -&gt;
<a name="379"/>  379:     ModuleName = ?get_name(),
<a name="380"/>  380:     {ok, ModName} = default_compile_file(Conf, ModuleName),
<a name="381"/>  381:     {ok, {docs_v1, _,_, _, none, _, []}} = code:get_doc(ModName),
<a name="user_defined_type-last_expr"/><a name="382"/>  382:     ok.
<a name="383"/>  383: 
<a name="deprecated-1"/><a name="384"/>  384: <b>deprecated</b>(Conf) -&gt;
<a name="385"/>  385:     ModuleName = ?get_name(),
<a name="386"/>  386:     {ok, ModName} = default_compile_file(Conf, ModuleName),
<a name="387"/>  387:     {ok, {docs_v1, _,_, _, none, _,
<a name="388"/>  388:           [{{type,test,1},_,[&lt;&lt;&quot;test(N)&quot;&gt;&gt;],none,#{deprecated := &lt;&lt;&quot;the type deprecated:test(_) is deprecated; Deprecation reason&quot;&gt;&gt;}},
<a name="389"/>  389:            {{type,test,0},_,[&lt;&lt;&quot;test()&quot;&gt;&gt;],none,#{deprecated := &lt;&lt;&quot;the type deprecated:test() is deprecated; see the documentation for details&quot;&gt;&gt;}},
<a name="390"/>  390:            {{callback,test,0},_,[&lt;&lt;&quot;test()&quot;&gt;&gt;],none,#{deprecated := &lt;&lt;&quot;Meta reason&quot;&gt;&gt;}},
<a name="391"/>  391:            {{function,test,2},_,[&lt;&lt;&quot;test(N, M)&quot;&gt;&gt;],none,#{deprecated := &lt;&lt;&quot;Meta reason&quot;&gt;&gt;}},
<a name="392"/>  392:            {{function,test,1},_,[&lt;&lt;&quot;test(N)&quot;&gt;&gt;],none,#{deprecated := &lt;&lt;&quot;deprecated:test/1 is deprecated; Deprecation reason&quot;&gt;&gt;}},
<a name="393"/>  393:            {{function,test,0},_,[&lt;&lt;&quot;test()&quot;&gt;&gt;],none,#{deprecated := &lt;&lt;&quot;deprecated:test/0 is deprecated; see the documentation for details&quot;&gt;&gt;}}]}} =
<a name="394"/>  394:         code:get_doc(ModName),
<a name="395"/>  395: 
<a name="396"/>  396:     {ok, ModName} = default_compile_file(Conf, ModuleName, [{d,'TEST_WILDCARD'},
<a name="397"/>  397:                                                     {d, 'REASON', next_major_release}]),
<a name="398"/>  398:     {ok, {docs_v1, _,_, _, none, _,
<a name="399"/>  399:           [{{type,test,1},_,[&lt;&lt;&quot;test(N)&quot;&gt;&gt;],none,#{deprecated := &lt;&lt;&quot;the type deprecated:test(_) is deprecated; see the documentation for details&quot;&gt;&gt;}},
<a name="400"/>  400:            {{type,test,0},_,[&lt;&lt;&quot;test()&quot;&gt;&gt;],none,#{deprecated := &lt;&lt;&quot;the type deprecated:test() is deprecated; see the documentation for details&quot;&gt;&gt;}},
<a name="401"/>  401:            {{callback,test,0},_,[&lt;&lt;&quot;test()&quot;&gt;&gt;],none,#{deprecated := &lt;&lt;&quot;Meta reason&quot;&gt;&gt;}},
<a name="402"/>  402:            {{function,test,2},_,[&lt;&lt;&quot;test(N, M)&quot;&gt;&gt;],none,#{deprecated := &lt;&lt;&quot;Meta reason&quot;&gt;&gt;}},
<a name="403"/>  403:            {{function,test,1},_,[&lt;&lt;&quot;test(N)&quot;&gt;&gt;],none,#{deprecated := &lt;&lt;&quot;deprecated:test/1 is deprecated; will be removed in the next major release. See the documentation for details&quot;&gt;&gt;}},
<a name="404"/>  404:            {{function,test,0},_,[&lt;&lt;&quot;test()&quot;&gt;&gt;],none,#{deprecated := &lt;&lt;&quot;deprecated:test/0 is deprecated; see the documentation for details&quot;&gt;&gt;}}]}} =
<a name="405"/>  405:         code:get_doc(ModName),
<a name="406"/>  406: 
<a name="407"/>  407:     {ok, ModName} = default_compile_file(Conf, ModuleName, [{d,'ALL_WILDCARD'},
<a name="408"/>  408:                                                     {d,'REASON',next_version},
<a name="409"/>  409:                                                     {d,'TREASON',eventually}]),
<a name="410"/>  410:     {ok, {docs_v1, _,_, _, none, _,
<a name="411"/>  411:           [{{type,test,1},_,[&lt;&lt;&quot;test(N)&quot;&gt;&gt;],none,#{deprecated := &lt;&lt;&quot;the type deprecated:test(_) is deprecated; will be removed in a future release. See the documentation for details&quot;&gt;&gt;}},
<a name="412"/>  412:            {{type,test,0},_,[&lt;&lt;&quot;test()&quot;&gt;&gt;],none,#{deprecated := &lt;&lt;&quot;the type deprecated:test() is deprecated; see the documentation for details&quot;&gt;&gt;}},
<a name="413"/>  413:            {{callback,test,0},_,[&lt;&lt;&quot;test()&quot;&gt;&gt;],none,#{deprecated := &lt;&lt;&quot;Meta reason&quot;&gt;&gt;}},
<a name="414"/>  414:            {{function,test,2},_,[&lt;&lt;&quot;test(N, M)&quot;&gt;&gt;],none,#{deprecated := &lt;&lt;&quot;Meta reason&quot;&gt;&gt;}},
<a name="415"/>  415:            {{function,test,1},_,[&lt;&lt;&quot;test(N)&quot;&gt;&gt;],none,#{deprecated := &lt;&lt;&quot;deprecated:test/1 is deprecated; will be removed in the next version. See the documentation for details&quot;&gt;&gt;}},
<a name="416"/>  416:            {{function,test,0},_,[&lt;&lt;&quot;test()&quot;&gt;&gt;],none,#{deprecated := &lt;&lt;&quot;deprecated:test/0 is deprecated; see the documentation for details&quot;&gt;&gt;}}]}} =
<a name="417"/>  417:         code:get_doc(ModName),
<a name="deprecated-last_expr"/><a name="418"/>  418:     ok.
<a name="419"/>  419: 
<a name="warn_missing_doc-1"/><a name="420"/>  420: <b>warn_missing_doc</b>(Conf) -&gt;
<a name="421"/>  421: 
<a name="422"/>  422:     warn_missing_doc(Conf, [function, type, callback], [warn_missing_doc]),
<a name="423"/>  423:     warn_missing_doc(Conf, [function], [warn_missing_doc_functions]),
<a name="424"/>  424:     warn_missing_doc(Conf, [function, type], [warn_missing_doc_functions, warn_missing_doc_types]),
<a name="425"/>  425:     warn_missing_doc(Conf, [type, callback], [warn_missing_doc_types, warn_missing_doc_callbacks]),
<a name="426"/>  426:     warn_missing_doc(Conf, [callback], [warn_missing_doc_callbacks]),
<a name="427"/>  427: 
<a name="428"/>  428:     warn_missing_doc(Conf, [type, callback], [warn_missing_doc, nowarn_missing_doc_functions]),
<a name="429"/>  429:     warn_missing_doc(Conf, [function, callback], [warn_missing_doc, nowarn_missing_doc_types]),
<a name="430"/>  430:     warn_missing_doc(Conf, [type], [warn_missing_doc, nowarn_missing_doc_callbacks, nowarn_missing_doc_functions]),
<a name="431"/>  431:     warn_missing_doc(Conf, [], [warn_missing_doc_functions, nowarn_missing_doc]),
<a name="432"/>  432: 
<a name="warn_missing_doc-last_expr"/><a name="433"/>  433:     ok.
<a name="434"/>  434: 
<a name="warn_missing_doc-3"/><a name="435"/>  435: <b>warn_missing_doc</b>(Conf, ExpectedWarnings, Options) -&gt;
<a name="436"/>  436:     ModuleName = ?get_name(),
<a name="437"/>  437:     {ok, ModName, Ws} =
<a name="438"/>  438:         default_compile_file(Conf, ModuleName, [return_warnings, report | Options]),
<a name="439"/>  439: 
<a name="440"/>  440:     {ok, {docs_v1, _,_, _, none, _,
<a name="441"/>  441:           [{{type,test,1},_,[&lt;&lt;&quot;test(N)&quot;&gt;&gt;],none,_},
<a name="442"/>  442:            {{type,test,0},_,[&lt;&lt;&quot;test()&quot;&gt;&gt;],none,_},
<a name="443"/>  443:            {{callback,test,0},_,[&lt;&lt;&quot;test()&quot;&gt;&gt;],none,_},
<a name="444"/>  444:            {{function,test,1},_,[&lt;&lt;&quot;test(N)&quot;&gt;&gt;],none,_},
<a name="445"/>  445:            {{function,test,0},_,[&lt;&lt;&quot;test()&quot;&gt;&gt;],none,_},
<a name="446"/>  446:            {{function,test,2},_,[&lt;&lt;&quot;test(N, M)&quot;&gt;&gt;],none,_}]}
<a name="447"/>  447:     } = code:get_doc(ModName),
<a name="448"/>  448: 
<a name="warn_missing_doc-last_expr"/><a name="449"/>  449:     case ExpectedWarnings of
<a name="450"/>  450:         [] -&gt;
<a name="451"/>  451:             ?assertEqual([],Ws);
<a name="452"/>  452:         _ -&gt;
<a name="453"/>  453:             [{File,Warnings} | Hrl] = Ws,
<a name="454"/>  454:             ExpectedWarningCount = 1 + lists:sum(
<a name="455"/>  455:                                          lists:flatten(
<a name="456"/>  456:                                            [[2 || lists:member(type, ExpectedWarnings)],
<a name="457"/>  457:                                             [1 || lists:member(callback, ExpectedWarnings)],
<a name="458"/>  458:                                             [2 || lists:member(function, ExpectedWarnings)]])),
<a name="459"/>  459: 
<a name="460"/>  460:             ?assertEqual(&quot;warn_missing_doc.erl&quot;, filename:basename(File)),
<a name="461"/>  461:             ?assertEqual(ExpectedWarningCount, length(Warnings)),
<a name="462"/>  462:             ?assertMatch({1, beam_doc, missing_moduledoc}, lists:nth(1, Warnings)),
<a name="463"/>  463:             TypePos =
<a name="464"/>  464:                 case lists:member(type, ExpectedWarnings) of
<a name="465"/>  465:                     true -&gt;
<a name="466"/>  466:                         ?assertMatch({{6,2}, beam_doc, {missing_doc, {type,test,0}}}, lists:nth(2, Warnings)),
<a name="467"/>  467:                         ?assertMatch({{7,2}, beam_doc, {missing_doc, {type,test,1}}}, lists:nth(3, Warnings)),
<a name="468"/>  468:                         4;
<a name="469"/>  469:                     false -&gt;
<a name="470"/>  470:                         2
<a name="471"/>  471:                 end,
<a name="472"/>  472: 
<a name="473"/>  473:             CBPos =
<a name="474"/>  474:                 case lists:member(callback, ExpectedWarnings) of
<a name="475"/>  475:                     true -&gt;
<a name="476"/>  476:                         ?assertMatch({{9,2}, beam_doc, {missing_doc, {callback,test,0}}}, lists:nth(TypePos, Warnings)),
<a name="477"/>  477:                         TypePos + 1;
<a name="478"/>  478:                     false -&gt;
<a name="479"/>  479:                         TypePos
<a name="480"/>  480:                 end,
<a name="481"/>  481: 
<a name="482"/>  482:             case lists:member(function, ExpectedWarnings) of
<a name="483"/>  483:                 true -&gt;
<a name="484"/>  484:                     ?assertMatch({{13,1}, beam_doc, {missing_doc, {function,test,0}}}, lists:nth(CBPos, Warnings)),
<a name="485"/>  485:                     ?assertMatch({{14,1}, beam_doc, {missing_doc, {function,test,1}}}, lists:nth(CBPos+1, Warnings)),
<a name="486"/>  486:                     [{HrlFile, HrlWarnings}] = Hrl,
<a name="487"/>  487:                     ?assertEqual(&quot;warn_missing_doc.hrl&quot;, filename:basename(HrlFile)),
<a name="488"/>  488:                     ?assertEqual(1, length(HrlWarnings)),
<a name="489"/>  489:                     ?assertMatch({{2,1}, beam_doc, {missing_doc, {function,test,2}}}, lists:nth(1, HrlWarnings));
<a name="490"/>  490:                 false -&gt;
<a name="491"/>  491:                     ok
<a name="492"/>  492:             end
<a name="493"/>  493:     end.
<a name="494"/>  494: 
<a name="doc_with_file-1"/><a name="495"/>  495: <b>doc_with_file</b>(Conf) -&gt;
<a name="496"/>  496:     ModuleName = ?get_name(),
<a name="497"/>  497:     {ok, Cwd} = file:get_cwd(),
<a name="doc_with_file-last_expr"/><a name="498"/>  498:     try
<a name="499"/>  499:         ok = file:set_cwd(proplists:get_value(data_dir, Conf)),
<a name="500"/>  500:         {ok, ModName} = default_compile_file(Conf, ModuleName, [{i, &quot;./folder&quot;}]),
<a name="501"/>  501:         {ok, {docs_v1, ModuleAnno,_, _, #{&lt;&lt;&quot;en&quot;&gt;&gt; := &lt;&lt;&quot;# README\n\nThis is a test&quot;&gt;&gt;}, _,
<a name="502"/>  502:               [{{type,bar,1},_,[&lt;&lt;&quot;bar(X)&quot;&gt;&gt;],none,#{exported := false}},
<a name="503"/>  503:                {{type,foo,1},_,[&lt;&lt;&quot;foo(X)&quot;&gt;&gt;],none,#{exported := true}},
<a name="504"/>  504:                {{type,private_type_exported,0},_,[&lt;&lt;&quot;private_type_exported()&quot;&gt;&gt;],
<a name="505"/>  505:                 #{&lt;&lt;&quot;en&quot;&gt;&gt; := &lt;&lt;&quot;# TYPES\n\nTest&quot;&gt;&gt;}, #{exported := false}},
<a name="506"/>  506:                {{function,main2,1},Main2Anno,[&lt;&lt;&quot;main2(I)&quot;&gt;&gt;],
<a name="507"/>  507:                 #{&lt;&lt;&quot;en&quot;&gt;&gt; := &lt;&lt;&quot;# File\n\ntesting fetching docs from other folders&quot;&gt;&gt;}, #{}},
<a name="508"/>  508:                {{function,main,1},_,[&lt;&lt;&quot;main(Var)&quot;&gt;&gt;],
<a name="509"/>  509:                 #{&lt;&lt;&quot;en&quot;&gt;&gt; := &lt;&lt;&quot;# Fun\n\nTest importing function&quot;&gt;&gt;},#{}}]}} = code:get_doc(ModName),
<a name="510"/>  510: 
<a name="511"/>  511:         ?assertEqual(1, erl_anno:line(ModuleAnno)),
<a name="512"/>  512:         ?assertEqual(1, erl_anno:line(Main2Anno)),
<a name="513"/>  513:         ?assertEqual(&quot;./folder/FILE&quot;, erl_anno:file(Main2Anno)),
<a name="514"/>  514:         ok
<a name="515"/>  515:     after
<a name="516"/>  516:         ok = file:set_cwd(Cwd)
<a name="517"/>  517:     end.
<a name="518"/>  518: 
<a name="doc_with_file_error-1"/><a name="519"/>  519: <b>doc_with_file_error</b>(Conf) -&gt;
<a name="520"/>  520:     ModuleName = ?get_name(),
<a name="521"/>  521:     {error,
<a name="522"/>  522:      [{_,
<a name="523"/>  523:        [{{6,2},epp,{moduledoc,file,&quot;doesnotexist&quot;}},
<a name="524"/>  524:         {{8,2},epp,{doc,file,&quot;doesnotexist&quot;}},
<a name="525"/>  525:         {{11,2},epp,{doc,file,&quot;doesnotexist&quot;}}]}] = Errors, []} = default_compile_file(Conf, ModuleName),
<a name="526"/>  526:     [[Mod:format_error(Error) || {_Loc, Mod, Error} &lt;- Errs] || {_File, Errs} &lt;- Errors],
<a name="527"/>  527:     {error, _, []} = default_compile_file(Conf, ModuleName, [report]),
<a name="doc_with_file_error-last_expr"/><a name="528"/>  528:     ok.
<a name="529"/>  529: 
<a name="all_string_formats-1"/><a name="530"/>  530: <b>all_string_formats</b>(Conf) -&gt;
<a name="531"/>  531:     ModuleName = ?get_name(),
<a name="532"/>  532:     {ok, ModName} = default_compile_file(Conf, ModuleName),
<a name="533"/>  533: 
<a name="534"/>  534:     {ok, {docs_v1, _ModuleAnno,_, _, #{&lt;&lt;&quot;en&quot;&gt;&gt; := &lt;&lt;&quot;Moduledoc test module&quot;&gt;&gt;}, _,
<a name="535"/>  535:               [
<a name="536"/>  536:                {{function,six,0},_,_, #{&lt;&lt;&quot;en&quot;&gt;&gt; := &lt;&lt;&quot;all_string_formats-all_string_formats&quot;&gt;&gt;}, #{}},
<a name="537"/>  537:                {{function,five,0},_,_, #{&lt;&lt;&quot;en&quot;&gt;&gt; := &lt;&lt;&quot;all_string_formats-Doc module&quot;&gt;&gt;}, #{}},
<a name="538"/>  538:                {{function,four,0},_,_, #{&lt;&lt;&quot;en&quot;&gt;&gt; := &lt;&lt;&quot;Doc test m√∂dule&quot;/utf8&gt;&gt;}, #{}},
<a name="539"/>  539:                {{function,three,0},_,_, #{&lt;&lt;&quot;en&quot;&gt;&gt; := &lt;&lt;&quot;Doctestmodule&quot;&gt;&gt;}, #{}},
<a name="540"/>  540:                {{function,two,0},_,_, #{&lt;&lt;&quot;en&quot;&gt;&gt; := &lt;&lt;&quot;Doc test module&quot;&gt;&gt;}, #{}},
<a name="541"/>  541:                {{function,one,0},_,_, #{&lt;&lt;&quot;en&quot;&gt;&gt; := &lt;&lt;&quot;Doc test module&quot;&gt;&gt;}, #{}}
<a name="542"/>  542:               ]}} = code:get_doc(ModName),
<a name="all_string_formats-last_expr"/><a name="543"/>  543:     ok.
<a name="544"/>  544: 
<a name="spec_switch_order-1"/><a name="545"/>  545: <b>spec_switch_order</b>(Conf) -&gt;
<a name="546"/>  546:   ModuleName = ?get_name(),
<a name="547"/>  547:     {ok, ModName} = default_compile_file(Conf, ModuleName),
<a name="548"/>  548: 
<a name="549"/>  549:     {ok, {docs_v1, _ModuleAnno,_, _, _, _,
<a name="550"/>  550:           [NotFalse, Other, Bar, Foo]}} = code:get_doc(ModName),
<a name="551"/>  551:   {{function,not_false,0}, {52,1}, [&lt;&lt;&quot;not_false()&quot;&gt;&gt;], none,#{}} = NotFalse,
<a name="552"/>  552:   {{function,other,0},{36,2},[&lt;&lt;&quot;other()&quot;&gt;&gt;],hidden,#{}} = Other,
<a name="553"/>  553:   {{function,bar,1},{30,2},[&lt;&lt;&quot;bar(X)&quot;&gt;&gt;],hidden,#{}} = Bar,
<a name="spec_switch_order-last_expr"/><a name="554"/>  554: <b>  {{function,foo,1}, {22, 2}, [&lt;&lt;&quot;foo</b>(Var)&quot;&gt;&gt;], #{ &lt;&lt;&quot;en&quot;&gt;&gt; := &lt;&lt;&quot;Foo does X&quot;&gt;&gt; }, #{}} = Foo.
<a name="555"/>  555: 
<a name="skip_doc-1"/><a name="556"/>  556: <b>skip_doc</b>(Conf) -&gt;
<a name="557"/>  557:   ModuleName =?get_name(),
<a name="558"/>  558:   {ok, ModName} = default_compile_file(Conf, ModuleName, [no_docs]),
<a name="559"/>  559: 
<a name="560"/>  560:   {ok,{docs_v1,0,erlang,&lt;&lt;&quot;application/erlang+html&quot;&gt;&gt;,none,
<a name="561"/>  561:      #{generated := true,
<a name="562"/>  562:        otp_doc_vsn := {1,0,0}},
<a name="563"/>  563:        [{{function,main,0},{8,1},[&lt;&lt;&quot;main/0&quot;&gt;&gt;],none,#{}},
<a name="564"/>  564:         {{function,foo,1},{16,1},[&lt;&lt;&quot;foo/1&quot;&gt;&gt;],none,#{}}]}} = code:get_doc(ModName),
<a name="565"/>  565: 
<a name="566"/>  566:   {ok, _ModName} = compile_file(Conf, ModuleName, [report, return_errors, no_docs]),
<a name="567"/>  567:   {error, missing} = code:get_doc(ModName),
<a name="skip_doc-last_expr"/><a name="568"/>  568:   ok.
<a name="569"/>  569: 
<a name="570"/>  570: 
<a name="docs_from_ast-1"/><a name="571"/>  571: <b>docs_from_ast</b>(_Conf) -&gt;
<a name="572"/>  572:     Code = &quot;&quot;&quot;
<a name="573"/>  573:       -module(test).
<a name="574"/>  574:       -moduledoc &quot;moduledoc&quot;.
<a name="575"/>  575:       -export([main/0]).
<a name="576"/>  576:       -doc &quot;main&quot;.
<a name="577"/>  577:       main() -&gt; ok.
<a name="578"/>  578:       &quot;&quot;&quot;,
<a name="579"/>  579: 
<a name="580"/>  580:     {ok, test, BeamCode} = compile:forms(scan_and_parse(Code),[debug_info]),
<a name="581"/>  581:     {ok, {test, [{documentation, Docs }]}} = beam_lib:chunks(BeamCode, [documentation]),
<a name="582"/>  582: 
<a name="583"/>  583:     ?assertMatch(
<a name="584"/>  584:        #docs_v1{ module_doc = #{ &lt;&lt;&quot;en&quot;&gt;&gt; := &lt;&lt;&quot;moduledoc&quot;&gt;&gt; },
<a name="585"/>  585:                  anno = 2,
<a name="586"/>  586:                  docs = [{{function,main,0}, 4, _, #{ &lt;&lt;&quot;en&quot;&gt;&gt; := &lt;&lt;&quot;main&quot;&gt;&gt; }, _}]},
<a name="587"/>  587:        Docs),
<a name="588"/>  588: 
<a name="589"/>  589:     check_no_doc_attributes(BeamCode),
<a name="590"/>  590: 
<a name="591"/>  591:     {ok, test, BeamCodeWSource} = compile:forms(scan_and_parse(Code),[beam_docs, debug_info, {source, &quot;test.erl&quot;}]),
<a name="592"/>  592:     {ok, {test, [{documentation, DocsWSource }]}} = beam_lib:chunks(BeamCodeWSource, [documentation]),
<a name="593"/>  593: 
<a name="594"/>  594:     ?assertMatch(
<a name="595"/>  595:        #docs_v1{ module_doc = #{ &lt;&lt;&quot;en&quot;&gt;&gt; := &lt;&lt;&quot;moduledoc&quot;&gt;&gt; },
<a name="596"/>  596:                  anno = 2,
<a name="597"/>  597:                  docs = [{{function,main,0}, 4,
<a name="598"/>  598:                           _, #{ &lt;&lt;&quot;en&quot;&gt;&gt; := &lt;&lt;&quot;main&quot;&gt;&gt; }, _}]},
<a name="599"/>  599:        DocsWSource),
<a name="600"/>  600:     check_no_doc_attributes(BeamCodeWSource),
<a name="docs_from_ast-last_expr"/><a name="601"/>  601:     ok.
<a name="602"/>  602: 
<a name="scan_and_parse-1"/><a name="603"/>  603: <b>scan_and_parse</b>(Code) -&gt;
<a name="604"/>  604:     {ok, Toks, _} = erl_scan:string(Code),
<a name="scan_and_parse-last_expr"/><a name="605"/>  605: <b>    parse</b>(Toks).
<a name="606"/>  606: 
<a name="parse-1"/><a name="607"/>  607: <b>parse</b>([]) -&gt; [];
<a name="608"/>  608: <b>parse</b>(Toks) -&gt;
<a name="609"/>  609:     {Form, [Dot | Rest]} = lists:splitwith(fun(E) -&gt; element(1,E) =/= dot end, Toks),
<a name="610"/>  610:     {ok, F} = erl_parse:parse_form(Form ++ [Dot]),
<a name="parse-last_expr"/><a name="611"/>  611: <b>    [F | parse</b>(Rest)].
<a name="612"/>  612: 
<a name="compile_file-3"/><a name="613"/>  613: <b>compile_file</b>(Conf, ModuleName, ExtraOpts) -&gt;
<a name="614"/>  614:     ErlModName = ModuleName ++ &quot;.erl&quot;,
<a name="615"/>  615:     Filename = filename:join(proplists:get_value(data_dir, Conf), ErlModName),
<a name="616"/>  616:     io:format(&quot;Compiling: ~ts~n~p~n&quot;,[Filename, ExtraOpts]),
<a name="compile_file-last_expr"/><a name="617"/>  617: <b>    case compile:file</b>(Filename, ExtraOpts) of
<a name="618"/>  618:         Res when element(1, Res) =:= ok -&gt;
<a name="619"/>  619:             ModName = element(2, Res),
<a name="620"/>  620:             case lists:search(fun (X) -&gt; X =:= no_docs end, ExtraOpts) of
<a name="621"/>  621:               false when length(ExtraOpts) &gt; 0 -&gt;
<a name="622"/>  622:                 check_no_doc_attributes(code:which(ModName)),
<a name="623"/>  623:                 Res;
<a name="624"/>  624:               _ -&gt;
<a name="625"/>  625:                 Res
<a name="626"/>  626:             end;
<a name="627"/>  627:         Else -&gt;
<a name="628"/>  628:             Else
<a name="629"/>  629:     end.
<a name="630"/>  630: 
<a name="default_compile_file-2"/><a name="631"/>  631: <b>default_compile_file</b>(Conf, ModuleName) -&gt;
<a name="default_compile_file-last_expr"/><a name="632"/>  632: <b>  default_compile_file</b>(Conf, ModuleName, []).
<a name="default_compile_file-3"/><a name="633"/>  633: <b>default_compile_file</b>(Conf, ModuleName, ExtraOpts) -&gt;
<a name="default_compile_file-last_expr"/><a name="634"/>  634: <b>  compile_file</b>(Conf, ModuleName, [report, return_errors, debug_info] ++ ExtraOpts).
<a name="635"/>  635: 
<a name="636"/>  636: 
<a name="637"/>  637: <i>%% Verify that all doc and moduledoc attributes are stripped from debug_info</i>
<a name="check_no_doc_attributes-1"/><a name="638"/>  638: <b>check_no_doc_attributes</b>(Mod) -&gt;
<a name="639"/>  639:     {ok, {_ModName,
<a name="640"/>  640:           [{debug_info,
<a name="641"/>  641:             {debug_info_v1,erl_abstract_code,
<a name="642"/>  642:              {AST, Opts}}}]}} = beam_lib:chunks(Mod, [debug_info]),
<a name="643"/>  643:     false = lists:search(
<a name="644"/>  644:               fun(E) -&gt;
<a name="645"/>  645:                       element(1,E) == attribute
<a name="646"/>  646:                           andalso
<a name="647"/>  647:                             (element(3,E) == doc orelse element(3,E) == moduledoc)
<a name="648"/>  648:               end, AST),
<a name="649"/>  649:     false = lists:member(no_docs, Opts),
<a name="check_no_doc_attributes-last_expr"/><a name="650"/>  650:     ok.
</pre>
<script>
var hash = window.location.hash.substring(1);
var anchor = document.getElementsByName(hash);
anchor[0].style.backgroundColor="orange";
</script>
</body>
</html>
